

--- FILE: lib/l10n/app_localizations.dart ---

import 'dart:async';

import 'package:flutter/foundation.dart';
import 'package:flutter/widgets.dart';
import 'package:flutter_localizations/flutter_localizations.dart';
import 'package:intl/intl.dart' as intl;

import 'app_localizations_en.dart';
import 'app_localizations_tr.dart';

// ignore_for_file: type=lint

/// Callers can lookup localized strings with an instance of AppLocalizations
/// returned by `AppLocalizations.of(context)`.
///
/// Applications need to include `AppLocalizations.delegate()` in their app's
/// `localizationDelegates` list, and the locales they support in the app's
/// `supportedLocales` list. For example:
///
/// ```dart
/// import 'l10n/app_localizations.dart';
///
/// return MaterialApp(
///   localizationsDelegates: AppLocalizations.localizationsDelegates,
///   supportedLocales: AppLocalizations.supportedLocales,
///   home: MyApplicationHome(),
/// );
/// ```
///
/// ## Update pubspec.yaml
///
/// Please make sure to update your pubspec.yaml to include the following
/// packages:
///
/// ```yaml
/// dependencies:
///   # Internationalization support.
///   flutter_localizations:
///     sdk: flutter
///   intl: any # Use the pinned version from flutter_localizations
///
///   # Rest of dependencies
/// ```
///
/// ## iOS Applications
///
/// iOS applications define key application metadata, including supported
/// locales, in an Info.plist file that is built into the application bundle.
/// To configure the locales supported by your app, you’ll need to edit this
/// file.
///
/// First, open your project’s ios/Runner.xcworkspace Xcode workspace file.
/// Then, in the Project Navigator, open the Info.plist file under the Runner
/// project’s Runner folder.
///
/// Next, select the Information Property List item, select Add Item from the
/// Editor menu, then select Localizations from the pop-up menu.
///
/// Select and expand the newly-created Localizations item then, for each
/// locale your application supports, add a new item and select the locale
/// you wish to add from the pop-up menu in the Value field. This list should
/// be consistent with the languages listed in the AppLocalizations.supportedLocales
/// property.
abstract class AppLocalizations {
  AppLocalizations(String locale)
    : localeName = intl.Intl.canonicalizedLocale(locale.toString());

  final String localeName;

  static AppLocalizations of(BuildContext context) {
    return Localizations.of<AppLocalizations>(context, AppLocalizations)!;
  }

  static const LocalizationsDelegate<AppLocalizations> delegate =
      _AppLocalizationsDelegate();

  /// A list of this localizations delegate along with the default localizations
  /// delegates.
  ///
  /// Returns a list of localizations delegates containing this delegate along with
  /// GlobalMaterialLocalizations.delegate, GlobalCupertinoLocalizations.delegate,
  /// and GlobalWidgetsLocalizations.delegate.
  ///
  /// Additional delegates can be added by appending to this list in
  /// MaterialApp. This list does not have to be used at all if a custom list
  /// of delegates is preferred or required.
  static const List<LocalizationsDelegate<dynamic>> localizationsDelegates =
      <LocalizationsDelegate<dynamic>>[
        delegate,
        GlobalMaterialLocalizations.delegate,
        GlobalCupertinoLocalizations.delegate,
        GlobalWidgetsLocalizations.delegate,
      ];

  /// A list of this localizations delegate's supported locales.
  static const List<Locale> supportedLocales = <Locale>[
    Locale('en'),
    Locale('tr'),
  ];

  /// No description provided for @appTitle.
  ///
  /// In en, this message translates to:
  /// **'Vantag'**
  String get appTitle;

  /// No description provided for @appSlogan.
  ///
  /// In en, this message translates to:
  /// **'Your Financial Edge'**
  String get appSlogan;

  /// No description provided for @navExpenses.
  ///
  /// In en, this message translates to:
  /// **'Expenses'**
  String get navExpenses;

  /// No description provided for @navReports.
  ///
  /// In en, this message translates to:
  /// **'Reports'**
  String get navReports;

  /// No description provided for @navAchievements.
  ///
  /// In en, this message translates to:
  /// **'Achievements'**
  String get navAchievements;

  /// No description provided for @navProfile.
  ///
  /// In en, this message translates to:
  /// **'Profile'**
  String get navProfile;

  /// No description provided for @navSettings.
  ///
  /// In en, this message translates to:
  /// **'Settings'**
  String get navSettings;

  /// No description provided for @profile.
  ///
  /// In en, this message translates to:
  /// **'Profile'**
  String get profile;

  /// No description provided for @profileSavedTime.
  ///
  /// In en, this message translates to:
  /// **'Time Saved with Vantag'**
  String get profileSavedTime;

  /// No description provided for @profileHours.
  ///
  /// In en, this message translates to:
  /// **'{hours} Hours'**
  String profileHours(String hours);

  /// No description provided for @profileMemberSince.
  ///
  /// In en, this message translates to:
  /// **'Member Since'**
  String get profileMemberSince;

  /// No description provided for @profileDays.
  ///
  /// In en, this message translates to:
  /// **'{days} Days'**
  String profileDays(int days);

  /// No description provided for @profileBadgesEarned.
  ///
  /// In en, this message translates to:
  /// **'Badges Earned'**
  String get profileBadgesEarned;

  /// No description provided for @profileGoogleConnected.
  ///
  /// In en, this message translates to:
  /// **'Google Account Connected'**
  String get profileGoogleConnected;

  /// No description provided for @profileGoogleNotConnected.
  ///
  /// In en, this message translates to:
  /// **'Google Account Not Connected'**
  String get profileGoogleNotConnected;

  /// No description provided for @profileSignOut.
  ///
  /// In en, this message translates to:
  /// **'Sign Out'**
  String get profileSignOut;

  /// No description provided for @profileSignOutConfirm.
  ///
  /// In en, this message translates to:
  /// **'Are you sure you want to sign out?'**
  String get profileSignOutConfirm;

  /// No description provided for @proMember.
  ///
  /// In en, this message translates to:
  /// **'Pro Member'**
  String get proMember;

  /// No description provided for @proMemberToast.
  ///
  /// In en, this message translates to:
  /// **'You are a Pro Member ✓'**
  String get proMemberToast;

  /// No description provided for @settingsGeneral.
  ///
  /// In en, this message translates to:
  /// **'General'**
  String get settingsGeneral;

  /// No description provided for @settingsCurrency.
  ///
  /// In en, this message translates to:
  /// **'Currency'**
  String get settingsCurrency;

  /// No description provided for @settingsLanguage.
  ///
  /// In en, this message translates to:
  /// **'Language'**
  String get settingsLanguage;

  /// No description provided for @settingsTheme.
  ///
  /// In en, this message translates to:
  /// **'Theme'**
  String get settingsTheme;

  /// No description provided for @settingsThemeDark.
  ///
  /// In en, this message translates to:
  /// **'Dark'**
  String get settingsThemeDark;

  /// No description provided for @settingsThemeLight.
  ///
  /// In en, this message translates to:
  /// **'Light'**
  String get settingsThemeLight;

  /// No description provided for @settingsThemeAutomatic.
  ///
  /// In en, this message translates to:
  /// **'Automatic'**
  String get settingsThemeAutomatic;

  /// No description provided for @simpleMode.
  ///
  /// In en, this message translates to:
  /// **'Simple Mode'**
  String get simpleMode;

  /// No description provided for @simpleModeDescription.
  ///
  /// In en, this message translates to:
  /// **'Streamlined experience with essential features only'**
  String get simpleModeDescription;

  /// No description provided for @simpleModeEnabled.
  ///
  /// In en, this message translates to:
  /// **'Simple mode is enabled'**
  String get simpleModeEnabled;

  /// No description provided for @simpleModeDisabled.
  ///
  /// In en, this message translates to:
  /// **'Simple mode is disabled'**
  String get simpleModeDisabled;

  /// No description provided for @simpleModeHint.
  ///
  /// In en, this message translates to:
  /// **'Turn off Simple Mode to access all features like AI chat, achievements, and pursuits'**
  String get simpleModeHint;

  /// No description provided for @simpleTransactions.
  ///
  /// In en, this message translates to:
  /// **'Transactions'**
  String get simpleTransactions;

  /// No description provided for @simpleStatistics.
  ///
  /// In en, this message translates to:
  /// **'Statistics'**
  String get simpleStatistics;

  /// No description provided for @simpleSettings.
  ///
  /// In en, this message translates to:
  /// **'Settings'**
  String get simpleSettings;

  /// No description provided for @simpleIncome.
  ///
  /// In en, this message translates to:
  /// **'Income'**
  String get simpleIncome;

  /// No description provided for @simpleExpense.
  ///
  /// In en, this message translates to:
  /// **'Expense'**
  String get simpleExpense;

  /// No description provided for @simpleExpenses.
  ///
  /// In en, this message translates to:
  /// **'Expenses'**
  String get simpleExpenses;

  /// No description provided for @simpleBalance.
  ///
  /// In en, this message translates to:
  /// **'Balance'**
  String get simpleBalance;

  /// No description provided for @simpleTotal.
  ///
  /// In en, this message translates to:
  /// **'Total'**
  String get simpleTotal;

  /// No description provided for @simpleTotalIncome.
  ///
  /// In en, this message translates to:
  /// **'Total Income'**
  String get simpleTotalIncome;

  /// No description provided for @simpleIncomeTab.
  ///
  /// In en, this message translates to:
  /// **'Income'**
  String get simpleIncomeTab;

  /// No description provided for @simpleIncomeSources.
  ///
  /// In en, this message translates to:
  /// **'Income Sources'**
  String get simpleIncomeSources;

  /// No description provided for @simpleNoTransactions.
  ///
  /// In en, this message translates to:
  /// **'No transactions this month'**
  String get simpleNoTransactions;

  /// No description provided for @simpleNoData.
  ///
  /// In en, this message translates to:
  /// **'No data for this month'**
  String get simpleNoData;

  /// No description provided for @settingsNotifications.
  ///
  /// In en, this message translates to:
  /// **'Notifications'**
  String get settingsNotifications;

  /// No description provided for @settingsReminders.
  ///
  /// In en, this message translates to:
  /// **'Reminders'**
  String get settingsReminders;

  /// No description provided for @settingsSoundEffects.
  ///
  /// In en, this message translates to:
  /// **'Sound Effects'**
  String get settingsSoundEffects;

  /// No description provided for @settingsSoundVolume.
  ///
  /// In en, this message translates to:
  /// **'Volume'**
  String get settingsSoundVolume;

  /// No description provided for @settingsProPurchases.
  ///
  /// In en, this message translates to:
  /// **'Pro & Purchases'**
  String get settingsProPurchases;

  /// No description provided for @settingsVantagPro.
  ///
  /// In en, this message translates to:
  /// **'Vantag Pro'**
  String get settingsVantagPro;

  /// No description provided for @settingsRestorePurchases.
  ///
  /// In en, this message translates to:
  /// **'Restore Purchases'**
  String get settingsRestorePurchases;

  /// No description provided for @settingsRestoreSuccess.
  ///
  /// In en, this message translates to:
  /// **'Purchases restored'**
  String get settingsRestoreSuccess;

  /// No description provided for @settingsRestoreNone.
  ///
  /// In en, this message translates to:
  /// **'No purchases to restore'**
  String get settingsRestoreNone;

  /// No description provided for @settingsDataPrivacy.
  ///
  /// In en, this message translates to:
  /// **'Data & Privacy'**
  String get settingsDataPrivacy;

  /// No description provided for @settingsExportData.
  ///
  /// In en, this message translates to:
  /// **'Export Data'**
  String get settingsExportData;

  /// No description provided for @settingsImportStatement.
  ///
  /// In en, this message translates to:
  /// **'Import Statement'**
  String get settingsImportStatement;

  /// No description provided for @settingsImportStatementDesc.
  ///
  /// In en, this message translates to:
  /// **'Upload your bank statement (PDF/CSV)'**
  String get settingsImportStatementDesc;

  /// No description provided for @importStatementTitle.
  ///
  /// In en, this message translates to:
  /// **'Import Statement'**
  String get importStatementTitle;

  /// No description provided for @importStatementSelectFile.
  ///
  /// In en, this message translates to:
  /// **'Select File'**
  String get importStatementSelectFile;

  /// No description provided for @importStatementSupportedFormats.
  ///
  /// In en, this message translates to:
  /// **'Supported formats: PDF, CSV'**
  String get importStatementSupportedFormats;

  /// No description provided for @importStatementDragDrop.
  ///
  /// In en, this message translates to:
  /// **'Tap to select your bank statement'**
  String get importStatementDragDrop;

  /// No description provided for @importStatementProcessing.
  ///
  /// In en, this message translates to:
  /// **'Processing statement...'**
  String get importStatementProcessing;

  /// No description provided for @importStatementSuccess.
  ///
  /// In en, this message translates to:
  /// **'Successfully imported {count} transactions'**
  String importStatementSuccess(int count);

  /// No description provided for @importStatementError.
  ///
  /// In en, this message translates to:
  /// **'Error importing statement'**
  String get importStatementError;

  /// No description provided for @importStatementNoTransactions.
  ///
  /// In en, this message translates to:
  /// **'No transactions found in statement'**
  String get importStatementNoTransactions;

  /// No description provided for @importStatementUnsupportedFormat.
  ///
  /// In en, this message translates to:
  /// **'Unsupported file format'**
  String get importStatementUnsupportedFormat;

  /// No description provided for @importStatementMonthlyLimit.
  ///
  /// In en, this message translates to:
  /// **'{remaining} imports remaining this month'**
  String importStatementMonthlyLimit(int remaining);

  /// No description provided for @importStatementLimitReached.
  ///
  /// In en, this message translates to:
  /// **'Monthly import limit reached'**
  String get importStatementLimitReached;

  /// No description provided for @importStatementLimitReachedDesc.
  ///
  /// In en, this message translates to:
  /// **'You\'ve used all your imports for this month. Upgrade to Pro for more imports.'**
  String get importStatementLimitReachedDesc;

  /// No description provided for @importStatementProLimit.
  ///
  /// In en, this message translates to:
  /// **'10 imports/month'**
  String get importStatementProLimit;

  /// No description provided for @importStatementFreeLimit.
  ///
  /// In en, this message translates to:
  /// **'1 import/month'**
  String get importStatementFreeLimit;

  /// No description provided for @importStatementReviewTitle.
  ///
  /// In en, this message translates to:
  /// **'Review Transactions'**
  String get importStatementReviewTitle;

  /// No description provided for @importStatementReviewDesc.
  ///
  /// In en, this message translates to:
  /// **'Select transactions to import'**
  String get importStatementReviewDesc;

  /// No description provided for @importStatementImportSelected.
  ///
  /// In en, this message translates to:
  /// **'Import Selected ({count})'**
  String importStatementImportSelected(int count);

  /// No description provided for @importStatementSelectAll.
  ///
  /// In en, this message translates to:
  /// **'Select All'**
  String get importStatementSelectAll;

  /// No description provided for @importStatementDeselectAll.
  ///
  /// In en, this message translates to:
  /// **'Deselect All'**
  String get importStatementDeselectAll;

  /// No description provided for @settingsPrivacyPolicy.
  ///
  /// In en, this message translates to:
  /// **'Privacy Policy'**
  String get settingsPrivacyPolicy;

  /// No description provided for @settingsAbout.
  ///
  /// In en, this message translates to:
  /// **'About'**
  String get settingsAbout;

  /// No description provided for @settingsVersion.
  ///
  /// In en, this message translates to:
  /// **'Version'**
  String get settingsVersion;

  /// No description provided for @settingsContactUs.
  ///
  /// In en, this message translates to:
  /// **'Contact Us'**
  String get settingsContactUs;

  /// No description provided for @settingsGrowth.
  ///
  /// In en, this message translates to:
  /// **'Invite & get 3 days Premium free!'**
  String get settingsGrowth;

  /// No description provided for @settingsInviteFriends.
  ///
  /// In en, this message translates to:
  /// **'Invite Friends'**
  String get settingsInviteFriends;

  /// No description provided for @settingsInviteMessage.
  ///
  /// In en, this message translates to:
  /// **'I\'m tracking my expenses with Vantag! You should try it too:'**
  String get settingsInviteMessage;

  /// No description provided for @dashboard.
  ///
  /// In en, this message translates to:
  /// **'Dashboard'**
  String get dashboard;

  /// No description provided for @totalBalance.
  ///
  /// In en, this message translates to:
  /// **'Total Balance'**
  String get totalBalance;

  /// No description provided for @monthlyIncome.
  ///
  /// In en, this message translates to:
  /// **'Monthly Income'**
  String get monthlyIncome;

  /// No description provided for @totalIncome.
  ///
  /// In en, this message translates to:
  /// **'Total Income'**
  String get totalIncome;

  /// No description provided for @totalSpent.
  ///
  /// In en, this message translates to:
  /// **'Total Spent'**
  String get totalSpent;

  /// No description provided for @totalSaved.
  ///
  /// In en, this message translates to:
  /// **'Total Saved'**
  String get totalSaved;

  /// No description provided for @workHours.
  ///
  /// In en, this message translates to:
  /// **'Work Hours'**
  String get workHours;

  /// No description provided for @workDays.
  ///
  /// In en, this message translates to:
  /// **'Work Days'**
  String get workDays;

  /// No description provided for @expenses.
  ///
  /// In en, this message translates to:
  /// **'Expenses'**
  String get expenses;

  /// No description provided for @addExpense.
  ///
  /// In en, this message translates to:
  /// **'Add Expense'**
  String get addExpense;

  /// No description provided for @amount.
  ///
  /// In en, this message translates to:
  /// **'Amount'**
  String get amount;

  /// No description provided for @amountTL.
  ///
  /// In en, this message translates to:
  /// **'Amount (₺)'**
  String get amountTL;

  /// No description provided for @category.
  ///
  /// In en, this message translates to:
  /// **'Category'**
  String get category;

  /// No description provided for @description.
  ///
  /// In en, this message translates to:
  /// **'Description'**
  String get description;

  /// No description provided for @descriptionHint.
  ///
  /// In en, this message translates to:
  /// **'e.g: Migros, Spotify, Shell...'**
  String get descriptionHint;

  /// No description provided for @descriptionLabel.
  ///
  /// In en, this message translates to:
  /// **'Description (Store/Product)'**
  String get descriptionLabel;

  /// No description provided for @date.
  ///
  /// In en, this message translates to:
  /// **'Date'**
  String get date;

  /// No description provided for @today.
  ///
  /// In en, this message translates to:
  /// **'Today'**
  String get today;

  /// No description provided for @weekdayMon.
  ///
  /// In en, this message translates to:
  /// **'Mon'**
  String get weekdayMon;

  /// No description provided for @weekdayTue.
  ///
  /// In en, this message translates to:
  /// **'Tue'**
  String get weekdayTue;

  /// No description provided for @weekdayWed.
  ///
  /// In en, this message translates to:
  /// **'Wed'**
  String get weekdayWed;

  /// No description provided for @weekdayThu.
  ///
  /// In en, this message translates to:
  /// **'Thu'**
  String get weekdayThu;

  /// No description provided for @weekdayFri.
  ///
  /// In en, this message translates to:
  /// **'Fri'**
  String get weekdayFri;

  /// No description provided for @weekdaySat.
  ///
  /// In en, this message translates to:
  /// **'Sat'**
  String get weekdaySat;

  /// No description provided for @weekdaySun.
  ///
  /// In en, this message translates to:
  /// **'Sun'**
  String get weekdaySun;

  /// No description provided for @monthJan.
  ///
  /// In en, this message translates to:
  /// **'Jan'**
  String get monthJan;

  /// No description provided for @monthFeb.
  ///
  /// In en, this message translates to:
  /// **'Feb'**
  String get monthFeb;

  /// No description provided for @monthMar.
  ///
  /// In en, this message translates to:
  /// **'Mar'**
  String get monthMar;

  /// No description provided for @monthApr.
  ///
  /// In en, this message translates to:
  /// **'Apr'**
  String get monthApr;

  /// No description provided for @monthMay.
  ///
  /// In en, this message translates to:
  /// **'May'**
  String get monthMay;

  /// No description provided for @monthJun.
  ///
  /// In en, this message translates to:
  /// **'Jun'**
  String get monthJun;

  /// No description provided for @monthJul.
  ///
  /// In en, this message translates to:
  /// **'Jul'**
  String get monthJul;

  /// No description provided for @monthAug.
  ///
  /// In en, this message translates to:
  /// **'Aug'**
  String get monthAug;

  /// No description provided for @monthSep.
  ///
  /// In en, this message translates to:
  /// **'Sep'**
  String get monthSep;

  /// No description provided for @monthOct.
  ///
  /// In en, this message translates to:
  /// **'Oct'**
  String get monthOct;

  /// No description provided for @monthNov.
  ///
  /// In en, this message translates to:
  /// **'Nov'**
  String get monthNov;

  /// No description provided for @monthDec.
  ///
  /// In en, this message translates to:
  /// **'Dec'**
  String get monthDec;

  /// No description provided for @yesterday.
  ///
  /// In en, this message translates to:
  /// **'Yesterday'**
  String get yesterday;

  /// No description provided for @twoDaysAgo.
  ///
  /// In en, this message translates to:
  /// **'2 Days Ago'**
  String get twoDaysAgo;

  /// No description provided for @daysAgo.
  ///
  /// In en, this message translates to:
  /// **'{count} Days Ago'**
  String daysAgo(int count);

  /// No description provided for @bought.
  ///
  /// In en, this message translates to:
  /// **'Bought'**
  String get bought;

  /// No description provided for @thinking.
  ///
  /// In en, this message translates to:
  /// **'Thinking'**
  String get thinking;

  /// No description provided for @passed.
  ///
  /// In en, this message translates to:
  /// **'Passed'**
  String get passed;

  /// No description provided for @cancel.
  ///
  /// In en, this message translates to:
  /// **'Cancel'**
  String get cancel;

  /// No description provided for @ok.
  ///
  /// In en, this message translates to:
  /// **'OK'**
  String get ok;

  /// No description provided for @save.
  ///
  /// In en, this message translates to:
  /// **'Save'**
  String get save;

  /// No description provided for @delete.
  ///
  /// In en, this message translates to:
  /// **'Delete'**
  String get delete;

  /// No description provided for @edit.
  ///
  /// In en, this message translates to:
  /// **'Edit'**
  String get edit;

  /// No description provided for @change.
  ///
  /// In en, this message translates to:
  /// **'Change'**
  String get change;

  /// No description provided for @close.
  ///
  /// In en, this message translates to:
  /// **'Close'**
  String get close;

  /// No description provided for @update.
  ///
  /// In en, this message translates to:
  /// **'Update'**
  String get update;

  /// No description provided for @calculate.
  ///
  /// In en, this message translates to:
  /// **'Calculate'**
  String get calculate;

  /// No description provided for @giveUp.
  ///
  /// In en, this message translates to:
  /// **'Give Up'**
  String get giveUp;

  /// No description provided for @select.
  ///
  /// In en, this message translates to:
  /// **'Select'**
  String get select;

  /// No description provided for @decision.
  ///
  /// In en, this message translates to:
  /// **'Decision'**
  String get decision;

  /// No description provided for @hoursRequired.
  ///
  /// In en, this message translates to:
  /// **'{hours} hours'**
  String hoursRequired(String hours);

  /// No description provided for @daysRequired.
  ///
  /// In en, this message translates to:
  /// **'{days} days'**
  String daysRequired(String days);

  /// No description provided for @minutesRequired.
  ///
  /// In en, this message translates to:
  /// **'{minutes} minutes'**
  String minutesRequired(int minutes);

  /// No description provided for @hoursEquivalent.
  ///
  /// In en, this message translates to:
  /// **'{hours} hours equivalent'**
  String hoursEquivalent(String hours);

  /// No description provided for @editProfile.
  ///
  /// In en, this message translates to:
  /// **'Edit Profile'**
  String get editProfile;

  /// No description provided for @settings.
  ///
  /// In en, this message translates to:
  /// **'Settings'**
  String get settings;

  /// No description provided for @language.
  ///
  /// In en, this message translates to:
  /// **'Language'**
  String get language;

  /// No description provided for @selectLanguage.
  ///
  /// In en, this message translates to:
  /// **'Select Language'**
  String get selectLanguage;

  /// No description provided for @selectCurrency.
  ///
  /// In en, this message translates to:
  /// **'Select Currency'**
  String get selectCurrency;

  /// No description provided for @currency.
  ///
  /// In en, this message translates to:
  /// **'Currency'**
  String get currency;

  /// No description provided for @turkish.
  ///
  /// In en, this message translates to:
  /// **'Turkish'**
  String get turkish;

  /// No description provided for @english.
  ///
  /// In en, this message translates to:
  /// **'English'**
  String get english;

  /// No description provided for @incomeInfo.
  ///
  /// In en, this message translates to:
  /// **'Income Information'**
  String get incomeInfo;

  /// No description provided for @dailyWorkHours.
  ///
  /// In en, this message translates to:
  /// **'Daily Work Hours'**
  String get dailyWorkHours;

  /// No description provided for @weeklyWorkDays.
  ///
  /// In en, this message translates to:
  /// **'Weekly Work Days'**
  String get weeklyWorkDays;

  /// No description provided for @workingDaysPerWeek.
  ///
  /// In en, this message translates to:
  /// **'Working {count} days per week'**
  String workingDaysPerWeek(int count);

  /// No description provided for @hours.
  ///
  /// In en, this message translates to:
  /// **'hours'**
  String get hours;

  /// No description provided for @incomeSources.
  ///
  /// In en, this message translates to:
  /// **'{count} sources'**
  String incomeSources(int count);

  /// No description provided for @detailedEntry.
  ///
  /// In en, this message translates to:
  /// **'Detailed Entry'**
  String get detailedEntry;

  /// No description provided for @googleAccount.
  ///
  /// In en, this message translates to:
  /// **'Google Account'**
  String get googleAccount;

  /// No description provided for @googleLinked.
  ///
  /// In en, this message translates to:
  /// **'Google Linked'**
  String get googleLinked;

  /// No description provided for @googleNotLinked.
  ///
  /// In en, this message translates to:
  /// **'Google Not Linked'**
  String get googleNotLinked;

  /// No description provided for @linkWithGoogle.
  ///
  /// In en, this message translates to:
  /// **'Link with Google'**
  String get linkWithGoogle;

  /// No description provided for @linking.
  ///
  /// In en, this message translates to:
  /// **'Linking...'**
  String get linking;

  /// No description provided for @backupAndSecure.
  ///
  /// In en, this message translates to:
  /// **'Backup and secure your data'**
  String get backupAndSecure;

  /// No description provided for @dataNotBackedUp.
  ///
  /// In en, this message translates to:
  /// **'Your data is not backed up'**
  String get dataNotBackedUp;

  /// No description provided for @googleLinkedSuccess.
  ///
  /// In en, this message translates to:
  /// **'Google account linked successfully!'**
  String get googleLinkedSuccess;

  /// No description provided for @googleLinkFailed.
  ///
  /// In en, this message translates to:
  /// **'Failed to link Google account'**
  String get googleLinkFailed;

  /// No description provided for @appleAccount.
  ///
  /// In en, this message translates to:
  /// **'Apple Account'**
  String get appleAccount;

  /// No description provided for @appleLinked.
  ///
  /// In en, this message translates to:
  /// **'Apple Linked'**
  String get appleLinked;

  /// No description provided for @appleNotLinked.
  ///
  /// In en, this message translates to:
  /// **'Apple Not Linked'**
  String get appleNotLinked;

  /// No description provided for @linkWithApple.
  ///
  /// In en, this message translates to:
  /// **'Link with Apple'**
  String get linkWithApple;

  /// No description provided for @profileAppleConnected.
  ///
  /// In en, this message translates to:
  /// **'Apple Account Connected'**
  String get profileAppleConnected;

  /// No description provided for @profileAppleNotConnected.
  ///
  /// In en, this message translates to:
  /// **'Apple Account Not Connected'**
  String get profileAppleNotConnected;

  /// No description provided for @appleLinkedSuccess.
  ///
  /// In en, this message translates to:
  /// **'Apple account linked successfully!'**
  String get appleLinkedSuccess;

  /// No description provided for @appleLinkFailed.
  ///
  /// In en, this message translates to:
  /// **'Failed to link Apple account'**
  String get appleLinkFailed;

  /// No description provided for @appleSignInNotAvailable.
  ///
  /// In en, this message translates to:
  /// **'Apple Sign In is not available on this device'**
  String get appleSignInNotAvailable;

  /// No description provided for @editWorkHours.
  ///
  /// In en, this message translates to:
  /// **'Work Hours'**
  String get editWorkHours;

  /// No description provided for @editWorkHoursSubtitle.
  ///
  /// In en, this message translates to:
  /// **'Your daily work hours for time calculations'**
  String get editWorkHoursSubtitle;

  /// No description provided for @hoursPerDay.
  ///
  /// In en, this message translates to:
  /// **'{hours} hours/day'**
  String hoursPerDay(String hours);

  /// No description provided for @workHoursUpdated.
  ///
  /// In en, this message translates to:
  /// **'Work hours updated'**
  String get workHoursUpdated;

  /// No description provided for @freeCurrencyNote.
  ///
  /// In en, this message translates to:
  /// **'Free users can only use TRY. Upgrade to Pro for all currencies.'**
  String get freeCurrencyNote;

  /// No description provided for @currencyLockNote.
  ///
  /// In en, this message translates to:
  /// **'Selected currency will be locked. Pro users can change anytime.'**
  String get currencyLockNote;

  /// No description provided for @welcome.
  ///
  /// In en, this message translates to:
  /// **'Welcome'**
  String get welcome;

  /// No description provided for @welcomeSubtitle.
  ///
  /// In en, this message translates to:
  /// **'Enter your information to measure expenses in time'**
  String get welcomeSubtitle;

  /// No description provided for @getStarted.
  ///
  /// In en, this message translates to:
  /// **'Get Started'**
  String get getStarted;

  /// No description provided for @offlineMode.
  ///
  /// In en, this message translates to:
  /// **'Offline mode - Data will be synced'**
  String get offlineMode;

  /// No description provided for @noInternet.
  ///
  /// In en, this message translates to:
  /// **'No Internet Connection'**
  String get noInternet;

  /// No description provided for @offline.
  ///
  /// In en, this message translates to:
  /// **'Offline'**
  String get offline;

  /// No description provided for @offlineMessage.
  ///
  /// In en, this message translates to:
  /// **'Data will sync when connection is restored'**
  String get offlineMessage;

  /// No description provided for @backOnline.
  ///
  /// In en, this message translates to:
  /// **'Back Online'**
  String get backOnline;

  /// No description provided for @dataSynced.
  ///
  /// In en, this message translates to:
  /// **'Data synced successfully'**
  String get dataSynced;

  /// No description provided for @reports.
  ///
  /// In en, this message translates to:
  /// **'Reports'**
  String get reports;

  /// No description provided for @monthlyReport.
  ///
  /// In en, this message translates to:
  /// **'Monthly Report'**
  String get monthlyReport;

  /// No description provided for @categoryReport.
  ///
  /// In en, this message translates to:
  /// **'Category Report'**
  String get categoryReport;

  /// No description provided for @thisMonth.
  ///
  /// In en, this message translates to:
  /// **'This Month'**
  String get thisMonth;

  /// No description provided for @lastMonth.
  ///
  /// In en, this message translates to:
  /// **'Last Month'**
  String get lastMonth;

  /// No description provided for @thisWeek.
  ///
  /// In en, this message translates to:
  /// **'This Week'**
  String get thisWeek;

  /// No description provided for @allTime.
  ///
  /// In en, this message translates to:
  /// **'All Time'**
  String get allTime;

  /// No description provided for @achievements.
  ///
  /// In en, this message translates to:
  /// **'Achievements'**
  String get achievements;

  /// No description provided for @badges.
  ///
  /// In en, this message translates to:
  /// **'Badges'**
  String get badges;

  /// No description provided for @progress.
  ///
  /// In en, this message translates to:
  /// **'Progress'**
  String get progress;

  /// No description provided for @unlocked.
  ///
  /// In en, this message translates to:
  /// **'Unlocked'**
  String get unlocked;

  /// No description provided for @locked.
  ///
  /// In en, this message translates to:
  /// **'Locked'**
  String get locked;

  /// No description provided for @streak.
  ///
  /// In en, this message translates to:
  /// **'Streak'**
  String get streak;

  /// No description provided for @currentStreak.
  ///
  /// In en, this message translates to:
  /// **'Current Streak'**
  String get currentStreak;

  /// No description provided for @bestStreak.
  ///
  /// In en, this message translates to:
  /// **'Best Streak'**
  String get bestStreak;

  /// No description provided for @streakDays.
  ///
  /// In en, this message translates to:
  /// **'{count} days'**
  String streakDays(int count);

  /// No description provided for @subscriptions.
  ///
  /// In en, this message translates to:
  /// **'Subscriptions'**
  String get subscriptions;

  /// No description provided for @subscriptionsDescription.
  ///
  /// In en, this message translates to:
  /// **'Track your recurring subscriptions like Netflix, Spotify here.'**
  String get subscriptionsDescription;

  /// No description provided for @addSubscription.
  ///
  /// In en, this message translates to:
  /// **'Add Subscription'**
  String get addSubscription;

  /// No description provided for @monthlyTotal.
  ///
  /// In en, this message translates to:
  /// **'Monthly Total'**
  String get monthlyTotal;

  /// No description provided for @yearlyTotal.
  ///
  /// In en, this message translates to:
  /// **'Yearly Total'**
  String get yearlyTotal;

  /// No description provided for @nextPayment.
  ///
  /// In en, this message translates to:
  /// **'Next Payment'**
  String get nextPayment;

  /// No description provided for @renewalWarning.
  ///
  /// In en, this message translates to:
  /// **'Renewal in {days} days'**
  String renewalWarning(int days);

  /// No description provided for @activeSubscriptions.
  ///
  /// In en, this message translates to:
  /// **'{count} active subscriptions'**
  String activeSubscriptions(int count);

  /// No description provided for @monthlySubscriptions.
  ///
  /// In en, this message translates to:
  /// **'Monthly Subscriptions'**
  String get monthlySubscriptions;

  /// No description provided for @habitCalculator.
  ///
  /// In en, this message translates to:
  /// **'Habit Calculator'**
  String get habitCalculator;

  /// No description provided for @selectHabit.
  ///
  /// In en, this message translates to:
  /// **'Select a Habit'**
  String get selectHabit;

  /// No description provided for @enterAmount.
  ///
  /// In en, this message translates to:
  /// **'Enter Amount'**
  String get enterAmount;

  /// No description provided for @dailyAmount.
  ///
  /// In en, this message translates to:
  /// **'Daily Amount'**
  String get dailyAmount;

  /// No description provided for @yearlyCost.
  ///
  /// In en, this message translates to:
  /// **'Yearly Cost'**
  String get yearlyCost;

  /// No description provided for @workDaysEquivalent.
  ///
  /// In en, this message translates to:
  /// **'Work Days Equivalent'**
  String get workDaysEquivalent;

  /// No description provided for @shareResult.
  ///
  /// In en, this message translates to:
  /// **'Share Result'**
  String get shareResult;

  /// No description provided for @habitQuestion.
  ///
  /// In en, this message translates to:
  /// **'How many days does your habit cost?'**
  String get habitQuestion;

  /// No description provided for @calculateAndShock.
  ///
  /// In en, this message translates to:
  /// **'Calculate and be shocked →'**
  String get calculateAndShock;

  /// No description provided for @appTour.
  ///
  /// In en, this message translates to:
  /// **'App Tour'**
  String get appTour;

  /// No description provided for @repeatTour.
  ///
  /// In en, this message translates to:
  /// **'Repeat App Tour'**
  String get repeatTour;

  /// No description provided for @tourCompleted.
  ///
  /// In en, this message translates to:
  /// **'Tour Completed'**
  String get tourCompleted;

  /// No description provided for @notifications.
  ///
  /// In en, this message translates to:
  /// **'Notifications'**
  String get notifications;

  /// No description provided for @notificationSettings.
  ///
  /// In en, this message translates to:
  /// **'Notifications'**
  String get notificationSettings;

  /// No description provided for @streakReminder.
  ///
  /// In en, this message translates to:
  /// **'Streak Reminder'**
  String get streakReminder;

  /// No description provided for @weeklyInsights.
  ///
  /// In en, this message translates to:
  /// **'Weekly Insights'**
  String get weeklyInsights;

  /// No description provided for @error.
  ///
  /// In en, this message translates to:
  /// **'Error'**
  String get error;

  /// No description provided for @success.
  ///
  /// In en, this message translates to:
  /// **'Success'**
  String get success;

  /// No description provided for @warning.
  ///
  /// In en, this message translates to:
  /// **'Warning'**
  String get warning;

  /// No description provided for @info.
  ///
  /// In en, this message translates to:
  /// **'Info'**
  String get info;

  /// No description provided for @retry.
  ///
  /// In en, this message translates to:
  /// **'Retry'**
  String get retry;

  /// No description provided for @loading.
  ///
  /// In en, this message translates to:
  /// **'Loading...'**
  String get loading;

  /// No description provided for @noData.
  ///
  /// In en, this message translates to:
  /// **'No data available'**
  String get noData;

  /// No description provided for @noExpenses.
  ///
  /// In en, this message translates to:
  /// **'No expenses yet'**
  String get noExpenses;

  /// No description provided for @noExpensesHint.
  ///
  /// In en, this message translates to:
  /// **'Enter an amount above to start'**
  String get noExpensesHint;

  /// No description provided for @noAchievements.
  ///
  /// In en, this message translates to:
  /// **'No achievements yet'**
  String get noAchievements;

  /// No description provided for @recordToEarnBadge.
  ///
  /// In en, this message translates to:
  /// **'Record expenses to earn badges'**
  String get recordToEarnBadge;

  /// No description provided for @notEnoughDataForReports.
  ///
  /// In en, this message translates to:
  /// **'Not enough data for reports'**
  String get notEnoughDataForReports;

  /// No description provided for @confirmDelete.
  ///
  /// In en, this message translates to:
  /// **'Are you sure you want to delete?'**
  String get confirmDelete;

  /// No description provided for @deleteConfirmation.
  ///
  /// In en, this message translates to:
  /// **'This action cannot be undone.'**
  String get deleteConfirmation;

  /// No description provided for @categoryFood.
  ///
  /// In en, this message translates to:
  /// **'Food'**
  String get categoryFood;

  /// No description provided for @categoryTransport.
  ///
  /// In en, this message translates to:
  /// **'Transport'**
  String get categoryTransport;

  /// No description provided for @categoryEntertainment.
  ///
  /// In en, this message translates to:
  /// **'Entertainment'**
  String get categoryEntertainment;

  /// No description provided for @categoryShopping.
  ///
  /// In en, this message translates to:
  /// **'Shopping'**
  String get categoryShopping;

  /// No description provided for @categoryBills.
  ///
  /// In en, this message translates to:
  /// **'Bills'**
  String get categoryBills;

  /// No description provided for @categoryHealth.
  ///
  /// In en, this message translates to:
  /// **'Health'**
  String get categoryHealth;

  /// No description provided for @categoryEducation.
  ///
  /// In en, this message translates to:
  /// **'Education'**
  String get categoryEducation;

  /// No description provided for @categoryDigital.
  ///
  /// In en, this message translates to:
  /// **'Digital'**
  String get categoryDigital;

  /// No description provided for @categoryOther.
  ///
  /// In en, this message translates to:
  /// **'Other'**
  String get categoryOther;

  /// No description provided for @categoryClothing.
  ///
  /// In en, this message translates to:
  /// **'Clothing'**
  String get categoryClothing;

  /// No description provided for @categoryElectronics.
  ///
  /// In en, this message translates to:
  /// **'Electronics'**
  String get categoryElectronics;

  /// No description provided for @categorySubscription.
  ///
  /// In en, this message translates to:
  /// **'Subscription'**
  String get categorySubscription;

  /// No description provided for @weekdayMonday.
  ///
  /// In en, this message translates to:
  /// **'Monday'**
  String get weekdayMonday;

  /// No description provided for @weekdayTuesday.
  ///
  /// In en, this message translates to:
  /// **'Tuesday'**
  String get weekdayTuesday;

  /// No description provided for @weekdayWednesday.
  ///
  /// In en, this message translates to:
  /// **'Wednesday'**
  String get weekdayWednesday;

  /// No description provided for @weekdayThursday.
  ///
  /// In en, this message translates to:
  /// **'Thursday'**
  String get weekdayThursday;

  /// No description provided for @weekdayFriday.
  ///
  /// In en, this message translates to:
  /// **'Friday'**
  String get weekdayFriday;

  /// No description provided for @weekdaySaturday.
  ///
  /// In en, this message translates to:
  /// **'Saturday'**
  String get weekdaySaturday;

  /// No description provided for @weekdaySunday.
  ///
  /// In en, this message translates to:
  /// **'Sunday'**
  String get weekdaySunday;

  /// No description provided for @shareTitle.
  ///
  /// In en, this message translates to:
  /// **'Check out my savings with Vantag!'**
  String get shareTitle;

  /// No description provided for @shareMessage.
  ///
  /// In en, this message translates to:
  /// **'I saved {amount} TL this month with Vantag!'**
  String shareMessage(String amount);

  /// No description provided for @currencyRates.
  ///
  /// In en, this message translates to:
  /// **'Currency Rates'**
  String get currencyRates;

  /// No description provided for @currencyRatesDescription.
  ///
  /// In en, this message translates to:
  /// **'Current USD, EUR and gold prices. Tap for details.'**
  String get currencyRatesDescription;

  /// No description provided for @gold.
  ///
  /// In en, this message translates to:
  /// **'Gold'**
  String get gold;

  /// No description provided for @dollar.
  ///
  /// In en, this message translates to:
  /// **'Dollar'**
  String get dollar;

  /// No description provided for @euro.
  ///
  /// In en, this message translates to:
  /// **'Euro'**
  String get euro;

  /// No description provided for @moneySavedInPocket.
  ///
  /// In en, this message translates to:
  /// **'Money stayed in your pocket!'**
  String get moneySavedInPocket;

  /// No description provided for @greatDecision.
  ///
  /// In en, this message translates to:
  /// **'Great decision!'**
  String get greatDecision;

  /// No description provided for @freedomCloser.
  ///
  /// In en, this message translates to:
  /// **'Money stayed in pocket, you\'re {hours} closer to freedom!'**
  String freedomCloser(String hours);

  /// No description provided for @version.
  ///
  /// In en, this message translates to:
  /// **'Version'**
  String get version;

  /// No description provided for @privacyPolicy.
  ///
  /// In en, this message translates to:
  /// **'Privacy Policy'**
  String get privacyPolicy;

  /// No description provided for @termsOfService.
  ///
  /// In en, this message translates to:
  /// **'Terms of Service'**
  String get termsOfService;

  /// No description provided for @about.
  ///
  /// In en, this message translates to:
  /// **'About'**
  String get about;

  /// No description provided for @dangerZone.
  ///
  /// In en, this message translates to:
  /// **'Danger Zone'**
  String get dangerZone;

  /// No description provided for @appVersion.
  ///
  /// In en, this message translates to:
  /// **'App Version'**
  String get appVersion;

  /// No description provided for @signOut.
  ///
  /// In en, this message translates to:
  /// **'Sign Out'**
  String get signOut;

  /// No description provided for @deleteAccount.
  ///
  /// In en, this message translates to:
  /// **'Delete My Account'**
  String get deleteAccount;

  /// No description provided for @greetingMorning.
  ///
  /// In en, this message translates to:
  /// **'Good morning'**
  String get greetingMorning;

  /// No description provided for @greetingAfternoon.
  ///
  /// In en, this message translates to:
  /// **'Good afternoon'**
  String get greetingAfternoon;

  /// No description provided for @greetingEvening.
  ///
  /// In en, this message translates to:
  /// **'Good evening'**
  String get greetingEvening;

  /// No description provided for @financialStatus.
  ///
  /// In en, this message translates to:
  /// **'Financial Status'**
  String get financialStatus;

  /// No description provided for @financialSummary.
  ///
  /// In en, this message translates to:
  /// **'Financial Summary'**
  String get financialSummary;

  /// No description provided for @financialSummaryDescription.
  ///
  /// In en, this message translates to:
  /// **'Your monthly income, expenses and saved money here. All data updates in real-time.'**
  String get financialSummaryDescription;

  /// No description provided for @newExpense.
  ///
  /// In en, this message translates to:
  /// **'New Expense'**
  String get newExpense;

  /// No description provided for @editExpense.
  ///
  /// In en, this message translates to:
  /// **'Edit Expense'**
  String get editExpense;

  /// No description provided for @deleteExpense.
  ///
  /// In en, this message translates to:
  /// **'Delete Expense'**
  String get deleteExpense;

  /// No description provided for @deleteExpenseConfirm.
  ///
  /// In en, this message translates to:
  /// **'Are you sure you want to delete this expense?'**
  String get deleteExpenseConfirm;

  /// No description provided for @updateExpense.
  ///
  /// In en, this message translates to:
  /// **'Update'**
  String get updateExpense;

  /// No description provided for @expenseHistory.
  ///
  /// In en, this message translates to:
  /// **'History'**
  String get expenseHistory;

  /// No description provided for @recordCount.
  ///
  /// In en, this message translates to:
  /// **'{count} records'**
  String recordCount(int count);

  /// No description provided for @recordCountLimited.
  ///
  /// In en, this message translates to:
  /// **'{shown} of {total} records'**
  String recordCountLimited(int shown, int total);

  /// No description provided for @unlockFullHistory.
  ///
  /// In en, this message translates to:
  /// **'Unlock Full History'**
  String get unlockFullHistory;

  /// No description provided for @proHistoryDescription.
  ///
  /// In en, this message translates to:
  /// **'Free users can view last 30 days. Upgrade to Pro for unlimited history.'**
  String proHistoryDescription(int count);

  /// No description provided for @upgradeToPro.
  ///
  /// In en, this message translates to:
  /// **'Upgrade to Pro'**
  String get upgradeToPro;

  /// No description provided for @streakTracking.
  ///
  /// In en, this message translates to:
  /// **'Streak Tracking'**
  String get streakTracking;

  /// No description provided for @streakTrackingDescription.
  ///
  /// In en, this message translates to:
  /// **'Your streak increases with daily entries. Regular tracking is key to mindful spending!'**
  String get streakTrackingDescription;

  /// No description provided for @pastDateSelection.
  ///
  /// In en, this message translates to:
  /// **'Past Date Selection'**
  String get pastDateSelection;

  /// No description provided for @pastDateSelectionDescription.
  ///
  /// In en, this message translates to:
  /// **'You can also enter expenses from yesterday or previous days. Tap the calendar icon to select any date.'**
  String get pastDateSelectionDescription;

  /// No description provided for @amountEntry.
  ///
  /// In en, this message translates to:
  /// **'Amount Entry'**
  String get amountEntry;

  /// No description provided for @amountEntryDescription.
  ///
  /// In en, this message translates to:
  /// **'Enter the expense amount here. Use the receipt scan button to read from receipt automatically.'**
  String get amountEntryDescription;

  /// No description provided for @smartMatching.
  ///
  /// In en, this message translates to:
  /// **'Smart Matching'**
  String get smartMatching;

  /// No description provided for @smartMatchingDescription.
  ///
  /// In en, this message translates to:
  /// **'Type the store or product name. Migros, A101, Starbucks... The app will automatically suggest a category!'**
  String get smartMatchingDescription;

  /// No description provided for @categorySelection.
  ///
  /// In en, this message translates to:
  /// **'Category Selection'**
  String get categorySelection;

  /// No description provided for @categorySelectionDescription.
  ///
  /// In en, this message translates to:
  /// **'If smart matching doesn\'t find it or you want to change, you can manually select here.'**
  String get categorySelectionDescription;

  /// No description provided for @selectCategory.
  ///
  /// In en, this message translates to:
  /// **'Select Category'**
  String get selectCategory;

  /// No description provided for @autoSelected.
  ///
  /// In en, this message translates to:
  /// **'Auto-selected: {category}'**
  String autoSelected(String category);

  /// No description provided for @pleaseSelectCategory.
  ///
  /// In en, this message translates to:
  /// **'Please select a category'**
  String get pleaseSelectCategory;

  /// No description provided for @subCategoryOptional.
  ///
  /// In en, this message translates to:
  /// **'Sub-category (optional)'**
  String get subCategoryOptional;

  /// No description provided for @recentlyUsed.
  ///
  /// In en, this message translates to:
  /// **'Recently used'**
  String get recentlyUsed;

  /// No description provided for @suggestions.
  ///
  /// In en, this message translates to:
  /// **'Suggestions'**
  String get suggestions;

  /// No description provided for @scanReceipt.
  ///
  /// In en, this message translates to:
  /// **'Scan receipt'**
  String get scanReceipt;

  /// No description provided for @cameraCapture.
  ///
  /// In en, this message translates to:
  /// **'Capture with camera'**
  String get cameraCapture;

  /// No description provided for @selectFromGallery.
  ///
  /// In en, this message translates to:
  /// **'Select from gallery'**
  String get selectFromGallery;

  /// No description provided for @amountFound.
  ///
  /// In en, this message translates to:
  /// **'Amount found: {amount} ₺'**
  String amountFound(String amount);

  /// No description provided for @amountNotFound.
  ///
  /// In en, this message translates to:
  /// **'Amount not found. Enter manually.'**
  String get amountNotFound;

  /// No description provided for @scanError.
  ///
  /// In en, this message translates to:
  /// **'Scan error. Try again.'**
  String get scanError;

  /// No description provided for @selectExpenseDate.
  ///
  /// In en, this message translates to:
  /// **'Select Expense Date'**
  String get selectExpenseDate;

  /// No description provided for @decisionUpdatedBought.
  ///
  /// In en, this message translates to:
  /// **'Decision updated: Bought'**
  String get decisionUpdatedBought;

  /// No description provided for @decisionSaved.
  ///
  /// In en, this message translates to:
  /// **'You passed, saved {amount} TL!'**
  String decisionSaved(String amount);

  /// No description provided for @keepThinking.
  ///
  /// In en, this message translates to:
  /// **'Keep thinking'**
  String get keepThinking;

  /// No description provided for @expenseUpdated.
  ///
  /// In en, this message translates to:
  /// **'Expense updated'**
  String get expenseUpdated;

  /// No description provided for @validationEnterAmount.
  ///
  /// In en, this message translates to:
  /// **'Please enter a valid amount'**
  String get validationEnterAmount;

  /// No description provided for @validationAmountPositive.
  ///
  /// In en, this message translates to:
  /// **'Amount must be greater than 0'**
  String get validationAmountPositive;

  /// No description provided for @validationAmountTooHigh.
  ///
  /// In en, this message translates to:
  /// **'Amount seems too high'**
  String get validationAmountTooHigh;

  /// No description provided for @simulationSaved.
  ///
  /// In en, this message translates to:
  /// **'Saved as Simulation'**
  String get simulationSaved;

  /// No description provided for @simulationDescription.
  ///
  /// In en, this message translates to:
  /// **'This amount was saved as simulation because it\'s large.'**
  String get simulationDescription;

  /// No description provided for @simulationInfo.
  ///
  /// In en, this message translates to:
  /// **'Does not affect your statistics, just for reference.'**
  String get simulationInfo;

  /// No description provided for @understood.
  ///
  /// In en, this message translates to:
  /// **'Understood'**
  String get understood;

  /// No description provided for @largeAmountTitle.
  ///
  /// In en, this message translates to:
  /// **'Large Amount'**
  String get largeAmountTitle;

  /// No description provided for @largeAmountMessage.
  ///
  /// In en, this message translates to:
  /// **'Is this a real expense or a simulation?'**
  String get largeAmountMessage;

  /// No description provided for @realExpenseButton.
  ///
  /// In en, this message translates to:
  /// **'Real Expense'**
  String get realExpenseButton;

  /// No description provided for @simulationButton.
  ///
  /// In en, this message translates to:
  /// **'Simulation'**
  String get simulationButton;

  /// No description provided for @monthJanuary.
  ///
  /// In en, this message translates to:
  /// **'January'**
  String get monthJanuary;

  /// No description provided for @monthFebruary.
  ///
  /// In en, this message translates to:
  /// **'February'**
  String get monthFebruary;

  /// No description provided for @monthMarch.
  ///
  /// In en, this message translates to:
  /// **'March'**
  String get monthMarch;

  /// No description provided for @monthApril.
  ///
  /// In en, this message translates to:
  /// **'April'**
  String get monthApril;

  /// No description provided for @monthJune.
  ///
  /// In en, this message translates to:
  /// **'June'**
  String get monthJune;

  /// No description provided for @monthJuly.
  ///
  /// In en, this message translates to:
  /// **'July'**
  String get monthJuly;

  /// No description provided for @monthAugust.
  ///
  /// In en, this message translates to:
  /// **'August'**
  String get monthAugust;

  /// No description provided for @monthSeptember.
  ///
  /// In en, this message translates to:
  /// **'September'**
  String get monthSeptember;

  /// No description provided for @monthOctober.
  ///
  /// In en, this message translates to:
  /// **'October'**
  String get monthOctober;

  /// No description provided for @monthNovember.
  ///
  /// In en, this message translates to:
  /// **'November'**
  String get monthNovember;

  /// No description provided for @monthDecember.
  ///
  /// In en, this message translates to:
  /// **'December'**
  String get monthDecember;

  /// No description provided for @categoryDistribution.
  ///
  /// In en, this message translates to:
  /// **'Category Distribution'**
  String get categoryDistribution;

  /// No description provided for @moreCategories.
  ///
  /// In en, this message translates to:
  /// **'+{count} more categories'**
  String moreCategories(int count);

  /// No description provided for @expenseCount.
  ///
  /// In en, this message translates to:
  /// **'Expense Count'**
  String get expenseCount;

  /// No description provided for @boughtPassed.
  ///
  /// In en, this message translates to:
  /// **'{bought} bought, {passed} passed'**
  String boughtPassed(int bought, int passed);

  /// No description provided for @passRate.
  ///
  /// In en, this message translates to:
  /// **'Pass Rate'**
  String get passRate;

  /// No description provided for @doingGreat.
  ///
  /// In en, this message translates to:
  /// **'You\'re doing great!'**
  String get doingGreat;

  /// No description provided for @canDoBetter.
  ///
  /// In en, this message translates to:
  /// **'You can do better'**
  String get canDoBetter;

  /// No description provided for @statistics.
  ///
  /// In en, this message translates to:
  /// **'Statistics'**
  String get statistics;

  /// No description provided for @avgDailyExpense.
  ///
  /// In en, this message translates to:
  /// **'Average Daily Expense'**
  String get avgDailyExpense;

  /// No description provided for @highestSingleExpense.
  ///
  /// In en, this message translates to:
  /// **'Highest Single Expense'**
  String get highestSingleExpense;

  /// No description provided for @mostDeclinedCategory.
  ///
  /// In en, this message translates to:
  /// **'Most Declined Category'**
  String get mostDeclinedCategory;

  /// No description provided for @times.
  ///
  /// In en, this message translates to:
  /// **'{count} times'**
  String times(int count);

  /// No description provided for @trend.
  ///
  /// In en, this message translates to:
  /// **'Trend'**
  String get trend;

  /// No description provided for @trendSpentThisPeriod.
  ///
  /// In en, this message translates to:
  /// **'You spent {amount} TL this {period}'**
  String trendSpentThisPeriod(String amount, String period);

  /// No description provided for @trendSameAsPrevious.
  ///
  /// In en, this message translates to:
  /// **'Same spending as last {period}'**
  String trendSameAsPrevious(String period);

  /// No description provided for @trendSpentLess.
  ///
  /// In en, this message translates to:
  /// **'You spent {percent}% less than last {period}'**
  String trendSpentLess(String percent, String period);

  /// No description provided for @trendSpentMore.
  ///
  /// In en, this message translates to:
  /// **'You spent {percent}% more than last {period}'**
  String trendSpentMore(String percent, String period);

  /// No description provided for @periodWeek.
  ///
  /// In en, this message translates to:
  /// **'week'**
  String get periodWeek;

  /// No description provided for @periodMonth.
  ///
  /// In en, this message translates to:
  /// **'month'**
  String get periodMonth;

  /// No description provided for @subCategoryDetail.
  ///
  /// In en, this message translates to:
  /// **'Sub-Category Detail'**
  String get subCategoryDetail;

  /// No description provided for @comparedToPrevious.
  ///
  /// In en, this message translates to:
  /// **'Compared to previous period'**
  String get comparedToPrevious;

  /// No description provided for @increased.
  ///
  /// In en, this message translates to:
  /// **'increased'**
  String get increased;

  /// No description provided for @decreased.
  ///
  /// In en, this message translates to:
  /// **'decreased'**
  String get decreased;

  /// No description provided for @subCategoryChange.
  ///
  /// In en, this message translates to:
  /// **'This {period} your {subCategory} spending {changeText} by {percent}% compared to last {previousPeriod}.'**
  String subCategoryChange(
    String period,
    String subCategory,
    String changeText,
    String percent,
    String previousPeriod,
  );

  /// No description provided for @listView.
  ///
  /// In en, this message translates to:
  /// **'List View'**
  String get listView;

  /// No description provided for @calendarView.
  ///
  /// In en, this message translates to:
  /// **'Calendar View'**
  String get calendarView;

  /// No description provided for @subscription.
  ///
  /// In en, this message translates to:
  /// **'subscription'**
  String get subscription;

  /// No description provided for @workDaysPerMonth.
  ///
  /// In en, this message translates to:
  /// **'work days/month'**
  String get workDaysPerMonth;

  /// No description provided for @everyMonthDay.
  ///
  /// In en, this message translates to:
  /// **'Every {day}th of month'**
  String everyMonthDay(int day);

  /// No description provided for @noSubscriptionsYet.
  ///
  /// In en, this message translates to:
  /// **'No subscriptions yet'**
  String get noSubscriptionsYet;

  /// No description provided for @addSubscriptionsLikeNetflix.
  ///
  /// In en, this message translates to:
  /// **'Add your subscriptions like Netflix, Spotify'**
  String get addSubscriptionsLikeNetflix;

  /// No description provided for @monthlyTotalAmount.
  ///
  /// In en, this message translates to:
  /// **'Monthly total: {amount} TL'**
  String monthlyTotalAmount(String amount);

  /// No description provided for @dayOfMonth.
  ///
  /// In en, this message translates to:
  /// **'Day {day}'**
  String dayOfMonth(int day);

  /// No description provided for @addSubscriptionHint.
  ///
  /// In en, this message translates to:
  /// **'Press + button to add a new subscription'**
  String get addSubscriptionHint;

  /// No description provided for @tomorrow.
  ///
  /// In en, this message translates to:
  /// **'Tomorrow'**
  String get tomorrow;

  /// No description provided for @daysLater.
  ///
  /// In en, this message translates to:
  /// **'in {days} days'**
  String daysLater(int days);

  /// No description provided for @perMonth.
  ///
  /// In en, this message translates to:
  /// **'/month'**
  String get perMonth;

  /// No description provided for @enterSubscriptionName.
  ///
  /// In en, this message translates to:
  /// **'Enter subscription name'**
  String get enterSubscriptionName;

  /// No description provided for @enterValidAmount.
  ///
  /// In en, this message translates to:
  /// **'Enter a valid amount'**
  String get enterValidAmount;

  /// No description provided for @editSubscription.
  ///
  /// In en, this message translates to:
  /// **'Edit Subscription'**
  String get editSubscription;

  /// No description provided for @newSubscription.
  ///
  /// In en, this message translates to:
  /// **'New Subscription'**
  String get newSubscription;

  /// No description provided for @subscriptionName.
  ///
  /// In en, this message translates to:
  /// **'Subscription Name'**
  String get subscriptionName;

  /// No description provided for @subscriptionNameHint.
  ///
  /// In en, this message translates to:
  /// **'Netflix, Spotify...'**
  String get subscriptionNameHint;

  /// No description provided for @monthlyAmount.
  ///
  /// In en, this message translates to:
  /// **'Monthly Amount'**
  String get monthlyAmount;

  /// No description provided for @renewalDay.
  ///
  /// In en, this message translates to:
  /// **'Renewal Day'**
  String get renewalDay;

  /// No description provided for @active.
  ///
  /// In en, this message translates to:
  /// **'Active'**
  String get active;

  /// No description provided for @passivesNotIncluded.
  ///
  /// In en, this message translates to:
  /// **'Passive subscriptions not included in notifications'**
  String get passivesNotIncluded;

  /// No description provided for @autoRecord.
  ///
  /// In en, this message translates to:
  /// **'Auto Record'**
  String get autoRecord;

  /// No description provided for @autoRecordDescription.
  ///
  /// In en, this message translates to:
  /// **'Expense will be automatically added on billing date'**
  String get autoRecordDescription;

  /// No description provided for @add.
  ///
  /// In en, this message translates to:
  /// **'Add'**
  String get add;

  /// No description provided for @subscriptionCount.
  ///
  /// In en, this message translates to:
  /// **'{count} subscriptions, {amount} ₺/month'**
  String subscriptionCount(int count, String amount);

  /// No description provided for @viewSubscriptionsInCalendar.
  ///
  /// In en, this message translates to:
  /// **'View your subscriptions in calendar'**
  String get viewSubscriptionsInCalendar;

  /// No description provided for @urgentRenewalWarning.
  ///
  /// In en, this message translates to:
  /// **'Urgent Renewal Warning!'**
  String get urgentRenewalWarning;

  /// No description provided for @upcomingRenewals.
  ///
  /// In en, this message translates to:
  /// **'Upcoming Renewals'**
  String get upcomingRenewals;

  /// No description provided for @renewsWithinOneHour.
  ///
  /// In en, this message translates to:
  /// **'{name} - renews within 1 hour'**
  String renewsWithinOneHour(String name);

  /// No description provided for @renewsWithinHours.
  ///
  /// In en, this message translates to:
  /// **'{name} - in {hours} hours'**
  String renewsWithinHours(String name, int hours);

  /// No description provided for @renewsToday.
  ///
  /// In en, this message translates to:
  /// **'{name} - renews today'**
  String renewsToday(String name);

  /// No description provided for @renewsTomorrow.
  ///
  /// In en, this message translates to:
  /// **'{name} - renews tomorrow'**
  String renewsTomorrow(String name);

  /// No description provided for @subscriptionsRenewingSoon.
  ///
  /// In en, this message translates to:
  /// **'{count} subscriptions renewing soon'**
  String subscriptionsRenewingSoon(int count);

  /// No description provided for @amountPerMonth.
  ///
  /// In en, this message translates to:
  /// **'{amount} ₺/month'**
  String amountPerMonth(String amount);

  /// No description provided for @hiddenBadges.
  ///
  /// In en, this message translates to:
  /// **'Hidden Badges'**
  String get hiddenBadges;

  /// No description provided for @badgesEarned.
  ///
  /// In en, this message translates to:
  /// **'{unlocked} / {total} badges earned'**
  String badgesEarned(int unlocked, int total);

  /// No description provided for @percentComplete.
  ///
  /// In en, this message translates to:
  /// **'{percent}% complete'**
  String percentComplete(String percent);

  /// No description provided for @completed.
  ///
  /// In en, this message translates to:
  /// **'Completed!'**
  String get completed;

  /// No description provided for @startRecordingForFirstBadge.
  ///
  /// In en, this message translates to:
  /// **'Record an expense to earn your first badge!'**
  String get startRecordingForFirstBadge;

  /// No description provided for @greatStartKeepGoing.
  ///
  /// In en, this message translates to:
  /// **'Great start, keep going!'**
  String get greatStartKeepGoing;

  /// No description provided for @halfwayThere.
  ///
  /// In en, this message translates to:
  /// **'Halfway there, keep it up!'**
  String get halfwayThere;

  /// No description provided for @doingVeryWell.
  ///
  /// In en, this message translates to:
  /// **'You\'re doing very well!'**
  String get doingVeryWell;

  /// No description provided for @almostDone.
  ///
  /// In en, this message translates to:
  /// **'Almost there!'**
  String get almostDone;

  /// No description provided for @allBadgesEarned.
  ///
  /// In en, this message translates to:
  /// **'All badges earned, congratulations!'**
  String get allBadgesEarned;

  /// No description provided for @hiddenBadge.
  ///
  /// In en, this message translates to:
  /// **'Hidden Badge'**
  String get hiddenBadge;

  /// No description provided for @discoverHowToUnlock.
  ///
  /// In en, this message translates to:
  /// **'Discover how to unlock!'**
  String get discoverHowToUnlock;

  /// No description provided for @difficultyEasy.
  ///
  /// In en, this message translates to:
  /// **'Easy'**
  String get difficultyEasy;

  /// No description provided for @difficultyMedium.
  ///
  /// In en, this message translates to:
  /// **'Medium'**
  String get difficultyMedium;

  /// No description provided for @difficultyHard.
  ///
  /// In en, this message translates to:
  /// **'Hard'**
  String get difficultyHard;

  /// No description provided for @difficultyLegendary.
  ///
  /// In en, this message translates to:
  /// **'Legendary'**
  String get difficultyLegendary;

  /// No description provided for @earnedToday.
  ///
  /// In en, this message translates to:
  /// **'Earned today!'**
  String get earnedToday;

  /// No description provided for @earnedYesterday.
  ///
  /// In en, this message translates to:
  /// **'Earned yesterday'**
  String get earnedYesterday;

  /// No description provided for @daysAgoEarned.
  ///
  /// In en, this message translates to:
  /// **'{count} days ago'**
  String daysAgoEarned(int count);

  /// No description provided for @weeksAgoEarned.
  ///
  /// In en, this message translates to:
  /// **'{count} weeks ago'**
  String weeksAgoEarned(int count);

  /// No description provided for @tapToAddPhoto.
  ///
  /// In en, this message translates to:
  /// **'Tap to add photo'**
  String get tapToAddPhoto;

  /// No description provided for @dailyWork.
  ///
  /// In en, this message translates to:
  /// **'Daily Work'**
  String get dailyWork;

  /// No description provided for @weeklyWorkingDays.
  ///
  /// In en, this message translates to:
  /// **'Weekly Working Days'**
  String get weeklyWorkingDays;

  /// No description provided for @hourlyEarnings.
  ///
  /// In en, this message translates to:
  /// **'Hourly Earnings'**
  String get hourlyEarnings;

  /// No description provided for @hourAbbreviation.
  ///
  /// In en, this message translates to:
  /// **'h'**
  String get hourAbbreviation;

  /// No description provided for @days.
  ///
  /// In en, this message translates to:
  /// **'days'**
  String get days;

  /// No description provided for @resetData.
  ///
  /// In en, this message translates to:
  /// **'Reset Data'**
  String get resetData;

  /// No description provided for @resetDataDebug.
  ///
  /// In en, this message translates to:
  /// **'Reset Data (DEBUG)'**
  String get resetDataDebug;

  /// No description provided for @resetDataTitle.
  ///
  /// In en, this message translates to:
  /// **'Reset Data'**
  String get resetDataTitle;

  /// No description provided for @resetDataMessage.
  ///
  /// In en, this message translates to:
  /// **'All app data will be deleted. This action cannot be undone.'**
  String get resetDataMessage;

  /// No description provided for @deleteAccountWarningTitle.
  ///
  /// In en, this message translates to:
  /// **'You Are About to Delete Your Account'**
  String get deleteAccountWarningTitle;

  /// No description provided for @deleteAccountWarningMessage.
  ///
  /// In en, this message translates to:
  /// **'This action cannot be undone! All your data will be permanently deleted:\n\n• Expenses\n• Income\n• Installments\n• Achievements\n• Settings'**
  String get deleteAccountWarningMessage;

  /// No description provided for @deleteAccountConfirmPlaceholder.
  ///
  /// In en, this message translates to:
  /// **'Type \'I confirm\' to confirm'**
  String get deleteAccountConfirmPlaceholder;

  /// No description provided for @deleteAccountConfirmWord.
  ///
  /// In en, this message translates to:
  /// **'I confirm'**
  String get deleteAccountConfirmWord;

  /// No description provided for @deleteAccountButton.
  ///
  /// In en, this message translates to:
  /// **'Delete Account'**
  String get deleteAccountButton;

  /// No description provided for @deleteAccountSuccess.
  ///
  /// In en, this message translates to:
  /// **'Your account has been successfully deleted'**
  String get deleteAccountSuccess;

  /// No description provided for @deleteAccountError.
  ///
  /// In en, this message translates to:
  /// **'An error occurred while deleting your account'**
  String get deleteAccountError;

  /// No description provided for @notificationTypes.
  ///
  /// In en, this message translates to:
  /// **'Notification Types'**
  String get notificationTypes;

  /// No description provided for @awarenessReminder.
  ///
  /// In en, this message translates to:
  /// **'Awareness Reminder'**
  String get awarenessReminder;

  /// No description provided for @awarenessReminderDesc.
  ///
  /// In en, this message translates to:
  /// **'6-12 hours after high-value purchases'**
  String get awarenessReminderDesc;

  /// No description provided for @giveUpCongrats.
  ///
  /// In en, this message translates to:
  /// **'Pass Congratulation'**
  String get giveUpCongrats;

  /// No description provided for @giveUpCongratsDesc.
  ///
  /// In en, this message translates to:
  /// **'Same day motivation when you pass'**
  String get giveUpCongratsDesc;

  /// No description provided for @streakReminderDesc.
  ///
  /// In en, this message translates to:
  /// **'Evening, before streak breaks'**
  String get streakReminderDesc;

  /// No description provided for @weeklySummary.
  ///
  /// In en, this message translates to:
  /// **'Weekly Summary'**
  String get weeklySummary;

  /// No description provided for @weeklySummaryDesc.
  ///
  /// In en, this message translates to:
  /// **'Sunday weekly insight'**
  String get weeklySummaryDesc;

  /// No description provided for @nightModeNotice.
  ///
  /// In en, this message translates to:
  /// **'No notifications during night hours (22:00-08:00). We won\'t disturb your sleep.'**
  String get nightModeNotice;

  /// No description provided for @on.
  ///
  /// In en, this message translates to:
  /// **'On'**
  String get on;

  /// No description provided for @off.
  ///
  /// In en, this message translates to:
  /// **'Off'**
  String get off;

  /// No description provided for @lastUpdate.
  ///
  /// In en, this message translates to:
  /// **'Last Update'**
  String get lastUpdate;

  /// No description provided for @rates.
  ///
  /// In en, this message translates to:
  /// **'Rates'**
  String get rates;

  /// No description provided for @usDollar.
  ///
  /// In en, this message translates to:
  /// **'US Dollar'**
  String get usDollar;

  /// No description provided for @gramGold.
  ///
  /// In en, this message translates to:
  /// **'Gram Gold'**
  String get gramGold;

  /// No description provided for @tcmbNotice.
  ///
  /// In en, this message translates to:
  /// **'Rates are from TCMB (Central Bank of the Republic of Turkey). Gold prices reflect real-time market data.'**
  String get tcmbNotice;

  /// No description provided for @buy.
  ///
  /// In en, this message translates to:
  /// **'Buy'**
  String get buy;

  /// No description provided for @sell.
  ///
  /// In en, this message translates to:
  /// **'Sell'**
  String get sell;

  /// No description provided for @createOwnCategory.
  ///
  /// In en, this message translates to:
  /// **'Create Your Own Category'**
  String get createOwnCategory;

  /// No description provided for @selectEmoji.
  ///
  /// In en, this message translates to:
  /// **'Select Emoji'**
  String get selectEmoji;

  /// No description provided for @categoryName.
  ///
  /// In en, this message translates to:
  /// **'Category Name'**
  String get categoryName;

  /// No description provided for @categoryNameHint.
  ///
  /// In en, this message translates to:
  /// **'e.g: Starbucks'**
  String get categoryNameHint;

  /// No description provided for @continueButton.
  ///
  /// In en, this message translates to:
  /// **'Continue'**
  String get continueButton;

  /// No description provided for @howManyDaysForHabit.
  ///
  /// In en, this message translates to:
  /// **'How many days do you work for what?'**
  String get howManyDaysForHabit;

  /// No description provided for @selectHabitShock.
  ///
  /// In en, this message translates to:
  /// **'Select a habit, be shocked'**
  String get selectHabitShock;

  /// No description provided for @addMyOwnCategory.
  ///
  /// In en, this message translates to:
  /// **'Add my own category'**
  String get addMyOwnCategory;

  /// No description provided for @whatIsYourSalary.
  ///
  /// In en, this message translates to:
  /// **'What\'s Your Monthly Salary?'**
  String get whatIsYourSalary;

  /// No description provided for @enterNetAmount.
  ///
  /// In en, this message translates to:
  /// **'Enter net take-home amount'**
  String get enterNetAmount;

  /// No description provided for @howMuchPerTime.
  ///
  /// In en, this message translates to:
  /// **'How much TL do you spend per time?'**
  String get howMuchPerTime;

  /// No description provided for @tl.
  ///
  /// In en, this message translates to:
  /// **'TL'**
  String get tl;

  /// No description provided for @howOften.
  ///
  /// In en, this message translates to:
  /// **'How often?'**
  String get howOften;

  /// No description provided for @whatIsYourIncome.
  ///
  /// In en, this message translates to:
  /// **'What\'s your monthly income?'**
  String get whatIsYourIncome;

  /// No description provided for @exampleAmount.
  ///
  /// In en, this message translates to:
  /// **'e.g: 20,000'**
  String get exampleAmount;

  /// No description provided for @dontWantToSay.
  ///
  /// In en, this message translates to:
  /// **'I don\'t want to say'**
  String get dontWantToSay;

  /// No description provided for @resultDays.
  ///
  /// In en, this message translates to:
  /// **'{value} DAYS'**
  String resultDays(String value);

  /// No description provided for @yearlyHabitCost.
  ///
  /// In en, this message translates to:
  /// **'You work this many days\njust for {habit} yearly'**
  String yearlyHabitCost(String habit);

  /// No description provided for @monthlyYearlyCost.
  ///
  /// In en, this message translates to:
  /// **'Monthly: {monthly} • Yearly: {yearly}'**
  String monthlyYearlyCost(String monthly, String yearly);

  /// No description provided for @shareOnStory.
  ///
  /// In en, this message translates to:
  /// **'Share on Story'**
  String get shareOnStory;

  /// No description provided for @tryAnotherHabit.
  ///
  /// In en, this message translates to:
  /// **'Try another habit'**
  String get tryAnotherHabit;

  /// No description provided for @trackAllExpenses.
  ///
  /// In en, this message translates to:
  /// **'Track all my expenses'**
  String get trackAllExpenses;

  /// No description provided for @habitCatCoffee.
  ///
  /// In en, this message translates to:
  /// **'Coffee'**
  String get habitCatCoffee;

  /// No description provided for @habitCatSmoking.
  ///
  /// In en, this message translates to:
  /// **'Smoking'**
  String get habitCatSmoking;

  /// No description provided for @habitCatEatingOut.
  ///
  /// In en, this message translates to:
  /// **'Eating Out'**
  String get habitCatEatingOut;

  /// No description provided for @habitCatGaming.
  ///
  /// In en, this message translates to:
  /// **'Gaming'**
  String get habitCatGaming;

  /// No description provided for @habitCatClothing.
  ///
  /// In en, this message translates to:
  /// **'Clothing'**
  String get habitCatClothing;

  /// No description provided for @habitCatTaxi.
  ///
  /// In en, this message translates to:
  /// **'Taxi/Uber'**
  String get habitCatTaxi;

  /// No description provided for @freqOnceDaily.
  ///
  /// In en, this message translates to:
  /// **'Once daily'**
  String get freqOnceDaily;

  /// No description provided for @freqTwiceDaily.
  ///
  /// In en, this message translates to:
  /// **'Twice daily'**
  String get freqTwiceDaily;

  /// No description provided for @freqEveryTwoDays.
  ///
  /// In en, this message translates to:
  /// **'Every 2 days'**
  String get freqEveryTwoDays;

  /// No description provided for @freqOnceWeekly.
  ///
  /// In en, this message translates to:
  /// **'Once weekly'**
  String get freqOnceWeekly;

  /// No description provided for @freqTwoThreeWeekly.
  ///
  /// In en, this message translates to:
  /// **'2-3x weekly'**
  String get freqTwoThreeWeekly;

  /// No description provided for @freqFewMonthly.
  ///
  /// In en, this message translates to:
  /// **'Few per month'**
  String get freqFewMonthly;

  /// No description provided for @habitSharePreText.
  ///
  /// In en, this message translates to:
  /// **'This habit takes'**
  String get habitSharePreText;

  /// No description provided for @habitShareWorkDays.
  ///
  /// In en, this message translates to:
  /// **'WORK DAYS'**
  String get habitShareWorkDays;

  /// No description provided for @habitSharePostText.
  ///
  /// In en, this message translates to:
  /// **'of work per year'**
  String get habitSharePostText;

  /// No description provided for @habitSharePerYear.
  ///
  /// In en, this message translates to:
  /// **'/year'**
  String get habitSharePerYear;

  /// No description provided for @habitShareCTA.
  ///
  /// In en, this message translates to:
  /// **'How many days are your habits?'**
  String get habitShareCTA;

  /// No description provided for @habitShareText.
  ///
  /// In en, this message translates to:
  /// **'How many days are your habits? 👀 vantag.app'**
  String get habitShareText;

  /// No description provided for @habitShareTextWithLink.
  ///
  /// In en, this message translates to:
  /// **'How many days are your habits? 👀 {link}'**
  String habitShareTextWithLink(String link);

  /// No description provided for @habitMonthlyDetail.
  ///
  /// In en, this message translates to:
  /// **'{days} days {hours} hours'**
  String habitMonthlyDetail(int days, int hours);

  /// No description provided for @editIncomes.
  ///
  /// In en, this message translates to:
  /// **'Edit Incomes'**
  String get editIncomes;

  /// No description provided for @editIncome.
  ///
  /// In en, this message translates to:
  /// **'Edit Income'**
  String get editIncome;

  /// No description provided for @addIncome.
  ///
  /// In en, this message translates to:
  /// **'Add Income'**
  String get addIncome;

  /// No description provided for @changePhoto.
  ///
  /// In en, this message translates to:
  /// **'Photo'**
  String get changePhoto;

  /// No description provided for @takePhoto.
  ///
  /// In en, this message translates to:
  /// **'Take Photo'**
  String get takePhoto;

  /// No description provided for @chooseFromGallery.
  ///
  /// In en, this message translates to:
  /// **'Choose from Gallery'**
  String get chooseFromGallery;

  /// No description provided for @removePhoto.
  ///
  /// In en, this message translates to:
  /// **'Remove Photo'**
  String get removePhoto;

  /// No description provided for @photoSelectError.
  ///
  /// In en, this message translates to:
  /// **'Could not select photo'**
  String get photoSelectError;

  /// No description provided for @editSalary.
  ///
  /// In en, this message translates to:
  /// **'Salary'**
  String get editSalary;

  /// No description provided for @editSalarySubtitle.
  ///
  /// In en, this message translates to:
  /// **'Update your monthly salary'**
  String get editSalarySubtitle;

  /// No description provided for @daysPerWeek.
  ///
  /// In en, this message translates to:
  /// **'days/week'**
  String get daysPerWeek;

  /// No description provided for @doYouHaveOtherIncome.
  ///
  /// In en, this message translates to:
  /// **'Do You Have\nOther Income?'**
  String get doYouHaveOtherIncome;

  /// No description provided for @otherIncomeDescription.
  ///
  /// In en, this message translates to:
  /// **'You can add additional incomes like\nfreelance, rental, investment income'**
  String get otherIncomeDescription;

  /// No description provided for @yesAddIncome.
  ///
  /// In en, this message translates to:
  /// **'Yes, I Want to Add'**
  String get yesAddIncome;

  /// No description provided for @noOnlySalary.
  ///
  /// In en, this message translates to:
  /// **'No, Only My Salary'**
  String get noOnlySalary;

  /// No description provided for @addAdditionalIncome.
  ///
  /// In en, this message translates to:
  /// **'+ Add Additional Income'**
  String get addAdditionalIncome;

  /// No description provided for @additionalIncomeQuestion.
  ///
  /// In en, this message translates to:
  /// **'Do you have additional income?'**
  String get additionalIncomeQuestion;

  /// No description provided for @budgetSettings.
  ///
  /// In en, this message translates to:
  /// **'Budget Settings'**
  String get budgetSettings;

  /// No description provided for @budgetSettingsHint.
  ///
  /// In en, this message translates to:
  /// **'Optional. If not set, it will be calculated based on your income.'**
  String get budgetSettingsHint;

  /// No description provided for @monthlySpendingLimit.
  ///
  /// In en, this message translates to:
  /// **'Monthly Spending Limit'**
  String get monthlySpendingLimit;

  /// No description provided for @monthlySpendingLimitHint.
  ///
  /// In en, this message translates to:
  /// **'How much do you want to spend this month?'**
  String get monthlySpendingLimitHint;

  /// No description provided for @monthlySavingsGoal.
  ///
  /// In en, this message translates to:
  /// **'Monthly Savings Goal'**
  String get monthlySavingsGoal;

  /// No description provided for @monthlySavingsGoalHint.
  ///
  /// In en, this message translates to:
  /// **'How much do you want to save each month?'**
  String get monthlySavingsGoalHint;

  /// No description provided for @budgetInfoMessage.
  ///
  /// In en, this message translates to:
  /// **'The progress bar is calculated based on your remaining budget after mandatory expenses.'**
  String get budgetInfoMessage;

  /// No description provided for @linkWithGoogleTitle.
  ///
  /// In en, this message translates to:
  /// **'Link with Google'**
  String get linkWithGoogleTitle;

  /// No description provided for @linkWithGoogleDescription.
  ///
  /// In en, this message translates to:
  /// **'Securely access your data from all devices'**
  String get linkWithGoogleDescription;

  /// No description provided for @skipForNow.
  ///
  /// In en, this message translates to:
  /// **'Skip for now'**
  String get skipForNow;

  /// No description provided for @incomeType.
  ///
  /// In en, this message translates to:
  /// **'Income type'**
  String get incomeType;

  /// No description provided for @incomeCategorySalary.
  ///
  /// In en, this message translates to:
  /// **'Salary'**
  String get incomeCategorySalary;

  /// No description provided for @incomeCategoryFreelance.
  ///
  /// In en, this message translates to:
  /// **'Freelance'**
  String get incomeCategoryFreelance;

  /// No description provided for @incomeCategoryRental.
  ///
  /// In en, this message translates to:
  /// **'Rental Income'**
  String get incomeCategoryRental;

  /// No description provided for @incomeCategoryPassive.
  ///
  /// In en, this message translates to:
  /// **'Passive Income'**
  String get incomeCategoryPassive;

  /// No description provided for @incomeCategoryOther.
  ///
  /// In en, this message translates to:
  /// **'Other'**
  String get incomeCategoryOther;

  /// No description provided for @incomeCategorySalaryDesc.
  ///
  /// In en, this message translates to:
  /// **'Monthly regular salary'**
  String get incomeCategorySalaryDesc;

  /// No description provided for @incomeCategoryFreelanceDesc.
  ///
  /// In en, this message translates to:
  /// **'Self-employment income'**
  String get incomeCategoryFreelanceDesc;

  /// No description provided for @incomeCategoryRentalDesc.
  ///
  /// In en, this message translates to:
  /// **'Property, vehicle rental income'**
  String get incomeCategoryRentalDesc;

  /// No description provided for @incomeCategoryPassiveDesc.
  ///
  /// In en, this message translates to:
  /// **'Investment, dividends, interest etc.'**
  String get incomeCategoryPassiveDesc;

  /// No description provided for @incomeCategoryOtherDesc.
  ///
  /// In en, this message translates to:
  /// **'Other income sources'**
  String get incomeCategoryOtherDesc;

  /// No description provided for @mainSalary.
  ///
  /// In en, this message translates to:
  /// **'Main Salary'**
  String get mainSalary;

  /// No description provided for @descriptionOptional.
  ///
  /// In en, this message translates to:
  /// **'Description (Optional)'**
  String get descriptionOptional;

  /// No description provided for @descriptionOptionalHint.
  ///
  /// In en, this message translates to:
  /// **'e.g: Upwork Project'**
  String get descriptionOptionalHint;

  /// No description provided for @addedIncomes.
  ///
  /// In en, this message translates to:
  /// **'Added Incomes'**
  String get addedIncomes;

  /// No description provided for @incomeSummary.
  ///
  /// In en, this message translates to:
  /// **'Income Summary'**
  String get incomeSummary;

  /// No description provided for @totalMonthlyIncome.
  ///
  /// In en, this message translates to:
  /// **'Total Monthly Income'**
  String get totalMonthlyIncome;

  /// No description provided for @incomeSource.
  ///
  /// In en, this message translates to:
  /// **'income source'**
  String get incomeSource;

  /// No description provided for @complete.
  ///
  /// In en, this message translates to:
  /// **'Complete'**
  String get complete;

  /// No description provided for @editMyIncomes.
  ///
  /// In en, this message translates to:
  /// **'Edit My Incomes'**
  String get editMyIncomes;

  /// No description provided for @goBack.
  ///
  /// In en, this message translates to:
  /// **'Go Back'**
  String get goBack;

  /// No description provided for @notBudgetApp.
  ///
  /// In en, this message translates to:
  /// **'This is not a budget app'**
  String get notBudgetApp;

  /// No description provided for @showRealCost.
  ///
  /// In en, this message translates to:
  /// **'Show the real cost of expenses: your time.'**
  String get showRealCost;

  /// No description provided for @everyExpenseDecision.
  ///
  /// In en, this message translates to:
  /// **'Every expense is a decision'**
  String get everyExpenseDecision;

  /// No description provided for @youDecide.
  ///
  /// In en, this message translates to:
  /// **'Bought, thinking, or passed. You decide.'**
  String get youDecide;

  /// No description provided for @oneExpenseEnough.
  ///
  /// In en, this message translates to:
  /// **'One expense today is enough'**
  String get oneExpenseEnough;

  /// No description provided for @startSmall.
  ///
  /// In en, this message translates to:
  /// **'Start small, awareness grows.'**
  String get startSmall;

  /// No description provided for @skip.
  ///
  /// In en, this message translates to:
  /// **'Skip'**
  String get skip;

  /// No description provided for @start.
  ///
  /// In en, this message translates to:
  /// **'Start'**
  String get start;

  /// No description provided for @whatIsYourDecision.
  ///
  /// In en, this message translates to:
  /// **'What\'s your decision?'**
  String get whatIsYourDecision;

  /// No description provided for @netBalance.
  ///
  /// In en, this message translates to:
  /// **'NET BALANCE'**
  String get netBalance;

  /// No description provided for @sources.
  ///
  /// In en, this message translates to:
  /// **'{count} sources'**
  String sources(int count);

  /// No description provided for @income.
  ///
  /// In en, this message translates to:
  /// **'INCOME'**
  String get income;

  /// No description provided for @expense.
  ///
  /// In en, this message translates to:
  /// **'SPENT'**
  String get expense;

  /// No description provided for @saved.
  ///
  /// In en, this message translates to:
  /// **'SAVED'**
  String get saved;

  /// No description provided for @budgetUsage.
  ///
  /// In en, this message translates to:
  /// **'BUDGET USAGE'**
  String get budgetUsage;

  /// No description provided for @startToday.
  ///
  /// In en, this message translates to:
  /// **'Start today!'**
  String get startToday;

  /// No description provided for @dayStreak.
  ///
  /// In en, this message translates to:
  /// **'{count} Day Streak!'**
  String dayStreak(int count);

  /// No description provided for @startStreak.
  ///
  /// In en, this message translates to:
  /// **'Start Your Streak!'**
  String get startStreak;

  /// No description provided for @keepStreakMessage.
  ///
  /// In en, this message translates to:
  /// **'Keep your streak by recording expenses daily!'**
  String get keepStreakMessage;

  /// No description provided for @startStreakMessage.
  ///
  /// In en, this message translates to:
  /// **'Record at least 1 expense daily and build a streak!'**
  String get startStreakMessage;

  /// No description provided for @longestStreak.
  ///
  /// In en, this message translates to:
  /// **'Longest streak: {count} days'**
  String longestStreak(int count);

  /// No description provided for @newRecord.
  ///
  /// In en, this message translates to:
  /// **'New Record!'**
  String get newRecord;

  /// No description provided for @withThisAmount.
  ///
  /// In en, this message translates to:
  /// **'With this {amount} TL you could have bought:'**
  String withThisAmount(String amount);

  /// No description provided for @goldGrams.
  ///
  /// In en, this message translates to:
  /// **'{grams}g gold'**
  String goldGrams(String grams);

  /// No description provided for @ratesLoading.
  ///
  /// In en, this message translates to:
  /// **'Loading rates...'**
  String get ratesLoading;

  /// No description provided for @ratesLoadFailed.
  ///
  /// In en, this message translates to:
  /// **'Failed to load rates'**
  String get ratesLoadFailed;

  /// No description provided for @goldPriceNotUpdated.
  ///
  /// In en, this message translates to:
  /// **'Gold price could not be updated'**
  String get goldPriceNotUpdated;

  /// No description provided for @monthAbbreviations.
  ///
  /// In en, this message translates to:
  /// **'Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec'**
  String get monthAbbreviations;

  /// No description provided for @updateYourDecision.
  ///
  /// In en, this message translates to:
  /// **'Update your decision'**
  String get updateYourDecision;

  /// No description provided for @simulation.
  ///
  /// In en, this message translates to:
  /// **'Simulation'**
  String get simulation;

  /// No description provided for @tapToUpdate.
  ///
  /// In en, this message translates to:
  /// **'Tap to update'**
  String get tapToUpdate;

  /// No description provided for @swipeToEditOrDelete.
  ///
  /// In en, this message translates to:
  /// **'Swipe to edit or delete'**
  String get swipeToEditOrDelete;

  /// No description provided for @pleaseEnterValidAmount.
  ///
  /// In en, this message translates to:
  /// **'Please enter a valid amount'**
  String get pleaseEnterValidAmount;

  /// No description provided for @amountTooHigh.
  ///
  /// In en, this message translates to:
  /// **'Amount seems too high'**
  String get amountTooHigh;

  /// No description provided for @pleaseSelectExpenseGroup.
  ///
  /// In en, this message translates to:
  /// **'Please select expense group first'**
  String get pleaseSelectExpenseGroup;

  /// No description provided for @categorySelectionRequired.
  ///
  /// In en, this message translates to:
  /// **'Category selection is required'**
  String get categorySelectionRequired;

  /// No description provided for @expenseGroup.
  ///
  /// In en, this message translates to:
  /// **'Expense Group'**
  String get expenseGroup;

  /// No description provided for @required.
  ///
  /// In en, this message translates to:
  /// **'Required'**
  String get required;

  /// No description provided for @detail.
  ///
  /// In en, this message translates to:
  /// **'Detail'**
  String get detail;

  /// No description provided for @optional.
  ///
  /// In en, this message translates to:
  /// **'Optional'**
  String get optional;

  /// No description provided for @editYourCard.
  ///
  /// In en, this message translates to:
  /// **'Edit Your Card'**
  String get editYourCard;

  /// No description provided for @share.
  ///
  /// In en, this message translates to:
  /// **'Share'**
  String get share;

  /// No description provided for @sharing.
  ///
  /// In en, this message translates to:
  /// **'Sharing...'**
  String get sharing;

  /// No description provided for @frequency.
  ///
  /// In en, this message translates to:
  /// **'Frequency'**
  String get frequency;

  /// No description provided for @daysAbbrev.
  ///
  /// In en, this message translates to:
  /// **'days'**
  String get daysAbbrev;

  /// No description provided for @youSaved.
  ///
  /// In en, this message translates to:
  /// **'saved!'**
  String get youSaved;

  /// No description provided for @noSavingsYet.
  ///
  /// In en, this message translates to:
  /// **'No savings yet'**
  String get noSavingsYet;

  /// No description provided for @categorySports.
  ///
  /// In en, this message translates to:
  /// **'Sports'**
  String get categorySports;

  /// No description provided for @categoryCommunication.
  ///
  /// In en, this message translates to:
  /// **'Communication'**
  String get categoryCommunication;

  /// No description provided for @subscriptionNameExample.
  ///
  /// In en, this message translates to:
  /// **'e.g: Netflix, Spotify'**
  String get subscriptionNameExample;

  /// No description provided for @monthlyAmountExample.
  ///
  /// In en, this message translates to:
  /// **'e.g: 99.99'**
  String get monthlyAmountExample;

  /// No description provided for @color.
  ///
  /// In en, this message translates to:
  /// **'Color'**
  String get color;

  /// No description provided for @autoRecordOnRenewal.
  ///
  /// In en, this message translates to:
  /// **'Record as expense on renewal day'**
  String get autoRecordOnRenewal;

  /// No description provided for @deleteSubscription.
  ///
  /// In en, this message translates to:
  /// **'Delete Subscription'**
  String get deleteSubscription;

  /// No description provided for @deleteSubscriptionConfirm.
  ///
  /// In en, this message translates to:
  /// **'Are you sure you want to delete {name} subscription?'**
  String deleteSubscriptionConfirm(String name);

  /// No description provided for @subscriptionDuration.
  ///
  /// In en, this message translates to:
  /// **'Subscription Duration'**
  String get subscriptionDuration;

  /// No description provided for @subscriptionDurationDays.
  ///
  /// In en, this message translates to:
  /// **'{days} days'**
  String subscriptionDurationDays(int days);

  /// No description provided for @totalPaid.
  ///
  /// In en, this message translates to:
  /// **'Total Paid'**
  String get totalPaid;

  /// No description provided for @workHoursAmount.
  ///
  /// In en, this message translates to:
  /// **'{hours} hours'**
  String workHoursAmount(String hours);

  /// No description provided for @workDaysAmount.
  ///
  /// In en, this message translates to:
  /// **'{days} days'**
  String workDaysAmount(String days);

  /// No description provided for @autoRecordEnabled.
  ///
  /// In en, this message translates to:
  /// **'Auto-record enabled'**
  String get autoRecordEnabled;

  /// No description provided for @autoRecordDisabled.
  ///
  /// In en, this message translates to:
  /// **'Auto expense recording disabled'**
  String get autoRecordDisabled;

  /// No description provided for @saveChanges.
  ///
  /// In en, this message translates to:
  /// **'Save Changes'**
  String get saveChanges;

  /// No description provided for @weekdayAbbreviations.
  ///
  /// In en, this message translates to:
  /// **'Mon,Tue,Wed,Thu,Fri,Sat,Sun'**
  String get weekdayAbbreviations;

  /// No description provided for @homePage.
  ///
  /// In en, this message translates to:
  /// **'Home'**
  String get homePage;

  /// No description provided for @analysis.
  ///
  /// In en, this message translates to:
  /// **'Analysis'**
  String get analysis;

  /// No description provided for @reportsDescription.
  ///
  /// In en, this message translates to:
  /// **'View monthly and category-based expense analysis here.'**
  String get reportsDescription;

  /// No description provided for @quickAdd.
  ///
  /// In en, this message translates to:
  /// **'Quick Add'**
  String get quickAdd;

  /// No description provided for @quickAddDescription.
  ///
  /// In en, this message translates to:
  /// **'Use this button to quickly add expenses from anywhere. Practical and fast!'**
  String get quickAddDescription;

  /// No description provided for @badgesDescription.
  ///
  /// In en, this message translates to:
  /// **'Earn badges as you reach your savings goals. Keep your motivation high!'**
  String get badgesDescription;

  /// No description provided for @profileAndSettings.
  ///
  /// In en, this message translates to:
  /// **'Profile & Settings'**
  String get profileAndSettings;

  /// No description provided for @profileAndSettingsDescription.
  ///
  /// In en, this message translates to:
  /// **'Edit income info, manage notification preferences and access app settings.'**
  String get profileAndSettingsDescription;

  /// No description provided for @addSubscriptionButton.
  ///
  /// In en, this message translates to:
  /// **'Add subscriptions like Netflix, Spotify'**
  String get addSubscriptionButton;

  /// No description provided for @shareError.
  ///
  /// In en, this message translates to:
  /// **'An error occurred while sharing'**
  String get shareError;

  /// No description provided for @shareVia.
  ///
  /// In en, this message translates to:
  /// **'Share via'**
  String get shareVia;

  /// No description provided for @saveToGallery.
  ///
  /// In en, this message translates to:
  /// **'Save to Gallery'**
  String get saveToGallery;

  /// No description provided for @savedToGallery.
  ///
  /// In en, this message translates to:
  /// **'Saved to gallery'**
  String get savedToGallery;

  /// No description provided for @otherApps.
  ///
  /// In en, this message translates to:
  /// **'Other Apps'**
  String get otherApps;

  /// No description provided for @expenseDeleted.
  ///
  /// In en, this message translates to:
  /// **'Expense deleted'**
  String get expenseDeleted;

  /// No description provided for @undo.
  ///
  /// In en, this message translates to:
  /// **'Undo'**
  String get undo;

  /// No description provided for @choosePlatform.
  ///
  /// In en, this message translates to:
  /// **'Choose Platform'**
  String get choosePlatform;

  /// No description provided for @savingToGallery.
  ///
  /// In en, this message translates to:
  /// **'Saving...'**
  String get savingToGallery;

  /// No description provided for @pleaseEnterValidSalary.
  ///
  /// In en, this message translates to:
  /// **'Please enter a valid salary'**
  String get pleaseEnterValidSalary;

  /// No description provided for @pleaseEnterValidIncomeAmount.
  ///
  /// In en, this message translates to:
  /// **'Please enter a valid amount'**
  String get pleaseEnterValidIncomeAmount;

  /// No description provided for @atLeastOneIncomeRequired.
  ///
  /// In en, this message translates to:
  /// **'You must add at least one income source'**
  String get atLeastOneIncomeRequired;

  /// No description provided for @incomesUpdated.
  ///
  /// In en, this message translates to:
  /// **'Incomes updated'**
  String get incomesUpdated;

  /// No description provided for @incomesSaved.
  ///
  /// In en, this message translates to:
  /// **'Incomes saved'**
  String get incomesSaved;

  /// No description provided for @saveError.
  ///
  /// In en, this message translates to:
  /// **'An error occurred while saving'**
  String get saveError;

  /// No description provided for @incomeSourceCount.
  ///
  /// In en, this message translates to:
  /// **'{count} income sources'**
  String incomeSourceCount(int count);

  /// No description provided for @freedTime.
  ///
  /// In en, this message translates to:
  /// **'Freed'**
  String get freedTime;

  /// No description provided for @savedAmountLabel.
  ///
  /// In en, this message translates to:
  /// **'Saved'**
  String get savedAmountLabel;

  /// No description provided for @dayLabel.
  ///
  /// In en, this message translates to:
  /// **'Day'**
  String get dayLabel;

  /// No description provided for @zeroMinutes.
  ///
  /// In en, this message translates to:
  /// **'0 Minutes'**
  String get zeroMinutes;

  /// No description provided for @zeroAmount.
  ///
  /// In en, this message translates to:
  /// **'0 ₺'**
  String get zeroAmount;

  /// No description provided for @shareCardDays.
  ///
  /// In en, this message translates to:
  /// **'{days} DAYS'**
  String shareCardDays(int days);

  /// No description provided for @shareCardDescription.
  ///
  /// In en, this message translates to:
  /// **'I work this many days yearly\njust for {category}'**
  String shareCardDescription(String category);

  /// No description provided for @shareCardQuestion.
  ///
  /// In en, this message translates to:
  /// **'How many days for you?'**
  String get shareCardQuestion;

  /// No description provided for @shareCardDuration.
  ///
  /// In en, this message translates to:
  /// **'Duration ({days} days)'**
  String shareCardDuration(int days);

  /// No description provided for @shareCardAmountLabel.
  ///
  /// In en, this message translates to:
  /// **'Amount (₺{amount})'**
  String shareCardAmountLabel(String amount);

  /// No description provided for @shareCardFrequency.
  ///
  /// In en, this message translates to:
  /// **'Frequency ({frequency})'**
  String shareCardFrequency(String frequency);

  /// No description provided for @unsavedChanges.
  ///
  /// In en, this message translates to:
  /// **'Unsaved Changes'**
  String get unsavedChanges;

  /// No description provided for @unsavedChangesConfirm.
  ///
  /// In en, this message translates to:
  /// **'Are you sure you want to exit without saving?'**
  String get unsavedChangesConfirm;

  /// No description provided for @discardChanges.
  ///
  /// In en, this message translates to:
  /// **'Discard'**
  String get discardChanges;

  /// No description provided for @thinkingTime.
  ///
  /// In en, this message translates to:
  /// **'Thinking time...'**
  String get thinkingTime;

  /// No description provided for @confirm.
  ///
  /// In en, this message translates to:
  /// **'Confirm'**
  String get confirm;

  /// No description provided for @riskLevelNone.
  ///
  /// In en, this message translates to:
  /// **'Safe'**
  String get riskLevelNone;

  /// No description provided for @riskLevelLow.
  ///
  /// In en, this message translates to:
  /// **'Low Risk'**
  String get riskLevelLow;

  /// No description provided for @riskLevelMedium.
  ///
  /// In en, this message translates to:
  /// **'Medium Risk'**
  String get riskLevelMedium;

  /// No description provided for @riskLevelHigh.
  ///
  /// In en, this message translates to:
  /// **'High Risk'**
  String get riskLevelHigh;

  /// No description provided for @riskLevelExtreme.
  ///
  /// In en, this message translates to:
  /// **'Critical Risk'**
  String get riskLevelExtreme;

  /// No description provided for @savedTimeHoursDays.
  ///
  /// In en, this message translates to:
  /// **'{hours} hours = {days} days saved'**
  String savedTimeHoursDays(String hours, String days);

  /// No description provided for @savedTimeHours.
  ///
  /// In en, this message translates to:
  /// **'{hours} hours saved'**
  String savedTimeHours(String hours);

  /// No description provided for @savedTimeMinutes.
  ///
  /// In en, this message translates to:
  /// **'{minutes} minutes saved'**
  String savedTimeMinutes(int minutes);

  /// No description provided for @couldBuyGoldGrams.
  ///
  /// In en, this message translates to:
  /// **'With this money you could buy {grams} grams of gold'**
  String couldBuyGoldGrams(String grams);

  /// No description provided for @equivalentWorkDays.
  ///
  /// In en, this message translates to:
  /// **'This equals {days} days of work'**
  String equivalentWorkDays(String days);

  /// No description provided for @equivalentWorkHours.
  ///
  /// In en, this message translates to:
  /// **'This equals {hours} hours of work'**
  String equivalentWorkHours(String hours);

  /// No description provided for @savedDollars.
  ///
  /// In en, this message translates to:
  /// **'You saved exactly {amount} dollars'**
  String savedDollars(String amount);

  /// No description provided for @or.
  ///
  /// In en, this message translates to:
  /// **'OR'**
  String get or;

  /// No description provided for @goldGramsShort.
  ///
  /// In en, this message translates to:
  /// **'{grams}g gold'**
  String goldGramsShort(String grams);

  /// No description provided for @amountRequired.
  ///
  /// In en, this message translates to:
  /// **'Amount is required'**
  String get amountRequired;

  /// No description provided for @everyMonth.
  ///
  /// In en, this message translates to:
  /// **'Every month'**
  String get everyMonth;

  /// No description provided for @daysCount.
  ///
  /// In en, this message translates to:
  /// **'{count} days'**
  String daysCount(int count);

  /// No description provided for @hoursCount.
  ///
  /// In en, this message translates to:
  /// **'{count} hours'**
  String hoursCount(String count);

  /// No description provided for @daysCountDecimal.
  ///
  /// In en, this message translates to:
  /// **'{count} days'**
  String daysCountDecimal(String count);

  /// No description provided for @autoRecordOn.
  ///
  /// In en, this message translates to:
  /// **'Auto record enabled'**
  String get autoRecordOn;

  /// No description provided for @autoRecordOff.
  ///
  /// In en, this message translates to:
  /// **'Auto record disabled'**
  String get autoRecordOff;

  /// No description provided for @monthlyAmountTl.
  ///
  /// In en, this message translates to:
  /// **'{amount} TL/month'**
  String monthlyAmountTl(String amount);

  /// No description provided for @nameRequired.
  ///
  /// In en, this message translates to:
  /// **'Name is required'**
  String get nameRequired;

  /// No description provided for @amountHint.
  ///
  /// In en, this message translates to:
  /// **'e.g: 99.99'**
  String get amountHint;

  /// No description provided for @updateDecision.
  ///
  /// In en, this message translates to:
  /// **'Update your decision'**
  String get updateDecision;

  /// No description provided for @categoryRequired.
  ///
  /// In en, this message translates to:
  /// **'Category is required'**
  String get categoryRequired;

  /// No description provided for @monthlyAmountLabel.
  ///
  /// In en, this message translates to:
  /// **'Monthly Amount (TL)'**
  String get monthlyAmountLabel;

  /// No description provided for @withThisAmountYouCouldBuy.
  ///
  /// In en, this message translates to:
  /// **'With {amount} TL you could buy:'**
  String withThisAmountYouCouldBuy(String amount);

  /// No description provided for @workHoursDistribution.
  ///
  /// In en, this message translates to:
  /// **'Work Hours Distribution'**
  String get workHoursDistribution;

  /// No description provided for @workHoursDistributionDesc.
  ///
  /// In en, this message translates to:
  /// **'See how many hours you work for each category'**
  String get workHoursDistributionDesc;

  /// No description provided for @hoursShort.
  ///
  /// In en, this message translates to:
  /// **'{hours}h'**
  String hoursShort(String hours);

  /// No description provided for @categoryHoursBar.
  ///
  /// In en, this message translates to:
  /// **'{hours} hours ({percent}%)'**
  String categoryHoursBar(String hours, String percent);

  /// No description provided for @monthComparison.
  ///
  /// In en, this message translates to:
  /// **'Month Comparison'**
  String get monthComparison;

  /// No description provided for @vsLastMonth.
  ///
  /// In en, this message translates to:
  /// **'vs Last Month'**
  String get vsLastMonth;

  /// No description provided for @noLastMonthData.
  ///
  /// In en, this message translates to:
  /// **'No last month data'**
  String get noLastMonthData;

  /// No description provided for @decreasedBy.
  ///
  /// In en, this message translates to:
  /// **'↓ {percent}% decreased'**
  String decreasedBy(String percent);

  /// No description provided for @increasedBy.
  ///
  /// In en, this message translates to:
  /// **'↑ {percent}% increased'**
  String increasedBy(String percent);

  /// No description provided for @noChange.
  ///
  /// In en, this message translates to:
  /// **'No change'**
  String get noChange;

  /// No description provided for @greatProgress.
  ///
  /// In en, this message translates to:
  /// **'Great progress!'**
  String get greatProgress;

  /// No description provided for @watchOut.
  ///
  /// In en, this message translates to:
  /// **'Watch out!'**
  String get watchOut;

  /// No description provided for @smartInsights.
  ///
  /// In en, this message translates to:
  /// **'Smart Insights'**
  String get smartInsights;

  /// No description provided for @mostExpensiveDay.
  ///
  /// In en, this message translates to:
  /// **'Most Expensive Day'**
  String get mostExpensiveDay;

  /// No description provided for @mostExpensiveDayValue.
  ///
  /// In en, this message translates to:
  /// **'{day} (avg. {amount} TL)'**
  String mostExpensiveDayValue(String day, String amount);

  /// No description provided for @mostPassedCategory.
  ///
  /// In en, this message translates to:
  /// **'Most Passed Category'**
  String get mostPassedCategory;

  /// No description provided for @mostPassedCategoryValue.
  ///
  /// In en, this message translates to:
  /// **'{category} ({count} times)'**
  String mostPassedCategoryValue(String category, int count);

  /// No description provided for @savingsOpportunity.
  ///
  /// In en, this message translates to:
  /// **'Savings Opportunity'**
  String get savingsOpportunity;

  /// No description provided for @savingsOpportunityValue.
  ///
  /// In en, this message translates to:
  /// **'Cut {category} by 20% = {hours}h saved/month'**
  String savingsOpportunityValue(String category, String hours);

  /// No description provided for @weeklyTrend.
  ///
  /// In en, this message translates to:
  /// **'Weekly Trend'**
  String get weeklyTrend;

  /// No description provided for @weeklyTrendValue.
  ///
  /// In en, this message translates to:
  /// **'Last 4 weeks: {trend}'**
  String weeklyTrendValue(String trend);

  /// No description provided for @overallDecreasing.
  ///
  /// In en, this message translates to:
  /// **'Overall decreasing'**
  String get overallDecreasing;

  /// No description provided for @overallIncreasing.
  ///
  /// In en, this message translates to:
  /// **'Overall increasing'**
  String get overallIncreasing;

  /// No description provided for @stableTrend.
  ///
  /// In en, this message translates to:
  /// **'Stable'**
  String get stableTrend;

  /// No description provided for @noTrendData.
  ///
  /// In en, this message translates to:
  /// **'Not enough data'**
  String get noTrendData;

  /// No description provided for @yearlyView.
  ///
  /// In en, this message translates to:
  /// **'Yearly View'**
  String get yearlyView;

  /// No description provided for @yearlyHeatmap.
  ///
  /// In en, this message translates to:
  /// **'Spending Trend'**
  String get yearlyHeatmap;

  /// No description provided for @yearlyHeatmapDesc.
  ///
  /// In en, this message translates to:
  /// **'Your monthly spending over the last 12 months'**
  String get yearlyHeatmapDesc;

  /// No description provided for @lowSpending.
  ///
  /// In en, this message translates to:
  /// **'Low'**
  String get lowSpending;

  /// No description provided for @highSpending.
  ///
  /// In en, this message translates to:
  /// **'High'**
  String get highSpending;

  /// No description provided for @noSpending.
  ///
  /// In en, this message translates to:
  /// **'No spending'**
  String get noSpending;

  /// No description provided for @tapDayForDetails.
  ///
  /// In en, this message translates to:
  /// **'Tap a day for details'**
  String get tapDayForDetails;

  /// No description provided for @tapMonthForDetails.
  ///
  /// In en, this message translates to:
  /// **'Tap a month for details'**
  String get tapMonthForDetails;

  /// No description provided for @selectedDayExpenses.
  ///
  /// In en, this message translates to:
  /// **'{date}: {amount} TL ({count} expenses)'**
  String selectedDayExpenses(String date, String amount, int count);

  /// No description provided for @selectedMonthExpenses.
  ///
  /// In en, this message translates to:
  /// **'{month}: {amount} ({count} expenses)'**
  String selectedMonthExpenses(String month, String amount, int count);

  /// No description provided for @proBadge.
  ///
  /// In en, this message translates to:
  /// **'PRO'**
  String get proBadge;

  /// No description provided for @proFeature.
  ///
  /// In en, this message translates to:
  /// **'Pro Feature'**
  String get proFeature;

  /// No description provided for @comingSoon.
  ///
  /// In en, this message translates to:
  /// **'Coming Soon'**
  String get comingSoon;

  /// No description provided for @mindfulChoice.
  ///
  /// In en, this message translates to:
  /// **'Mindful Choice'**
  String get mindfulChoice;

  /// No description provided for @mindfulChoiceExpandedDesc.
  ///
  /// In en, this message translates to:
  /// **'What were you originally planning to buy?'**
  String get mindfulChoiceExpandedDesc;

  /// No description provided for @mindfulChoiceCollapsedDesc.
  ///
  /// In en, this message translates to:
  /// **'Were you going to buy something more expensive?'**
  String get mindfulChoiceCollapsedDesc;

  /// No description provided for @mindfulChoiceAmountLabel.
  ///
  /// In en, this message translates to:
  /// **'Amount in Mind (₺)'**
  String get mindfulChoiceAmountLabel;

  /// No description provided for @mindfulChoiceAmountHint.
  ///
  /// In en, this message translates to:
  /// **'e.g: {amount}'**
  String mindfulChoiceAmountHint(String amount);

  /// No description provided for @mindfulChoiceSavings.
  ///
  /// In en, this message translates to:
  /// **'{amount} TL savings'**
  String mindfulChoiceSavings(String amount);

  /// No description provided for @mindfulChoiceSavingsDesc.
  ///
  /// In en, this message translates to:
  /// **'Stays in your pocket with mindful choice'**
  String get mindfulChoiceSavingsDesc;

  /// No description provided for @tierBronze.
  ///
  /// In en, this message translates to:
  /// **'Bronze'**
  String get tierBronze;

  /// No description provided for @tierSilver.
  ///
  /// In en, this message translates to:
  /// **'Silver'**
  String get tierSilver;

  /// No description provided for @tierGold.
  ///
  /// In en, this message translates to:
  /// **'Gold'**
  String get tierGold;

  /// No description provided for @tierPlatinum.
  ///
  /// In en, this message translates to:
  /// **'Platinum'**
  String get tierPlatinum;

  /// No description provided for @achievementCategoryStreak.
  ///
  /// In en, this message translates to:
  /// **'Streak'**
  String get achievementCategoryStreak;

  /// No description provided for @achievementCategorySavings.
  ///
  /// In en, this message translates to:
  /// **'Savings'**
  String get achievementCategorySavings;

  /// No description provided for @achievementCategoryDecision.
  ///
  /// In en, this message translates to:
  /// **'Decision'**
  String get achievementCategoryDecision;

  /// No description provided for @achievementCategoryRecord.
  ///
  /// In en, this message translates to:
  /// **'Record'**
  String get achievementCategoryRecord;

  /// No description provided for @achievementCategoryHidden.
  ///
  /// In en, this message translates to:
  /// **'Hidden'**
  String get achievementCategoryHidden;

  /// No description provided for @achievementStreakB1Title.
  ///
  /// In en, this message translates to:
  /// **'Getting Started'**
  String get achievementStreakB1Title;

  /// No description provided for @achievementStreakB1Desc.
  ///
  /// In en, this message translates to:
  /// **'Record for 3 days in a row'**
  String get achievementStreakB1Desc;

  /// No description provided for @achievementStreakB2Title.
  ///
  /// In en, this message translates to:
  /// **'Keeping Going'**
  String get achievementStreakB2Title;

  /// No description provided for @achievementStreakB2Desc.
  ///
  /// In en, this message translates to:
  /// **'Record for 7 days in a row'**
  String get achievementStreakB2Desc;

  /// No description provided for @achievementStreakB3Title.
  ///
  /// In en, this message translates to:
  /// **'Building Routine'**
  String get achievementStreakB3Title;

  /// No description provided for @achievementStreakB3Desc.
  ///
  /// In en, this message translates to:
  /// **'Record for 14 days in a row'**
  String get achievementStreakB3Desc;

  /// No description provided for @achievementStreakS1Title.
  ///
  /// In en, this message translates to:
  /// **'Determination'**
  String get achievementStreakS1Title;

  /// No description provided for @achievementStreakS1Desc.
  ///
  /// In en, this message translates to:
  /// **'Record for 30 days in a row'**
  String get achievementStreakS1Desc;

  /// No description provided for @achievementStreakS2Title.
  ///
  /// In en, this message translates to:
  /// **'Habit'**
  String get achievementStreakS2Title;

  /// No description provided for @achievementStreakS2Desc.
  ///
  /// In en, this message translates to:
  /// **'Record for 60 days in a row'**
  String get achievementStreakS2Desc;

  /// No description provided for @achievementStreakS3Title.
  ///
  /// In en, this message translates to:
  /// **'Discipline'**
  String get achievementStreakS3Title;

  /// No description provided for @achievementStreakS3Desc.
  ///
  /// In en, this message translates to:
  /// **'Record for 90 days in a row'**
  String get achievementStreakS3Desc;

  /// No description provided for @achievementStreakG1Title.
  ///
  /// In en, this message translates to:
  /// **'Strong Will'**
  String get achievementStreakG1Title;

  /// No description provided for @achievementStreakG1Desc.
  ///
  /// In en, this message translates to:
  /// **'Record for 150 days in a row'**
  String get achievementStreakG1Desc;

  /// No description provided for @achievementStreakG2Title.
  ///
  /// In en, this message translates to:
  /// **'Unshakeable'**
  String get achievementStreakG2Title;

  /// No description provided for @achievementStreakG2Desc.
  ///
  /// In en, this message translates to:
  /// **'Record for 250 days in a row'**
  String get achievementStreakG2Desc;

  /// No description provided for @achievementStreakG3Title.
  ///
  /// In en, this message translates to:
  /// **'Consistency'**
  String get achievementStreakG3Title;

  /// No description provided for @achievementStreakG3Desc.
  ///
  /// In en, this message translates to:
  /// **'Record for 365 days in a row'**
  String get achievementStreakG3Desc;

  /// No description provided for @achievementStreakPTitle.
  ///
  /// In en, this message translates to:
  /// **'Persistence'**
  String get achievementStreakPTitle;

  /// No description provided for @achievementStreakPDesc.
  ///
  /// In en, this message translates to:
  /// **'Record for 730 days in a row'**
  String get achievementStreakPDesc;

  /// No description provided for @achievementSavingsB1Title.
  ///
  /// In en, this message translates to:
  /// **'First Savings'**
  String get achievementSavingsB1Title;

  /// No description provided for @achievementSavingsB1Desc.
  ///
  /// In en, this message translates to:
  /// **'Saved 250 TL'**
  String get achievementSavingsB1Desc;

  /// No description provided for @achievementSavingsB2Title.
  ///
  /// In en, this message translates to:
  /// **'Starting to Save'**
  String get achievementSavingsB2Title;

  /// No description provided for @achievementSavingsB2Desc.
  ///
  /// In en, this message translates to:
  /// **'Saved 500 TL'**
  String get achievementSavingsB2Desc;

  /// No description provided for @achievementSavingsB3Title.
  ///
  /// In en, this message translates to:
  /// **'On the Right Path'**
  String get achievementSavingsB3Title;

  /// No description provided for @achievementSavingsB3Desc.
  ///
  /// In en, this message translates to:
  /// **'Saved 1,000 TL'**
  String get achievementSavingsB3Desc;

  /// No description provided for @achievementSavingsS1Title.
  ///
  /// In en, this message translates to:
  /// **'Mindful Spending'**
  String get achievementSavingsS1Title;

  /// No description provided for @achievementSavingsS1Desc.
  ///
  /// In en, this message translates to:
  /// **'Saved 2,500 TL'**
  String get achievementSavingsS1Desc;

  /// No description provided for @achievementSavingsS2Title.
  ///
  /// In en, this message translates to:
  /// **'In Control'**
  String get achievementSavingsS2Title;

  /// No description provided for @achievementSavingsS2Desc.
  ///
  /// In en, this message translates to:
  /// **'Saved 5,000 TL'**
  String get achievementSavingsS2Desc;

  /// No description provided for @achievementSavingsS3Title.
  ///
  /// In en, this message translates to:
  /// **'Consistent'**
  String get achievementSavingsS3Title;

  /// No description provided for @achievementSavingsS3Desc.
  ///
  /// In en, this message translates to:
  /// **'Saved 10,000 TL'**
  String get achievementSavingsS3Desc;

  /// No description provided for @achievementSavingsG1Title.
  ///
  /// In en, this message translates to:
  /// **'Strong Savings'**
  String get achievementSavingsG1Title;

  /// No description provided for @achievementSavingsG1Desc.
  ///
  /// In en, this message translates to:
  /// **'Saved 25,000 TL'**
  String get achievementSavingsG1Desc;

  /// No description provided for @achievementSavingsG2Title.
  ///
  /// In en, this message translates to:
  /// **'Financial Awareness'**
  String get achievementSavingsG2Title;

  /// No description provided for @achievementSavingsG2Desc.
  ///
  /// In en, this message translates to:
  /// **'Saved 50,000 TL'**
  String get achievementSavingsG2Desc;

  /// No description provided for @achievementSavingsG3Title.
  ///
  /// In en, this message translates to:
  /// **'Solid Foundation'**
  String get achievementSavingsG3Title;

  /// No description provided for @achievementSavingsG3Desc.
  ///
  /// In en, this message translates to:
  /// **'Saved 100,000 TL'**
  String get achievementSavingsG3Desc;

  /// No description provided for @achievementSavingsP1Title.
  ///
  /// In en, this message translates to:
  /// **'Long-term Thinking'**
  String get achievementSavingsP1Title;

  /// No description provided for @achievementSavingsP1Desc.
  ///
  /// In en, this message translates to:
  /// **'Saved 250,000 TL'**
  String get achievementSavingsP1Desc;

  /// No description provided for @achievementSavingsP2Title.
  ///
  /// In en, this message translates to:
  /// **'Financial Clarity'**
  String get achievementSavingsP2Title;

  /// No description provided for @achievementSavingsP2Desc.
  ///
  /// In en, this message translates to:
  /// **'Saved 500,000 TL'**
  String get achievementSavingsP2Desc;

  /// No description provided for @achievementSavingsP3Title.
  ///
  /// In en, this message translates to:
  /// **'Big Picture'**
  String get achievementSavingsP3Title;

  /// No description provided for @achievementSavingsP3Desc.
  ///
  /// In en, this message translates to:
  /// **'Saved 1,000,000 TL'**
  String get achievementSavingsP3Desc;

  /// No description provided for @achievementDecisionB1Title.
  ///
  /// In en, this message translates to:
  /// **'First Decision'**
  String get achievementDecisionB1Title;

  /// No description provided for @achievementDecisionB1Desc.
  ///
  /// In en, this message translates to:
  /// **'Passed 3 times'**
  String get achievementDecisionB1Desc;

  /// No description provided for @achievementDecisionB2Title.
  ///
  /// In en, this message translates to:
  /// **'Resistance'**
  String get achievementDecisionB2Title;

  /// No description provided for @achievementDecisionB2Desc.
  ///
  /// In en, this message translates to:
  /// **'Passed 7 times'**
  String get achievementDecisionB2Desc;

  /// No description provided for @achievementDecisionB3Title.
  ///
  /// In en, this message translates to:
  /// **'Control'**
  String get achievementDecisionB3Title;

  /// No description provided for @achievementDecisionB3Desc.
  ///
  /// In en, this message translates to:
  /// **'Passed 15 times'**
  String get achievementDecisionB3Desc;

  /// No description provided for @achievementDecisionS1Title.
  ///
  /// In en, this message translates to:
  /// **'Determination'**
  String get achievementDecisionS1Title;

  /// No description provided for @achievementDecisionS1Desc.
  ///
  /// In en, this message translates to:
  /// **'Passed 30 times'**
  String get achievementDecisionS1Desc;

  /// No description provided for @achievementDecisionS2Title.
  ///
  /// In en, this message translates to:
  /// **'Clarity'**
  String get achievementDecisionS2Title;

  /// No description provided for @achievementDecisionS2Desc.
  ///
  /// In en, this message translates to:
  /// **'Passed 60 times'**
  String get achievementDecisionS2Desc;

  /// No description provided for @achievementDecisionS3Title.
  ///
  /// In en, this message translates to:
  /// **'Strong Choices'**
  String get achievementDecisionS3Title;

  /// No description provided for @achievementDecisionS3Desc.
  ///
  /// In en, this message translates to:
  /// **'Passed 100 times'**
  String get achievementDecisionS3Desc;

  /// No description provided for @achievementDecisionG1Title.
  ///
  /// In en, this message translates to:
  /// **'Willpower'**
  String get achievementDecisionG1Title;

  /// No description provided for @achievementDecisionG1Desc.
  ///
  /// In en, this message translates to:
  /// **'Passed 200 times'**
  String get achievementDecisionG1Desc;

  /// No description provided for @achievementDecisionG2Title.
  ///
  /// In en, this message translates to:
  /// **'Composure'**
  String get achievementDecisionG2Title;

  /// No description provided for @achievementDecisionG2Desc.
  ///
  /// In en, this message translates to:
  /// **'Passed 400 times'**
  String get achievementDecisionG2Desc;

  /// No description provided for @achievementDecisionG3Title.
  ///
  /// In en, this message translates to:
  /// **'Top Level Control'**
  String get achievementDecisionG3Title;

  /// No description provided for @achievementDecisionG3Desc.
  ///
  /// In en, this message translates to:
  /// **'Passed 700 times'**
  String get achievementDecisionG3Desc;

  /// No description provided for @achievementDecisionPTitle.
  ///
  /// In en, this message translates to:
  /// **'Total Mastery'**
  String get achievementDecisionPTitle;

  /// No description provided for @achievementDecisionPDesc.
  ///
  /// In en, this message translates to:
  /// **'Passed 1,000 times'**
  String get achievementDecisionPDesc;

  /// No description provided for @achievementRecordB1Title.
  ///
  /// In en, this message translates to:
  /// **'Started'**
  String get achievementRecordB1Title;

  /// No description provided for @achievementRecordB1Desc.
  ///
  /// In en, this message translates to:
  /// **'5 expense records'**
  String get achievementRecordB1Desc;

  /// No description provided for @achievementRecordB2Title.
  ///
  /// In en, this message translates to:
  /// **'Tracking'**
  String get achievementRecordB2Title;

  /// No description provided for @achievementRecordB2Desc.
  ///
  /// In en, this message translates to:
  /// **'15 expense records'**
  String get achievementRecordB2Desc;

  /// No description provided for @achievementRecordB3Title.
  ///
  /// In en, this message translates to:
  /// **'Organized'**
  String get achievementRecordB3Title;

  /// No description provided for @achievementRecordB3Desc.
  ///
  /// In en, this message translates to:
  /// **'30 expense records'**
  String get achievementRecordB3Desc;

  /// No description provided for @achievementRecordS1Title.
  ///
  /// In en, this message translates to:
  /// **'Detailed Tracking'**
  String get achievementRecordS1Title;

  /// No description provided for @achievementRecordS1Desc.
  ///
  /// In en, this message translates to:
  /// **'60 expense records'**
  String get achievementRecordS1Desc;

  /// No description provided for @achievementRecordS2Title.
  ///
  /// In en, this message translates to:
  /// **'Analytical'**
  String get achievementRecordS2Title;

  /// No description provided for @achievementRecordS2Desc.
  ///
  /// In en, this message translates to:
  /// **'120 expense records'**
  String get achievementRecordS2Desc;

  /// No description provided for @achievementRecordS3Title.
  ///
  /// In en, this message translates to:
  /// **'Systematic'**
  String get achievementRecordS3Title;

  /// No description provided for @achievementRecordS3Desc.
  ///
  /// In en, this message translates to:
  /// **'200 expense records'**
  String get achievementRecordS3Desc;

  /// No description provided for @achievementRecordG1Title.
  ///
  /// In en, this message translates to:
  /// **'Depth'**
  String get achievementRecordG1Title;

  /// No description provided for @achievementRecordG1Desc.
  ///
  /// In en, this message translates to:
  /// **'350 expense records'**
  String get achievementRecordG1Desc;

  /// No description provided for @achievementRecordG2Title.
  ///
  /// In en, this message translates to:
  /// **'Mastery'**
  String get achievementRecordG2Title;

  /// No description provided for @achievementRecordG2Desc.
  ///
  /// In en, this message translates to:
  /// **'600 expense records'**
  String get achievementRecordG2Desc;

  /// No description provided for @achievementRecordG3Title.
  ///
  /// In en, this message translates to:
  /// **'Archive'**
  String get achievementRecordG3Title;

  /// No description provided for @achievementRecordG3Desc.
  ///
  /// In en, this message translates to:
  /// **'1,000 expense records'**
  String get achievementRecordG3Desc;

  /// No description provided for @achievementRecordPTitle.
  ///
  /// In en, this message translates to:
  /// **'Long-term Record'**
  String get achievementRecordPTitle;

  /// No description provided for @achievementRecordPDesc.
  ///
  /// In en, this message translates to:
  /// **'2,000 expense records'**
  String get achievementRecordPDesc;

  /// No description provided for @achievementHiddenNightTitle.
  ///
  /// In en, this message translates to:
  /// **'Night Record'**
  String get achievementHiddenNightTitle;

  /// No description provided for @achievementHiddenNightDesc.
  ///
  /// In en, this message translates to:
  /// **'Record between 00:00-05:00'**
  String get achievementHiddenNightDesc;

  /// No description provided for @achievementHiddenEarlyTitle.
  ///
  /// In en, this message translates to:
  /// **'Early Bird'**
  String get achievementHiddenEarlyTitle;

  /// No description provided for @achievementHiddenEarlyDesc.
  ///
  /// In en, this message translates to:
  /// **'Record between 05:00-07:00'**
  String get achievementHiddenEarlyDesc;

  /// No description provided for @achievementHiddenWeekendTitle.
  ///
  /// In en, this message translates to:
  /// **'Weekend Routine'**
  String get achievementHiddenWeekendTitle;

  /// No description provided for @achievementHiddenWeekendDesc.
  ///
  /// In en, this message translates to:
  /// **'5 records on Saturday-Sunday'**
  String get achievementHiddenWeekendDesc;

  /// No description provided for @achievementHiddenOcrTitle.
  ///
  /// In en, this message translates to:
  /// **'First Scan'**
  String get achievementHiddenOcrTitle;

  /// No description provided for @achievementHiddenOcrDesc.
  ///
  /// In en, this message translates to:
  /// **'First receipt OCR usage'**
  String get achievementHiddenOcrDesc;

  /// No description provided for @achievementHiddenBalancedTitle.
  ///
  /// In en, this message translates to:
  /// **'Balanced Week'**
  String get achievementHiddenBalancedTitle;

  /// No description provided for @achievementHiddenBalancedDesc.
  ///
  /// In en, this message translates to:
  /// **'7 days in a row with 0 \"Bought\"'**
  String get achievementHiddenBalancedDesc;

  /// No description provided for @achievementHiddenCategoriesTitle.
  ///
  /// In en, this message translates to:
  /// **'Category Completion'**
  String get achievementHiddenCategoriesTitle;

  /// No description provided for @achievementHiddenCategoriesDesc.
  ///
  /// In en, this message translates to:
  /// **'Record in all 6 categories'**
  String get achievementHiddenCategoriesDesc;

  /// No description provided for @achievementHiddenGoldTitle.
  ///
  /// In en, this message translates to:
  /// **'Gold Equivalent'**
  String get achievementHiddenGoldTitle;

  /// No description provided for @achievementHiddenGoldDesc.
  ///
  /// In en, this message translates to:
  /// **'Saved money equals 1 gram of gold'**
  String get achievementHiddenGoldDesc;

  /// No description provided for @achievementHiddenUsdTitle.
  ///
  /// In en, this message translates to:
  /// **'Currency Equivalent'**
  String get achievementHiddenUsdTitle;

  /// No description provided for @achievementHiddenUsdDesc.
  ///
  /// In en, this message translates to:
  /// **'Saved money equals \$100'**
  String get achievementHiddenUsdDesc;

  /// No description provided for @achievementHiddenSubsTitle.
  ///
  /// In en, this message translates to:
  /// **'Subscription Control'**
  String get achievementHiddenSubsTitle;

  /// No description provided for @achievementHiddenSubsDesc.
  ///
  /// In en, this message translates to:
  /// **'Track 5 subscriptions'**
  String get achievementHiddenSubsDesc;

  /// No description provided for @achievementHiddenNoSpendTitle.
  ///
  /// In en, this message translates to:
  /// **'No-Spend Month'**
  String get achievementHiddenNoSpendTitle;

  /// No description provided for @achievementHiddenNoSpendDesc.
  ///
  /// In en, this message translates to:
  /// **'0 \"Bought\" for 1 month'**
  String get achievementHiddenNoSpendDesc;

  /// No description provided for @achievementHiddenGoldKgTitle.
  ///
  /// In en, this message translates to:
  /// **'High Value Savings'**
  String get achievementHiddenGoldKgTitle;

  /// No description provided for @achievementHiddenGoldKgDesc.
  ///
  /// In en, this message translates to:
  /// **'Saved money equals 1 kg of gold'**
  String get achievementHiddenGoldKgDesc;

  /// No description provided for @achievementHiddenUsd10kTitle.
  ///
  /// In en, this message translates to:
  /// **'Major Currency Equivalent'**
  String get achievementHiddenUsd10kTitle;

  /// No description provided for @achievementHiddenUsd10kDesc.
  ///
  /// In en, this message translates to:
  /// **'Saved money equals \$10,000'**
  String get achievementHiddenUsd10kDesc;

  /// No description provided for @achievementHiddenAnniversaryTitle.
  ///
  /// In en, this message translates to:
  /// **'Usage Anniversary'**
  String get achievementHiddenAnniversaryTitle;

  /// No description provided for @achievementHiddenAnniversaryDesc.
  ///
  /// In en, this message translates to:
  /// **'365 days of usage'**
  String get achievementHiddenAnniversaryDesc;

  /// No description provided for @achievementHiddenEarlyAdopterTitle.
  ///
  /// In en, this message translates to:
  /// **'Early Adopter'**
  String get achievementHiddenEarlyAdopterTitle;

  /// No description provided for @achievementHiddenEarlyAdopterDesc.
  ///
  /// In en, this message translates to:
  /// **'Installed the app 2 years ago'**
  String get achievementHiddenEarlyAdopterDesc;

  /// No description provided for @achievementHiddenUltimateTitle.
  ///
  /// In en, this message translates to:
  /// **'Long-term Discipline'**
  String get achievementHiddenUltimateTitle;

  /// No description provided for @achievementHiddenUltimateDesc.
  ///
  /// In en, this message translates to:
  /// **'1,000,000 TL + 365 day streak at once'**
  String get achievementHiddenUltimateDesc;

  /// No description provided for @achievementHiddenCollectorTitle.
  ///
  /// In en, this message translates to:
  /// **'Collector'**
  String get achievementHiddenCollectorTitle;

  /// No description provided for @achievementHiddenCollectorDesc.
  ///
  /// In en, this message translates to:
  /// **'Collected all badges except Platinum'**
  String get achievementHiddenCollectorDesc;

  /// No description provided for @easterEgg5Left.
  ///
  /// In en, this message translates to:
  /// **'5 more...'**
  String get easterEgg5Left;

  /// No description provided for @easterEggAlmost.
  ///
  /// In en, this message translates to:
  /// **'Almost...'**
  String get easterEggAlmost;

  /// No description provided for @achievementUnlocked.
  ///
  /// In en, this message translates to:
  /// **'Achievement Unlocked!'**
  String get achievementUnlocked;

  /// No description provided for @curiousCatTitle.
  ///
  /// In en, this message translates to:
  /// **'Too Curious'**
  String get curiousCatTitle;

  /// No description provided for @curiousCatDescription.
  ///
  /// In en, this message translates to:
  /// **'You found the hidden Easter Egg!'**
  String get curiousCatDescription;

  /// No description provided for @great.
  ///
  /// In en, this message translates to:
  /// **'Great!'**
  String get great;

  /// No description provided for @achievementHiddenCuriousCatTitle.
  ///
  /// In en, this message translates to:
  /// **'Too Curious'**
  String get achievementHiddenCuriousCatTitle;

  /// No description provided for @achievementHiddenCuriousCatDesc.
  ///
  /// In en, this message translates to:
  /// **'You found the hidden Easter Egg!'**
  String get achievementHiddenCuriousCatDesc;

  /// No description provided for @recentExpenses.
  ///
  /// In en, this message translates to:
  /// **'Recent Expenses'**
  String get recentExpenses;

  /// No description provided for @seeMore.
  ///
  /// In en, this message translates to:
  /// **'See More'**
  String get seeMore;

  /// No description provided for @tapPlusToAdd.
  ///
  /// In en, this message translates to:
  /// **'Tap + to add your first expense'**
  String get tapPlusToAdd;

  /// No description provided for @expenseAdded.
  ///
  /// In en, this message translates to:
  /// **'Expense added successfully'**
  String get expenseAdded;

  /// No description provided for @duplicateExpenseWarning.
  ///
  /// In en, this message translates to:
  /// **'This expense already seems to exist'**
  String get duplicateExpenseWarning;

  /// No description provided for @duplicateExpenseDetails.
  ///
  /// In en, this message translates to:
  /// **'{amount} {category}'**
  String duplicateExpenseDetails(String amount, String category);

  /// No description provided for @addAnyway.
  ///
  /// In en, this message translates to:
  /// **'Do you still want to add it?'**
  String get addAnyway;

  /// No description provided for @yes.
  ///
  /// In en, this message translates to:
  /// **'Yes'**
  String get yes;

  /// No description provided for @no.
  ///
  /// In en, this message translates to:
  /// **'No'**
  String get no;

  /// No description provided for @timeAgoNow.
  ///
  /// In en, this message translates to:
  /// **'just now'**
  String get timeAgoNow;

  /// No description provided for @timeAgoMinutes.
  ///
  /// In en, this message translates to:
  /// **'{count} minutes ago'**
  String timeAgoMinutes(int count);

  /// No description provided for @timeAgoHours.
  ///
  /// In en, this message translates to:
  /// **'{count} hours ago'**
  String timeAgoHours(int count);

  /// No description provided for @timeAgoDays.
  ///
  /// In en, this message translates to:
  /// **'{count} days ago'**
  String timeAgoDays(int count);

  /// No description provided for @exportToExcel.
  ///
  /// In en, this message translates to:
  /// **'Export to Excel'**
  String get exportToExcel;

  /// No description provided for @exportReport.
  ///
  /// In en, this message translates to:
  /// **'Export Report'**
  String get exportReport;

  /// No description provided for @exporting.
  ///
  /// In en, this message translates to:
  /// **'Exporting...'**
  String get exporting;

  /// No description provided for @exportSuccess.
  ///
  /// In en, this message translates to:
  /// **'Report exported successfully'**
  String get exportSuccess;

  /// No description provided for @exportError.
  ///
  /// In en, this message translates to:
  /// **'Export failed'**
  String get exportError;

  /// No description provided for @exportComplete.
  ///
  /// In en, this message translates to:
  /// **'Export Complete'**
  String get exportComplete;

  /// No description provided for @exportShareOption.
  ///
  /// In en, this message translates to:
  /// **'Share'**
  String get exportShareOption;

  /// No description provided for @exportSaveOption.
  ///
  /// In en, this message translates to:
  /// **'Save to Files'**
  String get exportSaveOption;

  /// No description provided for @exportSavedToDownloads.
  ///
  /// In en, this message translates to:
  /// **'Saved to Downloads/Vantag'**
  String get exportSavedToDownloads;

  /// No description provided for @exportChooseAction.
  ///
  /// In en, this message translates to:
  /// **'What would you like to do with the file?'**
  String get exportChooseAction;

  /// No description provided for @csvHeaderDate.
  ///
  /// In en, this message translates to:
  /// **'Date'**
  String get csvHeaderDate;

  /// No description provided for @csvHeaderTime.
  ///
  /// In en, this message translates to:
  /// **'Time'**
  String get csvHeaderTime;

  /// No description provided for @csvHeaderAmount.
  ///
  /// In en, this message translates to:
  /// **'Amount'**
  String get csvHeaderAmount;

  /// No description provided for @csvHeaderCurrency.
  ///
  /// In en, this message translates to:
  /// **'Currency'**
  String get csvHeaderCurrency;

  /// No description provided for @csvHeaderCategory.
  ///
  /// In en, this message translates to:
  /// **'Category'**
  String get csvHeaderCategory;

  /// No description provided for @csvHeaderSubcategory.
  ///
  /// In en, this message translates to:
  /// **'Subcategory'**
  String get csvHeaderSubcategory;

  /// No description provided for @csvHeaderDescription.
  ///
  /// In en, this message translates to:
  /// **'Description'**
  String get csvHeaderDescription;

  /// No description provided for @csvHeaderProduct.
  ///
  /// In en, this message translates to:
  /// **'Product'**
  String get csvHeaderProduct;

  /// No description provided for @csvHeaderDecision.
  ///
  /// In en, this message translates to:
  /// **'Decision'**
  String get csvHeaderDecision;

  /// No description provided for @csvHeaderWorkHours.
  ///
  /// In en, this message translates to:
  /// **'Work Hours'**
  String get csvHeaderWorkHours;

  /// No description provided for @csvHeaderInstallment.
  ///
  /// In en, this message translates to:
  /// **'Installment'**
  String get csvHeaderInstallment;

  /// No description provided for @csvHeaderMandatory.
  ///
  /// In en, this message translates to:
  /// **'Mandatory'**
  String get csvHeaderMandatory;

  /// No description provided for @csvSummarySection.
  ///
  /// In en, this message translates to:
  /// **'SUMMARY'**
  String get csvSummarySection;

  /// No description provided for @csvTotalExpense.
  ///
  /// In en, this message translates to:
  /// **'Total Expense'**
  String get csvTotalExpense;

  /// No description provided for @csvCategoryTotals.
  ///
  /// In en, this message translates to:
  /// **'Category Totals'**
  String get csvCategoryTotals;

  /// No description provided for @csvDailyAverage.
  ///
  /// In en, this message translates to:
  /// **'Daily Average'**
  String get csvDailyAverage;

  /// No description provided for @csvWeeklyAverage.
  ///
  /// In en, this message translates to:
  /// **'Weekly Average'**
  String get csvWeeklyAverage;

  /// No description provided for @csvTopCategory.
  ///
  /// In en, this message translates to:
  /// **'Top Category'**
  String get csvTopCategory;

  /// No description provided for @csvLargestExpense.
  ///
  /// In en, this message translates to:
  /// **'Largest Expense'**
  String get csvLargestExpense;

  /// No description provided for @csvTotalWorkHours.
  ///
  /// In en, this message translates to:
  /// **'Total Work Hours'**
  String get csvTotalWorkHours;

  /// No description provided for @csvPeriod.
  ///
  /// In en, this message translates to:
  /// **'Period'**
  String get csvPeriod;

  /// No description provided for @csvYes.
  ///
  /// In en, this message translates to:
  /// **'Yes'**
  String get csvYes;

  /// No description provided for @csvNo.
  ///
  /// In en, this message translates to:
  /// **'No'**
  String get csvNo;

  /// No description provided for @financialReport.
  ///
  /// In en, this message translates to:
  /// **'Financial Summary Report'**
  String get financialReport;

  /// No description provided for @createdAt.
  ///
  /// In en, this message translates to:
  /// **'Created'**
  String get createdAt;

  /// No description provided for @savingsRate.
  ///
  /// In en, this message translates to:
  /// **'Savings Rate'**
  String get savingsRate;

  /// No description provided for @hourlyRate.
  ///
  /// In en, this message translates to:
  /// **'Hourly Rate'**
  String get hourlyRate;

  /// No description provided for @workHoursEquivalent.
  ///
  /// In en, this message translates to:
  /// **'Work Hours Equivalent'**
  String get workHoursEquivalent;

  /// No description provided for @transactionCount.
  ///
  /// In en, this message translates to:
  /// **'Transaction Count'**
  String get transactionCount;

  /// No description provided for @average.
  ///
  /// In en, this message translates to:
  /// **'Average'**
  String get average;

  /// No description provided for @percentage.
  ///
  /// In en, this message translates to:
  /// **'Percentage'**
  String get percentage;

  /// No description provided for @total.
  ///
  /// In en, this message translates to:
  /// **'Total'**
  String get total;

  /// No description provided for @monthly.
  ///
  /// In en, this message translates to:
  /// **'Monthly'**
  String get monthly;

  /// No description provided for @yearly.
  ///
  /// In en, this message translates to:
  /// **'Yearly'**
  String get yearly;

  /// No description provided for @changePercent.
  ///
  /// In en, this message translates to:
  /// **'Change %'**
  String get changePercent;

  /// No description provided for @month.
  ///
  /// In en, this message translates to:
  /// **'Month'**
  String get month;

  /// No description provided for @originalAmount.
  ///
  /// In en, this message translates to:
  /// **'Original Amount'**
  String get originalAmount;

  /// No description provided for @nextRenewal.
  ///
  /// In en, this message translates to:
  /// **'Next Renewal'**
  String get nextRenewal;

  /// No description provided for @yearlyAmount.
  ///
  /// In en, this message translates to:
  /// **'Yearly Amount'**
  String get yearlyAmount;

  /// No description provided for @badge.
  ///
  /// In en, this message translates to:
  /// **'Badge'**
  String get badge;

  /// No description provided for @status.
  ///
  /// In en, this message translates to:
  /// **'Status'**
  String get status;

  /// No description provided for @earnedDate.
  ///
  /// In en, this message translates to:
  /// **'Earned Date'**
  String get earnedDate;

  /// No description provided for @totalBadges.
  ///
  /// In en, this message translates to:
  /// **'Total Badges'**
  String get totalBadges;

  /// No description provided for @proFeatureExport.
  ///
  /// In en, this message translates to:
  /// **'Excel Export is a Pro feature'**
  String get proFeatureExport;

  /// No description provided for @upgradeForExport.
  ///
  /// In en, this message translates to:
  /// **'Upgrade to Pro to export your financial data'**
  String get upgradeForExport;

  /// No description provided for @importPremiumOnly.
  ///
  /// In en, this message translates to:
  /// **'Import is a Pro feature'**
  String get importPremiumOnly;

  /// No description provided for @upgradeForImport.
  ///
  /// In en, this message translates to:
  /// **'Upgrade to Pro to import your bank statements'**
  String get upgradeForImport;

  /// No description provided for @receiptScanned.
  ///
  /// In en, this message translates to:
  /// **'Receipt scanned successfully'**
  String get receiptScanned;

  /// No description provided for @noAmountFound.
  ///
  /// In en, this message translates to:
  /// **'No amount found in the image'**
  String get noAmountFound;

  /// No description provided for @saveAllRecognized.
  ///
  /// In en, this message translates to:
  /// **'Save All ({count})'**
  String saveAllRecognized(int count);

  /// No description provided for @saveAllRecognizedSuccess.
  ///
  /// In en, this message translates to:
  /// **'{count} expenses saved successfully'**
  String saveAllRecognizedSuccess(int count);

  /// No description provided for @budgets.
  ///
  /// In en, this message translates to:
  /// **'Budgets'**
  String get budgets;

  /// No description provided for @budget.
  ///
  /// In en, this message translates to:
  /// **'Budget'**
  String get budget;

  /// No description provided for @addBudget.
  ///
  /// In en, this message translates to:
  /// **'Add Budget'**
  String get addBudget;

  /// No description provided for @editBudget.
  ///
  /// In en, this message translates to:
  /// **'Edit Budget'**
  String get editBudget;

  /// No description provided for @deleteBudget.
  ///
  /// In en, this message translates to:
  /// **'Delete Budget'**
  String get deleteBudget;

  /// No description provided for @deleteBudgetConfirm.
  ///
  /// In en, this message translates to:
  /// **'Are you sure you want to delete this budget?'**
  String get deleteBudgetConfirm;

  /// No description provided for @monthlyLimit.
  ///
  /// In en, this message translates to:
  /// **'Monthly Limit'**
  String get monthlyLimit;

  /// No description provided for @budgetProgress.
  ///
  /// In en, this message translates to:
  /// **'Budget Progress'**
  String get budgetProgress;

  /// No description provided for @totalBudget.
  ///
  /// In en, this message translates to:
  /// **'Total Budget'**
  String get totalBudget;

  /// No description provided for @remainingAmount.
  ///
  /// In en, this message translates to:
  /// **'{amount} remaining'**
  String remainingAmount(String amount);

  /// No description provided for @overBudgetAmount.
  ///
  /// In en, this message translates to:
  /// **'{amount} over!'**
  String overBudgetAmount(String amount);

  /// No description provided for @ofBudget.
  ///
  /// In en, this message translates to:
  /// **'{spent} of {total}'**
  String ofBudget(String spent, String total);

  /// No description provided for @onTrack.
  ///
  /// In en, this message translates to:
  /// **'On track'**
  String get onTrack;

  /// No description provided for @nearLimit.
  ///
  /// In en, this message translates to:
  /// **'Near limit'**
  String get nearLimit;

  /// No description provided for @overLimit.
  ///
  /// In en, this message translates to:
  /// **'Over limit'**
  String get overLimit;

  /// No description provided for @noBudgetsYet.
  ///
  /// In en, this message translates to:
  /// **'No budgets yet'**
  String get noBudgetsYet;

  /// No description provided for @noBudgetsDescription.
  ///
  /// In en, this message translates to:
  /// **'Set budgets to track your spending by category'**
  String get noBudgetsDescription;

  /// No description provided for @budgetHelperText.
  ///
  /// In en, this message translates to:
  /// **'Set a monthly spending limit for this category'**
  String get budgetHelperText;

  /// No description provided for @budgetExceededTitle.
  ///
  /// In en, this message translates to:
  /// **'Budget Exceeded!'**
  String get budgetExceededTitle;

  /// No description provided for @budgetExceededMessage.
  ///
  /// In en, this message translates to:
  /// **'You\'ve exceeded your {category} budget by {amount}'**
  String budgetExceededMessage(String category, String amount);

  /// No description provided for @budgetNearLimit.
  ///
  /// In en, this message translates to:
  /// **'Approaching budget limit'**
  String get budgetNearLimit;

  /// No description provided for @budgetNearLimitMessage.
  ///
  /// In en, this message translates to:
  /// **'You\'ve used {percent}% of your {category} budget'**
  String budgetNearLimitMessage(String percent, String category);

  /// No description provided for @categoriesOnTrack.
  ///
  /// In en, this message translates to:
  /// **'{count} on track'**
  String categoriesOnTrack(int count);

  /// No description provided for @categoriesOverBudget.
  ///
  /// In en, this message translates to:
  /// **'{count} over budget'**
  String categoriesOverBudget(int count);

  /// No description provided for @categoriesNearLimit.
  ///
  /// In en, this message translates to:
  /// **'{count} near limit'**
  String categoriesNearLimit(int count);

  /// No description provided for @categories.
  ///
  /// In en, this message translates to:
  /// **'categories'**
  String get categories;

  /// No description provided for @viewAll.
  ///
  /// In en, this message translates to:
  /// **'View All'**
  String get viewAll;

  /// No description provided for @viewBudgetsInReports.
  ///
  /// In en, this message translates to:
  /// **'View budget details in Reports tab'**
  String get viewBudgetsInReports;

  /// No description provided for @pendingCategorization.
  ///
  /// In en, this message translates to:
  /// **'{count} expenses pending categorization'**
  String pendingCategorization(int count);

  /// No description provided for @suggestionsAvailable.
  ///
  /// In en, this message translates to:
  /// **'{count} suggestions available'**
  String suggestionsAvailable(int count);

  /// No description provided for @reviewExpenses.
  ///
  /// In en, this message translates to:
  /// **'Review Expenses'**
  String get reviewExpenses;

  /// No description provided for @swipeToCategorizeTip.
  ///
  /// In en, this message translates to:
  /// **'Tap a category to categorize'**
  String get swipeToCategorizeTip;

  /// No description provided for @rememberMerchant.
  ///
  /// In en, this message translates to:
  /// **'Remember this merchant'**
  String get rememberMerchant;

  /// No description provided for @suggestionLabel.
  ///
  /// In en, this message translates to:
  /// **'Suggestion: {name}'**
  String suggestionLabel(String name);

  /// No description provided for @suggested.
  ///
  /// In en, this message translates to:
  /// **'Suggested'**
  String get suggested;

  /// No description provided for @allCategorized.
  ///
  /// In en, this message translates to:
  /// **'All Done!'**
  String get allCategorized;

  /// No description provided for @categorizedCount.
  ///
  /// In en, this message translates to:
  /// **'{processed} categorized, {skipped} skipped'**
  String categorizedCount(int processed, int skipped);

  /// No description provided for @importStatement.
  ///
  /// In en, this message translates to:
  /// **'Import Statement'**
  String get importStatement;

  /// No description provided for @importCSV.
  ///
  /// In en, this message translates to:
  /// **'Import CSV'**
  String get importCSV;

  /// No description provided for @importFromBank.
  ///
  /// In en, this message translates to:
  /// **'Import from Bank'**
  String get importFromBank;

  /// No description provided for @selectCSVFile.
  ///
  /// In en, this message translates to:
  /// **'Select CSV file'**
  String get selectCSVFile;

  /// No description provided for @importingExpenses.
  ///
  /// In en, this message translates to:
  /// **'Importing expenses...'**
  String get importingExpenses;

  /// No description provided for @importSuccess.
  ///
  /// In en, this message translates to:
  /// **'{count} expenses imported successfully'**
  String importSuccess(int count);

  /// No description provided for @importError.
  ///
  /// In en, this message translates to:
  /// **'Import failed'**
  String get importError;

  /// No description provided for @recognizedExpenses.
  ///
  /// In en, this message translates to:
  /// **'{count} recognized'**
  String recognizedExpenses(int count);

  /// No description provided for @pendingExpenses.
  ///
  /// In en, this message translates to:
  /// **'{count} pending review'**
  String pendingExpenses(int count);

  /// No description provided for @importSummary.
  ///
  /// In en, this message translates to:
  /// **'Import Summary'**
  String get importSummary;

  /// No description provided for @autoMatched.
  ///
  /// In en, this message translates to:
  /// **'Auto-matched'**
  String get autoMatched;

  /// No description provided for @needsReview.
  ///
  /// In en, this message translates to:
  /// **'Needs Review'**
  String get needsReview;

  /// No description provided for @startReview.
  ///
  /// In en, this message translates to:
  /// **'Start Review'**
  String get startReview;

  /// No description provided for @importAIParsed.
  ///
  /// In en, this message translates to:
  /// **'AI Parsed Transactions'**
  String get importAIParsed;

  /// No description provided for @importNoTransactions.
  ///
  /// In en, this message translates to:
  /// **'No transactions found in this file'**
  String get importNoTransactions;

  /// No description provided for @importSelected.
  ///
  /// In en, this message translates to:
  /// **'Save {count} Selected'**
  String importSelected(int count);

  /// No description provided for @transactions.
  ///
  /// In en, this message translates to:
  /// **'transactions'**
  String get transactions;

  /// No description provided for @selectAll.
  ///
  /// In en, this message translates to:
  /// **'Select All'**
  String get selectAll;

  /// No description provided for @selectNone.
  ///
  /// In en, this message translates to:
  /// **'Select None'**
  String get selectNone;

  /// No description provided for @selected.
  ///
  /// In en, this message translates to:
  /// **'selected'**
  String get selected;

  /// No description provided for @saving.
  ///
  /// In en, this message translates to:
  /// **'Saving...'**
  String get saving;

  /// No description provided for @learnedMerchants.
  ///
  /// In en, this message translates to:
  /// **'Learned Merchants'**
  String get learnedMerchants;

  /// No description provided for @noLearnedMerchants.
  ///
  /// In en, this message translates to:
  /// **'No learned merchants yet'**
  String get noLearnedMerchants;

  /// No description provided for @learnedMerchantsDescription.
  ///
  /// In en, this message translates to:
  /// **'Merchants you categorize will appear here'**
  String get learnedMerchantsDescription;

  /// No description provided for @merchantCount.
  ///
  /// In en, this message translates to:
  /// **'{count} merchants learned'**
  String merchantCount(int count);

  /// No description provided for @deleteMerchant.
  ///
  /// In en, this message translates to:
  /// **'Delete Merchant'**
  String get deleteMerchant;

  /// No description provided for @deleteMerchantConfirm.
  ///
  /// In en, this message translates to:
  /// **'Are you sure you want to delete this merchant?'**
  String get deleteMerchantConfirm;

  /// No description provided for @voiceInput.
  ///
  /// In en, this message translates to:
  /// **'Voice Input'**
  String get voiceInput;

  /// No description provided for @listening.
  ///
  /// In en, this message translates to:
  /// **'Listening...'**
  String get listening;

  /// No description provided for @voiceNotAvailable.
  ///
  /// In en, this message translates to:
  /// **'Voice input is not available on this device'**
  String get voiceNotAvailable;

  /// No description provided for @microphonePermissionDenied.
  ///
  /// In en, this message translates to:
  /// **'Microphone permission denied'**
  String get microphonePermissionDenied;

  /// No description provided for @microphonePermissionRequired.
  ///
  /// In en, this message translates to:
  /// **'Microphone permission required'**
  String get microphonePermissionRequired;

  /// No description provided for @networkRequired.
  ///
  /// In en, this message translates to:
  /// **'Internet connection required'**
  String get networkRequired;

  /// No description provided for @understanding.
  ///
  /// In en, this message translates to:
  /// **'Understanding...'**
  String get understanding;

  /// No description provided for @couldNotUnderstandTryAgain.
  ///
  /// In en, this message translates to:
  /// **'Could not understand, try again'**
  String get couldNotUnderstandTryAgain;

  /// No description provided for @couldNotUnderstandSayAgain.
  ///
  /// In en, this message translates to:
  /// **'Could not understand, say again'**
  String get couldNotUnderstandSayAgain;

  /// No description provided for @sayAgain.
  ///
  /// In en, this message translates to:
  /// **'Say again'**
  String get sayAgain;

  /// No description provided for @yesSave.
  ///
  /// In en, this message translates to:
  /// **'Yes, save'**
  String get yesSave;

  /// No description provided for @voiceExpenseAdded.
  ///
  /// In en, this message translates to:
  /// **'{amount}₺ {description} added'**
  String voiceExpenseAdded(String amount, String description);

  /// No description provided for @voiceConfirmExpense.
  ///
  /// In en, this message translates to:
  /// **'Confirm Expense'**
  String get voiceConfirmExpense;

  /// No description provided for @voiceDetectedAmount.
  ///
  /// In en, this message translates to:
  /// **'Detected: {amount}₺'**
  String voiceDetectedAmount(String amount);

  /// No description provided for @tapToSpeak.
  ///
  /// In en, this message translates to:
  /// **'Tap to speak'**
  String get tapToSpeak;

  /// No description provided for @speakExpense.
  ///
  /// In en, this message translates to:
  /// **'Say your expense (e.g. \"50 lira coffee\")'**
  String get speakExpense;

  /// No description provided for @voiceParsingFailed.
  ///
  /// In en, this message translates to:
  /// **'Could not understand. Please try again.'**
  String get voiceParsingFailed;

  /// No description provided for @voiceHighConfidence.
  ///
  /// In en, this message translates to:
  /// **'Auto-saved'**
  String get voiceHighConfidence;

  /// No description provided for @voiceMediumConfidence.
  ///
  /// In en, this message translates to:
  /// **'Tap to edit'**
  String get voiceMediumConfidence;

  /// No description provided for @voiceLowConfidence.
  ///
  /// In en, this message translates to:
  /// **'Please confirm'**
  String get voiceLowConfidence;

  /// No description provided for @speakYourExpense.
  ///
  /// In en, this message translates to:
  /// **'Speak your expense'**
  String get speakYourExpense;

  /// No description provided for @longPressForVoice.
  ///
  /// In en, this message translates to:
  /// **'Long-press for voice input'**
  String get longPressForVoice;

  /// No description provided for @didYouKnow.
  ///
  /// In en, this message translates to:
  /// **'Did you know?'**
  String get didYouKnow;

  /// No description provided for @voiceTipMessage.
  ///
  /// In en, this message translates to:
  /// **'Add expenses faster! Long-press + button and say: \"50 lira coffee\"'**
  String get voiceTipMessage;

  /// No description provided for @gotIt.
  ///
  /// In en, this message translates to:
  /// **'Got It'**
  String get gotIt;

  /// No description provided for @tryNow.
  ///
  /// In en, this message translates to:
  /// **'Try Now'**
  String get tryNow;

  /// No description provided for @voiceAndShortcuts.
  ///
  /// In en, this message translates to:
  /// **'Voice & Shortcuts'**
  String get voiceAndShortcuts;

  /// No description provided for @newBadge.
  ///
  /// In en, this message translates to:
  /// **'NEW'**
  String get newBadge;

  /// No description provided for @voiceInputHint.
  ///
  /// In en, this message translates to:
  /// **'Long-press + button for voice'**
  String get voiceInputHint;

  /// No description provided for @howToUseVoice.
  ///
  /// In en, this message translates to:
  /// **'How to Use Voice'**
  String get howToUseVoice;

  /// No description provided for @voiceLimitReachedTitle.
  ///
  /// In en, this message translates to:
  /// **'Daily Limit Reached'**
  String get voiceLimitReachedTitle;

  /// No description provided for @voiceLimitReachedFree.
  ///
  /// In en, this message translates to:
  /// **'You\'ve used your daily voice input. Upgrade to Pro for unlimited access or try again tomorrow.'**
  String get voiceLimitReachedFree;

  /// No description provided for @voiceServerBusyTitle.
  ///
  /// In en, this message translates to:
  /// **'Servers Busy'**
  String get voiceServerBusyTitle;

  /// No description provided for @voiceServerBusyMessage.
  ///
  /// In en, this message translates to:
  /// **'Voice servers are busy right now. Please try again shortly.'**
  String get voiceServerBusyMessage;

  /// No description provided for @longPressFab.
  ///
  /// In en, this message translates to:
  /// **'Long-Press + Button'**
  String get longPressFab;

  /// No description provided for @longPressFabHint.
  ///
  /// In en, this message translates to:
  /// **'Hold for 1 second'**
  String get longPressFabHint;

  /// No description provided for @micButton.
  ///
  /// In en, this message translates to:
  /// **'Microphone Button'**
  String get micButton;

  /// No description provided for @micButtonHint.
  ///
  /// In en, this message translates to:
  /// **'Tap mic when adding expense'**
  String get micButtonHint;

  /// No description provided for @exampleCommands.
  ///
  /// In en, this message translates to:
  /// **'Example Commands'**
  String get exampleCommands;

  /// No description provided for @voiceExample1.
  ///
  /// In en, this message translates to:
  /// **'\"50 dollars for coffee\"'**
  String get voiceExample1;

  /// No description provided for @voiceExample2.
  ///
  /// In en, this message translates to:
  /// **'\"Spent 200 on groceries\"'**
  String get voiceExample2;

  /// No description provided for @voiceExample3.
  ///
  /// In en, this message translates to:
  /// **'\"Taxi was 150\"'**
  String get voiceExample3;

  /// No description provided for @voiceExamplesMultiline.
  ///
  /// In en, this message translates to:
  /// **'\"50 dollars coffee\"\n\"spent 200 on groceries\"\n\"taxi was 150\"'**
  String get voiceExamplesMultiline;

  /// No description provided for @somethingWentWrong.
  ///
  /// In en, this message translates to:
  /// **'Something went wrong. Please try again.'**
  String get somethingWentWrong;

  /// No description provided for @errorLoadingData.
  ///
  /// In en, this message translates to:
  /// **'Error loading data'**
  String get errorLoadingData;

  /// No description provided for @errorSaving.
  ///
  /// In en, this message translates to:
  /// **'Error saving. Please try again.'**
  String get errorSaving;

  /// No description provided for @networkError.
  ///
  /// In en, this message translates to:
  /// **'Network error. Check your connection.'**
  String get networkError;

  /// No description provided for @errorLoadingRates.
  ///
  /// In en, this message translates to:
  /// **'Could not load exchange rates'**
  String get errorLoadingRates;

  /// No description provided for @errorLoadingSubscriptions.
  ///
  /// In en, this message translates to:
  /// **'Could not load subscriptions'**
  String get errorLoadingSubscriptions;

  /// No description provided for @autoRecorded.
  ///
  /// In en, this message translates to:
  /// **'Auto'**
  String get autoRecorded;

  /// No description provided for @autoRecordedExpenses.
  ///
  /// In en, this message translates to:
  /// **'{count} subscription(s) auto-recorded'**
  String autoRecordedExpenses(int count);

  /// No description provided for @security.
  ///
  /// In en, this message translates to:
  /// **'Security'**
  String get security;

  /// No description provided for @pinLock.
  ///
  /// In en, this message translates to:
  /// **'PIN Lock'**
  String get pinLock;

  /// No description provided for @pinLockDescription.
  ///
  /// In en, this message translates to:
  /// **'Require PIN to open app'**
  String get pinLockDescription;

  /// No description provided for @biometricUnlock.
  ///
  /// In en, this message translates to:
  /// **'Biometric Unlock'**
  String get biometricUnlock;

  /// No description provided for @biometricDescription.
  ///
  /// In en, this message translates to:
  /// **'Use fingerprint or Face ID'**
  String get biometricDescription;

  /// No description provided for @enterPin.
  ///
  /// In en, this message translates to:
  /// **'Enter PIN'**
  String get enterPin;

  /// No description provided for @createPin.
  ///
  /// In en, this message translates to:
  /// **'Create PIN'**
  String get createPin;

  /// No description provided for @createPinDescription.
  ///
  /// In en, this message translates to:
  /// **'Choose a 4-digit PIN'**
  String get createPinDescription;

  /// No description provided for @confirmPin.
  ///
  /// In en, this message translates to:
  /// **'Confirm PIN'**
  String get confirmPin;

  /// No description provided for @confirmPinDescription.
  ///
  /// In en, this message translates to:
  /// **'Enter your PIN again'**
  String get confirmPinDescription;

  /// No description provided for @wrongPin.
  ///
  /// In en, this message translates to:
  /// **'Wrong PIN. Try again.'**
  String get wrongPin;

  /// No description provided for @pinMismatch.
  ///
  /// In en, this message translates to:
  /// **'PINs don\'t match. Try again.'**
  String get pinMismatch;

  /// No description provided for @pinSet.
  ///
  /// In en, this message translates to:
  /// **'PIN set successfully'**
  String get pinSet;

  /// No description provided for @useBiometric.
  ///
  /// In en, this message translates to:
  /// **'Use Biometric'**
  String get useBiometric;

  /// No description provided for @unlockWithBiometric.
  ///
  /// In en, this message translates to:
  /// **'Unlock Vantag'**
  String get unlockWithBiometric;

  /// No description provided for @reset.
  ///
  /// In en, this message translates to:
  /// **'Reset'**
  String get reset;

  /// No description provided for @assistantSetupTitle.
  ///
  /// In en, this message translates to:
  /// **'Google Assistant Setup'**
  String get assistantSetupTitle;

  /// No description provided for @assistantSetupHeadline.
  ///
  /// In en, this message translates to:
  /// **'Add expenses without saying \"Vantag\"'**
  String get assistantSetupHeadline;

  /// No description provided for @assistantSetupSubheadline.
  ///
  /// In en, this message translates to:
  /// **'After this setup, just say\n\"Hey Google, add expense\"'**
  String get assistantSetupSubheadline;

  /// No description provided for @assistantSetupComplete.
  ///
  /// In en, this message translates to:
  /// **'Great! Now you can say \"Hey Google, add expense\"'**
  String get assistantSetupComplete;

  /// No description provided for @assistantSetupStep1Title.
  ///
  /// In en, this message translates to:
  /// **'Open Google Assistant'**
  String get assistantSetupStep1Title;

  /// No description provided for @assistantSetupStep1Desc.
  ///
  /// In en, this message translates to:
  /// **'Say \"Hey Google, settings\" or open the Google Assistant app.'**
  String get assistantSetupStep1Desc;

  /// No description provided for @assistantSetupStep1Tip.
  ///
  /// In en, this message translates to:
  /// **'Tap the profile icon in the bottom right corner.'**
  String get assistantSetupStep1Tip;

  /// No description provided for @assistantSetupStep2Title.
  ///
  /// In en, this message translates to:
  /// **'Go to Routines'**
  String get assistantSetupStep2Title;

  /// No description provided for @assistantSetupStep2Desc.
  ///
  /// In en, this message translates to:
  /// **'Find and tap \"Routines\" in the settings.'**
  String get assistantSetupStep2Desc;

  /// No description provided for @assistantSetupStep2Tip.
  ///
  /// In en, this message translates to:
  /// **'May also appear as \"Shortcuts\" on some devices.'**
  String get assistantSetupStep2Tip;

  /// No description provided for @assistantSetupStep3Title.
  ///
  /// In en, this message translates to:
  /// **'Create New Routine'**
  String get assistantSetupStep3Title;

  /// No description provided for @assistantSetupStep3Desc.
  ///
  /// In en, this message translates to:
  /// **'Tap the \"+\" or \"New routine\" button.'**
  String get assistantSetupStep3Desc;

  /// No description provided for @assistantSetupStep3Tip.
  ///
  /// In en, this message translates to:
  /// **'Usually in the bottom right corner.'**
  String get assistantSetupStep3Tip;

  /// No description provided for @assistantSetupStep4Title.
  ///
  /// In en, this message translates to:
  /// **'Add Voice Command'**
  String get assistantSetupStep4Title;

  /// No description provided for @assistantSetupStep4Desc.
  ///
  /// In en, this message translates to:
  /// **'Tap \"When I say\" and add a voice command.\n\nType \"add expense\".'**
  String get assistantSetupStep4Desc;

  /// No description provided for @assistantSetupStep4Tip.
  ///
  /// In en, this message translates to:
  /// **'You can also use \"log expense\" or \"record spending\".'**
  String get assistantSetupStep4Tip;

  /// No description provided for @assistantSetupStep5Title.
  ///
  /// In en, this message translates to:
  /// **'Add Action'**
  String get assistantSetupStep5Title;

  /// No description provided for @assistantSetupStep5Desc.
  ///
  /// In en, this message translates to:
  /// **'\"Add action\" → \"Open app\" → Select \"Vantag\".'**
  String get assistantSetupStep5Desc;

  /// No description provided for @assistantSetupStep5Tip.
  ///
  /// In en, this message translates to:
  /// **'Search for Vantag if not visible in the list.'**
  String get assistantSetupStep5Tip;

  /// No description provided for @assistantSetupStep6Title.
  ///
  /// In en, this message translates to:
  /// **'Save'**
  String get assistantSetupStep6Title;

  /// No description provided for @assistantSetupStep6Desc.
  ///
  /// In en, this message translates to:
  /// **'Tap \"Save\" in the top right corner.'**
  String get assistantSetupStep6Desc;

  /// No description provided for @assistantSetupStep6Tip.
  ///
  /// In en, this message translates to:
  /// **'You may be asked to name the routine.'**
  String get assistantSetupStep6Tip;

  /// No description provided for @step.
  ///
  /// In en, this message translates to:
  /// **'Step'**
  String get step;

  /// No description provided for @next.
  ///
  /// In en, this message translates to:
  /// **'Next'**
  String get next;

  /// No description provided for @back.
  ///
  /// In en, this message translates to:
  /// **'Back'**
  String get back;

  /// No description provided for @laterButton.
  ///
  /// In en, this message translates to:
  /// **'I\'ll do it later'**
  String get laterButton;

  /// No description provided for @monthlySpendingBreakdown.
  ///
  /// In en, this message translates to:
  /// **'Monthly Spending Breakdown'**
  String get monthlySpendingBreakdown;

  /// No description provided for @mandatoryExpenses.
  ///
  /// In en, this message translates to:
  /// **'Mandatory'**
  String get mandatoryExpenses;

  /// No description provided for @discretionaryExpenses.
  ///
  /// In en, this message translates to:
  /// **'Discretionary'**
  String get discretionaryExpenses;

  /// No description provided for @remainingHoursToSpend.
  ///
  /// In en, this message translates to:
  /// **'{hours} hours left to spend'**
  String remainingHoursToSpend(String hours);

  /// No description provided for @budgetExceeded.
  ///
  /// In en, this message translates to:
  /// **'You exceeded your budget by {amount}!'**
  String budgetExceeded(String amount);

  /// No description provided for @activeInstallments.
  ///
  /// In en, this message translates to:
  /// **'Active Installments'**
  String get activeInstallments;

  /// No description provided for @installmentCount.
  ///
  /// In en, this message translates to:
  /// **'{count} installments'**
  String installmentCount(int count);

  /// No description provided for @moreInstallments.
  ///
  /// In en, this message translates to:
  /// **'+{count} more installments'**
  String moreInstallments(int count);

  /// No description provided for @monthlyBurden.
  ///
  /// In en, this message translates to:
  /// **'Monthly Burden'**
  String get monthlyBurden;

  /// No description provided for @remainingDebt.
  ///
  /// In en, this message translates to:
  /// **'Remaining Debt'**
  String get remainingDebt;

  /// No description provided for @totalInterestCost.
  ///
  /// In en, this message translates to:
  /// **'Total interest: {amount} ({hours} hours)'**
  String totalInterestCost(String amount, String hours);

  /// No description provided for @monthAbbreviation.
  ///
  /// In en, this message translates to:
  /// **'mo'**
  String get monthAbbreviation;

  /// No description provided for @installmentsLabel.
  ///
  /// In en, this message translates to:
  /// **'installments'**
  String get installmentsLabel;

  /// No description provided for @remaining.
  ///
  /// In en, this message translates to:
  /// **'Remaining'**
  String get remaining;

  /// No description provided for @paywallTitle.
  ///
  /// In en, this message translates to:
  /// **'Upgrade to Premium'**
  String get paywallTitle;

  /// No description provided for @paywallSubtitle.
  ///
  /// In en, this message translates to:
  /// **'Unlock all features and achieve your financial freedom'**
  String get paywallSubtitle;

  /// No description provided for @subscribeToPro.
  ///
  /// In en, this message translates to:
  /// **'Subscribe to Pro'**
  String get subscribeToPro;

  /// No description provided for @startFreeTrial.
  ///
  /// In en, this message translates to:
  /// **'Start 7-Day Free Trial'**
  String get startFreeTrial;

  /// No description provided for @freeTrialBanner.
  ///
  /// In en, this message translates to:
  /// **'7 DAYS FREE'**
  String get freeTrialBanner;

  /// No description provided for @freeTrialDescription.
  ///
  /// In en, this message translates to:
  /// **'First 7 days completely free, cancel anytime'**
  String get freeTrialDescription;

  /// No description provided for @trialThenPrice.
  ///
  /// In en, this message translates to:
  /// **'Then {price}/month after trial'**
  String trialThenPrice(String price);

  /// No description provided for @noPaymentNow.
  ///
  /// In en, this message translates to:
  /// **'No payment required now'**
  String get noPaymentNow;

  /// No description provided for @restorePurchases.
  ///
  /// In en, this message translates to:
  /// **'Restore purchases'**
  String get restorePurchases;

  /// No description provided for @feature.
  ///
  /// In en, this message translates to:
  /// **'Feature'**
  String get feature;

  /// No description provided for @featureAiChat.
  ///
  /// In en, this message translates to:
  /// **'AI Chat'**
  String get featureAiChat;

  /// No description provided for @featureAiChatFree.
  ///
  /// In en, this message translates to:
  /// **'4/day'**
  String get featureAiChatFree;

  /// No description provided for @featureHistory.
  ///
  /// In en, this message translates to:
  /// **'History'**
  String get featureHistory;

  /// No description provided for @featureHistory30Days.
  ///
  /// In en, this message translates to:
  /// **'30 days'**
  String get featureHistory30Days;

  /// No description provided for @featureExport.
  ///
  /// In en, this message translates to:
  /// **'Excel Export'**
  String get featureExport;

  /// No description provided for @featureWidgets.
  ///
  /// In en, this message translates to:
  /// **'Widgets'**
  String get featureWidgets;

  /// No description provided for @featureAds.
  ///
  /// In en, this message translates to:
  /// **'Ads'**
  String get featureAds;

  /// No description provided for @featureUnlimited.
  ///
  /// In en, this message translates to:
  /// **'Unlimited'**
  String get featureUnlimited;

  /// No description provided for @featureYes.
  ///
  /// In en, this message translates to:
  /// **'Yes'**
  String get featureYes;

  /// No description provided for @featureNo.
  ///
  /// In en, this message translates to:
  /// **'No'**
  String get featureNo;

  /// No description provided for @weekly.
  ///
  /// In en, this message translates to:
  /// **'Weekly'**
  String get weekly;

  /// No description provided for @week.
  ///
  /// In en, this message translates to:
  /// **'week'**
  String get week;

  /// No description provided for @year.
  ///
  /// In en, this message translates to:
  /// **'year'**
  String get year;

  /// No description provided for @bestValue.
  ///
  /// In en, this message translates to:
  /// **'Best Value'**
  String get bestValue;

  /// No description provided for @yearlySavings.
  ///
  /// In en, this message translates to:
  /// **'Save up to 50%'**
  String get yearlySavings;

  /// No description provided for @cancelAnytime.
  ///
  /// In en, this message translates to:
  /// **'Cancel anytime'**
  String get cancelAnytime;

  /// No description provided for @aiLimitReached.
  ///
  /// In en, this message translates to:
  /// **'Daily AI limit reached'**
  String get aiLimitReached;

  /// No description provided for @aiLimitMessage.
  ///
  /// In en, this message translates to:
  /// **'You\'ve used {used}/{limit} AI chats today. Upgrade to Pro for unlimited access.'**
  String aiLimitMessage(int used, int limit);

  /// No description provided for @historyLimitReached.
  ///
  /// In en, this message translates to:
  /// **'History limit reached'**
  String get historyLimitReached;

  /// No description provided for @historyLimitMessage.
  ///
  /// In en, this message translates to:
  /// **'Free plan only shows last 30 days. Upgrade to Pro for full history access.'**
  String get historyLimitMessage;

  /// No description provided for @exportProOnly.
  ///
  /// In en, this message translates to:
  /// **'Excel export is a Pro feature'**
  String get exportProOnly;

  /// No description provided for @remainingAiUses.
  ///
  /// In en, this message translates to:
  /// **'{count} AI uses left'**
  String remainingAiUses(int count);

  /// No description provided for @lifetime.
  ///
  /// In en, this message translates to:
  /// **'Lifetime'**
  String get lifetime;

  /// No description provided for @lifetimeDescription.
  ///
  /// In en, this message translates to:
  /// **'Pay once, use forever • 100 AI credits/month'**
  String get lifetimeDescription;

  /// No description provided for @oneTime.
  ///
  /// In en, this message translates to:
  /// **'one-time'**
  String get oneTime;

  /// No description provided for @forever.
  ///
  /// In en, this message translates to:
  /// **'FOREVER'**
  String get forever;

  /// No description provided for @mostPopular.
  ///
  /// In en, this message translates to:
  /// **'MOST POPULAR'**
  String get mostPopular;

  /// No description provided for @monthlyCredits.
  ///
  /// In en, this message translates to:
  /// **'{count} AI credits/month'**
  String monthlyCredits(int count);

  /// No description provided for @proMonthlyCredits.
  ///
  /// In en, this message translates to:
  /// **'{remaining}/{limit} monthly credits'**
  String proMonthlyCredits(int remaining, int limit);

  /// No description provided for @aiLimitFreeTitleEmoji.
  ///
  /// In en, this message translates to:
  /// **'🔒 Daily AI Limit Reached!'**
  String get aiLimitFreeTitleEmoji;

  /// No description provided for @aiLimitProTitleEmoji.
  ///
  /// In en, this message translates to:
  /// **'⏳ Monthly AI Limit Reached!'**
  String get aiLimitProTitleEmoji;

  /// No description provided for @aiLimitFreeMessage.
  ///
  /// In en, this message translates to:
  /// **'You\'ve used all 4 AI questions for today.'**
  String get aiLimitFreeMessage;

  /// No description provided for @aiLimitProMessage.
  ///
  /// In en, this message translates to:
  /// **'You\'ve used all 500 AI questions this month.'**
  String get aiLimitProMessage;

  /// No description provided for @aiLimitLifetimeMessage.
  ///
  /// In en, this message translates to:
  /// **'You\'ve used all 200 AI credits this month.'**
  String get aiLimitLifetimeMessage;

  /// No description provided for @aiLimitResetDate.
  ///
  /// In en, this message translates to:
  /// **'Limit resets on {month} {day} ({days} days left)'**
  String aiLimitResetDate(String day, String month, int days);

  /// No description provided for @aiLimitUpgradeToPro.
  ///
  /// In en, this message translates to:
  /// **'🚀 Upgrade to Pro - Unlimited AI'**
  String get aiLimitUpgradeToPro;

  /// No description provided for @aiLimitBuyCredits.
  ///
  /// In en, this message translates to:
  /// **'🔋 Buy Extra Credit Pack'**
  String get aiLimitBuyCredits;

  /// No description provided for @aiLimitTryTomorrow.
  ///
  /// In en, this message translates to:
  /// **'or try again tomorrow'**
  String get aiLimitTryTomorrow;

  /// No description provided for @aiLimitOrWaitDays.
  ///
  /// In en, this message translates to:
  /// **'or wait {days} days for reset'**
  String aiLimitOrWaitDays(int days);

  /// No description provided for @creditPurchaseTitle.
  ///
  /// In en, this message translates to:
  /// **'Buy Credits'**
  String get creditPurchaseTitle;

  /// No description provided for @creditPurchaseHeader.
  ///
  /// In en, this message translates to:
  /// **'Top Up AI Credits'**
  String get creditPurchaseHeader;

  /// No description provided for @creditPurchaseSubtitle.
  ///
  /// In en, this message translates to:
  /// **'Purchase extra credits for AI queries beyond your monthly limit.'**
  String get creditPurchaseSubtitle;

  /// No description provided for @creditCurrentBalance.
  ///
  /// In en, this message translates to:
  /// **'Current Balance'**
  String get creditCurrentBalance;

  /// No description provided for @creditAmount.
  ///
  /// In en, this message translates to:
  /// **'{credits} Credits'**
  String creditAmount(int credits);

  /// No description provided for @creditPackTitle.
  ///
  /// In en, this message translates to:
  /// **'{credits} Credits'**
  String creditPackTitle(int credits);

  /// No description provided for @creditPackPricePerCredit.
  ///
  /// In en, this message translates to:
  /// **'₺{price} per credit'**
  String creditPackPricePerCredit(String price);

  /// No description provided for @creditPackPopular.
  ///
  /// In en, this message translates to:
  /// **'MOST POPULAR'**
  String get creditPackPopular;

  /// No description provided for @creditPackBestValue.
  ///
  /// In en, this message translates to:
  /// **'BEST VALUE'**
  String get creditPackBestValue;

  /// No description provided for @creditNeverExpire.
  ///
  /// In en, this message translates to:
  /// **'Credits never expire, use them anytime'**
  String get creditNeverExpire;

  /// No description provided for @creditPurchaseSuccess.
  ///
  /// In en, this message translates to:
  /// **'{credits} credits added to your account!'**
  String creditPurchaseSuccess(int credits);

  /// No description provided for @pursuits.
  ///
  /// In en, this message translates to:
  /// **'My Dreams'**
  String get pursuits;

  /// No description provided for @myPursuits.
  ///
  /// In en, this message translates to:
  /// **'My Dreams'**
  String get myPursuits;

  /// No description provided for @navPursuits.
  ///
  /// In en, this message translates to:
  /// **'Dreams'**
  String get navPursuits;

  /// No description provided for @createPursuit.
  ///
  /// In en, this message translates to:
  /// **'New Dream'**
  String get createPursuit;

  /// No description provided for @pursuitName.
  ///
  /// In en, this message translates to:
  /// **'What are you saving for?'**
  String get pursuitName;

  /// No description provided for @pursuitNameHint.
  ///
  /// In en, this message translates to:
  /// **'e.g: iPhone 16, Maldives Vacation...'**
  String get pursuitNameHint;

  /// No description provided for @targetAmount.
  ///
  /// In en, this message translates to:
  /// **'Target Amount'**
  String get targetAmount;

  /// No description provided for @savedAmount.
  ///
  /// In en, this message translates to:
  /// **'Saved'**
  String get savedAmount;

  /// No description provided for @addSavings.
  ///
  /// In en, this message translates to:
  /// **'Add Money'**
  String get addSavings;

  /// No description provided for @pursuitProgress.
  ///
  /// In en, this message translates to:
  /// **'{percent}% complete'**
  String pursuitProgress(int percent);

  /// No description provided for @daysToGoal.
  ///
  /// In en, this message translates to:
  /// **'≈ {days} work days'**
  String daysToGoal(int days);

  /// No description provided for @pursuitCompleted.
  ///
  /// In en, this message translates to:
  /// **'Your Dream Came True!'**
  String get pursuitCompleted;

  /// No description provided for @congratulations.
  ///
  /// In en, this message translates to:
  /// **'Congratulations!'**
  String get congratulations;

  /// No description provided for @pursuitCompletedMessage.
  ///
  /// In en, this message translates to:
  /// **'You saved {amount} in {days} days!'**
  String pursuitCompletedMessage(int days, String amount);

  /// No description provided for @shareProgress.
  ///
  /// In en, this message translates to:
  /// **'Share Progress'**
  String get shareProgress;

  /// No description provided for @activePursuits.
  ///
  /// In en, this message translates to:
  /// **'Active'**
  String get activePursuits;

  /// No description provided for @completedPursuits.
  ///
  /// In en, this message translates to:
  /// **'Completed'**
  String get completedPursuits;

  /// No description provided for @archivePursuit.
  ///
  /// In en, this message translates to:
  /// **'Archive'**
  String get archivePursuit;

  /// No description provided for @deletePursuit.
  ///
  /// In en, this message translates to:
  /// **'Delete'**
  String get deletePursuit;

  /// No description provided for @editPursuit.
  ///
  /// In en, this message translates to:
  /// **'Edit'**
  String get editPursuit;

  /// No description provided for @deletePursuitConfirm.
  ///
  /// In en, this message translates to:
  /// **'Are you sure you want to delete this dream?'**
  String get deletePursuitConfirm;

  /// No description provided for @pursuitCategoryTech.
  ///
  /// In en, this message translates to:
  /// **'Tech'**
  String get pursuitCategoryTech;

  /// No description provided for @pursuitCategoryTravel.
  ///
  /// In en, this message translates to:
  /// **'Travel'**
  String get pursuitCategoryTravel;

  /// No description provided for @pursuitCategoryHome.
  ///
  /// In en, this message translates to:
  /// **'Home'**
  String get pursuitCategoryHome;

  /// No description provided for @pursuitCategoryFashion.
  ///
  /// In en, this message translates to:
  /// **'Fashion'**
  String get pursuitCategoryFashion;

  /// No description provided for @pursuitCategoryVehicle.
  ///
  /// In en, this message translates to:
  /// **'Vehicle'**
  String get pursuitCategoryVehicle;

  /// No description provided for @pursuitCategoryEducation.
  ///
  /// In en, this message translates to:
  /// **'Education'**
  String get pursuitCategoryEducation;

  /// No description provided for @pursuitCategoryHealth.
  ///
  /// In en, this message translates to:
  /// **'Health'**
  String get pursuitCategoryHealth;

  /// No description provided for @pursuitCategoryOther.
  ///
  /// In en, this message translates to:
  /// **'Other'**
  String get pursuitCategoryOther;

  /// No description provided for @emptyPursuitsTitle.
  ///
  /// In en, this message translates to:
  /// **'Take a Step Toward Your Dream'**
  String get emptyPursuitsTitle;

  /// No description provided for @emptyPursuitsMessage.
  ///
  /// In en, this message translates to:
  /// **'Add your first dream and start saving!'**
  String get emptyPursuitsMessage;

  /// No description provided for @addFirstPursuit.
  ///
  /// In en, this message translates to:
  /// **'Add Your First Dream'**
  String get addFirstPursuit;

  /// No description provided for @pursuitLimitReached.
  ///
  /// In en, this message translates to:
  /// **'Upgrade to Pro for unlimited dreams'**
  String get pursuitLimitReached;

  /// No description provided for @quickAmounts.
  ///
  /// In en, this message translates to:
  /// **'Quick Amounts'**
  String get quickAmounts;

  /// No description provided for @addNote.
  ///
  /// In en, this message translates to:
  /// **'Add note (optional)'**
  String get addNote;

  /// No description provided for @pursuitCreated.
  ///
  /// In en, this message translates to:
  /// **'Dream created!'**
  String get pursuitCreated;

  /// No description provided for @savingsAdded.
  ///
  /// In en, this message translates to:
  /// **'Added!'**
  String get savingsAdded;

  /// No description provided for @workHoursRemaining.
  ///
  /// In en, this message translates to:
  /// **'{hours} work hours remaining'**
  String workHoursRemaining(String hours);

  /// No description provided for @pursuitInitialSavings.
  ///
  /// In en, this message translates to:
  /// **'Initial Savings'**
  String get pursuitInitialSavings;

  /// No description provided for @pursuitInitialSavingsHint.
  ///
  /// In en, this message translates to:
  /// **'Amount you\'ve already saved'**
  String get pursuitInitialSavingsHint;

  /// No description provided for @pursuitSelectCategory.
  ///
  /// In en, this message translates to:
  /// **'Select Category'**
  String get pursuitSelectCategory;

  /// No description provided for @redirectSavings.
  ///
  /// In en, this message translates to:
  /// **'Redirect Savings to Dream'**
  String get redirectSavings;

  /// No description provided for @redirectSavingsMessage.
  ///
  /// In en, this message translates to:
  /// **'Which dream would you like to add the {amount} you saved?'**
  String redirectSavingsMessage(String amount);

  /// No description provided for @skipRedirect.
  ///
  /// In en, this message translates to:
  /// **'Skip for Now'**
  String get skipRedirect;

  /// No description provided for @pursuitTransactionHistory.
  ///
  /// In en, this message translates to:
  /// **'Transaction History'**
  String get pursuitTransactionHistory;

  /// No description provided for @noTransactions.
  ///
  /// In en, this message translates to:
  /// **'No transactions yet'**
  String get noTransactions;

  /// No description provided for @transactionSourceManual.
  ///
  /// In en, this message translates to:
  /// **'Manual Entry'**
  String get transactionSourceManual;

  /// No description provided for @transactionSourcePool.
  ///
  /// In en, this message translates to:
  /// **'Pool Transfer'**
  String get transactionSourcePool;

  /// No description provided for @transactionSourceExpense.
  ///
  /// In en, this message translates to:
  /// **'Cancelled Expense'**
  String get transactionSourceExpense;

  /// No description provided for @savingsPool.
  ///
  /// In en, this message translates to:
  /// **'Savings Pool'**
  String get savingsPool;

  /// No description provided for @savingsPoolAvailable.
  ///
  /// In en, this message translates to:
  /// **'available'**
  String get savingsPoolAvailable;

  /// No description provided for @savingsPoolDebt.
  ///
  /// In en, this message translates to:
  /// **'You owe'**
  String get savingsPoolDebt;

  /// No description provided for @shadowDebtMessage.
  ///
  /// In en, this message translates to:
  /// **'You borrowed {amount} from your future self'**
  String shadowDebtMessage(String amount);

  /// No description provided for @budgetShiftQuestion.
  ///
  /// In en, this message translates to:
  /// **'Where did this {amount} come from?'**
  String budgetShiftQuestion(String amount);

  /// No description provided for @jokerUsed.
  ///
  /// In en, this message translates to:
  /// **'You used this month\'s joker'**
  String get jokerUsed;

  /// No description provided for @jokerAvailable.
  ///
  /// In en, this message translates to:
  /// **'You have a joker available!'**
  String get jokerAvailable;

  /// No description provided for @allocatedToDreams.
  ///
  /// In en, this message translates to:
  /// **'{amount} allocated to dreams'**
  String allocatedToDreams(String amount);

  /// No description provided for @extraIncome.
  ///
  /// In en, this message translates to:
  /// **'I earned extra income'**
  String get extraIncome;

  /// No description provided for @useJoker.
  ///
  /// In en, this message translates to:
  /// **'Use Joker (1/month)'**
  String get useJoker;

  /// No description provided for @budgetShiftFromFood.
  ///
  /// In en, this message translates to:
  /// **'From my food budget'**
  String get budgetShiftFromFood;

  /// No description provided for @budgetShiftFromEntertainment.
  ///
  /// In en, this message translates to:
  /// **'From my entertainment budget'**
  String get budgetShiftFromEntertainment;

  /// No description provided for @budgetShiftFromClothing.
  ///
  /// In en, this message translates to:
  /// **'From my clothing budget'**
  String get budgetShiftFromClothing;

  /// No description provided for @budgetShiftFromTransport.
  ///
  /// In en, this message translates to:
  /// **'From my transport budget'**
  String get budgetShiftFromTransport;

  /// No description provided for @budgetShiftFromShopping.
  ///
  /// In en, this message translates to:
  /// **'From my shopping budget'**
  String get budgetShiftFromShopping;

  /// No description provided for @budgetShiftFromHealth.
  ///
  /// In en, this message translates to:
  /// **'From my health budget'**
  String get budgetShiftFromHealth;

  /// No description provided for @budgetShiftFromEducation.
  ///
  /// In en, this message translates to:
  /// **'From my education budget'**
  String get budgetShiftFromEducation;

  /// No description provided for @insufficientFunds.
  ///
  /// In en, this message translates to:
  /// **'Insufficient funds'**
  String get insufficientFunds;

  /// No description provided for @insufficientFundsMessage.
  ///
  /// In en, this message translates to:
  /// **'Pool has {available}, you want {requested}'**
  String insufficientFundsMessage(String available, String requested);

  /// No description provided for @createShadowDebt.
  ///
  /// In en, this message translates to:
  /// **'Add anyway (create debt)'**
  String get createShadowDebt;

  /// No description provided for @debtRepaidMessage.
  ///
  /// In en, this message translates to:
  /// **'{amount} paid towards your debt!'**
  String debtRepaidMessage(String amount);

  /// No description provided for @poolSummaryTotal.
  ///
  /// In en, this message translates to:
  /// **'Total Savings'**
  String get poolSummaryTotal;

  /// No description provided for @poolSummaryAllocated.
  ///
  /// In en, this message translates to:
  /// **'Allocated to Dreams'**
  String get poolSummaryAllocated;

  /// No description provided for @poolSummaryAvailable.
  ///
  /// In en, this message translates to:
  /// **'Available'**
  String get poolSummaryAvailable;

  /// No description provided for @overAllocationTitle.
  ///
  /// In en, this message translates to:
  /// **'Insufficient Pool Balance'**
  String get overAllocationTitle;

  /// No description provided for @overAllocationMessage.
  ///
  /// In en, this message translates to:
  /// **'Pool has {available}. You want to add {requested}.'**
  String overAllocationMessage(String available, String requested);

  /// No description provided for @fromMyPocket.
  ///
  /// In en, this message translates to:
  /// **'Add from my pocket'**
  String get fromMyPocket;

  /// No description provided for @fromMyPocketDesc.
  ///
  /// In en, this message translates to:
  /// **'Zero out pool + add {difference} from pocket'**
  String fromMyPocketDesc(String difference);

  /// No description provided for @deductFromFuture.
  ///
  /// In en, this message translates to:
  /// **'Deduct from future savings'**
  String get deductFromFuture;

  /// No description provided for @deductFromFutureDesc.
  ///
  /// In en, this message translates to:
  /// **'Pool will go negative by {amount}'**
  String deductFromFutureDesc(String amount);

  /// No description provided for @transferAvailableOnly.
  ///
  /// In en, this message translates to:
  /// **'Transfer only {amount}'**
  String transferAvailableOnly(String amount);

  /// No description provided for @transferAvailableOnlyDesc.
  ///
  /// In en, this message translates to:
  /// **'Add only what\'s available in the pool'**
  String get transferAvailableOnlyDesc;

  /// No description provided for @oneTimeIncomeTitle.
  ///
  /// In en, this message translates to:
  /// **'Where is this money from?'**
  String get oneTimeIncomeTitle;

  /// No description provided for @oneTimeIncomeDesc.
  ///
  /// In en, this message translates to:
  /// **'Your pool is in debt. Choose the source:'**
  String get oneTimeIncomeDesc;

  /// No description provided for @oneTimeIncomeOption.
  ///
  /// In en, this message translates to:
  /// **'One-time income'**
  String get oneTimeIncomeOption;

  /// No description provided for @oneTimeIncomeOptionDesc.
  ///
  /// In en, this message translates to:
  /// **'Doesn\'t affect the pool, goes directly to goal'**
  String get oneTimeIncomeOptionDesc;

  /// No description provided for @fromSavingsOption.
  ///
  /// In en, this message translates to:
  /// **'From my savings'**
  String get fromSavingsOption;

  /// No description provided for @fromSavingsOptionDesc.
  ///
  /// In en, this message translates to:
  /// **'Pool will go further negative'**
  String get fromSavingsOptionDesc;

  /// No description provided for @debtWarningOnPurchase.
  ///
  /// In en, this message translates to:
  /// **'You owe {amount} to your dreams!'**
  String debtWarningOnPurchase(String amount);

  /// No description provided for @debtReminderNotification.
  ///
  /// In en, this message translates to:
  /// **'Don\'t forget to pay off your debt to your dreams!'**
  String get debtReminderNotification;

  /// No description provided for @aiThinking.
  ///
  /// In en, this message translates to:
  /// **'Thinking...'**
  String get aiThinking;

  /// No description provided for @aiSuggestion1.
  ///
  /// In en, this message translates to:
  /// **'Where did I spend this month?'**
  String get aiSuggestion1;

  /// No description provided for @aiSuggestion2.
  ///
  /// In en, this message translates to:
  /// **'Where can I save money?'**
  String get aiSuggestion2;

  /// No description provided for @aiSuggestion3.
  ///
  /// In en, this message translates to:
  /// **'What\'s my most expensive habit?'**
  String get aiSuggestion3;

  /// No description provided for @aiSuggestion4.
  ///
  /// In en, this message translates to:
  /// **'How far am I from my goal?'**
  String get aiSuggestion4;

  /// No description provided for @aiPremiumUpsell.
  ///
  /// In en, this message translates to:
  /// **'Get detailed analysis and personal savings plan with Premium'**
  String get aiPremiumUpsell;

  /// No description provided for @aiPremiumButton.
  ///
  /// In en, this message translates to:
  /// **'Go Premium'**
  String get aiPremiumButton;

  /// No description provided for @aiInputPlaceholderFree.
  ///
  /// In en, this message translates to:
  /// **'Ask your own question 🔒'**
  String get aiInputPlaceholderFree;

  /// No description provided for @aiInputPlaceholder.
  ///
  /// In en, this message translates to:
  /// **'Ask something...'**
  String get aiInputPlaceholder;

  /// No description provided for @onboardingTryTitle.
  ///
  /// In en, this message translates to:
  /// **'Let\'s Try!'**
  String get onboardingTryTitle;

  /// No description provided for @onboardingTrySubtitle.
  ///
  /// In en, this message translates to:
  /// **'Curious how long you\'d work for something?'**
  String get onboardingTrySubtitle;

  /// No description provided for @onboardingTryButton.
  ///
  /// In en, this message translates to:
  /// **'Calculate'**
  String get onboardingTryButton;

  /// No description provided for @onboardingTryDisclaimer.
  ///
  /// In en, this message translates to:
  /// **'This was just to show how abstract money is and how concrete time is.'**
  String get onboardingTryDisclaimer;

  /// No description provided for @onboardingTryNotSaved.
  ///
  /// In en, this message translates to:
  /// **'Don\'t worry, this wasn\'t saved to your expenses.'**
  String get onboardingTryNotSaved;

  /// No description provided for @onboardingContinue.
  ///
  /// In en, this message translates to:
  /// **'Continue to App'**
  String get onboardingContinue;

  /// No description provided for @onboardingTryResult.
  ///
  /// In en, this message translates to:
  /// **'This expense takes {hours} hours from your life'**
  String onboardingTryResult(String hours);

  /// No description provided for @subscriptionPriceHint.
  ///
  /// In en, this message translates to:
  /// **'\$9.99'**
  String get subscriptionPriceHint;

  /// No description provided for @currencyUpdatePopup.
  ///
  /// In en, this message translates to:
  /// **'Currency updating: {oldAmount} {oldCurrency} ≈ {newAmount} {newCurrency}'**
  String currencyUpdatePopup(
    String oldAmount,
    String oldCurrency,
    String newAmount,
    String newCurrency,
  );

  /// No description provided for @currencyConverting.
  ///
  /// In en, this message translates to:
  /// **'Converting currency...'**
  String get currencyConverting;

  /// No description provided for @currencyConversionFailed.
  ///
  /// In en, this message translates to:
  /// **'Could not fetch exchange rate, values unchanged'**
  String get currencyConversionFailed;

  /// No description provided for @requiredExpense.
  ///
  /// In en, this message translates to:
  /// **'Required Expense'**
  String get requiredExpense;

  /// No description provided for @installmentPurchase.
  ///
  /// In en, this message translates to:
  /// **'Installment Purchase'**
  String get installmentPurchase;

  /// No description provided for @installmentInfo.
  ///
  /// In en, this message translates to:
  /// **'Installment Information'**
  String get installmentInfo;

  /// No description provided for @cashPrice.
  ///
  /// In en, this message translates to:
  /// **'Cash Price'**
  String get cashPrice;

  /// No description provided for @cashPriceHint.
  ///
  /// In en, this message translates to:
  /// **'Original cash price'**
  String get cashPriceHint;

  /// No description provided for @numberOfInstallments.
  ///
  /// In en, this message translates to:
  /// **'Number of Installments'**
  String get numberOfInstallments;

  /// No description provided for @totalInstallmentPrice.
  ///
  /// In en, this message translates to:
  /// **'Total Installment Price'**
  String get totalInstallmentPrice;

  /// No description provided for @totalWithInterestHint.
  ///
  /// In en, this message translates to:
  /// **'Total with interest'**
  String get totalWithInterestHint;

  /// No description provided for @installmentSummary.
  ///
  /// In en, this message translates to:
  /// **'INSTALLMENT SUMMARY'**
  String get installmentSummary;

  /// No description provided for @willBeSavedAsRequired.
  ///
  /// In en, this message translates to:
  /// **'Will be saved as required expense'**
  String get willBeSavedAsRequired;

  /// No description provided for @creditCardOrStoreInstallment.
  ///
  /// In en, this message translates to:
  /// **'Credit card or store installment'**
  String get creditCardOrStoreInstallment;

  /// No description provided for @vantagAI.
  ///
  /// In en, this message translates to:
  /// **'Vantag AI'**
  String get vantagAI;

  /// No description provided for @professionalMode.
  ///
  /// In en, this message translates to:
  /// **'Professional mode'**
  String get professionalMode;

  /// No description provided for @friendlyMode.
  ///
  /// In en, this message translates to:
  /// **'Friendly mode'**
  String get friendlyMode;

  /// No description provided for @errorTryAgain.
  ///
  /// In en, this message translates to:
  /// **'An error occurred, try again?'**
  String get errorTryAgain;

  /// No description provided for @aiFallbackOverBudget.
  ///
  /// In en, this message translates to:
  /// **'Budget seems a bit tight.\nLet\'s see what we can do together?'**
  String get aiFallbackOverBudget;

  /// No description provided for @aiFallbackHighUsage.
  ///
  /// In en, this message translates to:
  /// **'End of month approaching, let\'s be careful.\nHow can I help?'**
  String get aiFallbackHighUsage;

  /// No description provided for @aiFallbackMediumUsage.
  ///
  /// In en, this message translates to:
  /// **'Budget is holding up.\nWant to ask something?'**
  String get aiFallbackMediumUsage;

  /// No description provided for @aiFallbackLowUsage.
  ///
  /// In en, this message translates to:
  /// **'Your budget is looking great!\nWhat should we analyze?'**
  String get aiFallbackLowUsage;

  /// No description provided for @aiInsights.
  ///
  /// In en, this message translates to:
  /// **'AI Insights'**
  String get aiInsights;

  /// No description provided for @mostSpendingDay.
  ///
  /// In en, this message translates to:
  /// **'Busiest Spending Day'**
  String get mostSpendingDay;

  /// No description provided for @biggestCategory.
  ///
  /// In en, this message translates to:
  /// **'Biggest Category'**
  String get biggestCategory;

  /// No description provided for @thisMonthVsLast.
  ///
  /// In en, this message translates to:
  /// **'This Month vs Last Month'**
  String get thisMonthVsLast;

  /// No description provided for @monday.
  ///
  /// In en, this message translates to:
  /// **'Monday'**
  String get monday;

  /// No description provided for @tuesday.
  ///
  /// In en, this message translates to:
  /// **'Tuesday'**
  String get tuesday;

  /// No description provided for @wednesday.
  ///
  /// In en, this message translates to:
  /// **'Wednesday'**
  String get wednesday;

  /// No description provided for @thursday.
  ///
  /// In en, this message translates to:
  /// **'Thursday'**
  String get thursday;

  /// No description provided for @friday.
  ///
  /// In en, this message translates to:
  /// **'Friday'**
  String get friday;

  /// No description provided for @saturday.
  ///
  /// In en, this message translates to:
  /// **'Saturday'**
  String get saturday;

  /// No description provided for @sunday.
  ///
  /// In en, this message translates to:
  /// **'Sunday'**
  String get sunday;

  /// No description provided for @securePayment.
  ///
  /// In en, this message translates to:
  /// **'Secure Payment'**
  String get securePayment;

  /// No description provided for @encrypted.
  ///
  /// In en, this message translates to:
  /// **'Encrypted'**
  String get encrypted;

  /// No description provided for @syncing.
  ///
  /// In en, this message translates to:
  /// **'Syncing data...'**
  String get syncing;

  /// No description provided for @pendingSync.
  ///
  /// In en, this message translates to:
  /// **'{count} changes pending sync'**
  String pendingSync(int count);

  /// No description provided for @pendingLabel.
  ///
  /// In en, this message translates to:
  /// **'Pending'**
  String get pendingLabel;

  /// No description provided for @insightMinutes.
  ///
  /// In en, this message translates to:
  /// **'This expense took {minutes} minutes of your life.'**
  String insightMinutes(int minutes);

  /// No description provided for @insightHours.
  ///
  /// In en, this message translates to:
  /// **'This expense took {hours} hours of your life.'**
  String insightHours(String hours);

  /// No description provided for @insightAlmostDay.
  ///
  /// In en, this message translates to:
  /// **'You worked almost a full day for this expense.'**
  String get insightAlmostDay;

  /// No description provided for @insightDays.
  ///
  /// In en, this message translates to:
  /// **'This expense took {days} days of your life.'**
  String insightDays(String days);

  /// No description provided for @insightDaysWorked.
  ///
  /// In en, this message translates to:
  /// **'You had to work {days} days for this expense.'**
  String insightDaysWorked(String days);

  /// No description provided for @insightAlmostMonth.
  ///
  /// In en, this message translates to:
  /// **'This expense cost you almost a month of work.'**
  String get insightAlmostMonth;

  /// No description provided for @insightCategoryDays.
  ///
  /// In en, this message translates to:
  /// **'This month you worked {days} days for {category}.'**
  String insightCategoryDays(String category, String days);

  /// No description provided for @insightCategoryHours.
  ///
  /// In en, this message translates to:
  /// **'This month you worked {hours} hours for {category}.'**
  String insightCategoryHours(String category, String hours);

  /// No description provided for @insightMonthlyAlmost.
  ///
  /// In en, this message translates to:
  /// **'You worked almost the entire month for this month\'s expenses.'**
  String get insightMonthlyAlmost;

  /// No description provided for @insightMonthlyDays.
  ///
  /// In en, this message translates to:
  /// **'You worked {days} days for this month\'s expenses.'**
  String insightMonthlyDays(String days);

  /// No description provided for @msgShort1.
  ///
  /// In en, this message translates to:
  /// **'A few hours of work, for a fleeting desire?'**
  String get msgShort1;

  /// No description provided for @msgShort2.
  ///
  /// In en, this message translates to:
  /// **'Easy to spend what you earned in such short time, hard to earn it back.'**
  String get msgShort2;

  /// No description provided for @msgShort3.
  ///
  /// In en, this message translates to:
  /// **'You went to work this morning, this money will be gone before lunch.'**
  String get msgShort3;

  /// No description provided for @msgShort4.
  ///
  /// In en, this message translates to:
  /// **'You earned it in a coffee break, it\'ll be gone with one click.'**
  String get msgShort4;

  /// No description provided for @msgShort5.
  ///
  /// In en, this message translates to:
  /// **'Half a day\'s work, don\'t let it become a full day of regret.'**
  String get msgShort5;

  /// No description provided for @msgShort6.
  ///
  /// In en, this message translates to:
  /// **'Think about the hours you worked for this item.'**
  String get msgShort6;

  /// No description provided for @msgShort7.
  ///
  /// In en, this message translates to:
  /// **'Looks small but makes a big difference in total.'**
  String get msgShort7;

  /// No description provided for @msgShort8.
  ///
  /// In en, this message translates to:
  /// **'If not now, tomorrow works too.'**
  String get msgShort8;

  /// No description provided for @msgMedium1.
  ///
  /// In en, this message translates to:
  /// **'Is your week\'s work worth this item?'**
  String get msgMedium1;

  /// No description provided for @msgMedium2.
  ///
  /// In en, this message translates to:
  /// **'It took days to save this money, seconds to spend it.'**
  String get msgMedium2;

  /// No description provided for @msgMedium3.
  ///
  /// In en, this message translates to:
  /// **'Would you accept if you were investing a week into this?'**
  String get msgMedium3;

  /// No description provided for @msgMedium4.
  ///
  /// In en, this message translates to:
  /// **'Days of effort, a split-second decision.'**
  String get msgMedium4;

  /// No description provided for @msgMedium5.
  ///
  /// In en, this message translates to:
  /// **'A weekend getaway or this item?'**
  String get msgMedium5;

  /// No description provided for @msgMedium6.
  ///
  /// In en, this message translates to:
  /// **'Remember what you worked for all those days.'**
  String get msgMedium6;

  /// No description provided for @msgMedium7.
  ///
  /// In en, this message translates to:
  /// **'Did you work Monday to Friday for this?'**
  String get msgMedium7;

  /// No description provided for @msgMedium8.
  ///
  /// In en, this message translates to:
  /// **'Does it make sense to spend your weekly budget in one go?'**
  String get msgMedium8;

  /// No description provided for @msgLong1.
  ///
  /// In en, this message translates to:
  /// **'You need to work for weeks for this. Is it really worth it?'**
  String get msgLong1;

  /// No description provided for @msgLong2.
  ///
  /// In en, this message translates to:
  /// **'Saving this money could take months.'**
  String get msgLong2;

  /// No description provided for @msgLong3.
  ///
  /// In en, this message translates to:
  /// **'You might be delaying one of your long-term goals.'**
  String get msgLong3;

  /// No description provided for @msgLong4.
  ///
  /// In en, this message translates to:
  /// **'Does the time you\'ll spend on this affect your vacation plans?'**
  String get msgLong4;

  /// No description provided for @msgLong5.
  ///
  /// In en, this message translates to:
  /// **'Is this an investment or an expense?'**
  String get msgLong5;

  /// No description provided for @msgLong6.
  ///
  /// In en, this message translates to:
  /// **'How would future you evaluate this decision?'**
  String get msgLong6;

  /// No description provided for @msgLong7.
  ///
  /// In en, this message translates to:
  /// **'Working this long should be for something lasting.'**
  String get msgLong7;

  /// No description provided for @msgLong8.
  ///
  /// In en, this message translates to:
  /// **'How will you view this decision at month\'s end?'**
  String get msgLong8;

  /// No description provided for @msgSim1.
  ///
  /// In en, this message translates to:
  /// **'This amount isn\'t just spending anymore, it\'s a serious investment decision.'**
  String get msgSim1;

  /// No description provided for @msgSim2.
  ///
  /// In en, this message translates to:
  /// **'For such a large sum, decide with your vision, not your emotions.'**
  String get msgSim2;

  /// No description provided for @msgSim3.
  ///
  /// In en, this message translates to:
  /// **'It\'s hard to even calculate the time equivalent of this amount.'**
  String get msgSim3;

  /// No description provided for @msgSim4.
  ///
  /// In en, this message translates to:
  /// **'Could this be that big step you\'ve been dreaming of?'**
  String get msgSim4;

  /// No description provided for @msgSim5.
  ///
  /// In en, this message translates to:
  /// **'Managing such a large amount requires patience and strategy.'**
  String get msgSim5;

  /// No description provided for @msgSim6.
  ///
  /// In en, this message translates to:
  /// **'You\'re at a point that will affect your future, not just your wallet.'**
  String get msgSim6;

  /// No description provided for @msgSim7.
  ///
  /// In en, this message translates to:
  /// **'Big numbers bring big responsibilities. Are you ready?'**
  String get msgSim7;

  /// No description provided for @msgSim8.
  ///
  /// In en, this message translates to:
  /// **'Is this amount just a number to you, or a turning point?'**
  String get msgSim8;

  /// No description provided for @msgYes1.
  ///
  /// In en, this message translates to:
  /// **'Recorded. Hope it\'s worth it.'**
  String get msgYes1;

  /// No description provided for @msgYes2.
  ///
  /// In en, this message translates to:
  /// **'Let\'s see if you\'ll regret it.'**
  String get msgYes2;

  /// No description provided for @msgYes3.
  ///
  /// In en, this message translates to:
  /// **'Okay, it\'s your money.'**
  String get msgYes3;

  /// No description provided for @msgYes4.
  ///
  /// In en, this message translates to:
  /// **'You bought it, congratulations.'**
  String get msgYes4;

  /// No description provided for @msgYes5.
  ///
  /// In en, this message translates to:
  /// **'As you wish.'**
  String get msgYes5;

  /// No description provided for @msgYes6.
  ///
  /// In en, this message translates to:
  /// **'Alright, it\'s on the record.'**
  String get msgYes6;

  /// No description provided for @msgYes7.
  ///
  /// In en, this message translates to:
  /// **'If it\'s a need, no problem.'**
  String get msgYes7;

  /// No description provided for @msgYes8.
  ///
  /// In en, this message translates to:
  /// **'Sometimes spending is necessary too.'**
  String get msgYes8;

  /// No description provided for @msgNo1.
  ///
  /// In en, this message translates to:
  /// **'Great decision. You saved this money.'**
  String get msgNo1;

  /// No description provided for @msgNo2.
  ///
  /// In en, this message translates to:
  /// **'You chose the hard path, your future self will thank you.'**
  String get msgNo2;

  /// No description provided for @msgNo3.
  ///
  /// In en, this message translates to:
  /// **'Willpower won.'**
  String get msgNo3;

  /// No description provided for @msgNo4.
  ///
  /// In en, this message translates to:
  /// **'Smart move. You\'ll need this money.'**
  String get msgNo4;

  /// No description provided for @msgNo5.
  ///
  /// In en, this message translates to:
  /// **'Passing is also a win.'**
  String get msgNo5;

  /// No description provided for @msgNo6.
  ///
  /// In en, this message translates to:
  /// **'The urge passed, the money stayed.'**
  String get msgNo6;

  /// No description provided for @msgNo7.
  ///
  /// In en, this message translates to:
  /// **'You actually invested in yourself.'**
  String get msgNo7;

  /// No description provided for @msgNo8.
  ///
  /// In en, this message translates to:
  /// **'Hard decision, right decision.'**
  String get msgNo8;

  /// No description provided for @msgThink1.
  ///
  /// In en, this message translates to:
  /// **'Thinking is free, spending isn\'t.'**
  String get msgThink1;

  /// No description provided for @msgThink2.
  ///
  /// In en, this message translates to:
  /// **'Not rushing is smart.'**
  String get msgThink2;

  /// No description provided for @msgThink3.
  ///
  /// In en, this message translates to:
  /// **'Sleep on it, look again tomorrow.'**
  String get msgThink3;

  /// No description provided for @msgThink4.
  ///
  /// In en, this message translates to:
  /// **'Wait 24 hours, come back if you still want it.'**
  String get msgThink4;

  /// No description provided for @msgThink5.
  ///
  /// In en, this message translates to:
  /// **'If you\'re hesitating, it\'s probably not necessary.'**
  String get msgThink5;

  /// No description provided for @msgThink6.
  ///
  /// In en, this message translates to:
  /// **'Time is the best advisor.'**
  String get msgThink6;

  /// No description provided for @msgThink7.
  ///
  /// In en, this message translates to:
  /// **'If it\'s not urgent, don\'t rush.'**
  String get msgThink7;

  /// No description provided for @msgThink8.
  ///
  /// In en, this message translates to:
  /// **'If you\'re not sure, the answer is probably no.'**
  String get msgThink8;

  /// No description provided for @savingMsg1.
  ///
  /// In en, this message translates to:
  /// **'Great decision! 💪'**
  String get savingMsg1;

  /// No description provided for @savingMsg2.
  ///
  /// In en, this message translates to:
  /// **'You protected your money! 🛡️'**
  String get savingMsg2;

  /// No description provided for @savingMsg3.
  ///
  /// In en, this message translates to:
  /// **'Future you will thank you!'**
  String get savingMsg3;

  /// No description provided for @savingMsg4.
  ///
  /// In en, this message translates to:
  /// **'Smart choice! 🧠'**
  String get savingMsg4;

  /// No description provided for @savingMsg5.
  ///
  /// In en, this message translates to:
  /// **'Saving is power!'**
  String get savingMsg5;

  /// No description provided for @savingMsg6.
  ///
  /// In en, this message translates to:
  /// **'One step closer to your goal!'**
  String get savingMsg6;

  /// No description provided for @savingMsg7.
  ///
  /// In en, this message translates to:
  /// **'Willpower! 💎'**
  String get savingMsg7;

  /// No description provided for @savingMsg8.
  ///
  /// In en, this message translates to:
  /// **'This money is now yours!'**
  String get savingMsg8;

  /// No description provided for @savingMsg9.
  ///
  /// In en, this message translates to:
  /// **'Financial discipline! 🎯'**
  String get savingMsg9;

  /// No description provided for @savingMsg10.
  ///
  /// In en, this message translates to:
  /// **'You\'re building wealth!'**
  String get savingMsg10;

  /// No description provided for @savingMsg11.
  ///
  /// In en, this message translates to:
  /// **'Strong decision! 💪'**
  String get savingMsg11;

  /// No description provided for @savingMsg12.
  ///
  /// In en, this message translates to:
  /// **'Your wallet thanks you!'**
  String get savingMsg12;

  /// No description provided for @savingMsg13.
  ///
  /// In en, this message translates to:
  /// **'That\'s how champions save! 🏆'**
  String get savingMsg13;

  /// No description provided for @savingMsg14.
  ///
  /// In en, this message translates to:
  /// **'Money saved = Freedom earned!'**
  String get savingMsg14;

  /// No description provided for @savingMsg15.
  ///
  /// In en, this message translates to:
  /// **'Impressive self-control! ⭐'**
  String get savingMsg15;

  /// No description provided for @spendingMsg1.
  ///
  /// In en, this message translates to:
  /// **'Recorded! ✓'**
  String get spendingMsg1;

  /// No description provided for @spendingMsg2.
  ///
  /// In en, this message translates to:
  /// **'You\'re tracking, that\'s important.'**
  String get spendingMsg2;

  /// No description provided for @spendingMsg3.
  ///
  /// In en, this message translates to:
  /// **'Every record is awareness.'**
  String get spendingMsg3;

  /// No description provided for @spendingMsg4.
  ///
  /// In en, this message translates to:
  /// **'Knowing your spending is power.'**
  String get spendingMsg4;

  /// No description provided for @spendingMsg5.
  ///
  /// In en, this message translates to:
  /// **'Logged! Keep going.'**
  String get spendingMsg5;

  /// No description provided for @spendingMsg6.
  ///
  /// In en, this message translates to:
  /// **'Tracking builds control.'**
  String get spendingMsg6;

  /// No description provided for @spendingMsg7.
  ///
  /// In en, this message translates to:
  /// **'Noted! Awareness is key.'**
  String get spendingMsg7;

  /// No description provided for @spendingMsg8.
  ///
  /// In en, this message translates to:
  /// **'Good job tracking!'**
  String get spendingMsg8;

  /// No description provided for @spendingMsg9.
  ///
  /// In en, this message translates to:
  /// **'Data is power! 📊'**
  String get spendingMsg9;

  /// No description provided for @spendingMsg10.
  ///
  /// In en, this message translates to:
  /// **'Stay aware, stay in control.'**
  String get spendingMsg10;

  /// No description provided for @tourAmountTitle.
  ///
  /// In en, this message translates to:
  /// **'Amount Entry'**
  String get tourAmountTitle;

  /// No description provided for @tourAmountDesc.
  ///
  /// In en, this message translates to:
  /// **'Enter the expense amount here. You can automatically scan it from a receipt using the scan button.'**
  String get tourAmountDesc;

  /// No description provided for @tourDescriptionTitle.
  ///
  /// In en, this message translates to:
  /// **'Smart Matching'**
  String get tourDescriptionTitle;

  /// No description provided for @tourDescriptionDesc.
  ///
  /// In en, this message translates to:
  /// **'Enter the store or product name. Like Migros, A101, Starbucks... The app will automatically suggest a category!'**
  String get tourDescriptionDesc;

  /// No description provided for @tourCategoryTitle.
  ///
  /// In en, this message translates to:
  /// **'Category Selection'**
  String get tourCategoryTitle;

  /// No description provided for @tourCategoryDesc.
  ///
  /// In en, this message translates to:
  /// **'If smart matching doesn\'t find it or you want to change it, you can manually select from here.'**
  String get tourCategoryDesc;

  /// No description provided for @tourDateTitle.
  ///
  /// In en, this message translates to:
  /// **'Past Date Selection'**
  String get tourDateTitle;

  /// No description provided for @tourDateDesc.
  ///
  /// In en, this message translates to:
  /// **'You can also enter expenses from yesterday or previous days. Click the calendar icon to select any date.'**
  String get tourDateDesc;

  /// No description provided for @tourSnapshotTitle.
  ///
  /// In en, this message translates to:
  /// **'Financial Summary'**
  String get tourSnapshotTitle;

  /// No description provided for @tourSnapshotDesc.
  ///
  /// In en, this message translates to:
  /// **'Your monthly income, expenses, and saved money are here. All data updates in real-time.'**
  String get tourSnapshotDesc;

  /// No description provided for @tourCurrencyTitle.
  ///
  /// In en, this message translates to:
  /// **'Exchange Rates'**
  String get tourCurrencyTitle;

  /// No description provided for @tourCurrencyDesc.
  ///
  /// In en, this message translates to:
  /// **'Current USD, EUR, and gold prices. Tap for detailed information.'**
  String get tourCurrencyDesc;

  /// No description provided for @tourStreakTitle.
  ///
  /// In en, this message translates to:
  /// **'Streak Tracking'**
  String get tourStreakTitle;

  /// No description provided for @tourStreakDesc.
  ///
  /// In en, this message translates to:
  /// **'Your streak increases every day you record an expense. Regular tracking is the key to mindful spending!'**
  String get tourStreakDesc;

  /// No description provided for @tourSubscriptionTitle.
  ///
  /// In en, this message translates to:
  /// **'Subscriptions'**
  String get tourSubscriptionTitle;

  /// No description provided for @tourSubscriptionDesc.
  ///
  /// In en, this message translates to:
  /// **'Track your regular subscriptions like Netflix, Spotify here. You\'ll get notifications for upcoming payments.'**
  String get tourSubscriptionDesc;

  /// No description provided for @tourReportTitle.
  ///
  /// In en, this message translates to:
  /// **'Reports'**
  String get tourReportTitle;

  /// No description provided for @tourReportDesc.
  ///
  /// In en, this message translates to:
  /// **'View monthly and category-based spending analysis here.'**
  String get tourReportDesc;

  /// No description provided for @tourAchievementsTitle.
  ///
  /// In en, this message translates to:
  /// **'Badges'**
  String get tourAchievementsTitle;

  /// No description provided for @tourAchievementsDesc.
  ///
  /// In en, this message translates to:
  /// **'Earn badges as you reach savings goals. Keep your motivation high!'**
  String get tourAchievementsDesc;

  /// No description provided for @tourProfileTitle.
  ///
  /// In en, this message translates to:
  /// **'Profile & Settings'**
  String get tourProfileTitle;

  /// No description provided for @tourProfileDesc.
  ///
  /// In en, this message translates to:
  /// **'Edit income info, manage notification preferences, and access app settings.'**
  String get tourProfileDesc;

  /// No description provided for @tourQuickAddTitle.
  ///
  /// In en, this message translates to:
  /// **'Quick Add'**
  String get tourQuickAddTitle;

  /// No description provided for @tourQuickAddDesc.
  ///
  /// In en, this message translates to:
  /// **'Use this button to quickly add expenses from anywhere. Practical and fast!'**
  String get tourQuickAddDesc;

  /// No description provided for @notifChannelName.
  ///
  /// In en, this message translates to:
  /// **'Vantag Notifications'**
  String get notifChannelName;

  /// No description provided for @notifChannelDescription.
  ///
  /// In en, this message translates to:
  /// **'Financial tracking notifications'**
  String get notifChannelDescription;

  /// No description provided for @notifTitleThinkAboutIt.
  ///
  /// In en, this message translates to:
  /// **'Think about it'**
  String get notifTitleThinkAboutIt;

  /// No description provided for @notifTitleCongratulations.
  ///
  /// In en, this message translates to:
  /// **'Congratulations'**
  String get notifTitleCongratulations;

  /// No description provided for @notifTitleStreakWaiting.
  ///
  /// In en, this message translates to:
  /// **'Your streak is waiting'**
  String get notifTitleStreakWaiting;

  /// No description provided for @notifTitleWeeklySummary.
  ///
  /// In en, this message translates to:
  /// **'Weekly summary'**
  String get notifTitleWeeklySummary;

  /// No description provided for @notifTitleSubscriptionReminder.
  ///
  /// In en, this message translates to:
  /// **'Subscription reminder'**
  String get notifTitleSubscriptionReminder;

  /// No description provided for @aiGreeting.
  ///
  /// In en, this message translates to:
  /// **'Hello! I\'m Vantag.\nReady to answer your financial questions.'**
  String get aiGreeting;

  /// No description provided for @aiServiceUnavailable.
  ///
  /// In en, this message translates to:
  /// **'AI assistant is currently unavailable. Please try again later.'**
  String get aiServiceUnavailable;

  /// No description provided for @onboardingHookTitle.
  ///
  /// In en, this message translates to:
  /// **'This coffee is 47 minutes'**
  String get onboardingHookTitle;

  /// No description provided for @onboardingHookSubtitle.
  ///
  /// In en, this message translates to:
  /// **'See the real cost of every purchase'**
  String get onboardingHookSubtitle;

  /// No description provided for @pursuitOnboardingTitle.
  ///
  /// In en, this message translates to:
  /// **'What\'s your goal?'**
  String get pursuitOnboardingTitle;

  /// No description provided for @pursuitOnboardingSubtitle.
  ///
  /// In en, this message translates to:
  /// **'Pick something to save for'**
  String get pursuitOnboardingSubtitle;

  /// No description provided for @pursuitOnboardingAirpods.
  ///
  /// In en, this message translates to:
  /// **'AirPods'**
  String get pursuitOnboardingAirpods;

  /// No description provided for @pursuitOnboardingIphone.
  ///
  /// In en, this message translates to:
  /// **'iPhone'**
  String get pursuitOnboardingIphone;

  /// No description provided for @pursuitOnboardingVacation.
  ///
  /// In en, this message translates to:
  /// **'Vacation'**
  String get pursuitOnboardingVacation;

  /// No description provided for @pursuitOnboardingCustom.
  ///
  /// In en, this message translates to:
  /// **'My own goal'**
  String get pursuitOnboardingCustom;

  /// No description provided for @pursuitOnboardingCta.
  ///
  /// In en, this message translates to:
  /// **'I want this'**
  String get pursuitOnboardingCta;

  /// No description provided for @pursuitOnboardingSkip.
  ///
  /// In en, this message translates to:
  /// **'Skip for now'**
  String get pursuitOnboardingSkip;

  /// No description provided for @pursuitOnboardingHours.
  ///
  /// In en, this message translates to:
  /// **'{hours} hours'**
  String pursuitOnboardingHours(int hours);

  /// No description provided for @celebrationTitle.
  ///
  /// In en, this message translates to:
  /// **'Congratulations!'**
  String get celebrationTitle;

  /// No description provided for @celebrationSubtitle.
  ///
  /// In en, this message translates to:
  /// **'You reached your {goalName} goal!'**
  String celebrationSubtitle(String goalName);

  /// No description provided for @celebrationTotalSaved.
  ///
  /// In en, this message translates to:
  /// **'Total saved: {hours} hours'**
  String celebrationTotalSaved(String hours);

  /// No description provided for @celebrationDuration.
  ///
  /// In en, this message translates to:
  /// **'Duration: {days} days'**
  String celebrationDuration(int days);

  /// No description provided for @celebrationShare.
  ///
  /// In en, this message translates to:
  /// **'Share'**
  String get celebrationShare;

  /// No description provided for @celebrationNewGoal.
  ///
  /// In en, this message translates to:
  /// **'New Goal'**
  String get celebrationNewGoal;

  /// No description provided for @celebrationDismiss.
  ///
  /// In en, this message translates to:
  /// **'Close'**
  String get celebrationDismiss;

  /// No description provided for @widgetTodayLabel.
  ///
  /// In en, this message translates to:
  /// **'Today'**
  String get widgetTodayLabel;

  /// No description provided for @widgetHoursAbbrev.
  ///
  /// In en, this message translates to:
  /// **'h'**
  String get widgetHoursAbbrev;

  /// No description provided for @widgetMinutesAbbrev.
  ///
  /// In en, this message translates to:
  /// **'m'**
  String get widgetMinutesAbbrev;

  /// No description provided for @widgetSetGoal.
  ///
  /// In en, this message translates to:
  /// **'Set a goal'**
  String get widgetSetGoal;

  /// No description provided for @widgetNoData.
  ///
  /// In en, this message translates to:
  /// **'Open app to start'**
  String get widgetNoData;

  /// No description provided for @widgetSmallTitle.
  ///
  /// In en, this message translates to:
  /// **'Daily Spending'**
  String get widgetSmallTitle;

  /// No description provided for @widgetSmallDesc.
  ///
  /// In en, this message translates to:
  /// **'See today\'s spending in hours'**
  String get widgetSmallDesc;

  /// No description provided for @widgetMediumTitle.
  ///
  /// In en, this message translates to:
  /// **'Spending + Goal'**
  String get widgetMediumTitle;

  /// No description provided for @widgetMediumDesc.
  ///
  /// In en, this message translates to:
  /// **'Track spending and goal progress'**
  String get widgetMediumDesc;

  /// No description provided for @accessibilityTodaySpending.
  ///
  /// In en, this message translates to:
  /// **'Today you spent {amount}, equal to {hours} hours {minutes} minutes of work'**
  String accessibilityTodaySpending(String amount, int hours, int minutes);

  /// No description provided for @accessibilitySpendingProgress.
  ///
  /// In en, this message translates to:
  /// **'Spending progress: {percentage} percent of budget used'**
  String accessibilitySpendingProgress(int percentage);

  /// No description provided for @accessibilityExpenseItem.
  ///
  /// In en, this message translates to:
  /// **'{category} expense of {amount}, took {hours} hours, status: {decision}'**
  String accessibilityExpenseItem(
    String category,
    String amount,
    String hours,
    String decision,
  );

  /// No description provided for @accessibilityPursuitCard.
  ///
  /// In en, this message translates to:
  /// **'{name} goal, {saved} of {target} saved, {percentage} percent complete'**
  String accessibilityPursuitCard(
    String name,
    String saved,
    String target,
    int percentage,
  );

  /// No description provided for @accessibilityAddExpense.
  ///
  /// In en, this message translates to:
  /// **'Add new expense'**
  String get accessibilityAddExpense;

  /// No description provided for @accessibilityDecisionYes.
  ///
  /// In en, this message translates to:
  /// **'Purchased'**
  String get accessibilityDecisionYes;

  /// No description provided for @accessibilityDecisionNo.
  ///
  /// In en, this message translates to:
  /// **'Passed'**
  String get accessibilityDecisionNo;

  /// No description provided for @accessibilityDecisionThinking.
  ///
  /// In en, this message translates to:
  /// **'Thinking'**
  String get accessibilityDecisionThinking;

  /// No description provided for @accessibilityDashboard.
  ///
  /// In en, this message translates to:
  /// **'Financial dashboard showing income, expenses and balance'**
  String get accessibilityDashboard;

  /// No description provided for @accessibilityNetBalance.
  ///
  /// In en, this message translates to:
  /// **'Net balance: {amount}, {status}'**
  String accessibilityNetBalance(String amount, String status);

  /// No description provided for @accessibilityBalanceHealthy.
  ///
  /// In en, this message translates to:
  /// **'in the green'**
  String get accessibilityBalanceHealthy;

  /// No description provided for @accessibilityBalanceNegative.
  ///
  /// In en, this message translates to:
  /// **'in the red'**
  String get accessibilityBalanceNegative;

  /// No description provided for @accessibilityIncomeTotal.
  ///
  /// In en, this message translates to:
  /// **'Total income: {amount}'**
  String accessibilityIncomeTotal(String amount);

  /// No description provided for @accessibilityExpenseTotal.
  ///
  /// In en, this message translates to:
  /// **'Total expenses: {amount}'**
  String accessibilityExpenseTotal(String amount);

  /// No description provided for @accessibilityAddSavings.
  ///
  /// In en, this message translates to:
  /// **'Add savings to this goal'**
  String get accessibilityAddSavings;

  /// No description provided for @accessibilityDeleteExpense.
  ///
  /// In en, this message translates to:
  /// **'Delete this expense'**
  String get accessibilityDeleteExpense;

  /// No description provided for @accessibilityEditExpense.
  ///
  /// In en, this message translates to:
  /// **'Edit this expense'**
  String get accessibilityEditExpense;

  /// No description provided for @accessibilityShareExpense.
  ///
  /// In en, this message translates to:
  /// **'Share this expense'**
  String get accessibilityShareExpense;

  /// No description provided for @accessibilityStreakInfo.
  ///
  /// In en, this message translates to:
  /// **'Current streak: {days} days, best streak: {best} days'**
  String accessibilityStreakInfo(int days, int best);

  /// No description provided for @accessibilityAiChatInput.
  ///
  /// In en, this message translates to:
  /// **'Type your financial question here'**
  String get accessibilityAiChatInput;

  /// No description provided for @accessibilityAiSendButton.
  ///
  /// In en, this message translates to:
  /// **'Send message to AI assistant'**
  String get accessibilityAiSendButton;

  /// No description provided for @accessibilitySuggestionButton.
  ///
  /// In en, this message translates to:
  /// **'Quick question: {question}'**
  String accessibilitySuggestionButton(String question);

  /// No description provided for @accessibilitySubscriptionCard.
  ///
  /// In en, this message translates to:
  /// **'{name} subscription, {amount} per {cycle}, renews on day {day}'**
  String accessibilitySubscriptionCard(
    String name,
    String amount,
    String cycle,
    int day,
  );

  /// No description provided for @accessibilitySettingsItem.
  ///
  /// In en, this message translates to:
  /// **'{title}, current value: {value}'**
  String accessibilitySettingsItem(String title, String value);

  /// No description provided for @accessibilityToggleOn.
  ///
  /// In en, this message translates to:
  /// **'Enabled'**
  String get accessibilityToggleOn;

  /// No description provided for @accessibilityToggleOff.
  ///
  /// In en, this message translates to:
  /// **'Disabled'**
  String get accessibilityToggleOff;

  /// No description provided for @accessibilityCloseSheet.
  ///
  /// In en, this message translates to:
  /// **'Close this sheet'**
  String get accessibilityCloseSheet;

  /// No description provided for @accessibilityBackButton.
  ///
  /// In en, this message translates to:
  /// **'Go back'**
  String get accessibilityBackButton;

  /// No description provided for @accessibilityProfileButton.
  ///
  /// In en, this message translates to:
  /// **'Open profile menu'**
  String get accessibilityProfileButton;

  /// No description provided for @accessibilityNotificationsButton.
  ///
  /// In en, this message translates to:
  /// **'View notifications'**
  String get accessibilityNotificationsButton;

  /// No description provided for @navHomeTooltip.
  ///
  /// In en, this message translates to:
  /// **'Home, spending overview'**
  String get navHomeTooltip;

  /// No description provided for @navPursuitsTooltip.
  ///
  /// In en, this message translates to:
  /// **'Goals, savings targets'**
  String get navPursuitsTooltip;

  /// No description provided for @navReportsTooltip.
  ///
  /// In en, this message translates to:
  /// **'Reports, spending analysis'**
  String get navReportsTooltip;

  /// No description provided for @navSettingsTooltip.
  ///
  /// In en, this message translates to:
  /// **'Settings and preferences'**
  String get navSettingsTooltip;

  /// No description provided for @shareDefaultMessage.
  ///
  /// In en, this message translates to:
  /// **'I track my expenses in hours! Try it: {link}'**
  String shareDefaultMessage(String link);

  /// No description provided for @shareInviteLink.
  ///
  /// In en, this message translates to:
  /// **'Share Invite Link'**
  String get shareInviteLink;

  /// No description provided for @inviteFriends.
  ///
  /// In en, this message translates to:
  /// **'Invite Friends'**
  String get inviteFriends;

  /// No description provided for @yourReferralCode.
  ///
  /// In en, this message translates to:
  /// **'Your referral code'**
  String get yourReferralCode;

  /// No description provided for @referralStats.
  ///
  /// In en, this message translates to:
  /// **'{count} friends joined'**
  String referralStats(int count);

  /// No description provided for @referralRewardInfo.
  ///
  /// In en, this message translates to:
  /// **'Earn 7 days premium for each friend!'**
  String get referralRewardInfo;

  /// No description provided for @codeCopied.
  ///
  /// In en, this message translates to:
  /// **'Code copied!'**
  String get codeCopied;

  /// No description provided for @haveReferralCode.
  ///
  /// In en, this message translates to:
  /// **'Have a referral code?'**
  String get haveReferralCode;

  /// No description provided for @referralCodeHint.
  ///
  /// In en, this message translates to:
  /// **'Enter code (optional)'**
  String get referralCodeHint;

  /// No description provided for @referralCodePlaceholder.
  ///
  /// In en, this message translates to:
  /// **'VANTAG-XXXXX'**
  String get referralCodePlaceholder;

  /// No description provided for @referralSuccess.
  ///
  /// In en, this message translates to:
  /// **'{name} joined Vantag! +7 days premium'**
  String referralSuccess(String name);

  /// No description provided for @welcomeReferred.
  ///
  /// In en, this message translates to:
  /// **'Welcome! You have 7 days premium trial'**
  String get welcomeReferred;

  /// No description provided for @referralInvalidCode.
  ///
  /// In en, this message translates to:
  /// **'Invalid referral code'**
  String get referralInvalidCode;

  /// No description provided for @referralCodeApplied.
  ///
  /// In en, this message translates to:
  /// **'Referral code applied!'**
  String get referralCodeApplied;

  /// No description provided for @referralSectionTitle.
  ///
  /// In en, this message translates to:
  /// **'Referrals'**
  String get referralSectionTitle;

  /// No description provided for @referralShareDescription.
  ///
  /// In en, this message translates to:
  /// **'Share your code and earn premium days'**
  String get referralShareDescription;

  /// No description provided for @trialMidpointTitle.
  ///
  /// In en, this message translates to:
  /// **'Halfway there! ⏳'**
  String get trialMidpointTitle;

  /// No description provided for @trialMidpointBody.
  ///
  /// In en, this message translates to:
  /// **'Your trial is halfway done. You\'ve saved {hours} hours so far!'**
  String trialMidpointBody(String hours);

  /// No description provided for @trialOneDayLeftTitle.
  ///
  /// In en, this message translates to:
  /// **'Trial ends tomorrow ⏰'**
  String get trialOneDayLeftTitle;

  /// No description provided for @trialOneDayLeftBody.
  ///
  /// In en, this message translates to:
  /// **'Go premium to keep tracking your savings!'**
  String get trialOneDayLeftBody;

  /// No description provided for @trialEndsTodayTitle.
  ///
  /// In en, this message translates to:
  /// **'Last day of trial! 🎁'**
  String get trialEndsTodayTitle;

  /// No description provided for @trialEndsTodayBody.
  ///
  /// In en, this message translates to:
  /// **'Get 50% off if you upgrade today!'**
  String get trialEndsTodayBody;

  /// No description provided for @trialExpiredTitle.
  ///
  /// In en, this message translates to:
  /// **'We miss you! 💜'**
  String get trialExpiredTitle;

  /// No description provided for @trialExpiredBody.
  ///
  /// In en, this message translates to:
  /// **'Come back and continue reaching your goals'**
  String get trialExpiredBody;

  /// No description provided for @dailyReminderTitle.
  ///
  /// In en, this message translates to:
  /// **'Don\'t forget to log! 📝'**
  String get dailyReminderTitle;

  /// No description provided for @dailyReminderBody.
  ///
  /// In en, this message translates to:
  /// **'Track today\'s spending in just seconds'**
  String get dailyReminderBody;

  /// No description provided for @notificationSettingsDesc.
  ///
  /// In en, this message translates to:
  /// **'Reminders and updates'**
  String get notificationSettingsDesc;

  /// No description provided for @firstExpenseTitle.
  ///
  /// In en, this message translates to:
  /// **'Great start! 🎉'**
  String get firstExpenseTitle;

  /// No description provided for @firstExpenseBody.
  ///
  /// In en, this message translates to:
  /// **'You saved {hours} hours today!'**
  String firstExpenseBody(String hours);

  /// No description provided for @trialReminderEnabled.
  ///
  /// In en, this message translates to:
  /// **'Trial reminders'**
  String get trialReminderEnabled;

  /// No description provided for @trialReminderDesc.
  ///
  /// In en, this message translates to:
  /// **'Get notified before your trial ends'**
  String get trialReminderDesc;

  /// No description provided for @dailyReminderEnabled.
  ///
  /// In en, this message translates to:
  /// **'Daily reminders'**
  String get dailyReminderEnabled;

  /// No description provided for @dailyReminderDesc.
  ///
  /// In en, this message translates to:
  /// **'Evening reminder to log expenses'**
  String get dailyReminderDesc;

  /// No description provided for @dailyReminderTime.
  ///
  /// In en, this message translates to:
  /// **'Reminder time'**
  String get dailyReminderTime;

  /// No description provided for @trialDaysRemaining.
  ///
  /// In en, this message translates to:
  /// **'{days} days left in trial'**
  String trialDaysRemaining(int days);

  /// No description provided for @subscriptionReminder.
  ///
  /// In en, this message translates to:
  /// **'Subscription reminders'**
  String get subscriptionReminder;

  /// No description provided for @subscriptionReminderDesc.
  ///
  /// In en, this message translates to:
  /// **'Get notified before subscriptions renew'**
  String get subscriptionReminderDesc;

  /// No description provided for @thinkingReminder.
  ///
  /// In en, this message translates to:
  /// **'\"Thinking\" reminders'**
  String get thinkingReminder;

  /// No description provided for @thinkingReminderDesc.
  ///
  /// In en, this message translates to:
  /// **'Get reminded after 72 hours about items you\'re still thinking about'**
  String get thinkingReminderDesc;

  /// No description provided for @thinkingReminderTitle.
  ///
  /// In en, this message translates to:
  /// **'Still thinking?'**
  String get thinkingReminderTitle;

  /// No description provided for @thinkingReminderBody.
  ///
  /// In en, this message translates to:
  /// **'Did you decide? {item}'**
  String thinkingReminderBody(String item);

  /// No description provided for @willRemindIn72h.
  ///
  /// In en, this message translates to:
  /// **'We\'ll remind you in 72 hours'**
  String get willRemindIn72h;

  /// No description provided for @thinkingAbout.
  ///
  /// In en, this message translates to:
  /// **'Thinking about'**
  String get thinkingAbout;

  /// No description provided for @addedDaysAgo.
  ///
  /// In en, this message translates to:
  /// **'Added {days} days ago'**
  String addedDaysAgo(int days);

  /// No description provided for @stillThinking.
  ///
  /// In en, this message translates to:
  /// **'Still thinking?'**
  String get stillThinking;

  /// No description provided for @stillThinkingMessage.
  ///
  /// In en, this message translates to:
  /// **'It\'s been 72 hours. Did you decide?'**
  String get stillThinkingMessage;

  /// No description provided for @decidedYes.
  ///
  /// In en, this message translates to:
  /// **'I bought it'**
  String get decidedYes;

  /// No description provided for @decidedNo.
  ///
  /// In en, this message translates to:
  /// **'I passed'**
  String get decidedNo;

  /// No description provided for @aiChatLimitReached.
  ///
  /// In en, this message translates to:
  /// **'You\'ve used your 4 daily AI chats. Go premium for unlimited!'**
  String get aiChatLimitReached;

  /// No description provided for @aiChatsRemaining.
  ///
  /// In en, this message translates to:
  /// **'{count} chats left today'**
  String aiChatsRemaining(int count);

  /// No description provided for @pursuitLimitReachedFree.
  ///
  /// In en, this message translates to:
  /// **'Free accounts can have 1 active goal. Go premium for unlimited goals!'**
  String get pursuitLimitReachedFree;

  /// No description provided for @pursuitNameRequired.
  ///
  /// In en, this message translates to:
  /// **'Please enter a name'**
  String get pursuitNameRequired;

  /// No description provided for @pursuitAmountRequired.
  ///
  /// In en, this message translates to:
  /// **'Please enter an amount'**
  String get pursuitAmountRequired;

  /// No description provided for @pursuitAmountInvalid.
  ///
  /// In en, this message translates to:
  /// **'Please enter a valid amount'**
  String get pursuitAmountInvalid;

  /// No description provided for @exportPremiumOnly.
  ///
  /// In en, this message translates to:
  /// **'Export is a premium feature'**
  String get exportPremiumOnly;

  /// No description provided for @multiCurrencyPremium.
  ///
  /// In en, this message translates to:
  /// **'Multiple currencies is a premium feature. Free users can only use TRY.'**
  String get multiCurrencyPremium;

  /// No description provided for @reportsPremiumOnly.
  ///
  /// In en, this message translates to:
  /// **'Monthly and yearly reports are premium features'**
  String get reportsPremiumOnly;

  /// No description provided for @upgradeToPremium.
  ///
  /// In en, this message translates to:
  /// **'Upgrade to Premium'**
  String get upgradeToPremium;

  /// No description provided for @premiumIncludes.
  ///
  /// In en, this message translates to:
  /// **'Premium includes:'**
  String get premiumIncludes;

  /// No description provided for @unlimitedAiChat.
  ///
  /// In en, this message translates to:
  /// **'Unlimited AI chat'**
  String get unlimitedAiChat;

  /// No description provided for @unlimitedPursuits.
  ///
  /// In en, this message translates to:
  /// **'Unlimited goals'**
  String get unlimitedPursuits;

  /// No description provided for @exportFeature.
  ///
  /// In en, this message translates to:
  /// **'Export your data'**
  String get exportFeature;

  /// No description provided for @allCurrencies.
  ///
  /// In en, this message translates to:
  /// **'All currencies'**
  String get allCurrencies;

  /// No description provided for @fullReports.
  ///
  /// In en, this message translates to:
  /// **'Full reports'**
  String get fullReports;

  /// No description provided for @cleanShareCards.
  ///
  /// In en, this message translates to:
  /// **'Clean share cards (no watermark)'**
  String get cleanShareCards;

  /// No description provided for @maybeLater.
  ///
  /// In en, this message translates to:
  /// **'Maybe later'**
  String get maybeLater;

  /// No description provided for @seePremium.
  ///
  /// In en, this message translates to:
  /// **'See Premium'**
  String get seePremium;

  /// No description provided for @weeklyOnly.
  ///
  /// In en, this message translates to:
  /// **'Weekly'**
  String get weeklyOnly;

  /// No description provided for @monthlyPro.
  ///
  /// In en, this message translates to:
  /// **'Monthly (Pro)'**
  String get monthlyPro;

  /// No description provided for @yearlyPro.
  ///
  /// In en, this message translates to:
  /// **'Yearly (Pro)'**
  String get yearlyPro;

  /// No description provided for @currencyLocked.
  ///
  /// In en, this message translates to:
  /// **'Premium only'**
  String get currencyLocked;

  /// No description provided for @freeUserCurrencyNote.
  ///
  /// In en, this message translates to:
  /// **'Free users can only use TRY. Upgrade to use {currency}.'**
  String freeUserCurrencyNote(String currency);

  /// No description provided for @watermarkText.
  ///
  /// In en, this message translates to:
  /// **'vantag.app'**
  String get watermarkText;

  /// No description provided for @incomeTypeSalary.
  ///
  /// In en, this message translates to:
  /// **'Salary'**
  String get incomeTypeSalary;

  /// No description provided for @incomeTypeBonus.
  ///
  /// In en, this message translates to:
  /// **'Bonus'**
  String get incomeTypeBonus;

  /// No description provided for @incomeTypeGift.
  ///
  /// In en, this message translates to:
  /// **'Gift'**
  String get incomeTypeGift;

  /// No description provided for @incomeTypeRefund.
  ///
  /// In en, this message translates to:
  /// **'Refund'**
  String get incomeTypeRefund;

  /// No description provided for @incomeTypeFreelance.
  ///
  /// In en, this message translates to:
  /// **'Freelance'**
  String get incomeTypeFreelance;

  /// No description provided for @incomeTypeRental.
  ///
  /// In en, this message translates to:
  /// **'Rental'**
  String get incomeTypeRental;

  /// No description provided for @incomeTypeInvestment.
  ///
  /// In en, this message translates to:
  /// **'Investment'**
  String get incomeTypeInvestment;

  /// No description provided for @incomeTypeOther.
  ///
  /// In en, this message translates to:
  /// **'Other Income'**
  String get incomeTypeOther;

  /// No description provided for @salaryDay.
  ///
  /// In en, this message translates to:
  /// **'Salary Day'**
  String get salaryDay;

  /// No description provided for @salaryDayTitle.
  ///
  /// In en, this message translates to:
  /// **'When do you get paid?'**
  String get salaryDayTitle;

  /// No description provided for @salaryDaySubtitle.
  ///
  /// In en, this message translates to:
  /// **'We\'ll remind you on payday'**
  String get salaryDaySubtitle;

  /// No description provided for @salaryDayHint.
  ///
  /// In en, this message translates to:
  /// **'Select day of month (1-31)'**
  String get salaryDayHint;

  /// No description provided for @salaryDaySet.
  ///
  /// In en, this message translates to:
  /// **'Salary day set to {day}'**
  String salaryDaySet(int day);

  /// No description provided for @salaryDaySkip.
  ///
  /// In en, this message translates to:
  /// **'Skip for now'**
  String get salaryDaySkip;

  /// No description provided for @salaryDayNotSet.
  ///
  /// In en, this message translates to:
  /// **'Not set'**
  String get salaryDayNotSet;

  /// No description provided for @currentBalance.
  ///
  /// In en, this message translates to:
  /// **'Current Balance'**
  String get currentBalance;

  /// No description provided for @balanceTitle.
  ///
  /// In en, this message translates to:
  /// **'What\'s your current balance?'**
  String get balanceTitle;

  /// No description provided for @balanceSubtitle.
  ///
  /// In en, this message translates to:
  /// **'Track your spending more accurately'**
  String get balanceSubtitle;

  /// No description provided for @balanceHint.
  ///
  /// In en, this message translates to:
  /// **'Enter your bank balance'**
  String get balanceHint;

  /// No description provided for @balanceUpdated.
  ///
  /// In en, this message translates to:
  /// **'Balance updated'**
  String get balanceUpdated;

  /// No description provided for @balanceOptional.
  ///
  /// In en, this message translates to:
  /// **'Optional - you can add this later'**
  String get balanceOptional;

  /// No description provided for @paydayTitle.
  ///
  /// In en, this message translates to:
  /// **'Payday!'**
  String get paydayTitle;

  /// No description provided for @paydayMessage.
  ///
  /// In en, this message translates to:
  /// **'Did you receive your salary?'**
  String get paydayMessage;

  /// No description provided for @paydayConfirm.
  ///
  /// In en, this message translates to:
  /// **'Yes, received!'**
  String get paydayConfirm;

  /// No description provided for @paydayNotYet.
  ///
  /// In en, this message translates to:
  /// **'Not yet'**
  String get paydayNotYet;

  /// No description provided for @paydaySkip.
  ///
  /// In en, this message translates to:
  /// **'Skip'**
  String get paydaySkip;

  /// No description provided for @paydayCelebration.
  ///
  /// In en, this message translates to:
  /// **'Congratulations! Salary received'**
  String get paydayCelebration;

  /// No description provided for @paydayUpdateBalance.
  ///
  /// In en, this message translates to:
  /// **'Update your balance'**
  String get paydayUpdateBalance;

  /// No description provided for @paydayNewBalance.
  ///
  /// In en, this message translates to:
  /// **'New balance after salary'**
  String get paydayNewBalance;

  /// No description provided for @daysUntilPayday.
  ///
  /// In en, this message translates to:
  /// **'{days} days until payday'**
  String daysUntilPayday(int days);

  /// No description provided for @paydayToday.
  ///
  /// In en, this message translates to:
  /// **'Payday is today!'**
  String get paydayToday;

  /// No description provided for @paydayTomorrow.
  ///
  /// In en, this message translates to:
  /// **'Payday is tomorrow'**
  String get paydayTomorrow;

  /// No description provided for @addIncomeTitle.
  ///
  /// In en, this message translates to:
  /// **'Record Income'**
  String get addIncomeTitle;

  /// No description provided for @addIncomeSubtitle.
  ///
  /// In en, this message translates to:
  /// **'Bonus, gift, refund, etc.'**
  String get addIncomeSubtitle;

  /// No description provided for @incomeAmount.
  ///
  /// In en, this message translates to:
  /// **'Amount received'**
  String get incomeAmount;

  /// No description provided for @incomeNotes.
  ///
  /// In en, this message translates to:
  /// **'Notes (optional)'**
  String get incomeNotes;

  /// No description provided for @incomeNotesHint.
  ///
  /// In en, this message translates to:
  /// **'e.g. Year-end bonus, birthday gift...'**
  String get incomeNotesHint;

  /// No description provided for @incomeAdded.
  ///
  /// In en, this message translates to:
  /// **'Income added!'**
  String get incomeAdded;

  /// No description provided for @incomeAddedBalance.
  ///
  /// In en, this message translates to:
  /// **'Balance updated: {amount}'**
  String incomeAddedBalance(String amount);

  /// No description provided for @thisMonthIncome.
  ///
  /// In en, this message translates to:
  /// **'This Month\'s Income'**
  String get thisMonthIncome;

  /// No description provided for @regularIncome.
  ///
  /// In en, this message translates to:
  /// **'Regular Income'**
  String get regularIncome;

  /// No description provided for @additionalIncome.
  ///
  /// In en, this message translates to:
  /// **'Additional Income'**
  String get additionalIncome;

  /// No description provided for @incomeBreakdown.
  ///
  /// In en, this message translates to:
  /// **'Income Breakdown'**
  String get incomeBreakdown;

  /// No description provided for @paydayNotificationTitle.
  ///
  /// In en, this message translates to:
  /// **'Payday!'**
  String get paydayNotificationTitle;

  /// No description provided for @paydayNotificationBody.
  ///
  /// In en, this message translates to:
  /// **'Your salary should be arriving today. Check your account!'**
  String get paydayNotificationBody;

  /// No description provided for @paydayNotificationEnabled.
  ///
  /// In en, this message translates to:
  /// **'Payday reminders'**
  String get paydayNotificationEnabled;

  /// No description provided for @paydayNotificationDesc.
  ///
  /// In en, this message translates to:
  /// **'Get notified on your salary day'**
  String get paydayNotificationDesc;

  /// No description provided for @onboardingSalaryDayTitle.
  ///
  /// In en, this message translates to:
  /// **'When\'s Payday?'**
  String get onboardingSalaryDayTitle;

  /// No description provided for @onboardingSalaryDayDesc.
  ///
  /// In en, this message translates to:
  /// **'Tell us when you receive your salary so we can help you budget better'**
  String get onboardingSalaryDayDesc;

  /// No description provided for @onboardingBalanceTitle.
  ///
  /// In en, this message translates to:
  /// **'Starting Balance'**
  String get onboardingBalanceTitle;

  /// No description provided for @onboardingBalanceDesc.
  ///
  /// In en, this message translates to:
  /// **'Enter your current balance to track your finances accurately'**
  String get onboardingBalanceDesc;

  /// No description provided for @onboardingV2Step1Title.
  ///
  /// In en, this message translates to:
  /// **'See expenses differently'**
  String get onboardingV2Step1Title;

  /// No description provided for @onboardingV2Step1Subtitle.
  ///
  /// In en, this message translates to:
  /// **'See how many hours each purchase costs you'**
  String get onboardingV2Step1Subtitle;

  /// No description provided for @onboardingV2Step1Demo.
  ///
  /// In en, this message translates to:
  /// **'\$500 phone = 20 hours of work'**
  String get onboardingV2Step1Demo;

  /// No description provided for @onboardingV2Step1Cta.
  ///
  /// In en, this message translates to:
  /// **'Calculate'**
  String get onboardingV2Step1Cta;

  /// No description provided for @onboardingV2Step2Title.
  ///
  /// In en, this message translates to:
  /// **'Let\'s get to know you'**
  String get onboardingV2Step2Title;

  /// No description provided for @onboardingV2Step2Income.
  ///
  /// In en, this message translates to:
  /// **'Monthly income'**
  String get onboardingV2Step2Income;

  /// No description provided for @onboardingV2Step2Hours.
  ///
  /// In en, this message translates to:
  /// **'Daily work hours'**
  String get onboardingV2Step2Hours;

  /// No description provided for @onboardingV2Step2Days.
  ///
  /// In en, this message translates to:
  /// **'Work days per week'**
  String get onboardingV2Step2Days;

  /// No description provided for @onboardingV2Step2Cta.
  ///
  /// In en, this message translates to:
  /// **'Continue'**
  String get onboardingV2Step2Cta;

  /// No description provided for @onboardingV2Step3Title.
  ///
  /// In en, this message translates to:
  /// **'Add your first expense'**
  String get onboardingV2Step3Title;

  /// No description provided for @onboardingV2Step3Subtitle.
  ///
  /// In en, this message translates to:
  /// **'See its value in hours'**
  String get onboardingV2Step3Subtitle;

  /// No description provided for @onboardingV2Step3Result.
  ///
  /// In en, this message translates to:
  /// **'= {hours}h {minutes}m'**
  String onboardingV2Step3Result(int hours, int minutes);

  /// No description provided for @onboardingV2Step3Success.
  ///
  /// In en, this message translates to:
  /// **'Great! Now you\'ll know the true cost of every purchase'**
  String get onboardingV2Step3Success;

  /// No description provided for @onboardingV2Step3Cta.
  ///
  /// In en, this message translates to:
  /// **'Start'**
  String get onboardingV2Step3Cta;

  /// No description provided for @onboardingV2SkipSetup.
  ///
  /// In en, this message translates to:
  /// **'Later'**
  String get onboardingV2SkipSetup;

  /// No description provided for @onboardingV2Progress.
  ///
  /// In en, this message translates to:
  /// **'Step {current}/{total}'**
  String onboardingV2Progress(int current, int total);

  /// No description provided for @checklistTitle.
  ///
  /// In en, this message translates to:
  /// **'Getting Started'**
  String get checklistTitle;

  /// No description provided for @checklistProgress.
  ///
  /// In en, this message translates to:
  /// **'{completed}/{total} completed'**
  String checklistProgress(int completed, int total);

  /// No description provided for @checklistFirstExpenseTitle.
  ///
  /// In en, this message translates to:
  /// **'Add your first expense'**
  String get checklistFirstExpenseTitle;

  /// No description provided for @checklistFirstExpenseSubtitle.
  ///
  /// In en, this message translates to:
  /// **'See its value in hours'**
  String get checklistFirstExpenseSubtitle;

  /// No description provided for @checklistViewReportTitle.
  ///
  /// In en, this message translates to:
  /// **'View your report'**
  String get checklistViewReportTitle;

  /// No description provided for @checklistViewReportSubtitle.
  ///
  /// In en, this message translates to:
  /// **'Discover spending patterns'**
  String get checklistViewReportSubtitle;

  /// No description provided for @checklistCreatePursuitTitle.
  ///
  /// In en, this message translates to:
  /// **'Set a savings goal'**
  String get checklistCreatePursuitTitle;

  /// No description provided for @checklistCreatePursuitSubtitle.
  ///
  /// In en, this message translates to:
  /// **'Start saving for something'**
  String get checklistCreatePursuitSubtitle;

  /// No description provided for @checklistNotificationsTitle.
  ///
  /// In en, this message translates to:
  /// **'Enable notifications'**
  String get checklistNotificationsTitle;

  /// No description provided for @checklistNotificationsSubtitle.
  ///
  /// In en, this message translates to:
  /// **'Get daily reminders'**
  String get checklistNotificationsSubtitle;

  /// No description provided for @checklistCelebrationTitle.
  ///
  /// In en, this message translates to:
  /// **'Great start!'**
  String get checklistCelebrationTitle;

  /// No description provided for @checklistCelebrationSubtitle.
  ///
  /// In en, this message translates to:
  /// **'You\'re ready to use Vantag'**
  String get checklistCelebrationSubtitle;

  /// No description provided for @emptyStateExampleTitle.
  ///
  /// In en, this message translates to:
  /// **'Example'**
  String get emptyStateExampleTitle;

  /// No description provided for @emptyStateExpensesMessage.
  ///
  /// In en, this message translates to:
  /// **'See how many hours each purchase costs you'**
  String get emptyStateExpensesMessage;

  /// No description provided for @emptyStateExpensesCta.
  ///
  /// In en, this message translates to:
  /// **'Add Expense'**
  String get emptyStateExpensesCta;

  /// No description provided for @emptyStatePursuitsMessage.
  ///
  /// In en, this message translates to:
  /// **'Set a goal and track your progress'**
  String get emptyStatePursuitsMessage;

  /// No description provided for @emptyStatePursuitsCta.
  ///
  /// In en, this message translates to:
  /// **'Create Goal'**
  String get emptyStatePursuitsCta;

  /// No description provided for @emptyStateReportsMessage.
  ///
  /// In en, this message translates to:
  /// **'Discover your spending patterns'**
  String get emptyStateReportsMessage;

  /// No description provided for @emptyStateReportsCta.
  ///
  /// In en, this message translates to:
  /// **'Add Expense'**
  String get emptyStateReportsCta;

  /// No description provided for @emptyStateSubscriptionsMessage.
  ///
  /// In en, this message translates to:
  /// **'Track your subscriptions, never forget'**
  String get emptyStateSubscriptionsMessage;

  /// No description provided for @emptyStateSubscriptionsCta.
  ///
  /// In en, this message translates to:
  /// **'Add Subscription'**
  String get emptyStateSubscriptionsCta;

  /// No description provided for @emptyStateAchievementsMessage.
  ///
  /// In en, this message translates to:
  /// **'Add expenses to earn badges'**
  String get emptyStateAchievementsMessage;

  /// No description provided for @emptyStateSavingsPoolMessage.
  ///
  /// In en, this message translates to:
  /// **'Pool your savings together'**
  String get emptyStateSavingsPoolMessage;

  /// No description provided for @milestone3DayStreakTitle.
  ///
  /// In en, this message translates to:
  /// **'3 Day Streak!'**
  String get milestone3DayStreakTitle;

  /// No description provided for @milestone3DayStreakMessage.
  ///
  /// In en, this message translates to:
  /// **'Great start, keep going!'**
  String get milestone3DayStreakMessage;

  /// No description provided for @milestone7DayStreakTitle.
  ///
  /// In en, this message translates to:
  /// **'1 Week Streak!'**
  String get milestone7DayStreakTitle;

  /// No description provided for @milestone7DayStreakMessage.
  ///
  /// In en, this message translates to:
  /// **'A whole week of tracking'**
  String get milestone7DayStreakMessage;

  /// No description provided for @milestone14DayStreakTitle.
  ///
  /// In en, this message translates to:
  /// **'2 Week Streak!'**
  String get milestone14DayStreakTitle;

  /// No description provided for @milestone14DayStreakMessage.
  ///
  /// In en, this message translates to:
  /// **'You\'re building a habit'**
  String get milestone14DayStreakMessage;

  /// No description provided for @milestone30DayStreakTitle.
  ///
  /// In en, this message translates to:
  /// **'1 Month Streak!'**
  String get milestone30DayStreakTitle;

  /// No description provided for @milestone30DayStreakMessage.
  ///
  /// In en, this message translates to:
  /// **'A full month! Incredible'**
  String get milestone30DayStreakMessage;

  /// No description provided for @milestone60DayStreakTitle.
  ///
  /// In en, this message translates to:
  /// **'2 Month Streak!'**
  String get milestone60DayStreakTitle;

  /// No description provided for @milestone60DayStreakMessage.
  ///
  /// In en, this message translates to:
  /// **'You\'re a financial awareness pro'**
  String get milestone60DayStreakMessage;

  /// No description provided for @milestone100DayStreakTitle.
  ///
  /// In en, this message translates to:
  /// **'100 Day Streak!'**
  String get milestone100DayStreakTitle;

  /// No description provided for @milestone100DayStreakMessage.
  ///
  /// In en, this message translates to:
  /// **'Legendary achievement! You\'re a champion'**
  String get milestone100DayStreakMessage;

  /// No description provided for @milestoneFirstSavedTitle.
  ///
  /// In en, this message translates to:
  /// **'First Savings!'**
  String get milestoneFirstSavedTitle;

  /// No description provided for @milestoneFirstSavedMessage.
  ///
  /// In en, this message translates to:
  /// **'You saved your first money'**
  String get milestoneFirstSavedMessage;

  /// No description provided for @milestoneSaved100Title.
  ///
  /// In en, this message translates to:
  /// **'Saved \$100!'**
  String get milestoneSaved100Title;

  /// No description provided for @milestoneSaved100Message.
  ///
  /// In en, this message translates to:
  /// **'Your savings habit is growing'**
  String get milestoneSaved100Message;

  /// No description provided for @milestoneSaved1000Title.
  ///
  /// In en, this message translates to:
  /// **'Saved \$1,000!'**
  String get milestoneSaved1000Title;

  /// No description provided for @milestoneSaved1000Message.
  ///
  /// In en, this message translates to:
  /// **'You\'re saving seriously'**
  String get milestoneSaved1000Message;

  /// No description provided for @milestoneSaved5000Title.
  ///
  /// In en, this message translates to:
  /// **'Saved \$5,000!'**
  String get milestoneSaved5000Title;

  /// No description provided for @milestoneSaved5000Message.
  ///
  /// In en, this message translates to:
  /// **'You\'re a savings master!'**
  String get milestoneSaved5000Message;

  /// No description provided for @milestoneFirstExpenseTitle.
  ///
  /// In en, this message translates to:
  /// **'First Step!'**
  String get milestoneFirstExpenseTitle;

  /// No description provided for @milestoneFirstExpenseMessage.
  ///
  /// In en, this message translates to:
  /// **'You logged your first expense'**
  String get milestoneFirstExpenseMessage;

  /// No description provided for @milestone10ExpensesTitle.
  ///
  /// In en, this message translates to:
  /// **'10 Expenses!'**
  String get milestone10ExpensesTitle;

  /// No description provided for @milestone10ExpensesMessage.
  ///
  /// In en, this message translates to:
  /// **'You have a tracking habit now'**
  String get milestone10ExpensesMessage;

  /// No description provided for @milestone50ExpensesTitle.
  ///
  /// In en, this message translates to:
  /// **'50 Expenses!'**
  String get milestone50ExpensesTitle;

  /// No description provided for @milestone50ExpensesMessage.
  ///
  /// In en, this message translates to:
  /// **'You\'re a financial awareness pro'**
  String get milestone50ExpensesMessage;

  /// No description provided for @milestoneFirstPursuitTitle.
  ///
  /// In en, this message translates to:
  /// **'First Goal!'**
  String get milestoneFirstPursuitTitle;

  /// No description provided for @milestoneFirstPursuitMessage.
  ///
  /// In en, this message translates to:
  /// **'Your savings journey has begun'**
  String get milestoneFirstPursuitMessage;

  /// No description provided for @milestoneFirstPursuitCompletedTitle.
  ///
  /// In en, this message translates to:
  /// **'Goal Completed!'**
  String get milestoneFirstPursuitCompletedTitle;

  /// No description provided for @milestoneFirstPursuitCompletedMessage.
  ///
  /// In en, this message translates to:
  /// **'You reached your first goal!'**
  String get milestoneFirstPursuitCompletedMessage;

  /// No description provided for @milestoneUsedAiChatTitle.
  ///
  /// In en, this message translates to:
  /// **'AI Discovery!'**
  String get milestoneUsedAiChatTitle;

  /// No description provided for @milestoneUsedAiChatMessage.
  ///
  /// In en, this message translates to:
  /// **'You met your financial assistant'**
  String get milestoneUsedAiChatMessage;

  /// No description provided for @selectTimeFilter.
  ///
  /// In en, this message translates to:
  /// **'Select time filter: {filter}'**
  String selectTimeFilter(String filter);

  /// No description provided for @lockedFilterPremium.
  ///
  /// In en, this message translates to:
  /// **'{filter}, premium feature'**
  String lockedFilterPremium(String filter);

  /// No description provided for @selectedFilter.
  ///
  /// In en, this message translates to:
  /// **'{filter}, selected'**
  String selectedFilter(String filter);

  /// No description provided for @selectHeatmapDay.
  ///
  /// In en, this message translates to:
  /// **'Select day: {date}'**
  String selectHeatmapDay(String date);

  /// No description provided for @heatmapDayWithSpending.
  ///
  /// In en, this message translates to:
  /// **'{date}, {amount} spent'**
  String heatmapDayWithSpending(String date, String amount);

  /// No description provided for @heatmapDayNoSpending.
  ///
  /// In en, this message translates to:
  /// **'{date}, no spending'**
  String heatmapDayNoSpending(String date);

  /// No description provided for @loggedOutFromAnotherDevice.
  ///
  /// In en, this message translates to:
  /// **'Logged In From Another Device'**
  String get loggedOutFromAnotherDevice;

  /// No description provided for @loggedOutFromAnotherDeviceMessage.
  ///
  /// In en, this message translates to:
  /// **'Your account was accessed from another device. For security reasons, you have been signed out from this device.'**
  String get loggedOutFromAnotherDeviceMessage;

  /// No description provided for @multiCurrencyProTitle.
  ///
  /// In en, this message translates to:
  /// **'Multi-Currency'**
  String get multiCurrencyProTitle;

  /// No description provided for @multiCurrencyProDescription.
  ///
  /// In en, this message translates to:
  /// **'Upgrade to Pro to enter income and expenses in different currencies. Use USD, EUR, GBP and more.'**
  String get multiCurrencyProDescription;

  /// No description provided for @multiCurrencyBenefit.
  ///
  /// In en, this message translates to:
  /// **'All currencies available'**
  String get multiCurrencyBenefit;

  /// No description provided for @currencyLockedForFree.
  ///
  /// In en, this message translates to:
  /// **'Currency change is a Pro feature'**
  String get currencyLockedForFree;

  /// No description provided for @excelSheetExpenses.
  ///
  /// In en, this message translates to:
  /// **'Expenses'**
  String get excelSheetExpenses;

  /// No description provided for @excelSheetSummary.
  ///
  /// In en, this message translates to:
  /// **'Summary'**
  String get excelSheetSummary;

  /// No description provided for @excelSheetCategories.
  ///
  /// In en, this message translates to:
  /// **'Categories'**
  String get excelSheetCategories;

  /// No description provided for @excelSheetTimeAnalysis.
  ///
  /// In en, this message translates to:
  /// **'Time Analysis'**
  String get excelSheetTimeAnalysis;

  /// No description provided for @excelSheetDecisions.
  ///
  /// In en, this message translates to:
  /// **'Decisions'**
  String get excelSheetDecisions;

  /// No description provided for @excelSheetInstallments.
  ///
  /// In en, this message translates to:
  /// **'Installments'**
  String get excelSheetInstallments;

  /// No description provided for @excelHeaderDay.
  ///
  /// In en, this message translates to:
  /// **'Day'**
  String get excelHeaderDay;

  /// No description provided for @excelHeaderStore.
  ///
  /// In en, this message translates to:
  /// **'Store/Location'**
  String get excelHeaderStore;

  /// No description provided for @excelHeaderMinutes.
  ///
  /// In en, this message translates to:
  /// **'Minutes Equiv.'**
  String get excelHeaderMinutes;

  /// No description provided for @excelHeaderMonthlyInstallment.
  ///
  /// In en, this message translates to:
  /// **'Monthly Payment'**
  String get excelHeaderMonthlyInstallment;

  /// No description provided for @excelHeaderInstallmentCount.
  ///
  /// In en, this message translates to:
  /// **'Installment'**
  String get excelHeaderInstallmentCount;

  /// No description provided for @excelHeaderSimulation.
  ///
  /// In en, this message translates to:
  /// **'Simulation'**
  String get excelHeaderSimulation;

  /// No description provided for @excelHeaderHoursEquiv.
  ///
  /// In en, this message translates to:
  /// **'Hours Equiv.'**
  String get excelHeaderHoursEquiv;

  /// No description provided for @excelReportTitle.
  ///
  /// In en, this message translates to:
  /// **'Vantag Financial Report'**
  String get excelReportTitle;

  /// No description provided for @excelReportPeriod.
  ///
  /// In en, this message translates to:
  /// **'Report Period'**
  String get excelReportPeriod;

  /// No description provided for @excelReportGeneratedAt.
  ///
  /// In en, this message translates to:
  /// **'Generated'**
  String get excelReportGeneratedAt;

  /// No description provided for @excelTotalExpenses.
  ///
  /// In en, this message translates to:
  /// **'Total Expenses'**
  String get excelTotalExpenses;

  /// No description provided for @excelTotalTransactions.
  ///
  /// In en, this message translates to:
  /// **'Total Transactions'**
  String get excelTotalTransactions;

  /// No description provided for @excelAvgPerTransaction.
  ///
  /// In en, this message translates to:
  /// **'Average per Transaction'**
  String get excelAvgPerTransaction;

  /// No description provided for @excelMonthlyAverage.
  ///
  /// In en, this message translates to:
  /// **'Monthly Average'**
  String get excelMonthlyAverage;

  /// No description provided for @excelDailyAverage.
  ///
  /// In en, this message translates to:
  /// **'Daily Average'**
  String get excelDailyAverage;

  /// No description provided for @excelWeeklyAverage.
  ///
  /// In en, this message translates to:
  /// **'Weekly Average'**
  String get excelWeeklyAverage;

  /// No description provided for @excelSavingsRate.
  ///
  /// In en, this message translates to:
  /// **'Savings Rate'**
  String get excelSavingsRate;

  /// No description provided for @excelTotalWorkHours.
  ///
  /// In en, this message translates to:
  /// **'Total Work Hours'**
  String get excelTotalWorkHours;

  /// No description provided for @excelTotalWorkDays.
  ///
  /// In en, this message translates to:
  /// **'Total Work Days'**
  String get excelTotalWorkDays;

  /// No description provided for @excelCategoryShare.
  ///
  /// In en, this message translates to:
  /// **'Share %'**
  String get excelCategoryShare;

  /// No description provided for @excelCategoryRank.
  ///
  /// In en, this message translates to:
  /// **'Rank'**
  String get excelCategoryRank;

  /// No description provided for @excelTopCategory.
  ///
  /// In en, this message translates to:
  /// **'Top Category'**
  String get excelTopCategory;

  /// No description provided for @excelCategoryCount.
  ///
  /// In en, this message translates to:
  /// **'Transaction Count'**
  String get excelCategoryCount;

  /// No description provided for @excelCategoryAvg.
  ///
  /// In en, this message translates to:
  /// **'Category Average'**
  String get excelCategoryAvg;

  /// No description provided for @excelCategoryTotal.
  ///
  /// In en, this message translates to:
  /// **'Category Total'**
  String get excelCategoryTotal;

  /// No description provided for @excelCategoryHours.
  ///
  /// In en, this message translates to:
  /// **'Work Hours'**
  String get excelCategoryHours;

  /// No description provided for @excelTimeTitle.
  ///
  /// In en, this message translates to:
  /// **'Time Analysis'**
  String get excelTimeTitle;

  /// No description provided for @excelMostActiveDay.
  ///
  /// In en, this message translates to:
  /// **'Most Active Day'**
  String get excelMostActiveDay;

  /// No description provided for @excelMostActiveHour.
  ///
  /// In en, this message translates to:
  /// **'Most Active Hour'**
  String get excelMostActiveHour;

  /// No description provided for @excelWeekdayAvg.
  ///
  /// In en, this message translates to:
  /// **'Weekday Average'**
  String get excelWeekdayAvg;

  /// No description provided for @excelWeekendAvg.
  ///
  /// In en, this message translates to:
  /// **'Weekend Average'**
  String get excelWeekendAvg;

  /// No description provided for @excelMorningSpend.
  ///
  /// In en, this message translates to:
  /// **'Morning (06-12)'**
  String get excelMorningSpend;

  /// No description provided for @excelAfternoonSpend.
  ///
  /// In en, this message translates to:
  /// **'Afternoon (12-18)'**
  String get excelAfternoonSpend;

  /// No description provided for @excelEveningSpend.
  ///
  /// In en, this message translates to:
  /// **'Evening (18-24)'**
  String get excelEveningSpend;

  /// No description provided for @excelNightSpend.
  ///
  /// In en, this message translates to:
  /// **'Night (00-06)'**
  String get excelNightSpend;

  /// No description provided for @excelByDayOfWeek.
  ///
  /// In en, this message translates to:
  /// **'By Day of Week'**
  String get excelByDayOfWeek;

  /// No description provided for @excelByHour.
  ///
  /// In en, this message translates to:
  /// **'By Hour'**
  String get excelByHour;

  /// No description provided for @excelByMonth.
  ///
  /// In en, this message translates to:
  /// **'By Month'**
  String get excelByMonth;

  /// No description provided for @excelDecisionsBought.
  ///
  /// In en, this message translates to:
  /// **'Bought'**
  String get excelDecisionsBought;

  /// No description provided for @excelDecisionsThinking.
  ///
  /// In en, this message translates to:
  /// **'Thinking'**
  String get excelDecisionsThinking;

  /// No description provided for @excelDecisionsPassed.
  ///
  /// In en, this message translates to:
  /// **'Passed'**
  String get excelDecisionsPassed;

  /// No description provided for @excelDecisionCount.
  ///
  /// In en, this message translates to:
  /// **'Count'**
  String get excelDecisionCount;

  /// No description provided for @excelDecisionAmount.
  ///
  /// In en, this message translates to:
  /// **'Amount'**
  String get excelDecisionAmount;

  /// No description provided for @excelDecisionPercent.
  ///
  /// In en, this message translates to:
  /// **'Percentage'**
  String get excelDecisionPercent;

  /// No description provided for @excelDecisionAvg.
  ///
  /// In en, this message translates to:
  /// **'Average'**
  String get excelDecisionAvg;

  /// No description provided for @excelDecisionHours.
  ///
  /// In en, this message translates to:
  /// **'Work Hours'**
  String get excelDecisionHours;

  /// No description provided for @excelImpulseRate.
  ///
  /// In en, this message translates to:
  /// **'Impulse Rate'**
  String get excelImpulseRate;

  /// No description provided for @excelSavingsFromPassed.
  ///
  /// In en, this message translates to:
  /// **'Savings from Passed'**
  String get excelSavingsFromPassed;

  /// No description provided for @excelPotentialSavings.
  ///
  /// In en, this message translates to:
  /// **'Potential Savings (Thinking)'**
  String get excelPotentialSavings;

  /// No description provided for @excelInstallmentName.
  ///
  /// In en, this message translates to:
  /// **'Description'**
  String get excelInstallmentName;

  /// No description provided for @excelInstallmentTotal.
  ///
  /// In en, this message translates to:
  /// **'Total Amount'**
  String get excelInstallmentTotal;

  /// No description provided for @excelInstallmentMonthly.
  ///
  /// In en, this message translates to:
  /// **'Monthly Payment'**
  String get excelInstallmentMonthly;

  /// No description provided for @excelInstallmentProgress.
  ///
  /// In en, this message translates to:
  /// **'Progress'**
  String get excelInstallmentProgress;

  /// No description provided for @excelInstallmentRemaining.
  ///
  /// In en, this message translates to:
  /// **'Remaining'**
  String get excelInstallmentRemaining;

  /// No description provided for @excelInstallmentStartDate.
  ///
  /// In en, this message translates to:
  /// **'Start Date'**
  String get excelInstallmentStartDate;

  /// No description provided for @excelInstallmentEndDate.
  ///
  /// In en, this message translates to:
  /// **'End Date'**
  String get excelInstallmentEndDate;

  /// No description provided for @excelInstallmentInterest.
  ///
  /// In en, this message translates to:
  /// **'Interest'**
  String get excelInstallmentInterest;

  /// No description provided for @excelNoInstallments.
  ///
  /// In en, this message translates to:
  /// **'No installment payments'**
  String get excelNoInstallments;

  /// No description provided for @excelTotalMonthlyPayments.
  ///
  /// In en, this message translates to:
  /// **'Total Monthly Payments'**
  String get excelTotalMonthlyPayments;

  /// No description provided for @excelTotalRemainingDebt.
  ///
  /// In en, this message translates to:
  /// **'Total Remaining Debt'**
  String get excelTotalRemainingDebt;

  /// No description provided for @excelDayMonday.
  ///
  /// In en, this message translates to:
  /// **'Monday'**
  String get excelDayMonday;

  /// No description provided for @excelDayTuesday.
  ///
  /// In en, this message translates to:
  /// **'Tuesday'**
  String get excelDayTuesday;

  /// No description provided for @excelDayWednesday.
  ///
  /// In en, this message translates to:
  /// **'Wednesday'**
  String get excelDayWednesday;

  /// No description provided for @excelDayThursday.
  ///
  /// In en, this message translates to:
  /// **'Thursday'**
  String get excelDayThursday;

  /// No description provided for @excelDayFriday.
  ///
  /// In en, this message translates to:
  /// **'Friday'**
  String get excelDayFriday;

  /// No description provided for @excelDaySaturday.
  ///
  /// In en, this message translates to:
  /// **'Saturday'**
  String get excelDaySaturday;

  /// No description provided for @excelDaySunday.
  ///
  /// In en, this message translates to:
  /// **'Sunday'**
  String get excelDaySunday;

  /// No description provided for @excelYes.
  ///
  /// In en, this message translates to:
  /// **'Yes'**
  String get excelYes;

  /// No description provided for @excelNo.
  ///
  /// In en, this message translates to:
  /// **'No'**
  String get excelNo;

  /// No description provided for @excelReal.
  ///
  /// In en, this message translates to:
  /// **'Real'**
  String get excelReal;

  /// No description provided for @excelSimulation.
  ///
  /// In en, this message translates to:
  /// **'Simulation'**
  String get excelSimulation;

  /// No description provided for @proFeaturesSheetTitle.
  ///
  /// In en, this message translates to:
  /// **'Pro Feature'**
  String get proFeaturesSheetTitle;

  /// No description provided for @proFeaturesSheetSubtitle.
  ///
  /// In en, this message translates to:
  /// **'This feature is exclusive to Pro members'**
  String get proFeaturesSheetSubtitle;

  /// No description provided for @proFeaturesIncluded.
  ///
  /// In en, this message translates to:
  /// **'Pro membership includes:'**
  String get proFeaturesIncluded;

  /// No description provided for @proFeatureHeatmap.
  ///
  /// In en, this message translates to:
  /// **'Expense Heatmap'**
  String get proFeatureHeatmap;

  /// No description provided for @proFeatureHeatmapDesc.
  ///
  /// In en, this message translates to:
  /// **'Visualize your spending patterns over the year'**
  String get proFeatureHeatmapDesc;

  /// No description provided for @proFeatureCategoryBreakdown.
  ///
  /// In en, this message translates to:
  /// **'Category Breakdown'**
  String get proFeatureCategoryBreakdown;

  /// No description provided for @proFeatureCategoryBreakdownDesc.
  ///
  /// In en, this message translates to:
  /// **'Detailed pie chart analysis by category'**
  String get proFeatureCategoryBreakdownDesc;

  /// No description provided for @proFeatureSpendingTrends.
  ///
  /// In en, this message translates to:
  /// **'Spending Trends'**
  String get proFeatureSpendingTrends;

  /// No description provided for @proFeatureSpendingTrendsDesc.
  ///
  /// In en, this message translates to:
  /// **'Track your spending changes over time'**
  String get proFeatureSpendingTrendsDesc;

  /// No description provided for @proFeatureTimeAnalysis.
  ///
  /// In en, this message translates to:
  /// **'Time Analysis'**
  String get proFeatureTimeAnalysis;

  /// No description provided for @proFeatureTimeAnalysisDesc.
  ///
  /// In en, this message translates to:
  /// **'See when you spend most by day and hour'**
  String get proFeatureTimeAnalysisDesc;

  /// No description provided for @proFeatureBudgetBreakdown.
  ///
  /// In en, this message translates to:
  /// **'Budget Breakdown'**
  String get proFeatureBudgetBreakdown;

  /// No description provided for @proFeatureBudgetBreakdownDesc.
  ///
  /// In en, this message translates to:
  /// **'Track spending against your budget goals'**
  String get proFeatureBudgetBreakdownDesc;

  /// No description provided for @proFeatureAdvancedFilters.
  ///
  /// In en, this message translates to:
  /// **'Advanced Filters'**
  String get proFeatureAdvancedFilters;

  /// No description provided for @proFeatureAdvancedFiltersDesc.
  ///
  /// In en, this message translates to:
  /// **'Filter by month, all-time, and more'**
  String get proFeatureAdvancedFiltersDesc;

  /// No description provided for @proFeatureExcelExport.
  ///
  /// In en, this message translates to:
  /// **'Excel Export'**
  String get proFeatureExcelExport;

  /// No description provided for @proFeatureExcelExportDesc.
  ///
  /// In en, this message translates to:
  /// **'Export your complete financial data'**
  String get proFeatureExcelExportDesc;

  /// No description provided for @proFeatureUnlimitedHistory.
  ///
  /// In en, this message translates to:
  /// **'Unlimited History'**
  String get proFeatureUnlimitedHistory;

  /// No description provided for @proFeatureUnlimitedHistoryDesc.
  ///
  /// In en, this message translates to:
  /// **'Access all your past expenses'**
  String get proFeatureUnlimitedHistoryDesc;

  /// No description provided for @goProButton.
  ///
  /// In en, this message translates to:
  /// **'Go Pro'**
  String get goProButton;

  /// No description provided for @lockedFeatureTapToUnlock.
  ///
  /// In en, this message translates to:
  /// **'Tap to unlock'**
  String get lockedFeatureTapToUnlock;

  /// No description provided for @voiceUsageIndicator.
  ///
  /// In en, this message translates to:
  /// **'{used}/{total} voice inputs today'**
  String voiceUsageIndicator(int used, int total);

  /// No description provided for @aiChatUsageIndicator.
  ///
  /// In en, this message translates to:
  /// **'{used}/{total} questions today'**
  String aiChatUsageIndicator(int used, int total);

  /// No description provided for @dailyLimitReached.
  ///
  /// In en, this message translates to:
  /// **'Daily limit reached'**
  String get dailyLimitReached;

  /// No description provided for @dailyLimitReachedDesc.
  ///
  /// In en, this message translates to:
  /// **'You\'ve used all your daily quota. Upgrade to Pro for unlimited access!'**
  String get dailyLimitReachedDesc;

  /// No description provided for @unlimitedWithPro.
  ///
  /// In en, this message translates to:
  /// **'Unlimited with Pro'**
  String get unlimitedWithPro;

  /// No description provided for @backupData.
  ///
  /// In en, this message translates to:
  /// **'Backup Data'**
  String get backupData;

  /// No description provided for @backupDataDesc.
  ///
  /// In en, this message translates to:
  /// **'Export your data as a JSON file'**
  String get backupDataDesc;

  /// No description provided for @restoreData.
  ///
  /// In en, this message translates to:
  /// **'Restore Data'**
  String get restoreData;

  /// No description provided for @restoreDataDesc.
  ///
  /// In en, this message translates to:
  /// **'Import data from a backup file'**
  String get restoreDataDesc;

  /// No description provided for @backupCreating.
  ///
  /// In en, this message translates to:
  /// **'Creating backup...'**
  String get backupCreating;

  /// No description provided for @backupSuccess.
  ///
  /// In en, this message translates to:
  /// **'Backup created successfully'**
  String get backupSuccess;

  /// No description provided for @backupError.
  ///
  /// In en, this message translates to:
  /// **'Failed to create backup'**
  String get backupError;

  /// No description provided for @restoreConfirmTitle.
  ///
  /// In en, this message translates to:
  /// **'Restore Data?'**
  String get restoreConfirmTitle;

  /// No description provided for @restoreConfirmMessage.
  ///
  /// In en, this message translates to:
  /// **'This will add the backup data to your existing data. Continue?'**
  String get restoreConfirmMessage;

  /// No description provided for @restoreSuccess.
  ///
  /// In en, this message translates to:
  /// **'Data restored! {expenses} expenses, {pursuits} goals, {subscriptions} subscriptions imported.'**
  String restoreSuccess(int expenses, int pursuits, int subscriptions);

  /// No description provided for @restoreError.
  ///
  /// In en, this message translates to:
  /// **'Failed to restore data'**
  String get restoreError;

  /// No description provided for @noFileSelected.
  ///
  /// In en, this message translates to:
  /// **'No file selected'**
  String get noFileSelected;

  /// No description provided for @invalidBackupFormat.
  ///
  /// In en, this message translates to:
  /// **'Invalid backup file format'**
  String get invalidBackupFormat;

  /// No description provided for @shareApp.
  ///
  /// In en, this message translates to:
  /// **'Share App'**
  String get shareApp;

  /// No description provided for @shareAppDesc.
  ///
  /// In en, this message translates to:
  /// **'Recommend Vantag to friends'**
  String get shareAppDesc;

  /// No description provided for @shareAppMessage.
  ///
  /// In en, this message translates to:
  /// **'Check out Vantag - It shows you how many work hours each expense costs! Download: https://play.google.com/store/apps/details?id=com.vantag.app'**
  String get shareAppMessage;

  /// No description provided for @sendFeedback.
  ///
  /// In en, this message translates to:
  /// **'Send Feedback'**
  String get sendFeedback;

  /// No description provided for @sendFeedbackDesc.
  ///
  /// In en, this message translates to:
  /// **'Help us improve Vantag'**
  String get sendFeedbackDesc;

  /// No description provided for @feedbackEmailSubject.
  ///
  /// In en, this message translates to:
  /// **'Vantag Feedback'**
  String get feedbackEmailSubject;

  /// No description provided for @rateApp.
  ///
  /// In en, this message translates to:
  /// **'Rate App'**
  String get rateApp;

  /// No description provided for @rateAppDesc.
  ///
  /// In en, this message translates to:
  /// **'Rate us on Play Store'**
  String get rateAppDesc;

  /// No description provided for @whatsNew.
  ///
  /// In en, this message translates to:
  /// **'What\'s New'**
  String get whatsNew;

  /// No description provided for @whatsNewInVersion.
  ///
  /// In en, this message translates to:
  /// **'What\'s New in v{version}'**
  String whatsNewInVersion(String version);

  /// No description provided for @updateRequired.
  ///
  /// In en, this message translates to:
  /// **'Update Required'**
  String get updateRequired;

  /// No description provided for @updateRequiredMessage.
  ///
  /// In en, this message translates to:
  /// **'A new version of Vantag is available. Please update to continue.'**
  String get updateRequiredMessage;

  /// No description provided for @updateNow.
  ///
  /// In en, this message translates to:
  /// **'Update Now'**
  String get updateNow;

  /// No description provided for @dailyLimits.
  ///
  /// In en, this message translates to:
  /// **'Daily Limits'**
  String get dailyLimits;

  /// No description provided for @aiChat.
  ///
  /// In en, this message translates to:
  /// **'AI Chat'**
  String get aiChat;

  /// No description provided for @statementImport.
  ///
  /// In en, this message translates to:
  /// **'Statement Import'**
  String get statementImport;

  /// Apple App Store required auto-renewal disclosure
  ///
  /// In en, this message translates to:
  /// **'Subscription automatically renews unless canceled at least 24 hours before the end of the current period. Manage subscriptions in Settings.'**
  String get subscriptionAutoRenewalNotice;

  /// No description provided for @welcomeBackTitle3Days.
  ///
  /// In en, this message translates to:
  /// **'Welcome Back!'**
  String get welcomeBackTitle3Days;

  /// No description provided for @welcomeBackSubtitle3Days.
  ///
  /// In en, this message translates to:
  /// **'We missed you. Keep tracking your expenses.'**
  String get welcomeBackSubtitle3Days;

  /// No description provided for @welcomeBackCta3Days.
  ///
  /// In en, this message translates to:
  /// **'Add Expense'**
  String get welcomeBackCta3Days;

  /// No description provided for @welcomeBackTitle7Days.
  ///
  /// In en, this message translates to:
  /// **'You\'re Back!'**
  String get welcomeBackTitle7Days;

  /// No description provided for @welcomeBackSubtitle7Days.
  ///
  /// In en, this message translates to:
  /// **'It\'s been a week. Let\'s continue towards your financial goals.'**
  String get welcomeBackSubtitle7Days;

  /// No description provided for @welcomeBackCta7Days.
  ///
  /// In en, this message translates to:
  /// **'Where Did We Leave Off?'**
  String get welcomeBackCta7Days;

  /// No description provided for @welcomeBackTitle14Days.
  ///
  /// In en, this message translates to:
  /// **'Hello Again!'**
  String get welcomeBackTitle14Days;

  /// No description provided for @welcomeBackSubtitle14Days.
  ///
  /// In en, this message translates to:
  /// **'We\'ve been waiting. Ready for a fresh start?'**
  String get welcomeBackSubtitle14Days;

  /// No description provided for @welcomeBackCta14Days.
  ///
  /// In en, this message translates to:
  /// **'Start Fresh'**
  String get welcomeBackCta14Days;

  /// No description provided for @welcomeBackTitle30Days.
  ///
  /// In en, this message translates to:
  /// **'Welcome Back!'**
  String get welcomeBackTitle30Days;

  /// No description provided for @welcomeBackSubtitle30Days.
  ///
  /// In en, this message translates to:
  /// **'It\'s been a while, but reaching your goals is still possible!'**
  String get welcomeBackSubtitle30Days;

  /// No description provided for @welcomeBackCta30Days.
  ///
  /// In en, this message translates to:
  /// **'Get Started'**
  String get welcomeBackCta30Days;

  /// No description provided for @welcomeBackStreakLost.
  ///
  /// In en, this message translates to:
  /// **'Your streak was reset'**
  String get welcomeBackStreakLost;

  /// No description provided for @welcomeBackStreakRecovered.
  ///
  /// In en, this message translates to:
  /// **'{percent}% of your streak recovered!'**
  String welcomeBackStreakRecovered(int percent);

  /// No description provided for @reengagementPushTitle3Days.
  ///
  /// In en, this message translates to:
  /// **'Don\'t forget to track your expenses!'**
  String get reengagementPushTitle3Days;

  /// No description provided for @reengagementPushBody3Days.
  ///
  /// In en, this message translates to:
  /// **'How much did you save today? Check now.'**
  String get reengagementPushBody3Days;

  /// No description provided for @reengagementPushTitle5Days.
  ///
  /// In en, this message translates to:
  /// **'We miss you!'**
  String get reengagementPushTitle5Days;

  /// No description provided for @reengagementPushBody5Days.
  ///
  /// In en, this message translates to:
  /// **'Keep going to reach your financial goals.'**
  String get reengagementPushBody5Days;

  /// No description provided for @reengagementPushTitle7Days.
  ///
  /// In en, this message translates to:
  /// **'Come back before you lose your streak!'**
  String get reengagementPushTitle7Days;

  /// No description provided for @reengagementPushBody7Days.
  ///
  /// In en, this message translates to:
  /// **'Don\'t lose your streak, add an expense now.'**
  String get reengagementPushBody7Days;

  /// No description provided for @reengagementUrgentTitle.
  ///
  /// In en, this message translates to:
  /// **'Don\'t lose control of your finances!'**
  String get reengagementUrgentTitle;

  /// No description provided for @reengagementUrgentBody.
  ///
  /// In en, this message translates to:
  /// **'Update your expenses and stay on track.'**
  String get reengagementUrgentBody;

  /// No description provided for @pushOnboardingDay1Title.
  ///
  /// In en, this message translates to:
  /// **'Add your first expense!'**
  String get pushOnboardingDay1Title;

  /// No description provided for @pushOnboardingDay1Body.
  ///
  /// In en, this message translates to:
  /// **'A coffee or meal - start small, see the difference.'**
  String get pushOnboardingDay1Body;

  /// No description provided for @pushOnboardingDay3Title.
  ///
  /// In en, this message translates to:
  /// **'Do you know how many hours you worked?'**
  String get pushOnboardingDay3Title;

  /// No description provided for @pushOnboardingDay3Body.
  ///
  /// In en, this message translates to:
  /// **'Keep seeing your expenses as hours worked.'**
  String get pushOnboardingDay3Body;

  /// No description provided for @pushOnboardingDay7Title.
  ///
  /// In en, this message translates to:
  /// **'It\'s been 7 days!'**
  String get pushOnboardingDay7Title;

  /// No description provided for @pushOnboardingDay7Body.
  ///
  /// In en, this message translates to:
  /// **'Add an expense daily to start a streak.'**
  String get pushOnboardingDay7Body;

  /// No description provided for @pushWeeklyInsightTitle.
  ///
  /// In en, this message translates to:
  /// **'Weekly Summary Ready'**
  String get pushWeeklyInsightTitle;

  /// No description provided for @pushWeeklyInsightBody.
  ///
  /// In en, this message translates to:
  /// **'How much did you save this week? Check now.'**
  String get pushWeeklyInsightBody;

  /// No description provided for @pushStreakReminderNewTitle.
  ///
  /// In en, this message translates to:
  /// **'Start a new streak!'**
  String get pushStreakReminderNewTitle;

  /// No description provided for @pushStreakReminderNewBody.
  ///
  /// In en, this message translates to:
  /// **'Add your first expense today and begin your journey.'**
  String get pushStreakReminderNewBody;

  /// No description provided for @pushStreakReminderShortTitle.
  ///
  /// In en, this message translates to:
  /// **'You have a {days} day streak!'**
  String pushStreakReminderShortTitle(int days);

  /// No description provided for @pushStreakReminderShortBody.
  ///
  /// In en, this message translates to:
  /// **'Add one today to keep it going.'**
  String get pushStreakReminderShortBody;

  /// No description provided for @pushStreakReminderMediumTitle.
  ///
  /// In en, this message translates to:
  /// **'{days} days! You\'re doing great!'**
  String pushStreakReminderMediumTitle(int days);

  /// No description provided for @pushStreakReminderMediumBody.
  ///
  /// In en, this message translates to:
  /// **'Add today to keep your streak alive.'**
  String get pushStreakReminderMediumBody;

  /// No description provided for @pushStreakReminderLongTitle.
  ///
  /// In en, this message translates to:
  /// **'{days} day streak!'**
  String pushStreakReminderLongTitle(int days);

  /// No description provided for @pushStreakReminderLongBody.
  ///
  /// In en, this message translates to:
  /// **'Incredible achievement! Keep it up.'**
  String get pushStreakReminderLongBody;

  /// No description provided for @pushMorningMotivationTitle.
  ///
  /// In en, this message translates to:
  /// **'Good morning!'**
  String get pushMorningMotivationTitle;

  /// No description provided for @pushMorningMotivationWithSavingsBody.
  ///
  /// In en, this message translates to:
  /// **'You saved {symbol}{amount} this month. Keep going!'**
  String pushMorningMotivationWithSavingsBody(String symbol, String amount);

  /// No description provided for @pushMorningMotivationDefaultBody.
  ///
  /// In en, this message translates to:
  /// **'Add an expense today to boost your financial awareness.'**
  String get pushMorningMotivationDefaultBody;

  /// No description provided for @notificationSettingsTitle.
  ///
  /// In en, this message translates to:
  /// **'Notification Settings'**
  String get notificationSettingsTitle;

  /// No description provided for @notificationSettingsQuietHours.
  ///
  /// In en, this message translates to:
  /// **'Quiet Hours'**
  String get notificationSettingsQuietHours;

  /// No description provided for @notificationSettingsQuietHoursDesc.
  ///
  /// In en, this message translates to:
  /// **'No notifications during these hours'**
  String get notificationSettingsQuietHoursDesc;

  /// No description provided for @notificationSettingsPreferredTime.
  ///
  /// In en, this message translates to:
  /// **'Preferred Time'**
  String get notificationSettingsPreferredTime;

  /// No description provided for @notificationSettingsPreferredTimeDesc.
  ///
  /// In en, this message translates to:
  /// **'Time to receive notifications'**
  String get notificationSettingsPreferredTimeDesc;

  /// No description provided for @notificationSettingsStreakReminders.
  ///
  /// In en, this message translates to:
  /// **'Streak Reminders'**
  String get notificationSettingsStreakReminders;

  /// No description provided for @notificationSettingsStreakRemindersDesc.
  ///
  /// In en, this message translates to:
  /// **'Get evening reminders about your streak'**
  String get notificationSettingsStreakRemindersDesc;

  /// No description provided for @notificationSettingsMorningMotivation.
  ///
  /// In en, this message translates to:
  /// **'Morning Motivation'**
  String get notificationSettingsMorningMotivation;

  /// No description provided for @notificationSettingsMorningMotivationDesc.
  ///
  /// In en, this message translates to:
  /// **'Get motivation messages in the morning'**
  String get notificationSettingsMorningMotivationDesc;

  /// No description provided for @notificationSettingsWeeklyInsights.
  ///
  /// In en, this message translates to:
  /// **'Weekly Insights'**
  String get notificationSettingsWeeklyInsights;

  /// No description provided for @notificationSettingsWeeklyInsightsDesc.
  ///
  /// In en, this message translates to:
  /// **'Get weekly summary on Sunday mornings'**
  String get notificationSettingsWeeklyInsightsDesc;

  /// No description provided for @loginPromptTitle.
  ///
  /// In en, this message translates to:
  /// **'Save Your Data'**
  String get loginPromptTitle;

  /// No description provided for @loginPromptSubtitle.
  ///
  /// In en, this message translates to:
  /// **'Link your account so you don\'t lose your data'**
  String get loginPromptSubtitle;

  /// No description provided for @loginPromptLater.
  ///
  /// In en, this message translates to:
  /// **'Maybe later'**
  String get loginPromptLater;

  /// No description provided for @additionalIncomePromptTitle.
  ///
  /// In en, this message translates to:
  /// **'Do you have additional income?'**
  String get additionalIncomePromptTitle;

  /// No description provided for @additionalIncomePromptSubtitle.
  ///
  /// In en, this message translates to:
  /// **'Side job, rent, freelance...'**
  String get additionalIncomePromptSubtitle;

  /// No description provided for @additionalIncomeYes.
  ///
  /// In en, this message translates to:
  /// **'Yes, add'**
  String get additionalIncomeYes;

  /// No description provided for @additionalIncomeNo.
  ///
  /// In en, this message translates to:
  /// **'No, I don\'t'**
  String get additionalIncomeNo;
}

class _AppLocalizationsDelegate
    extends LocalizationsDelegate<AppLocalizations> {
  const _AppLocalizationsDelegate();

  @override
  Future<AppLocalizations> load(Locale locale) {
    return SynchronousFuture<AppLocalizations>(lookupAppLocalizations(locale));
  }

  @override
  bool isSupported(Locale locale) =>
      <String>['en', 'tr'].contains(locale.languageCode);

  @override
  bool shouldReload(_AppLocalizationsDelegate old) => false;
}

AppLocalizations lookupAppLocalizations(Locale locale) {
  // Lookup logic when only language code is specified.
  switch (locale.languageCode) {
    case 'en':
      return AppLocalizationsEn();
    case 'tr':
      return AppLocalizationsTr();
  }

  throw FlutterError(
    'AppLocalizations.delegate failed to load unsupported locale "$locale". This is likely '
    'an issue with the localizations generation tool. Please file an issue '
    'on GitHub with a reproducible sample app and the gen-l10n configuration '
    'that was used.',
  );
}


--- FILE: lib/l10n/app_localizations_tr.dart ---

// ignore: unused_import
import 'package:intl/intl.dart' as intl;
import 'app_localizations.dart';

// ignore_for_file: type=lint

/// The translations for Turkish (`tr`).
class AppLocalizationsTr extends AppLocalizations {
  AppLocalizationsTr([String locale = 'tr']) : super(locale);

  @override
  String get appTitle => 'Vantag';

  @override
  String get appSlogan => 'Finansal Üstünlüğün';

  @override
  String get navExpenses => 'Harcama';

  @override
  String get navReports => 'Rapor';

  @override
  String get navAchievements => 'Rozetler';

  @override
  String get navProfile => 'Profil';

  @override
  String get navSettings => 'Ayarlar';

  @override
  String get profile => 'Profil';

  @override
  String get profileSavedTime => 'Vantag ile Kurtarılan Zaman';

  @override
  String profileHours(String hours) {
    return '$hours Saat';
  }

  @override
  String get profileMemberSince => 'Üyelik Süresi';

  @override
  String profileDays(int days) {
    return '$days Gün';
  }

  @override
  String get profileBadgesEarned => 'Kazanılan Rozet';

  @override
  String get profileGoogleConnected => 'Google Hesabı Bağlı';

  @override
  String get profileGoogleNotConnected => 'Google Hesabı Bağlı Değil';

  @override
  String get profileSignOut => 'Çıkış Yap';

  @override
  String get profileSignOutConfirm => 'Çıkış yapmak istediğinize emin misiniz?';

  @override
  String get proMember => 'Pro Üye';

  @override
  String get proMemberToast => 'Pro Üyesiniz ✓';

  @override
  String get settingsGeneral => 'Genel';

  @override
  String get settingsCurrency => 'Para Birimi';

  @override
  String get settingsLanguage => 'Dil';

  @override
  String get settingsTheme => 'Tema';

  @override
  String get settingsThemeDark => 'Koyu';

  @override
  String get settingsThemeLight => 'Açık';

  @override
  String get settingsThemeAutomatic => 'Otomatik';

  @override
  String get simpleMode => 'Basit Mod';

  @override
  String get simpleModeDescription =>
      'Sadece temel özelliklerle basitleştirilmiş deneyim';

  @override
  String get simpleModeEnabled => 'Basit mod etkin';

  @override
  String get simpleModeDisabled => 'Basit mod devre dışı';

  @override
  String get simpleModeHint =>
      'AI sohbet, rozetler ve hedefler gibi tüm özelliklere erişmek için Basit Modu kapatın';

  @override
  String get simpleTransactions => 'İşlemler';

  @override
  String get simpleStatistics => 'İstatistik';

  @override
  String get simpleSettings => 'Ayarlar';

  @override
  String get simpleIncome => 'Gelir';

  @override
  String get simpleExpense => 'Gider';

  @override
  String get simpleExpenses => 'Giderler';

  @override
  String get simpleBalance => 'Bakiye';

  @override
  String get simpleTotal => 'Toplam';

  @override
  String get simpleTotalIncome => 'Toplam Gelir';

  @override
  String get simpleIncomeTab => 'Gelir';

  @override
  String get simpleIncomeSources => 'Gelir Kaynakları';

  @override
  String get simpleNoTransactions => 'Bu ay işlem yok';

  @override
  String get simpleNoData => 'Bu ay için veri yok';

  @override
  String get settingsNotifications => 'Bildirimler';

  @override
  String get settingsReminders => 'Hatırlatıcılar';

  @override
  String get settingsSoundEffects => 'Ses Efektleri';

  @override
  String get settingsSoundVolume => 'Ses Seviyesi';

  @override
  String get settingsProPurchases => 'Pro & Satın Alma';

  @override
  String get settingsVantagPro => 'Vantag Pro';

  @override
  String get settingsRestorePurchases => 'Satın Alımları Geri Yükle';

  @override
  String get settingsRestoreSuccess => 'Satın alımlar geri yüklendi';

  @override
  String get settingsRestoreNone => 'Geri yüklenecek satın alım bulunamadı';

  @override
  String get settingsDataPrivacy => 'Veri & Gizlilik';

  @override
  String get settingsExportData => 'Verileri Dışa Aktar';

  @override
  String get settingsImportStatement => 'Ekstre Yükle';

  @override
  String get settingsImportStatementDesc =>
      'Banka ekstrenizi yükleyin (PDF/CSV)';

  @override
  String get importStatementTitle => 'Ekstre Yükle';

  @override
  String get importStatementSelectFile => 'Dosya Seç';

  @override
  String get importStatementSupportedFormats =>
      'Desteklenen formatlar: PDF, CSV';

  @override
  String get importStatementDragDrop => 'Banka ekstrenizi seçmek için dokunun';

  @override
  String get importStatementProcessing => 'Ekstre işleniyor...';

  @override
  String importStatementSuccess(int count) {
    return '$count işlem başarıyla içe aktarıldı';
  }

  @override
  String get importStatementError => 'Ekstre içe aktarılırken hata oluştu';

  @override
  String get importStatementNoTransactions => 'Ekstrede işlem bulunamadı';

  @override
  String get importStatementUnsupportedFormat => 'Desteklenmeyen dosya formatı';

  @override
  String importStatementMonthlyLimit(int remaining) {
    return 'Bu ay $remaining içe aktarma hakkınız kaldı';
  }

  @override
  String get importStatementLimitReached =>
      'Aylık içe aktarma limitine ulaşıldı';

  @override
  String get importStatementLimitReachedDesc =>
      'Bu ayki tüm içe aktarma haklarınızı kullandınız. Daha fazlası için Pro\'ya yükseltin.';

  @override
  String get importStatementProLimit => 'Ayda 10 içe aktarma';

  @override
  String get importStatementFreeLimit => 'Ayda 1 içe aktarma';

  @override
  String get importStatementReviewTitle => 'İşlemleri İncele';

  @override
  String get importStatementReviewDesc => 'İçe aktarılacak işlemleri seçin';

  @override
  String importStatementImportSelected(int count) {
    return 'Seçilenleri İçe Aktar ($count)';
  }

  @override
  String get importStatementSelectAll => 'Tümünü Seç';

  @override
  String get importStatementDeselectAll => 'Seçimi Kaldır';

  @override
  String get settingsPrivacyPolicy => 'Gizlilik Politikası';

  @override
  String get settingsAbout => 'Hakkında';

  @override
  String get settingsVersion => 'Versiyon';

  @override
  String get settingsContactUs => 'Bize Ulaşın';

  @override
  String get settingsGrowth => 'Davet et, 3 gün Premium kazan!';

  @override
  String get settingsInviteFriends => 'Arkadaşını Davet Et';

  @override
  String get settingsInviteMessage =>
      'Vantag ile harcamalarımı kontrol ediyorum! Sen de dene:';

  @override
  String get dashboard => 'Anasayfa';

  @override
  String get totalBalance => 'Toplam Bakiye';

  @override
  String get monthlyIncome => 'Aylık Gelir';

  @override
  String get totalIncome => 'Toplam Gelir';

  @override
  String get totalSpent => 'Toplam Harcama';

  @override
  String get totalSaved => 'Toplam Tasarruf';

  @override
  String get workHours => 'Çalışma Saati';

  @override
  String get workDays => 'Çalışma Günü';

  @override
  String get expenses => 'Harcamalar';

  @override
  String get addExpense => 'Harcama Ekle';

  @override
  String get amount => 'Tutar';

  @override
  String get amountTL => 'Tutar (₺)';

  @override
  String get category => 'Kategori';

  @override
  String get description => 'Açıklama';

  @override
  String get descriptionHint => 'ör: Migros, Spotify, Shell...';

  @override
  String get descriptionLabel => 'Açıklama (Mağaza/Ürün)';

  @override
  String get date => 'Tarih';

  @override
  String get today => 'Bugün';

  @override
  String get weekdayMon => 'Pzt';

  @override
  String get weekdayTue => 'Sal';

  @override
  String get weekdayWed => 'Çar';

  @override
  String get weekdayThu => 'Per';

  @override
  String get weekdayFri => 'Cum';

  @override
  String get weekdaySat => 'Cmt';

  @override
  String get weekdaySun => 'Paz';

  @override
  String get monthJan => 'Oca';

  @override
  String get monthFeb => 'Şub';

  @override
  String get monthMar => 'Mar';

  @override
  String get monthApr => 'Nis';

  @override
  String get monthMay => 'May';

  @override
  String get monthJun => 'Haz';

  @override
  String get monthJul => 'Tem';

  @override
  String get monthAug => 'Ağu';

  @override
  String get monthSep => 'Eyl';

  @override
  String get monthOct => 'Eki';

  @override
  String get monthNov => 'Kas';

  @override
  String get monthDec => 'Ara';

  @override
  String get yesterday => 'Dün';

  @override
  String get twoDaysAgo => '2 Gün Önce';

  @override
  String daysAgo(int count) {
    return '$count Gün Önce';
  }

  @override
  String get bought => 'Aldım';

  @override
  String get thinking => 'Düşünüyorum';

  @override
  String get passed => 'Vazgeçtim';

  @override
  String get cancel => 'İptal';

  @override
  String get ok => 'Tamam';

  @override
  String get save => 'Kaydet';

  @override
  String get delete => 'Sil';

  @override
  String get edit => 'Düzenle';

  @override
  String get change => 'Değiştir';

  @override
  String get close => 'Kapat';

  @override
  String get update => 'Güncelle';

  @override
  String get calculate => 'Hesapla';

  @override
  String get giveUp => 'Vazgeç';

  @override
  String get select => 'Seç';

  @override
  String get decision => 'Karar';

  @override
  String hoursRequired(String hours) {
    return '$hours saat';
  }

  @override
  String daysRequired(String days) {
    return '$days gün';
  }

  @override
  String minutesRequired(int minutes) {
    return '$minutes dakika';
  }

  @override
  String hoursEquivalent(String hours) {
    return '$hours saat karşılığı';
  }

  @override
  String get editProfile => 'Profili Düzenle';

  @override
  String get settings => 'Ayarlar';

  @override
  String get language => 'Dil';

  @override
  String get selectLanguage => 'Dil Seçin';

  @override
  String get selectCurrency => 'Para Birimi Seçin';

  @override
  String get currency => 'Para Birimi';

  @override
  String get turkish => 'Türkçe';

  @override
  String get english => 'İngilizce';

  @override
  String get incomeInfo => 'Gelir Bilgileri';

  @override
  String get dailyWorkHours => 'Günlük Çalışma Saati';

  @override
  String get weeklyWorkDays => 'Haftalık Çalışma Günü';

  @override
  String workingDaysPerWeek(int count) {
    return 'Haftada $count gün çalışıyorum';
  }

  @override
  String get hours => 'saat';

  @override
  String incomeSources(int count) {
    return '$count kaynak';
  }

  @override
  String get detailedEntry => 'Detaylı Giriş';

  @override
  String get googleAccount => 'Google Hesabı';

  @override
  String get googleLinked => 'Google Bağlandı';

  @override
  String get googleNotLinked => 'Google Bağlı Değil';

  @override
  String get linkWithGoogle => 'Google ile Bağla';

  @override
  String get linking => 'Bağlanıyor...';

  @override
  String get backupAndSecure => 'Verilerini yedekle ve güvende tut';

  @override
  String get dataNotBackedUp => 'Verileriniz yedeklenmemiş';

  @override
  String get googleLinkedSuccess => 'Google hesabı başarıyla bağlandı!';

  @override
  String get googleLinkFailed => 'Google hesabı bağlanamadı';

  @override
  String get appleAccount => 'Apple Hesabı';

  @override
  String get appleLinked => 'Apple Bağlandı';

  @override
  String get appleNotLinked => 'Apple Bağlı Değil';

  @override
  String get linkWithApple => 'Apple ile Bağla';

  @override
  String get profileAppleConnected => 'Apple Hesabı Bağlı';

  @override
  String get profileAppleNotConnected => 'Apple Hesabı Bağlı Değil';

  @override
  String get appleLinkedSuccess => 'Apple hesabı başarıyla bağlandı!';

  @override
  String get appleLinkFailed => 'Apple hesabı bağlanamadı';

  @override
  String get appleSignInNotAvailable =>
      'Apple ile giriş bu cihazda kullanılamıyor';

  @override
  String get editWorkHours => 'Çalışma Saati';

  @override
  String get editWorkHoursSubtitle =>
      'Zaman hesaplamaları için günlük çalışma saatiniz';

  @override
  String hoursPerDay(String hours) {
    return '$hours saat/gün';
  }

  @override
  String get workHoursUpdated => 'Çalışma saati güncellendi';

  @override
  String get freeCurrencyNote =>
      'Ücretsiz kullanıcılar sadece TL kullanabilir. Tüm para birimleri için Pro\'ya yükseltin.';

  @override
  String get currencyLockNote =>
      'Seçilen para birimi kilitlenecek. Pro kullanıcılar istediği zaman değiştirebilir.';

  @override
  String get welcome => 'Hoş geldin';

  @override
  String get welcomeSubtitle =>
      'Harcamalarını zamanla ölçmek için bilgilerini gir';

  @override
  String get getStarted => 'Başla';

  @override
  String get offlineMode => 'Çevrimdışı mod - Veriler senkronize edilecek';

  @override
  String get noInternet => 'İnternet Bağlantısı Yok';

  @override
  String get offline => 'Çevrimdışı';

  @override
  String get offlineMessage =>
      'Veriler bağlantı sağlandığında senkronize edilecek';

  @override
  String get backOnline => 'Tekrar Çevrimiçi';

  @override
  String get dataSynced => 'Veriler senkronize edildi';

  @override
  String get reports => 'Raporlar';

  @override
  String get monthlyReport => 'Aylık Rapor';

  @override
  String get categoryReport => 'Kategori Raporu';

  @override
  String get thisMonth => 'Bu Ay';

  @override
  String get lastMonth => 'Geçen Ay';

  @override
  String get thisWeek => 'Bu Hafta';

  @override
  String get allTime => 'Tüm Zamanlar';

  @override
  String get achievements => 'Başarılar';

  @override
  String get badges => 'Rozetler';

  @override
  String get progress => 'İlerleme';

  @override
  String get unlocked => 'Açıldı';

  @override
  String get locked => 'Kilitli';

  @override
  String get streak => 'Seri';

  @override
  String get currentStreak => 'Mevcut Seri';

  @override
  String get bestStreak => 'En İyi Seri';

  @override
  String streakDays(int count) {
    return '$count gün';
  }

  @override
  String get subscriptions => 'Abonelikler';

  @override
  String get subscriptionsDescription =>
      'Netflix, Spotify gibi düzenli aboneliklerini buradan takip et.';

  @override
  String get addSubscription => 'Abonelik Ekle';

  @override
  String get monthlyTotal => 'Aylık Toplam';

  @override
  String get yearlyTotal => 'Yıllık Toplam';

  @override
  String get nextPayment => 'Sonraki Ödeme';

  @override
  String renewalWarning(int days) {
    return '$days gün içinde yenileniyor';
  }

  @override
  String activeSubscriptions(int count) {
    return '$count aktif abonelik';
  }

  @override
  String get monthlySubscriptions => 'Aylık Abonelikler';

  @override
  String get habitCalculator => 'Alışkanlık Hesaplayıcı';

  @override
  String get selectHabit => 'Alışkanlık Seç';

  @override
  String get enterAmount => 'Miktar Gir';

  @override
  String get dailyAmount => 'Günlük Miktar';

  @override
  String get yearlyCost => 'Yıllık Maliyet';

  @override
  String get workDaysEquivalent => 'İş Günü Karşılığı';

  @override
  String get shareResult => 'Sonucu Paylaş';

  @override
  String get habitQuestion => 'Alışkanlığın kaç gününü alıyor?';

  @override
  String get calculateAndShock => 'Hesapla ve şok ol →';

  @override
  String get appTour => 'Uygulama Turu';

  @override
  String get repeatTour => 'Uygulama Turunu Tekrarla';

  @override
  String get tourCompleted => 'Tur Tamamlandı';

  @override
  String get notifications => 'Bildirimler';

  @override
  String get notificationSettings => 'Bildirimler';

  @override
  String get streakReminder => 'Seri Hatırlatıcı';

  @override
  String get weeklyInsights => 'Haftalık Bilgiler';

  @override
  String get error => 'Hata';

  @override
  String get success => 'Başarılı';

  @override
  String get warning => 'Uyarı';

  @override
  String get info => 'Bilgi';

  @override
  String get retry => 'Tekrar Dene';

  @override
  String get loading => 'Yükleniyor...';

  @override
  String get noData => 'Veri bulunamadı';

  @override
  String get noExpenses => 'Henüz harcama yok';

  @override
  String get noExpensesHint => 'Yukarıdan tutar girerek başla';

  @override
  String get noAchievements => 'Henüz başarı yok';

  @override
  String get recordToEarnBadge => 'Rozet kazanmak için kayıt yap';

  @override
  String get notEnoughDataForReports => 'Raporlar için yeterli veri yok';

  @override
  String get confirmDelete => 'Silmek istediğinizden emin misiniz?';

  @override
  String get deleteConfirmation => 'Bu işlem geri alınamaz.';

  @override
  String get categoryFood => 'Yiyecek';

  @override
  String get categoryTransport => 'Ulaşım';

  @override
  String get categoryEntertainment => 'Eğlence';

  @override
  String get categoryShopping => 'Alışveriş';

  @override
  String get categoryBills => 'Faturalar';

  @override
  String get categoryHealth => 'Sağlık';

  @override
  String get categoryEducation => 'Eğitim';

  @override
  String get categoryDigital => 'Dijital';

  @override
  String get categoryOther => 'Diğer';

  @override
  String get categoryClothing => 'Giyim';

  @override
  String get categoryElectronics => 'Elektronik';

  @override
  String get categorySubscription => 'Abonelik';

  @override
  String get weekdayMonday => 'Pazartesi';

  @override
  String get weekdayTuesday => 'Salı';

  @override
  String get weekdayWednesday => 'Çarşamba';

  @override
  String get weekdayThursday => 'Perşembe';

  @override
  String get weekdayFriday => 'Cuma';

  @override
  String get weekdaySaturday => 'Cumartesi';

  @override
  String get weekdaySunday => 'Pazar';

  @override
  String get shareTitle => 'Vantag ile tasarruflarıma göz at!';

  @override
  String shareMessage(String amount) {
    return 'Bu ay Vantag ile $amount TL tasarruf ettim!';
  }

  @override
  String get currencyRates => 'Döviz Kurları';

  @override
  String get currencyRatesDescription =>
      'Güncel USD, EUR ve altın fiyatları. Tıklayarak detaylı bilgi alabilirsin.';

  @override
  String get gold => 'Altın';

  @override
  String get dollar => 'Dolar';

  @override
  String get euro => 'Euro';

  @override
  String get moneySavedInPocket => 'Para cebinde kaldı!';

  @override
  String get greatDecision => 'Harika karar!';

  @override
  String freedomCloser(String hours) {
    return 'Para cebinde kaldı, özgürlüğüne $hours daha yakınsın!';
  }

  @override
  String get version => 'Sürüm';

  @override
  String get privacyPolicy => 'Gizlilik Politikası';

  @override
  String get termsOfService => 'Kullanım Şartları';

  @override
  String get about => 'Hakkında';

  @override
  String get dangerZone => 'Tehlikeli Bölge';

  @override
  String get appVersion => 'Uygulama Sürümü';

  @override
  String get signOut => 'Çıkış Yap';

  @override
  String get deleteAccount => 'Hesabımı Sil';

  @override
  String get greetingMorning => 'Günaydın';

  @override
  String get greetingAfternoon => 'İyi günler';

  @override
  String get greetingEvening => 'İyi akşamlar';

  @override
  String get financialStatus => 'Finansal Durum';

  @override
  String get financialSummary => 'Finansal Özet';

  @override
  String get financialSummaryDescription =>
      'Aylık gelirin, harcamaların ve kurtardığın para burada. Tüm veriler anlık güncellenir.';

  @override
  String get newExpense => 'Yeni Harcama';

  @override
  String get editExpense => 'Harcama Düzenle';

  @override
  String get deleteExpense => 'Harcamayı Sil';

  @override
  String get deleteExpenseConfirm =>
      'Bu harcamayı silmek istediğine emin misin?';

  @override
  String get updateExpense => 'Güncelle';

  @override
  String get expenseHistory => 'Geçmiş';

  @override
  String recordCount(int count) {
    return '$count kayıt';
  }

  @override
  String recordCountLimited(int shown, int total) {
    return '$total kayıttan $shown tanesi';
  }

  @override
  String get unlockFullHistory => 'Tam Geçmişi Aç';

  @override
  String proHistoryDescription(int count) {
    return 'Ücretsiz kullanıcılar son 30 günü görebilir. Sınırsız geçmiş için Pro\'ya yükseltin.';
  }

  @override
  String get upgradeToPro => 'Pro\'ya Yükselt';

  @override
  String get streakTracking => 'Seri Takibi';

  @override
  String get streakTrackingDescription =>
      'Her gün harcama girdiğinde serin artar. Düzenli takip bilinçli harcamanın anahtarı!';

  @override
  String get pastDateSelection => 'Geçmiş Tarih Seçimi';

  @override
  String get pastDateSelectionDescription =>
      'Dün veya önceki günlerin harcamalarını da girebilirsin. Takvim ikonuna tıklayarak istediğin tarihi seç.';

  @override
  String get amountEntry => 'Tutar Girişi';

  @override
  String get amountEntryDescription =>
      'Harcama tutarını buraya gir. Fiş tarama butonu ile fişten otomatik okuyabilirsin.';

  @override
  String get smartMatching => 'Akıllı Eşleştirme';

  @override
  String get smartMatchingDescription =>
      'Mağaza veya ürün adını yaz. Migros, A101, Starbucks gibi... Uygulama otomatik olarak kategori önericek!';

  @override
  String get categorySelection => 'Kategori Seçimi';

  @override
  String get categorySelectionDescription =>
      'Akıllı eşleştirme bulamazsa veya düzeltmek istersen buradan manuel seçim yapabilirsin.';

  @override
  String get selectCategory => 'Kategori Seçin';

  @override
  String autoSelected(String category) {
    return 'Otomatik seçildi: $category';
  }

  @override
  String get pleaseSelectCategory => 'Lütfen bir kategori seçin';

  @override
  String get subCategoryOptional => 'Alt kategori (opsiyonel)';

  @override
  String get recentlyUsed => 'Son kullanılanlar';

  @override
  String get suggestions => 'Öneriler';

  @override
  String get scanReceipt => 'Fiş tara';

  @override
  String get cameraCapture => 'Kamera ile çek';

  @override
  String get selectFromGallery => 'Galeriden seç';

  @override
  String amountFound(String amount) {
    return 'Tutar bulundu: $amount ₺';
  }

  @override
  String get amountNotFound => 'Tutar bulunamadı. Manuel girin.';

  @override
  String get scanError => 'Tarama hatası. Tekrar deneyin.';

  @override
  String get selectExpenseDate => 'Harcama Tarihi Seçin';

  @override
  String get decisionUpdatedBought => 'Karar güncellendi: Aldın';

  @override
  String decisionSaved(String amount) {
    return 'Vazgeçtin, $amount TL kurtardın!';
  }

  @override
  String get keepThinking => 'Düşünmeye devam';

  @override
  String get expenseUpdated => 'Harcama güncellendi';

  @override
  String get validationEnterAmount => 'Lütfen geçerli bir tutar girin';

  @override
  String get validationAmountPositive => 'Tutar 0\'dan büyük olmalı';

  @override
  String get validationAmountTooHigh => 'Tutar çok yüksek görünüyor';

  @override
  String get simulationSaved => 'Simülasyon Olarak Kaydedildi';

  @override
  String get simulationDescription =>
      'Bu tutar büyük olduğu için simülasyon olarak kaydedildi.';

  @override
  String get simulationInfo =>
      'İstatistiklerini etkilemez, sadece fikir vermek için.';

  @override
  String get understood => 'Anladım';

  @override
  String get largeAmountTitle => 'Büyük Tutar';

  @override
  String get largeAmountMessage =>
      'Bu gerçek bir harcama mı, yoksa simülasyon mu?';

  @override
  String get realExpenseButton => 'Gerçek Harcama';

  @override
  String get simulationButton => 'Simülasyon';

  @override
  String get monthJanuary => 'Ocak';

  @override
  String get monthFebruary => 'Şubat';

  @override
  String get monthMarch => 'Mart';

  @override
  String get monthApril => 'Nisan';

  @override
  String get monthJune => 'Haziran';

  @override
  String get monthJuly => 'Temmuz';

  @override
  String get monthAugust => 'Ağustos';

  @override
  String get monthSeptember => 'Eylül';

  @override
  String get monthOctober => 'Ekim';

  @override
  String get monthNovember => 'Kasım';

  @override
  String get monthDecember => 'Aralık';

  @override
  String get categoryDistribution => 'Kategori Dağılımı';

  @override
  String moreCategories(int count) {
    return '+$count kategori daha';
  }

  @override
  String get expenseCount => 'Harcama Sayısı';

  @override
  String boughtPassed(int bought, int passed) {
    return '$bought alındı, $passed vazgeçildi';
  }

  @override
  String get passRate => 'Vazgeçme Oranı';

  @override
  String get doingGreat => 'Harika gidiyorsun!';

  @override
  String get canDoBetter => 'Daha iyisini yapabilirsin';

  @override
  String get statistics => 'İstatistikler';

  @override
  String get avgDailyExpense => 'Ortalama Günlük Harcama';

  @override
  String get highestSingleExpense => 'En Yüksek Tek Harcama';

  @override
  String get mostDeclinedCategory => 'En Çok Vazgeçilen Kategori';

  @override
  String times(int count) {
    return '$count kez';
  }

  @override
  String get trend => 'Trend';

  @override
  String trendSpentThisPeriod(String amount, String period) {
    return 'Bu $period $amount TL harcadın';
  }

  @override
  String trendSameAsPrevious(String period) {
    return 'Geçen $period göre aynı harcama yaptın';
  }

  @override
  String trendSpentLess(String percent, String period) {
    return 'Geçen $period göre %$percent daha az harcadın';
  }

  @override
  String trendSpentMore(String percent, String period) {
    return 'Geçen $period göre %$percent daha fazla harcadın';
  }

  @override
  String get periodWeek => 'hafta';

  @override
  String get periodMonth => 'ay';

  @override
  String get subCategoryDetail => 'Alt Kategori Detayı';

  @override
  String get comparedToPrevious => 'Önceki döneme kıyasla';

  @override
  String get increased => 'arttı';

  @override
  String get decreased => 'azaldı';

  @override
  String subCategoryChange(
    String period,
    String subCategory,
    String changeText,
    String percent,
    String previousPeriod,
  ) {
    return '$period $subCategory harcaman $previousPeriod göre %$percent $changeText.';
  }

  @override
  String get listView => 'Liste Görünümü';

  @override
  String get calendarView => 'Takvim Görünümü';

  @override
  String get subscription => 'abonelik';

  @override
  String get workDaysPerMonth => 'iş günü/ay';

  @override
  String everyMonthDay(int day) {
    return 'Her ayın $day\'i';
  }

  @override
  String get noSubscriptionsYet => 'Henüz abonelik yok';

  @override
  String get addSubscriptionsLikeNetflix =>
      'Netflix, Spotify gibi aboneliklerini ekle';

  @override
  String monthlyTotalAmount(String amount) {
    return 'Aylık toplam: $amount TL';
  }

  @override
  String dayOfMonth(int day) {
    return 'Ayın $day. günü';
  }

  @override
  String get addSubscriptionHint => 'Yeni abonelik eklemek için + butonuna bas';

  @override
  String get tomorrow => 'Yarın';

  @override
  String daysLater(int days) {
    return '$days gün sonra';
  }

  @override
  String get perMonth => '/ay';

  @override
  String get enterSubscriptionName => 'Abonelik adı girin';

  @override
  String get enterValidAmount => 'Geçerli bir tutar girin';

  @override
  String get editSubscription => 'Aboneliği Düzenle';

  @override
  String get newSubscription => 'Yeni Abonelik';

  @override
  String get subscriptionName => 'Abonelik Adı';

  @override
  String get subscriptionNameHint => 'Netflix, Spotify...';

  @override
  String get monthlyAmount => 'Aylık Tutar';

  @override
  String get renewalDay => 'Yenileme Günü';

  @override
  String get active => 'Aktif';

  @override
  String get passivesNotIncluded => 'Pasifler bildirimlere dahil edilmez';

  @override
  String get autoRecord => 'Otomatik Kayıt';

  @override
  String get autoRecordDescription =>
      'Harcama fatura tarihinde otomatik eklenecek';

  @override
  String get add => 'Ekle';

  @override
  String subscriptionCount(int count, String amount) {
    return '$count abonelik, $amount ₺/ay';
  }

  @override
  String get viewSubscriptionsInCalendar => 'Aboneliklerini takvimde gör';

  @override
  String get urgentRenewalWarning => 'Acil Yenileme Uyarısı!';

  @override
  String get upcomingRenewals => 'Yaklaşan Yenilemeler';

  @override
  String renewsWithinOneHour(String name) {
    return '$name - 1 saat içinde yenilenecek';
  }

  @override
  String renewsWithinHours(String name, int hours) {
    return '$name - $hours saat içinde';
  }

  @override
  String renewsToday(String name) {
    return '$name - Bugün yenilenecek';
  }

  @override
  String renewsTomorrow(String name) {
    return '$name - Yarın yenilenecek';
  }

  @override
  String subscriptionsRenewingSoon(int count) {
    return '$count abonelik yakında yenilenecek';
  }

  @override
  String amountPerMonth(String amount) {
    return '$amount ₺/ay';
  }

  @override
  String get hiddenBadges => 'Gizli Rozetler';

  @override
  String badgesEarned(int unlocked, int total) {
    return '$unlocked / $total rozet kazandın';
  }

  @override
  String percentComplete(String percent) {
    return '%$percent tamamlandı';
  }

  @override
  String get completed => 'Tamamlandı!';

  @override
  String get startRecordingForFirstBadge =>
      'İlk rozetini kazanmak için harcama kaydet!';

  @override
  String get greatStartKeepGoing => 'Harika bir başlangıç, devam et!';

  @override
  String get halfwayThere => 'Yarı yola geldin, böyle devam!';

  @override
  String get doingVeryWell => 'Çok iyi gidiyorsun!';

  @override
  String get almostDone => 'Neredeyse tamamladın!';

  @override
  String get allBadgesEarned => 'Tüm rozetleri kazandın, tebrikler!';

  @override
  String get hiddenBadge => 'Gizli Rozet';

  @override
  String get discoverHowToUnlock => 'Nasıl açılacağını keşfet!';

  @override
  String get difficultyEasy => 'Kolay';

  @override
  String get difficultyMedium => 'Orta';

  @override
  String get difficultyHard => 'Zor';

  @override
  String get difficultyLegendary => 'Efsanevi';

  @override
  String get earnedToday => 'Bugün kazandın!';

  @override
  String get earnedYesterday => 'Dün kazandın';

  @override
  String daysAgoEarned(int count) {
    return '$count gün önce';
  }

  @override
  String weeksAgoEarned(int count) {
    return '$count hafta önce';
  }

  @override
  String get tapToAddPhoto => 'Fotoğraf eklemek için dokun';

  @override
  String get dailyWork => 'Günlük Çalışma';

  @override
  String get weeklyWorkingDays => 'Haftalık Çalışma Günleri';

  @override
  String get hourlyEarnings => 'Saatlik Kazanç';

  @override
  String get hourAbbreviation => 'sa';

  @override
  String get days => 'gün';

  @override
  String get resetData => 'Verileri Sıfırla';

  @override
  String get resetDataDebug => 'Verileri Sıfırla (DEBUG)';

  @override
  String get resetDataTitle => 'Verileri Sıfırla';

  @override
  String get resetDataMessage =>
      'Tüm uygulama verileri silinecek. Bu işlem geri alınamaz.';

  @override
  String get deleteAccountWarningTitle => 'Hesabınızı Silmek Üzeresiniz';

  @override
  String get deleteAccountWarningMessage =>
      'Bu işlem geri alınamaz! Tüm verileriniz kalıcı olarak silinecektir:\n\n• Harcamalar\n• Gelirler\n• Taksitler\n• Başarımlar\n• Ayarlar';

  @override
  String get deleteAccountConfirmPlaceholder =>
      'Onaylamak için \'Onaylıyorum\' yazın';

  @override
  String get deleteAccountConfirmWord => 'Onaylıyorum';

  @override
  String get deleteAccountButton => 'Hesabı Sil';

  @override
  String get deleteAccountSuccess => 'Hesabınız başarıyla silindi';

  @override
  String get deleteAccountError => 'Hesap silinirken bir hata oluştu';

  @override
  String get notificationTypes => 'Bildirim Türleri';

  @override
  String get awarenessReminder => 'Farkındalık Hatırlatması';

  @override
  String get awarenessReminderDesc =>
      'Yüksek tutarlı alımlardan 6-12 saat sonra';

  @override
  String get giveUpCongrats => 'Vazgeçme Tebriği';

  @override
  String get giveUpCongratsDesc => 'Vazgeçtiğinde aynı gün motivasyon';

  @override
  String get streakReminderDesc => 'Akşam, seri kırılmadan önce';

  @override
  String get weeklySummary => 'Haftalık Özet';

  @override
  String get weeklySummaryDesc => 'Pazar günü haftalık içgörü';

  @override
  String get nightModeNotice =>
      'Gece saatlerinde (22:00-08:00) bildirim gönderilmez. Uykunu bozmayız.';

  @override
  String get on => 'Açık';

  @override
  String get off => 'Kapalı';

  @override
  String get lastUpdate => 'Son Güncelleme';

  @override
  String get rates => 'Kurlar';

  @override
  String get usDollar => 'ABD Doları';

  @override
  String get gramGold => 'Gram Altın';

  @override
  String get tcmbNotice =>
      'Kurlar TCMB (Türkiye Cumhuriyet Merkez Bankası) verilerinden alınmaktadır. Altın fiyatları anlık piyasa verilerini yansıtır.';

  @override
  String get buy => 'Alış';

  @override
  String get sell => 'Satış';

  @override
  String get createOwnCategory => 'Kendi Kategorini Oluştur';

  @override
  String get selectEmoji => 'Emoji Seç';

  @override
  String get categoryName => 'Kategori Adı';

  @override
  String get categoryNameHint => 'Örn: Starbucks';

  @override
  String get continueButton => 'Devam Et';

  @override
  String get howManyDaysForHabit => 'Ne için kaç gün çalışıyorsun?';

  @override
  String get selectHabitShock => 'Bir alışkanlık seç, şok ol';

  @override
  String get addMyOwnCategory => 'Kendi kategorimi ekle';

  @override
  String get whatIsYourSalary => 'Aylık Maaşın Ne Kadar?';

  @override
  String get enterNetAmount => 'Net ele geçen tutarı gir';

  @override
  String get howMuchPerTime => 'Bir seferinde kaç TL harcıyorsun?';

  @override
  String get tl => 'TL';

  @override
  String get howOften => 'Ne sıklıkta?';

  @override
  String get whatIsYourIncome => 'Aylık gelirin ne kadar?';

  @override
  String get exampleAmount => 'örn: 20.000';

  @override
  String get dontWantToSay => 'Söylemek istemiyorum';

  @override
  String resultDays(String value) {
    return '$value GÜN';
  }

  @override
  String yearlyHabitCost(String habit) {
    return 'Yılda sadece $habit için\nbu kadar çalışıyorsun';
  }

  @override
  String monthlyYearlyCost(String monthly, String yearly) {
    return 'Aylık: $monthly • Yıllık: $yearly';
  }

  @override
  String get shareOnStory => 'Hikayemde Paylaş';

  @override
  String get tryAnotherHabit => 'Başka alışkanlık dene';

  @override
  String get trackAllExpenses => 'Tüm harcamalarımı takip et';

  @override
  String get habitCatCoffee => 'Kahve';

  @override
  String get habitCatSmoking => 'Sigara';

  @override
  String get habitCatEatingOut => 'Dışarıda Yemek';

  @override
  String get habitCatGaming => 'Oyun/Eğlence';

  @override
  String get habitCatClothing => 'Kıyafet';

  @override
  String get habitCatTaxi => 'Taksi/Uber';

  @override
  String get freqOnceDaily => 'Günde 1';

  @override
  String get freqTwiceDaily => 'Günde 2';

  @override
  String get freqEveryTwoDays => '2 günde 1';

  @override
  String get freqOnceWeekly => 'Haftada 1';

  @override
  String get freqTwoThreeWeekly => 'Haftada 2-3';

  @override
  String get freqFewMonthly => 'Ayda birkaç';

  @override
  String get habitSharePreText => 'Bu alışkanlık yılda';

  @override
  String get habitShareWorkDays => 'İŞ GÜNÜ';

  @override
  String get habitSharePostText => 'çalışmana eşdeğer';

  @override
  String get habitSharePerYear => '/yıl';

  @override
  String get habitShareCTA => 'Senin alışkanlıkların kaç gün?';

  @override
  String get habitShareText => 'Senin alışkanlıkların kaç gün? 👀 vantag.app';

  @override
  String habitShareTextWithLink(String link) {
    return 'Senin alışkanlıkların kaç gün? 👀 $link';
  }

  @override
  String habitMonthlyDetail(int days, int hours) {
    return '$days gün $hours saat';
  }

  @override
  String get editIncomes => 'Gelirleri Düzenle';

  @override
  String get editIncome => 'Gelir Düzenle';

  @override
  String get addIncome => 'Gelir Ekle';

  @override
  String get changePhoto => 'Fotoğraf';

  @override
  String get takePhoto => 'Fotoğraf Çek';

  @override
  String get chooseFromGallery => 'Galeriden Seç';

  @override
  String get removePhoto => 'Fotoğrafı Kaldır';

  @override
  String get photoSelectError => 'Fotoğraf seçilemedi';

  @override
  String get editSalary => 'Maaş';

  @override
  String get editSalarySubtitle => 'Aylık maaşınızı güncelleyin';

  @override
  String get daysPerWeek => 'gün/hafta';

  @override
  String get doYouHaveOtherIncome => 'Başka Bir Gelirin\nVar mı?';

  @override
  String get otherIncomeDescription =>
      'Freelance, kira, yatırım geliri gibi\nek gelirlerini de ekleyebilirsin';

  @override
  String get yesAddIncome => 'Evet, Eklemek İstiyorum';

  @override
  String get noOnlySalary => 'Hayır, Sadece Maaşım Var';

  @override
  String get addAdditionalIncome => '+ Ek Gelir Ekle';

  @override
  String get additionalIncomeQuestion => 'Ek Geliriniz Var mı?';

  @override
  String get budgetSettings => 'Bütçe Ayarları';

  @override
  String get budgetSettingsHint =>
      'İsteğe bağlı. Belirlemezseniz gelirinize göre hesaplanır.';

  @override
  String get monthlySpendingLimit => 'Aylık Harcama Limiti';

  @override
  String get monthlySpendingLimitHint =>
      'Bu ay maksimum ne kadar harcamak istiyorsunuz?';

  @override
  String get monthlySavingsGoal => 'Aylık Tasarruf Hedefi';

  @override
  String get monthlySavingsGoalHint =>
      'Her ay ne kadar biriktirmek istiyorsunuz?';

  @override
  String get budgetInfoMessage =>
      'Progress bar, zorunlu giderler düşüldükten sonra kalan bütçenize göre hesaplanır.';

  @override
  String get linkWithGoogleTitle => 'Google ile Bağla';

  @override
  String get linkWithGoogleDescription =>
      'Verilerinize tüm cihazlardan güvenle erişin';

  @override
  String get skipForNow => 'Şimdilik geç';

  @override
  String get incomeType => 'Gelir türü';

  @override
  String get incomeCategorySalary => 'Maaş';

  @override
  String get incomeCategoryFreelance => 'Freelance';

  @override
  String get incomeCategoryRental => 'Kira Geliri';

  @override
  String get incomeCategoryPassive => 'Pasif Gelir';

  @override
  String get incomeCategoryOther => 'Diğer';

  @override
  String get incomeCategorySalaryDesc => 'Aylık düzenli maaş';

  @override
  String get incomeCategoryFreelanceDesc => 'Serbest çalışma gelirleri';

  @override
  String get incomeCategoryRentalDesc => 'Ev, araba vb. kira gelirleri';

  @override
  String get incomeCategoryPassiveDesc => 'Yatırım, temettü, faiz vb.';

  @override
  String get incomeCategoryOtherDesc => 'Diğer gelir kaynakları';

  @override
  String get mainSalary => 'Ana Maaş';

  @override
  String get descriptionOptional => 'Açıklama (Opsiyonel)';

  @override
  String get descriptionOptionalHint => 'Örn: Upwork Projesi';

  @override
  String get addedIncomes => 'Eklenen Gelirler';

  @override
  String get incomeSummary => 'Gelir Özeti';

  @override
  String get totalMonthlyIncome => 'Toplam Aylık Gelir';

  @override
  String get incomeSource => 'gelir kaynağı';

  @override
  String get complete => 'Tamamla';

  @override
  String get editMyIncomes => 'Gelirlerimi Düzenle';

  @override
  String get goBack => 'Geri Dön';

  @override
  String get notBudgetApp => 'Bu bir bütçe uygulaması değil';

  @override
  String get showRealCost => 'Harcamalarının gerçek bedelini göster: zamanın.';

  @override
  String get everyExpenseDecision => 'Her harcama bir karar';

  @override
  String get youDecide => 'Aldım, düşünüyorum veya vazgeçtim. Sen seç.';

  @override
  String get oneExpenseEnough => 'Bugün tek bir harcama yeter';

  @override
  String get startSmall => 'Küçük başla, farkındalık büyür.';

  @override
  String get skip => 'Atla';

  @override
  String get start => 'Başla';

  @override
  String get whatIsYourDecision => 'Kararın nedir?';

  @override
  String get netBalance => 'NET BAKİYE';

  @override
  String sources(int count) {
    return '$count kaynak';
  }

  @override
  String get income => 'GELİR';

  @override
  String get expense => 'GİDER';

  @override
  String get saved => 'KURTARILAN';

  @override
  String get budgetUsage => 'BÜTÇE KULLANIMI';

  @override
  String get startToday => 'Bugün başla!';

  @override
  String dayStreak(int count) {
    return '$count Günlük Seri!';
  }

  @override
  String get startStreak => 'Seriye Başla!';

  @override
  String get keepStreakMessage => 'Her gün harcama kaydederek serini sürdür!';

  @override
  String get startStreakMessage =>
      'Her gün en az 1 harcama kaydet ve seri oluştur!';

  @override
  String longestStreak(int count) {
    return 'En uzun seri: $count gün';
  }

  @override
  String get newRecord => 'Yeni Rekor!';

  @override
  String withThisAmount(String amount) {
    return 'Bu $amount TL ile şunları alabilirdin:';
  }

  @override
  String goldGrams(String grams) {
    return '${grams}g altın';
  }

  @override
  String get ratesLoading => 'Kurlar yükleniyor...';

  @override
  String get ratesLoadFailed => 'Kurlar yüklenemedi';

  @override
  String get goldPriceNotUpdated => 'Altın fiyatı güncellenemedi';

  @override
  String get monthAbbreviations =>
      'Oca,Şub,Mar,Nis,May,Haz,Tem,Ağu,Eyl,Eki,Kas,Ara';

  @override
  String get updateYourDecision => 'Kararını güncelle';

  @override
  String get simulation => 'Simülasyon';

  @override
  String get tapToUpdate => 'Dokunarak güncelle';

  @override
  String get swipeToEditOrDelete => 'Kaydırarak düzenle veya sil';

  @override
  String get pleaseEnterValidAmount => 'Lütfen geçerli bir tutar girin';

  @override
  String get amountTooHigh => 'Tutar çok yüksek görünüyor';

  @override
  String get pleaseSelectExpenseGroup => 'Lütfen önce harcama grubunu belirle';

  @override
  String get categorySelectionRequired => 'Kategori seçimi zorunludur';

  @override
  String get expenseGroup => 'Harcama Grubu';

  @override
  String get required => 'Zorunlu';

  @override
  String get detail => 'Detay';

  @override
  String get optional => 'Opsiyonel';

  @override
  String get editYourCard => 'Kartını Düzenle';

  @override
  String get share => 'Paylaş';

  @override
  String get sharing => 'Paylaşılıyor...';

  @override
  String get frequency => 'Sıklık';

  @override
  String get daysAbbrev => 'gün';

  @override
  String get youSaved => 'kurtardın!';

  @override
  String get noSavingsYet => 'Henüz kurtarılan yok';

  @override
  String get categorySports => 'Spor';

  @override
  String get categoryCommunication => 'Haberleşme';

  @override
  String get subscriptionNameExample => 'Örn: Netflix, Spotify';

  @override
  String get monthlyAmountExample => 'Örn: 99,99';

  @override
  String get color => 'Renk';

  @override
  String get autoRecordOnRenewal => 'Yenileme gününde harcama olarak kaydet';

  @override
  String get deleteSubscription => 'Aboneliği Sil';

  @override
  String deleteSubscriptionConfirm(String name) {
    return '$name aboneliğini silmek istediğine emin misin?';
  }

  @override
  String get subscriptionDuration => 'Abone Süresi';

  @override
  String subscriptionDurationDays(int days) {
    return '$days gün';
  }

  @override
  String get totalPaid => 'Toplam Ödenen';

  @override
  String workHoursAmount(String hours) {
    return '$hours saat';
  }

  @override
  String workDaysAmount(String days) {
    return '$days gün';
  }

  @override
  String get autoRecordEnabled => 'Otomatik kayıt açık';

  @override
  String get autoRecordDisabled => 'Otomatik harcama kaydı kapalı';

  @override
  String get saveChanges => 'Değişiklikleri Kaydet';

  @override
  String get weekdayAbbreviations => 'Pzt,Sal,Çar,Per,Cum,Cmt,Paz';

  @override
  String get homePage => 'Ana Sayfa';

  @override
  String get analysis => 'Analiz';

  @override
  String get reportsDescription =>
      'Aylık ve kategorilere göre harcama analizlerini buradan görüntüle.';

  @override
  String get quickAdd => 'Hızlı Ekleme';

  @override
  String get quickAddDescription =>
      'Her yerden hızlıca harcama eklemek için bu butonu kullan. Pratik ve hızlı!';

  @override
  String get badgesDescription =>
      'Tasarruf hedeflerine ulaştıkça rozetler kazan. Motivasyonunu yüksek tut!';

  @override
  String get profileAndSettings => 'Profil & Ayarlar';

  @override
  String get profileAndSettingsDescription =>
      'Gelir bilgilerini düzenle, bildirim tercihlerini yönet ve uygulama ayarlarına eriş.';

  @override
  String get addSubscriptionButton =>
      'Netflix, Spotify gibi aboneliklerini ekle';

  @override
  String get shareError => 'Paylaşım sırasında bir hata oluştu';

  @override
  String get shareVia => 'Paylaş';

  @override
  String get saveToGallery => 'Galeriye Kaydet';

  @override
  String get savedToGallery => 'Galeriye kaydedildi';

  @override
  String get otherApps => 'Diğer Uygulamalar';

  @override
  String get expenseDeleted => 'Harcama silindi';

  @override
  String get undo => 'Geri Al';

  @override
  String get choosePlatform => 'Platform Seç';

  @override
  String get savingToGallery => 'Kaydediliyor...';

  @override
  String get pleaseEnterValidSalary => 'Lütfen geçerli bir maaş girin';

  @override
  String get pleaseEnterValidIncomeAmount => 'Lütfen geçerli bir tutar girin';

  @override
  String get atLeastOneIncomeRequired =>
      'En az bir gelir kaynağı eklemelisiniz';

  @override
  String get incomesUpdated => 'Gelirler güncellendi';

  @override
  String get incomesSaved => 'Gelirler kaydedildi';

  @override
  String get saveError => 'Kaydetme sırasında bir hata oluştu';

  @override
  String incomeSourceCount(int count) {
    return '$count gelir kaynağı';
  }

  @override
  String get freedTime => 'Özgürleştin';

  @override
  String get savedAmountLabel => 'Kurtarılan';

  @override
  String get dayLabel => 'Gün';

  @override
  String get zeroMinutes => '0 Dakika';

  @override
  String get zeroAmount => '0 ₺';

  @override
  String shareCardDays(int days) {
    return '$days GÜN';
  }

  @override
  String shareCardDescription(String category) {
    return 'Yılda sadece $category için\nbu kadar çalışıyorum';
  }

  @override
  String get shareCardQuestion => 'Sen kaç gün? 👀';

  @override
  String shareCardDuration(int days) {
    return 'Süre ($days gün)';
  }

  @override
  String shareCardAmountLabel(String amount) {
    return 'Tutar (₺$amount)';
  }

  @override
  String shareCardFrequency(String frequency) {
    return 'Sıklık ($frequency)';
  }

  @override
  String get unsavedChanges => 'Kaydedilmemiş Değişiklikler';

  @override
  String get unsavedChangesConfirm =>
      'Değişiklikleri kaydetmeden çıkmak istediğine emin misin?';

  @override
  String get discardChanges => 'Kaydetme';

  @override
  String get thinkingTime => 'Düşünme süresi...';

  @override
  String get confirm => 'Onayla';

  @override
  String get riskLevelNone => 'Güvenli';

  @override
  String get riskLevelLow => 'Düşük Risk';

  @override
  String get riskLevelMedium => 'Orta Risk';

  @override
  String get riskLevelHigh => 'Yüksek Risk';

  @override
  String get riskLevelExtreme => 'Kritik Risk';

  @override
  String savedTimeHoursDays(String hours, String days) {
    return '$hours saat = $days gün kazandın';
  }

  @override
  String savedTimeHours(String hours) {
    return '$hours saat kazandın';
  }

  @override
  String savedTimeMinutes(int minutes) {
    return '$minutes dakika kazandın';
  }

  @override
  String couldBuyGoldGrams(String grams) {
    return 'Bu parayla $grams gram altın alabilirdin';
  }

  @override
  String equivalentWorkDays(String days) {
    return 'Bu $days gün çalışmana eşdeğer';
  }

  @override
  String equivalentWorkHours(String hours) {
    return 'Bu $hours saat çalışmana eşdeğer';
  }

  @override
  String savedDollars(String amount) {
    return 'Tam $amount dolar biriktirdin';
  }

  @override
  String get or => 'VEYA';

  @override
  String goldGramsShort(String grams) {
    return '${grams}g altın';
  }

  @override
  String get amountRequired => 'Tutar gerekli';

  @override
  String get everyMonth => 'Her ay';

  @override
  String daysCount(int count) {
    return '$count gün';
  }

  @override
  String hoursCount(String count) {
    return '$count saat';
  }

  @override
  String daysCountDecimal(String count) {
    return '$count gün';
  }

  @override
  String get autoRecordOn => 'Otomatik kayıt açık';

  @override
  String get autoRecordOff => 'Otomatik kayıt kapalı';

  @override
  String monthlyAmountTl(String amount) {
    return '$amount TL/ay';
  }

  @override
  String get nameRequired => 'İsim gerekli';

  @override
  String get amountHint => 'Örn: 99,99';

  @override
  String get updateDecision => 'Kararını güncelle';

  @override
  String get categoryRequired => 'Kategori gerekli';

  @override
  String get monthlyAmountLabel => 'Aylık Tutar (TL)';

  @override
  String withThisAmountYouCouldBuy(String amount) {
    return '$amount TL ile şunları alabilirdin:';
  }

  @override
  String get workHoursDistribution => 'Çalışma Saati Dağılımı';

  @override
  String get workHoursDistributionDesc =>
      'Her kategori için kaç saat çalıştığını gör';

  @override
  String hoursShort(String hours) {
    return '${hours}s';
  }

  @override
  String categoryHoursBar(String hours, String percent) {
    return '$hours saat (%$percent)';
  }

  @override
  String get monthComparison => 'Ay Karşılaştırması';

  @override
  String get vsLastMonth => 'Geçen Aya Göre';

  @override
  String get noLastMonthData => 'Geçen ay verisi yok';

  @override
  String decreasedBy(String percent) {
    return '↓ %$percent azaldı';
  }

  @override
  String increasedBy(String percent) {
    return '↑ %$percent arttı';
  }

  @override
  String get noChange => 'Değişim yok';

  @override
  String get greatProgress => 'Harika ilerleme!';

  @override
  String get watchOut => 'Dikkat!';

  @override
  String get smartInsights => 'Akıllı Bilgiler';

  @override
  String get mostExpensiveDay => 'En Pahalı Gün';

  @override
  String mostExpensiveDayValue(String day, String amount) {
    return '$day (ort. $amount TL)';
  }

  @override
  String get mostPassedCategory => 'En Çok Vazgeçilen';

  @override
  String mostPassedCategoryValue(String category, int count) {
    return '$category ($count kez)';
  }

  @override
  String get savingsOpportunity => 'Tasarruf Fırsatı';

  @override
  String savingsOpportunityValue(String category, String hours) {
    return '$category\'i %20 azalt = ayda ${hours}s kazan';
  }

  @override
  String get weeklyTrend => 'Haftalık Trend';

  @override
  String weeklyTrendValue(String trend) {
    return 'Son 4 hafta: $trend';
  }

  @override
  String get overallDecreasing => 'Genel düşüş';

  @override
  String get overallIncreasing => 'Genel artış';

  @override
  String get stableTrend => 'Stabil';

  @override
  String get noTrendData => 'Yeterli veri yok';

  @override
  String get yearlyView => 'Yıllık Görünüm';

  @override
  String get yearlyHeatmap => 'Harcama Trendi';

  @override
  String get yearlyHeatmapDesc => 'Son 12 ayın aylık harcama trendi';

  @override
  String get lowSpending => 'Az';

  @override
  String get highSpending => 'Çok';

  @override
  String get noSpending => 'Harcama yok';

  @override
  String get tapDayForDetails => 'Detay için güne dokun';

  @override
  String get tapMonthForDetails => 'Detay için aya dokun';

  @override
  String selectedDayExpenses(String date, String amount, int count) {
    return '$date: $amount TL ($count harcama)';
  }

  @override
  String selectedMonthExpenses(String month, String amount, int count) {
    return '$month: $amount ($count harcama)';
  }

  @override
  String get proBadge => 'PRO';

  @override
  String get proFeature => 'Pro Özellik';

  @override
  String get comingSoon => 'Yakında';

  @override
  String get mindfulChoice => 'Bilinçli Tercih';

  @override
  String get mindfulChoiceExpandedDesc => 'Aslında ne almayı planlamıştın?';

  @override
  String get mindfulChoiceCollapsedDesc =>
      'Aslında daha pahalısını mı alacaktın?';

  @override
  String get mindfulChoiceAmountLabel => 'Aklındaki Tutar (₺)';

  @override
  String mindfulChoiceAmountHint(String amount) {
    return 'Örn: $amount';
  }

  @override
  String mindfulChoiceSavings(String amount) {
    return '$amount TL tasarruf';
  }

  @override
  String get mindfulChoiceSavingsDesc => 'Bilinçli tercih ile cebinde kalıyor';

  @override
  String get tierBronze => 'Bronz';

  @override
  String get tierSilver => 'Gümüş';

  @override
  String get tierGold => 'Altın';

  @override
  String get tierPlatinum => 'Platin';

  @override
  String get achievementCategoryStreak => 'Seri';

  @override
  String get achievementCategorySavings => 'Tasarruf';

  @override
  String get achievementCategoryDecision => 'Karar';

  @override
  String get achievementCategoryRecord => 'Kayıt';

  @override
  String get achievementCategoryHidden => 'Gizli';

  @override
  String get achievementStreakB1Title => 'Başlangıç';

  @override
  String get achievementStreakB1Desc => '3 gün üst üste kayıt yap';

  @override
  String get achievementStreakB2Title => 'Devam Ediyorum';

  @override
  String get achievementStreakB2Desc => '7 gün üst üste kayıt yap';

  @override
  String get achievementStreakB3Title => 'Rutin Oluşuyor';

  @override
  String get achievementStreakB3Desc => '14 gün üst üste kayıt yap';

  @override
  String get achievementStreakS1Title => 'Kararlılık';

  @override
  String get achievementStreakS1Desc => '30 gün üst üste kayıt yap';

  @override
  String get achievementStreakS2Title => 'Alışkanlık';

  @override
  String get achievementStreakS2Desc => '60 gün üst üste kayıt yap';

  @override
  String get achievementStreakS3Title => 'Disiplin';

  @override
  String get achievementStreakS3Desc => '90 gün üst üste kayıt yap';

  @override
  String get achievementStreakG1Title => 'Güçlü İrade';

  @override
  String get achievementStreakG1Desc => '150 gün üst üste kayıt yap';

  @override
  String get achievementStreakG2Title => 'Sarsılmaz';

  @override
  String get achievementStreakG2Desc => '250 gün üst üste kayıt yap';

  @override
  String get achievementStreakG3Title => 'İstikrar';

  @override
  String get achievementStreakG3Desc => '365 gün üst üste kayıt yap';

  @override
  String get achievementStreakPTitle => 'Süreklilik';

  @override
  String get achievementStreakPDesc => '730 gün üst üste kayıt yap';

  @override
  String get achievementSavingsB1Title => 'İlk Tasarruf';

  @override
  String get achievementSavingsB1Desc => '250 TL kurtardın';

  @override
  String get achievementSavingsB2Title => 'Birikime Başladım';

  @override
  String get achievementSavingsB2Desc => '500 TL kurtardın';

  @override
  String get achievementSavingsB3Title => 'Yolun Başında';

  @override
  String get achievementSavingsB3Desc => '1.000 TL kurtardın';

  @override
  String get achievementSavingsS1Title => 'Bilinçli Harcama';

  @override
  String get achievementSavingsS1Desc => '2.500 TL kurtardın';

  @override
  String get achievementSavingsS2Title => 'Kontrollü';

  @override
  String get achievementSavingsS2Desc => '5.000 TL kurtardın';

  @override
  String get achievementSavingsS3Title => 'Tutarlı';

  @override
  String get achievementSavingsS3Desc => '10.000 TL kurtardın';

  @override
  String get achievementSavingsG1Title => 'Güçlü Birikim';

  @override
  String get achievementSavingsG1Desc => '25.000 TL kurtardın';

  @override
  String get achievementSavingsG2Title => 'Finansal Farkındalık';

  @override
  String get achievementSavingsG2Desc => '50.000 TL kurtardın';

  @override
  String get achievementSavingsG3Title => 'Sağlam Zemin';

  @override
  String get achievementSavingsG3Desc => '100.000 TL kurtardın';

  @override
  String get achievementSavingsP1Title => 'Uzun Vadeli Düşünce';

  @override
  String get achievementSavingsP1Desc => '250.000 TL kurtardın';

  @override
  String get achievementSavingsP2Title => 'Finansal Netlik';

  @override
  String get achievementSavingsP2Desc => '500.000 TL kurtardın';

  @override
  String get achievementSavingsP3Title => 'Büyük Resim';

  @override
  String get achievementSavingsP3Desc => '1.000.000 TL kurtardın';

  @override
  String get achievementDecisionB1Title => 'İlk Karar';

  @override
  String get achievementDecisionB1Desc => '3 kez vazgeçtin';

  @override
  String get achievementDecisionB2Title => 'Direnç';

  @override
  String get achievementDecisionB2Desc => '7 kez vazgeçtin';

  @override
  String get achievementDecisionB3Title => 'Kontrol';

  @override
  String get achievementDecisionB3Desc => '15 kez vazgeçtin';

  @override
  String get achievementDecisionS1Title => 'Kararlılık';

  @override
  String get achievementDecisionS1Desc => '30 kez vazgeçtin';

  @override
  String get achievementDecisionS2Title => 'Netlik';

  @override
  String get achievementDecisionS2Desc => '60 kez vazgeçtin';

  @override
  String get achievementDecisionS3Title => 'Güçlü Seçimler';

  @override
  String get achievementDecisionS3Desc => '100 kez vazgeçtin';

  @override
  String get achievementDecisionG1Title => 'İrade';

  @override
  String get achievementDecisionG1Desc => '200 kez vazgeçtin';

  @override
  String get achievementDecisionG2Title => 'Soğukkanlılık';

  @override
  String get achievementDecisionG2Desc => '400 kez vazgeçtin';

  @override
  String get achievementDecisionG3Title => 'Üst Seviye Kontrol';

  @override
  String get achievementDecisionG3Desc => '700 kez vazgeçtin';

  @override
  String get achievementDecisionPTitle => 'Tam Hakimiyet';

  @override
  String get achievementDecisionPDesc => '1.000 kez vazgeçtin';

  @override
  String get achievementRecordB1Title => 'Başladım';

  @override
  String get achievementRecordB1Desc => '5 harcama kaydı';

  @override
  String get achievementRecordB2Title => 'Takip Ediyorum';

  @override
  String get achievementRecordB2Desc => '15 harcama kaydı';

  @override
  String get achievementRecordB3Title => 'Düzen Oluştu';

  @override
  String get achievementRecordB3Desc => '30 harcama kaydı';

  @override
  String get achievementRecordS1Title => 'Detaylı Takip';

  @override
  String get achievementRecordS1Desc => '60 harcama kaydı';

  @override
  String get achievementRecordS2Title => 'Analitik';

  @override
  String get achievementRecordS2Desc => '120 harcama kaydı';

  @override
  String get achievementRecordS3Title => 'Sistemli';

  @override
  String get achievementRecordS3Desc => '200 harcama kaydı';

  @override
  String get achievementRecordG1Title => 'Derinlik';

  @override
  String get achievementRecordG1Desc => '350 harcama kaydı';

  @override
  String get achievementRecordG2Title => 'Uzmanlaşma';

  @override
  String get achievementRecordG2Desc => '600 harcama kaydı';

  @override
  String get achievementRecordG3Title => 'Arşiv';

  @override
  String get achievementRecordG3Desc => '1.000 harcama kaydı';

  @override
  String get achievementRecordPTitle => 'Uzun Süreli Kayıt';

  @override
  String get achievementRecordPDesc => '2.000 harcama kaydı';

  @override
  String get achievementHiddenNightTitle => 'Gece Kaydı';

  @override
  String get achievementHiddenNightDesc => '00:00-05:00 arası kayıt yap';

  @override
  String get achievementHiddenEarlyTitle => 'Erken Saat';

  @override
  String get achievementHiddenEarlyDesc => '05:00-07:00 arası kayıt yap';

  @override
  String get achievementHiddenWeekendTitle => 'Hafta Sonu Rutini';

  @override
  String get achievementHiddenWeekendDesc => 'Cumartesi-Pazar 5 kayıt';

  @override
  String get achievementHiddenOcrTitle => 'İlk Tarama';

  @override
  String get achievementHiddenOcrDesc => 'İlk fiş OCR kullanımı';

  @override
  String get achievementHiddenBalancedTitle => 'Dengeli Hafta';

  @override
  String get achievementHiddenBalancedDesc => '7 gün üst üste 0 \"Aldım\"';

  @override
  String get achievementHiddenCategoriesTitle => 'Kategori Tamamlama';

  @override
  String get achievementHiddenCategoriesDesc => 'Tüm 6 kategoride kayıt';

  @override
  String get achievementHiddenGoldTitle => 'Altın Denkliği';

  @override
  String get achievementHiddenGoldDesc =>
      'Kurtarılan para 1 gram altın değerinde';

  @override
  String get achievementHiddenUsdTitle => 'Döviz Denkliği';

  @override
  String get achievementHiddenUsdDesc => 'Kurtarılan para 100\$ değerinde';

  @override
  String get achievementHiddenSubsTitle => 'Abonelik Kontrolü';

  @override
  String get achievementHiddenSubsDesc => '5 abonelik takibi';

  @override
  String get achievementHiddenNoSpendTitle => 'Harcamasız Ay';

  @override
  String get achievementHiddenNoSpendDesc => '1 ay boyunca 0 \"Aldım\"';

  @override
  String get achievementHiddenGoldKgTitle => 'Yüksek Değer Birikim';

  @override
  String get achievementHiddenGoldKgDesc =>
      'Kurtarılan para 1 kg altın değerinde';

  @override
  String get achievementHiddenUsd10kTitle => 'Büyük Döviz Denkliği';

  @override
  String get achievementHiddenUsd10kDesc =>
      'Kurtarılan para 10.000\$ değerinde';

  @override
  String get achievementHiddenAnniversaryTitle => 'Kullanım Yıldönümü';

  @override
  String get achievementHiddenAnniversaryDesc => '365 gün kullanım';

  @override
  String get achievementHiddenEarlyAdopterTitle => 'İlk Nesil Kullanıcı';

  @override
  String get achievementHiddenEarlyAdopterDesc =>
      'Uygulamayı 2 yıl önce indirdi';

  @override
  String get achievementHiddenUltimateTitle => 'Uzun Vadeli Disiplin';

  @override
  String get achievementHiddenUltimateDesc =>
      '1.000.000 TL + 365 gün streak aynı anda';

  @override
  String get achievementHiddenCollectorTitle => 'Koleksiyoncu';

  @override
  String get achievementHiddenCollectorDesc =>
      'Platinum hariç tüm rozetleri topladı';

  @override
  String get easterEgg5Left => '5 kaldı...';

  @override
  String get easterEggAlmost => 'Neredeyse...';

  @override
  String get achievementUnlocked => 'Rozet Açıldı!';

  @override
  String get curiousCatTitle => 'Çok Meraklı';

  @override
  String get curiousCatDescription => 'Gizli Easter Egg\'i buldun!';

  @override
  String get great => 'Harika!';

  @override
  String get achievementHiddenCuriousCatTitle => 'Çok Meraklı';

  @override
  String get achievementHiddenCuriousCatDesc => 'Gizli Easter Egg\'i buldun!';

  @override
  String get recentExpenses => 'Son Harcamalar';

  @override
  String get seeMore => 'Tümünü Gör';

  @override
  String get tapPlusToAdd => 'İlk harcamanı eklemek için + butonuna dokun';

  @override
  String get expenseAdded => 'Harcama başarıyla eklendi';

  @override
  String get duplicateExpenseWarning => 'Bu harcama zaten var gibi görünüyor';

  @override
  String duplicateExpenseDetails(String amount, String category) {
    return '$amount TL $category';
  }

  @override
  String get addAnyway => 'Yine de eklemek istiyor musun?';

  @override
  String get yes => 'Evet';

  @override
  String get no => 'Hayır';

  @override
  String get timeAgoNow => 'şimdi';

  @override
  String timeAgoMinutes(int count) {
    return '$count dakika önce';
  }

  @override
  String timeAgoHours(int count) {
    return '$count saat önce';
  }

  @override
  String timeAgoDays(int count) {
    return '$count gün önce';
  }

  @override
  String get exportToExcel => 'Excel\'e Aktar';

  @override
  String get exportReport => 'Rapor Dışa Aktar';

  @override
  String get exporting => 'Dışa aktarılıyor...';

  @override
  String get exportSuccess => 'Rapor başarıyla dışa aktarıldı';

  @override
  String get exportError => 'Dışa aktarma başarısız';

  @override
  String get exportComplete => 'Dışa Aktarma Tamamlandı';

  @override
  String get exportShareOption => 'Paylaş';

  @override
  String get exportSaveOption => 'Dosyalarıma Kaydet';

  @override
  String get exportSavedToDownloads => 'Downloads/Vantag klasörüne kaydedildi';

  @override
  String get exportChooseAction => 'Dosya ile ne yapmak istersiniz?';

  @override
  String get csvHeaderDate => 'Tarih';

  @override
  String get csvHeaderTime => 'Saat';

  @override
  String get csvHeaderAmount => 'Tutar';

  @override
  String get csvHeaderCurrency => 'Para Birimi';

  @override
  String get csvHeaderCategory => 'Kategori';

  @override
  String get csvHeaderSubcategory => 'Alt Kategori';

  @override
  String get csvHeaderDescription => 'Açıklama';

  @override
  String get csvHeaderProduct => 'Ürün';

  @override
  String get csvHeaderDecision => 'Karar';

  @override
  String get csvHeaderWorkHours => 'Çalışma Saati';

  @override
  String get csvHeaderInstallment => 'Taksit';

  @override
  String get csvHeaderMandatory => 'Zorunlu';

  @override
  String get csvSummarySection => 'ÖZET';

  @override
  String get csvTotalExpense => 'Toplam Harcama';

  @override
  String get csvCategoryTotals => 'Kategori Toplamları';

  @override
  String get csvDailyAverage => 'Günlük Ortalama';

  @override
  String get csvWeeklyAverage => 'Haftalık Ortalama';

  @override
  String get csvTopCategory => 'En Çok Harcanan Kategori';

  @override
  String get csvLargestExpense => 'En Büyük Harcama';

  @override
  String get csvTotalWorkHours => 'Toplam Çalışma Saati';

  @override
  String get csvPeriod => 'Dönem';

  @override
  String get csvYes => 'Evet';

  @override
  String get csvNo => 'Hayır';

  @override
  String get financialReport => 'Finansal Özet Raporu';

  @override
  String get createdAt => 'Oluşturulma';

  @override
  String get savingsRate => 'Tasarruf Oranı';

  @override
  String get hourlyRate => 'Saatlik Ücret';

  @override
  String get workHoursEquivalent => 'Çalışma Saati Karşılığı';

  @override
  String get transactionCount => 'İşlem Sayısı';

  @override
  String get average => 'Ortalama';

  @override
  String get percentage => 'Yüzde';

  @override
  String get total => 'Toplam';

  @override
  String get monthly => 'Aylık';

  @override
  String get yearly => 'Yıllık';

  @override
  String get changePercent => 'Değişim %';

  @override
  String get month => 'Ay';

  @override
  String get originalAmount => 'Orijinal Tutar';

  @override
  String get nextRenewal => 'Sonraki Yenileme';

  @override
  String get yearlyAmount => 'Yıllık Tutar';

  @override
  String get badge => 'Rozet';

  @override
  String get status => 'Durum';

  @override
  String get earnedDate => 'Kazanılan Tarih';

  @override
  String get totalBadges => 'Toplam Rozet';

  @override
  String get proFeatureExport => 'Excel Dışa Aktarma Pro özelliğidir';

  @override
  String get upgradeForExport =>
      'Finansal verilerinizi dışa aktarmak için Pro\'ya yükseltin';

  @override
  String get importPremiumOnly => 'İçe Aktarma Pro özelliğidir';

  @override
  String get upgradeForImport =>
      'Banka ekstrelerinizi içe aktarmak için Pro\'ya yükseltin';

  @override
  String get receiptScanned => 'Fiş başarıyla tarandı';

  @override
  String get noAmountFound => 'Görüntüde tutar bulunamadı';

  @override
  String saveAllRecognized(int count) {
    return 'Tümünü Kaydet ($count)';
  }

  @override
  String saveAllRecognizedSuccess(int count) {
    return '$count harcama başarıyla kaydedildi';
  }

  @override
  String get budgets => 'Bütçeler';

  @override
  String get budget => 'Bütçe';

  @override
  String get addBudget => 'Bütçe Ekle';

  @override
  String get editBudget => 'Bütçe Düzenle';

  @override
  String get deleteBudget => 'Bütçe Sil';

  @override
  String get deleteBudgetConfirm =>
      'Bu bütçeyi silmek istediğinizden emin misiniz?';

  @override
  String get monthlyLimit => 'Aylık Limit';

  @override
  String get budgetProgress => 'Bütçe Durumu';

  @override
  String get totalBudget => 'Toplam Bütçe';

  @override
  String remainingAmount(String amount) {
    return '$amount kaldı';
  }

  @override
  String overBudgetAmount(String amount) {
    return '$amount aştın!';
  }

  @override
  String ofBudget(String spent, String total) {
    return '$spent / $total';
  }

  @override
  String get onTrack => 'Yolunda';

  @override
  String get nearLimit => 'Limite yakın';

  @override
  String get overLimit => 'Limit aşıldı';

  @override
  String get noBudgetsYet => 'Henüz bütçe yok';

  @override
  String get noBudgetsDescription =>
      'Kategorilere bütçe koyarak harcamalarını takip et';

  @override
  String get budgetHelperText =>
      'Bu kategori için aylık harcama limiti belirle';

  @override
  String get budgetExceededTitle => 'Bütçe Aşıldı!';

  @override
  String budgetExceededMessage(String category, String amount) {
    return '$category bütçeni $amount aştın';
  }

  @override
  String get budgetNearLimit => 'Bütçe limitine yaklaşıyorsun';

  @override
  String budgetNearLimitMessage(String percent, String category) {
    return '$category bütçenin %$percent\'ini kullandın';
  }

  @override
  String categoriesOnTrack(int count) {
    return '$count yolunda';
  }

  @override
  String categoriesOverBudget(int count) {
    return '$count bütçe aşımı';
  }

  @override
  String categoriesNearLimit(int count) {
    return '$count limite yakın';
  }

  @override
  String get categories => 'kategori';

  @override
  String get viewAll => 'Tümünü Gör';

  @override
  String get viewBudgetsInReports =>
      'Bütçe detaylarını Raporlar sekmesinde gör';

  @override
  String pendingCategorization(int count) {
    return '$count harcama kategorize bekliyor';
  }

  @override
  String suggestionsAvailable(int count) {
    return '$count öneri mevcut';
  }

  @override
  String get reviewExpenses => 'Harcamaları İncele';

  @override
  String get swipeToCategorizeTip => 'Kategorize etmek için bir kategori seçin';

  @override
  String get rememberMerchant => 'Bu satıcıyı hatırla';

  @override
  String suggestionLabel(String name) {
    return 'Öneri: $name';
  }

  @override
  String get suggested => 'Önerilen';

  @override
  String get allCategorized => 'Tamamlandı!';

  @override
  String categorizedCount(int processed, int skipped) {
    return '$processed kategorize edildi, $skipped atlandı';
  }

  @override
  String get importStatement => 'Ekstre Yükle';

  @override
  String get importCSV => 'CSV Yükle';

  @override
  String get importFromBank => 'Bankadan İçe Aktar';

  @override
  String get selectCSVFile => 'CSV dosyası seçin';

  @override
  String get importingExpenses => 'Harcamalar içe aktarılıyor...';

  @override
  String importSuccess(int count) {
    return '$count harcama başarıyla içe aktarıldı';
  }

  @override
  String get importError => 'İçe aktarma başarısız';

  @override
  String recognizedExpenses(int count) {
    return '$count tanındı';
  }

  @override
  String pendingExpenses(int count) {
    return '$count inceleme bekliyor';
  }

  @override
  String get importSummary => 'İçe Aktarma Özeti';

  @override
  String get autoMatched => 'Otomatik Eşleşti';

  @override
  String get needsReview => 'İnceleme Gerekli';

  @override
  String get startReview => 'İncelemeye Başla';

  @override
  String get importAIParsed => 'AI ile Ayrıştırılan İşlemler';

  @override
  String get importNoTransactions => 'Bu dosyada işlem bulunamadı';

  @override
  String importSelected(int count) {
    return '$count Seçiliyi Kaydet';
  }

  @override
  String get transactions => 'işlem';

  @override
  String get selectAll => 'Tümünü Seç';

  @override
  String get selectNone => 'Hiçbirini Seçme';

  @override
  String get selected => 'seçili';

  @override
  String get saving => 'Kaydediliyor...';

  @override
  String get learnedMerchants => 'Öğrenilen Satıcılar';

  @override
  String get noLearnedMerchants => 'Henüz öğrenilen satıcı yok';

  @override
  String get learnedMerchantsDescription =>
      'Kategorize ettiğiniz satıcılar burada görünecek';

  @override
  String merchantCount(int count) {
    return '$count satıcı öğrenildi';
  }

  @override
  String get deleteMerchant => 'Satıcıyı Sil';

  @override
  String get deleteMerchantConfirm =>
      'Bu satıcıyı silmek istediğinizden emin misiniz?';

  @override
  String get voiceInput => 'Sesli Giriş';

  @override
  String get listening => 'Dinleniyor...';

  @override
  String get voiceNotAvailable => 'Bu cihazda sesli giriş kullanılamıyor';

  @override
  String get microphonePermissionDenied => 'Mikrofon izni reddedildi';

  @override
  String get microphonePermissionRequired => 'Mikrofon izni gerekli';

  @override
  String get networkRequired => 'İnternet bağlantısı gerekli';

  @override
  String get understanding => 'Anlıyorum...';

  @override
  String get couldNotUnderstandTryAgain => 'Anlayamadım, tekrar dene';

  @override
  String get couldNotUnderstandSayAgain => 'Anlayamadım, tekrar söyle';

  @override
  String get sayAgain => 'Tekrar söyle';

  @override
  String get yesSave => 'Evet, kaydet';

  @override
  String voiceExpenseAdded(String amount, String description) {
    return '$amount₺ $description eklendi';
  }

  @override
  String get voiceConfirmExpense => 'Harcamayı Onayla';

  @override
  String voiceDetectedAmount(String amount) {
    return 'Algılanan: $amount₺';
  }

  @override
  String get tapToSpeak => 'Konuşmak için dokun';

  @override
  String get speakExpense => 'Harcamanı söyle (örn: \"50 lira kahve\")';

  @override
  String get voiceParsingFailed => 'Anlaşılamadı. Lütfen tekrar dene.';

  @override
  String get voiceHighConfidence => 'Otomatik kaydedildi';

  @override
  String get voiceMediumConfidence => 'Düzenlemek için dokun';

  @override
  String get voiceLowConfidence => 'Lütfen onayla';

  @override
  String get speakYourExpense => 'Harcamanı söyle';

  @override
  String get longPressForVoice => 'Sesli giriş için uzun bas';

  @override
  String get didYouKnow => 'Biliyor muydun?';

  @override
  String get voiceTipMessage =>
      'Daha hızlı ekle! + butonuna uzun bas ve söyle: \"50 lira kahve\"';

  @override
  String get gotIt => 'Anladım';

  @override
  String get tryNow => 'Dene';

  @override
  String get voiceAndShortcuts => 'Ses ve Kısayollar';

  @override
  String get newBadge => 'YENİ';

  @override
  String get voiceInputHint => 'Sesle eklemek için + butonuna uzun bas';

  @override
  String get howToUseVoice => 'Sesli Giriş Nasıl Kullanılır';

  @override
  String get voiceLimitReachedTitle => 'Günlük Limit Doldu';

  @override
  String get voiceLimitReachedFree =>
      'Bugünlük sesli giriş hakkın bitti. Pro\'ya geçerek sınırsız kullanabilir veya yarın tekrar deneyebilirsin.';

  @override
  String get voiceServerBusyTitle => 'Sunucular Yoğun';

  @override
  String get voiceServerBusyMessage =>
      'Ses sunucuları şu an yoğun. Lütfen biraz sonra tekrar dene.';

  @override
  String get longPressFab => '+ Butonuna Uzun Bas';

  @override
  String get longPressFabHint => '1 saniye basılı tut';

  @override
  String get micButton => 'Mikrofon Butonu';

  @override
  String get micButtonHint => 'Harcama eklerken mikrofona tıkla';

  @override
  String get exampleCommands => 'Örnek Komutlar';

  @override
  String get voiceExample1 => '\"50 lira kahve\"';

  @override
  String get voiceExample2 => '\"Markete 200 lira verdim\"';

  @override
  String get voiceExample3 => '\"Taksi 150 tuttu\"';

  @override
  String get voiceExamplesMultiline =>
      '\"50 lira kahve\"\n\"markete 200 TL verdim\"\n\"taksi 150 tuttu\"';

  @override
  String get somethingWentWrong => 'Bir şeyler yanlış gitti. Tekrar dene.';

  @override
  String get errorLoadingData => 'Veri yüklenirken hata oluştu';

  @override
  String get errorSaving => 'Kaydedilirken hata oluştu. Tekrar dene.';

  @override
  String get networkError => 'Ağ hatası. Bağlantını kontrol et.';

  @override
  String get errorLoadingRates => 'Döviz kurları yüklenemedi';

  @override
  String get errorLoadingSubscriptions => 'Abonelikler yüklenemedi';

  @override
  String get autoRecorded => 'Otomatik';

  @override
  String autoRecordedExpenses(int count) {
    return '$count abonelik otomatik eklendi';
  }

  @override
  String get security => 'Güvenlik';

  @override
  String get pinLock => 'PIN Kilidi';

  @override
  String get pinLockDescription => 'Uygulamayı açmak için PIN iste';

  @override
  String get biometricUnlock => 'Biyometrik Kilit';

  @override
  String get biometricDescription => 'Parmak izi veya Face ID kullan';

  @override
  String get enterPin => 'PIN Gir';

  @override
  String get createPin => 'PIN Oluştur';

  @override
  String get createPinDescription => '4 haneli bir PIN seç';

  @override
  String get confirmPin => 'PIN\'i Onayla';

  @override
  String get confirmPinDescription => 'PIN\'ini tekrar gir';

  @override
  String get wrongPin => 'Yanlış PIN. Tekrar dene.';

  @override
  String get pinMismatch => 'PIN\'ler eşleşmiyor. Tekrar dene.';

  @override
  String get pinSet => 'PIN başarıyla ayarlandı';

  @override
  String get useBiometric => 'Biyometrik Kullan';

  @override
  String get unlockWithBiometric => 'Vantag\'ı Aç';

  @override
  String get reset => 'Sıfırla';

  @override
  String get assistantSetupTitle => 'Google Assistant Kurulumu';

  @override
  String get assistantSetupHeadline => '\"Vantag\" demeden harcama ekle';

  @override
  String get assistantSetupSubheadline =>
      'Bu kurulumdan sonra sadece\n\"Hey Google, harcama ekle\" demen yeterli';

  @override
  String get assistantSetupComplete =>
      'Harika! Artık \"Hey Google, harcama ekle\" diyebilirsin';

  @override
  String get assistantSetupStep1Title => 'Google Assistant\'ı Aç';

  @override
  String get assistantSetupStep1Desc =>
      '\"Hey Google, ayarlar\" de veya Google Assistant uygulamasını aç.';

  @override
  String get assistantSetupStep1Tip =>
      'Ana sayfada sağ alt köşedeki profil ikonuna tıkla.';

  @override
  String get assistantSetupStep2Title => 'Rutinler\'e Git';

  @override
  String get assistantSetupStep2Desc =>
      'Ayarlar içinde \"Rutinler\" seçeneğini bul ve tıkla.';

  @override
  String get assistantSetupStep2Tip =>
      'Bazı cihazlarda \"Kısayollar\" olarak da geçebilir.';

  @override
  String get assistantSetupStep3Title => 'Yeni Rutin Oluştur';

  @override
  String get assistantSetupStep3Desc =>
      '\"+\" veya \"Yeni rutin\" butonuna tıkla.';

  @override
  String get assistantSetupStep3Tip => 'Sağ alt köşede olabilir.';

  @override
  String get assistantSetupStep4Title => 'Sesli Komut Ekle';

  @override
  String get assistantSetupStep4Desc =>
      '\"Başladığında\" kısmına tıkla ve \"Sesli komut ekle\" seç.\n\n\"Harcama ekle\" yaz.';

  @override
  String get assistantSetupStep4Tip =>
      'İstersen \"Para ekle\" veya \"Masraf kaydet\" de yazabilirsin.';

  @override
  String get assistantSetupStep5Title => 'Eylemi Ekle';

  @override
  String get assistantSetupStep5Desc =>
      '\"Eylem ekle\" → \"Uygulama aç\" → \"Vantag\" seç.';

  @override
  String get assistantSetupStep5Tip =>
      'Vantag listede yoksa arama kutusuna yaz.';

  @override
  String get assistantSetupStep6Title => 'Kaydet';

  @override
  String get assistantSetupStep6Desc =>
      'Sağ üstteki \"Kaydet\" butonuna tıkla.';

  @override
  String get assistantSetupStep6Tip => 'Rutine bir isim vermeni isteyebilir.';

  @override
  String get step => 'Adım';

  @override
  String get next => 'Sonraki';

  @override
  String get back => 'Geri';

  @override
  String get laterButton => 'Daha sonra yaparım';

  @override
  String get monthlySpendingBreakdown => 'Bu Ay Harcama Dağılımı';

  @override
  String get mandatoryExpenses => 'Zorunlu';

  @override
  String get discretionaryExpenses => 'İsteğe Bağlı';

  @override
  String remainingHoursToSpend(String hours) {
    return '$hours saat daha harcayabilirsin';
  }

  @override
  String budgetExceeded(String amount) {
    return 'Bütçeni $amount aştın!';
  }

  @override
  String get activeInstallments => 'Aktif Taksitler';

  @override
  String installmentCount(int count) {
    return '$count taksit';
  }

  @override
  String moreInstallments(int count) {
    return '+$count taksit daha';
  }

  @override
  String get monthlyBurden => 'Aylık Yük';

  @override
  String get remainingDebt => 'Kalan Borç';

  @override
  String totalInterestCost(String amount, String hours) {
    return 'Toplam vade farkı: $amount ($hours saat)';
  }

  @override
  String get monthAbbreviation => 'ay';

  @override
  String get installmentsLabel => 'taksit';

  @override
  String get remaining => 'Kalan';

  @override
  String get paywallTitle => 'Premium\'a Geç';

  @override
  String get paywallSubtitle =>
      'Tüm özelliklerin kilidini aç ve finansal özgürlüğüne ulaş';

  @override
  String get subscribeToPro => 'Pro\'ya Abone Ol';

  @override
  String get startFreeTrial => '7 Gün Ücretsiz Dene';

  @override
  String get freeTrialBanner => '7 GÜN ÜCRETSİZ';

  @override
  String get freeTrialDescription =>
      'İlk 7 gün tamamen ücretsiz, istediğin zaman iptal et';

  @override
  String trialThenPrice(String price) {
    return 'Deneme sonrası $price/ay';
  }

  @override
  String get noPaymentNow => 'Şimdi ödeme yapılmayacak';

  @override
  String get restorePurchases => 'Satın alımları geri yükle';

  @override
  String get feature => 'Özellik';

  @override
  String get featureAiChat => 'AI Sohbet';

  @override
  String get featureAiChatFree => '4/gün';

  @override
  String get featureHistory => 'Geçmiş';

  @override
  String get featureHistory30Days => '30 gün';

  @override
  String get featureExport => 'Excel Dışa Aktarma';

  @override
  String get featureWidgets => 'Widgetlar';

  @override
  String get featureAds => 'Reklamlar';

  @override
  String get featureUnlimited => 'Sınırsız';

  @override
  String get featureYes => 'Evet';

  @override
  String get featureNo => 'Hayır';

  @override
  String get weekly => 'Haftalık';

  @override
  String get week => 'hafta';

  @override
  String get year => 'yıl';

  @override
  String get bestValue => 'En İyi Değer';

  @override
  String get yearlySavings => '%50\'ye varan tasarruf';

  @override
  String get cancelAnytime => 'İstediğin zaman iptal et';

  @override
  String get aiLimitReached => 'Günlük AI limitine ulaştın';

  @override
  String aiLimitMessage(int used, int limit) {
    return 'Bugün $used/$limit AI sohbet hakkını kullandın. Sınırsız erişim için Pro\'ya yükselt.';
  }

  @override
  String get historyLimitReached => 'Geçmiş sınırına ulaştın';

  @override
  String get historyLimitMessage =>
      'Ücretsiz planda sadece son 30 günlük geçmişi görebilirsin. Tüm geçmişe erişmek için Pro\'ya yükselt.';

  @override
  String get exportProOnly => 'Excel dışa aktarma Pro özelliğidir';

  @override
  String remainingAiUses(int count) {
    return '$count AI hakkın kaldı';
  }

  @override
  String get lifetime => 'Ömür Boyu';

  @override
  String get lifetimeDescription =>
      'Bir kere öde, sonsuza kadar kullan • Ayda 100 AI kredisi';

  @override
  String get oneTime => 'tek seferlik';

  @override
  String get forever => 'SONSUZA KADAR';

  @override
  String get mostPopular => 'EN POPÜLER';

  @override
  String monthlyCredits(int count) {
    return 'Ayda $count AI kredisi';
  }

  @override
  String proMonthlyCredits(int remaining, int limit) {
    return '$remaining/$limit aylık kredi';
  }

  @override
  String get aiLimitFreeTitleEmoji => '🔒 Günlük AI Limitine Ulaştın!';

  @override
  String get aiLimitProTitleEmoji => '⏳ Aylık AI Limitine Ulaştın!';

  @override
  String get aiLimitFreeMessage => 'Bugün 4 AI soru hakkını kullandın.';

  @override
  String get aiLimitProMessage => 'Bu ay 500 AI soru hakkını kullandın.';

  @override
  String get aiLimitLifetimeMessage => 'Bu ay 200 AI kredini kullandın.';

  @override
  String aiLimitResetDate(String day, String month, int days) {
    return 'Limitin $day $month\'ta yenilenir ($days gün kaldı)';
  }

  @override
  String get aiLimitUpgradeToPro => '🚀 Pro\'ya Geç - Sınırsız AI';

  @override
  String get aiLimitBuyCredits => '🔋 Ek Kredi Paketi Al';

  @override
  String get aiLimitTryTomorrow => 'veya yarın tekrar dene';

  @override
  String aiLimitOrWaitDays(int days) {
    return 'veya $days gün sonra yenilenir';
  }

  @override
  String get creditPurchaseTitle => 'Kredi Satın Al';

  @override
  String get creditPurchaseHeader => 'AI Kredisi Yükle';

  @override
  String get creditPurchaseSubtitle =>
      'Aylık limitin dışında ekstra AI sorguları için kredi satın al.';

  @override
  String get creditCurrentBalance => 'Mevcut Bakiye';

  @override
  String creditAmount(int credits) {
    return '$credits Kredi';
  }

  @override
  String creditPackTitle(int credits) {
    return '$credits Kredi';
  }

  @override
  String creditPackPricePerCredit(String price) {
    return 'Kredi başına ₺$price';
  }

  @override
  String get creditPackPopular => 'EN POPÜLER';

  @override
  String get creditPackBestValue => 'EN TASARRUFLU';

  @override
  String get creditNeverExpire =>
      'Krediler asla sona ermez, istediğin zaman kullan';

  @override
  String creditPurchaseSuccess(int credits) {
    return '$credits kredi hesabına eklendi!';
  }

  @override
  String get pursuits => 'Hayallerim';

  @override
  String get myPursuits => 'Hayallerim';

  @override
  String get navPursuits => 'Hayaller';

  @override
  String get createPursuit => 'Yeni Hayal';

  @override
  String get pursuitName => 'Ne için biriktiriyorsun?';

  @override
  String get pursuitNameHint => 'ör: iPhone 16, Maldivler Tatili...';

  @override
  String get targetAmount => 'Hedef Tutar';

  @override
  String get savedAmount => 'Biriken';

  @override
  String get addSavings => 'Para Ekle';

  @override
  String pursuitProgress(int percent) {
    return '%$percent tamamlandı';
  }

  @override
  String daysToGoal(int days) {
    return '≈ $days iş günü';
  }

  @override
  String get pursuitCompleted => 'Hayalin Gerçek Oldu!';

  @override
  String get congratulations => 'Tebrikler!';

  @override
  String pursuitCompletedMessage(int days, String amount) {
    return '$days günde $amount biriktirdin!';
  }

  @override
  String get shareProgress => 'İlerlemeyi Paylaş';

  @override
  String get activePursuits => 'Aktif';

  @override
  String get completedPursuits => 'Gerçekleşenler';

  @override
  String get archivePursuit => 'Arşivle';

  @override
  String get deletePursuit => 'Sil';

  @override
  String get editPursuit => 'Düzenle';

  @override
  String get deletePursuitConfirm =>
      'Bu hayali silmek istediğinize emin misiniz?';

  @override
  String get pursuitCategoryTech => 'Teknoloji';

  @override
  String get pursuitCategoryTravel => 'Seyahat';

  @override
  String get pursuitCategoryHome => 'Ev';

  @override
  String get pursuitCategoryFashion => 'Moda';

  @override
  String get pursuitCategoryVehicle => 'Araç';

  @override
  String get pursuitCategoryEducation => 'Eğitim';

  @override
  String get pursuitCategoryHealth => 'Sağlık';

  @override
  String get pursuitCategoryOther => 'Diğer';

  @override
  String get emptyPursuitsTitle => 'Hayaline Bir Adım At';

  @override
  String get emptyPursuitsMessage => 'İlk hayalini ekle ve biriktirmeye başla!';

  @override
  String get addFirstPursuit => 'İlk Hayalini Ekle';

  @override
  String get pursuitLimitReached => 'Sınırsız hayal için Pro\'ya geç';

  @override
  String get quickAmounts => 'Hızlı Tutarlar';

  @override
  String get addNote => 'Not ekle (opsiyonel)';

  @override
  String get pursuitCreated => 'Hayal oluşturuldu!';

  @override
  String get savingsAdded => 'Eklendi!';

  @override
  String workHoursRemaining(String hours) {
    return '$hours saatlik emek kaldı';
  }

  @override
  String get pursuitInitialSavings => 'Başlangıç Birikimi';

  @override
  String get pursuitInitialSavingsHint => 'Zaten biriktirdiğin tutar';

  @override
  String get pursuitSelectCategory => 'Kategori Seç';

  @override
  String get redirectSavings => 'Tasarrufu Hayale Aktar';

  @override
  String redirectSavingsMessage(String amount) {
    return 'Vazgeçtiğin $amount tutarı hangi hayaline eklemek istersin?';
  }

  @override
  String get skipRedirect => 'Şimdilik Atla';

  @override
  String get pursuitTransactionHistory => 'İşlem Geçmişi';

  @override
  String get noTransactions => 'Henüz işlem yok';

  @override
  String get transactionSourceManual => 'Manuel Ekleme';

  @override
  String get transactionSourcePool => 'Havuzdan Transfer';

  @override
  String get transactionSourceExpense => 'Vazgeçilen Harcama';

  @override
  String get savingsPool => 'Tasarruf Havuzu';

  @override
  String get savingsPoolAvailable => 'kullanılabilir';

  @override
  String get savingsPoolDebt => 'Borçlusun';

  @override
  String shadowDebtMessage(String amount) {
    return 'Gelecekteki kendinden $amount borç aldın';
  }

  @override
  String budgetShiftQuestion(String amount) {
    return 'Bu $amount hangi bütçenden geldi?';
  }

  @override
  String get jokerUsed => 'Bu ayki joker hakkını kullandın';

  @override
  String get jokerAvailable => 'Joker hakkın var!';

  @override
  String allocatedToDreams(String amount) {
    return '$amount hayallerine ayrıldı';
  }

  @override
  String get extraIncome => 'Ekstra gelir elde ettim';

  @override
  String get useJoker => 'Joker Kullan (ayda 1)';

  @override
  String get budgetShiftFromFood => 'Yemek bütçemden';

  @override
  String get budgetShiftFromEntertainment => 'Eğlence bütçemden';

  @override
  String get budgetShiftFromClothing => 'Giyim bütçemden';

  @override
  String get budgetShiftFromTransport => 'Ulaşım bütçemden';

  @override
  String get budgetShiftFromShopping => 'Alışveriş bütçemden';

  @override
  String get budgetShiftFromHealth => 'Sağlık bütçemden';

  @override
  String get budgetShiftFromEducation => 'Eğitim bütçemden';

  @override
  String get insufficientFunds => 'Yetersiz bakiye';

  @override
  String insufficientFundsMessage(String available, String requested) {
    return 'Havuzda $available var, $requested istiyorsun';
  }

  @override
  String get createShadowDebt => 'Yine de ekle (borç oluştur)';

  @override
  String debtRepaidMessage(String amount) {
    return 'Borcundan $amount ödendi!';
  }

  @override
  String get poolSummaryTotal => 'Toplam Tasarruf';

  @override
  String get poolSummaryAllocated => 'Hayallere Ayrılan';

  @override
  String get poolSummaryAvailable => 'Kullanılabilir';

  @override
  String get overAllocationTitle => 'Yetersiz Havuz Bakiyesi';

  @override
  String overAllocationMessage(String available, String requested) {
    return 'Havuzda $available var. $requested eklemek istiyorsun.';
  }

  @override
  String get fromMyPocket => 'Cebimden ekle';

  @override
  String fromMyPocketDesc(String difference) {
    return 'Havuzu sıfırla + $difference cebimden ekle';
  }

  @override
  String get deductFromFuture => 'İleriki tasarruflardan düş';

  @override
  String deductFromFutureDesc(String amount) {
    return 'Havuz $amount eksiye düşer';
  }

  @override
  String transferAvailableOnly(String amount) {
    return 'Sadece $amount aktar';
  }

  @override
  String get transferAvailableOnlyDesc => 'Havuzdaki kadarını ekle';

  @override
  String get oneTimeIncomeTitle => 'Bu para nereden?';

  @override
  String get oneTimeIncomeDesc => 'Havuzun ekside. Kaynağı seç:';

  @override
  String get oneTimeIncomeOption => 'Tek seferlik gelir';

  @override
  String get oneTimeIncomeOptionDesc => 'Havuzu etkilemez, direkt hedefe gider';

  @override
  String get fromSavingsOption => 'Tasarruflarımdan';

  @override
  String get fromSavingsOptionDesc => 'Havuz daha da eksiye düşer';

  @override
  String debtWarningOnPurchase(String amount) {
    return 'Hayallerine $amount borcun var!';
  }

  @override
  String get debtReminderNotification =>
      'Hayallerine olan borcunu ödemeyi unutma!';

  @override
  String get aiThinking => 'Düşünüyor...';

  @override
  String get aiSuggestion1 => 'Bu ay nereye harcadım?';

  @override
  String get aiSuggestion2 => 'Nereden tasarruf edebilirim?';

  @override
  String get aiSuggestion3 => 'En pahalı alışkanlığım ne?';

  @override
  String get aiSuggestion4 => 'Hedefime ne kadar kaldı?';

  @override
  String get aiPremiumUpsell =>
      'Detaylı analiz ve kişisel tasarruf planı için Premium\'a geç';

  @override
  String get aiPremiumButton => 'Premium\'a Geç';

  @override
  String get aiInputPlaceholderFree => 'Kendi sorunu sor 🔒';

  @override
  String get aiInputPlaceholder => 'Bir şey sor...';

  @override
  String get onboardingTryTitle => 'Haydi Deneyelim!';

  @override
  String get onboardingTrySubtitle =>
      'Ne kadar çalıştığını merak ettiğin bir şey var mı?';

  @override
  String get onboardingTryButton => 'Hesapla';

  @override
  String get onboardingTryDisclaimer =>
      'Bu sadece paranın ne kadar soyut, zamanın ne kadar somut olduğunu göstermek içindi.';

  @override
  String get onboardingTryNotSaved =>
      'Merak etme, bu harcamalara kaydedilmedi.';

  @override
  String get onboardingContinue => 'Uygulamaya Geç';

  @override
  String onboardingTryResult(String hours) {
    return 'Bu harcama hayatından $hours saat götürüyor';
  }

  @override
  String get subscriptionPriceHint => '₺99.99';

  @override
  String currencyUpdatePopup(
    String oldAmount,
    String oldCurrency,
    String newAmount,
    String newCurrency,
  ) {
    return 'Kur güncelleniyor: $oldAmount $oldCurrency ≈ $newAmount $newCurrency olarak güncellendi';
  }

  @override
  String get currencyConverting => 'Para birimi dönüştürülüyor...';

  @override
  String get currencyConversionFailed =>
      'Döviz kuru alınamadı, değerler değiştirilmedi';

  @override
  String get requiredExpense => 'Zorunlu Gider';

  @override
  String get installmentPurchase => 'Taksitli Alım';

  @override
  String get installmentInfo => 'Taksit Bilgileri';

  @override
  String get cashPrice => 'Peşin Fiyat';

  @override
  String get cashPriceHint => 'Ürünün peşin fiyatı';

  @override
  String get numberOfInstallments => 'Taksit Sayısı';

  @override
  String get totalInstallmentPrice => 'Taksitli Toplam Fiyat';

  @override
  String get totalWithInterestHint => 'Vade farkı dahil toplam';

  @override
  String get installmentSummary => 'TAKSİT ÖZETİ';

  @override
  String get willBeSavedAsRequired => 'Zorunlu gider olarak kaydedilecek';

  @override
  String get creditCardOrStoreInstallment => 'Kredi kartı veya mağaza taksiti';

  @override
  String get vantagAI => 'Vantag AI';

  @override
  String get professionalMode => 'Profesyonel mod';

  @override
  String get friendlyMode => 'Samimi mod';

  @override
  String get errorTryAgain => 'Bir hata oluştu, tekrar dener misin?';

  @override
  String get aiFallbackOverBudget =>
      'Bütçe biraz zorlanıyor gibi.\nGel birlikte bakalım ne yapabiliriz?';

  @override
  String get aiFallbackHighUsage =>
      'Ayın sonuna az kaldı, dikkatli olalım.\nNasıl yardımcı olabilirim?';

  @override
  String get aiFallbackMediumUsage =>
      'Bütçe idare ediyor.\nBir şey sormak ister misin?';

  @override
  String get aiFallbackLowUsage =>
      'Bütçen gayet iyi durumda!\nNeyi analiz edelim?';

  @override
  String get aiInsights => 'AI Insights';

  @override
  String get mostSpendingDay => 'En Çok Harcama Günü';

  @override
  String get biggestCategory => 'En Büyük Kategori';

  @override
  String get thisMonthVsLast => 'Bu Ay vs Geçen Ay';

  @override
  String get monday => 'Pazartesi';

  @override
  String get tuesday => 'Salı';

  @override
  String get wednesday => 'Çarşamba';

  @override
  String get thursday => 'Perşembe';

  @override
  String get friday => 'Cuma';

  @override
  String get saturday => 'Cumartesi';

  @override
  String get sunday => 'Pazar';

  @override
  String get securePayment => 'Güvenli Ödeme';

  @override
  String get encrypted => 'Şifreli';

  @override
  String get syncing => 'Veriler senkronize ediliyor...';

  @override
  String pendingSync(int count) {
    return '$count değişiklik bekliyor';
  }

  @override
  String get pendingLabel => 'Bekliyor';

  @override
  String insightMinutes(int minutes) {
    return 'Bu harcama hayatından $minutes dakika aldı.';
  }

  @override
  String insightHours(String hours) {
    return 'Bu harcama hayatından $hours saat aldı.';
  }

  @override
  String get insightAlmostDay => 'Bu harcama için neredeyse bir gün çalıştın.';

  @override
  String insightDays(String days) {
    return 'Bu harcama hayatından $days gün aldı.';
  }

  @override
  String insightDaysWorked(String days) {
    return 'Bu harcama için $days gün çalışman gerekti.';
  }

  @override
  String get insightAlmostMonth =>
      'Bu harcama neredeyse bir aylık emeğine mal oldu.';

  @override
  String insightCategoryDays(String category, String days) {
    return 'Bu ay $category için $days gün çalıştın.';
  }

  @override
  String insightCategoryHours(String category, String hours) {
    return 'Bu ay $category için $hours saat çalıştın.';
  }

  @override
  String get insightMonthlyAlmost =>
      'Bu ayki harcamalar için neredeyse tüm ay çalıştın.';

  @override
  String insightMonthlyDays(String days) {
    return 'Bu ay harcamalar için $days gün çalıştın.';
  }

  @override
  String get msgShort1 => 'Birkaç saatlik emeğin, bir anlık heves için mi?';

  @override
  String get msgShort2 =>
      'Bu kadar kısa sürede kazandığın parayı harcamak kolay, kazanmak zor.';

  @override
  String get msgShort3 => 'Sabah işe gittin, öğlene kalmadan bu para gidecek.';

  @override
  String get msgShort4 =>
      'Bir kahve molası kadar sürede kazandın, bir tıkla gidecek.';

  @override
  String get msgShort5 => 'Yarım günlük mesai, tam günlük pişmanlık olmasın.';

  @override
  String get msgShort6 => 'Bu ürün için çalıştığın saatleri düşün.';

  @override
  String get msgShort7 => 'Küçük görünüyor ama toplamda büyük fark yaratıyor.';

  @override
  String get msgShort8 => 'Şimdi değil dersen, yarın da olur.';

  @override
  String get msgMedium1 => 'Bir haftalık emeğin bu ürüne değer mi?';

  @override
  String get msgMedium2 =>
      'Bu parayı biriktirmek günler aldı, harcamak saniyeler alacak.';

  @override
  String get msgMedium3 =>
      'Bir haftanı buna yatırıyor olsaydın kabul eder miydin?';

  @override
  String get msgMedium4 => 'Günlerce emek, anlık bir karar.';

  @override
  String get msgMedium5 => 'Hafta sonu tatili mi, bu ürün mü?';

  @override
  String get msgMedium6 => 'Bu kadar gün boyunca ne için çalıştığını hatırla.';

  @override
  String get msgMedium7 => 'Pazartesiden cumaya kadar bunun için mi çalıştın?';

  @override
  String get msgMedium8 => 'Haftalık bütçeni tek seferde harcamak mantıklı mı?';

  @override
  String get msgLong1 =>
      'Haftalarca çalışman gerekiyor bunun için. Gerçekten değer mi?';

  @override
  String get msgLong2 => 'Bu parayı biriktirmek aylar alabilir.';

  @override
  String get msgLong3 =>
      'Uzun vadeli hedeflerinden birini erteliyor olabilirsin.';

  @override
  String get msgLong4 =>
      'Bu ürün için harcayacağın zaman, tatil planlarını etkiler mi?';

  @override
  String get msgLong5 => 'Bu yatırım mı, harcama mı?';

  @override
  String get msgLong6 => 'Gelecekteki sen bu kararı nasıl değerlendirir?';

  @override
  String get msgLong7 =>
      'Bu kadar uzun süre çalışmak, kalıcı bir şey için olmalı.';

  @override
  String get msgLong8 => 'Ay sonunda bu karara nasıl bakacaksın?';

  @override
  String get msgSim1 =>
      'Bu rakam artık bir harcama değil, ciddi bir yatırım kararı.';

  @override
  String get msgSim2 =>
      'Böyle büyük bir tutar için duygularınla değil, vizyonunla karar ver.';

  @override
  String get msgSim3 => 'Bu tutarın karşılığı olan zamanı hesaplamak bile güç.';

  @override
  String get msgSim4 => 'Hayallerini süsleyen o büyük adım bu olabilir mi?';

  @override
  String get msgSim5 =>
      'Bu kadar büyük bir rakamı yönetmek, sabır ve strateji ister.';

  @override
  String get msgSim6 =>
      'Cüzdanını değil, geleceğini etkileyecek bir noktadasın.';

  @override
  String get msgSim7 =>
      'Büyük rakamlar, büyük sorumluluklar getirir. Hazır mısın?';

  @override
  String get msgSim8 =>
      'Bu tutar senin için sadece bir sayı mı, yoksa bir dönüm noktası mı?';

  @override
  String get msgYes1 => 'Kaydettim. Umarım değer.';

  @override
  String get msgYes2 => 'Bakalım pişman olacak mısın.';

  @override
  String get msgYes3 => 'Tamam, senin paran.';

  @override
  String get msgYes4 => 'Aldın aldın, hayırlı olsun.';

  @override
  String get msgYes5 => 'Keyfin bilir.';

  @override
  String get msgYes6 => 'Peki, kayıtlara geçti.';

  @override
  String get msgYes7 => 'İhtiyaçsa sorun yok.';

  @override
  String get msgYes8 => 'Bazen harcamak da gerekir.';

  @override
  String get msgNo1 => 'Güzel karar. Bu parayı kurtardın.';

  @override
  String get msgNo2 => 'Zor olanı seçtin, gelecekte teşekkür edeceksin.';

  @override
  String get msgNo3 => 'İrade kazandı.';

  @override
  String get msgNo4 => 'Akıllıca. Bu para sana lazım olacak.';

  @override
  String get msgNo5 => 'Vazgeçmek de bir kazanım.';

  @override
  String get msgNo6 => 'Heves geçti, para kaldı.';

  @override
  String get msgNo7 => 'Kendine yatırım yaptın aslında.';

  @override
  String get msgNo8 => 'Zor karar, doğru karar.';

  @override
  String get msgThink1 => 'Düşünmek bedava, harcamak değil.';

  @override
  String get msgThink2 => 'Acele etmemek akıllıca.';

  @override
  String get msgThink3 => 'Bir gece uyu, yarın tekrar bak.';

  @override
  String get msgThink4 => '24 saat bekle, hala istiyorsan gel.';

  @override
  String get msgThink5 => 'Tereddüt ediyorsan muhtemelen gerekli değil.';

  @override
  String get msgThink6 => 'Zaman en iyi danışman.';

  @override
  String get msgThink7 => 'Acil değilse, acele etme.';

  @override
  String get msgThink8 => 'Emin değilsen, cevap muhtemelen hayır.';

  @override
  String get savingMsg1 => 'Harika karar! 💪';

  @override
  String get savingMsg2 => 'Paranı korudun! 🛡️';

  @override
  String get savingMsg3 => 'Gelecekteki sen teşekkür edecek!';

  @override
  String get savingMsg4 => 'Akıllı tercih! 🧠';

  @override
  String get savingMsg5 => 'Biriktirmek güçtür!';

  @override
  String get savingMsg6 => 'Hedefine bir adım daha yaklaştın!';

  @override
  String get savingMsg7 => 'İrade gücü! 💎';

  @override
  String get savingMsg8 => 'Bu para artık senin!';

  @override
  String get savingMsg9 => 'Finansal disiplin! 🎯';

  @override
  String get savingMsg10 => 'Zenginlik inşa ediyorsun!';

  @override
  String get savingMsg11 => 'Güçlü karar! 💪';

  @override
  String get savingMsg12 => 'Cüzdanın teşekkür ediyor!';

  @override
  String get savingMsg13 => 'Şampiyonlar böyle biriktirir! 🏆';

  @override
  String get savingMsg14 => 'Biriken para = Kazanılan özgürlük!';

  @override
  String get savingMsg15 => 'Etkileyici öz kontrol! ⭐';

  @override
  String get spendingMsg1 => 'Kaydedildi! ✓';

  @override
  String get spendingMsg2 => 'Takip ediyorsun, bu önemli.';

  @override
  String get spendingMsg3 => 'Her kayıt bir farkındalık.';

  @override
  String get spendingMsg4 => 'Harcamalarını bilmek güç.';

  @override
  String get spendingMsg5 => 'Kaydedildi! Devam et.';

  @override
  String get spendingMsg6 => 'Takip etmek kontrol sağlar.';

  @override
  String get spendingMsg7 => 'Not alındı! Farkındalık anahtar.';

  @override
  String get spendingMsg8 => 'Takip ettiğin için aferin!';

  @override
  String get spendingMsg9 => 'Veri güçtür! 📊';

  @override
  String get spendingMsg10 => 'Farkında ol, kontrol sende.';

  @override
  String get tourAmountTitle => 'Tutar Girişi';

  @override
  String get tourAmountDesc =>
      'Harcama tutarını buraya gir. Fiş tarama butonu ile fişten otomatik okuyabilirsin.';

  @override
  String get tourDescriptionTitle => 'Akıllı Eşleştirme';

  @override
  String get tourDescriptionDesc =>
      'Mağaza veya ürün adını yaz. Migros, A101, Starbucks gibi... Uygulama otomatik olarak kategori önerecek!';

  @override
  String get tourCategoryTitle => 'Kategori Seçimi';

  @override
  String get tourCategoryDesc =>
      'Akıllı eşleştirme bulamazsa veya düzeltmek istersen buradan manuel seçim yapabilirsin.';

  @override
  String get tourDateTitle => 'Geçmiş Tarih Seçimi';

  @override
  String get tourDateDesc =>
      'Dün veya önceki günlerin harcamalarını da girebilirsin. Takvim ikonuna tıklayarak istediğin tarihi seç.';

  @override
  String get tourSnapshotTitle => 'Finansal Özet';

  @override
  String get tourSnapshotDesc =>
      'Aylık gelirin, harcamaların ve kurtardığın para burada. Tüm veriler anlık güncellenir.';

  @override
  String get tourCurrencyTitle => 'Döviz Kurları';

  @override
  String get tourCurrencyDesc =>
      'Güncel USD, EUR ve altın fiyatları. Tıklayarak detaylı bilgi alabilirsin.';

  @override
  String get tourStreakTitle => 'Seri Takibi';

  @override
  String get tourStreakDesc =>
      'Her gün harcama girdiğinde serin artar. Düzenli takip etmek bilinçli harcamanın anahtarı!';

  @override
  String get tourSubscriptionTitle => 'Abonelikler';

  @override
  String get tourSubscriptionDesc =>
      'Netflix, Spotify gibi düzenli aboneliklerini buradan takip et. Yaklaşan ödemeler için bildirim alırsın.';

  @override
  String get tourReportTitle => 'Raporlar';

  @override
  String get tourReportDesc =>
      'Aylık ve kategorilere göre harcama analizlerini buradan görüntüle.';

  @override
  String get tourAchievementsTitle => 'Rozetler';

  @override
  String get tourAchievementsDesc =>
      'Tasarruf hedeflerine ulaştıkça rozetler kazan. Motivasyonunu yüksek tut!';

  @override
  String get tourProfileTitle => 'Profil & Ayarlar';

  @override
  String get tourProfileDesc =>
      'Gelir bilgilerini düzenle, bildirim tercihlerini yönet ve uygulama ayarlarına eriş.';

  @override
  String get tourQuickAddTitle => 'Hızlı Ekleme';

  @override
  String get tourQuickAddDesc =>
      'Her yerden hızlıca harcama eklemek için bu butonu kullan. Pratik ve hızlı!';

  @override
  String get notifChannelName => 'Vantag Bildirimleri';

  @override
  String get notifChannelDescription => 'Finansal takip bildirimleri';

  @override
  String get notifTitleThinkAboutIt => 'Bir düşün';

  @override
  String get notifTitleCongratulations => 'Tebrikler';

  @override
  String get notifTitleStreakWaiting => 'Serin bekliyor';

  @override
  String get notifTitleWeeklySummary => 'Haftalık özet';

  @override
  String get notifTitleSubscriptionReminder => 'Abonelik hatırlatma';

  @override
  String get aiGreeting =>
      'Merhaba! Ben Vantag.\nFinansal sorularını yanıtlamaya hazırım.';

  @override
  String get aiServiceUnavailable =>
      'AI asistan şu anda kullanılamıyor. Lütfen daha sonra tekrar deneyin.';

  @override
  String get onboardingHookTitle => 'Bu kahve 47 dakikan';

  @override
  String get onboardingHookSubtitle => 'Her harcamanın gerçek maliyetini gör';

  @override
  String get pursuitOnboardingTitle => 'Hedefin ne?';

  @override
  String get pursuitOnboardingSubtitle => 'Biriktirmek istediğin bir şey seç';

  @override
  String get pursuitOnboardingAirpods => 'AirPods';

  @override
  String get pursuitOnboardingIphone => 'iPhone';

  @override
  String get pursuitOnboardingVacation => 'Tatil';

  @override
  String get pursuitOnboardingCustom => 'Kendi hedefim';

  @override
  String get pursuitOnboardingCta => 'Bunu istiyorum';

  @override
  String get pursuitOnboardingSkip => 'Şimdilik geç';

  @override
  String pursuitOnboardingHours(int hours) {
    return '$hours saat';
  }

  @override
  String get celebrationTitle => 'Tebrikler!';

  @override
  String celebrationSubtitle(String goalName) {
    return '$goalName hedefine ulaştın!';
  }

  @override
  String celebrationTotalSaved(String hours) {
    return 'Toplam biriktirdiğin: $hours saat';
  }

  @override
  String celebrationDuration(int days) {
    return 'Süre: $days gün';
  }

  @override
  String get celebrationShare => 'Paylaş';

  @override
  String get celebrationNewGoal => 'Yeni Hedef';

  @override
  String get celebrationDismiss => 'Kapat';

  @override
  String get widgetTodayLabel => 'Bugün';

  @override
  String get widgetHoursAbbrev => 's';

  @override
  String get widgetMinutesAbbrev => 'dk';

  @override
  String get widgetSetGoal => 'Hedef belirle';

  @override
  String get widgetNoData => 'Başlamak için aç';

  @override
  String get widgetSmallTitle => 'Günlük Harcama';

  @override
  String get widgetSmallDesc => 'Bugünkü harcamanı saat olarak gör';

  @override
  String get widgetMediumTitle => 'Harcama + Hedef';

  @override
  String get widgetMediumDesc => 'Harcama ve hedef takibi';

  @override
  String accessibilityTodaySpending(String amount, int hours, int minutes) {
    return 'Bugün $amount harcadın, bu $hours saat $minutes dakika çalışmana eşit';
  }

  @override
  String accessibilitySpendingProgress(int percentage) {
    return 'Harcama ilerlemesi: bütçenin yüzde $percentage\'i kullanıldı';
  }

  @override
  String accessibilityExpenseItem(
    String category,
    String amount,
    String hours,
    String decision,
  ) {
    return '$category harcaması $amount, $hours saat sürdü, durum: $decision';
  }

  @override
  String accessibilityPursuitCard(
    String name,
    String saved,
    String target,
    int percentage,
  ) {
    return '$name hedefi, $target hedeften $saved biriktirildi, yüzde $percentage tamamlandı';
  }

  @override
  String get accessibilityAddExpense => 'Yeni harcama ekle';

  @override
  String get accessibilityDecisionYes => 'Satın alındı';

  @override
  String get accessibilityDecisionNo => 'Vazgeçildi';

  @override
  String get accessibilityDecisionThinking => 'Düşünülüyor';

  @override
  String get accessibilityDashboard =>
      'Gelir, gider ve bakiyeyi gösteren finansal pano';

  @override
  String accessibilityNetBalance(String amount, String status) {
    return 'Net bakiye: $amount, $status';
  }

  @override
  String get accessibilityBalanceHealthy => 'artıda';

  @override
  String get accessibilityBalanceNegative => 'eksidə';

  @override
  String accessibilityIncomeTotal(String amount) {
    return 'Toplam gelir: $amount';
  }

  @override
  String accessibilityExpenseTotal(String amount) {
    return 'Toplam harcama: $amount';
  }

  @override
  String get accessibilityAddSavings => 'Bu hedefe birikim ekle';

  @override
  String get accessibilityDeleteExpense => 'Bu harcamayı sil';

  @override
  String get accessibilityEditExpense => 'Bu harcamayı düzenle';

  @override
  String get accessibilityShareExpense => 'Bu harcamayı paylaş';

  @override
  String accessibilityStreakInfo(int days, int best) {
    return 'Mevcut seri: $days gün, en iyi seri: $best gün';
  }

  @override
  String get accessibilityAiChatInput => 'Finansal sorunuzu buraya yazın';

  @override
  String get accessibilityAiSendButton => 'Yapay zeka asistanına mesaj gönder';

  @override
  String accessibilitySuggestionButton(String question) {
    return 'Hızlı soru: $question';
  }

  @override
  String accessibilitySubscriptionCard(
    String name,
    String amount,
    String cycle,
    int day,
  ) {
    return '$name aboneliği, $cycle başına $amount, $day. gün yenilenir';
  }

  @override
  String accessibilitySettingsItem(String title, String value) {
    return '$title, mevcut değer: $value';
  }

  @override
  String get accessibilityToggleOn => 'Açık';

  @override
  String get accessibilityToggleOff => 'Kapalı';

  @override
  String get accessibilityCloseSheet => 'Bu sayfayı kapat';

  @override
  String get accessibilityBackButton => 'Geri dön';

  @override
  String get accessibilityProfileButton => 'Profil menüsünü aç';

  @override
  String get accessibilityNotificationsButton => 'Bildirimleri görüntüle';

  @override
  String get navHomeTooltip => 'Ana sayfa, harcama özeti';

  @override
  String get navPursuitsTooltip => 'Hedefler, birikim amaçları';

  @override
  String get navReportsTooltip => 'Raporlar, harcama analizi';

  @override
  String get navSettingsTooltip => 'Ayarlar ve tercihler';

  @override
  String shareDefaultMessage(String link) {
    return 'Harcamalarımı saat olarak takip ediyorum! Sen de dene: $link';
  }

  @override
  String get shareInviteLink => 'Davet Linkini Paylaş';

  @override
  String get inviteFriends => 'Arkadaşlarını Davet Et';

  @override
  String get yourReferralCode => 'Senin davet kodun';

  @override
  String referralStats(int count) {
    return '$count arkadaşın katıldı';
  }

  @override
  String get referralRewardInfo => 'Her arkadaşın için 7 gün premium kazan!';

  @override
  String get codeCopied => 'Kod kopyalandı!';

  @override
  String get haveReferralCode => 'Davet kodun var mı?';

  @override
  String get referralCodeHint => 'Kodu gir (opsiyonel)';

  @override
  String get referralCodePlaceholder => 'VANTAG-XXXXX';

  @override
  String referralSuccess(String name) {
    return '$name Vantag\'a katıldı! +7 gün premium kazandın';
  }

  @override
  String get welcomeReferred => 'Hoş geldin! 7 gün premium denemen var';

  @override
  String get referralInvalidCode => 'Geçersiz davet kodu';

  @override
  String get referralCodeApplied => 'Davet kodu uygulandı!';

  @override
  String get referralSectionTitle => 'Davetler';

  @override
  String get referralShareDescription => 'Kodunu paylaş, premium gün kazan';

  @override
  String get trialMidpointTitle => 'Yarı yoldasın! ⏳';

  @override
  String trialMidpointBody(String hours) {
    return 'Deneme süren yarılandı. Şu ana kadar $hours saat biriktirdin!';
  }

  @override
  String get trialOneDayLeftTitle => 'Denemen yarın bitiyor ⏰';

  @override
  String get trialOneDayLeftBody => 'Premium\'a geç, biriktirmeye devam et!';

  @override
  String get trialEndsTodayTitle => 'Denemenin son günü! 🎁';

  @override
  String get trialEndsTodayBody => 'Bugün geçersen %50 indirim!';

  @override
  String get trialExpiredTitle => 'Seni özledik! 💜';

  @override
  String get trialExpiredBody => 'Geri dön, hedeflerine devam et';

  @override
  String get dailyReminderTitle => 'Harcamalarını girmeyi unutma! 📝';

  @override
  String get dailyReminderBody => 'Bugünkü harcamalarını saniyeler içinde gir';

  @override
  String get notificationSettingsDesc => 'Hatırlatıcılar ve güncellemeler';

  @override
  String get firstExpenseTitle => 'Harika başlangıç! 🎉';

  @override
  String firstExpenseBody(String hours) {
    return 'Bugün $hours saat biriktirdin!';
  }

  @override
  String get trialReminderEnabled => 'Deneme hatırlatmaları';

  @override
  String get trialReminderDesc => 'Deneme süren bitmeden bildirim al';

  @override
  String get dailyReminderEnabled => 'Günlük hatırlatmalar';

  @override
  String get dailyReminderDesc => 'Akşam harcama girişi hatırlatması';

  @override
  String get dailyReminderTime => 'Hatırlatma saati';

  @override
  String trialDaysRemaining(int days) {
    return 'Denemede $days gün kaldı';
  }

  @override
  String get subscriptionReminder => 'Abonelik hatırlatmaları';

  @override
  String get subscriptionReminderDesc =>
      'Abonelikler yenilenmeden önce bildirim al';

  @override
  String get thinkingReminder => '\"Düşünüyorum\" hatırlatmaları';

  @override
  String get thinkingReminderDesc =>
      'Düşündüğün öğeler için 72 saat sonra hatırlatma al';

  @override
  String get thinkingReminderTitle => 'Hala düşünüyor musun?';

  @override
  String thinkingReminderBody(String item) {
    return 'Karar verdin mi? $item';
  }

  @override
  String get willRemindIn72h => '72 saat sonra hatırlatacağız';

  @override
  String get thinkingAbout => 'Düşündüklerin';

  @override
  String addedDaysAgo(int days) {
    return '$days gün önce eklendi';
  }

  @override
  String get stillThinking => 'Hala düşünüyor musun?';

  @override
  String get stillThinkingMessage => '72 saat oldu. Karar verdin mi?';

  @override
  String get decidedYes => 'Aldım';

  @override
  String get decidedNo => 'Vazgeçtim';

  @override
  String get aiChatLimitReached =>
      'Günlük 4 AI sohbet hakkını kullandın. Sınırsız için premium\'a geç!';

  @override
  String aiChatsRemaining(int count) {
    return 'Bugün $count mesaj hakkın kaldı';
  }

  @override
  String get pursuitLimitReachedFree =>
      'Ücretsiz hesaplarda 1 aktif hedef olabilir. Sınırsız hedef için premium\'a geç!';

  @override
  String get pursuitNameRequired => 'Lütfen bir isim girin';

  @override
  String get pursuitAmountRequired => 'Lütfen bir tutar girin';

  @override
  String get pursuitAmountInvalid => 'Geçerli bir tutar girin';

  @override
  String get exportPremiumOnly => 'Dışa aktarma premium özelliği';

  @override
  String get multiCurrencyPremium =>
      'Çoklu para birimi premium özelliği. Ücretsiz kullanıcılar sadece TRY kullanabilir.';

  @override
  String get reportsPremiumOnly => 'Aylık ve yıllık raporlar premium özelliği';

  @override
  String get upgradeToPremium => 'Premium\'a Geç';

  @override
  String get premiumIncludes => 'Premium içerir:';

  @override
  String get unlimitedAiChat => 'Sınırsız AI sohbet';

  @override
  String get unlimitedPursuits => 'Sınırsız hedef';

  @override
  String get exportFeature => 'Verilerini dışa aktar';

  @override
  String get allCurrencies => 'Tüm para birimleri';

  @override
  String get fullReports => 'Detaylı raporlar';

  @override
  String get cleanShareCards => 'Temiz paylaşım kartları (filigran yok)';

  @override
  String get maybeLater => 'Belki sonra';

  @override
  String get seePremium => 'Premium\'u Gör';

  @override
  String get weeklyOnly => 'Haftalık';

  @override
  String get monthlyPro => 'Aylık (Pro)';

  @override
  String get yearlyPro => 'Yıllık (Pro)';

  @override
  String get currencyLocked => 'Sadece Premium';

  @override
  String freeUserCurrencyNote(String currency) {
    return 'Ücretsiz kullanıcılar sadece TRY kullanabilir. $currency için premium\'a geç.';
  }

  @override
  String get watermarkText => 'vantag.app';

  @override
  String get incomeTypeSalary => 'Maaş';

  @override
  String get incomeTypeBonus => 'Prim';

  @override
  String get incomeTypeGift => 'Hediye';

  @override
  String get incomeTypeRefund => 'İade';

  @override
  String get incomeTypeFreelance => 'Serbest Çalışma';

  @override
  String get incomeTypeRental => 'Kira Geliri';

  @override
  String get incomeTypeInvestment => 'Yatırım Getirisi';

  @override
  String get incomeTypeOther => 'Diğer Gelir';

  @override
  String get salaryDay => 'Maaş Günü';

  @override
  String get salaryDayTitle => 'Maaşınız ne zaman yatıyor?';

  @override
  String get salaryDaySubtitle => 'Maaş gününüzde size hatırlatacağız';

  @override
  String get salaryDayHint => 'Ayın gününü seçin (1-31)';

  @override
  String salaryDaySet(int day) {
    return 'Maaş günü $day olarak ayarlandı';
  }

  @override
  String get salaryDaySkip => 'Şimdilik geç';

  @override
  String get salaryDayNotSet => 'Belirlenmedi';

  @override
  String get currentBalance => 'Güncel Bakiye';

  @override
  String get balanceTitle => 'Güncel bakiyeniz ne kadar?';

  @override
  String get balanceSubtitle => 'Harcamalarınızı daha doğru takip edin';

  @override
  String get balanceHint => 'Banka bakiyenizi girin';

  @override
  String get balanceUpdated => 'Bakiye güncellendi';

  @override
  String get balanceOptional => 'Opsiyonel - daha sonra ekleyebilirsiniz';

  @override
  String get paydayTitle => 'Maaş Günü!';

  @override
  String get paydayMessage => 'Maaşınız yattı mı?';

  @override
  String get paydayConfirm => 'Evet, yattı!';

  @override
  String get paydayNotYet => 'Henüz değil';

  @override
  String get paydaySkip => 'Geç';

  @override
  String get paydayCelebration => 'Tebrikler! Maaş yattı';

  @override
  String get paydayUpdateBalance => 'Bakiyenizi güncelleyin';

  @override
  String get paydayNewBalance => 'Maaş sonrası yeni bakiye';

  @override
  String daysUntilPayday(int days) {
    return 'Maaşa $days gün var';
  }

  @override
  String get paydayToday => 'Bugün maaş günü!';

  @override
  String get paydayTomorrow => 'Yarın maaş günü';

  @override
  String get addIncomeTitle => 'Gelir Kaydet';

  @override
  String get addIncomeSubtitle => 'Prim, hediye, iade vb.';

  @override
  String get incomeAmount => 'Gelen tutar';

  @override
  String get incomeNotes => 'Notlar (opsiyonel)';

  @override
  String get incomeNotesHint => 'ör. Yıl sonu primi, doğum günü hediyesi...';

  @override
  String get incomeAdded => 'Gelir eklendi!';

  @override
  String incomeAddedBalance(String amount) {
    return 'Bakiye güncellendi: $amount';
  }

  @override
  String get thisMonthIncome => 'Bu Ayın Geliri';

  @override
  String get regularIncome => 'Düzenli Gelir';

  @override
  String get additionalIncome => 'Ek Gelirler';

  @override
  String get incomeBreakdown => 'Gelir Dağılımı';

  @override
  String get paydayNotificationTitle => 'Maaş Günü!';

  @override
  String get paydayNotificationBody =>
      'Maaşınız bugün yatıyor olmalı. Hesabınızı kontrol edin!';

  @override
  String get paydayNotificationEnabled => 'Maaş günü hatırlatması';

  @override
  String get paydayNotificationDesc => 'Maaş gününüzde bildirim alın';

  @override
  String get onboardingSalaryDayTitle => 'Maaş Günü Ne Zaman?';

  @override
  String get onboardingSalaryDayDesc =>
      'Maaş gününüzü söyleyin, bütçenizi daha iyi planlamanıza yardımcı olalım';

  @override
  String get onboardingBalanceTitle => 'Başlangıç Bakiyesi';

  @override
  String get onboardingBalanceDesc =>
      'Finanslarınızı doğru takip etmek için güncel bakiyenizi girin';

  @override
  String get onboardingV2Step1Title => 'Harcamalarına farklı bak';

  @override
  String get onboardingV2Step1Subtitle =>
      'Her harcamanın sana kaç saat mal olduğunu gör';

  @override
  String get onboardingV2Step1Demo => '5.000₺\'lik telefon = 20 saat çalışman';

  @override
  String get onboardingV2Step1Cta => 'Hesapla';

  @override
  String get onboardingV2Step2Title => 'Seni tanıyalım';

  @override
  String get onboardingV2Step2Income => 'Aylık gelirin';

  @override
  String get onboardingV2Step2Hours => 'Günlük çalışma saatin';

  @override
  String get onboardingV2Step2Days => 'Haftalık çalışma günün';

  @override
  String get onboardingV2Step2Cta => 'Devam';

  @override
  String get onboardingV2Step3Title => 'İlk harcamanı gir';

  @override
  String get onboardingV2Step3Subtitle => 'Değerini saat olarak gör';

  @override
  String onboardingV2Step3Result(int hours, int minutes) {
    return '= $hours saat $minutes dakika';
  }

  @override
  String get onboardingV2Step3Success =>
      'Harika! Artık her harcamanın değerini bileceksin';

  @override
  String get onboardingV2Step3Cta => 'Başla';

  @override
  String get onboardingV2SkipSetup => 'Daha sonra';

  @override
  String onboardingV2Progress(int current, int total) {
    return 'Adım $current/$total';
  }

  @override
  String get checklistTitle => 'Başlangıç Rehberi';

  @override
  String checklistProgress(int completed, int total) {
    return '$completed/$total tamamlandı';
  }

  @override
  String get checklistFirstExpenseTitle => 'İlk harcamanı ekle';

  @override
  String get checklistFirstExpenseSubtitle => 'Değerini saat olarak gör';

  @override
  String get checklistViewReportTitle => 'Raporunu incele';

  @override
  String get checklistViewReportSubtitle => 'Harcama alışkanlıklarını keşfet';

  @override
  String get checklistCreatePursuitTitle => 'Tasarruf hedefi koy';

  @override
  String get checklistCreatePursuitSubtitle =>
      'Bir şey için biriktirmeye başla';

  @override
  String get checklistNotificationsTitle => 'Bildirimleri aç';

  @override
  String get checklistNotificationsSubtitle => 'Günlük hatırlatmalar al';

  @override
  String get checklistCelebrationTitle => 'Harika başlangıç!';

  @override
  String get checklistCelebrationSubtitle =>
      'Artık Vantag\'ı kullanmaya hazırsın';

  @override
  String get emptyStateExampleTitle => 'Örnek';

  @override
  String get emptyStateExpensesMessage =>
      'Harcamalarının sana kaç saat mal olduğunu gör';

  @override
  String get emptyStateExpensesCta => 'Harcama Ekle';

  @override
  String get emptyStatePursuitsMessage =>
      'Bir hedef koy, ne kadar yaklaştığını takip et';

  @override
  String get emptyStatePursuitsCta => 'Hedef Oluştur';

  @override
  String get emptyStateReportsMessage => 'Harcama alışkanlıklarını keşfet';

  @override
  String get emptyStateReportsCta => 'Harcama Ekle';

  @override
  String get emptyStateSubscriptionsMessage =>
      'Aboneliklerini takip et, unutma';

  @override
  String get emptyStateSubscriptionsCta => 'Abonelik Ekle';

  @override
  String get emptyStateAchievementsMessage =>
      'Rozetler kazanmak için harcama ekle';

  @override
  String get emptyStateSavingsPoolMessage => 'Birikimlerini havuzda topla';

  @override
  String get milestone3DayStreakTitle => '3 Gün Serisi!';

  @override
  String get milestone3DayStreakMessage => 'Harika başlangıç, devam et!';

  @override
  String get milestone7DayStreakTitle => '1 Hafta Serisi!';

  @override
  String get milestone7DayStreakMessage =>
      'Bir hafta boyunca düzenli kullandın';

  @override
  String get milestone14DayStreakTitle => '2 Hafta Serisi!';

  @override
  String get milestone14DayStreakMessage => 'Alışkanlık oluşturmaya başladın';

  @override
  String get milestone30DayStreakTitle => '1 Ay Serisi!';

  @override
  String get milestone30DayStreakMessage => 'Bir ay boyunca her gün! İnanılmaz';

  @override
  String get milestone60DayStreakTitle => '2 Ay Serisi!';

  @override
  String get milestone60DayStreakMessage => 'Finansal farkındalık uzmanı oldun';

  @override
  String get milestone100DayStreakTitle => '100 Gün Serisi!';

  @override
  String get milestone100DayStreakMessage =>
      'Efsanevi başarı! Sen bir şampiyon';

  @override
  String get milestoneFirstSavedTitle => 'İlk Tasarruf!';

  @override
  String get milestoneFirstSavedMessage => 'İlk paranı kurtardın';

  @override
  String get milestoneSaved100Title => '100₺ Kurtardın!';

  @override
  String get milestoneSaved100Message => 'Tasarruf alışkanlığın gelişiyor';

  @override
  String get milestoneSaved1000Title => '1.000₺ Kurtardın!';

  @override
  String get milestoneSaved1000Message => 'Ciddi tasarruf yapıyorsun';

  @override
  String get milestoneSaved5000Title => '5.000₺ Kurtardın!';

  @override
  String get milestoneSaved5000Message => 'Tasarruf ustası oldun!';

  @override
  String get milestoneFirstExpenseTitle => 'İlk Adım!';

  @override
  String get milestoneFirstExpenseMessage => 'İlk harcamanı girdin';

  @override
  String get milestone10ExpensesTitle => '10 Harcama!';

  @override
  String get milestone10ExpensesMessage => 'Artık takip alışkanlığın var';

  @override
  String get milestone50ExpensesTitle => '50 Harcama!';

  @override
  String get milestone50ExpensesMessage => 'Finansal farkındalık uzmanısın';

  @override
  String get milestoneFirstPursuitTitle => 'İlk Hedef!';

  @override
  String get milestoneFirstPursuitMessage => 'Biriktirme yolculuğun başladı';

  @override
  String get milestoneFirstPursuitCompletedTitle => 'Hedef Tamamlandı!';

  @override
  String get milestoneFirstPursuitCompletedMessage => 'İlk hedefine ulaştın!';

  @override
  String get milestoneUsedAiChatTitle => 'AI Keşfi!';

  @override
  String get milestoneUsedAiChatMessage => 'Finansal asistanınla tanıştın';

  @override
  String selectTimeFilter(String filter) {
    return 'Zaman filtresi seç: $filter';
  }

  @override
  String lockedFilterPremium(String filter) {
    return '$filter, premium özellik';
  }

  @override
  String selectedFilter(String filter) {
    return '$filter, seçili';
  }

  @override
  String selectHeatmapDay(String date) {
    return 'Gün seç: $date';
  }

  @override
  String heatmapDayWithSpending(String date, String amount) {
    return '$date, $amount harcama';
  }

  @override
  String heatmapDayNoSpending(String date) {
    return '$date, harcama yok';
  }

  @override
  String get loggedOutFromAnotherDevice => 'Başka Cihazda Giriş Yapıldı';

  @override
  String get loggedOutFromAnotherDeviceMessage =>
      'Hesabınıza başka bir cihazdan giriş yapıldı. Güvenlik nedeniyle bu cihazdan çıkış yapıldı.';

  @override
  String get multiCurrencyProTitle => 'Çoklu Para Birimi';

  @override
  String get multiCurrencyProDescription =>
      'Farklı para birimlerinde gelir ve harcama girişi yapabilmek için Pro üyeliğe yükseltin. USD, EUR, GBP ve daha fazlasını kullanın.';

  @override
  String get multiCurrencyBenefit => 'Tüm para birimlerinde işlem';

  @override
  String get currencyLockedForFree => 'Para birimi değişikliği Pro özelliğidir';

  @override
  String get excelSheetExpenses => 'Harcamalar';

  @override
  String get excelSheetSummary => 'Özet';

  @override
  String get excelSheetCategories => 'Kategoriler';

  @override
  String get excelSheetTimeAnalysis => 'Zaman Analizi';

  @override
  String get excelSheetDecisions => 'Kararlar';

  @override
  String get excelSheetInstallments => 'Taksitler';

  @override
  String get excelHeaderDay => 'Gün';

  @override
  String get excelHeaderStore => 'Mağaza/Yer';

  @override
  String get excelHeaderMinutes => 'Dakika Karşılığı';

  @override
  String get excelHeaderMonthlyInstallment => 'Aylık Ödeme';

  @override
  String get excelHeaderInstallmentCount => 'Taksit';

  @override
  String get excelHeaderSimulation => 'Simülasyon';

  @override
  String get excelHeaderHoursEquiv => 'Saat Karşılığı';

  @override
  String get excelReportTitle => 'Vantag Finansal Rapor';

  @override
  String get excelReportPeriod => 'Rapor Dönemi';

  @override
  String get excelReportGeneratedAt => 'Oluşturulma Tarihi';

  @override
  String get excelTotalExpenses => 'Toplam Harcama';

  @override
  String get excelTotalTransactions => 'Toplam İşlem';

  @override
  String get excelAvgPerTransaction => 'İşlem Başına Ortalama';

  @override
  String get excelMonthlyAverage => 'Aylık Ortalama';

  @override
  String get excelDailyAverage => 'Günlük Ortalama';

  @override
  String get excelWeeklyAverage => 'Haftalık Ortalama';

  @override
  String get excelSavingsRate => 'Tasarruf Oranı';

  @override
  String get excelTotalWorkHours => 'Toplam Çalışma Saati';

  @override
  String get excelTotalWorkDays => 'Toplam Çalışma Günü';

  @override
  String get excelCategoryShare => 'Pay %';

  @override
  String get excelCategoryRank => 'Sıra';

  @override
  String get excelTopCategory => 'En Çok Harcanan';

  @override
  String get excelCategoryCount => 'İşlem Sayısı';

  @override
  String get excelCategoryAvg => 'Kategori Ortalaması';

  @override
  String get excelCategoryTotal => 'Kategori Toplamı';

  @override
  String get excelCategoryHours => 'Çalışma Saati';

  @override
  String get excelTimeTitle => 'Zaman Analizi';

  @override
  String get excelMostActiveDay => 'En Aktif Gün';

  @override
  String get excelMostActiveHour => 'En Aktif Saat';

  @override
  String get excelWeekdayAvg => 'Hafta İçi Ortalama';

  @override
  String get excelWeekendAvg => 'Hafta Sonu Ortalama';

  @override
  String get excelMorningSpend => 'Sabah (06-12)';

  @override
  String get excelAfternoonSpend => 'Öğleden Sonra (12-18)';

  @override
  String get excelEveningSpend => 'Akşam (18-24)';

  @override
  String get excelNightSpend => 'Gece (00-06)';

  @override
  String get excelByDayOfWeek => 'Haftanın Günlerine Göre';

  @override
  String get excelByHour => 'Saate Göre';

  @override
  String get excelByMonth => 'Aya Göre';

  @override
  String get excelDecisionsBought => 'Aldım';

  @override
  String get excelDecisionsThinking => 'Düşünüyorum';

  @override
  String get excelDecisionsPassed => 'Vazgeçtim';

  @override
  String get excelDecisionCount => 'Adet';

  @override
  String get excelDecisionAmount => 'Tutar';

  @override
  String get excelDecisionPercent => 'Yüzde';

  @override
  String get excelDecisionAvg => 'Ortalama';

  @override
  String get excelDecisionHours => 'Çalışma Saati';

  @override
  String get excelImpulseRate => 'Anlık Karar Oranı';

  @override
  String get excelSavingsFromPassed => 'Vazgeçerek Tasarruf';

  @override
  String get excelPotentialSavings => 'Potansiyel Tasarruf (Düşünülen)';

  @override
  String get excelInstallmentName => 'Açıklama';

  @override
  String get excelInstallmentTotal => 'Toplam Tutar';

  @override
  String get excelInstallmentMonthly => 'Aylık Ödeme';

  @override
  String get excelInstallmentProgress => 'İlerleme';

  @override
  String get excelInstallmentRemaining => 'Kalan';

  @override
  String get excelInstallmentStartDate => 'Başlangıç';

  @override
  String get excelInstallmentEndDate => 'Bitiş';

  @override
  String get excelInstallmentInterest => 'Vade Farkı';

  @override
  String get excelNoInstallments => 'Taksitli ödeme bulunmuyor';

  @override
  String get excelTotalMonthlyPayments => 'Toplam Aylık Ödemeler';

  @override
  String get excelTotalRemainingDebt => 'Toplam Kalan Borç';

  @override
  String get excelDayMonday => 'Pazartesi';

  @override
  String get excelDayTuesday => 'Salı';

  @override
  String get excelDayWednesday => 'Çarşamba';

  @override
  String get excelDayThursday => 'Perşembe';

  @override
  String get excelDayFriday => 'Cuma';

  @override
  String get excelDaySaturday => 'Cumartesi';

  @override
  String get excelDaySunday => 'Pazar';

  @override
  String get excelYes => 'Evet';

  @override
  String get excelNo => 'Hayır';

  @override
  String get excelReal => 'Gerçek';

  @override
  String get excelSimulation => 'Simülasyon';

  @override
  String get proFeaturesSheetTitle => 'Pro Özellik';

  @override
  String get proFeaturesSheetSubtitle => 'Bu özellik Pro üyelere özel';

  @override
  String get proFeaturesIncluded => 'Pro üyelik şunları içerir:';

  @override
  String get proFeatureHeatmap => 'Harcama Haritası';

  @override
  String get proFeatureHeatmapDesc => 'Yıllık harcama düzenini görselleştir';

  @override
  String get proFeatureCategoryBreakdown => 'Kategori Dağılımı';

  @override
  String get proFeatureCategoryBreakdownDesc =>
      'Kategorilere göre detaylı pasta grafik analizi';

  @override
  String get proFeatureSpendingTrends => 'Harcama Trendleri';

  @override
  String get proFeatureSpendingTrendsDesc =>
      'Harcamalarının zaman içindeki değişimini takip et';

  @override
  String get proFeatureTimeAnalysis => 'Zaman Analizi';

  @override
  String get proFeatureTimeAnalysisDesc =>
      'Gün ve saate göre en çok ne zaman harcadığını gör';

  @override
  String get proFeatureBudgetBreakdown => 'Bütçe Dağılımı';

  @override
  String get proFeatureBudgetBreakdownDesc =>
      'Bütçe hedeflerine göre harcamalarını takip et';

  @override
  String get proFeatureAdvancedFilters => 'Gelişmiş Filtreler';

  @override
  String get proFeatureAdvancedFiltersDesc =>
      'Aylık, tüm zamanlar ve daha fazla filtre';

  @override
  String get proFeatureExcelExport => 'Excel Dışa Aktarım';

  @override
  String get proFeatureExcelExportDesc => 'Tüm finansal verilerini dışa aktar';

  @override
  String get proFeatureUnlimitedHistory => 'Sınırsız Geçmiş';

  @override
  String get proFeatureUnlimitedHistoryDesc => 'Tüm geçmiş harcamalarına eriş';

  @override
  String get goProButton => 'Pro\'ya Geç';

  @override
  String get lockedFeatureTapToUnlock => 'Açmak için dokun';

  @override
  String voiceUsageIndicator(int used, int total) {
    return 'Bugün $used/$total sesli giriş';
  }

  @override
  String aiChatUsageIndicator(int used, int total) {
    return 'Bugün $used/$total soru';
  }

  @override
  String get dailyLimitReached => 'Günlük limit doldu';

  @override
  String get dailyLimitReachedDesc =>
      'Günlük kullanım hakkın bitti. Sınırsız erişim için Pro\'ya geç!';

  @override
  String get unlimitedWithPro => 'Pro ile sınırsız';

  @override
  String get backupData => 'Verileri Yedekle';

  @override
  String get backupDataDesc => 'Verilerini JSON dosyası olarak dışa aktar';

  @override
  String get restoreData => 'Yedeği Geri Yükle';

  @override
  String get restoreDataDesc => 'Yedek dosyasından verileri içe aktar';

  @override
  String get backupCreating => 'Yedek oluşturuluyor...';

  @override
  String get backupSuccess => 'Yedek başarıyla oluşturuldu';

  @override
  String get backupError => 'Yedek oluşturulamadı';

  @override
  String get restoreConfirmTitle => 'Verileri Geri Yükle?';

  @override
  String get restoreConfirmMessage =>
      'Yedek verileri mevcut verilerine eklenecek. Devam edilsin mi?';

  @override
  String restoreSuccess(int expenses, int pursuits, int subscriptions) {
    return 'Veriler geri yüklendi! $expenses harcama, $pursuits hedef, $subscriptions abonelik içe aktarıldı.';
  }

  @override
  String get restoreError => 'Veriler geri yüklenemedi';

  @override
  String get noFileSelected => 'Dosya seçilmedi';

  @override
  String get invalidBackupFormat => 'Geçersiz yedek dosyası formatı';

  @override
  String get shareApp => 'Arkadaşına Öner';

  @override
  String get shareAppDesc => 'Vantag\'ı arkadaşlarına öner';

  @override
  String get shareAppMessage =>
      'Vantag\'a bak - Her harcamanın kaç saat çalışmana mal olduğunu gösteriyor! İndir: https://play.google.com/store/apps/details?id=com.vantag.app';

  @override
  String get sendFeedback => 'Geri Bildirim Gönder';

  @override
  String get sendFeedbackDesc => 'Vantag\'ı geliştirmemize yardım et';

  @override
  String get feedbackEmailSubject => 'Vantag Geri Bildirim';

  @override
  String get rateApp => 'Uygulamayı Puanla';

  @override
  String get rateAppDesc => 'Play Store\'da puanla';

  @override
  String get whatsNew => 'Yenilikler';

  @override
  String whatsNewInVersion(String version) {
    return 'v$version Yenilikleri';
  }

  @override
  String get updateRequired => 'Güncelleme Gerekli';

  @override
  String get updateRequiredMessage =>
      'Vantag\'ın yeni bir sürümü mevcut. Devam etmek için lütfen güncelle.';

  @override
  String get updateNow => 'Şimdi Güncelle';

  @override
  String get dailyLimits => 'Günlük Limitler';

  @override
  String get aiChat => 'AI Sohbet';

  @override
  String get statementImport => 'Ekstre İçe Aktarma';

  @override
  String get subscriptionAutoRenewalNotice =>
      'Abonelik, mevcut dönem sona ermeden en az 24 saat önce iptal edilmediği sürece otomatik olarak yenilenir. Abonelikleri Ayarlar\'dan yönetin.';

  @override
  String get welcomeBackTitle3Days => 'Tekrar Hoş Geldin!';

  @override
  String get welcomeBackSubtitle3Days =>
      'Seni özledik. Harcamalarını takip etmeye devam et.';

  @override
  String get welcomeBackCta3Days => 'Harcama Ekle';

  @override
  String get welcomeBackTitle7Days => 'Geri Döndün!';

  @override
  String get welcomeBackSubtitle7Days =>
      'Bir hafta oldu. Finansal hedeflerine devam edelim.';

  @override
  String get welcomeBackCta7Days => 'Nereden Kaldık?';

  @override
  String get welcomeBackTitle14Days => 'Merhaba Yeniden!';

  @override
  String get welcomeBackSubtitle14Days =>
      'Seni bekledik. Yeni bir başlangıç yapmaya hazır mısın?';

  @override
  String get welcomeBackCta14Days => 'Yeniden Başla';

  @override
  String get welcomeBackTitle30Days => 'Hoş Geldin Geri!';

  @override
  String get welcomeBackSubtitle30Days =>
      'Uzun zaman oldu ama hedeflerine ulaşmak hâlâ mümkün!';

  @override
  String get welcomeBackCta30Days => 'Hemen Başla';

  @override
  String get welcomeBackStreakLost => 'Seriniz sıfırlandı';

  @override
  String welcomeBackStreakRecovered(int percent) {
    return 'Serinin %$percent\'i kurtarıldı!';
  }

  @override
  String get reengagementPushTitle3Days => 'Harcamalarını takip etmeyi unutma!';

  @override
  String get reengagementPushBody3Days =>
      'Bugün ne kadar tasarruf ettin? Hemen gir ve gör.';

  @override
  String get reengagementPushTitle5Days => 'Seni özledik!';

  @override
  String get reengagementPushBody5Days =>
      'Finansal hedeflerine ulaşmak için devam et.';

  @override
  String get reengagementPushTitle7Days => 'Geri dön, serinin bozulmasın!';

  @override
  String get reengagementPushBody7Days =>
      'Streak\'ini kaybetme, hemen bir harcama ekle.';

  @override
  String get reengagementUrgentTitle => 'Finansal kontrolün elden kaçmasın!';

  @override
  String get reengagementUrgentBody =>
      'Harcamalarını güncelle ve yoluna devam et.';

  @override
  String get pushOnboardingDay1Title => 'İlk harcamanı ekle!';

  @override
  String get pushOnboardingDay1Body =>
      'Bir kahve veya yemek - küçük başla, farkı gör.';

  @override
  String get pushOnboardingDay3Title => 'Kaç saat çalıştığını biliyor musun?';

  @override
  String get pushOnboardingDay3Body =>
      'Harcamalarını saat olarak görmeye devam et.';

  @override
  String get pushOnboardingDay7Title => '7 gün oldu!';

  @override
  String get pushOnboardingDay7Body =>
      'Streak başlatmak için her gün bir harcama ekle.';

  @override
  String get pushWeeklyInsightTitle => 'Haftalık Özet Hazır';

  @override
  String get pushWeeklyInsightBody =>
      'Bu hafta ne kadar tasarruf ettin? Hemen kontrol et.';

  @override
  String get pushStreakReminderNewTitle => 'Yeni bir seri başlat!';

  @override
  String get pushStreakReminderNewBody =>
      'Bugün ilk harcamanı ekle ve yolculuğa başla.';

  @override
  String pushStreakReminderShortTitle(int days) {
    return '$days günlük serin var!';
  }

  @override
  String get pushStreakReminderShortBody => 'Bugün de ekle, serini koru.';

  @override
  String pushStreakReminderMediumTitle(int days) {
    return '$days gün! Harika gidiyorsun!';
  }

  @override
  String get pushStreakReminderMediumBody =>
      'Seriyi bozmamak için bugün de ekle.';

  @override
  String pushStreakReminderLongTitle(int days) {
    return '$days günlük seri!';
  }

  @override
  String get pushStreakReminderLongBody => 'İnanılmaz bir başarı! Devam et.';

  @override
  String get pushMorningMotivationTitle => 'Günaydın!';

  @override
  String pushMorningMotivationWithSavingsBody(String symbol, String amount) {
    return 'Bu ay $symbol$amount tasarruf ettin. Devam!';
  }

  @override
  String get pushMorningMotivationDefaultBody =>
      'Bugün bir harcama ekleyerek finansal farkındalığını artır.';

  @override
  String get notificationSettingsTitle => 'Bildirim Ayarları';

  @override
  String get notificationSettingsQuietHours => 'Sessiz Saatler';

  @override
  String get notificationSettingsQuietHoursDesc =>
      'Bu saatler arasında bildirim gönderilmez';

  @override
  String get notificationSettingsPreferredTime => 'Tercih Edilen Saat';

  @override
  String get notificationSettingsPreferredTimeDesc =>
      'Bildirimlerin gönderileceği saat';

  @override
  String get notificationSettingsStreakReminders => 'Seri Hatırlatıcıları';

  @override
  String get notificationSettingsStreakRemindersDesc =>
      'Akşamları seri hatırlatması al';

  @override
  String get notificationSettingsMorningMotivation => 'Sabah Motivasyonu';

  @override
  String get notificationSettingsMorningMotivationDesc =>
      'Sabahları motivasyon mesajı al';

  @override
  String get notificationSettingsWeeklyInsights => 'Haftalık Özetler';

  @override
  String get notificationSettingsWeeklyInsightsDesc =>
      'Pazar sabahları haftalık özet al';

  @override
  String get loginPromptTitle => 'Verilerini Kaydet';

  @override
  String get loginPromptSubtitle => 'Hesabını bağla, verilerini kaybetme';

  @override
  String get loginPromptLater => 'Daha sonra';

  @override
  String get additionalIncomePromptTitle => 'Ek gelirin var mı?';

  @override
  String get additionalIncomePromptSubtitle => 'Yan iş, kira, freelance...';

  @override
  String get additionalIncomeYes => 'Evet, ekle';

  @override
  String get additionalIncomeNo => 'Hayır, yok';
}


--- FILE: lib/l10n/app_localizations_en.dart ---

// ignore: unused_import
import 'package:intl/intl.dart' as intl;
import 'app_localizations.dart';

// ignore_for_file: type=lint

/// The translations for English (`en`).
class AppLocalizationsEn extends AppLocalizations {
  AppLocalizationsEn([String locale = 'en']) : super(locale);

  @override
  String get appTitle => 'Vantag';

  @override
  String get appSlogan => 'Your Financial Edge';

  @override
  String get navExpenses => 'Expenses';

  @override
  String get navReports => 'Reports';

  @override
  String get navAchievements => 'Achievements';

  @override
  String get navProfile => 'Profile';

  @override
  String get navSettings => 'Settings';

  @override
  String get profile => 'Profile';

  @override
  String get profileSavedTime => 'Time Saved with Vantag';

  @override
  String profileHours(String hours) {
    return '$hours Hours';
  }

  @override
  String get profileMemberSince => 'Member Since';

  @override
  String profileDays(int days) {
    return '$days Days';
  }

  @override
  String get profileBadgesEarned => 'Badges Earned';

  @override
  String get profileGoogleConnected => 'Google Account Connected';

  @override
  String get profileGoogleNotConnected => 'Google Account Not Connected';

  @override
  String get profileSignOut => 'Sign Out';

  @override
  String get profileSignOutConfirm => 'Are you sure you want to sign out?';

  @override
  String get proMember => 'Pro Member';

  @override
  String get proMemberToast => 'You are a Pro Member ✓';

  @override
  String get settingsGeneral => 'General';

  @override
  String get settingsCurrency => 'Currency';

  @override
  String get settingsLanguage => 'Language';

  @override
  String get settingsTheme => 'Theme';

  @override
  String get settingsThemeDark => 'Dark';

  @override
  String get settingsThemeLight => 'Light';

  @override
  String get settingsThemeAutomatic => 'Automatic';

  @override
  String get simpleMode => 'Simple Mode';

  @override
  String get simpleModeDescription =>
      'Streamlined experience with essential features only';

  @override
  String get simpleModeEnabled => 'Simple mode is enabled';

  @override
  String get simpleModeDisabled => 'Simple mode is disabled';

  @override
  String get simpleModeHint =>
      'Turn off Simple Mode to access all features like AI chat, achievements, and pursuits';

  @override
  String get simpleTransactions => 'Transactions';

  @override
  String get simpleStatistics => 'Statistics';

  @override
  String get simpleSettings => 'Settings';

  @override
  String get simpleIncome => 'Income';

  @override
  String get simpleExpense => 'Expense';

  @override
  String get simpleExpenses => 'Expenses';

  @override
  String get simpleBalance => 'Balance';

  @override
  String get simpleTotal => 'Total';

  @override
  String get simpleTotalIncome => 'Total Income';

  @override
  String get simpleIncomeTab => 'Income';

  @override
  String get simpleIncomeSources => 'Income Sources';

  @override
  String get simpleNoTransactions => 'No transactions this month';

  @override
  String get simpleNoData => 'No data for this month';

  @override
  String get settingsNotifications => 'Notifications';

  @override
  String get settingsReminders => 'Reminders';

  @override
  String get settingsSoundEffects => 'Sound Effects';

  @override
  String get settingsSoundVolume => 'Volume';

  @override
  String get settingsProPurchases => 'Pro & Purchases';

  @override
  String get settingsVantagPro => 'Vantag Pro';

  @override
  String get settingsRestorePurchases => 'Restore Purchases';

  @override
  String get settingsRestoreSuccess => 'Purchases restored';

  @override
  String get settingsRestoreNone => 'No purchases to restore';

  @override
  String get settingsDataPrivacy => 'Data & Privacy';

  @override
  String get settingsExportData => 'Export Data';

  @override
  String get settingsImportStatement => 'Import Statement';

  @override
  String get settingsImportStatementDesc =>
      'Upload your bank statement (PDF/CSV)';

  @override
  String get importStatementTitle => 'Import Statement';

  @override
  String get importStatementSelectFile => 'Select File';

  @override
  String get importStatementSupportedFormats => 'Supported formats: PDF, CSV';

  @override
  String get importStatementDragDrop => 'Tap to select your bank statement';

  @override
  String get importStatementProcessing => 'Processing statement...';

  @override
  String importStatementSuccess(int count) {
    return 'Successfully imported $count transactions';
  }

  @override
  String get importStatementError => 'Error importing statement';

  @override
  String get importStatementNoTransactions =>
      'No transactions found in statement';

  @override
  String get importStatementUnsupportedFormat => 'Unsupported file format';

  @override
  String importStatementMonthlyLimit(int remaining) {
    return '$remaining imports remaining this month';
  }

  @override
  String get importStatementLimitReached => 'Monthly import limit reached';

  @override
  String get importStatementLimitReachedDesc =>
      'You\'ve used all your imports for this month. Upgrade to Pro for more imports.';

  @override
  String get importStatementProLimit => '10 imports/month';

  @override
  String get importStatementFreeLimit => '1 import/month';

  @override
  String get importStatementReviewTitle => 'Review Transactions';

  @override
  String get importStatementReviewDesc => 'Select transactions to import';

  @override
  String importStatementImportSelected(int count) {
    return 'Import Selected ($count)';
  }

  @override
  String get importStatementSelectAll => 'Select All';

  @override
  String get importStatementDeselectAll => 'Deselect All';

  @override
  String get settingsPrivacyPolicy => 'Privacy Policy';

  @override
  String get settingsAbout => 'About';

  @override
  String get settingsVersion => 'Version';

  @override
  String get settingsContactUs => 'Contact Us';

  @override
  String get settingsGrowth => 'Invite & get 3 days Premium free!';

  @override
  String get settingsInviteFriends => 'Invite Friends';

  @override
  String get settingsInviteMessage =>
      'I\'m tracking my expenses with Vantag! You should try it too:';

  @override
  String get dashboard => 'Dashboard';

  @override
  String get totalBalance => 'Total Balance';

  @override
  String get monthlyIncome => 'Monthly Income';

  @override
  String get totalIncome => 'Total Income';

  @override
  String get totalSpent => 'Total Spent';

  @override
  String get totalSaved => 'Total Saved';

  @override
  String get workHours => 'Work Hours';

  @override
  String get workDays => 'Work Days';

  @override
  String get expenses => 'Expenses';

  @override
  String get addExpense => 'Add Expense';

  @override
  String get amount => 'Amount';

  @override
  String get amountTL => 'Amount (₺)';

  @override
  String get category => 'Category';

  @override
  String get description => 'Description';

  @override
  String get descriptionHint => 'e.g: Migros, Spotify, Shell...';

  @override
  String get descriptionLabel => 'Description (Store/Product)';

  @override
  String get date => 'Date';

  @override
  String get today => 'Today';

  @override
  String get weekdayMon => 'Mon';

  @override
  String get weekdayTue => 'Tue';

  @override
  String get weekdayWed => 'Wed';

  @override
  String get weekdayThu => 'Thu';

  @override
  String get weekdayFri => 'Fri';

  @override
  String get weekdaySat => 'Sat';

  @override
  String get weekdaySun => 'Sun';

  @override
  String get monthJan => 'Jan';

  @override
  String get monthFeb => 'Feb';

  @override
  String get monthMar => 'Mar';

  @override
  String get monthApr => 'Apr';

  @override
  String get monthMay => 'May';

  @override
  String get monthJun => 'Jun';

  @override
  String get monthJul => 'Jul';

  @override
  String get monthAug => 'Aug';

  @override
  String get monthSep => 'Sep';

  @override
  String get monthOct => 'Oct';

  @override
  String get monthNov => 'Nov';

  @override
  String get monthDec => 'Dec';

  @override
  String get yesterday => 'Yesterday';

  @override
  String get twoDaysAgo => '2 Days Ago';

  @override
  String daysAgo(int count) {
    return '$count Days Ago';
  }

  @override
  String get bought => 'Bought';

  @override
  String get thinking => 'Thinking';

  @override
  String get passed => 'Passed';

  @override
  String get cancel => 'Cancel';

  @override
  String get ok => 'OK';

  @override
  String get save => 'Save';

  @override
  String get delete => 'Delete';

  @override
  String get edit => 'Edit';

  @override
  String get change => 'Change';

  @override
  String get close => 'Close';

  @override
  String get update => 'Update';

  @override
  String get calculate => 'Calculate';

  @override
  String get giveUp => 'Give Up';

  @override
  String get select => 'Select';

  @override
  String get decision => 'Decision';

  @override
  String hoursRequired(String hours) {
    return '$hours hours';
  }

  @override
  String daysRequired(String days) {
    return '$days days';
  }

  @override
  String minutesRequired(int minutes) {
    return '$minutes minutes';
  }

  @override
  String hoursEquivalent(String hours) {
    return '$hours hours equivalent';
  }

  @override
  String get editProfile => 'Edit Profile';

  @override
  String get settings => 'Settings';

  @override
  String get language => 'Language';

  @override
  String get selectLanguage => 'Select Language';

  @override
  String get selectCurrency => 'Select Currency';

  @override
  String get currency => 'Currency';

  @override
  String get turkish => 'Turkish';

  @override
  String get english => 'English';

  @override
  String get incomeInfo => 'Income Information';

  @override
  String get dailyWorkHours => 'Daily Work Hours';

  @override
  String get weeklyWorkDays => 'Weekly Work Days';

  @override
  String workingDaysPerWeek(int count) {
    return 'Working $count days per week';
  }

  @override
  String get hours => 'hours';

  @override
  String incomeSources(int count) {
    return '$count sources';
  }

  @override
  String get detailedEntry => 'Detailed Entry';

  @override
  String get googleAccount => 'Google Account';

  @override
  String get googleLinked => 'Google Linked';

  @override
  String get googleNotLinked => 'Google Not Linked';

  @override
  String get linkWithGoogle => 'Link with Google';

  @override
  String get linking => 'Linking...';

  @override
  String get backupAndSecure => 'Backup and secure your data';

  @override
  String get dataNotBackedUp => 'Your data is not backed up';

  @override
  String get googleLinkedSuccess => 'Google account linked successfully!';

  @override
  String get googleLinkFailed => 'Failed to link Google account';

  @override
  String get appleAccount => 'Apple Account';

  @override
  String get appleLinked => 'Apple Linked';

  @override
  String get appleNotLinked => 'Apple Not Linked';

  @override
  String get linkWithApple => 'Link with Apple';

  @override
  String get profileAppleConnected => 'Apple Account Connected';

  @override
  String get profileAppleNotConnected => 'Apple Account Not Connected';

  @override
  String get appleLinkedSuccess => 'Apple account linked successfully!';

  @override
  String get appleLinkFailed => 'Failed to link Apple account';

  @override
  String get appleSignInNotAvailable =>
      'Apple Sign In is not available on this device';

  @override
  String get editWorkHours => 'Work Hours';

  @override
  String get editWorkHoursSubtitle =>
      'Your daily work hours for time calculations';

  @override
  String hoursPerDay(String hours) {
    return '$hours hours/day';
  }

  @override
  String get workHoursUpdated => 'Work hours updated';

  @override
  String get freeCurrencyNote =>
      'Free users can only use TRY. Upgrade to Pro for all currencies.';

  @override
  String get currencyLockNote =>
      'Selected currency will be locked. Pro users can change anytime.';

  @override
  String get welcome => 'Welcome';

  @override
  String get welcomeSubtitle =>
      'Enter your information to measure expenses in time';

  @override
  String get getStarted => 'Get Started';

  @override
  String get offlineMode => 'Offline mode - Data will be synced';

  @override
  String get noInternet => 'No Internet Connection';

  @override
  String get offline => 'Offline';

  @override
  String get offlineMessage => 'Data will sync when connection is restored';

  @override
  String get backOnline => 'Back Online';

  @override
  String get dataSynced => 'Data synced successfully';

  @override
  String get reports => 'Reports';

  @override
  String get monthlyReport => 'Monthly Report';

  @override
  String get categoryReport => 'Category Report';

  @override
  String get thisMonth => 'This Month';

  @override
  String get lastMonth => 'Last Month';

  @override
  String get thisWeek => 'This Week';

  @override
  String get allTime => 'All Time';

  @override
  String get achievements => 'Achievements';

  @override
  String get badges => 'Badges';

  @override
  String get progress => 'Progress';

  @override
  String get unlocked => 'Unlocked';

  @override
  String get locked => 'Locked';

  @override
  String get streak => 'Streak';

  @override
  String get currentStreak => 'Current Streak';

  @override
  String get bestStreak => 'Best Streak';

  @override
  String streakDays(int count) {
    return '$count days';
  }

  @override
  String get subscriptions => 'Subscriptions';

  @override
  String get subscriptionsDescription =>
      'Track your recurring subscriptions like Netflix, Spotify here.';

  @override
  String get addSubscription => 'Add Subscription';

  @override
  String get monthlyTotal => 'Monthly Total';

  @override
  String get yearlyTotal => 'Yearly Total';

  @override
  String get nextPayment => 'Next Payment';

  @override
  String renewalWarning(int days) {
    return 'Renewal in $days days';
  }

  @override
  String activeSubscriptions(int count) {
    return '$count active subscriptions';
  }

  @override
  String get monthlySubscriptions => 'Monthly Subscriptions';

  @override
  String get habitCalculator => 'Habit Calculator';

  @override
  String get selectHabit => 'Select a Habit';

  @override
  String get enterAmount => 'Enter Amount';

  @override
  String get dailyAmount => 'Daily Amount';

  @override
  String get yearlyCost => 'Yearly Cost';

  @override
  String get workDaysEquivalent => 'Work Days Equivalent';

  @override
  String get shareResult => 'Share Result';

  @override
  String get habitQuestion => 'How many days does your habit cost?';

  @override
  String get calculateAndShock => 'Calculate and be shocked →';

  @override
  String get appTour => 'App Tour';

  @override
  String get repeatTour => 'Repeat App Tour';

  @override
  String get tourCompleted => 'Tour Completed';

  @override
  String get notifications => 'Notifications';

  @override
  String get notificationSettings => 'Notifications';

  @override
  String get streakReminder => 'Streak Reminder';

  @override
  String get weeklyInsights => 'Weekly Insights';

  @override
  String get error => 'Error';

  @override
  String get success => 'Success';

  @override
  String get warning => 'Warning';

  @override
  String get info => 'Info';

  @override
  String get retry => 'Retry';

  @override
  String get loading => 'Loading...';

  @override
  String get noData => 'No data available';

  @override
  String get noExpenses => 'No expenses yet';

  @override
  String get noExpensesHint => 'Enter an amount above to start';

  @override
  String get noAchievements => 'No achievements yet';

  @override
  String get recordToEarnBadge => 'Record expenses to earn badges';

  @override
  String get notEnoughDataForReports => 'Not enough data for reports';

  @override
  String get confirmDelete => 'Are you sure you want to delete?';

  @override
  String get deleteConfirmation => 'This action cannot be undone.';

  @override
  String get categoryFood => 'Food';

  @override
  String get categoryTransport => 'Transport';

  @override
  String get categoryEntertainment => 'Entertainment';

  @override
  String get categoryShopping => 'Shopping';

  @override
  String get categoryBills => 'Bills';

  @override
  String get categoryHealth => 'Health';

  @override
  String get categoryEducation => 'Education';

  @override
  String get categoryDigital => 'Digital';

  @override
  String get categoryOther => 'Other';

  @override
  String get categoryClothing => 'Clothing';

  @override
  String get categoryElectronics => 'Electronics';

  @override
  String get categorySubscription => 'Subscription';

  @override
  String get weekdayMonday => 'Monday';

  @override
  String get weekdayTuesday => 'Tuesday';

  @override
  String get weekdayWednesday => 'Wednesday';

  @override
  String get weekdayThursday => 'Thursday';

  @override
  String get weekdayFriday => 'Friday';

  @override
  String get weekdaySaturday => 'Saturday';

  @override
  String get weekdaySunday => 'Sunday';

  @override
  String get shareTitle => 'Check out my savings with Vantag!';

  @override
  String shareMessage(String amount) {
    return 'I saved $amount TL this month with Vantag!';
  }

  @override
  String get currencyRates => 'Currency Rates';

  @override
  String get currencyRatesDescription =>
      'Current USD, EUR and gold prices. Tap for details.';

  @override
  String get gold => 'Gold';

  @override
  String get dollar => 'Dollar';

  @override
  String get euro => 'Euro';

  @override
  String get moneySavedInPocket => 'Money stayed in your pocket!';

  @override
  String get greatDecision => 'Great decision!';

  @override
  String freedomCloser(String hours) {
    return 'Money stayed in pocket, you\'re $hours closer to freedom!';
  }

  @override
  String get version => 'Version';

  @override
  String get privacyPolicy => 'Privacy Policy';

  @override
  String get termsOfService => 'Terms of Service';

  @override
  String get about => 'About';

  @override
  String get dangerZone => 'Danger Zone';

  @override
  String get appVersion => 'App Version';

  @override
  String get signOut => 'Sign Out';

  @override
  String get deleteAccount => 'Delete My Account';

  @override
  String get greetingMorning => 'Good morning';

  @override
  String get greetingAfternoon => 'Good afternoon';

  @override
  String get greetingEvening => 'Good evening';

  @override
  String get financialStatus => 'Financial Status';

  @override
  String get financialSummary => 'Financial Summary';

  @override
  String get financialSummaryDescription =>
      'Your monthly income, expenses and saved money here. All data updates in real-time.';

  @override
  String get newExpense => 'New Expense';

  @override
  String get editExpense => 'Edit Expense';

  @override
  String get deleteExpense => 'Delete Expense';

  @override
  String get deleteExpenseConfirm =>
      'Are you sure you want to delete this expense?';

  @override
  String get updateExpense => 'Update';

  @override
  String get expenseHistory => 'History';

  @override
  String recordCount(int count) {
    return '$count records';
  }

  @override
  String recordCountLimited(int shown, int total) {
    return '$shown of $total records';
  }

  @override
  String get unlockFullHistory => 'Unlock Full History';

  @override
  String proHistoryDescription(int count) {
    return 'Free users can view last 30 days. Upgrade to Pro for unlimited history.';
  }

  @override
  String get upgradeToPro => 'Upgrade to Pro';

  @override
  String get streakTracking => 'Streak Tracking';

  @override
  String get streakTrackingDescription =>
      'Your streak increases with daily entries. Regular tracking is key to mindful spending!';

  @override
  String get pastDateSelection => 'Past Date Selection';

  @override
  String get pastDateSelectionDescription =>
      'You can also enter expenses from yesterday or previous days. Tap the calendar icon to select any date.';

  @override
  String get amountEntry => 'Amount Entry';

  @override
  String get amountEntryDescription =>
      'Enter the expense amount here. Use the receipt scan button to read from receipt automatically.';

  @override
  String get smartMatching => 'Smart Matching';

  @override
  String get smartMatchingDescription =>
      'Type the store or product name. Migros, A101, Starbucks... The app will automatically suggest a category!';

  @override
  String get categorySelection => 'Category Selection';

  @override
  String get categorySelectionDescription =>
      'If smart matching doesn\'t find it or you want to change, you can manually select here.';

  @override
  String get selectCategory => 'Select Category';

  @override
  String autoSelected(String category) {
    return 'Auto-selected: $category';
  }

  @override
  String get pleaseSelectCategory => 'Please select a category';

  @override
  String get subCategoryOptional => 'Sub-category (optional)';

  @override
  String get recentlyUsed => 'Recently used';

  @override
  String get suggestions => 'Suggestions';

  @override
  String get scanReceipt => 'Scan receipt';

  @override
  String get cameraCapture => 'Capture with camera';

  @override
  String get selectFromGallery => 'Select from gallery';

  @override
  String amountFound(String amount) {
    return 'Amount found: $amount ₺';
  }

  @override
  String get amountNotFound => 'Amount not found. Enter manually.';

  @override
  String get scanError => 'Scan error. Try again.';

  @override
  String get selectExpenseDate => 'Select Expense Date';

  @override
  String get decisionUpdatedBought => 'Decision updated: Bought';

  @override
  String decisionSaved(String amount) {
    return 'You passed, saved $amount TL!';
  }

  @override
  String get keepThinking => 'Keep thinking';

  @override
  String get expenseUpdated => 'Expense updated';

  @override
  String get validationEnterAmount => 'Please enter a valid amount';

  @override
  String get validationAmountPositive => 'Amount must be greater than 0';

  @override
  String get validationAmountTooHigh => 'Amount seems too high';

  @override
  String get simulationSaved => 'Saved as Simulation';

  @override
  String get simulationDescription =>
      'This amount was saved as simulation because it\'s large.';

  @override
  String get simulationInfo =>
      'Does not affect your statistics, just for reference.';

  @override
  String get understood => 'Understood';

  @override
  String get largeAmountTitle => 'Large Amount';

  @override
  String get largeAmountMessage => 'Is this a real expense or a simulation?';

  @override
  String get realExpenseButton => 'Real Expense';

  @override
  String get simulationButton => 'Simulation';

  @override
  String get monthJanuary => 'January';

  @override
  String get monthFebruary => 'February';

  @override
  String get monthMarch => 'March';

  @override
  String get monthApril => 'April';

  @override
  String get monthJune => 'June';

  @override
  String get monthJuly => 'July';

  @override
  String get monthAugust => 'August';

  @override
  String get monthSeptember => 'September';

  @override
  String get monthOctober => 'October';

  @override
  String get monthNovember => 'November';

  @override
  String get monthDecember => 'December';

  @override
  String get categoryDistribution => 'Category Distribution';

  @override
  String moreCategories(int count) {
    return '+$count more categories';
  }

  @override
  String get expenseCount => 'Expense Count';

  @override
  String boughtPassed(int bought, int passed) {
    return '$bought bought, $passed passed';
  }

  @override
  String get passRate => 'Pass Rate';

  @override
  String get doingGreat => 'You\'re doing great!';

  @override
  String get canDoBetter => 'You can do better';

  @override
  String get statistics => 'Statistics';

  @override
  String get avgDailyExpense => 'Average Daily Expense';

  @override
  String get highestSingleExpense => 'Highest Single Expense';

  @override
  String get mostDeclinedCategory => 'Most Declined Category';

  @override
  String times(int count) {
    return '$count times';
  }

  @override
  String get trend => 'Trend';

  @override
  String trendSpentThisPeriod(String amount, String period) {
    return 'You spent $amount TL this $period';
  }

  @override
  String trendSameAsPrevious(String period) {
    return 'Same spending as last $period';
  }

  @override
  String trendSpentLess(String percent, String period) {
    return 'You spent $percent% less than last $period';
  }

  @override
  String trendSpentMore(String percent, String period) {
    return 'You spent $percent% more than last $period';
  }

  @override
  String get periodWeek => 'week';

  @override
  String get periodMonth => 'month';

  @override
  String get subCategoryDetail => 'Sub-Category Detail';

  @override
  String get comparedToPrevious => 'Compared to previous period';

  @override
  String get increased => 'increased';

  @override
  String get decreased => 'decreased';

  @override
  String subCategoryChange(
    String period,
    String subCategory,
    String changeText,
    String percent,
    String previousPeriod,
  ) {
    return 'This $period your $subCategory spending $changeText by $percent% compared to last $previousPeriod.';
  }

  @override
  String get listView => 'List View';

  @override
  String get calendarView => 'Calendar View';

  @override
  String get subscription => 'subscription';

  @override
  String get workDaysPerMonth => 'work days/month';

  @override
  String everyMonthDay(int day) {
    return 'Every ${day}th of month';
  }

  @override
  String get noSubscriptionsYet => 'No subscriptions yet';

  @override
  String get addSubscriptionsLikeNetflix =>
      'Add your subscriptions like Netflix, Spotify';

  @override
  String monthlyTotalAmount(String amount) {
    return 'Monthly total: $amount TL';
  }

  @override
  String dayOfMonth(int day) {
    return 'Day $day';
  }

  @override
  String get addSubscriptionHint => 'Press + button to add a new subscription';

  @override
  String get tomorrow => 'Tomorrow';

  @override
  String daysLater(int days) {
    return 'in $days days';
  }

  @override
  String get perMonth => '/month';

  @override
  String get enterSubscriptionName => 'Enter subscription name';

  @override
  String get enterValidAmount => 'Enter a valid amount';

  @override
  String get editSubscription => 'Edit Subscription';

  @override
  String get newSubscription => 'New Subscription';

  @override
  String get subscriptionName => 'Subscription Name';

  @override
  String get subscriptionNameHint => 'Netflix, Spotify...';

  @override
  String get monthlyAmount => 'Monthly Amount';

  @override
  String get renewalDay => 'Renewal Day';

  @override
  String get active => 'Active';

  @override
  String get passivesNotIncluded =>
      'Passive subscriptions not included in notifications';

  @override
  String get autoRecord => 'Auto Record';

  @override
  String get autoRecordDescription =>
      'Expense will be automatically added on billing date';

  @override
  String get add => 'Add';

  @override
  String subscriptionCount(int count, String amount) {
    return '$count subscriptions, $amount ₺/month';
  }

  @override
  String get viewSubscriptionsInCalendar =>
      'View your subscriptions in calendar';

  @override
  String get urgentRenewalWarning => 'Urgent Renewal Warning!';

  @override
  String get upcomingRenewals => 'Upcoming Renewals';

  @override
  String renewsWithinOneHour(String name) {
    return '$name - renews within 1 hour';
  }

  @override
  String renewsWithinHours(String name, int hours) {
    return '$name - in $hours hours';
  }

  @override
  String renewsToday(String name) {
    return '$name - renews today';
  }

  @override
  String renewsTomorrow(String name) {
    return '$name - renews tomorrow';
  }

  @override
  String subscriptionsRenewingSoon(int count) {
    return '$count subscriptions renewing soon';
  }

  @override
  String amountPerMonth(String amount) {
    return '$amount ₺/month';
  }

  @override
  String get hiddenBadges => 'Hidden Badges';

  @override
  String badgesEarned(int unlocked, int total) {
    return '$unlocked / $total badges earned';
  }

  @override
  String percentComplete(String percent) {
    return '$percent% complete';
  }

  @override
  String get completed => 'Completed!';

  @override
  String get startRecordingForFirstBadge =>
      'Record an expense to earn your first badge!';

  @override
  String get greatStartKeepGoing => 'Great start, keep going!';

  @override
  String get halfwayThere => 'Halfway there, keep it up!';

  @override
  String get doingVeryWell => 'You\'re doing very well!';

  @override
  String get almostDone => 'Almost there!';

  @override
  String get allBadgesEarned => 'All badges earned, congratulations!';

  @override
  String get hiddenBadge => 'Hidden Badge';

  @override
  String get discoverHowToUnlock => 'Discover how to unlock!';

  @override
  String get difficultyEasy => 'Easy';

  @override
  String get difficultyMedium => 'Medium';

  @override
  String get difficultyHard => 'Hard';

  @override
  String get difficultyLegendary => 'Legendary';

  @override
  String get earnedToday => 'Earned today!';

  @override
  String get earnedYesterday => 'Earned yesterday';

  @override
  String daysAgoEarned(int count) {
    return '$count days ago';
  }

  @override
  String weeksAgoEarned(int count) {
    return '$count weeks ago';
  }

  @override
  String get tapToAddPhoto => 'Tap to add photo';

  @override
  String get dailyWork => 'Daily Work';

  @override
  String get weeklyWorkingDays => 'Weekly Working Days';

  @override
  String get hourlyEarnings => 'Hourly Earnings';

  @override
  String get hourAbbreviation => 'h';

  @override
  String get days => 'days';

  @override
  String get resetData => 'Reset Data';

  @override
  String get resetDataDebug => 'Reset Data (DEBUG)';

  @override
  String get resetDataTitle => 'Reset Data';

  @override
  String get resetDataMessage =>
      'All app data will be deleted. This action cannot be undone.';

  @override
  String get deleteAccountWarningTitle =>
      'You Are About to Delete Your Account';

  @override
  String get deleteAccountWarningMessage =>
      'This action cannot be undone! All your data will be permanently deleted:\n\n• Expenses\n• Income\n• Installments\n• Achievements\n• Settings';

  @override
  String get deleteAccountConfirmPlaceholder => 'Type \'I confirm\' to confirm';

  @override
  String get deleteAccountConfirmWord => 'I confirm';

  @override
  String get deleteAccountButton => 'Delete Account';

  @override
  String get deleteAccountSuccess =>
      'Your account has been successfully deleted';

  @override
  String get deleteAccountError =>
      'An error occurred while deleting your account';

  @override
  String get notificationTypes => 'Notification Types';

  @override
  String get awarenessReminder => 'Awareness Reminder';

  @override
  String get awarenessReminderDesc => '6-12 hours after high-value purchases';

  @override
  String get giveUpCongrats => 'Pass Congratulation';

  @override
  String get giveUpCongratsDesc => 'Same day motivation when you pass';

  @override
  String get streakReminderDesc => 'Evening, before streak breaks';

  @override
  String get weeklySummary => 'Weekly Summary';

  @override
  String get weeklySummaryDesc => 'Sunday weekly insight';

  @override
  String get nightModeNotice =>
      'No notifications during night hours (22:00-08:00). We won\'t disturb your sleep.';

  @override
  String get on => 'On';

  @override
  String get off => 'Off';

  @override
  String get lastUpdate => 'Last Update';

  @override
  String get rates => 'Rates';

  @override
  String get usDollar => 'US Dollar';

  @override
  String get gramGold => 'Gram Gold';

  @override
  String get tcmbNotice =>
      'Rates are from TCMB (Central Bank of the Republic of Turkey). Gold prices reflect real-time market data.';

  @override
  String get buy => 'Buy';

  @override
  String get sell => 'Sell';

  @override
  String get createOwnCategory => 'Create Your Own Category';

  @override
  String get selectEmoji => 'Select Emoji';

  @override
  String get categoryName => 'Category Name';

  @override
  String get categoryNameHint => 'e.g: Starbucks';

  @override
  String get continueButton => 'Continue';

  @override
  String get howManyDaysForHabit => 'How many days do you work for what?';

  @override
  String get selectHabitShock => 'Select a habit, be shocked';

  @override
  String get addMyOwnCategory => 'Add my own category';

  @override
  String get whatIsYourSalary => 'What\'s Your Monthly Salary?';

  @override
  String get enterNetAmount => 'Enter net take-home amount';

  @override
  String get howMuchPerTime => 'How much TL do you spend per time?';

  @override
  String get tl => 'TL';

  @override
  String get howOften => 'How often?';

  @override
  String get whatIsYourIncome => 'What\'s your monthly income?';

  @override
  String get exampleAmount => 'e.g: 20,000';

  @override
  String get dontWantToSay => 'I don\'t want to say';

  @override
  String resultDays(String value) {
    return '$value DAYS';
  }

  @override
  String yearlyHabitCost(String habit) {
    return 'You work this many days\njust for $habit yearly';
  }

  @override
  String monthlyYearlyCost(String monthly, String yearly) {
    return 'Monthly: $monthly • Yearly: $yearly';
  }

  @override
  String get shareOnStory => 'Share on Story';

  @override
  String get tryAnotherHabit => 'Try another habit';

  @override
  String get trackAllExpenses => 'Track all my expenses';

  @override
  String get habitCatCoffee => 'Coffee';

  @override
  String get habitCatSmoking => 'Smoking';

  @override
  String get habitCatEatingOut => 'Eating Out';

  @override
  String get habitCatGaming => 'Gaming';

  @override
  String get habitCatClothing => 'Clothing';

  @override
  String get habitCatTaxi => 'Taxi/Uber';

  @override
  String get freqOnceDaily => 'Once daily';

  @override
  String get freqTwiceDaily => 'Twice daily';

  @override
  String get freqEveryTwoDays => 'Every 2 days';

  @override
  String get freqOnceWeekly => 'Once weekly';

  @override
  String get freqTwoThreeWeekly => '2-3x weekly';

  @override
  String get freqFewMonthly => 'Few per month';

  @override
  String get habitSharePreText => 'This habit takes';

  @override
  String get habitShareWorkDays => 'WORK DAYS';

  @override
  String get habitSharePostText => 'of work per year';

  @override
  String get habitSharePerYear => '/year';

  @override
  String get habitShareCTA => 'How many days are your habits?';

  @override
  String get habitShareText => 'How many days are your habits? 👀 vantag.app';

  @override
  String habitShareTextWithLink(String link) {
    return 'How many days are your habits? 👀 $link';
  }

  @override
  String habitMonthlyDetail(int days, int hours) {
    return '$days days $hours hours';
  }

  @override
  String get editIncomes => 'Edit Incomes';

  @override
  String get editIncome => 'Edit Income';

  @override
  String get addIncome => 'Add Income';

  @override
  String get changePhoto => 'Photo';

  @override
  String get takePhoto => 'Take Photo';

  @override
  String get chooseFromGallery => 'Choose from Gallery';

  @override
  String get removePhoto => 'Remove Photo';

  @override
  String get photoSelectError => 'Could not select photo';

  @override
  String get editSalary => 'Salary';

  @override
  String get editSalarySubtitle => 'Update your monthly salary';

  @override
  String get daysPerWeek => 'days/week';

  @override
  String get doYouHaveOtherIncome => 'Do You Have\nOther Income?';

  @override
  String get otherIncomeDescription =>
      'You can add additional incomes like\nfreelance, rental, investment income';

  @override
  String get yesAddIncome => 'Yes, I Want to Add';

  @override
  String get noOnlySalary => 'No, Only My Salary';

  @override
  String get addAdditionalIncome => '+ Add Additional Income';

  @override
  String get additionalIncomeQuestion => 'Do you have additional income?';

  @override
  String get budgetSettings => 'Budget Settings';

  @override
  String get budgetSettingsHint =>
      'Optional. If not set, it will be calculated based on your income.';

  @override
  String get monthlySpendingLimit => 'Monthly Spending Limit';

  @override
  String get monthlySpendingLimitHint =>
      'How much do you want to spend this month?';

  @override
  String get monthlySavingsGoal => 'Monthly Savings Goal';

  @override
  String get monthlySavingsGoalHint =>
      'How much do you want to save each month?';

  @override
  String get budgetInfoMessage =>
      'The progress bar is calculated based on your remaining budget after mandatory expenses.';

  @override
  String get linkWithGoogleTitle => 'Link with Google';

  @override
  String get linkWithGoogleDescription =>
      'Securely access your data from all devices';

  @override
  String get skipForNow => 'Skip for now';

  @override
  String get incomeType => 'Income type';

  @override
  String get incomeCategorySalary => 'Salary';

  @override
  String get incomeCategoryFreelance => 'Freelance';

  @override
  String get incomeCategoryRental => 'Rental Income';

  @override
  String get incomeCategoryPassive => 'Passive Income';

  @override
  String get incomeCategoryOther => 'Other';

  @override
  String get incomeCategorySalaryDesc => 'Monthly regular salary';

  @override
  String get incomeCategoryFreelanceDesc => 'Self-employment income';

  @override
  String get incomeCategoryRentalDesc => 'Property, vehicle rental income';

  @override
  String get incomeCategoryPassiveDesc =>
      'Investment, dividends, interest etc.';

  @override
  String get incomeCategoryOtherDesc => 'Other income sources';

  @override
  String get mainSalary => 'Main Salary';

  @override
  String get descriptionOptional => 'Description (Optional)';

  @override
  String get descriptionOptionalHint => 'e.g: Upwork Project';

  @override
  String get addedIncomes => 'Added Incomes';

  @override
  String get incomeSummary => 'Income Summary';

  @override
  String get totalMonthlyIncome => 'Total Monthly Income';

  @override
  String get incomeSource => 'income source';

  @override
  String get complete => 'Complete';

  @override
  String get editMyIncomes => 'Edit My Incomes';

  @override
  String get goBack => 'Go Back';

  @override
  String get notBudgetApp => 'This is not a budget app';

  @override
  String get showRealCost => 'Show the real cost of expenses: your time.';

  @override
  String get everyExpenseDecision => 'Every expense is a decision';

  @override
  String get youDecide => 'Bought, thinking, or passed. You decide.';

  @override
  String get oneExpenseEnough => 'One expense today is enough';

  @override
  String get startSmall => 'Start small, awareness grows.';

  @override
  String get skip => 'Skip';

  @override
  String get start => 'Start';

  @override
  String get whatIsYourDecision => 'What\'s your decision?';

  @override
  String get netBalance => 'NET BALANCE';

  @override
  String sources(int count) {
    return '$count sources';
  }

  @override
  String get income => 'INCOME';

  @override
  String get expense => 'SPENT';

  @override
  String get saved => 'SAVED';

  @override
  String get budgetUsage => 'BUDGET USAGE';

  @override
  String get startToday => 'Start today!';

  @override
  String dayStreak(int count) {
    return '$count Day Streak!';
  }

  @override
  String get startStreak => 'Start Your Streak!';

  @override
  String get keepStreakMessage =>
      'Keep your streak by recording expenses daily!';

  @override
  String get startStreakMessage =>
      'Record at least 1 expense daily and build a streak!';

  @override
  String longestStreak(int count) {
    return 'Longest streak: $count days';
  }

  @override
  String get newRecord => 'New Record!';

  @override
  String withThisAmount(String amount) {
    return 'With this $amount TL you could have bought:';
  }

  @override
  String goldGrams(String grams) {
    return '${grams}g gold';
  }

  @override
  String get ratesLoading => 'Loading rates...';

  @override
  String get ratesLoadFailed => 'Failed to load rates';

  @override
  String get goldPriceNotUpdated => 'Gold price could not be updated';

  @override
  String get monthAbbreviations =>
      'Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec';

  @override
  String get updateYourDecision => 'Update your decision';

  @override
  String get simulation => 'Simulation';

  @override
  String get tapToUpdate => 'Tap to update';

  @override
  String get swipeToEditOrDelete => 'Swipe to edit or delete';

  @override
  String get pleaseEnterValidAmount => 'Please enter a valid amount';

  @override
  String get amountTooHigh => 'Amount seems too high';

  @override
  String get pleaseSelectExpenseGroup => 'Please select expense group first';

  @override
  String get categorySelectionRequired => 'Category selection is required';

  @override
  String get expenseGroup => 'Expense Group';

  @override
  String get required => 'Required';

  @override
  String get detail => 'Detail';

  @override
  String get optional => 'Optional';

  @override
  String get editYourCard => 'Edit Your Card';

  @override
  String get share => 'Share';

  @override
  String get sharing => 'Sharing...';

  @override
  String get frequency => 'Frequency';

  @override
  String get daysAbbrev => 'days';

  @override
  String get youSaved => 'saved!';

  @override
  String get noSavingsYet => 'No savings yet';

  @override
  String get categorySports => 'Sports';

  @override
  String get categoryCommunication => 'Communication';

  @override
  String get subscriptionNameExample => 'e.g: Netflix, Spotify';

  @override
  String get monthlyAmountExample => 'e.g: 99.99';

  @override
  String get color => 'Color';

  @override
  String get autoRecordOnRenewal => 'Record as expense on renewal day';

  @override
  String get deleteSubscription => 'Delete Subscription';

  @override
  String deleteSubscriptionConfirm(String name) {
    return 'Are you sure you want to delete $name subscription?';
  }

  @override
  String get subscriptionDuration => 'Subscription Duration';

  @override
  String subscriptionDurationDays(int days) {
    return '$days days';
  }

  @override
  String get totalPaid => 'Total Paid';

  @override
  String workHoursAmount(String hours) {
    return '$hours hours';
  }

  @override
  String workDaysAmount(String days) {
    return '$days days';
  }

  @override
  String get autoRecordEnabled => 'Auto-record enabled';

  @override
  String get autoRecordDisabled => 'Auto expense recording disabled';

  @override
  String get saveChanges => 'Save Changes';

  @override
  String get weekdayAbbreviations => 'Mon,Tue,Wed,Thu,Fri,Sat,Sun';

  @override
  String get homePage => 'Home';

  @override
  String get analysis => 'Analysis';

  @override
  String get reportsDescription =>
      'View monthly and category-based expense analysis here.';

  @override
  String get quickAdd => 'Quick Add';

  @override
  String get quickAddDescription =>
      'Use this button to quickly add expenses from anywhere. Practical and fast!';

  @override
  String get badgesDescription =>
      'Earn badges as you reach your savings goals. Keep your motivation high!';

  @override
  String get profileAndSettings => 'Profile & Settings';

  @override
  String get profileAndSettingsDescription =>
      'Edit income info, manage notification preferences and access app settings.';

  @override
  String get addSubscriptionButton => 'Add subscriptions like Netflix, Spotify';

  @override
  String get shareError => 'An error occurred while sharing';

  @override
  String get shareVia => 'Share via';

  @override
  String get saveToGallery => 'Save to Gallery';

  @override
  String get savedToGallery => 'Saved to gallery';

  @override
  String get otherApps => 'Other Apps';

  @override
  String get expenseDeleted => 'Expense deleted';

  @override
  String get undo => 'Undo';

  @override
  String get choosePlatform => 'Choose Platform';

  @override
  String get savingToGallery => 'Saving...';

  @override
  String get pleaseEnterValidSalary => 'Please enter a valid salary';

  @override
  String get pleaseEnterValidIncomeAmount => 'Please enter a valid amount';

  @override
  String get atLeastOneIncomeRequired =>
      'You must add at least one income source';

  @override
  String get incomesUpdated => 'Incomes updated';

  @override
  String get incomesSaved => 'Incomes saved';

  @override
  String get saveError => 'An error occurred while saving';

  @override
  String incomeSourceCount(int count) {
    return '$count income sources';
  }

  @override
  String get freedTime => 'Freed';

  @override
  String get savedAmountLabel => 'Saved';

  @override
  String get dayLabel => 'Day';

  @override
  String get zeroMinutes => '0 Minutes';

  @override
  String get zeroAmount => '0 ₺';

  @override
  String shareCardDays(int days) {
    return '$days DAYS';
  }

  @override
  String shareCardDescription(String category) {
    return 'I work this many days yearly\njust for $category';
  }

  @override
  String get shareCardQuestion => 'How many days for you?';

  @override
  String shareCardDuration(int days) {
    return 'Duration ($days days)';
  }

  @override
  String shareCardAmountLabel(String amount) {
    return 'Amount (₺$amount)';
  }

  @override
  String shareCardFrequency(String frequency) {
    return 'Frequency ($frequency)';
  }

  @override
  String get unsavedChanges => 'Unsaved Changes';

  @override
  String get unsavedChangesConfirm =>
      'Are you sure you want to exit without saving?';

  @override
  String get discardChanges => 'Discard';

  @override
  String get thinkingTime => 'Thinking time...';

  @override
  String get confirm => 'Confirm';

  @override
  String get riskLevelNone => 'Safe';

  @override
  String get riskLevelLow => 'Low Risk';

  @override
  String get riskLevelMedium => 'Medium Risk';

  @override
  String get riskLevelHigh => 'High Risk';

  @override
  String get riskLevelExtreme => 'Critical Risk';

  @override
  String savedTimeHoursDays(String hours, String days) {
    return '$hours hours = $days days saved';
  }

  @override
  String savedTimeHours(String hours) {
    return '$hours hours saved';
  }

  @override
  String savedTimeMinutes(int minutes) {
    return '$minutes minutes saved';
  }

  @override
  String couldBuyGoldGrams(String grams) {
    return 'With this money you could buy $grams grams of gold';
  }

  @override
  String equivalentWorkDays(String days) {
    return 'This equals $days days of work';
  }

  @override
  String equivalentWorkHours(String hours) {
    return 'This equals $hours hours of work';
  }

  @override
  String savedDollars(String amount) {
    return 'You saved exactly $amount dollars';
  }

  @override
  String get or => 'OR';

  @override
  String goldGramsShort(String grams) {
    return '${grams}g gold';
  }

  @override
  String get amountRequired => 'Amount is required';

  @override
  String get everyMonth => 'Every month';

  @override
  String daysCount(int count) {
    return '$count days';
  }

  @override
  String hoursCount(String count) {
    return '$count hours';
  }

  @override
  String daysCountDecimal(String count) {
    return '$count days';
  }

  @override
  String get autoRecordOn => 'Auto record enabled';

  @override
  String get autoRecordOff => 'Auto record disabled';

  @override
  String monthlyAmountTl(String amount) {
    return '$amount TL/month';
  }

  @override
  String get nameRequired => 'Name is required';

  @override
  String get amountHint => 'e.g: 99.99';

  @override
  String get updateDecision => 'Update your decision';

  @override
  String get categoryRequired => 'Category is required';

  @override
  String get monthlyAmountLabel => 'Monthly Amount (TL)';

  @override
  String withThisAmountYouCouldBuy(String amount) {
    return 'With $amount TL you could buy:';
  }

  @override
  String get workHoursDistribution => 'Work Hours Distribution';

  @override
  String get workHoursDistributionDesc =>
      'See how many hours you work for each category';

  @override
  String hoursShort(String hours) {
    return '${hours}h';
  }

  @override
  String categoryHoursBar(String hours, String percent) {
    return '$hours hours ($percent%)';
  }

  @override
  String get monthComparison => 'Month Comparison';

  @override
  String get vsLastMonth => 'vs Last Month';

  @override
  String get noLastMonthData => 'No last month data';

  @override
  String decreasedBy(String percent) {
    return '↓ $percent% decreased';
  }

  @override
  String increasedBy(String percent) {
    return '↑ $percent% increased';
  }

  @override
  String get noChange => 'No change';

  @override
  String get greatProgress => 'Great progress!';

  @override
  String get watchOut => 'Watch out!';

  @override
  String get smartInsights => 'Smart Insights';

  @override
  String get mostExpensiveDay => 'Most Expensive Day';

  @override
  String mostExpensiveDayValue(String day, String amount) {
    return '$day (avg. $amount TL)';
  }

  @override
  String get mostPassedCategory => 'Most Passed Category';

  @override
  String mostPassedCategoryValue(String category, int count) {
    return '$category ($count times)';
  }

  @override
  String get savingsOpportunity => 'Savings Opportunity';

  @override
  String savingsOpportunityValue(String category, String hours) {
    return 'Cut $category by 20% = ${hours}h saved/month';
  }

  @override
  String get weeklyTrend => 'Weekly Trend';

  @override
  String weeklyTrendValue(String trend) {
    return 'Last 4 weeks: $trend';
  }

  @override
  String get overallDecreasing => 'Overall decreasing';

  @override
  String get overallIncreasing => 'Overall increasing';

  @override
  String get stableTrend => 'Stable';

  @override
  String get noTrendData => 'Not enough data';

  @override
  String get yearlyView => 'Yearly View';

  @override
  String get yearlyHeatmap => 'Spending Trend';

  @override
  String get yearlyHeatmapDesc =>
      'Your monthly spending over the last 12 months';

  @override
  String get lowSpending => 'Low';

  @override
  String get highSpending => 'High';

  @override
  String get noSpending => 'No spending';

  @override
  String get tapDayForDetails => 'Tap a day for details';

  @override
  String get tapMonthForDetails => 'Tap a month for details';

  @override
  String selectedDayExpenses(String date, String amount, int count) {
    return '$date: $amount TL ($count expenses)';
  }

  @override
  String selectedMonthExpenses(String month, String amount, int count) {
    return '$month: $amount ($count expenses)';
  }

  @override
  String get proBadge => 'PRO';

  @override
  String get proFeature => 'Pro Feature';

  @override
  String get comingSoon => 'Coming Soon';

  @override
  String get mindfulChoice => 'Mindful Choice';

  @override
  String get mindfulChoiceExpandedDesc =>
      'What were you originally planning to buy?';

  @override
  String get mindfulChoiceCollapsedDesc =>
      'Were you going to buy something more expensive?';

  @override
  String get mindfulChoiceAmountLabel => 'Amount in Mind (₺)';

  @override
  String mindfulChoiceAmountHint(String amount) {
    return 'e.g: $amount';
  }

  @override
  String mindfulChoiceSavings(String amount) {
    return '$amount TL savings';
  }

  @override
  String get mindfulChoiceSavingsDesc =>
      'Stays in your pocket with mindful choice';

  @override
  String get tierBronze => 'Bronze';

  @override
  String get tierSilver => 'Silver';

  @override
  String get tierGold => 'Gold';

  @override
  String get tierPlatinum => 'Platinum';

  @override
  String get achievementCategoryStreak => 'Streak';

  @override
  String get achievementCategorySavings => 'Savings';

  @override
  String get achievementCategoryDecision => 'Decision';

  @override
  String get achievementCategoryRecord => 'Record';

  @override
  String get achievementCategoryHidden => 'Hidden';

  @override
  String get achievementStreakB1Title => 'Getting Started';

  @override
  String get achievementStreakB1Desc => 'Record for 3 days in a row';

  @override
  String get achievementStreakB2Title => 'Keeping Going';

  @override
  String get achievementStreakB2Desc => 'Record for 7 days in a row';

  @override
  String get achievementStreakB3Title => 'Building Routine';

  @override
  String get achievementStreakB3Desc => 'Record for 14 days in a row';

  @override
  String get achievementStreakS1Title => 'Determination';

  @override
  String get achievementStreakS1Desc => 'Record for 30 days in a row';

  @override
  String get achievementStreakS2Title => 'Habit';

  @override
  String get achievementStreakS2Desc => 'Record for 60 days in a row';

  @override
  String get achievementStreakS3Title => 'Discipline';

  @override
  String get achievementStreakS3Desc => 'Record for 90 days in a row';

  @override
  String get achievementStreakG1Title => 'Strong Will';

  @override
  String get achievementStreakG1Desc => 'Record for 150 days in a row';

  @override
  String get achievementStreakG2Title => 'Unshakeable';

  @override
  String get achievementStreakG2Desc => 'Record for 250 days in a row';

  @override
  String get achievementStreakG3Title => 'Consistency';

  @override
  String get achievementStreakG3Desc => 'Record for 365 days in a row';

  @override
  String get achievementStreakPTitle => 'Persistence';

  @override
  String get achievementStreakPDesc => 'Record for 730 days in a row';

  @override
  String get achievementSavingsB1Title => 'First Savings';

  @override
  String get achievementSavingsB1Desc => 'Saved 250 TL';

  @override
  String get achievementSavingsB2Title => 'Starting to Save';

  @override
  String get achievementSavingsB2Desc => 'Saved 500 TL';

  @override
  String get achievementSavingsB3Title => 'On the Right Path';

  @override
  String get achievementSavingsB3Desc => 'Saved 1,000 TL';

  @override
  String get achievementSavingsS1Title => 'Mindful Spending';

  @override
  String get achievementSavingsS1Desc => 'Saved 2,500 TL';

  @override
  String get achievementSavingsS2Title => 'In Control';

  @override
  String get achievementSavingsS2Desc => 'Saved 5,000 TL';

  @override
  String get achievementSavingsS3Title => 'Consistent';

  @override
  String get achievementSavingsS3Desc => 'Saved 10,000 TL';

  @override
  String get achievementSavingsG1Title => 'Strong Savings';

  @override
  String get achievementSavingsG1Desc => 'Saved 25,000 TL';

  @override
  String get achievementSavingsG2Title => 'Financial Awareness';

  @override
  String get achievementSavingsG2Desc => 'Saved 50,000 TL';

  @override
  String get achievementSavingsG3Title => 'Solid Foundation';

  @override
  String get achievementSavingsG3Desc => 'Saved 100,000 TL';

  @override
  String get achievementSavingsP1Title => 'Long-term Thinking';

  @override
  String get achievementSavingsP1Desc => 'Saved 250,000 TL';

  @override
  String get achievementSavingsP2Title => 'Financial Clarity';

  @override
  String get achievementSavingsP2Desc => 'Saved 500,000 TL';

  @override
  String get achievementSavingsP3Title => 'Big Picture';

  @override
  String get achievementSavingsP3Desc => 'Saved 1,000,000 TL';

  @override
  String get achievementDecisionB1Title => 'First Decision';

  @override
  String get achievementDecisionB1Desc => 'Passed 3 times';

  @override
  String get achievementDecisionB2Title => 'Resistance';

  @override
  String get achievementDecisionB2Desc => 'Passed 7 times';

  @override
  String get achievementDecisionB3Title => 'Control';

  @override
  String get achievementDecisionB3Desc => 'Passed 15 times';

  @override
  String get achievementDecisionS1Title => 'Determination';

  @override
  String get achievementDecisionS1Desc => 'Passed 30 times';

  @override
  String get achievementDecisionS2Title => 'Clarity';

  @override
  String get achievementDecisionS2Desc => 'Passed 60 times';

  @override
  String get achievementDecisionS3Title => 'Strong Choices';

  @override
  String get achievementDecisionS3Desc => 'Passed 100 times';

  @override
  String get achievementDecisionG1Title => 'Willpower';

  @override
  String get achievementDecisionG1Desc => 'Passed 200 times';

  @override
  String get achievementDecisionG2Title => 'Composure';

  @override
  String get achievementDecisionG2Desc => 'Passed 400 times';

  @override
  String get achievementDecisionG3Title => 'Top Level Control';

  @override
  String get achievementDecisionG3Desc => 'Passed 700 times';

  @override
  String get achievementDecisionPTitle => 'Total Mastery';

  @override
  String get achievementDecisionPDesc => 'Passed 1,000 times';

  @override
  String get achievementRecordB1Title => 'Started';

  @override
  String get achievementRecordB1Desc => '5 expense records';

  @override
  String get achievementRecordB2Title => 'Tracking';

  @override
  String get achievementRecordB2Desc => '15 expense records';

  @override
  String get achievementRecordB3Title => 'Organized';

  @override
  String get achievementRecordB3Desc => '30 expense records';

  @override
  String get achievementRecordS1Title => 'Detailed Tracking';

  @override
  String get achievementRecordS1Desc => '60 expense records';

  @override
  String get achievementRecordS2Title => 'Analytical';

  @override
  String get achievementRecordS2Desc => '120 expense records';

  @override
  String get achievementRecordS3Title => 'Systematic';

  @override
  String get achievementRecordS3Desc => '200 expense records';

  @override
  String get achievementRecordG1Title => 'Depth';

  @override
  String get achievementRecordG1Desc => '350 expense records';

  @override
  String get achievementRecordG2Title => 'Mastery';

  @override
  String get achievementRecordG2Desc => '600 expense records';

  @override
  String get achievementRecordG3Title => 'Archive';

  @override
  String get achievementRecordG3Desc => '1,000 expense records';

  @override
  String get achievementRecordPTitle => 'Long-term Record';

  @override
  String get achievementRecordPDesc => '2,000 expense records';

  @override
  String get achievementHiddenNightTitle => 'Night Record';

  @override
  String get achievementHiddenNightDesc => 'Record between 00:00-05:00';

  @override
  String get achievementHiddenEarlyTitle => 'Early Bird';

  @override
  String get achievementHiddenEarlyDesc => 'Record between 05:00-07:00';

  @override
  String get achievementHiddenWeekendTitle => 'Weekend Routine';

  @override
  String get achievementHiddenWeekendDesc => '5 records on Saturday-Sunday';

  @override
  String get achievementHiddenOcrTitle => 'First Scan';

  @override
  String get achievementHiddenOcrDesc => 'First receipt OCR usage';

  @override
  String get achievementHiddenBalancedTitle => 'Balanced Week';

  @override
  String get achievementHiddenBalancedDesc =>
      '7 days in a row with 0 \"Bought\"';

  @override
  String get achievementHiddenCategoriesTitle => 'Category Completion';

  @override
  String get achievementHiddenCategoriesDesc => 'Record in all 6 categories';

  @override
  String get achievementHiddenGoldTitle => 'Gold Equivalent';

  @override
  String get achievementHiddenGoldDesc => 'Saved money equals 1 gram of gold';

  @override
  String get achievementHiddenUsdTitle => 'Currency Equivalent';

  @override
  String get achievementHiddenUsdDesc => 'Saved money equals \$100';

  @override
  String get achievementHiddenSubsTitle => 'Subscription Control';

  @override
  String get achievementHiddenSubsDesc => 'Track 5 subscriptions';

  @override
  String get achievementHiddenNoSpendTitle => 'No-Spend Month';

  @override
  String get achievementHiddenNoSpendDesc => '0 \"Bought\" for 1 month';

  @override
  String get achievementHiddenGoldKgTitle => 'High Value Savings';

  @override
  String get achievementHiddenGoldKgDesc => 'Saved money equals 1 kg of gold';

  @override
  String get achievementHiddenUsd10kTitle => 'Major Currency Equivalent';

  @override
  String get achievementHiddenUsd10kDesc => 'Saved money equals \$10,000';

  @override
  String get achievementHiddenAnniversaryTitle => 'Usage Anniversary';

  @override
  String get achievementHiddenAnniversaryDesc => '365 days of usage';

  @override
  String get achievementHiddenEarlyAdopterTitle => 'Early Adopter';

  @override
  String get achievementHiddenEarlyAdopterDesc =>
      'Installed the app 2 years ago';

  @override
  String get achievementHiddenUltimateTitle => 'Long-term Discipline';

  @override
  String get achievementHiddenUltimateDesc =>
      '1,000,000 TL + 365 day streak at once';

  @override
  String get achievementHiddenCollectorTitle => 'Collector';

  @override
  String get achievementHiddenCollectorDesc =>
      'Collected all badges except Platinum';

  @override
  String get easterEgg5Left => '5 more...';

  @override
  String get easterEggAlmost => 'Almost...';

  @override
  String get achievementUnlocked => 'Achievement Unlocked!';

  @override
  String get curiousCatTitle => 'Too Curious';

  @override
  String get curiousCatDescription => 'You found the hidden Easter Egg!';

  @override
  String get great => 'Great!';

  @override
  String get achievementHiddenCuriousCatTitle => 'Too Curious';

  @override
  String get achievementHiddenCuriousCatDesc =>
      'You found the hidden Easter Egg!';

  @override
  String get recentExpenses => 'Recent Expenses';

  @override
  String get seeMore => 'See More';

  @override
  String get tapPlusToAdd => 'Tap + to add your first expense';

  @override
  String get expenseAdded => 'Expense added successfully';

  @override
  String get duplicateExpenseWarning => 'This expense already seems to exist';

  @override
  String duplicateExpenseDetails(String amount, String category) {
    return '$amount $category';
  }

  @override
  String get addAnyway => 'Do you still want to add it?';

  @override
  String get yes => 'Yes';

  @override
  String get no => 'No';

  @override
  String get timeAgoNow => 'just now';

  @override
  String timeAgoMinutes(int count) {
    return '$count minutes ago';
  }

  @override
  String timeAgoHours(int count) {
    return '$count hours ago';
  }

  @override
  String timeAgoDays(int count) {
    return '$count days ago';
  }

  @override
  String get exportToExcel => 'Export to Excel';

  @override
  String get exportReport => 'Export Report';

  @override
  String get exporting => 'Exporting...';

  @override
  String get exportSuccess => 'Report exported successfully';

  @override
  String get exportError => 'Export failed';

  @override
  String get exportComplete => 'Export Complete';

  @override
  String get exportShareOption => 'Share';

  @override
  String get exportSaveOption => 'Save to Files';

  @override
  String get exportSavedToDownloads => 'Saved to Downloads/Vantag';

  @override
  String get exportChooseAction => 'What would you like to do with the file?';

  @override
  String get csvHeaderDate => 'Date';

  @override
  String get csvHeaderTime => 'Time';

  @override
  String get csvHeaderAmount => 'Amount';

  @override
  String get csvHeaderCurrency => 'Currency';

  @override
  String get csvHeaderCategory => 'Category';

  @override
  String get csvHeaderSubcategory => 'Subcategory';

  @override
  String get csvHeaderDescription => 'Description';

  @override
  String get csvHeaderProduct => 'Product';

  @override
  String get csvHeaderDecision => 'Decision';

  @override
  String get csvHeaderWorkHours => 'Work Hours';

  @override
  String get csvHeaderInstallment => 'Installment';

  @override
  String get csvHeaderMandatory => 'Mandatory';

  @override
  String get csvSummarySection => 'SUMMARY';

  @override
  String get csvTotalExpense => 'Total Expense';

  @override
  String get csvCategoryTotals => 'Category Totals';

  @override
  String get csvDailyAverage => 'Daily Average';

  @override
  String get csvWeeklyAverage => 'Weekly Average';

  @override
  String get csvTopCategory => 'Top Category';

  @override
  String get csvLargestExpense => 'Largest Expense';

  @override
  String get csvTotalWorkHours => 'Total Work Hours';

  @override
  String get csvPeriod => 'Period';

  @override
  String get csvYes => 'Yes';

  @override
  String get csvNo => 'No';

  @override
  String get financialReport => 'Financial Summary Report';

  @override
  String get createdAt => 'Created';

  @override
  String get savingsRate => 'Savings Rate';

  @override
  String get hourlyRate => 'Hourly Rate';

  @override
  String get workHoursEquivalent => 'Work Hours Equivalent';

  @override
  String get transactionCount => 'Transaction Count';

  @override
  String get average => 'Average';

  @override
  String get percentage => 'Percentage';

  @override
  String get total => 'Total';

  @override
  String get monthly => 'Monthly';

  @override
  String get yearly => 'Yearly';

  @override
  String get changePercent => 'Change %';

  @override
  String get month => 'Month';

  @override
  String get originalAmount => 'Original Amount';

  @override
  String get nextRenewal => 'Next Renewal';

  @override
  String get yearlyAmount => 'Yearly Amount';

  @override
  String get badge => 'Badge';

  @override
  String get status => 'Status';

  @override
  String get earnedDate => 'Earned Date';

  @override
  String get totalBadges => 'Total Badges';

  @override
  String get proFeatureExport => 'Excel Export is a Pro feature';

  @override
  String get upgradeForExport => 'Upgrade to Pro to export your financial data';

  @override
  String get importPremiumOnly => 'Import is a Pro feature';

  @override
  String get upgradeForImport =>
      'Upgrade to Pro to import your bank statements';

  @override
  String get receiptScanned => 'Receipt scanned successfully';

  @override
  String get noAmountFound => 'No amount found in the image';

  @override
  String saveAllRecognized(int count) {
    return 'Save All ($count)';
  }

  @override
  String saveAllRecognizedSuccess(int count) {
    return '$count expenses saved successfully';
  }

  @override
  String get budgets => 'Budgets';

  @override
  String get budget => 'Budget';

  @override
  String get addBudget => 'Add Budget';

  @override
  String get editBudget => 'Edit Budget';

  @override
  String get deleteBudget => 'Delete Budget';

  @override
  String get deleteBudgetConfirm =>
      'Are you sure you want to delete this budget?';

  @override
  String get monthlyLimit => 'Monthly Limit';

  @override
  String get budgetProgress => 'Budget Progress';

  @override
  String get totalBudget => 'Total Budget';

  @override
  String remainingAmount(String amount) {
    return '$amount remaining';
  }

  @override
  String overBudgetAmount(String amount) {
    return '$amount over!';
  }

  @override
  String ofBudget(String spent, String total) {
    return '$spent of $total';
  }

  @override
  String get onTrack => 'On track';

  @override
  String get nearLimit => 'Near limit';

  @override
  String get overLimit => 'Over limit';

  @override
  String get noBudgetsYet => 'No budgets yet';

  @override
  String get noBudgetsDescription =>
      'Set budgets to track your spending by category';

  @override
  String get budgetHelperText =>
      'Set a monthly spending limit for this category';

  @override
  String get budgetExceededTitle => 'Budget Exceeded!';

  @override
  String budgetExceededMessage(String category, String amount) {
    return 'You\'ve exceeded your $category budget by $amount';
  }

  @override
  String get budgetNearLimit => 'Approaching budget limit';

  @override
  String budgetNearLimitMessage(String percent, String category) {
    return 'You\'ve used $percent% of your $category budget';
  }

  @override
  String categoriesOnTrack(int count) {
    return '$count on track';
  }

  @override
  String categoriesOverBudget(int count) {
    return '$count over budget';
  }

  @override
  String categoriesNearLimit(int count) {
    return '$count near limit';
  }

  @override
  String get categories => 'categories';

  @override
  String get viewAll => 'View All';

  @override
  String get viewBudgetsInReports => 'View budget details in Reports tab';

  @override
  String pendingCategorization(int count) {
    return '$count expenses pending categorization';
  }

  @override
  String suggestionsAvailable(int count) {
    return '$count suggestions available';
  }

  @override
  String get reviewExpenses => 'Review Expenses';

  @override
  String get swipeToCategorizeTip => 'Tap a category to categorize';

  @override
  String get rememberMerchant => 'Remember this merchant';

  @override
  String suggestionLabel(String name) {
    return 'Suggestion: $name';
  }

  @override
  String get suggested => 'Suggested';

  @override
  String get allCategorized => 'All Done!';

  @override
  String categorizedCount(int processed, int skipped) {
    return '$processed categorized, $skipped skipped';
  }

  @override
  String get importStatement => 'Import Statement';

  @override
  String get importCSV => 'Import CSV';

  @override
  String get importFromBank => 'Import from Bank';

  @override
  String get selectCSVFile => 'Select CSV file';

  @override
  String get importingExpenses => 'Importing expenses...';

  @override
  String importSuccess(int count) {
    return '$count expenses imported successfully';
  }

  @override
  String get importError => 'Import failed';

  @override
  String recognizedExpenses(int count) {
    return '$count recognized';
  }

  @override
  String pendingExpenses(int count) {
    return '$count pending review';
  }

  @override
  String get importSummary => 'Import Summary';

  @override
  String get autoMatched => 'Auto-matched';

  @override
  String get needsReview => 'Needs Review';

  @override
  String get startReview => 'Start Review';

  @override
  String get importAIParsed => 'AI Parsed Transactions';

  @override
  String get importNoTransactions => 'No transactions found in this file';

  @override
  String importSelected(int count) {
    return 'Save $count Selected';
  }

  @override
  String get transactions => 'transactions';

  @override
  String get selectAll => 'Select All';

  @override
  String get selectNone => 'Select None';

  @override
  String get selected => 'selected';

  @override
  String get saving => 'Saving...';

  @override
  String get learnedMerchants => 'Learned Merchants';

  @override
  String get noLearnedMerchants => 'No learned merchants yet';

  @override
  String get learnedMerchantsDescription =>
      'Merchants you categorize will appear here';

  @override
  String merchantCount(int count) {
    return '$count merchants learned';
  }

  @override
  String get deleteMerchant => 'Delete Merchant';

  @override
  String get deleteMerchantConfirm =>
      'Are you sure you want to delete this merchant?';

  @override
  String get voiceInput => 'Voice Input';

  @override
  String get listening => 'Listening...';

  @override
  String get voiceNotAvailable => 'Voice input is not available on this device';

  @override
  String get microphonePermissionDenied => 'Microphone permission denied';

  @override
  String get microphonePermissionRequired => 'Microphone permission required';

  @override
  String get networkRequired => 'Internet connection required';

  @override
  String get understanding => 'Understanding...';

  @override
  String get couldNotUnderstandTryAgain => 'Could not understand, try again';

  @override
  String get couldNotUnderstandSayAgain => 'Could not understand, say again';

  @override
  String get sayAgain => 'Say again';

  @override
  String get yesSave => 'Yes, save';

  @override
  String voiceExpenseAdded(String amount, String description) {
    return '$amount₺ $description added';
  }

  @override
  String get voiceConfirmExpense => 'Confirm Expense';

  @override
  String voiceDetectedAmount(String amount) {
    return 'Detected: $amount₺';
  }

  @override
  String get tapToSpeak => 'Tap to speak';

  @override
  String get speakExpense => 'Say your expense (e.g. \"50 lira coffee\")';

  @override
  String get voiceParsingFailed => 'Could not understand. Please try again.';

  @override
  String get voiceHighConfidence => 'Auto-saved';

  @override
  String get voiceMediumConfidence => 'Tap to edit';

  @override
  String get voiceLowConfidence => 'Please confirm';

  @override
  String get speakYourExpense => 'Speak your expense';

  @override
  String get longPressForVoice => 'Long-press for voice input';

  @override
  String get didYouKnow => 'Did you know?';

  @override
  String get voiceTipMessage =>
      'Add expenses faster! Long-press + button and say: \"50 lira coffee\"';

  @override
  String get gotIt => 'Got It';

  @override
  String get tryNow => 'Try Now';

  @override
  String get voiceAndShortcuts => 'Voice & Shortcuts';

  @override
  String get newBadge => 'NEW';

  @override
  String get voiceInputHint => 'Long-press + button for voice';

  @override
  String get howToUseVoice => 'How to Use Voice';

  @override
  String get voiceLimitReachedTitle => 'Daily Limit Reached';

  @override
  String get voiceLimitReachedFree =>
      'You\'ve used your daily voice input. Upgrade to Pro for unlimited access or try again tomorrow.';

  @override
  String get voiceServerBusyTitle => 'Servers Busy';

  @override
  String get voiceServerBusyMessage =>
      'Voice servers are busy right now. Please try again shortly.';

  @override
  String get longPressFab => 'Long-Press + Button';

  @override
  String get longPressFabHint => 'Hold for 1 second';

  @override
  String get micButton => 'Microphone Button';

  @override
  String get micButtonHint => 'Tap mic when adding expense';

  @override
  String get exampleCommands => 'Example Commands';

  @override
  String get voiceExample1 => '\"50 dollars for coffee\"';

  @override
  String get voiceExample2 => '\"Spent 200 on groceries\"';

  @override
  String get voiceExample3 => '\"Taxi was 150\"';

  @override
  String get voiceExamplesMultiline =>
      '\"50 dollars coffee\"\n\"spent 200 on groceries\"\n\"taxi was 150\"';

  @override
  String get somethingWentWrong => 'Something went wrong. Please try again.';

  @override
  String get errorLoadingData => 'Error loading data';

  @override
  String get errorSaving => 'Error saving. Please try again.';

  @override
  String get networkError => 'Network error. Check your connection.';

  @override
  String get errorLoadingRates => 'Could not load exchange rates';

  @override
  String get errorLoadingSubscriptions => 'Could not load subscriptions';

  @override
  String get autoRecorded => 'Auto';

  @override
  String autoRecordedExpenses(int count) {
    return '$count subscription(s) auto-recorded';
  }

  @override
  String get security => 'Security';

  @override
  String get pinLock => 'PIN Lock';

  @override
  String get pinLockDescription => 'Require PIN to open app';

  @override
  String get biometricUnlock => 'Biometric Unlock';

  @override
  String get biometricDescription => 'Use fingerprint or Face ID';

  @override
  String get enterPin => 'Enter PIN';

  @override
  String get createPin => 'Create PIN';

  @override
  String get createPinDescription => 'Choose a 4-digit PIN';

  @override
  String get confirmPin => 'Confirm PIN';

  @override
  String get confirmPinDescription => 'Enter your PIN again';

  @override
  String get wrongPin => 'Wrong PIN. Try again.';

  @override
  String get pinMismatch => 'PINs don\'t match. Try again.';

  @override
  String get pinSet => 'PIN set successfully';

  @override
  String get useBiometric => 'Use Biometric';

  @override
  String get unlockWithBiometric => 'Unlock Vantag';

  @override
  String get reset => 'Reset';

  @override
  String get assistantSetupTitle => 'Google Assistant Setup';

  @override
  String get assistantSetupHeadline => 'Add expenses without saying \"Vantag\"';

  @override
  String get assistantSetupSubheadline =>
      'After this setup, just say\n\"Hey Google, add expense\"';

  @override
  String get assistantSetupComplete =>
      'Great! Now you can say \"Hey Google, add expense\"';

  @override
  String get assistantSetupStep1Title => 'Open Google Assistant';

  @override
  String get assistantSetupStep1Desc =>
      'Say \"Hey Google, settings\" or open the Google Assistant app.';

  @override
  String get assistantSetupStep1Tip =>
      'Tap the profile icon in the bottom right corner.';

  @override
  String get assistantSetupStep2Title => 'Go to Routines';

  @override
  String get assistantSetupStep2Desc =>
      'Find and tap \"Routines\" in the settings.';

  @override
  String get assistantSetupStep2Tip =>
      'May also appear as \"Shortcuts\" on some devices.';

  @override
  String get assistantSetupStep3Title => 'Create New Routine';

  @override
  String get assistantSetupStep3Desc =>
      'Tap the \"+\" or \"New routine\" button.';

  @override
  String get assistantSetupStep3Tip => 'Usually in the bottom right corner.';

  @override
  String get assistantSetupStep4Title => 'Add Voice Command';

  @override
  String get assistantSetupStep4Desc =>
      'Tap \"When I say\" and add a voice command.\n\nType \"add expense\".';

  @override
  String get assistantSetupStep4Tip =>
      'You can also use \"log expense\" or \"record spending\".';

  @override
  String get assistantSetupStep5Title => 'Add Action';

  @override
  String get assistantSetupStep5Desc =>
      '\"Add action\" → \"Open app\" → Select \"Vantag\".';

  @override
  String get assistantSetupStep5Tip =>
      'Search for Vantag if not visible in the list.';

  @override
  String get assistantSetupStep6Title => 'Save';

  @override
  String get assistantSetupStep6Desc => 'Tap \"Save\" in the top right corner.';

  @override
  String get assistantSetupStep6Tip => 'You may be asked to name the routine.';

  @override
  String get step => 'Step';

  @override
  String get next => 'Next';

  @override
  String get back => 'Back';

  @override
  String get laterButton => 'I\'ll do it later';

  @override
  String get monthlySpendingBreakdown => 'Monthly Spending Breakdown';

  @override
  String get mandatoryExpenses => 'Mandatory';

  @override
  String get discretionaryExpenses => 'Discretionary';

  @override
  String remainingHoursToSpend(String hours) {
    return '$hours hours left to spend';
  }

  @override
  String budgetExceeded(String amount) {
    return 'You exceeded your budget by $amount!';
  }

  @override
  String get activeInstallments => 'Active Installments';

  @override
  String installmentCount(int count) {
    return '$count installments';
  }

  @override
  String moreInstallments(int count) {
    return '+$count more installments';
  }

  @override
  String get monthlyBurden => 'Monthly Burden';

  @override
  String get remainingDebt => 'Remaining Debt';

  @override
  String totalInterestCost(String amount, String hours) {
    return 'Total interest: $amount ($hours hours)';
  }

  @override
  String get monthAbbreviation => 'mo';

  @override
  String get installmentsLabel => 'installments';

  @override
  String get remaining => 'Remaining';

  @override
  String get paywallTitle => 'Upgrade to Premium';

  @override
  String get paywallSubtitle =>
      'Unlock all features and achieve your financial freedom';

  @override
  String get subscribeToPro => 'Subscribe to Pro';

  @override
  String get startFreeTrial => 'Start 7-Day Free Trial';

  @override
  String get freeTrialBanner => '7 DAYS FREE';

  @override
  String get freeTrialDescription =>
      'First 7 days completely free, cancel anytime';

  @override
  String trialThenPrice(String price) {
    return 'Then $price/month after trial';
  }

  @override
  String get noPaymentNow => 'No payment required now';

  @override
  String get restorePurchases => 'Restore purchases';

  @override
  String get feature => 'Feature';

  @override
  String get featureAiChat => 'AI Chat';

  @override
  String get featureAiChatFree => '4/day';

  @override
  String get featureHistory => 'History';

  @override
  String get featureHistory30Days => '30 days';

  @override
  String get featureExport => 'Excel Export';

  @override
  String get featureWidgets => 'Widgets';

  @override
  String get featureAds => 'Ads';

  @override
  String get featureUnlimited => 'Unlimited';

  @override
  String get featureYes => 'Yes';

  @override
  String get featureNo => 'No';

  @override
  String get weekly => 'Weekly';

  @override
  String get week => 'week';

  @override
  String get year => 'year';

  @override
  String get bestValue => 'Best Value';

  @override
  String get yearlySavings => 'Save up to 50%';

  @override
  String get cancelAnytime => 'Cancel anytime';

  @override
  String get aiLimitReached => 'Daily AI limit reached';

  @override
  String aiLimitMessage(int used, int limit) {
    return 'You\'ve used $used/$limit AI chats today. Upgrade to Pro for unlimited access.';
  }

  @override
  String get historyLimitReached => 'History limit reached';

  @override
  String get historyLimitMessage =>
      'Free plan only shows last 30 days. Upgrade to Pro for full history access.';

  @override
  String get exportProOnly => 'Excel export is a Pro feature';

  @override
  String remainingAiUses(int count) {
    return '$count AI uses left';
  }

  @override
  String get lifetime => 'Lifetime';

  @override
  String get lifetimeDescription =>
      'Pay once, use forever • 100 AI credits/month';

  @override
  String get oneTime => 'one-time';

  @override
  String get forever => 'FOREVER';

  @override
  String get mostPopular => 'MOST POPULAR';

  @override
  String monthlyCredits(int count) {
    return '$count AI credits/month';
  }

  @override
  String proMonthlyCredits(int remaining, int limit) {
    return '$remaining/$limit monthly credits';
  }

  @override
  String get aiLimitFreeTitleEmoji => '🔒 Daily AI Limit Reached!';

  @override
  String get aiLimitProTitleEmoji => '⏳ Monthly AI Limit Reached!';

  @override
  String get aiLimitFreeMessage => 'You\'ve used all 4 AI questions for today.';

  @override
  String get aiLimitProMessage =>
      'You\'ve used all 500 AI questions this month.';

  @override
  String get aiLimitLifetimeMessage =>
      'You\'ve used all 200 AI credits this month.';

  @override
  String aiLimitResetDate(String day, String month, int days) {
    return 'Limit resets on $month $day ($days days left)';
  }

  @override
  String get aiLimitUpgradeToPro => '🚀 Upgrade to Pro - Unlimited AI';

  @override
  String get aiLimitBuyCredits => '🔋 Buy Extra Credit Pack';

  @override
  String get aiLimitTryTomorrow => 'or try again tomorrow';

  @override
  String aiLimitOrWaitDays(int days) {
    return 'or wait $days days for reset';
  }

  @override
  String get creditPurchaseTitle => 'Buy Credits';

  @override
  String get creditPurchaseHeader => 'Top Up AI Credits';

  @override
  String get creditPurchaseSubtitle =>
      'Purchase extra credits for AI queries beyond your monthly limit.';

  @override
  String get creditCurrentBalance => 'Current Balance';

  @override
  String creditAmount(int credits) {
    return '$credits Credits';
  }

  @override
  String creditPackTitle(int credits) {
    return '$credits Credits';
  }

  @override
  String creditPackPricePerCredit(String price) {
    return '₺$price per credit';
  }

  @override
  String get creditPackPopular => 'MOST POPULAR';

  @override
  String get creditPackBestValue => 'BEST VALUE';

  @override
  String get creditNeverExpire => 'Credits never expire, use them anytime';

  @override
  String creditPurchaseSuccess(int credits) {
    return '$credits credits added to your account!';
  }

  @override
  String get pursuits => 'My Dreams';

  @override
  String get myPursuits => 'My Dreams';

  @override
  String get navPursuits => 'Dreams';

  @override
  String get createPursuit => 'New Dream';

  @override
  String get pursuitName => 'What are you saving for?';

  @override
  String get pursuitNameHint => 'e.g: iPhone 16, Maldives Vacation...';

  @override
  String get targetAmount => 'Target Amount';

  @override
  String get savedAmount => 'Saved';

  @override
  String get addSavings => 'Add Money';

  @override
  String pursuitProgress(int percent) {
    return '$percent% complete';
  }

  @override
  String daysToGoal(int days) {
    return '≈ $days work days';
  }

  @override
  String get pursuitCompleted => 'Your Dream Came True!';

  @override
  String get congratulations => 'Congratulations!';

  @override
  String pursuitCompletedMessage(int days, String amount) {
    return 'You saved $amount in $days days!';
  }

  @override
  String get shareProgress => 'Share Progress';

  @override
  String get activePursuits => 'Active';

  @override
  String get completedPursuits => 'Completed';

  @override
  String get archivePursuit => 'Archive';

  @override
  String get deletePursuit => 'Delete';

  @override
  String get editPursuit => 'Edit';

  @override
  String get deletePursuitConfirm =>
      'Are you sure you want to delete this dream?';

  @override
  String get pursuitCategoryTech => 'Tech';

  @override
  String get pursuitCategoryTravel => 'Travel';

  @override
  String get pursuitCategoryHome => 'Home';

  @override
  String get pursuitCategoryFashion => 'Fashion';

  @override
  String get pursuitCategoryVehicle => 'Vehicle';

  @override
  String get pursuitCategoryEducation => 'Education';

  @override
  String get pursuitCategoryHealth => 'Health';

  @override
  String get pursuitCategoryOther => 'Other';

  @override
  String get emptyPursuitsTitle => 'Take a Step Toward Your Dream';

  @override
  String get emptyPursuitsMessage => 'Add your first dream and start saving!';

  @override
  String get addFirstPursuit => 'Add Your First Dream';

  @override
  String get pursuitLimitReached => 'Upgrade to Pro for unlimited dreams';

  @override
  String get quickAmounts => 'Quick Amounts';

  @override
  String get addNote => 'Add note (optional)';

  @override
  String get pursuitCreated => 'Dream created!';

  @override
  String get savingsAdded => 'Added!';

  @override
  String workHoursRemaining(String hours) {
    return '$hours work hours remaining';
  }

  @override
  String get pursuitInitialSavings => 'Initial Savings';

  @override
  String get pursuitInitialSavingsHint => 'Amount you\'ve already saved';

  @override
  String get pursuitSelectCategory => 'Select Category';

  @override
  String get redirectSavings => 'Redirect Savings to Dream';

  @override
  String redirectSavingsMessage(String amount) {
    return 'Which dream would you like to add the $amount you saved?';
  }

  @override
  String get skipRedirect => 'Skip for Now';

  @override
  String get pursuitTransactionHistory => 'Transaction History';

  @override
  String get noTransactions => 'No transactions yet';

  @override
  String get transactionSourceManual => 'Manual Entry';

  @override
  String get transactionSourcePool => 'Pool Transfer';

  @override
  String get transactionSourceExpense => 'Cancelled Expense';

  @override
  String get savingsPool => 'Savings Pool';

  @override
  String get savingsPoolAvailable => 'available';

  @override
  String get savingsPoolDebt => 'You owe';

  @override
  String shadowDebtMessage(String amount) {
    return 'You borrowed $amount from your future self';
  }

  @override
  String budgetShiftQuestion(String amount) {
    return 'Where did this $amount come from?';
  }

  @override
  String get jokerUsed => 'You used this month\'s joker';

  @override
  String get jokerAvailable => 'You have a joker available!';

  @override
  String allocatedToDreams(String amount) {
    return '$amount allocated to dreams';
  }

  @override
  String get extraIncome => 'I earned extra income';

  @override
  String get useJoker => 'Use Joker (1/month)';

  @override
  String get budgetShiftFromFood => 'From my food budget';

  @override
  String get budgetShiftFromEntertainment => 'From my entertainment budget';

  @override
  String get budgetShiftFromClothing => 'From my clothing budget';

  @override
  String get budgetShiftFromTransport => 'From my transport budget';

  @override
  String get budgetShiftFromShopping => 'From my shopping budget';

  @override
  String get budgetShiftFromHealth => 'From my health budget';

  @override
  String get budgetShiftFromEducation => 'From my education budget';

  @override
  String get insufficientFunds => 'Insufficient funds';

  @override
  String insufficientFundsMessage(String available, String requested) {
    return 'Pool has $available, you want $requested';
  }

  @override
  String get createShadowDebt => 'Add anyway (create debt)';

  @override
  String debtRepaidMessage(String amount) {
    return '$amount paid towards your debt!';
  }

  @override
  String get poolSummaryTotal => 'Total Savings';

  @override
  String get poolSummaryAllocated => 'Allocated to Dreams';

  @override
  String get poolSummaryAvailable => 'Available';

  @override
  String get overAllocationTitle => 'Insufficient Pool Balance';

  @override
  String overAllocationMessage(String available, String requested) {
    return 'Pool has $available. You want to add $requested.';
  }

  @override
  String get fromMyPocket => 'Add from my pocket';

  @override
  String fromMyPocketDesc(String difference) {
    return 'Zero out pool + add $difference from pocket';
  }

  @override
  String get deductFromFuture => 'Deduct from future savings';

  @override
  String deductFromFutureDesc(String amount) {
    return 'Pool will go negative by $amount';
  }

  @override
  String transferAvailableOnly(String amount) {
    return 'Transfer only $amount';
  }

  @override
  String get transferAvailableOnlyDesc =>
      'Add only what\'s available in the pool';

  @override
  String get oneTimeIncomeTitle => 'Where is this money from?';

  @override
  String get oneTimeIncomeDesc => 'Your pool is in debt. Choose the source:';

  @override
  String get oneTimeIncomeOption => 'One-time income';

  @override
  String get oneTimeIncomeOptionDesc =>
      'Doesn\'t affect the pool, goes directly to goal';

  @override
  String get fromSavingsOption => 'From my savings';

  @override
  String get fromSavingsOptionDesc => 'Pool will go further negative';

  @override
  String debtWarningOnPurchase(String amount) {
    return 'You owe $amount to your dreams!';
  }

  @override
  String get debtReminderNotification =>
      'Don\'t forget to pay off your debt to your dreams!';

  @override
  String get aiThinking => 'Thinking...';

  @override
  String get aiSuggestion1 => 'Where did I spend this month?';

  @override
  String get aiSuggestion2 => 'Where can I save money?';

  @override
  String get aiSuggestion3 => 'What\'s my most expensive habit?';

  @override
  String get aiSuggestion4 => 'How far am I from my goal?';

  @override
  String get aiPremiumUpsell =>
      'Get detailed analysis and personal savings plan with Premium';

  @override
  String get aiPremiumButton => 'Go Premium';

  @override
  String get aiInputPlaceholderFree => 'Ask your own question 🔒';

  @override
  String get aiInputPlaceholder => 'Ask something...';

  @override
  String get onboardingTryTitle => 'Let\'s Try!';

  @override
  String get onboardingTrySubtitle =>
      'Curious how long you\'d work for something?';

  @override
  String get onboardingTryButton => 'Calculate';

  @override
  String get onboardingTryDisclaimer =>
      'This was just to show how abstract money is and how concrete time is.';

  @override
  String get onboardingTryNotSaved =>
      'Don\'t worry, this wasn\'t saved to your expenses.';

  @override
  String get onboardingContinue => 'Continue to App';

  @override
  String onboardingTryResult(String hours) {
    return 'This expense takes $hours hours from your life';
  }

  @override
  String get subscriptionPriceHint => '\$9.99';

  @override
  String currencyUpdatePopup(
    String oldAmount,
    String oldCurrency,
    String newAmount,
    String newCurrency,
  ) {
    return 'Currency updating: $oldAmount $oldCurrency ≈ $newAmount $newCurrency';
  }

  @override
  String get currencyConverting => 'Converting currency...';

  @override
  String get currencyConversionFailed =>
      'Could not fetch exchange rate, values unchanged';

  @override
  String get requiredExpense => 'Required Expense';

  @override
  String get installmentPurchase => 'Installment Purchase';

  @override
  String get installmentInfo => 'Installment Information';

  @override
  String get cashPrice => 'Cash Price';

  @override
  String get cashPriceHint => 'Original cash price';

  @override
  String get numberOfInstallments => 'Number of Installments';

  @override
  String get totalInstallmentPrice => 'Total Installment Price';

  @override
  String get totalWithInterestHint => 'Total with interest';

  @override
  String get installmentSummary => 'INSTALLMENT SUMMARY';

  @override
  String get willBeSavedAsRequired => 'Will be saved as required expense';

  @override
  String get creditCardOrStoreInstallment => 'Credit card or store installment';

  @override
  String get vantagAI => 'Vantag AI';

  @override
  String get professionalMode => 'Professional mode';

  @override
  String get friendlyMode => 'Friendly mode';

  @override
  String get errorTryAgain => 'An error occurred, try again?';

  @override
  String get aiFallbackOverBudget =>
      'Budget seems a bit tight.\nLet\'s see what we can do together?';

  @override
  String get aiFallbackHighUsage =>
      'End of month approaching, let\'s be careful.\nHow can I help?';

  @override
  String get aiFallbackMediumUsage =>
      'Budget is holding up.\nWant to ask something?';

  @override
  String get aiFallbackLowUsage =>
      'Your budget is looking great!\nWhat should we analyze?';

  @override
  String get aiInsights => 'AI Insights';

  @override
  String get mostSpendingDay => 'Busiest Spending Day';

  @override
  String get biggestCategory => 'Biggest Category';

  @override
  String get thisMonthVsLast => 'This Month vs Last Month';

  @override
  String get monday => 'Monday';

  @override
  String get tuesday => 'Tuesday';

  @override
  String get wednesday => 'Wednesday';

  @override
  String get thursday => 'Thursday';

  @override
  String get friday => 'Friday';

  @override
  String get saturday => 'Saturday';

  @override
  String get sunday => 'Sunday';

  @override
  String get securePayment => 'Secure Payment';

  @override
  String get encrypted => 'Encrypted';

  @override
  String get syncing => 'Syncing data...';

  @override
  String pendingSync(int count) {
    return '$count changes pending sync';
  }

  @override
  String get pendingLabel => 'Pending';

  @override
  String insightMinutes(int minutes) {
    return 'This expense took $minutes minutes of your life.';
  }

  @override
  String insightHours(String hours) {
    return 'This expense took $hours hours of your life.';
  }

  @override
  String get insightAlmostDay =>
      'You worked almost a full day for this expense.';

  @override
  String insightDays(String days) {
    return 'This expense took $days days of your life.';
  }

  @override
  String insightDaysWorked(String days) {
    return 'You had to work $days days for this expense.';
  }

  @override
  String get insightAlmostMonth =>
      'This expense cost you almost a month of work.';

  @override
  String insightCategoryDays(String category, String days) {
    return 'This month you worked $days days for $category.';
  }

  @override
  String insightCategoryHours(String category, String hours) {
    return 'This month you worked $hours hours for $category.';
  }

  @override
  String get insightMonthlyAlmost =>
      'You worked almost the entire month for this month\'s expenses.';

  @override
  String insightMonthlyDays(String days) {
    return 'You worked $days days for this month\'s expenses.';
  }

  @override
  String get msgShort1 => 'A few hours of work, for a fleeting desire?';

  @override
  String get msgShort2 =>
      'Easy to spend what you earned in such short time, hard to earn it back.';

  @override
  String get msgShort3 =>
      'You went to work this morning, this money will be gone before lunch.';

  @override
  String get msgShort4 =>
      'You earned it in a coffee break, it\'ll be gone with one click.';

  @override
  String get msgShort5 =>
      'Half a day\'s work, don\'t let it become a full day of regret.';

  @override
  String get msgShort6 => 'Think about the hours you worked for this item.';

  @override
  String get msgShort7 => 'Looks small but makes a big difference in total.';

  @override
  String get msgShort8 => 'If not now, tomorrow works too.';

  @override
  String get msgMedium1 => 'Is your week\'s work worth this item?';

  @override
  String get msgMedium2 =>
      'It took days to save this money, seconds to spend it.';

  @override
  String get msgMedium3 =>
      'Would you accept if you were investing a week into this?';

  @override
  String get msgMedium4 => 'Days of effort, a split-second decision.';

  @override
  String get msgMedium5 => 'A weekend getaway or this item?';

  @override
  String get msgMedium6 => 'Remember what you worked for all those days.';

  @override
  String get msgMedium7 => 'Did you work Monday to Friday for this?';

  @override
  String get msgMedium8 =>
      'Does it make sense to spend your weekly budget in one go?';

  @override
  String get msgLong1 =>
      'You need to work for weeks for this. Is it really worth it?';

  @override
  String get msgLong2 => 'Saving this money could take months.';

  @override
  String get msgLong3 => 'You might be delaying one of your long-term goals.';

  @override
  String get msgLong4 =>
      'Does the time you\'ll spend on this affect your vacation plans?';

  @override
  String get msgLong5 => 'Is this an investment or an expense?';

  @override
  String get msgLong6 => 'How would future you evaluate this decision?';

  @override
  String get msgLong7 => 'Working this long should be for something lasting.';

  @override
  String get msgLong8 => 'How will you view this decision at month\'s end?';

  @override
  String get msgSim1 =>
      'This amount isn\'t just spending anymore, it\'s a serious investment decision.';

  @override
  String get msgSim2 =>
      'For such a large sum, decide with your vision, not your emotions.';

  @override
  String get msgSim3 =>
      'It\'s hard to even calculate the time equivalent of this amount.';

  @override
  String get msgSim4 => 'Could this be that big step you\'ve been dreaming of?';

  @override
  String get msgSim5 =>
      'Managing such a large amount requires patience and strategy.';

  @override
  String get msgSim6 =>
      'You\'re at a point that will affect your future, not just your wallet.';

  @override
  String get msgSim7 =>
      'Big numbers bring big responsibilities. Are you ready?';

  @override
  String get msgSim8 =>
      'Is this amount just a number to you, or a turning point?';

  @override
  String get msgYes1 => 'Recorded. Hope it\'s worth it.';

  @override
  String get msgYes2 => 'Let\'s see if you\'ll regret it.';

  @override
  String get msgYes3 => 'Okay, it\'s your money.';

  @override
  String get msgYes4 => 'You bought it, congratulations.';

  @override
  String get msgYes5 => 'As you wish.';

  @override
  String get msgYes6 => 'Alright, it\'s on the record.';

  @override
  String get msgYes7 => 'If it\'s a need, no problem.';

  @override
  String get msgYes8 => 'Sometimes spending is necessary too.';

  @override
  String get msgNo1 => 'Great decision. You saved this money.';

  @override
  String get msgNo2 =>
      'You chose the hard path, your future self will thank you.';

  @override
  String get msgNo3 => 'Willpower won.';

  @override
  String get msgNo4 => 'Smart move. You\'ll need this money.';

  @override
  String get msgNo5 => 'Passing is also a win.';

  @override
  String get msgNo6 => 'The urge passed, the money stayed.';

  @override
  String get msgNo7 => 'You actually invested in yourself.';

  @override
  String get msgNo8 => 'Hard decision, right decision.';

  @override
  String get msgThink1 => 'Thinking is free, spending isn\'t.';

  @override
  String get msgThink2 => 'Not rushing is smart.';

  @override
  String get msgThink3 => 'Sleep on it, look again tomorrow.';

  @override
  String get msgThink4 => 'Wait 24 hours, come back if you still want it.';

  @override
  String get msgThink5 =>
      'If you\'re hesitating, it\'s probably not necessary.';

  @override
  String get msgThink6 => 'Time is the best advisor.';

  @override
  String get msgThink7 => 'If it\'s not urgent, don\'t rush.';

  @override
  String get msgThink8 => 'If you\'re not sure, the answer is probably no.';

  @override
  String get savingMsg1 => 'Great decision! 💪';

  @override
  String get savingMsg2 => 'You protected your money! 🛡️';

  @override
  String get savingMsg3 => 'Future you will thank you!';

  @override
  String get savingMsg4 => 'Smart choice! 🧠';

  @override
  String get savingMsg5 => 'Saving is power!';

  @override
  String get savingMsg6 => 'One step closer to your goal!';

  @override
  String get savingMsg7 => 'Willpower! 💎';

  @override
  String get savingMsg8 => 'This money is now yours!';

  @override
  String get savingMsg9 => 'Financial discipline! 🎯';

  @override
  String get savingMsg10 => 'You\'re building wealth!';

  @override
  String get savingMsg11 => 'Strong decision! 💪';

  @override
  String get savingMsg12 => 'Your wallet thanks you!';

  @override
  String get savingMsg13 => 'That\'s how champions save! 🏆';

  @override
  String get savingMsg14 => 'Money saved = Freedom earned!';

  @override
  String get savingMsg15 => 'Impressive self-control! ⭐';

  @override
  String get spendingMsg1 => 'Recorded! ✓';

  @override
  String get spendingMsg2 => 'You\'re tracking, that\'s important.';

  @override
  String get spendingMsg3 => 'Every record is awareness.';

  @override
  String get spendingMsg4 => 'Knowing your spending is power.';

  @override
  String get spendingMsg5 => 'Logged! Keep going.';

  @override
  String get spendingMsg6 => 'Tracking builds control.';

  @override
  String get spendingMsg7 => 'Noted! Awareness is key.';

  @override
  String get spendingMsg8 => 'Good job tracking!';

  @override
  String get spendingMsg9 => 'Data is power! 📊';

  @override
  String get spendingMsg10 => 'Stay aware, stay in control.';

  @override
  String get tourAmountTitle => 'Amount Entry';

  @override
  String get tourAmountDesc =>
      'Enter the expense amount here. You can automatically scan it from a receipt using the scan button.';

  @override
  String get tourDescriptionTitle => 'Smart Matching';

  @override
  String get tourDescriptionDesc =>
      'Enter the store or product name. Like Migros, A101, Starbucks... The app will automatically suggest a category!';

  @override
  String get tourCategoryTitle => 'Category Selection';

  @override
  String get tourCategoryDesc =>
      'If smart matching doesn\'t find it or you want to change it, you can manually select from here.';

  @override
  String get tourDateTitle => 'Past Date Selection';

  @override
  String get tourDateDesc =>
      'You can also enter expenses from yesterday or previous days. Click the calendar icon to select any date.';

  @override
  String get tourSnapshotTitle => 'Financial Summary';

  @override
  String get tourSnapshotDesc =>
      'Your monthly income, expenses, and saved money are here. All data updates in real-time.';

  @override
  String get tourCurrencyTitle => 'Exchange Rates';

  @override
  String get tourCurrencyDesc =>
      'Current USD, EUR, and gold prices. Tap for detailed information.';

  @override
  String get tourStreakTitle => 'Streak Tracking';

  @override
  String get tourStreakDesc =>
      'Your streak increases every day you record an expense. Regular tracking is the key to mindful spending!';

  @override
  String get tourSubscriptionTitle => 'Subscriptions';

  @override
  String get tourSubscriptionDesc =>
      'Track your regular subscriptions like Netflix, Spotify here. You\'ll get notifications for upcoming payments.';

  @override
  String get tourReportTitle => 'Reports';

  @override
  String get tourReportDesc =>
      'View monthly and category-based spending analysis here.';

  @override
  String get tourAchievementsTitle => 'Badges';

  @override
  String get tourAchievementsDesc =>
      'Earn badges as you reach savings goals. Keep your motivation high!';

  @override
  String get tourProfileTitle => 'Profile & Settings';

  @override
  String get tourProfileDesc =>
      'Edit income info, manage notification preferences, and access app settings.';

  @override
  String get tourQuickAddTitle => 'Quick Add';

  @override
  String get tourQuickAddDesc =>
      'Use this button to quickly add expenses from anywhere. Practical and fast!';

  @override
  String get notifChannelName => 'Vantag Notifications';

  @override
  String get notifChannelDescription => 'Financial tracking notifications';

  @override
  String get notifTitleThinkAboutIt => 'Think about it';

  @override
  String get notifTitleCongratulations => 'Congratulations';

  @override
  String get notifTitleStreakWaiting => 'Your streak is waiting';

  @override
  String get notifTitleWeeklySummary => 'Weekly summary';

  @override
  String get notifTitleSubscriptionReminder => 'Subscription reminder';

  @override
  String get aiGreeting =>
      'Hello! I\'m Vantag.\nReady to answer your financial questions.';

  @override
  String get aiServiceUnavailable =>
      'AI assistant is currently unavailable. Please try again later.';

  @override
  String get onboardingHookTitle => 'This coffee is 47 minutes';

  @override
  String get onboardingHookSubtitle => 'See the real cost of every purchase';

  @override
  String get pursuitOnboardingTitle => 'What\'s your goal?';

  @override
  String get pursuitOnboardingSubtitle => 'Pick something to save for';

  @override
  String get pursuitOnboardingAirpods => 'AirPods';

  @override
  String get pursuitOnboardingIphone => 'iPhone';

  @override
  String get pursuitOnboardingVacation => 'Vacation';

  @override
  String get pursuitOnboardingCustom => 'My own goal';

  @override
  String get pursuitOnboardingCta => 'I want this';

  @override
  String get pursuitOnboardingSkip => 'Skip for now';

  @override
  String pursuitOnboardingHours(int hours) {
    return '$hours hours';
  }

  @override
  String get celebrationTitle => 'Congratulations!';

  @override
  String celebrationSubtitle(String goalName) {
    return 'You reached your $goalName goal!';
  }

  @override
  String celebrationTotalSaved(String hours) {
    return 'Total saved: $hours hours';
  }

  @override
  String celebrationDuration(int days) {
    return 'Duration: $days days';
  }

  @override
  String get celebrationShare => 'Share';

  @override
  String get celebrationNewGoal => 'New Goal';

  @override
  String get celebrationDismiss => 'Close';

  @override
  String get widgetTodayLabel => 'Today';

  @override
  String get widgetHoursAbbrev => 'h';

  @override
  String get widgetMinutesAbbrev => 'm';

  @override
  String get widgetSetGoal => 'Set a goal';

  @override
  String get widgetNoData => 'Open app to start';

  @override
  String get widgetSmallTitle => 'Daily Spending';

  @override
  String get widgetSmallDesc => 'See today\'s spending in hours';

  @override
  String get widgetMediumTitle => 'Spending + Goal';

  @override
  String get widgetMediumDesc => 'Track spending and goal progress';

  @override
  String accessibilityTodaySpending(String amount, int hours, int minutes) {
    return 'Today you spent $amount, equal to $hours hours $minutes minutes of work';
  }

  @override
  String accessibilitySpendingProgress(int percentage) {
    return 'Spending progress: $percentage percent of budget used';
  }

  @override
  String accessibilityExpenseItem(
    String category,
    String amount,
    String hours,
    String decision,
  ) {
    return '$category expense of $amount, took $hours hours, status: $decision';
  }

  @override
  String accessibilityPursuitCard(
    String name,
    String saved,
    String target,
    int percentage,
  ) {
    return '$name goal, $saved of $target saved, $percentage percent complete';
  }

  @override
  String get accessibilityAddExpense => 'Add new expense';

  @override
  String get accessibilityDecisionYes => 'Purchased';

  @override
  String get accessibilityDecisionNo => 'Passed';

  @override
  String get accessibilityDecisionThinking => 'Thinking';

  @override
  String get accessibilityDashboard =>
      'Financial dashboard showing income, expenses and balance';

  @override
  String accessibilityNetBalance(String amount, String status) {
    return 'Net balance: $amount, $status';
  }

  @override
  String get accessibilityBalanceHealthy => 'in the green';

  @override
  String get accessibilityBalanceNegative => 'in the red';

  @override
  String accessibilityIncomeTotal(String amount) {
    return 'Total income: $amount';
  }

  @override
  String accessibilityExpenseTotal(String amount) {
    return 'Total expenses: $amount';
  }

  @override
  String get accessibilityAddSavings => 'Add savings to this goal';

  @override
  String get accessibilityDeleteExpense => 'Delete this expense';

  @override
  String get accessibilityEditExpense => 'Edit this expense';

  @override
  String get accessibilityShareExpense => 'Share this expense';

  @override
  String accessibilityStreakInfo(int days, int best) {
    return 'Current streak: $days days, best streak: $best days';
  }

  @override
  String get accessibilityAiChatInput => 'Type your financial question here';

  @override
  String get accessibilityAiSendButton => 'Send message to AI assistant';

  @override
  String accessibilitySuggestionButton(String question) {
    return 'Quick question: $question';
  }

  @override
  String accessibilitySubscriptionCard(
    String name,
    String amount,
    String cycle,
    int day,
  ) {
    return '$name subscription, $amount per $cycle, renews on day $day';
  }

  @override
  String accessibilitySettingsItem(String title, String value) {
    return '$title, current value: $value';
  }

  @override
  String get accessibilityToggleOn => 'Enabled';

  @override
  String get accessibilityToggleOff => 'Disabled';

  @override
  String get accessibilityCloseSheet => 'Close this sheet';

  @override
  String get accessibilityBackButton => 'Go back';

  @override
  String get accessibilityProfileButton => 'Open profile menu';

  @override
  String get accessibilityNotificationsButton => 'View notifications';

  @override
  String get navHomeTooltip => 'Home, spending overview';

  @override
  String get navPursuitsTooltip => 'Goals, savings targets';

  @override
  String get navReportsTooltip => 'Reports, spending analysis';

  @override
  String get navSettingsTooltip => 'Settings and preferences';

  @override
  String shareDefaultMessage(String link) {
    return 'I track my expenses in hours! Try it: $link';
  }

  @override
  String get shareInviteLink => 'Share Invite Link';

  @override
  String get inviteFriends => 'Invite Friends';

  @override
  String get yourReferralCode => 'Your referral code';

  @override
  String referralStats(int count) {
    return '$count friends joined';
  }

  @override
  String get referralRewardInfo => 'Earn 7 days premium for each friend!';

  @override
  String get codeCopied => 'Code copied!';

  @override
  String get haveReferralCode => 'Have a referral code?';

  @override
  String get referralCodeHint => 'Enter code (optional)';

  @override
  String get referralCodePlaceholder => 'VANTAG-XXXXX';

  @override
  String referralSuccess(String name) {
    return '$name joined Vantag! +7 days premium';
  }

  @override
  String get welcomeReferred => 'Welcome! You have 7 days premium trial';

  @override
  String get referralInvalidCode => 'Invalid referral code';

  @override
  String get referralCodeApplied => 'Referral code applied!';

  @override
  String get referralSectionTitle => 'Referrals';

  @override
  String get referralShareDescription =>
      'Share your code and earn premium days';

  @override
  String get trialMidpointTitle => 'Halfway there! ⏳';

  @override
  String trialMidpointBody(String hours) {
    return 'Your trial is halfway done. You\'ve saved $hours hours so far!';
  }

  @override
  String get trialOneDayLeftTitle => 'Trial ends tomorrow ⏰';

  @override
  String get trialOneDayLeftBody => 'Go premium to keep tracking your savings!';

  @override
  String get trialEndsTodayTitle => 'Last day of trial! 🎁';

  @override
  String get trialEndsTodayBody => 'Get 50% off if you upgrade today!';

  @override
  String get trialExpiredTitle => 'We miss you! 💜';

  @override
  String get trialExpiredBody => 'Come back and continue reaching your goals';

  @override
  String get dailyReminderTitle => 'Don\'t forget to log! 📝';

  @override
  String get dailyReminderBody => 'Track today\'s spending in just seconds';

  @override
  String get notificationSettingsDesc => 'Reminders and updates';

  @override
  String get firstExpenseTitle => 'Great start! 🎉';

  @override
  String firstExpenseBody(String hours) {
    return 'You saved $hours hours today!';
  }

  @override
  String get trialReminderEnabled => 'Trial reminders';

  @override
  String get trialReminderDesc => 'Get notified before your trial ends';

  @override
  String get dailyReminderEnabled => 'Daily reminders';

  @override
  String get dailyReminderDesc => 'Evening reminder to log expenses';

  @override
  String get dailyReminderTime => 'Reminder time';

  @override
  String trialDaysRemaining(int days) {
    return '$days days left in trial';
  }

  @override
  String get subscriptionReminder => 'Subscription reminders';

  @override
  String get subscriptionReminderDesc =>
      'Get notified before subscriptions renew';

  @override
  String get thinkingReminder => '\"Thinking\" reminders';

  @override
  String get thinkingReminderDesc =>
      'Get reminded after 72 hours about items you\'re still thinking about';

  @override
  String get thinkingReminderTitle => 'Still thinking?';

  @override
  String thinkingReminderBody(String item) {
    return 'Did you decide? $item';
  }

  @override
  String get willRemindIn72h => 'We\'ll remind you in 72 hours';

  @override
  String get thinkingAbout => 'Thinking about';

  @override
  String addedDaysAgo(int days) {
    return 'Added $days days ago';
  }

  @override
  String get stillThinking => 'Still thinking?';

  @override
  String get stillThinkingMessage => 'It\'s been 72 hours. Did you decide?';

  @override
  String get decidedYes => 'I bought it';

  @override
  String get decidedNo => 'I passed';

  @override
  String get aiChatLimitReached =>
      'You\'ve used your 4 daily AI chats. Go premium for unlimited!';

  @override
  String aiChatsRemaining(int count) {
    return '$count chats left today';
  }

  @override
  String get pursuitLimitReachedFree =>
      'Free accounts can have 1 active goal. Go premium for unlimited goals!';

  @override
  String get pursuitNameRequired => 'Please enter a name';

  @override
  String get pursuitAmountRequired => 'Please enter an amount';

  @override
  String get pursuitAmountInvalid => 'Please enter a valid amount';

  @override
  String get exportPremiumOnly => 'Export is a premium feature';

  @override
  String get multiCurrencyPremium =>
      'Multiple currencies is a premium feature. Free users can only use TRY.';

  @override
  String get reportsPremiumOnly =>
      'Monthly and yearly reports are premium features';

  @override
  String get upgradeToPremium => 'Upgrade to Premium';

  @override
  String get premiumIncludes => 'Premium includes:';

  @override
  String get unlimitedAiChat => 'Unlimited AI chat';

  @override
  String get unlimitedPursuits => 'Unlimited goals';

  @override
  String get exportFeature => 'Export your data';

  @override
  String get allCurrencies => 'All currencies';

  @override
  String get fullReports => 'Full reports';

  @override
  String get cleanShareCards => 'Clean share cards (no watermark)';

  @override
  String get maybeLater => 'Maybe later';

  @override
  String get seePremium => 'See Premium';

  @override
  String get weeklyOnly => 'Weekly';

  @override
  String get monthlyPro => 'Monthly (Pro)';

  @override
  String get yearlyPro => 'Yearly (Pro)';

  @override
  String get currencyLocked => 'Premium only';

  @override
  String freeUserCurrencyNote(String currency) {
    return 'Free users can only use TRY. Upgrade to use $currency.';
  }

  @override
  String get watermarkText => 'vantag.app';

  @override
  String get incomeTypeSalary => 'Salary';

  @override
  String get incomeTypeBonus => 'Bonus';

  @override
  String get incomeTypeGift => 'Gift';

  @override
  String get incomeTypeRefund => 'Refund';

  @override
  String get incomeTypeFreelance => 'Freelance';

  @override
  String get incomeTypeRental => 'Rental';

  @override
  String get incomeTypeInvestment => 'Investment';

  @override
  String get incomeTypeOther => 'Other Income';

  @override
  String get salaryDay => 'Salary Day';

  @override
  String get salaryDayTitle => 'When do you get paid?';

  @override
  String get salaryDaySubtitle => 'We\'ll remind you on payday';

  @override
  String get salaryDayHint => 'Select day of month (1-31)';

  @override
  String salaryDaySet(int day) {
    return 'Salary day set to $day';
  }

  @override
  String get salaryDaySkip => 'Skip for now';

  @override
  String get salaryDayNotSet => 'Not set';

  @override
  String get currentBalance => 'Current Balance';

  @override
  String get balanceTitle => 'What\'s your current balance?';

  @override
  String get balanceSubtitle => 'Track your spending more accurately';

  @override
  String get balanceHint => 'Enter your bank balance';

  @override
  String get balanceUpdated => 'Balance updated';

  @override
  String get balanceOptional => 'Optional - you can add this later';

  @override
  String get paydayTitle => 'Payday!';

  @override
  String get paydayMessage => 'Did you receive your salary?';

  @override
  String get paydayConfirm => 'Yes, received!';

  @override
  String get paydayNotYet => 'Not yet';

  @override
  String get paydaySkip => 'Skip';

  @override
  String get paydayCelebration => 'Congratulations! Salary received';

  @override
  String get paydayUpdateBalance => 'Update your balance';

  @override
  String get paydayNewBalance => 'New balance after salary';

  @override
  String daysUntilPayday(int days) {
    return '$days days until payday';
  }

  @override
  String get paydayToday => 'Payday is today!';

  @override
  String get paydayTomorrow => 'Payday is tomorrow';

  @override
  String get addIncomeTitle => 'Record Income';

  @override
  String get addIncomeSubtitle => 'Bonus, gift, refund, etc.';

  @override
  String get incomeAmount => 'Amount received';

  @override
  String get incomeNotes => 'Notes (optional)';

  @override
  String get incomeNotesHint => 'e.g. Year-end bonus, birthday gift...';

  @override
  String get incomeAdded => 'Income added!';

  @override
  String incomeAddedBalance(String amount) {
    return 'Balance updated: $amount';
  }

  @override
  String get thisMonthIncome => 'This Month\'s Income';

  @override
  String get regularIncome => 'Regular Income';

  @override
  String get additionalIncome => 'Additional Income';

  @override
  String get incomeBreakdown => 'Income Breakdown';

  @override
  String get paydayNotificationTitle => 'Payday!';

  @override
  String get paydayNotificationBody =>
      'Your salary should be arriving today. Check your account!';

  @override
  String get paydayNotificationEnabled => 'Payday reminders';

  @override
  String get paydayNotificationDesc => 'Get notified on your salary day';

  @override
  String get onboardingSalaryDayTitle => 'When\'s Payday?';

  @override
  String get onboardingSalaryDayDesc =>
      'Tell us when you receive your salary so we can help you budget better';

  @override
  String get onboardingBalanceTitle => 'Starting Balance';

  @override
  String get onboardingBalanceDesc =>
      'Enter your current balance to track your finances accurately';

  @override
  String get onboardingV2Step1Title => 'See expenses differently';

  @override
  String get onboardingV2Step1Subtitle =>
      'See how many hours each purchase costs you';

  @override
  String get onboardingV2Step1Demo => '\$500 phone = 20 hours of work';

  @override
  String get onboardingV2Step1Cta => 'Calculate';

  @override
  String get onboardingV2Step2Title => 'Let\'s get to know you';

  @override
  String get onboardingV2Step2Income => 'Monthly income';

  @override
  String get onboardingV2Step2Hours => 'Daily work hours';

  @override
  String get onboardingV2Step2Days => 'Work days per week';

  @override
  String get onboardingV2Step2Cta => 'Continue';

  @override
  String get onboardingV2Step3Title => 'Add your first expense';

  @override
  String get onboardingV2Step3Subtitle => 'See its value in hours';

  @override
  String onboardingV2Step3Result(int hours, int minutes) {
    return '= ${hours}h ${minutes}m';
  }

  @override
  String get onboardingV2Step3Success =>
      'Great! Now you\'ll know the true cost of every purchase';

  @override
  String get onboardingV2Step3Cta => 'Start';

  @override
  String get onboardingV2SkipSetup => 'Later';

  @override
  String onboardingV2Progress(int current, int total) {
    return 'Step $current/$total';
  }

  @override
  String get checklistTitle => 'Getting Started';

  @override
  String checklistProgress(int completed, int total) {
    return '$completed/$total completed';
  }

  @override
  String get checklistFirstExpenseTitle => 'Add your first expense';

  @override
  String get checklistFirstExpenseSubtitle => 'See its value in hours';

  @override
  String get checklistViewReportTitle => 'View your report';

  @override
  String get checklistViewReportSubtitle => 'Discover spending patterns';

  @override
  String get checklistCreatePursuitTitle => 'Set a savings goal';

  @override
  String get checklistCreatePursuitSubtitle => 'Start saving for something';

  @override
  String get checklistNotificationsTitle => 'Enable notifications';

  @override
  String get checklistNotificationsSubtitle => 'Get daily reminders';

  @override
  String get checklistCelebrationTitle => 'Great start!';

  @override
  String get checklistCelebrationSubtitle => 'You\'re ready to use Vantag';

  @override
  String get emptyStateExampleTitle => 'Example';

  @override
  String get emptyStateExpensesMessage =>
      'See how many hours each purchase costs you';

  @override
  String get emptyStateExpensesCta => 'Add Expense';

  @override
  String get emptyStatePursuitsMessage => 'Set a goal and track your progress';

  @override
  String get emptyStatePursuitsCta => 'Create Goal';

  @override
  String get emptyStateReportsMessage => 'Discover your spending patterns';

  @override
  String get emptyStateReportsCta => 'Add Expense';

  @override
  String get emptyStateSubscriptionsMessage =>
      'Track your subscriptions, never forget';

  @override
  String get emptyStateSubscriptionsCta => 'Add Subscription';

  @override
  String get emptyStateAchievementsMessage => 'Add expenses to earn badges';

  @override
  String get emptyStateSavingsPoolMessage => 'Pool your savings together';

  @override
  String get milestone3DayStreakTitle => '3 Day Streak!';

  @override
  String get milestone3DayStreakMessage => 'Great start, keep going!';

  @override
  String get milestone7DayStreakTitle => '1 Week Streak!';

  @override
  String get milestone7DayStreakMessage => 'A whole week of tracking';

  @override
  String get milestone14DayStreakTitle => '2 Week Streak!';

  @override
  String get milestone14DayStreakMessage => 'You\'re building a habit';

  @override
  String get milestone30DayStreakTitle => '1 Month Streak!';

  @override
  String get milestone30DayStreakMessage => 'A full month! Incredible';

  @override
  String get milestone60DayStreakTitle => '2 Month Streak!';

  @override
  String get milestone60DayStreakMessage => 'You\'re a financial awareness pro';

  @override
  String get milestone100DayStreakTitle => '100 Day Streak!';

  @override
  String get milestone100DayStreakMessage =>
      'Legendary achievement! You\'re a champion';

  @override
  String get milestoneFirstSavedTitle => 'First Savings!';

  @override
  String get milestoneFirstSavedMessage => 'You saved your first money';

  @override
  String get milestoneSaved100Title => 'Saved \$100!';

  @override
  String get milestoneSaved100Message => 'Your savings habit is growing';

  @override
  String get milestoneSaved1000Title => 'Saved \$1,000!';

  @override
  String get milestoneSaved1000Message => 'You\'re saving seriously';

  @override
  String get milestoneSaved5000Title => 'Saved \$5,000!';

  @override
  String get milestoneSaved5000Message => 'You\'re a savings master!';

  @override
  String get milestoneFirstExpenseTitle => 'First Step!';

  @override
  String get milestoneFirstExpenseMessage => 'You logged your first expense';

  @override
  String get milestone10ExpensesTitle => '10 Expenses!';

  @override
  String get milestone10ExpensesMessage => 'You have a tracking habit now';

  @override
  String get milestone50ExpensesTitle => '50 Expenses!';

  @override
  String get milestone50ExpensesMessage => 'You\'re a financial awareness pro';

  @override
  String get milestoneFirstPursuitTitle => 'First Goal!';

  @override
  String get milestoneFirstPursuitMessage => 'Your savings journey has begun';

  @override
  String get milestoneFirstPursuitCompletedTitle => 'Goal Completed!';

  @override
  String get milestoneFirstPursuitCompletedMessage =>
      'You reached your first goal!';

  @override
  String get milestoneUsedAiChatTitle => 'AI Discovery!';

  @override
  String get milestoneUsedAiChatMessage => 'You met your financial assistant';

  @override
  String selectTimeFilter(String filter) {
    return 'Select time filter: $filter';
  }

  @override
  String lockedFilterPremium(String filter) {
    return '$filter, premium feature';
  }

  @override
  String selectedFilter(String filter) {
    return '$filter, selected';
  }

  @override
  String selectHeatmapDay(String date) {
    return 'Select day: $date';
  }

  @override
  String heatmapDayWithSpending(String date, String amount) {
    return '$date, $amount spent';
  }

  @override
  String heatmapDayNoSpending(String date) {
    return '$date, no spending';
  }

  @override
  String get loggedOutFromAnotherDevice => 'Logged In From Another Device';

  @override
  String get loggedOutFromAnotherDeviceMessage =>
      'Your account was accessed from another device. For security reasons, you have been signed out from this device.';

  @override
  String get multiCurrencyProTitle => 'Multi-Currency';

  @override
  String get multiCurrencyProDescription =>
      'Upgrade to Pro to enter income and expenses in different currencies. Use USD, EUR, GBP and more.';

  @override
  String get multiCurrencyBenefit => 'All currencies available';

  @override
  String get currencyLockedForFree => 'Currency change is a Pro feature';

  @override
  String get excelSheetExpenses => 'Expenses';

  @override
  String get excelSheetSummary => 'Summary';

  @override
  String get excelSheetCategories => 'Categories';

  @override
  String get excelSheetTimeAnalysis => 'Time Analysis';

  @override
  String get excelSheetDecisions => 'Decisions';

  @override
  String get excelSheetInstallments => 'Installments';

  @override
  String get excelHeaderDay => 'Day';

  @override
  String get excelHeaderStore => 'Store/Location';

  @override
  String get excelHeaderMinutes => 'Minutes Equiv.';

  @override
  String get excelHeaderMonthlyInstallment => 'Monthly Payment';

  @override
  String get excelHeaderInstallmentCount => 'Installment';

  @override
  String get excelHeaderSimulation => 'Simulation';

  @override
  String get excelHeaderHoursEquiv => 'Hours Equiv.';

  @override
  String get excelReportTitle => 'Vantag Financial Report';

  @override
  String get excelReportPeriod => 'Report Period';

  @override
  String get excelReportGeneratedAt => 'Generated';

  @override
  String get excelTotalExpenses => 'Total Expenses';

  @override
  String get excelTotalTransactions => 'Total Transactions';

  @override
  String get excelAvgPerTransaction => 'Average per Transaction';

  @override
  String get excelMonthlyAverage => 'Monthly Average';

  @override
  String get excelDailyAverage => 'Daily Average';

  @override
  String get excelWeeklyAverage => 'Weekly Average';

  @override
  String get excelSavingsRate => 'Savings Rate';

  @override
  String get excelTotalWorkHours => 'Total Work Hours';

  @override
  String get excelTotalWorkDays => 'Total Work Days';

  @override
  String get excelCategoryShare => 'Share %';

  @override
  String get excelCategoryRank => 'Rank';

  @override
  String get excelTopCategory => 'Top Category';

  @override
  String get excelCategoryCount => 'Transaction Count';

  @override
  String get excelCategoryAvg => 'Category Average';

  @override
  String get excelCategoryTotal => 'Category Total';

  @override
  String get excelCategoryHours => 'Work Hours';

  @override
  String get excelTimeTitle => 'Time Analysis';

  @override
  String get excelMostActiveDay => 'Most Active Day';

  @override
  String get excelMostActiveHour => 'Most Active Hour';

  @override
  String get excelWeekdayAvg => 'Weekday Average';

  @override
  String get excelWeekendAvg => 'Weekend Average';

  @override
  String get excelMorningSpend => 'Morning (06-12)';

  @override
  String get excelAfternoonSpend => 'Afternoon (12-18)';

  @override
  String get excelEveningSpend => 'Evening (18-24)';

  @override
  String get excelNightSpend => 'Night (00-06)';

  @override
  String get excelByDayOfWeek => 'By Day of Week';

  @override
  String get excelByHour => 'By Hour';

  @override
  String get excelByMonth => 'By Month';

  @override
  String get excelDecisionsBought => 'Bought';

  @override
  String get excelDecisionsThinking => 'Thinking';

  @override
  String get excelDecisionsPassed => 'Passed';

  @override
  String get excelDecisionCount => 'Count';

  @override
  String get excelDecisionAmount => 'Amount';

  @override
  String get excelDecisionPercent => 'Percentage';

  @override
  String get excelDecisionAvg => 'Average';

  @override
  String get excelDecisionHours => 'Work Hours';

  @override
  String get excelImpulseRate => 'Impulse Rate';

  @override
  String get excelSavingsFromPassed => 'Savings from Passed';

  @override
  String get excelPotentialSavings => 'Potential Savings (Thinking)';

  @override
  String get excelInstallmentName => 'Description';

  @override
  String get excelInstallmentTotal => 'Total Amount';

  @override
  String get excelInstallmentMonthly => 'Monthly Payment';

  @override
  String get excelInstallmentProgress => 'Progress';

  @override
  String get excelInstallmentRemaining => 'Remaining';

  @override
  String get excelInstallmentStartDate => 'Start Date';

  @override
  String get excelInstallmentEndDate => 'End Date';

  @override
  String get excelInstallmentInterest => 'Interest';

  @override
  String get excelNoInstallments => 'No installment payments';

  @override
  String get excelTotalMonthlyPayments => 'Total Monthly Payments';

  @override
  String get excelTotalRemainingDebt => 'Total Remaining Debt';

  @override
  String get excelDayMonday => 'Monday';

  @override
  String get excelDayTuesday => 'Tuesday';

  @override
  String get excelDayWednesday => 'Wednesday';

  @override
  String get excelDayThursday => 'Thursday';

  @override
  String get excelDayFriday => 'Friday';

  @override
  String get excelDaySaturday => 'Saturday';

  @override
  String get excelDaySunday => 'Sunday';

  @override
  String get excelYes => 'Yes';

  @override
  String get excelNo => 'No';

  @override
  String get excelReal => 'Real';

  @override
  String get excelSimulation => 'Simulation';

  @override
  String get proFeaturesSheetTitle => 'Pro Feature';

  @override
  String get proFeaturesSheetSubtitle =>
      'This feature is exclusive to Pro members';

  @override
  String get proFeaturesIncluded => 'Pro membership includes:';

  @override
  String get proFeatureHeatmap => 'Expense Heatmap';

  @override
  String get proFeatureHeatmapDesc =>
      'Visualize your spending patterns over the year';

  @override
  String get proFeatureCategoryBreakdown => 'Category Breakdown';

  @override
  String get proFeatureCategoryBreakdownDesc =>
      'Detailed pie chart analysis by category';

  @override
  String get proFeatureSpendingTrends => 'Spending Trends';

  @override
  String get proFeatureSpendingTrendsDesc =>
      'Track your spending changes over time';

  @override
  String get proFeatureTimeAnalysis => 'Time Analysis';

  @override
  String get proFeatureTimeAnalysisDesc =>
      'See when you spend most by day and hour';

  @override
  String get proFeatureBudgetBreakdown => 'Budget Breakdown';

  @override
  String get proFeatureBudgetBreakdownDesc =>
      'Track spending against your budget goals';

  @override
  String get proFeatureAdvancedFilters => 'Advanced Filters';

  @override
  String get proFeatureAdvancedFiltersDesc =>
      'Filter by month, all-time, and more';

  @override
  String get proFeatureExcelExport => 'Excel Export';

  @override
  String get proFeatureExcelExportDesc => 'Export your complete financial data';

  @override
  String get proFeatureUnlimitedHistory => 'Unlimited History';

  @override
  String get proFeatureUnlimitedHistoryDesc => 'Access all your past expenses';

  @override
  String get goProButton => 'Go Pro';

  @override
  String get lockedFeatureTapToUnlock => 'Tap to unlock';

  @override
  String voiceUsageIndicator(int used, int total) {
    return '$used/$total voice inputs today';
  }

  @override
  String aiChatUsageIndicator(int used, int total) {
    return '$used/$total questions today';
  }

  @override
  String get dailyLimitReached => 'Daily limit reached';

  @override
  String get dailyLimitReachedDesc =>
      'You\'ve used all your daily quota. Upgrade to Pro for unlimited access!';

  @override
  String get unlimitedWithPro => 'Unlimited with Pro';

  @override
  String get backupData => 'Backup Data';

  @override
  String get backupDataDesc => 'Export your data as a JSON file';

  @override
  String get restoreData => 'Restore Data';

  @override
  String get restoreDataDesc => 'Import data from a backup file';

  @override
  String get backupCreating => 'Creating backup...';

  @override
  String get backupSuccess => 'Backup created successfully';

  @override
  String get backupError => 'Failed to create backup';

  @override
  String get restoreConfirmTitle => 'Restore Data?';

  @override
  String get restoreConfirmMessage =>
      'This will add the backup data to your existing data. Continue?';

  @override
  String restoreSuccess(int expenses, int pursuits, int subscriptions) {
    return 'Data restored! $expenses expenses, $pursuits goals, $subscriptions subscriptions imported.';
  }

  @override
  String get restoreError => 'Failed to restore data';

  @override
  String get noFileSelected => 'No file selected';

  @override
  String get invalidBackupFormat => 'Invalid backup file format';

  @override
  String get shareApp => 'Share App';

  @override
  String get shareAppDesc => 'Recommend Vantag to friends';

  @override
  String get shareAppMessage =>
      'Check out Vantag - It shows you how many work hours each expense costs! Download: https://play.google.com/store/apps/details?id=com.vantag.app';

  @override
  String get sendFeedback => 'Send Feedback';

  @override
  String get sendFeedbackDesc => 'Help us improve Vantag';

  @override
  String get feedbackEmailSubject => 'Vantag Feedback';

  @override
  String get rateApp => 'Rate App';

  @override
  String get rateAppDesc => 'Rate us on Play Store';

  @override
  String get whatsNew => 'What\'s New';

  @override
  String whatsNewInVersion(String version) {
    return 'What\'s New in v$version';
  }

  @override
  String get updateRequired => 'Update Required';

  @override
  String get updateRequiredMessage =>
      'A new version of Vantag is available. Please update to continue.';

  @override
  String get updateNow => 'Update Now';

  @override
  String get dailyLimits => 'Daily Limits';

  @override
  String get aiChat => 'AI Chat';

  @override
  String get statementImport => 'Statement Import';

  @override
  String get subscriptionAutoRenewalNotice =>
      'Subscription automatically renews unless canceled at least 24 hours before the end of the current period. Manage subscriptions in Settings.';

  @override
  String get welcomeBackTitle3Days => 'Welcome Back!';

  @override
  String get welcomeBackSubtitle3Days =>
      'We missed you. Keep tracking your expenses.';

  @override
  String get welcomeBackCta3Days => 'Add Expense';

  @override
  String get welcomeBackTitle7Days => 'You\'re Back!';

  @override
  String get welcomeBackSubtitle7Days =>
      'It\'s been a week. Let\'s continue towards your financial goals.';

  @override
  String get welcomeBackCta7Days => 'Where Did We Leave Off?';

  @override
  String get welcomeBackTitle14Days => 'Hello Again!';

  @override
  String get welcomeBackSubtitle14Days =>
      'We\'ve been waiting. Ready for a fresh start?';

  @override
  String get welcomeBackCta14Days => 'Start Fresh';

  @override
  String get welcomeBackTitle30Days => 'Welcome Back!';

  @override
  String get welcomeBackSubtitle30Days =>
      'It\'s been a while, but reaching your goals is still possible!';

  @override
  String get welcomeBackCta30Days => 'Get Started';

  @override
  String get welcomeBackStreakLost => 'Your streak was reset';

  @override
  String welcomeBackStreakRecovered(int percent) {
    return '$percent% of your streak recovered!';
  }

  @override
  String get reengagementPushTitle3Days =>
      'Don\'t forget to track your expenses!';

  @override
  String get reengagementPushBody3Days =>
      'How much did you save today? Check now.';

  @override
  String get reengagementPushTitle5Days => 'We miss you!';

  @override
  String get reengagementPushBody5Days =>
      'Keep going to reach your financial goals.';

  @override
  String get reengagementPushTitle7Days =>
      'Come back before you lose your streak!';

  @override
  String get reengagementPushBody7Days =>
      'Don\'t lose your streak, add an expense now.';

  @override
  String get reengagementUrgentTitle => 'Don\'t lose control of your finances!';

  @override
  String get reengagementUrgentBody =>
      'Update your expenses and stay on track.';

  @override
  String get pushOnboardingDay1Title => 'Add your first expense!';

  @override
  String get pushOnboardingDay1Body =>
      'A coffee or meal - start small, see the difference.';

  @override
  String get pushOnboardingDay3Title =>
      'Do you know how many hours you worked?';

  @override
  String get pushOnboardingDay3Body =>
      'Keep seeing your expenses as hours worked.';

  @override
  String get pushOnboardingDay7Title => 'It\'s been 7 days!';

  @override
  String get pushOnboardingDay7Body =>
      'Add an expense daily to start a streak.';

  @override
  String get pushWeeklyInsightTitle => 'Weekly Summary Ready';

  @override
  String get pushWeeklyInsightBody =>
      'How much did you save this week? Check now.';

  @override
  String get pushStreakReminderNewTitle => 'Start a new streak!';

  @override
  String get pushStreakReminderNewBody =>
      'Add your first expense today and begin your journey.';

  @override
  String pushStreakReminderShortTitle(int days) {
    return 'You have a $days day streak!';
  }

  @override
  String get pushStreakReminderShortBody => 'Add one today to keep it going.';

  @override
  String pushStreakReminderMediumTitle(int days) {
    return '$days days! You\'re doing great!';
  }

  @override
  String get pushStreakReminderMediumBody =>
      'Add today to keep your streak alive.';

  @override
  String pushStreakReminderLongTitle(int days) {
    return '$days day streak!';
  }

  @override
  String get pushStreakReminderLongBody =>
      'Incredible achievement! Keep it up.';

  @override
  String get pushMorningMotivationTitle => 'Good morning!';

  @override
  String pushMorningMotivationWithSavingsBody(String symbol, String amount) {
    return 'You saved $symbol$amount this month. Keep going!';
  }

  @override
  String get pushMorningMotivationDefaultBody =>
      'Add an expense today to boost your financial awareness.';

  @override
  String get notificationSettingsTitle => 'Notification Settings';

  @override
  String get notificationSettingsQuietHours => 'Quiet Hours';

  @override
  String get notificationSettingsQuietHoursDesc =>
      'No notifications during these hours';

  @override
  String get notificationSettingsPreferredTime => 'Preferred Time';

  @override
  String get notificationSettingsPreferredTimeDesc =>
      'Time to receive notifications';

  @override
  String get notificationSettingsStreakReminders => 'Streak Reminders';

  @override
  String get notificationSettingsStreakRemindersDesc =>
      'Get evening reminders about your streak';

  @override
  String get notificationSettingsMorningMotivation => 'Morning Motivation';

  @override
  String get notificationSettingsMorningMotivationDesc =>
      'Get motivation messages in the morning';

  @override
  String get notificationSettingsWeeklyInsights => 'Weekly Insights';

  @override
  String get notificationSettingsWeeklyInsightsDesc =>
      'Get weekly summary on Sunday mornings';

  @override
  String get loginPromptTitle => 'Save Your Data';

  @override
  String get loginPromptSubtitle =>
      'Link your account so you don\'t lose your data';

  @override
  String get loginPromptLater => 'Maybe later';

  @override
  String get additionalIncomePromptTitle => 'Do you have additional income?';

  @override
  String get additionalIncomePromptSubtitle => 'Side job, rent, freelance...';

  @override
  String get additionalIncomeYes => 'Yes, add';

  @override
  String get additionalIncomeNo => 'No, I don\'t';
}


--- FILE: lib/core/theme/psychology_design_system.dart ---

import 'package:flutter/material.dart';

/// ═══════════════════════════════════════════════════════════════════════════
/// VANTAG PSYCHOLOGY-BASED DESIGN SYSTEM 2026
/// Apple Liquid Glass + Color Psychology + Gamification
/// ═══════════════════════════════════════════════════════════════════════════

// ═══════════════════════════════════════════════════════════════════════════
// COLOR PSYCHOLOGY SYSTEM
// ═══════════════════════════════════════════════════════════════════════════

/// Psychology-based color palette optimized for fintech
/// Each color is chosen based on psychological research
class PsychologyColors {
  PsychologyColors._();

  // ─────────────────────────────────────────────────────────────────────────
  // BACKGROUNDS - OLED optimized deep dark
  // Creates depth and premium feel, reduces eye strain
  // ─────────────────────────────────────────────────────────────────────────

  /// Ana arka plan - Ultra deep for OLED power saving
  static const Color background = Color(0xFF050508);

  /// Kart yüzeyi - Slight elevation
  static const Color surface = Color(0xFF0C0A12);

  /// Yükseltilmiş yüzey - Cards, elevated content
  static const Color surfaceElevated = Color(0xFF14111D);

  /// Overlay yüzey - Modals, sheets, popovers
  static const Color surfaceOverlay = Color(0xFF1C1828);

  /// Input alanları - Subtle distinction
  static const Color surfaceInput = Color(0xFF18151F);

  // ─────────────────────────────────────────────────────────────────────────
  // PRIMARY - Purple (Premium, Wisdom, Wealth)
  // Purple triggers feelings of luxury, wisdom, and financial success
  // ─────────────────────────────────────────────────────────────────────────

  /// Primary brand color
  static const Color primary = Color(0xFF8B5CF6);

  /// Primary light variant - Hover states
  static const Color primaryLight = Color(0xFFA78BFA);

  /// Primary dark variant - Pressed states
  static const Color primaryDark = Color(0xFF7C3AED);

  /// Primary subtle - 8% opacity for backgrounds
  static const Color primarySubtle = Color(0x148B5CF6);

  /// Primary muted - 15% opacity
  static const Color primaryMuted = Color(0x268B5CF6);

  // ─────────────────────────────────────────────────────────────────────────
  // SECONDARY - Cyan (Fresh, Trust, Savings = Positive!)
  // Cyan represents freshness, trust, and positive savings
  // ─────────────────────────────────────────────────────────────────────────

  /// Secondary brand color
  static const Color secondary = Color(0xFF06B6D4);

  /// Secondary light variant
  static const Color secondaryLight = Color(0xFF22D3EE);

  /// Secondary dark variant
  static const Color secondaryDark = Color(0xFF0891B2);

  /// Secondary subtle
  static const Color secondarySubtle = Color(0x1406B6D4);

  // ─────────────────────────────────────────────────────────────────────────
  // SEMANTIC STATES
  // Standard semantic colors with psychological undertones
  // ─────────────────────────────────────────────────────────────────────────

  /// Success - Emerald green (growth, prosperity)
  static const Color success = Color(0xFF10B981);
  static const Color successLight = Color(0xFF34D399);
  static const Color successSubtle = Color(0x1410B981);

  /// Warning - Amber (caution, attention)
  static const Color warning = Color(0xFFF59E0B);
  static const Color warningLight = Color(0xFFFBBF24);
  static const Color warningSubtle = Color(0x14F59E0B);

  /// Error - Rose red (urgency, importance)
  static const Color error = Color(0xFFEF4444);
  static const Color errorLight = Color(0xFFF87171);
  static const Color errorSubtle = Color(0x14EF4444);

  /// Info - Blue (trust, stability)
  static const Color info = Color(0xFF3B82F6);
  static const Color infoLight = Color(0xFF60A5FA);
  static const Color infoSubtle = Color(0x143B82F6);

  // ─────────────────────────────────────────────────────────────────────────
  // DECISION COLORS (Vantag specific)
  // Psychology: Make "Passed" feel positive (savings!)
  // ─────────────────────────────────────────────────────────────────────────

  /// Aldım - Soft rose (purchased, spent)
  static const Color decisionYes = Color(0xFFF87171);

  /// Düşünüyorum - Amber (contemplating)
  static const Color decisionThinking = Color(0xFFFBBF24);

  /// Vazgeçtim - CYAN (positive! money saved!)
  static const Color decisionNo = Color(0xFF06B6D4);

  // ─────────────────────────────────────────────────────────────────────────
  // BUDGET THRESHOLDS (Traffic light psychology)
  // Gradual color change triggers appropriate emotional response
  // ─────────────────────────────────────────────────────────────────────────

  /// 0-50% - Safe zone (green = go, prosperity)
  static const Color budgetSafe = Color(0xFF10B981);

  /// 50-70% - Caution zone (amber = slow down)
  static const Color budgetCaution = Color(0xFFF59E0B);

  /// 70-90% - Warning zone (orange = alert)
  static const Color budgetWarning = Color(0xFFEA580C);

  /// 90%+ - Danger zone (red = stop)
  static const Color budgetDanger = Color(0xFFEF4444);

  /// Dynamic budget color based on percentage
  static Color getBudgetColor(double percentage) {
    if (percentage < 50) return budgetSafe;
    if (percentage < 70) return budgetCaution;
    if (percentage < 90) return budgetWarning;
    return budgetDanger;
  }

  /// Get budget status text
  static String getBudgetStatus(double percentage) {
    if (percentage < 50) return 'Güvenli Bölge';
    if (percentage < 70) return 'Dikkatli Ol';
    if (percentage < 90) return 'Uyarı!';
    return 'Limit Aşıldı';
  }

  // ─────────────────────────────────────────────────────────────────────────
  // TEXT HIERARCHY
  // Clear hierarchy improves readability and comprehension
  // ─────────────────────────────────────────────────────────────────────────

  /// Primary text - Full white
  static const Color textPrimary = Color(0xFFFAFAFA);

  /// Secondary text - 60% opacity
  static const Color textSecondary = Color(0xFFA1A1AA);

  /// Tertiary text - 45% opacity
  static const Color textTertiary = Color(0xFF71717A);

  /// Muted text - 30% opacity
  static const Color textMuted = Color(0xFF52525B);

  /// Disabled text
  static const Color textDisabled = Color(0xFF3F3F46);

  // ─────────────────────────────────────────────────────────────────────────
  // GLASS COLORS (Liquid Glass effect)
  // Creates depth and dimension while maintaining readability
  // ─────────────────────────────────────────────────────────────────────────

  /// Glass fill - 5% white
  static const Color glassFill = Color(0x0DFFFFFF);

  /// Glass border - 8% white
  static const Color glassBorder = Color(0x14FFFFFF);

  /// Glass highlight - 15% white (top edge reflection)
  static const Color glassHighlight = Color(0x26FFFFFF);

  /// Glass shadow
  static const Color glassShadow = Color(0x40000000);

  // ─────────────────────────────────────────────────────────────────────────
  // GAMIFICATION COLORS
  // Colors that trigger dopamine and engagement
  // ─────────────────────────────────────────────────────────────────────────

  /// Streak flame - Orange fire
  static const Color streakFlame = Color(0xFFFF6B35);

  /// Gold reward
  static const Color gold = Color(0xFFFFD700);

  /// Achievement purple
  static const Color achievement = Color(0xFF9333EA);

  /// Level up cyan
  static const Color levelUp = Color(0xFF22D3EE);

  // ─────────────────────────────────────────────────────────────────────────
  // GRADIENT PRESETS
  // ─────────────────────────────────────────────────────────────────────────

  /// Primary gradient
  static const LinearGradient primaryGradient = LinearGradient(
    begin: Alignment.topLeft,
    end: Alignment.bottomRight,
    colors: [primary, primaryDark],
  );

  /// Success gradient
  static const LinearGradient successGradient = LinearGradient(
    begin: Alignment.topLeft,
    end: Alignment.bottomRight,
    colors: [success, Color(0xFF059669)],
  );

  /// Background gradient
  static const LinearGradient backgroundGradient = LinearGradient(
    begin: Alignment.topCenter,
    end: Alignment.bottomCenter,
    colors: [background, surface],
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// TYPOGRAPHY SYSTEM
// ═══════════════════════════════════════════════════════════════════════════

/// Psychology-based typography for maximum readability and impact
class PsychologyTypography {
  PsychologyTypography._();

  // ─────────────────────────────────────────────────────────────────────────
  // DISPLAY - Hero numbers (financial data)
  // Large, bold numbers create impact and importance
  // ─────────────────────────────────────────────────────────────────────────

  /// Display large - 56px hero numbers
  static const TextStyle displayLarge = TextStyle(
    fontSize: 56,
    fontWeight: FontWeight.w800,
    letterSpacing: -2.0,
    height: 1.0,
    fontFeatures: [FontFeature.tabularFigures()],
    color: PsychologyColors.textPrimary,
  );

  /// Display medium - 44px important numbers
  static const TextStyle displayMedium = TextStyle(
    fontSize: 44,
    fontWeight: FontWeight.w700,
    letterSpacing: -1.5,
    height: 1.1,
    fontFeatures: [FontFeature.tabularFigures()],
    color: PsychologyColors.textPrimary,
  );

  /// Display small - 32px secondary numbers
  static const TextStyle displaySmall = TextStyle(
    fontSize: 32,
    fontWeight: FontWeight.w600,
    letterSpacing: -1.0,
    height: 1.2,
    fontFeatures: [FontFeature.tabularFigures()],
    color: PsychologyColors.textPrimary,
  );

  // ─────────────────────────────────────────────────────────────────────────
  // HEADLINES - Section titles
  // ─────────────────────────────────────────────────────────────────────────

  /// Headline large - 28px
  static const TextStyle headlineLarge = TextStyle(
    fontSize: 28,
    fontWeight: FontWeight.w700,
    letterSpacing: -0.5,
    height: 1.2,
    color: PsychologyColors.textPrimary,
  );

  /// Headline medium - 24px
  static const TextStyle headlineMedium = TextStyle(
    fontSize: 24,
    fontWeight: FontWeight.w600,
    letterSpacing: -0.3,
    height: 1.25,
    color: PsychologyColors.textPrimary,
  );

  /// Headline small - 20px
  static const TextStyle headlineSmall = TextStyle(
    fontSize: 20,
    fontWeight: FontWeight.w600,
    letterSpacing: -0.2,
    height: 1.3,
    color: PsychologyColors.textPrimary,
  );

  // ─────────────────────────────────────────────────────────────────────────
  // TITLE - Card titles, list headers
  // ─────────────────────────────────────────────────────────────────────────

  /// Title large - 18px
  static const TextStyle titleLarge = TextStyle(
    fontSize: 18,
    fontWeight: FontWeight.w600,
    height: 1.35,
    color: PsychologyColors.textPrimary,
  );

  /// Title medium - 16px
  static const TextStyle titleMedium = TextStyle(
    fontSize: 16,
    fontWeight: FontWeight.w600,
    height: 1.4,
    color: PsychologyColors.textPrimary,
  );

  /// Title small - 14px
  static const TextStyle titleSmall = TextStyle(
    fontSize: 14,
    fontWeight: FontWeight.w500,
    height: 1.4,
    color: PsychologyColors.textSecondary,
  );

  // ─────────────────────────────────────────────────────────────────────────
  // BODY - Readable text
  // Line height 1.5 for optimal readability
  // ─────────────────────────────────────────────────────────────────────────

  /// Body large - 17px
  static const TextStyle bodyLarge = TextStyle(
    fontSize: 17,
    fontWeight: FontWeight.w400,
    height: 1.5,
    color: PsychologyColors.textPrimary,
  );

  /// Body medium - 15px
  static const TextStyle bodyMedium = TextStyle(
    fontSize: 15,
    fontWeight: FontWeight.w400,
    height: 1.5,
    color: PsychologyColors.textSecondary,
  );

  /// Body small - 13px
  static const TextStyle bodySmall = TextStyle(
    fontSize: 13,
    fontWeight: FontWeight.w400,
    height: 1.45,
    color: PsychologyColors.textSecondary,
  );

  // ─────────────────────────────────────────────────────────────────────────
  // LABELS - Buttons, badges, chips
  // ─────────────────────────────────────────────────────────────────────────

  /// Label large - 15px
  static const TextStyle labelLarge = TextStyle(
    fontSize: 15,
    fontWeight: FontWeight.w600,
    height: 1.2,
    color: PsychologyColors.textPrimary,
  );

  /// Label medium - 13px
  static const TextStyle labelMedium = TextStyle(
    fontSize: 13,
    fontWeight: FontWeight.w500,
    height: 1.2,
    color: PsychologyColors.textSecondary,
  );

  /// Label small - 11px (uppercase for emphasis)
  static const TextStyle labelSmall = TextStyle(
    fontSize: 11,
    fontWeight: FontWeight.w500,
    letterSpacing: 0.5,
    height: 1.2,
    color: PsychologyColors.textTertiary,
  );

  // ─────────────────────────────────────────────────────────────────────────
  // SPECIAL STYLES
  // ─────────────────────────────────────────────────────────────────────────

  /// Mono - For currency amounts
  static const TextStyle mono = TextStyle(
    fontSize: 15,
    fontWeight: FontWeight.w500,
    fontFeatures: [FontFeature.tabularFigures()],
    color: PsychologyColors.textPrimary,
  );

  /// Badge - Uppercase badge text
  static const TextStyle badge = TextStyle(
    fontSize: 10,
    fontWeight: FontWeight.w600,
    letterSpacing: 1.0,
    height: 1.0,
    color: PsychologyColors.textPrimary,
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// ANIMATION SYSTEM
// ═══════════════════════════════════════════════════════════════════════════

/// Research-based animation timings for optimal UX
class PsychologyAnimations {
  PsychologyAnimations._();

  // ─────────────────────────────────────────────────────────────────────────
  // DURATIONS (research-based)
  // Timings based on UX research for perceived performance
  // ─────────────────────────────────────────────────────────────────────────

  /// Instant - Button press feedback (50ms)
  static const Duration instant = Duration(milliseconds: 50);

  /// Micro - Ultra-fast transitions (100ms)
  static const Duration micro = Duration(milliseconds: 100);

  /// Quick - State changes, micro-interactions (150ms)
  static const Duration quick = Duration(milliseconds: 150);

  /// Standard - Normal transitions (300ms)
  static const Duration standardDuration = Duration(milliseconds: 300);

  /// Emphasis - Important transitions (400ms)
  static const Duration emphasis = Duration(milliseconds: 400);

  /// Slow - Dramatic reveals (600ms)
  static const Duration slow = Duration(milliseconds: 600);

  /// Count up - Number animations (800ms)
  static const Duration countUp = Duration(milliseconds: 800);

  /// Page transition (350ms)
  static const Duration pageTransition = Duration(milliseconds: 350);

  /// Breathing cycle - Glow pulse (3000ms)
  static const Duration breathingCycle = Duration(milliseconds: 3000);

  /// Shimmer cycle (1500ms)
  static const Duration shimmerCycle = Duration(milliseconds: 1500);

  // ─────────────────────────────────────────────────────────────────────────
  // CURVES
  // Different curves for different emotional responses
  // ─────────────────────────────────────────────────────────────────────────

  /// Standard curve - General purpose
  static const Curve standardCurve = Curves.easeOutCubic;

  /// Decelerate - Coming to rest
  static const Curve decelerate = Curves.decelerate;

  /// Bounce - Playful feedback
  static const Curve bounce = Curves.elasticOut;

  /// Spring - Snappy return
  static const Curve spring = Curves.easeOutBack;

  /// Smooth - Breathing animations
  static const Curve smooth = Curves.easeInOut;

  /// Sharp - Quick micro-interactions
  static const Curve sharp = Curves.easeOutQuart;

  // ─────────────────────────────────────────────────────────────────────────
  // SCALE VALUES
  // Subtle scale changes for tactile feedback
  // ─────────────────────────────────────────────────────────────────────────

  /// Button press scale (96%)
  static const double buttonPressScale = 0.96;

  /// Card press scale (98%)
  static const double cardPressScale = 0.98;

  /// Emphasis scale (105%)
  static const double emphasisScale = 1.05;

  /// Celebration scale (115%)
  static const double celebrationScale = 1.15;

  /// Icon pulse min (90%)
  static const double pulseMin = 0.9;

  /// Icon pulse max (110%)
  static const double pulseMax = 1.1;

  // ─────────────────────────────────────────────────────────────────────────
  // GLOW INTENSITY VALUES
  // ─────────────────────────────────────────────────────────────────────────

  /// Glow min opacity
  static const double glowMin = 0.15;

  /// Glow max opacity
  static const double glowMax = 0.45;

  /// Subtle glow
  static const double glowSubtle = 0.1;

  /// Strong glow
  static const double glowStrong = 0.6;
}

// ═══════════════════════════════════════════════════════════════════════════
// SPACING SYSTEM (4px grid)
// ═══════════════════════════════════════════════════════════════════════════

/// Consistent spacing based on 4px grid
class PsychologySpacing {
  PsychologySpacing._();

  /// Extra small - 4px
  static const double xs = 4.0;

  /// Small - 8px
  static const double sm = 8.0;

  /// Medium - 12px
  static const double md = 12.0;

  /// Large - 16px
  static const double lg = 16.0;

  /// Extra large - 20px
  static const double xl = 20.0;

  /// XXL - 24px
  static const double xxl = 24.0;

  /// XXXL - 32px
  static const double xxxl = 32.0;

  /// Section spacing - 48px
  static const double section = 48.0;

  /// Card padding
  static const EdgeInsets cardPadding = EdgeInsets.all(20.0);

  /// Card padding compact
  static const EdgeInsets cardPaddingCompact = EdgeInsets.all(16.0);

  /// Screen horizontal padding
  static const EdgeInsets screenPadding = EdgeInsets.symmetric(horizontal: 20.0);

  /// List item padding
  static const EdgeInsets listItemPadding = EdgeInsets.symmetric(
    horizontal: 16.0,
    vertical: 12.0,
  );

  /// Sheet padding - Bottom sheets and modals
  static const EdgeInsets sheetPadding = EdgeInsets.all(24.0);

  /// Sheet padding horizontal
  static const EdgeInsets sheetPaddingHorizontal = EdgeInsets.symmetric(
    horizontal: 24.0,
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// RADIUS SYSTEM
// ═══════════════════════════════════════════════════════════════════════════

/// Consistent border radius values
class PsychologyRadius {
  PsychologyRadius._();

  /// Small - 8px (buttons, chips)
  static const double sm = 8.0;

  /// Medium - 12px (inputs, small cards)
  static const double md = 12.0;

  /// Large - 16px (cards)
  static const double lg = 16.0;

  /// Extra large - 20px (large cards)
  static const double xl = 20.0;

  /// XXL - 24px (hero cards)
  static const double xxl = 24.0;

  /// Sheet - 32px (bottom sheets, modals)
  static const double sheet = 32.0;

  /// Full - Pill shape
  static const double full = 999.0;

  /// Card border radius
  static const BorderRadius card = BorderRadius.all(Radius.circular(20.0));

  /// Button border radius
  static const BorderRadius button = BorderRadius.all(Radius.circular(14.0));

  /// Sheet border radius
  static const BorderRadius sheetTop = BorderRadius.vertical(
    top: Radius.circular(32.0),
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// SHADOW SYSTEM
// ═══════════════════════════════════════════════════════════════════════════

/// Psychology-based shadow system for depth and hierarchy
class PsychologyShadows {
  PsychologyShadows._();

  /// Subtle shadow - Minimal elevation
  static List<BoxShadow> subtle(Color color) => [
    BoxShadow(
      color: color.withValues(alpha: 0.08),
      blurRadius: 8,
      offset: const Offset(0, 2),
    ),
  ];

  /// Medium shadow - Cards
  static List<BoxShadow> medium(Color color) => [
    BoxShadow(
      color: color.withValues(alpha: 0.12),
      blurRadius: 16,
      offset: const Offset(0, 4),
    ),
  ];

  /// Strong shadow - Elevated elements
  static List<BoxShadow> strong(Color color) => [
    BoxShadow(
      color: color.withValues(alpha: 0.2),
      blurRadius: 24,
      offset: const Offset(0, 8),
    ),
  ];

  /// Glow shadow - Breathing effect
  static List<BoxShadow> glow(Color color, {double intensity = 0.2, double blur = 24}) => [
    BoxShadow(
      color: color.withValues(alpha: intensity),
      blurRadius: blur,
      spreadRadius: -4,
    ),
  ];

  /// Double shadow - Depth + glow
  static List<BoxShadow> glowWithDepth(Color glowColor, {double intensity = 0.3}) => [
    // Glow layer
    BoxShadow(
      color: glowColor.withValues(alpha: intensity),
      blurRadius: 32,
      spreadRadius: -4,
    ),
    // Depth layer
    BoxShadow(
      color: Colors.black.withValues(alpha: 0.3),
      blurRadius: 16,
      offset: const Offset(0, 8),
    ),
  ];

  /// Card shadow - Standard card elevation
  static const List<BoxShadow> card = [
    BoxShadow(
      color: Color(0x20000000),
      blurRadius: 20,
      offset: Offset(0, 8),
    ),
  ];

  /// Icon halo - Subtle glow around icons
  static List<Shadow> iconHalo(Color color) => [
    Shadow(
      color: color.withValues(alpha: 0.4),
      blurRadius: 12,
    ),
  ];
}

// ═══════════════════════════════════════════════════════════════════════════
// GLASS EFFECT SYSTEM
// ═══════════════════════════════════════════════════════════════════════════

/// Liquid Glass effect parameters
class PsychologyGlass {
  PsychologyGlass._();

  /// Default blur sigma
  static const double blurSigma = 24.0;

  /// Hero card blur sigma
  static const double heroBlurSigma = 30.0;

  /// Light blur sigma (for smaller elements)
  static const double lightBlurSigma = 16.0;

  /// Heavy blur sigma (for prominent elements)
  static const double heavyBlurSigma = 40.0;

  /// Glass fill opacity
  static const double fillOpacity = 0.05;

  /// Glass border opacity
  static const double borderOpacity = 0.08;

  /// Glass highlight opacity
  static const double highlightOpacity = 0.15;

  /// Create glass decoration
  static BoxDecoration decoration({
    Color? glowColor,
    double glowIntensity = 0.2,
    double borderRadius = 20.0,
  }) {
    return BoxDecoration(
      gradient: LinearGradient(
        begin: Alignment.topLeft,
        end: Alignment.bottomRight,
        colors: [
          Colors.white.withValues(alpha: 0.08),
          Colors.white.withValues(alpha: 0.04),
        ],
      ),
      borderRadius: BorderRadius.circular(borderRadius),
      border: Border.all(
        color: Colors.white.withValues(alpha: borderOpacity),
        width: 1,
      ),
      boxShadow: glowColor != null
          ? PsychologyShadows.glow(glowColor, intensity: glowIntensity)
          : null,
    );
  }

  /// Create glass gradient for specific color
  static LinearGradient gradient(Color color, {double intensity = 0.12}) {
    return LinearGradient(
      begin: Alignment.topLeft,
      end: Alignment.bottomRight,
      colors: [
        color.withValues(alpha: intensity),
        color.withValues(alpha: intensity * 0.3),
      ],
    );
  }

  /// Top highlight gradient (light refraction effect)
  static LinearGradient get topHighlight => LinearGradient(
    begin: Alignment.topCenter,
    end: Alignment.bottomCenter,
    colors: [
      Colors.white.withValues(alpha: highlightOpacity),
      Colors.white.withValues(alpha: 0),
    ],
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// HELPER EXTENSIONS
// ═══════════════════════════════════════════════════════════════════════════

/// Extension for easy access to psychology colors from BuildContext
extension PsychologyColorsExtension on BuildContext {
  /// Get psychology colors
  PsychologyColors get psychologyColors => PsychologyColors._();
}

/// Extension for TextStyle with psychology color
extension PsychologyTextStyleExtension on TextStyle {
  /// Apply primary color
  TextStyle get primary => copyWith(color: PsychologyColors.textPrimary);

  /// Apply secondary color
  TextStyle get secondary => copyWith(color: PsychologyColors.textSecondary);

  /// Apply tertiary color
  TextStyle get tertiary => copyWith(color: PsychologyColors.textTertiary);

  /// Apply muted color
  TextStyle get muted => copyWith(color: PsychologyColors.textMuted);

  /// Apply custom color
  TextStyle withColor(Color color) => copyWith(color: color);

  /// Add glow shadow
  TextStyle withGlow(Color color, {double intensity = 0.4}) => copyWith(
    shadows: [Shadow(color: color.withValues(alpha: intensity), blurRadius: 12)],
  );
}


--- FILE: lib/core/theme/psychology_widgets.dart ---

import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'psychology_design_system.dart';
import 'psychology_effects.dart';

/// ═══════════════════════════════════════════════════════════════════════════
/// PREMIUM PSYCHOLOGY WIDGETS
/// Apple Liquid Glass + Gamification + Dopamine Triggers
/// ═══════════════════════════════════════════════════════════════════════════

// ═══════════════════════════════════════════════════════════════════════════
// WIDGET 1: PREMIUM HERO CARD
// Main dashboard card showing work hours
// ═══════════════════════════════════════════════════════════════════════════

/// Premium hero card displaying work hours with animated glow
class PremiumHeroCard extends StatefulWidget {
  final double hoursWorked;
  final double daysWorked;
  final double budgetPercentage;
  final VoidCallback? onTap;

  const PremiumHeroCard({
    super.key,
    required this.hoursWorked,
    required this.daysWorked,
    required this.budgetPercentage,
    this.onTap,
  });

  @override
  State<PremiumHeroCard> createState() => _PremiumHeroCardState();
}

class _PremiumHeroCardState extends State<PremiumHeroCard>
    with TickerProviderStateMixin {
  late AnimationController _breathingController;
  late AnimationController _countController;
  late Animation<double> _breathingAnimation;
  late Animation<double> _countAnimation;

  double _previousHours = 0;
  double _previousDays = 0;

  @override
  void initState() {
    super.initState();

    // Breathing glow animation (3s cycle)
    _breathingController = AnimationController(
      vsync: this,
      duration: PsychologyAnimations.breathingCycle,
    )..repeat(reverse: true);

    _breathingAnimation = Tween<double>(
      begin: PsychologyAnimations.glowMin,
      end: PsychologyAnimations.glowMax,
    ).animate(CurvedAnimation(
      parent: _breathingController,
      curve: PsychologyAnimations.smooth,
    ));

    // Count-up animation (800ms)
    _countController = AnimationController(
      vsync: this,
      duration: PsychologyAnimations.countUp,
    );
    _countAnimation = CurvedAnimation(
      parent: _countController,
      curve: PsychologyAnimations.standardCurve,
    );
    _countController.forward();
  }

  @override
  void didUpdateWidget(PremiumHeroCard oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (oldWidget.hoursWorked != widget.hoursWorked ||
        oldWidget.daysWorked != widget.daysWorked) {
      _previousHours = oldWidget.hoursWorked;
      _previousDays = oldWidget.daysWorked;
      _countController.forward(from: 0);
    }
  }

  @override
  void dispose() {
    _breathingController.dispose();
    _countController.dispose();
    super.dispose();
  }

  double _lerp(double begin, double end, double t) {
    return begin + (end - begin) * t;
  }

  @override
  Widget build(BuildContext context) {
    final budgetColor = PsychologyColors.getBudgetColor(widget.budgetPercentage);

    return AnimatedBuilder(
      animation: Listenable.merge([_breathingAnimation, _countAnimation]),
      builder: (context, child) {
        final animatedHours = _lerp(_previousHours, widget.hoursWorked, _countAnimation.value);
        final animatedDays = _lerp(_previousDays, widget.daysWorked, _countAnimation.value);

        return GestureDetector(
          onTap: () {
            HapticFeedback.lightImpact();
            widget.onTap?.call();
          },
          child: Container(
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(PsychologyRadius.xxl),
              boxShadow: [
                // Animated breathing glow
                BoxShadow(
                  color: budgetColor.withValues(alpha: _breathingAnimation.value),
                  blurRadius: 40,
                  spreadRadius: -4,
                ),
                // Depth shadow
                BoxShadow(
                  color: Colors.black.withValues(alpha: 0.35),
                  blurRadius: 20,
                  offset: const Offset(0, 10),
                ),
              ],
            ),
            child: ClipRRect(
              borderRadius: BorderRadius.circular(PsychologyRadius.xxl),
              child: BackdropFilter(
                filter: ImageFilter.blur(
                  sigmaX: PsychologyGlass.heroBlurSigma,
                  sigmaY: PsychologyGlass.heroBlurSigma,
                ),
                child: Container(
                  padding: PsychologySpacing.cardPadding,
                  decoration: BoxDecoration(
                    gradient: LinearGradient(
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                      colors: [
                        PsychologyColors.primary.withValues(alpha: 0.12),
                        PsychologyColors.primary.withValues(alpha: 0.04),
                      ],
                    ),
                    borderRadius: BorderRadius.circular(PsychologyRadius.xxl),
                    border: Border.all(
                      color: Colors.white.withValues(alpha: PsychologyGlass.borderOpacity),
                      width: 1,
                    ),
                  ),
                  child: Stack(
                    children: [
                      // Top highlight
                      Positioned(
                        top: 0,
                        left: 0,
                        right: 0,
                        height: 60,
                        child: Container(
                          decoration: BoxDecoration(
                            borderRadius: const BorderRadius.vertical(
                              top: Radius.circular(PsychologyRadius.xxl),
                            ),
                            gradient: PsychologyGlass.topHighlight,
                          ),
                        ),
                      ),
                      // Content
                      Column(
                        children: [
                          // Badge
                          Container(
                            padding: const EdgeInsets.symmetric(
                              horizontal: 12,
                              vertical: 6,
                            ),
                            decoration: BoxDecoration(
                              color: PsychologyColors.primarySubtle,
                              borderRadius: BorderRadius.circular(PsychologyRadius.full),
                              border: Border.all(
                                color: PsychologyColors.primary.withValues(alpha: 0.3),
                              ),
                            ),
                            child: Row(
                              mainAxisSize: MainAxisSize.min,
                              children: [
                                Icon(
                                  CupertinoIcons.clock_fill,
                                  size: 14,
                                  color: PsychologyColors.primary,
                                ),
                                const SizedBox(width: 6),
                                Text(
                                  'ÇALIŞMA KARŞILIĞI',
                                  style: PsychologyTypography.badge.copyWith(
                                    color: PsychologyColors.primary,
                                  ),
                                ),
                              ],
                            ),
                          ),
                          const SizedBox(height: 24),
                          // Hero numbers
                          Row(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              // Hours
                              _buildTimeBlock(
                                value: animatedHours.toStringAsFixed(0),
                                label: 'SAAT',
                                icon: CupertinoIcons.clock_fill,
                                color: PsychologyColors.primary,
                              ),
                              // Divider
                              Container(
                                width: 2,
                                height: 70,
                                margin: const EdgeInsets.symmetric(horizontal: 28),
                                decoration: BoxDecoration(
                                  gradient: LinearGradient(
                                    begin: Alignment.topCenter,
                                    end: Alignment.bottomCenter,
                                    colors: [
                                      Colors.white.withValues(alpha: 0),
                                      Colors.white.withValues(alpha: 0.3),
                                      Colors.white.withValues(alpha: 0),
                                    ],
                                  ),
                                  borderRadius: BorderRadius.circular(1),
                                ),
                              ),
                              // Days
                              _buildTimeBlock(
                                value: animatedDays.toStringAsFixed(0),
                                label: 'GÜN',
                                icon: CupertinoIcons.sun_max_fill,
                                color: PsychologyColors.secondary,
                              ),
                            ],
                          ),
                          const SizedBox(height: 24),
                          // Progress bar
                          Column(
                            children: [
                              Row(
                                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                                children: [
                                  Text(
                                    'Bütçe Kullanımı',
                                    style: PsychologyTypography.labelSmall,
                                  ),
                                  Text(
                                    '%${widget.budgetPercentage.toStringAsFixed(0)}',
                                    style: PsychologyTypography.labelMedium.copyWith(
                                      color: budgetColor,
                                      fontWeight: FontWeight.w700,
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 8),
                              LevelProgressBar(
                                progress: widget.budgetPercentage / 100,
                                height: 8,
                                color: budgetColor,
                              ),
                            ],
                          ),
                        ],
                      ),
                    ],
                  ),
                ),
              ),
            ),
          ),
        );
      },
    );
  }

  Widget _buildTimeBlock({
    required String value,
    required String label,
    required IconData icon,
    required Color color,
  }) {
    return Column(
      children: [
        // Icon container
        Container(
          width: 52,
          height: 52,
          decoration: BoxDecoration(
            gradient: LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: [
                color.withValues(alpha: 0.25),
                color.withValues(alpha: 0.1),
              ],
            ),
            borderRadius: BorderRadius.circular(16),
            border: Border.all(
              color: color.withValues(alpha: 0.3),
            ),
            boxShadow: PsychologyShadows.glow(color, intensity: 0.3, blur: 16),
          ),
          child: Icon(icon, size: 24, color: color),
        ),
        const SizedBox(height: 14),
        // Value
        Text(
          value,
          style: PsychologyTypography.displayMedium.copyWith(
            fontFeatures: const [FontFeature.tabularFigures()],
            shadows: [
              Shadow(
                color: color.withValues(alpha: 0.5),
                blurRadius: 20,
              ),
            ],
          ),
        ),
        const SizedBox(height: 6),
        // Label
        Text(
          label,
          style: PsychologyTypography.labelSmall.copyWith(
            letterSpacing: 1.5,
          ),
        ),
      ],
    );
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// WIDGET 2: PREMIUM DECISION BUTTONS
// ═══════════════════════════════════════════════════════════════════════════

enum ExpenseDecisionType { bought, thinking, passed }

/// Premium decision buttons with psychology-based emphasis
class PremiumDecisionButtons extends StatelessWidget {
  final Function(ExpenseDecisionType) onDecision;
  final bool enabled;

  const PremiumDecisionButtons({
    super.key,
    required this.onDecision,
    this.enabled = true,
  });

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        Text(
          'Kararın ne oldu?',
          style: PsychologyTypography.bodyMedium,
          textAlign: TextAlign.center,
        ),
        const SizedBox(height: 16),
        Row(
          children: [
            Expanded(
              child: _DecisionButton(
                label: 'Aldım',
                icon: CupertinoIcons.checkmark,
                color: PsychologyColors.decisionYes,
                type: ExpenseDecisionType.bought,
                onTap: enabled ? () => onDecision(ExpenseDecisionType.bought) : null,
              ),
            ),
            const SizedBox(width: 10),
            Expanded(
              child: _DecisionButton(
                label: 'Düşünüyorum',
                icon: CupertinoIcons.clock,
                color: PsychologyColors.decisionThinking,
                type: ExpenseDecisionType.thinking,
                onTap: enabled ? () => onDecision(ExpenseDecisionType.thinking) : null,
              ),
            ),
            const SizedBox(width: 10),
            Expanded(
              child: _DecisionButton(
                label: 'Vazgeçtim',
                icon: CupertinoIcons.xmark,
                color: PsychologyColors.decisionNo,
                type: ExpenseDecisionType.passed,
                onTap: enabled ? () => onDecision(ExpenseDecisionType.passed) : null,
                isEmphasized: true, // Positive action = emphasized
              ),
            ),
          ],
        ),
      ],
    );
  }
}

class _DecisionButton extends StatefulWidget {
  final String label;
  final IconData icon;
  final Color color;
  final ExpenseDecisionType type;
  final VoidCallback? onTap;
  final bool isEmphasized;

  const _DecisionButton({
    required this.label,
    required this.icon,
    required this.color,
    required this.type,
    this.onTap,
    this.isEmphasized = false,
  });

  @override
  State<_DecisionButton> createState() => _DecisionButtonState();
}

class _DecisionButtonState extends State<_DecisionButton>
    with TickerProviderStateMixin {
  late AnimationController _scaleController;
  late AnimationController _glowController;
  late Animation<double> _scaleAnimation;
  late Animation<double> _glowAnimation;
  bool _isPressed = false;

  @override
  void initState() {
    super.initState();

    _scaleController = AnimationController(
      vsync: this,
      duration: PsychologyAnimations.quick,
    );
    _scaleAnimation = Tween<double>(
      begin: 1.0,
      end: PsychologyAnimations.buttonPressScale,
    ).animate(CurvedAnimation(
      parent: _scaleController,
      curve: PsychologyAnimations.standardCurve,
    ));

    // Emphasis glow for "Vazgeçtim" button
    _glowController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 2000),
    );
    _glowAnimation = Tween<double>(begin: 0.2, end: 0.5).animate(
      CurvedAnimation(parent: _glowController, curve: Curves.easeInOut),
    );

    if (widget.isEmphasized) {
      _glowController.repeat(reverse: true);
    }
  }

  @override
  void dispose() {
    _scaleController.dispose();
    _glowController.dispose();
    super.dispose();
  }

  void _handleTapDown(TapDownDetails details) {
    if (widget.onTap == null) return;
    setState(() => _isPressed = true);
    _scaleController.forward();
    HapticFeedback.lightImpact();
  }

  void _handleTapUp(TapUpDetails details) {
    if (widget.onTap == null) return;
    setState(() => _isPressed = false);
    _scaleController.reverse();
  }

  void _handleTapCancel() {
    if (widget.onTap == null) return;
    setState(() => _isPressed = false);
    _scaleController.reverse();
  }

  void _handleTap() {
    if (widget.onTap == null) return;

    switch (widget.type) {
      case ExpenseDecisionType.bought:
        HapticFeedback.mediumImpact();
        break;
      case ExpenseDecisionType.thinking:
        HapticFeedback.lightImpact();
        break;
      case ExpenseDecisionType.passed:
        HapticFeedback.heavyImpact(); // Celebration!
        break;
    }

    widget.onTap!();
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: Listenable.merge([_scaleAnimation, _glowAnimation]),
      builder: (context, child) {
        return Transform.scale(
          scale: _scaleAnimation.value,
          child: GestureDetector(
            onTapDown: _handleTapDown,
            onTapUp: _handleTapUp,
            onTapCancel: _handleTapCancel,
            onTap: _handleTap,
            child: Container(
              constraints: const BoxConstraints(minHeight: 88),
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(PsychologyRadius.lg),
                boxShadow: widget.isEmphasized
                    ? [
                        BoxShadow(
                          color: widget.color.withValues(alpha: _glowAnimation.value),
                          blurRadius: 20,
                          spreadRadius: -4,
                        ),
                      ]
                    : null,
              ),
              child: ClipRRect(
                borderRadius: BorderRadius.circular(PsychologyRadius.lg),
                child: BackdropFilter(
                  filter: ImageFilter.blur(sigmaX: 20, sigmaY: 20),
                  child: Container(
                    padding: const EdgeInsets.symmetric(
                      vertical: 16,
                      horizontal: 12,
                    ),
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                        colors: [
                          widget.color.withValues(alpha: _isPressed ? 0.2 : 0.12),
                          widget.color.withValues(alpha: _isPressed ? 0.15 : 0.06),
                        ],
                      ),
                      borderRadius: BorderRadius.circular(PsychologyRadius.lg),
                      border: Border.all(
                        color: widget.color.withValues(
                          alpha: widget.isEmphasized ? 0.4 : 0.2,
                        ),
                        width: widget.isEmphasized ? 1.5 : 1,
                      ),
                    ),
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        // Icon container
                        Container(
                          width: 44,
                          height: 44,
                          decoration: BoxDecoration(
                            gradient: LinearGradient(
                              colors: [
                                widget.color.withValues(alpha: 0.25),
                                widget.color.withValues(alpha: 0.1),
                              ],
                            ),
                            borderRadius: BorderRadius.circular(14),
                            border: Border.all(
                              color: widget.color.withValues(alpha: 0.3),
                            ),
                            boxShadow: PsychologyShadows.glow(
                              widget.color,
                              intensity: 0.25,
                              blur: 12,
                            ),
                          ),
                          child: Icon(
                            widget.icon,
                            size: 22,
                            color: widget.color,
                            shadows: PsychologyShadows.iconHalo(widget.color),
                          ),
                        ),
                        const SizedBox(height: 10),
                        // Label
                        Text(
                          widget.label,
                          style: PsychologyTypography.labelMedium.copyWith(
                            color: widget.color,
                            fontWeight: FontWeight.w600,
                          ),
                          textAlign: TextAlign.center,
                        ),
                      ],
                    ),
                  ),
                ),
              ),
            ),
          ),
        );
      },
    );
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// WIDGET 3: VERTICAL BUDGET BAR
// Fills from top to bottom (weight metaphor)
// ═══════════════════════════════════════════════════════════════════════════

/// Vertical budget bar that fills from top (weight/gravity metaphor)
class PremiumVerticalBudgetBar extends StatefulWidget {
  final double percentage;
  final double height;
  final double width;
  final bool showLabel;

  const PremiumVerticalBudgetBar({
    super.key,
    required this.percentage,
    this.height = 160,
    this.width = 32,
    this.showLabel = true,
  });

  @override
  State<PremiumVerticalBudgetBar> createState() => _PremiumVerticalBudgetBarState();
}

class _PremiumVerticalBudgetBarState extends State<PremiumVerticalBudgetBar>
    with TickerProviderStateMixin {
  late AnimationController _fillController;
  late AnimationController _pulseController;
  late Animation<double> _fillAnimation;
  late Animation<double> _pulseAnimation;

  @override
  void initState() {
    super.initState();

    // Fill animation
    _fillController = AnimationController(
      vsync: this,
      duration: PsychologyAnimations.countUp,
    );
    _fillAnimation = CurvedAnimation(
      parent: _fillController,
      curve: PsychologyAnimations.standardCurve,
    );
    _fillController.forward();

    // Pulse animation for warning state
    _pulseController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 1500),
    );
    _pulseAnimation = Tween<double>(begin: 0.3, end: 0.6).animate(
      CurvedAnimation(parent: _pulseController, curve: Curves.easeInOut),
    );

    if (widget.percentage >= 70) {
      _pulseController.repeat(reverse: true);
    }
  }

  @override
  void didUpdateWidget(PremiumVerticalBudgetBar oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (oldWidget.percentage != widget.percentage) {
      _fillController.forward(from: 0);
      if (widget.percentage >= 70 && !_pulseController.isAnimating) {
        _pulseController.repeat(reverse: true);
      } else if (widget.percentage < 70 && _pulseController.isAnimating) {
        _pulseController.stop();
      }
    }
  }

  @override
  void dispose() {
    _fillController.dispose();
    _pulseController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final color = PsychologyColors.getBudgetColor(widget.percentage);
    final status = PsychologyColors.getBudgetStatus(widget.percentage);

    return AnimatedBuilder(
      animation: Listenable.merge([_fillAnimation, _pulseAnimation]),
      builder: (context, child) {
        final animatedPercentage = widget.percentage * _fillAnimation.value;
        final fillHeight = (animatedPercentage / 100) * widget.height;
        final glowIntensity = widget.percentage >= 70
            ? _pulseAnimation.value
            : 0.3;

        return Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            // Bar container
            Container(
              width: widget.width,
              height: widget.height,
              decoration: BoxDecoration(
                color: PsychologyColors.surfaceElevated,
                borderRadius: BorderRadius.circular(widget.width / 2),
                border: Border.all(
                  color: color.withValues(alpha: 0.3),
                ),
                boxShadow: PsychologyShadows.glow(color, intensity: glowIntensity),
              ),
              child: ClipRRect(
                borderRadius: BorderRadius.circular(widget.width / 2),
                child: Stack(
                  children: [
                    // Fill from top
                    Positioned(
                      top: 0,
                      left: 0,
                      right: 0,
                      height: fillHeight,
                      child: Container(
                        decoration: BoxDecoration(
                          gradient: LinearGradient(
                            begin: Alignment.topCenter,
                            end: Alignment.bottomCenter,
                            colors: [
                              color,
                              color.withValues(alpha: 0.6),
                            ],
                          ),
                          borderRadius: BorderRadius.circular(widget.width / 2),
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ),
            if (widget.showLabel) ...[
              const SizedBox(height: 12),
              // Percentage
              Text(
                '%${widget.percentage.toStringAsFixed(0)}',
                style: PsychologyTypography.titleMedium.copyWith(
                  color: color,
                  fontWeight: FontWeight.w700,
                  fontFeatures: const [FontFeature.tabularFigures()],
                ),
              ),
              const SizedBox(height: 4),
              // Status text
              Text(
                status,
                style: PsychologyTypography.labelSmall.copyWith(
                  color: color,
                ),
                textAlign: TextAlign.center,
              ),
            ],
          ],
        );
      },
    );
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// WIDGET 4: STREAK BADGE
// ═══════════════════════════════════════════════════════════════════════════

/// Animated streak badge for gamification
class PremiumStreakBadge extends StatefulWidget {
  final int streakCount;
  final VoidCallback? onTap;

  const PremiumStreakBadge({
    super.key,
    required this.streakCount,
    this.onTap,
  });

  @override
  State<PremiumStreakBadge> createState() => _PremiumStreakBadgeState();
}

class _PremiumStreakBadgeState extends State<PremiumStreakBadge>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _scaleAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 800),
    );
    _scaleAnimation = Tween<double>(
      begin: PsychologyAnimations.pulseMin,
      end: PsychologyAnimations.pulseMax,
    ).animate(CurvedAnimation(
      parent: _controller,
      curve: Curves.easeInOut,
    ));

    if (widget.streakCount > 0) {
      _controller.repeat(reverse: true);
    }
  }

  @override
  void didUpdateWidget(PremiumStreakBadge oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (widget.streakCount > 0 && !_controller.isAnimating) {
      _controller.repeat(reverse: true);
    } else if (widget.streakCount == 0 && _controller.isAnimating) {
      _controller.stop();
    }
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final isActive = widget.streakCount > 0;
    final color = isActive
        ? PsychologyColors.streakFlame
        : PsychologyColors.textTertiary;

    return GestureDetector(
      onTap: () {
        HapticFeedback.lightImpact();
        widget.onTap?.call();
      },
      child: AnimatedBuilder(
        animation: _scaleAnimation,
        builder: (context, child) {
          return Container(
            padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 8),
            decoration: BoxDecoration(
              color: color.withValues(alpha: 0.12),
              borderRadius: BorderRadius.circular(PsychologyRadius.full),
              border: Border.all(
                color: color.withValues(alpha: 0.25),
              ),
              boxShadow: isActive
                  ? PsychologyShadows.glow(color, intensity: 0.3)
                  : null,
            ),
            child: Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                Transform.scale(
                  scale: isActive ? _scaleAnimation.value : 1.0,
                  child: Icon(
                    CupertinoIcons.flame_fill,
                    size: 18,
                    color: color,
                    shadows: isActive
                        ? PsychologyShadows.iconHalo(color)
                        : null,
                  ),
                ),
                const SizedBox(width: 6),
                Text(
                  '${widget.streakCount} gün',
                  style: PsychologyTypography.labelMedium.copyWith(
                    color: color,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ],
            ),
          );
        },
      ),
    );
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// WIDGET 5: STAT CARD
// ═══════════════════════════════════════════════════════════════════════════

/// Small stat card for bento grid layouts
class PremiumStatCard extends StatelessWidget {
  final String title;
  final String value;
  final String? subtitle;
  final IconData icon;
  final Color color;
  final VoidCallback? onTap;

  const PremiumStatCard({
    super.key,
    required this.title,
    required this.value,
    this.subtitle,
    required this.icon,
    required this.color,
    this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    return PsychologyGlassCard(
      glowColor: color,
      glowIntensity: 0.15,
      onTap: onTap != null
          ? () {
              HapticFeedback.lightImpact();
              onTap!();
            }
          : null,
      padding: PsychologySpacing.cardPaddingCompact,
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Icon
          Container(
            width: 40,
            height: 40,
            decoration: BoxDecoration(
              color: color.withValues(alpha: 0.15),
              borderRadius: BorderRadius.circular(10),
            ),
            child: Icon(icon, size: 20, color: color),
          ),
          const SizedBox(height: 12),
          // Title
          Text(
            title,
            style: PsychologyTypography.labelSmall,
          ),
          const SizedBox(height: 4),
          // Value
          Text(
            value,
            style: PsychologyTypography.headlineMedium.copyWith(
              fontFeatures: const [FontFeature.tabularFigures()],
            ),
          ),
          if (subtitle != null) ...[
            const SizedBox(height: 4),
            Text(
              subtitle!,
              style: PsychologyTypography.bodySmall.copyWith(
                color: color,
              ),
            ),
          ],
        ],
      ),
    );
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// WIDGET 6: SUCCESS BANNER
// ═══════════════════════════════════════════════════════════════════════════

/// Dopamine trigger success banner
class PremiumSuccessBanner extends StatefulWidget {
  final String message;
  final String? subtitle;
  final VoidCallback? onDismiss;

  const PremiumSuccessBanner({
    super.key,
    required this.message,
    this.subtitle,
    this.onDismiss,
  });

  @override
  State<PremiumSuccessBanner> createState() => _PremiumSuccessBannerState();
}

class _PremiumSuccessBannerState extends State<PremiumSuccessBanner>
    with TickerProviderStateMixin {
  late AnimationController _entryController;
  late AnimationController _glowController;
  late Animation<double> _scaleAnimation;
  late Animation<double> _opacityAnimation;
  late Animation<double> _glowAnimation;

  @override
  void initState() {
    super.initState();

    _entryController = AnimationController(
      vsync: this,
      duration: PsychologyAnimations.slow,
    );
    _scaleAnimation = Tween<double>(begin: 0.8, end: 1.0).animate(
      CurvedAnimation(parent: _entryController, curve: PsychologyAnimations.bounce),
    );
    _opacityAnimation = Tween<double>(begin: 0.0, end: 1.0).animate(
      CurvedAnimation(parent: _entryController, curve: Curves.easeOut),
    );

    _glowController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 2000),
    )..repeat(reverse: true);
    _glowAnimation = Tween<double>(begin: 0.3, end: 0.6).animate(
      CurvedAnimation(parent: _glowController, curve: Curves.easeInOut),
    );

    HapticFeedback.mediumImpact();
    _entryController.forward();
  }

  @override
  void dispose() {
    _entryController.dispose();
    _glowController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: Listenable.merge([_entryController, _glowController]),
      builder: (context, child) {
        return Transform.scale(
          scale: _scaleAnimation.value,
          child: Opacity(
            opacity: _opacityAnimation.value,
            child: Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: PsychologyColors.success.withValues(alpha: 0.12),
                borderRadius: BorderRadius.circular(PsychologyRadius.lg),
                border: Border.all(
                  color: PsychologyColors.success.withValues(alpha: 0.3),
                ),
                boxShadow: PsychologyShadows.glow(
                  PsychologyColors.success,
                  intensity: _glowAnimation.value,
                ),
              ),
              child: Row(
                children: [
                  // Icon
                  Container(
                    width: 44,
                    height: 44,
                    decoration: BoxDecoration(
                      color: PsychologyColors.success.withValues(alpha: 0.2),
                      shape: BoxShape.circle,
                    ),
                    child: const Icon(
                      CupertinoIcons.checkmark_circle_fill,
                      color: PsychologyColors.success,
                      size: 24,
                    ),
                  ),
                  const SizedBox(width: 14),
                  // Text
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          widget.message,
                          style: PsychologyTypography.titleMedium.copyWith(
                            color: PsychologyColors.success,
                          ),
                        ),
                        if (widget.subtitle != null) ...[
                          const SizedBox(height: 2),
                          Text(
                            widget.subtitle!,
                            style: PsychologyTypography.bodySmall.copyWith(
                              color: PsychologyColors.success.withValues(alpha: 0.8),
                            ),
                          ),
                        ],
                      ],
                    ),
                  ),
                  // Dismiss
                  if (widget.onDismiss != null)
                    GestureDetector(
                      onTap: () {
                        HapticFeedback.lightImpact();
                        widget.onDismiss!();
                      },
                      child: Icon(
                        CupertinoIcons.xmark,
                        size: 20,
                        color: PsychologyColors.success.withValues(alpha: 0.6),
                      ),
                    ),
                ],
              ),
            ),
          ),
        );
      },
    );
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// WIDGET 7: FLOATING TAB BAR
// ═══════════════════════════════════════════════════════════════════════════

class PremiumTabItem {
  final IconData icon;
  final IconData activeIcon;
  final String label;

  const PremiumTabItem({
    required this.icon,
    required this.activeIcon,
    required this.label,
  });
}

/// Floating navigation bar that shrinks on scroll
class PremiumFloatingTabBar extends StatelessWidget {
  final int currentIndex;
  final Function(int) onTap;
  final List<PremiumTabItem> items;
  final bool isExpanded;

  const PremiumFloatingTabBar({
    super.key,
    required this.currentIndex,
    required this.onTap,
    required this.items,
    this.isExpanded = true,
  });

  @override
  Widget build(BuildContext context) {
    return AnimatedContainer(
      duration: PsychologyAnimations.standardDuration,
      curve: PsychologyAnimations.standardCurve,
      margin: EdgeInsets.symmetric(
        horizontal: isExpanded ? 20 : 40,
        vertical: isExpanded ? 20 : 12,
      ),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(isExpanded ? 24 : 20),
        child: BackdropFilter(
          filter: ImageFilter.blur(sigmaX: 20, sigmaY: 20),
          child: Container(
            padding: EdgeInsets.symmetric(
              horizontal: isExpanded ? 8 : 4,
              vertical: isExpanded ? 8 : 4,
            ),
            decoration: BoxDecoration(
              color: PsychologyColors.surface.withValues(alpha: 0.8),
              borderRadius: BorderRadius.circular(isExpanded ? 24 : 20),
              border: Border.all(
                color: Colors.white.withValues(alpha: 0.08),
              ),
              boxShadow: const [
                BoxShadow(
                  color: Color(0x40000000),
                  blurRadius: 20,
                  offset: Offset(0, 8),
                ),
              ],
            ),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceEvenly,
              children: List.generate(items.length, (index) {
                final item = items[index];
                final isSelected = index == currentIndex;

                return Expanded(
                  child: GestureDetector(
                    onTap: () {
                      HapticFeedback.selectionClick();
                      onTap(index);
                    },
                    child: AnimatedContainer(
                      duration: PsychologyAnimations.quick,
                      padding: EdgeInsets.symmetric(
                        vertical: isExpanded ? 12 : 8,
                      ),
                      decoration: BoxDecoration(
                        color: isSelected
                            ? PsychologyColors.primary.withValues(alpha: 0.15)
                            : Colors.transparent,
                        borderRadius: BorderRadius.circular(isExpanded ? 16 : 12),
                      ),
                      child: Column(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          Icon(
                            isSelected ? item.activeIcon : item.icon,
                            size: isExpanded ? 24 : 20,
                            color: isSelected
                                ? PsychologyColors.primary
                                : PsychologyColors.textTertiary,
                          ),
                          if (isExpanded && isSelected) ...[
                            const SizedBox(height: 4),
                            Text(
                              item.label,
                              style: PsychologyTypography.labelSmall.copyWith(
                                color: PsychologyColors.primary,
                                fontWeight: FontWeight.w600,
                              ),
                            ),
                          ],
                        ],
                      ),
                    ),
                  ),
                );
              }),
            ),
          ),
        ),
      ),
    );
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// WIDGET 8: QUICK ACTION BUTTON
// ═══════════════════════════════════════════════════════════════════════════

/// FAB-style quick action button
class PremiumQuickActionButton extends StatefulWidget {
  final IconData icon;
  final String label;
  final Color color;
  final VoidCallback onTap;

  const PremiumQuickActionButton({
    super.key,
    required this.icon,
    required this.label,
    required this.color,
    required this.onTap,
  });

  @override
  State<PremiumQuickActionButton> createState() => _PremiumQuickActionButtonState();
}

class _PremiumQuickActionButtonState extends State<PremiumQuickActionButton>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _scaleAnimation;
  bool _isPressed = false;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: PsychologyAnimations.quick,
    );
    _scaleAnimation = Tween<double>(begin: 1.0, end: 0.92).animate(
      CurvedAnimation(parent: _controller, curve: PsychologyAnimations.standardCurve),
    );
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: _scaleAnimation,
      builder: (context, child) {
        return Transform.scale(
          scale: _scaleAnimation.value,
          child: GestureDetector(
            onTapDown: (_) {
              setState(() => _isPressed = true);
              _controller.forward();
            },
            onTapUp: (_) {
              setState(() => _isPressed = false);
              _controller.reverse();
            },
            onTapCancel: () {
              setState(() => _isPressed = false);
              _controller.reverse();
            },
            onTap: () {
              HapticFeedback.mediumImpact();
              widget.onTap();
            },
            child: Container(
              padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 14),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: [
                    widget.color,
                    Color.lerp(widget.color, Colors.black, 0.2)!,
                  ],
                ),
                borderRadius: BorderRadius.circular(PsychologyRadius.lg),
                boxShadow: [
                  // Color glow
                  BoxShadow(
                    color: widget.color.withValues(alpha: 0.4),
                    blurRadius: 20,
                    offset: const Offset(0, 8),
                  ),
                  // Depth shadow
                  BoxShadow(
                    color: Colors.black.withValues(alpha: 0.3),
                    blurRadius: 12,
                    offset: const Offset(0, 4),
                  ),
                ],
              ),
              child: Row(
                mainAxisSize: MainAxisSize.min,
                children: [
                  Icon(widget.icon, size: 20, color: Colors.white),
                  const SizedBox(width: 8),
                  Text(
                    widget.label,
                    style: PsychologyTypography.labelLarge.copyWith(
                      color: Colors.white,
                    ),
                  ),
                ],
              ),
            ),
          ),
        );
      },
    );
  }
}


--- FILE: lib/core/theme/premium_effects.dart ---

import 'dart:math' as math;
import 'dart:ui';
import 'package:flutter/material.dart';

/// Premium UI Effects - Figma Design System
/// Glassmorphism, glow effects, animations

// ===========================================
// PREMIUM COLORS
// ===========================================

class PremiumColors {
  PremiumColors._();

  /// Ana arka plan - koyu mor (siyah değil!)
  static const Color background = Color(0xFF0D0B14);

  /// Kart arka planı
  static const Color cardBackground = Color(0xFF1A1625);

  /// Yükseltilmiş yüzey
  static const Color surfaceElevated = Color(0xFF2D2440);

  /// Mor tonları
  static const Color purple = Color(0xFF8B5CF6);
  static const Color purpleLight = Color(0xFFA78BFA);
  static const Color purpleDark = Color(0xFF6D28D9);

  /// Gradient renkleri
  static const Color gradientStart = Color(0xFF8B5CF6);
  static const Color gradientEnd = Color(0xFF06B6D4);
}

// ===========================================
// PREMIUM DECORATIONS
// ===========================================

class PremiumDecorations {
  PremiumDecorations._();

  /// Glass Card - Blur + gradient border
  static BoxDecoration glassCard({
    double borderRadius = 16,
    Color? borderColor,
  }) {
    return BoxDecoration(
      color: Colors.white.withValues(alpha: 0.08),
      borderRadius: BorderRadius.circular(borderRadius),
      border: Border.all(
        color: borderColor ?? Colors.white.withValues(alpha: 0.12),
        width: 1,
      ),
    );
  }

  /// Glass Card with gradient border
  static BoxDecoration glassCardGradient({double borderRadius = 16}) {
    return BoxDecoration(
      color: Colors.white.withValues(alpha: 0.08),
      borderRadius: BorderRadius.circular(borderRadius),
      gradient: LinearGradient(
        begin: Alignment.topLeft,
        end: Alignment.bottomRight,
        colors: [
          Colors.white.withValues(alpha: 0.15),
          Colors.white.withValues(alpha: 0.05),
        ],
      ),
    );
  }
}

// ===========================================
// PREMIUM SHADOWS
// ===========================================

class PremiumShadows {
  PremiumShadows._();

  /// Purple glow - intense (Design System: opacity 0.4, blur 24px)
  static List<BoxShadow> glowPurple = [
    BoxShadow(
      color: PremiumColors.purple.withValues(alpha: 0.4),
      blurRadius: 24,
      spreadRadius: 2,
    ),
    BoxShadow(
      color: PremiumColors.purple.withValues(alpha: 0.2),
      blurRadius: 48,
      spreadRadius: 0,
    ),
  ];

  /// Purple glow - soft
  static List<BoxShadow> glowPurpleSoft = [
    BoxShadow(
      color: PremiumColors.purple.withValues(alpha: 0.3),
      blurRadius: 32,
      spreadRadius: 0,
    ),
  ];

  /// Premium shadow - subtle
  static List<BoxShadow> shadowPremium = [
    BoxShadow(
      color: Colors.black.withValues(alpha: 0.5),
      blurRadius: 12,
      offset: const Offset(0, 4),
    ),
    BoxShadow(
      color: Colors.black.withValues(alpha: 0.3),
      blurRadius: 40,
      offset: const Offset(0, 12),
    ),
  ];

  /// Premium shadow - floating effect (Design System: enhanced)
  static List<BoxShadow> shadowPremiumFloat = [
    BoxShadow(
      color: Colors.black.withValues(alpha: 0.4),
      blurRadius: 16,
      offset: const Offset(0, 6),
    ),
    BoxShadow(
      color: Colors.black.withValues(alpha: 0.25),
      blurRadius: 48,
      offset: const Offset(0, 16),
    ),
    BoxShadow(
      color: PremiumColors.purple.withValues(alpha: 0.3),
      blurRadius: 24,
      spreadRadius: 0,
    ),
  ];

  /// Icon halo - drop shadow for icons (Design System: enhanced)
  static List<Shadow> iconHalo(Color color) {
    return [
      Shadow(color: color.withValues(alpha: 0.6), blurRadius: 16),
      Shadow(color: color.withValues(alpha: 0.4), blurRadius: 32),
    ];
  }

  /// Colored glow (Design System: intensity boosted)
  static List<BoxShadow> coloredGlow(Color color, {double intensity = 1.0}) {
    return [
      BoxShadow(
        color: color.withValues(alpha: 0.5 * intensity),
        blurRadius: 24,
        spreadRadius: 2,
      ),
      BoxShadow(
        color: color.withValues(alpha: 0.3 * intensity),
        blurRadius: 48,
        spreadRadius: 0,
      ),
    ];
  }
}

// ===========================================
// GRADIENT BORDER
// ===========================================

class GradientBorder extends StatelessWidget {
  final Widget child;
  final double borderWidth;
  final double borderRadius;
  final Gradient? gradient;

  const GradientBorder({
    super.key,
    required this.child,
    this.borderWidth = 1.5,
    this.borderRadius = 16,
    this.gradient,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(borderRadius),
        gradient:
            gradient ??
            LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: [
                Colors.white.withValues(alpha: 0.2),
                PremiumColors.purple.withValues(alpha: 0.3),
                Colors.white.withValues(alpha: 0.1),
              ],
            ),
      ),
      child: Padding(
        padding: EdgeInsets.all(borderWidth),
        child: Container(
          decoration: BoxDecoration(
            color: PremiumColors.cardBackground,
            borderRadius: BorderRadius.circular(borderRadius - borderWidth),
          ),
          child: child,
        ),
      ),
    );
  }
}

// ===========================================
// GLASS CARD WIDGET
// ===========================================

/// Glass Card Widget - Design System Compliant
/// Theme-aware: adapts to light/dark mode
class GlassCard extends StatelessWidget {
  final Widget child;
  final double borderRadius;
  final EdgeInsets? padding;
  final double blur;
  final Color? backgroundColor;
  final Gradient? backgroundGradient;
  final bool showBorder;
  final List<BoxShadow>? boxShadow;

  const GlassCard({
    super.key,
    required this.child,
    this.borderRadius = 20,
    this.padding,
    this.blur = 25,
    this.backgroundColor,
    this.backgroundGradient,
    this.showBorder = true,
    this.boxShadow,
  });

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final defaultBgColor = isDark
        ? const Color(0xFF2D1B4E).withValues(alpha: 0.6)
        : const Color(0xFFFFFFFF).withValues(alpha: 0.9);
    final borderColor = isDark
        ? Colors.white.withValues(alpha: 0.2)
        : Colors.black.withValues(alpha: 0.1);

    return ClipRRect(
      borderRadius: BorderRadius.circular(borderRadius),
      child: BackdropFilter(
        filter: ImageFilter.blur(sigmaX: blur, sigmaY: blur),
        child: Container(
          padding: padding ?? const EdgeInsets.all(20),
          decoration: BoxDecoration(
            color: backgroundGradient == null
                ? (backgroundColor ?? defaultBgColor)
                : null,
            gradient: backgroundGradient,
            borderRadius: BorderRadius.circular(borderRadius),
            border: showBorder
                ? Border.all(color: borderColor, width: 1.5)
                : null,
            boxShadow: boxShadow,
          ),
          child: child,
        ),
      ),
    );
  }
}

// ===========================================
// SHIMMER EFFECT
// ===========================================

class ShimmerEffect extends StatefulWidget {
  final Widget child;
  final Duration duration;
  final Color shimmerColor;
  final double shimmerWidth;

  const ShimmerEffect({
    super.key,
    required this.child,
    this.duration = const Duration(milliseconds: 2000),
    this.shimmerColor = Colors.white,
    this.shimmerWidth = 0.3,
  });

  @override
  State<ShimmerEffect> createState() => _ShimmerEffectState();
}

class _ShimmerEffectState extends State<ShimmerEffect>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(vsync: this, duration: widget.duration)
      ..repeat();
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: _controller,
      builder: (context, child) {
        return ShaderMask(
          shaderCallback: (bounds) {
            return LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: [
                Colors.transparent,
                widget.shimmerColor.withValues(alpha: 0.3),
                Colors.transparent,
              ],
              stops: [
                (_controller.value - widget.shimmerWidth).clamp(0.0, 1.0),
                _controller.value,
                (_controller.value + widget.shimmerWidth).clamp(0.0, 1.0),
              ],
              transform: GradientRotation(math.pi / 4),
            ).createShader(bounds);
          },
          blendMode: BlendMode.srcATop,
          child: widget.child,
        );
      },
      child: widget.child,
    );
  }
}

// ===========================================
// BREATHE GLOW - Pulse Animation
// ===========================================

/// Breathe Glow - Design System: Enhanced pulse animation
class BreatheGlow extends StatefulWidget {
  final Widget child;
  final Color glowColor;
  final double minOpacity;
  final double maxOpacity;
  final Duration duration;
  final double blurRadius;

  const BreatheGlow({
    super.key,
    required this.child,
    this.glowColor = PremiumColors.purple,
    this.minOpacity = 0.3,
    this.maxOpacity = 0.6,
    this.duration = const Duration(milliseconds: 2500),
    this.blurRadius = 40,
  });

  @override
  State<BreatheGlow> createState() => _BreatheGlowState();
}

class _BreatheGlowState extends State<BreatheGlow>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _animation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(vsync: this, duration: widget.duration)
      ..repeat(reverse: true);

    _animation = Tween<double>(
      begin: widget.minOpacity,
      end: widget.maxOpacity,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeInOut));
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: _animation,
      builder: (context, child) {
        return Container(
          decoration: BoxDecoration(
            boxShadow: [
              BoxShadow(
                color: widget.glowColor.withValues(alpha: _animation.value),
                blurRadius: widget.blurRadius,
                spreadRadius: 0,
              ),
            ],
          ),
          child: widget.child,
        );
      },
    );
  }
}

// ===========================================
// SPARKLE FLOAT - Float + Scale Animation
// ===========================================

class SparkleFloat extends StatefulWidget {
  final Widget child;
  final double floatHeight;
  final double scaleRange;
  final Duration duration;

  const SparkleFloat({
    super.key,
    required this.child,
    this.floatHeight = 8,
    this.scaleRange = 0.05,
    this.duration = const Duration(seconds: 2),
  });

  @override
  State<SparkleFloat> createState() => _SparkleFloatState();
}

class _SparkleFloatState extends State<SparkleFloat>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _floatAnimation;
  late Animation<double> _scaleAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(vsync: this, duration: widget.duration)
      ..repeat(reverse: true);

    _floatAnimation = Tween<double>(
      begin: 0,
      end: -widget.floatHeight,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeInOut));

    _scaleAnimation = Tween<double>(
      begin: 1.0,
      end: 1.0 + widget.scaleRange,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeInOut));
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: _controller,
      builder: (context, child) {
        return Transform.translate(
          offset: Offset(0, _floatAnimation.value),
          child: Transform.scale(
            scale: _scaleAnimation.value,
            child: widget.child,
          ),
        );
      },
    );
  }
}

// ===========================================
// ROTATING GRADIENT BORDER - For Avatar
// ===========================================

class RotatingGradientBorder extends StatefulWidget {
  final Widget child;
  final double borderWidth;
  final double size;
  final Duration duration;
  final List<Color>? colors;

  const RotatingGradientBorder({
    super.key,
    required this.child,
    this.borderWidth = 3,
    this.size = 48,
    this.duration = const Duration(seconds: 3),
    this.colors,
  });

  @override
  State<RotatingGradientBorder> createState() => _RotatingGradientBorderState();
}

class _RotatingGradientBorderState extends State<RotatingGradientBorder>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(vsync: this, duration: widget.duration)
      ..repeat();
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: _controller,
      builder: (context, child) {
        return Container(
          width: widget.size,
          height: widget.size,
          decoration: BoxDecoration(
            shape: BoxShape.circle,
            gradient: SweepGradient(
              transform: GradientRotation(_controller.value * 2 * math.pi),
              colors:
                  widget.colors ??
                  [
                    PremiumColors.purple,
                    PremiumColors.gradientEnd,
                    PremiumColors.purpleLight,
                    PremiumColors.purple,
                  ],
            ),
          ),
          child: Padding(
            padding: EdgeInsets.all(widget.borderWidth),
            child: Container(
              decoration: const BoxDecoration(
                shape: BoxShape.circle,
                color: PremiumColors.cardBackground,
              ),
              child: widget.child,
            ),
          ),
        );
      },
    );
  }
}

// ===========================================
// PREMIUM BUTTON
// ===========================================

class PremiumButton extends StatefulWidget {
  final Widget child;
  final VoidCallback? onTap;
  final bool showShimmer;
  final bool showGlow;
  final double borderRadius;
  final EdgeInsets? padding;

  const PremiumButton({
    super.key,
    required this.child,
    this.onTap,
    this.showShimmer = true,
    this.showGlow = false,
    this.borderRadius = 12,
    this.padding,
  });

  @override
  State<PremiumButton> createState() => _PremiumButtonState();
}

class _PremiumButtonState extends State<PremiumButton>
    with SingleTickerProviderStateMixin {
  late AnimationController _scaleController;
  late Animation<double> _scaleAnimation;

  @override
  void initState() {
    super.initState();
    _scaleController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 100),
    );
    _scaleAnimation = Tween<double>(begin: 1.0, end: 0.95).animate(
      CurvedAnimation(parent: _scaleController, curve: Curves.easeInOut),
    );
  }

  @override
  void dispose() {
    _scaleController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    Widget button = GestureDetector(
      onTapDown: (_) => _scaleController.forward(),
      onTapUp: (_) {
        _scaleController.reverse();
        widget.onTap?.call();
      },
      onTapCancel: () => _scaleController.reverse(),
      child: AnimatedBuilder(
        animation: _scaleAnimation,
        builder: (context, child) {
          return Transform.scale(
            scale: _scaleAnimation.value,
            child: Container(
              padding: widget.padding ?? const EdgeInsets.all(16),
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(widget.borderRadius),
                color: Colors.white.withValues(alpha: 0.08),
                border: Border.all(
                  color: Colors.white.withValues(alpha: 0.12),
                  width: 1,
                ),
                boxShadow: widget.showGlow
                    ? PremiumShadows.glowPurple
                    : PremiumShadows.shadowPremium,
              ),
              child: widget.child,
            ),
          );
        },
      ),
    );

    if (widget.showShimmer) {
      button = ShimmerEffect(child: button);
    }

    return button;
  }
}

// ===========================================
// LEVEL PROGRESS BAR
// ===========================================

class LevelProgressBar extends StatelessWidget {
  final double progress; // 0.0 - 1.0
  final double height;
  final bool showShimmer;

  const LevelProgressBar({
    super.key,
    required this.progress,
    this.height = 8,
    this.showShimmer = true,
  });

  @override
  Widget build(BuildContext context) {
    final clampedProgress = progress.clamp(0.0, 1.0);

    Widget bar = Container(
      height: height,
      decoration: BoxDecoration(
        color: Colors.white.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(height / 2),
      ),
      child: Stack(
        children: [
          // Progress fill
          FractionallySizedBox(
            widthFactor: clampedProgress,
            child: BreatheGlow(
              glowColor: PremiumColors.purple,
              blurRadius: 15,
              minOpacity: 0.3,
              maxOpacity: 0.6,
              child: Container(
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(height / 2),
                  gradient: const LinearGradient(
                    colors: [
                      PremiumColors.purpleDark,
                      PremiumColors.purple,
                      PremiumColors.purpleLight,
                    ],
                  ),
                ),
              ),
            ),
          ),
        ],
      ),
    );

    if (showShimmer) {
      bar = ShimmerEffect(child: bar);
    }

    return bar;
  }
}

// ===========================================
// SMART BADGE
// ===========================================

class SmartBadge extends StatelessWidget {
  final String text;
  final bool showShimmer;

  const SmartBadge({super.key, this.text = 'Smart', this.showShimmer = true});

  @override
  Widget build(BuildContext context) {
    Widget badge = Container(
      padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(8),
        gradient: const LinearGradient(
          colors: [PremiumColors.purple, PremiumColors.gradientEnd],
        ),
        boxShadow: [
          BoxShadow(
            color: PremiumColors.purple.withValues(alpha: 0.4),
            blurRadius: 8,
            spreadRadius: 0,
          ),
        ],
      ),
      child: Text(
        text,
        style: const TextStyle(
          color: Colors.white,
          fontSize: 10,
          fontWeight: FontWeight.w600,
        ),
      ),
    );

    if (showShimmer) {
      return ShimmerEffect(
        duration: const Duration(milliseconds: 2500),
        child: badge,
      );
    }

    return badge;
  }
}

// ===========================================
// RADIAL GRADIENT OVERLAY
// ===========================================

class RadialGradientOverlay extends StatelessWidget {
  final Widget child;
  final Color? centerColor;
  final double radius;

  const RadialGradientOverlay({
    super.key,
    required this.child,
    this.centerColor,
    this.radius = 0.8,
  });

  @override
  Widget build(BuildContext context) {
    return Stack(
      children: [
        child,
        Positioned.fill(
          child: IgnorePointer(
            child: Container(
              decoration: BoxDecoration(
                gradient: RadialGradient(
                  center: Alignment.center,
                  radius: radius,
                  colors: [
                    (centerColor ?? PremiumColors.purple).withValues(
                      alpha: 0.15,
                    ),
                    Colors.transparent,
                  ],
                ),
              ),
            ),
          ),
        ),
      ],
    );
  }
}

// ===========================================
// ANIMATED COUNT-UP
// ===========================================

/// Count-up animation for numbers
/// Duration: 800ms, Curve: easeOutCubic
class AnimatedCountUp extends StatelessWidget {
  final double value;
  final double? previousValue;
  final Duration duration;
  final Curve curve;
  final TextStyle? style;
  final String Function(double value)? formatter;

  const AnimatedCountUp({
    super.key,
    required this.value,
    this.previousValue,
    this.duration = const Duration(milliseconds: 800),
    this.curve = Curves.easeOutCubic,
    this.style,
    this.formatter,
  });

  @override
  Widget build(BuildContext context) {
    return TweenAnimationBuilder<double>(
      tween: Tween<double>(begin: previousValue ?? 0, end: value),
      duration: duration,
      curve: curve,
      builder: (context, animatedValue, child) {
        final displayValue = formatter != null
            ? formatter!(animatedValue)
            : animatedValue.toStringAsFixed(0);
        return Text(displayValue, style: style);
      },
    );
  }
}

// ===========================================
// ANIMATED PROGRESS BAR
// ===========================================

/// Animated progress bar with delay support
/// Duration: 600ms, Delay: customizable
class AnimatedProgressBar extends StatefulWidget {
  final double progress;
  final double height;
  final Color? backgroundColor;
  final Color? progressColor;
  final Gradient? progressGradient;
  final Duration duration;
  final Duration delay;
  final Curve curve;
  final BorderRadius? borderRadius;
  final List<BoxShadow>? boxShadow;

  const AnimatedProgressBar({
    super.key,
    required this.progress,
    this.height = 8,
    this.backgroundColor,
    this.progressColor,
    this.progressGradient,
    this.duration = const Duration(milliseconds: 600),
    this.delay = Duration.zero,
    this.curve = Curves.easeOutCubic,
    this.borderRadius,
    this.boxShadow,
  });

  @override
  State<AnimatedProgressBar> createState() => _AnimatedProgressBarState();
}

class _AnimatedProgressBarState extends State<AnimatedProgressBar>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _animation;
  bool _started = false;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(duration: widget.duration, vsync: this);
    _animation = CurvedAnimation(parent: _controller, curve: widget.curve);

    // Start after delay
    Future.delayed(widget.delay, () {
      if (mounted) {
        _started = true;
        _controller.forward();
      }
    });
  }

  @override
  void didUpdateWidget(AnimatedProgressBar oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (oldWidget.progress != widget.progress && _started) {
      _controller.forward(from: 0);
    }
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final radius =
        widget.borderRadius ?? BorderRadius.circular(widget.height / 2);

    return AnimatedBuilder(
      animation: _animation,
      builder: (context, child) {
        final animatedProgress = widget.progress * _animation.value;

        return Container(
          height: widget.height,
          decoration: BoxDecoration(
            color:
                widget.backgroundColor ?? Colors.white.withValues(alpha: 0.1),
            borderRadius: radius,
          ),
          child: Stack(
            children: [
              FractionallySizedBox(
                widthFactor: animatedProgress.clamp(0.0, 1.0),
                child: Container(
                  decoration: BoxDecoration(
                    color: widget.progressGradient == null
                        ? (widget.progressColor ?? PremiumColors.purple)
                        : null,
                    gradient: widget.progressGradient,
                    borderRadius: radius,
                    boxShadow: widget.boxShadow,
                  ),
                ),
              ),
            ],
          ),
        );
      },
    );
  }
}

// ===========================================
// STAGGERED SLIDE-UP ANIMATION
// ===========================================

/// Slide-up + fade-in animation for cards
/// Duration: 400ms, Stagger: 100ms per item
class StaggeredSlideUp extends StatefulWidget {
  final Widget child;
  final int index;
  final Duration duration;
  final Duration staggerDelay;
  final double slideOffset;
  final Curve curve;
  final bool animate;

  const StaggeredSlideUp({
    super.key,
    required this.child,
    required this.index,
    this.duration = const Duration(milliseconds: 400),
    this.staggerDelay = const Duration(milliseconds: 100),
    this.slideOffset = 30,
    this.curve = Curves.easeOutCubic,
    this.animate = true,
  });

  @override
  State<StaggeredSlideUp> createState() => _StaggeredSlideUpState();
}

class _StaggeredSlideUpState extends State<StaggeredSlideUp>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _slideAnimation;
  late Animation<double> _fadeAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(duration: widget.duration, vsync: this);

    _slideAnimation = Tween<double>(
      begin: widget.slideOffset,
      end: 0,
    ).animate(CurvedAnimation(parent: _controller, curve: widget.curve));

    _fadeAnimation = Tween<double>(
      begin: 0,
      end: 1,
    ).animate(CurvedAnimation(parent: _controller, curve: widget.curve));

    if (widget.animate) {
      final delay = widget.staggerDelay * widget.index;
      Future.delayed(delay, () {
        if (mounted) _controller.forward();
      });
    } else {
      _controller.value = 1.0;
    }
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: _controller,
      builder: (context, child) {
        return Transform.translate(
          offset: Offset(0, _slideAnimation.value),
          child: Opacity(opacity: _fadeAnimation.value, child: widget.child),
        );
      },
    );
  }
}

// ===========================================
// SCALE FADE ANIMATION
// ===========================================

/// Scale + fade animation for badges/achievements
class ScaleFadeIn extends StatefulWidget {
  final Widget child;
  final int index;
  final Duration duration;
  final Duration staggerDelay;
  final double startScale;
  final Curve curve;
  final bool animate;

  const ScaleFadeIn({
    super.key,
    required this.child,
    this.index = 0,
    this.duration = const Duration(milliseconds: 400),
    this.staggerDelay = const Duration(milliseconds: 80),
    this.startScale = 0.8,
    this.curve = Curves.easeOutBack,
    this.animate = true,
  });

  @override
  State<ScaleFadeIn> createState() => _ScaleFadeInState();
}

class _ScaleFadeInState extends State<ScaleFadeIn>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _scaleAnimation;
  late Animation<double> _fadeAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(duration: widget.duration, vsync: this);

    _scaleAnimation = Tween<double>(
      begin: widget.startScale,
      end: 1.0,
    ).animate(CurvedAnimation(parent: _controller, curve: widget.curve));

    _fadeAnimation = Tween<double>(
      begin: 0,
      end: 1,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeOut));

    if (widget.animate) {
      final delay = widget.staggerDelay * widget.index;
      Future.delayed(delay, () {
        if (mounted) _controller.forward();
      });
    } else {
      _controller.value = 1.0;
    }
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: _controller,
      builder: (context, child) {
        return Transform.scale(
          scale: _scaleAnimation.value,
          child: Opacity(opacity: _fadeAnimation.value, child: widget.child),
        );
      },
    );
  }
}

// ===========================================
// PULSE GLOW ANIMATION
// ===========================================

/// Pulse glow effect for unlocked items
class PulseGlow extends StatefulWidget {
  final Widget child;
  final Color glowColor;
  final double maxBlurRadius;
  final Duration duration;
  final bool animate;

  const PulseGlow({
    super.key,
    required this.child,
    this.glowColor = PremiumColors.purple,
    this.maxBlurRadius = 20,
    this.duration = const Duration(milliseconds: 1500),
    this.animate = true,
  });

  @override
  State<PulseGlow> createState() => _PulseGlowState();
}

class _PulseGlowState extends State<PulseGlow>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _animation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(duration: widget.duration, vsync: this);

    _animation = Tween<double>(
      begin: 0,
      end: 1,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeInOut));

    if (widget.animate) {
      _controller.repeat(reverse: true);
    }
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    if (!widget.animate) return widget.child;

    return AnimatedBuilder(
      animation: _animation,
      builder: (context, child) {
        return Container(
          decoration: BoxDecoration(
            boxShadow: [
              BoxShadow(
                color: widget.glowColor.withValues(
                  alpha: 0.3 * _animation.value,
                ),
                blurRadius: widget.maxBlurRadius * _animation.value,
                spreadRadius: 2 * _animation.value,
              ),
            ],
          ),
          child: widget.child,
        );
      },
    );
  }
}

// ===========================================
// PAGE TRANSITION WRAPPER
// ===========================================

// ===========================================
// FROSTED GLASS CONTAINER
// ===========================================

/// Frosted glass effect with customizable blur and tint
class FrostedGlass extends StatelessWidget {
  final Widget child;
  final double blur;
  final Color tint;
  final double tintOpacity;
  final double borderRadius;
  final EdgeInsets? padding;
  final EdgeInsets? margin;

  const FrostedGlass({
    super.key,
    required this.child,
    this.blur = 10,
    this.tint = Colors.white,
    this.tintOpacity = 0.1,
    this.borderRadius = 16,
    this.padding,
    this.margin,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      margin: margin,
      child: ClipRRect(
        borderRadius: BorderRadius.circular(borderRadius),
        child: BackdropFilter(
          filter: ImageFilter.blur(sigmaX: blur, sigmaY: blur),
          child: Container(
            padding: padding,
            decoration: BoxDecoration(
              color: tint.withValues(alpha: tintOpacity),
              borderRadius: BorderRadius.circular(borderRadius),
            ),
            child: child,
          ),
        ),
      ),
    );
  }
}

// ===========================================
// GLASS MODAL BOTTOM SHEET
// ===========================================

/// Glass-styled modal bottom sheet wrapper
class GlassModalSheet extends StatelessWidget {
  final Widget child;
  final double blur;
  final Color backgroundColor;
  final double topRadius;
  final EdgeInsets? padding;

  const GlassModalSheet({
    super.key,
    required this.child,
    this.blur = 20,
    this.backgroundColor = const Color(0xFF1A1625),
    this.topRadius = 24,
    this.padding,
  });

  @override
  Widget build(BuildContext context) {
    return ClipRRect(
      borderRadius: BorderRadius.vertical(top: Radius.circular(topRadius)),
      child: BackdropFilter(
        filter: ImageFilter.blur(sigmaX: blur, sigmaY: blur),
        child: Container(
          padding: padding,
          decoration: BoxDecoration(
            color: backgroundColor.withValues(alpha: 0.95),
            borderRadius: BorderRadius.vertical(
              top: Radius.circular(topRadius),
            ),
            border: Border(
              top: BorderSide(
                color: Colors.white.withValues(alpha: 0.1),
                width: 1,
              ),
            ),
          ),
          child: child,
        ),
      ),
    );
  }
}

// ===========================================
// GLASS BUTTON
// ===========================================

/// Glass-styled button with blur effect
class GlassButton extends StatefulWidget {
  final Widget child;
  final VoidCallback? onTap;
  final double blur;
  final double borderRadius;
  final EdgeInsets? padding;
  final Color? backgroundColor;
  final Color? borderColor;
  final List<BoxShadow>? boxShadow;

  const GlassButton({
    super.key,
    required this.child,
    this.onTap,
    this.blur = 10,
    this.borderRadius = 12,
    this.padding,
    this.backgroundColor,
    this.borderColor,
    this.boxShadow,
  });

  @override
  State<GlassButton> createState() => _GlassButtonState();
}

class _GlassButtonState extends State<GlassButton>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _scaleAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 100),
    );
    _scaleAnimation = Tween<double>(
      begin: 1.0,
      end: 0.96,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeInOut));
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTapDown: (_) => _controller.forward(),
      onTapUp: (_) {
        _controller.reverse();
        widget.onTap?.call();
      },
      onTapCancel: () => _controller.reverse(),
      child: AnimatedBuilder(
        animation: _scaleAnimation,
        builder: (context, child) {
          return Transform.scale(
            scale: _scaleAnimation.value,
            child: ClipRRect(
              borderRadius: BorderRadius.circular(widget.borderRadius),
              child: BackdropFilter(
                filter: ImageFilter.blur(
                  sigmaX: widget.blur,
                  sigmaY: widget.blur,
                ),
                child: Container(
                  padding:
                      widget.padding ??
                      const EdgeInsets.symmetric(horizontal: 20, vertical: 12),
                  decoration: BoxDecoration(
                    color:
                        widget.backgroundColor ??
                        Colors.white.withValues(alpha: 0.1),
                    borderRadius: BorderRadius.circular(widget.borderRadius),
                    border: Border.all(
                      color:
                          widget.borderColor ??
                          Colors.white.withValues(alpha: 0.2),
                      width: 1,
                    ),
                    boxShadow: widget.boxShadow,
                  ),
                  child: widget.child,
                ),
              ),
            ),
          );
        },
      ),
    );
  }
}

// ===========================================
// GLASS CHIP
// ===========================================

/// Glass-styled chip/tag
class GlassChip extends StatelessWidget {
  final String label;
  final IconData? icon;
  final Color? iconColor;
  final VoidCallback? onTap;
  final bool selected;
  final double blur;

  const GlassChip({
    super.key,
    required this.label,
    this.icon,
    this.iconColor,
    this.onTap,
    this.selected = false,
    this.blur = 8,
  });

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: ClipRRect(
        borderRadius: BorderRadius.circular(20),
        child: BackdropFilter(
          filter: ImageFilter.blur(sigmaX: blur, sigmaY: blur),
          child: Container(
            padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
            decoration: BoxDecoration(
              color: selected
                  ? PremiumColors.purple.withValues(alpha: 0.3)
                  : Colors.white.withValues(alpha: 0.1),
              borderRadius: BorderRadius.circular(20),
              border: Border.all(
                color: selected
                    ? PremiumColors.purple.withValues(alpha: 0.5)
                    : Colors.white.withValues(alpha: 0.15),
                width: 1,
              ),
            ),
            child: Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                if (icon != null) ...[
                  Icon(icon, size: 16, color: iconColor ?? Colors.white70),
                  const SizedBox(width: 6),
                ],
                Text(
                  label,
                  style: TextStyle(
                    color: selected ? Colors.white : Colors.white70,
                    fontSize: 13,
                    fontWeight: selected ? FontWeight.w600 : FontWeight.w500,
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

// ===========================================
// NEON GLOW TEXT
// ===========================================

/// Text with neon glow effect
class NeonText extends StatelessWidget {
  final String text;
  final TextStyle? style;
  final Color glowColor;
  final double blurRadius;

  const NeonText({
    super.key,
    required this.text,
    this.style,
    this.glowColor = PremiumColors.purple,
    this.blurRadius = 10,
  });

  @override
  Widget build(BuildContext context) {
    return Stack(
      children: [
        // Glow layer
        Text(
          text,
          style: (style ?? const TextStyle()).copyWith(
            foreground: Paint()
              ..color = glowColor
              ..maskFilter = MaskFilter.blur(BlurStyle.normal, blurRadius),
          ),
        ),
        // Main text
        Text(text, style: style),
      ],
    );
  }
}

// ===========================================
// GLASS DIVIDER
// ===========================================

/// Frosted glass styled divider
class GlassDivider extends StatelessWidget {
  final double height;
  final double indent;
  final double endIndent;
  final Color? color;

  const GlassDivider({
    super.key,
    this.height = 1,
    this.indent = 0,
    this.endIndent = 0,
    this.color,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      margin: EdgeInsets.only(left: indent, right: endIndent),
      height: height,
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [
            Colors.transparent,
            (color ?? Colors.white).withValues(alpha: 0.2),
            Colors.transparent,
          ],
        ),
      ),
    );
  }
}

// ===========================================
// PAGE TRANSITION WRAPPER
// ===========================================

/// Wrapper to trigger animations on page change
class AnimatedPageContent extends StatefulWidget {
  final Widget child;
  final bool shouldAnimate;
  final VoidCallback? onAnimationComplete;

  const AnimatedPageContent({
    super.key,
    required this.child,
    this.shouldAnimate = true,
    this.onAnimationComplete,
  });

  @override
  State<AnimatedPageContent> createState() => AnimatedPageContentState();
}

class AnimatedPageContentState extends State<AnimatedPageContent> {
  Key _contentKey = UniqueKey();

  /// Call this to replay animations (e.g., on pull-to-refresh)
  void replayAnimations() {
    setState(() {
      _contentKey = UniqueKey();
    });
  }

  @override
  Widget build(BuildContext context) {
    return KeyedSubtree(key: _contentKey, child: widget.child);
  }
}


--- FILE: lib/core/theme/liquid_glass.dart ---

// iOS 26 Liquid Glass Design System for Vantag
// Advanced optical physics with real glass simulation

import 'dart:ui';
import 'dart:math' as math;
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';

// ═══════════════════════════════════════════════════════════════
// COLORS
// ═══════════════════════════════════════════════════════════════

class LiquidGlassColors {
  LiquidGlassColors._();

  // Primary
  static const Color primary = Color(0xFF8B5CF6);
  static const Color primaryLight = Color(0xFFA78BFA);
  static const Color primaryDark = Color(0xFF7C3AED);

  // Secondary
  static const Color secondary = Color(0xFF06B6D4);
  static const Color secondaryLight = Color(0xFF22D3EE);
  static const Color secondaryDark = Color(0xFF0891B2);

  // Backgrounds
  static const Color background = Color(0xFF0A0A0F);
  static const Color surface = Color(0xFF12101A);
  static const Color surfaceElevated = Color(0xFF1A1725);
  static const Color surfaceOverlay = Color(0xFF231F2E);

  // Glass
  static const Color glassBackground = Color(0x0AFFFFFF);
  static const Color glassBorder = Color(0x15FFFFFF);
  static const Color glassHighlight = Color(0x25FFFFFF);

  // Semantic
  static const Color success = Color(0xFF10B981);
  static const Color warning = Color(0xFFF59E0B);
  static const Color error = Color(0xFFEF4444);
  static const Color info = Color(0xFF3B82F6);

  // Text
  static const Color textPrimary = Color(0xFFFAFAFA);
  static const Color textSecondary = Color(0xFFA1A1AA);
  static const Color textTertiary = Color(0xFF71717A);

  // Decision
  static const Color decisionYes = Color(0xFFF87171);
  static const Color decisionThinking = Color(0xFFFBBF24);
  static const Color decisionNo = Color(0xFF06B6D4);
}

// ═══════════════════════════════════════════════════════════════
// GRADIENTS
// ═══════════════════════════════════════════════════════════════

class LiquidGlassGradients {
  LiquidGlassGradients._();

  static const LinearGradient primaryGradient = LinearGradient(
    begin: Alignment.topLeft,
    end: Alignment.bottomRight,
    colors: [
      LiquidGlassColors.primary,
      LiquidGlassColors.secondary,
    ],
  );

  static const LinearGradient glassGradient = LinearGradient(
    begin: Alignment.topLeft,
    end: Alignment.bottomRight,
    colors: [
      Color(0x1FFFFFFF), // 12% white
      Color(0x0DFFFFFF), // 5% white
    ],
  );

  static const LinearGradient highlightGradient = LinearGradient(
    begin: Alignment.centerLeft,
    end: Alignment.centerRight,
    colors: [
      Colors.transparent,
      Color(0x14FFFFFF), // 8% white
      Colors.transparent,
    ],
  );

  static const LinearGradient luminanceGradient = LinearGradient(
    begin: Alignment.topLeft,
    end: Alignment.bottomRight,
    colors: [
      Color(0x33FFFFFF), // 20% white
      Colors.transparent,
    ],
    stops: [0.0, 0.6],
  );

  static Gradient dynamicLuminanceGradient(Offset lightPosition) {
    return RadialGradient(
      center: Alignment(
        (lightPosition.dx * 2) - 1,
        (lightPosition.dy * 2) - 1,
      ),
      radius: 1.2,
      colors: const [
        Color(0x33FFFFFF),
        Colors.transparent,
      ],
      stops: const [0.0, 0.7],
    );
  }

  static const LinearGradient dividerGradient = LinearGradient(
    colors: [
      Colors.transparent,
      Color(0x26FFFFFF), // 15% white
      Colors.transparent,
    ],
  );

  static SweepGradient activeBorderGradient({double rotation = 0}) {
    return SweepGradient(
      startAngle: rotation,
      endAngle: rotation + math.pi * 2,
      colors: const [
        Color(0x26FFFFFF), // 15% white - top left
        Color(0x08FFFFFF), // 3% white
        Color(0x05FFFFFF), // 2% white - bottom right
        Color(0x08FFFFFF), // 3% white
        Color(0x26FFFFFF), // 15% white - back to start
      ],
      stops: const [0.0, 0.25, 0.5, 0.75, 1.0],
    );
  }
}

// ═══════════════════════════════════════════════════════════════
// SHADOWS
// ═══════════════════════════════════════════════════════════════

class LiquidGlassShadows {
  LiquidGlassShadows._();

  // Macro shadow - depth and glow
  static List<BoxShadow> macroShadow({Color? glowColor, double intensity = 0.15}) {
    final color = glowColor ?? LiquidGlassColors.primary;
    return [
      BoxShadow(
        color: color.withValues(alpha: intensity),
        blurRadius: 30,
        offset: const Offset(0, 10),
        spreadRadius: 0,
      ),
    ];
  }

  // Micro shadow - grounding
  static const List<BoxShadow> microShadow = [
    BoxShadow(
      color: Color(0x66000000), // 40% black
      blurRadius: 2,
      offset: Offset(0, 1),
      spreadRadius: 0,
    ),
  ];

  // Glow shadow - inner light emission
  static List<BoxShadow> glowShadow({Color? color, double intensity = 0.3}) {
    return [
      BoxShadow(
        color: (color ?? LiquidGlassColors.primary).withValues(alpha: intensity),
        blurRadius: 20,
        spreadRadius: -5,
      ),
    ];
  }

  // Combined dual shadow system
  static List<BoxShadow> dualShadow({Color? glowColor, double glowIntensity = 0.15}) {
    return [
      ...macroShadow(glowColor: glowColor, intensity: glowIntensity),
      ...microShadow,
    ];
  }

  // Text glow for high balances
  static List<Shadow> textGlow({Color? color, double blur = 8}) {
    return [
      Shadow(
        color: (color ?? LiquidGlassColors.primary).withValues(alpha: 0.3),
        blurRadius: blur,
      ),
    ];
  }
}

// ═══════════════════════════════════════════════════════════════
// TYPOGRAPHY
// ═══════════════════════════════════════════════════════════════

class LiquidGlassTypography {
  LiquidGlassTypography._();

  static const TextStyle display = TextStyle(
    fontSize: 42,
    fontWeight: FontWeight.w800,
    letterSpacing: -0.84, // -0.02em
    color: LiquidGlassColors.textPrimary,
    height: 1.1,
  );

  static const TextStyle headline = TextStyle(
    fontSize: 28,
    fontWeight: FontWeight.w700,
    letterSpacing: -0.56, // -0.02em
    color: LiquidGlassColors.textPrimary,
    height: 1.2,
  );

  static const TextStyle title = TextStyle(
    fontSize: 20,
    fontWeight: FontWeight.w600,
    letterSpacing: -0.4, // -0.02em
    color: LiquidGlassColors.textPrimary,
    height: 1.3,
  );

  static const TextStyle body = TextStyle(
    fontSize: 15,
    fontWeight: FontWeight.w400,
    letterSpacing: 0,
    color: LiquidGlassColors.textPrimary,
    height: 1.5,
  );

  static const TextStyle caption = TextStyle(
    fontSize: 12,
    fontWeight: FontWeight.w500,
    letterSpacing: 0.5,
    color: LiquidGlassColors.textSecondary,
    height: 1.4,
  );

  static const TextStyle mono = TextStyle(
    fontSize: 15,
    fontWeight: FontWeight.w500,
    letterSpacing: 0,
    color: LiquidGlassColors.textPrimary,
    fontFeatures: [FontFeature.tabularFigures()],
    height: 1.5,
  );

  // High balance text with glow
  static TextStyle displayWithGlow({Color? glowColor}) {
    return display.copyWith(
      shadows: LiquidGlassShadows.textGlow(color: glowColor),
    );
  }

  static TextStyle headlineWithGlow({Color? glowColor}) {
    return headline.copyWith(
      shadows: LiquidGlassShadows.textGlow(color: glowColor),
    );
  }
}

// ═══════════════════════════════════════════════════════════════
// ACOUSTIC UI - Haptic Patterns
// ═══════════════════════════════════════════════════════════════

class LiquidGlassHaptics {
  LiquidGlassHaptics._();

  static void cardTap() => HapticFeedback.lightImpact();
  static void buttonPress() => HapticFeedback.mediumImpact();
  static void selection() => HapticFeedback.selectionClick();
  static void success() => HapticFeedback.heavyImpact();
  static void error() => HapticFeedback.vibrate();
}

// ═══════════════════════════════════════════════════════════════
// LIQUID GLASS CARD - Premium Widget with Optical Physics
// ═══════════════════════════════════════════════════════════════

class LiquidGlassCard extends StatefulWidget {
  final Widget child;
  final double? width;
  final double? height;
  final EdgeInsetsGeometry? padding;
  final EdgeInsetsGeometry? margin;
  final BorderRadius? borderRadius;
  final VoidCallback? onTap;
  final bool enableLightTracking;
  final bool enableShimmer;
  final bool enableVariableBlur;
  final Color? glowColor;
  final double blurSigma;

  const LiquidGlassCard({
    super.key,
    required this.child,
    this.width,
    this.height,
    this.padding,
    this.margin,
    this.borderRadius,
    this.onTap,
    this.enableLightTracking = true,
    this.enableShimmer = true,
    this.enableVariableBlur = false,
    this.glowColor,
    this.blurSigma = 20,
  });

  @override
  State<LiquidGlassCard> createState() => _LiquidGlassCardState();
}

class _LiquidGlassCardState extends State<LiquidGlassCard>
    with TickerProviderStateMixin {
  late AnimationController _shimmerController;
  late AnimationController _tapController;
  late Animation<double> _scaleAnimation;
  late Animation<double> _glowAnimation;

  Offset _lightPosition = const Offset(0.3, 0.3);

  @override
  void initState() {
    super.initState();

    // Shimmer animation - 3.5 seconds sweep
    _shimmerController = AnimationController(
      duration: const Duration(milliseconds: 3500),
      vsync: this,
    );
    if (widget.enableShimmer) {
      _shimmerController.repeat();
    }

    // Tap animation
    _tapController = AnimationController(
      duration: const Duration(milliseconds: 150),
      vsync: this,
    );

    _scaleAnimation = Tween<double>(begin: 1.0, end: 0.96).animate(
      CurvedAnimation(parent: _tapController, curve: Curves.easeOutCubic),
    );

    _glowAnimation = Tween<double>(begin: 0.15, end: 0.30).animate(
      CurvedAnimation(parent: _tapController, curve: Curves.easeOutCubic),
    );
  }

  @override
  void dispose() {
    _shimmerController.dispose();
    _tapController.dispose();
    super.dispose();
  }

  void _onTapDown(TapDownDetails details) {
    _tapController.forward();
    LiquidGlassHaptics.cardTap();

    if (widget.enableLightTracking) {
      final RenderBox box = context.findRenderObject() as RenderBox;
      final localPosition = details.localPosition;
      setState(() {
        _lightPosition = Offset(
          localPosition.dx / box.size.width,
          localPosition.dy / box.size.height,
        );
      });
    }
  }

  void _onTapUp(TapUpDetails details) {
    _tapController.reverse();
    widget.onTap?.call();
  }

  void _onTapCancel() {
    _tapController.reverse();
  }

  @override
  Widget build(BuildContext context) {
    final radius = widget.borderRadius ?? BorderRadius.circular(24);

    return AnimatedBuilder(
      animation: Listenable.merge([_shimmerController, _tapController]),
      builder: (context, child) {
        return Transform.scale(
          scale: _scaleAnimation.value,
          child: Container(
            width: widget.width,
            height: widget.height,
            margin: widget.margin,
            decoration: BoxDecoration(
              borderRadius: radius,
              boxShadow: LiquidGlassShadows.dualShadow(
                glowColor: widget.glowColor ?? LiquidGlassColors.primary,
                glowIntensity: _glowAnimation.value,
              ),
            ),
            child: GestureDetector(
              onTapDown: _onTapDown,
              onTapUp: _onTapUp,
              onTapCancel: _onTapCancel,
              child: ClipRRect(
                borderRadius: radius,
                child: Stack(
                  children: [
                    // Layer 1: Variable blur or standard blur
                    if (widget.enableVariableBlur)
                      _buildVariableBlur(radius)
                    else
                      _buildStandardBlur(),

                    // Layer 2: Glass gradient background
                    Container(
                      decoration: BoxDecoration(
                        gradient: LiquidGlassGradients.glassGradient,
                        borderRadius: radius,
                      ),
                    ),

                    // Layer 3: Dynamic luminance (light source)
                    Container(
                      decoration: BoxDecoration(
                        gradient: LiquidGlassGradients.dynamicLuminanceGradient(
                          _lightPosition,
                        ),
                        borderRadius: radius,
                      ),
                    ),

                    // Layer 4: Specular highlights (micro shimmer)
                    if (widget.enableShimmer) _buildSpecularHighlights(),

                    // Layer 5: Animated highlight sweep
                    if (widget.enableShimmer) _buildAnimatedHighlight(radius),

                    // Layer 6: Active border with sweep gradient
                    _buildActiveBorder(radius),

                    // Layer 7: Content
                    Padding(
                      padding: widget.padding ?? const EdgeInsets.all(20),
                      child: widget.child,
                    ),
                  ],
                ),
              ),
            ),
          ),
        );
      },
    );
  }

  Widget _buildStandardBlur() {
    return BackdropFilter(
      filter: ImageFilter.blur(
        sigmaX: widget.blurSigma,
        sigmaY: widget.blurSigma,
      ),
      child: Container(color: Colors.transparent),
    );
  }

  Widget _buildVariableBlur(BorderRadius radius) {
    return Stack(
      children: [
        // Top section - less blur (sigma 15)
        ClipRect(
          child: Align(
            alignment: Alignment.topCenter,
            heightFactor: 0.5,
            child: BackdropFilter(
              filter: ImageFilter.blur(sigmaX: 15, sigmaY: 15),
              child: Container(color: Colors.transparent),
            ),
          ),
        ),
        // Bottom section - more blur (sigma 25)
        ClipRect(
          child: Align(
            alignment: Alignment.bottomCenter,
            heightFactor: 0.5,
            child: BackdropFilter(
              filter: ImageFilter.blur(sigmaX: 25, sigmaY: 25),
              child: Container(color: Colors.transparent),
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildSpecularHighlights() {
    return Positioned.fill(
      child: CustomPaint(
        painter: _SpecularHighlightPainter(
          seed: _shimmerController.value,
        ),
      ),
    );
  }

  Widget _buildAnimatedHighlight(BorderRadius radius) {
    final sweepPosition = _shimmerController.value;
    return Positioned.fill(
      child: ShaderMask(
        shaderCallback: (bounds) {
          return LinearGradient(
            begin: Alignment(-1 + (sweepPosition * 3), 0),
            end: Alignment(-0.5 + (sweepPosition * 3), 0),
            colors: const [
              Colors.transparent,
              Color(0x20FFFFFF),
              Colors.transparent,
            ],
          ).createShader(bounds);
        },
        blendMode: BlendMode.srcOver,
        child: Container(
          decoration: BoxDecoration(
            borderRadius: radius,
            color: Colors.white,
          ),
        ),
      ),
    );
  }

  Widget _buildActiveBorder(BorderRadius radius) {
    return Positioned.fill(
      child: Container(
        decoration: BoxDecoration(
          borderRadius: radius,
          border: Border.all(
            color: Colors.transparent,
            width: 1.5,
          ),
        ),
        foregroundDecoration: BoxDecoration(
          borderRadius: radius,
          border: GradientBorder(
            gradient: LiquidGlassGradients.activeBorderGradient(
              rotation: _shimmerController.value * math.pi * 2,
            ),
            width: 1.5,
          ),
        ),
      ),
    );
  }
}

// Custom painter for specular highlights
class _SpecularHighlightPainter extends CustomPainter {
  final double seed;
  final math.Random _random = math.Random(42);

  _SpecularHighlightPainter({required this.seed});

  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()
      ..color = const Color(0x08FFFFFF)
      ..style = PaintingStyle.fill;

    // Generate subtle noise-like highlights
    for (int i = 0; i < 15; i++) {
      final x = _random.nextDouble() * size.width;
      final y = _random.nextDouble() * size.height;
      final radius = _random.nextDouble() * 30 + 10;
      final opacity = (_random.nextDouble() * 0.03 + 0.01) *
          (1 + math.sin(seed * math.pi * 2 + i) * 0.3);

      canvas.drawCircle(
        Offset(x, y),
        radius,
        paint..color = Color.fromRGBO(255, 255, 255, opacity),
      );
    }
  }

  @override
  bool shouldRepaint(_SpecularHighlightPainter oldDelegate) {
    return oldDelegate.seed != seed;
  }
}

// Gradient border decoration
class GradientBorder extends BoxBorder {
  final Gradient gradient;
  final double width;

  const GradientBorder({
    required this.gradient,
    required this.width,
  });

  @override
  BorderSide get top => BorderSide.none;
  @override
  BorderSide get bottom => BorderSide.none;
  @override
  bool get isUniform => true;

  @override
  void paint(
    Canvas canvas,
    Rect rect, {
    TextDirection? textDirection,
    BoxShape shape = BoxShape.rectangle,
    BorderRadius? borderRadius,
  }) {
    final paint = Paint()
      ..shader = gradient.createShader(rect)
      ..style = PaintingStyle.stroke
      ..strokeWidth = width;

    if (borderRadius != null) {
      canvas.drawRRect(
        borderRadius.toRRect(rect).deflate(width / 2),
        paint,
      );
    } else {
      canvas.drawRect(rect.deflate(width / 2), paint);
    }
  }

  @override
  ShapeBorder scale(double t) => this;

  @override
  EdgeInsetsGeometry get dimensions => EdgeInsets.all(width);
}

// ═══════════════════════════════════════════════════════════════
// LIQUID GLASS BUTTON
// ═══════════════════════════════════════════════════════════════

class LiquidGlassButton extends StatefulWidget {
  final Widget child;
  final VoidCallback? onPressed;
  final double? width;
  final double? height;
  final EdgeInsetsGeometry? padding;
  final BorderRadius? borderRadius;
  final Color? glowColor;
  final bool isLoading;

  const LiquidGlassButton({
    super.key,
    required this.child,
    this.onPressed,
    this.width,
    this.height,
    this.padding,
    this.borderRadius,
    this.glowColor,
    this.isLoading = false,
  });

  @override
  State<LiquidGlassButton> createState() => _LiquidGlassButtonState();
}

class _LiquidGlassButtonState extends State<LiquidGlassButton>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _scaleAnimation;
  late Animation<double> _glowAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      duration: const Duration(milliseconds: 200),
      vsync: this,
    );

    // Spring-like animation with damping 15, stiffness 150
    _scaleAnimation = Tween<double>(begin: 1.0, end: 0.96).animate(
      CurvedAnimation(
        parent: _controller,
        curve: const _SpringCurve(damping: 15, stiffness: 150),
      ),
    );

    _glowAnimation = Tween<double>(begin: 0.1, end: 0.25).animate(
      CurvedAnimation(parent: _controller, curve: Curves.easeOut),
    );
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  void _onTapDown(TapDownDetails details) {
    _controller.forward();
    LiquidGlassHaptics.buttonPress();
  }

  void _onTapUp(TapUpDetails details) {
    _controller.reverse();
    widget.onPressed?.call();
  }

  void _onTapCancel() {
    _controller.reverse();
  }

  @override
  Widget build(BuildContext context) {
    final radius = widget.borderRadius ?? BorderRadius.circular(16);
    final glowColor = widget.glowColor ?? LiquidGlassColors.primary;

    return AnimatedBuilder(
      animation: _controller,
      builder: (context, child) {
        return Transform.scale(
          scale: _scaleAnimation.value,
          child: GestureDetector(
            onTapDown: widget.onPressed != null ? _onTapDown : null,
            onTapUp: widget.onPressed != null ? _onTapUp : null,
            onTapCancel: widget.onPressed != null ? _onTapCancel : null,
            child: Container(
              width: widget.width,
              height: widget.height ?? 56,
              decoration: BoxDecoration(
                borderRadius: radius,
                boxShadow: [
                  BoxShadow(
                    color: glowColor.withValues(alpha: _glowAnimation.value),
                    blurRadius: 20,
                    spreadRadius: -2,
                  ),
                  ...LiquidGlassShadows.microShadow,
                ],
              ),
              child: ClipRRect(
                borderRadius: radius,
                child: BackdropFilter(
                  filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
                  child: Container(
                    decoration: BoxDecoration(
                      gradient: LiquidGlassGradients.glassGradient,
                      borderRadius: radius,
                      border: Border.all(
                        color: LiquidGlassColors.glassBorder,
                        width: 1,
                      ),
                    ),
                    padding: widget.padding ??
                        const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
                    child: Center(
                      child: widget.isLoading
                          ? SizedBox(
                              width: 20,
                              height: 20,
                              child: CircularProgressIndicator(
                                strokeWidth: 2,
                                valueColor: AlwaysStoppedAnimation<Color>(
                                  LiquidGlassColors.textPrimary,
                                ),
                              ),
                            )
                          : widget.child,
                    ),
                  ),
                ),
              ),
            ),
          ),
        );
      },
    );
  }
}

// Custom spring curve
class _SpringCurve extends Curve {
  final double damping;
  final double stiffness;

  const _SpringCurve({
    required this.damping,
    required this.stiffness,
  });

  @override
  double transformInternal(double t) {
    final omega = math.sqrt(stiffness);
    final zeta = damping / (2 * math.sqrt(stiffness));

    if (zeta < 1) {
      // Underdamped
      final omegaD = omega * math.sqrt(1 - zeta * zeta);
      return 1 -
          math.exp(-zeta * omega * t) *
              (math.cos(omegaD * t) +
                  (zeta * omega / omegaD) * math.sin(omegaD * t));
    } else {
      // Critically damped or overdamped
      return 1 - (1 + omega * t) * math.exp(-omega * t);
    }
  }
}

// ═══════════════════════════════════════════════════════════════
// LIQUID GLASS CONTAINER - Lightweight
// ═══════════════════════════════════════════════════════════════

class LiquidGlassContainer extends StatelessWidget {
  final Widget child;
  final double? width;
  final double? height;
  final EdgeInsetsGeometry? padding;
  final EdgeInsetsGeometry? margin;
  final BorderRadius? borderRadius;
  final double blurSigma;
  final Color? backgroundColor;
  final Color? borderColor;

  const LiquidGlassContainer({
    super.key,
    required this.child,
    this.width,
    this.height,
    this.padding,
    this.margin,
    this.borderRadius,
    this.blurSigma = 15,
    this.backgroundColor,
    this.borderColor,
  });

  @override
  Widget build(BuildContext context) {
    final radius = borderRadius ?? BorderRadius.circular(20);

    return Container(
      width: width,
      height: height,
      margin: margin,
      child: ClipRRect(
        borderRadius: radius,
        child: BackdropFilter(
          filter: ImageFilter.blur(sigmaX: blurSigma, sigmaY: blurSigma),
          child: Container(
            decoration: BoxDecoration(
              color: backgroundColor ?? LiquidGlassColors.glassBackground,
              borderRadius: radius,
              border: Border.all(
                color: borderColor ?? LiquidGlassColors.glassBorder,
                width: 1,
              ),
            ),
            padding: padding ?? const EdgeInsets.all(16),
            child: child,
          ),
        ),
      ),
    );
  }
}

// ═══════════════════════════════════════════════════════════════
// LIQUID GLASS CHIP - Selectable Tag
// ═══════════════════════════════════════════════════════════════

class LiquidGlassChip extends StatelessWidget {
  final String label;
  final bool isSelected;
  final VoidCallback? onTap;
  final IconData? icon;
  final Color? selectedColor;

  const LiquidGlassChip({
    super.key,
    required this.label,
    this.isSelected = false,
    this.onTap,
    this.icon,
    this.selectedColor,
  });

  @override
  Widget build(BuildContext context) {
    final color = selectedColor ?? LiquidGlassColors.primary;

    return GestureDetector(
      onTap: () {
        LiquidGlassHaptics.selection();
        onTap?.call();
      },
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        curve: Curves.easeOutCubic,
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
        decoration: BoxDecoration(
          color: isSelected ? color.withValues(alpha: 0.2) : Colors.transparent,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(
            color: isSelected ? color : LiquidGlassColors.glassBorder,
            width: 1,
          ),
          boxShadow: isSelected
              ? [
                  BoxShadow(
                    color: color.withValues(alpha: 0.2),
                    blurRadius: 12,
                    spreadRadius: -2,
                  ),
                ]
              : null,
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            if (icon != null) ...[
              Icon(
                icon,
                size: 16,
                color: isSelected ? color : LiquidGlassColors.textSecondary,
              ),
              const SizedBox(width: 6),
            ],
            Text(
              label,
              style: LiquidGlassTypography.caption.copyWith(
                color: isSelected ? color : LiquidGlassColors.textSecondary,
                fontWeight: isSelected ? FontWeight.w600 : FontWeight.w500,
              ),
            ),
          ],
        ),
      ),
    );
  }
}

// ═══════════════════════════════════════════════════════════════
// LIQUID GLASS DIVIDER
// ═══════════════════════════════════════════════════════════════

class LiquidGlassDivider extends StatelessWidget {
  final double? width;
  final EdgeInsetsGeometry? margin;

  const LiquidGlassDivider({
    super.key,
    this.width,
    this.margin,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      width: width,
      height: 1,
      margin: margin ?? const EdgeInsets.symmetric(vertical: 16),
      decoration: const BoxDecoration(
        gradient: LiquidGlassGradients.dividerGradient,
      ),
    );
  }
}

// ═══════════════════════════════════════════════════════════════
// LIQUID GLASS TEXT FIELD
// ═══════════════════════════════════════════════════════════════

class LiquidGlassTextField extends StatefulWidget {
  final TextEditingController? controller;
  final String? hintText;
  final String? labelText;
  final IconData? prefixIcon;
  final IconData? suffixIcon;
  final VoidCallback? onSuffixTap;
  final ValueChanged<String>? onChanged;
  final ValueChanged<String>? onSubmitted;
  final TextInputType? keyboardType;
  final bool obscureText;
  final int? maxLines;
  final FocusNode? focusNode;
  final bool autofocus;

  const LiquidGlassTextField({
    super.key,
    this.controller,
    this.hintText,
    this.labelText,
    this.prefixIcon,
    this.suffixIcon,
    this.onSuffixTap,
    this.onChanged,
    this.onSubmitted,
    this.keyboardType,
    this.obscureText = false,
    this.maxLines = 1,
    this.focusNode,
    this.autofocus = false,
  });

  @override
  State<LiquidGlassTextField> createState() => _LiquidGlassTextFieldState();
}

class _LiquidGlassTextFieldState extends State<LiquidGlassTextField> {
  late FocusNode _focusNode;
  bool _isFocused = false;

  @override
  void initState() {
    super.initState();
    _focusNode = widget.focusNode ?? FocusNode();
    _focusNode.addListener(_onFocusChange);
  }

  @override
  void dispose() {
    if (widget.focusNode == null) {
      _focusNode.dispose();
    }
    super.dispose();
  }

  void _onFocusChange() {
    setState(() {
      _isFocused = _focusNode.hasFocus;
    });
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedContainer(
      duration: const Duration(milliseconds: 200),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(16),
        color: LiquidGlassColors.glassBackground,
        border: Border.all(
          color: _isFocused
              ? LiquidGlassColors.primary.withValues(alpha: 0.5)
              : LiquidGlassColors.glassBorder,
          width: _isFocused ? 1.5 : 1,
        ),
        boxShadow: _isFocused
            ? [
                BoxShadow(
                  color: LiquidGlassColors.primary.withValues(alpha: 0.15),
                  blurRadius: 12,
                  spreadRadius: -2,
                ),
              ]
            : null,
      ),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(16),
        child: BackdropFilter(
          filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
          child: TextField(
            controller: widget.controller,
            focusNode: _focusNode,
            autofocus: widget.autofocus,
            keyboardType: widget.keyboardType,
            obscureText: widget.obscureText,
            maxLines: widget.maxLines,
            onChanged: widget.onChanged,
            onSubmitted: widget.onSubmitted,
            style: LiquidGlassTypography.body,
            cursorColor: LiquidGlassColors.primary,
            decoration: InputDecoration(
              hintText: widget.hintText,
              labelText: widget.labelText,
              hintStyle: LiquidGlassTypography.body.copyWith(
                color: LiquidGlassColors.textTertiary,
              ),
              labelStyle: LiquidGlassTypography.caption.copyWith(
                color: _isFocused
                    ? LiquidGlassColors.primary
                    : LiquidGlassColors.textSecondary,
              ),
              prefixIcon: widget.prefixIcon != null
                  ? Icon(
                      widget.prefixIcon,
                      color: _isFocused
                          ? LiquidGlassColors.primary
                          : LiquidGlassColors.textTertiary,
                      size: 20,
                    )
                  : null,
              suffixIcon: widget.suffixIcon != null
                  ? GestureDetector(
                      onTap: widget.onSuffixTap,
                      child: Icon(
                        widget.suffixIcon,
                        color: LiquidGlassColors.textTertiary,
                        size: 20,
                      ),
                    )
                  : null,
              border: InputBorder.none,
              contentPadding: const EdgeInsets.symmetric(
                horizontal: 16,
                vertical: 16,
              ),
            ),
          ),
        ),
      ),
    );
  }
}

// ═══════════════════════════════════════════════════════════════
// EXTENSIONS
// ═══════════════════════════════════════════════════════════════

extension LiquidGlassContext on BuildContext {
  // Access to liquid glass design tokens
  Color get liquidPrimary => LiquidGlassColors.primary;
  Color get liquidBackground => LiquidGlassColors.background;
  Color get liquidSurface => LiquidGlassColors.surface;
  Color get liquidTextPrimary => LiquidGlassColors.textPrimary;
  Color get liquidTextSecondary => LiquidGlassColors.textSecondary;
}

// ═══════════════════════════════════════════════════════════════
// ANIMATED BUILDER WRAPPER (to avoid name collision)
// ═══════════════════════════════════════════════════════════════

class AnimatedBuilder extends StatelessWidget {
  final Listenable animation;
  final Widget Function(BuildContext context, Widget? child) builder;
  final Widget? child;

  const AnimatedBuilder({
    super.key,
    required this.animation,
    required this.builder,
    this.child,
  });

  @override
  Widget build(BuildContext context) {
    return ListenableBuilder(
      listenable: animation,
      builder: builder,
      child: child,
    );
  }
}


--- FILE: lib/core/theme/psychology_effects.dart ---

import 'dart:math' as math;
import 'dart:ui';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'psychology_design_system.dart';

/// ═══════════════════════════════════════════════════════════════════════════
/// PSYCHOLOGY EFFECTS - Glow, Shimmer, Confetti, Celebrations
/// Apple Liquid Glass + Dopamine Triggers
/// ═══════════════════════════════════════════════════════════════════════════

// ═══════════════════════════════════════════════════════════════════════════
// BREATHING GLOW EFFECT
// ═══════════════════════════════════════════════════════════════════════════

/// Animated breathing glow effect widget
/// Creates a pulsing glow around content for emphasis
class BreathingGlow extends StatefulWidget {
  final Widget child;
  final Color glowColor;
  final double blurRadius;
  final double minOpacity;
  final double maxOpacity;
  final Duration duration;
  final bool enabled;

  const BreathingGlow({
    super.key,
    required this.child,
    this.glowColor = PsychologyColors.primary,
    this.blurRadius = 24,
    this.minOpacity = 0.15,
    this.maxOpacity = 0.45,
    this.duration = const Duration(milliseconds: 3000),
    this.enabled = true,
  });

  @override
  State<BreathingGlow> createState() => _BreathingGlowState();
}

class _BreathingGlowState extends State<BreathingGlow>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _animation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: widget.duration,
    );

    _animation = Tween<double>(
      begin: widget.minOpacity,
      end: widget.maxOpacity,
    ).animate(CurvedAnimation(
      parent: _controller,
      curve: PsychologyAnimations.smooth,
    ));

    if (widget.enabled) {
      _controller.repeat(reverse: true);
    }
  }

  @override
  void didUpdateWidget(BreathingGlow oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (widget.enabled != oldWidget.enabled) {
      if (widget.enabled) {
        _controller.repeat(reverse: true);
      } else {
        _controller.stop();
      }
    }
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    if (!widget.enabled) {
      return widget.child;
    }

    return AnimatedBuilder(
      animation: _animation,
      builder: (context, child) {
        return Container(
          decoration: BoxDecoration(
            boxShadow: [
              BoxShadow(
                color: widget.glowColor.withValues(alpha: _animation.value),
                blurRadius: widget.blurRadius,
                spreadRadius: -4,
              ),
            ],
          ),
          child: widget.child,
        );
      },
    );
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// PULSE GLOW EFFECT (for warnings)
// ═══════════════════════════════════════════════════════════════════════════

/// Fast pulsing glow for urgent states (budget warning, etc.)
class PulseGlow extends StatefulWidget {
  final Widget child;
  final Color glowColor;
  final double blurRadius;
  final Duration duration;
  final bool enabled;

  const PulseGlow({
    super.key,
    required this.child,
    this.glowColor = PsychologyColors.warning,
    this.blurRadius = 20,
    this.duration = const Duration(milliseconds: 1500),
    this.enabled = true,
  });

  @override
  State<PulseGlow> createState() => _PulseGlowState();
}

class _PulseGlowState extends State<PulseGlow>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _animation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: widget.duration,
    );

    _animation = Tween<double>(begin: 0.2, end: 0.6).animate(
      CurvedAnimation(parent: _controller, curve: Curves.easeInOut),
    );

    if (widget.enabled) {
      _controller.repeat(reverse: true);
    }
  }

  @override
  void didUpdateWidget(PulseGlow oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (widget.enabled && !_controller.isAnimating) {
      _controller.repeat(reverse: true);
    } else if (!widget.enabled && _controller.isAnimating) {
      _controller.stop();
    }
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    if (!widget.enabled) return widget.child;

    return AnimatedBuilder(
      animation: _animation,
      builder: (context, child) {
        return Container(
          decoration: BoxDecoration(
            boxShadow: [
              BoxShadow(
                color: widget.glowColor.withValues(alpha: _animation.value),
                blurRadius: widget.blurRadius,
                spreadRadius: -2,
              ),
            ],
          ),
          child: widget.child,
        );
      },
    );
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// SHIMMER EFFECT
// ═══════════════════════════════════════════════════════════════════════════

/// Shimmer loading effect
class PsychologyShimmer extends StatefulWidget {
  final Widget child;
  final bool isLoading;
  final Color baseColor;
  final Color highlightColor;
  final Duration duration;

  const PsychologyShimmer({
    super.key,
    required this.child,
    this.isLoading = true,
    this.baseColor = PsychologyColors.surface,
    this.highlightColor = PsychologyColors.surfaceElevated,
    this.duration = const Duration(milliseconds: 1500),
  });

  @override
  State<PsychologyShimmer> createState() => _PsychologyShimmerState();
}

class _PsychologyShimmerState extends State<PsychologyShimmer>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _animation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: widget.duration,
    );

    _animation = Tween<double>(begin: -1.0, end: 2.0).animate(
      CurvedAnimation(parent: _controller, curve: Curves.linear),
    );

    if (widget.isLoading) {
      _controller.repeat();
    }
  }

  @override
  void didUpdateWidget(PsychologyShimmer oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (widget.isLoading && !_controller.isAnimating) {
      _controller.repeat();
    } else if (!widget.isLoading && _controller.isAnimating) {
      _controller.stop();
    }
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    if (!widget.isLoading) return widget.child;

    return AnimatedBuilder(
      animation: _animation,
      builder: (context, child) {
        return ShaderMask(
          shaderCallback: (bounds) {
            return LinearGradient(
              begin: Alignment.centerLeft,
              end: Alignment.centerRight,
              colors: [
                widget.baseColor,
                widget.highlightColor,
                widget.baseColor,
              ],
              stops: const [0.0, 0.5, 1.0],
              transform: _SlidingGradientTransform(_animation.value),
            ).createShader(bounds);
          },
          blendMode: BlendMode.srcATop,
          child: widget.child,
        );
      },
    );
  }
}

class _SlidingGradientTransform extends GradientTransform {
  final double slidePercent;

  const _SlidingGradientTransform(this.slidePercent);

  @override
  Matrix4? transform(Rect bounds, {TextDirection? textDirection}) {
    return Matrix4.translationValues(bounds.width * slidePercent, 0.0, 0.0);
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// SHIMMER TEXT EFFECT
// ═══════════════════════════════════════════════════════════════════════════

/// Shimmer effect specifically for text highlights
class ShimmerText extends StatefulWidget {
  final Widget child;
  final Duration duration;
  final bool enabled;

  const ShimmerText({
    super.key,
    required this.child,
    this.duration = const Duration(milliseconds: 2500),
    this.enabled = true,
  });

  @override
  State<ShimmerText> createState() => _ShimmerTextState();
}

class _ShimmerTextState extends State<ShimmerText>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: widget.duration,
    );

    if (widget.enabled) {
      _controller.repeat();
    }
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    if (!widget.enabled) return widget.child;

    return AnimatedBuilder(
      animation: _controller,
      builder: (context, child) {
        return ShaderMask(
          shaderCallback: (bounds) {
            return LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: const [
                Colors.white,
                Color(0xFFE8E8FF),
                Colors.white,
              ],
              stops: [
                _controller.value - 0.3,
                _controller.value,
                _controller.value + 0.3,
              ].map((s) => s.clamp(0.0, 1.0)).toList(),
            ).createShader(bounds);
          },
          blendMode: BlendMode.srcIn,
          child: widget.child,
        );
      },
    );
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// GLASS CARD WRAPPER
// ═══════════════════════════════════════════════════════════════════════════

/// Premium glass card with optional breathing glow
class PsychologyGlassCard extends StatefulWidget {
  final Widget child;
  final EdgeInsets? padding;
  final Color? glowColor;
  final double glowIntensity;
  final bool enableBreathing;
  final VoidCallback? onTap;
  final BorderRadius? borderRadius;
  final double blurSigma;
  final LinearGradient? customGradient;

  const PsychologyGlassCard({
    super.key,
    required this.child,
    this.padding,
    this.glowColor,
    this.glowIntensity = 0.2,
    this.enableBreathing = false,
    this.onTap,
    this.borderRadius,
    this.blurSigma = 24,
    this.customGradient,
  });

  @override
  State<PsychologyGlassCard> createState() => _PsychologyGlassCardState();
}

class _PsychologyGlassCardState extends State<PsychologyGlassCard>
    with TickerProviderStateMixin {
  late AnimationController _breathingController;
  late AnimationController _pressController;
  late Animation<double> _breathingAnimation;
  late Animation<double> _scaleAnimation;
  bool _isPressed = false;

  @override
  void initState() {
    super.initState();

    // Breathing glow
    _breathingController = AnimationController(
      vsync: this,
      duration: PsychologyAnimations.breathingCycle,
    );
    _breathingAnimation = Tween<double>(
      begin: PsychologyAnimations.glowMin,
      end: PsychologyAnimations.glowMax,
    ).animate(CurvedAnimation(
      parent: _breathingController,
      curve: PsychologyAnimations.smooth,
    ));

    if (widget.enableBreathing && widget.glowColor != null) {
      _breathingController.repeat(reverse: true);
    }

    // Press scale
    _pressController = AnimationController(
      vsync: this,
      duration: PsychologyAnimations.quick,
    );
    _scaleAnimation = Tween<double>(
      begin: 1.0,
      end: PsychologyAnimations.cardPressScale,
    ).animate(CurvedAnimation(
      parent: _pressController,
      curve: PsychologyAnimations.standardCurve,
    ));
  }

  @override
  void dispose() {
    _breathingController.dispose();
    _pressController.dispose();
    super.dispose();
  }

  void _handleTapDown(TapDownDetails details) {
    if (widget.onTap == null) return;
    setState(() => _isPressed = true);
    _pressController.forward();
    HapticFeedback.lightImpact();
  }

  void _handleTapUp(TapUpDetails details) {
    if (widget.onTap == null) return;
    setState(() => _isPressed = false);
    _pressController.reverse();
  }

  void _handleTapCancel() {
    if (widget.onTap == null) return;
    setState(() => _isPressed = false);
    _pressController.reverse();
  }

  @override
  Widget build(BuildContext context) {
    final borderRadius = widget.borderRadius ?? PsychologyRadius.card;
    final effectiveGlowColor = widget.glowColor ?? PsychologyColors.primary;

    Widget content = AnimatedBuilder(
      animation: Listenable.merge([_breathingAnimation, _scaleAnimation]),
      builder: (context, child) {
        final glowOpacity = widget.enableBreathing
            ? _breathingAnimation.value
            : widget.glowIntensity;

        return Transform.scale(
          scale: _scaleAnimation.value,
          child: Container(
            decoration: BoxDecoration(
              borderRadius: borderRadius,
              boxShadow: widget.glowColor != null
                  ? [
                      BoxShadow(
                        color: effectiveGlowColor.withValues(alpha: glowOpacity),
                        blurRadius: 32,
                        spreadRadius: -4,
                      ),
                      BoxShadow(
                        color: Colors.black.withValues(alpha: 0.25),
                        blurRadius: 16,
                        offset: const Offset(0, 8),
                      ),
                    ]
                  : PsychologyShadows.card,
            ),
            child: ClipRRect(
              borderRadius: borderRadius,
              child: BackdropFilter(
                filter: ImageFilter.blur(
                  sigmaX: widget.blurSigma,
                  sigmaY: widget.blurSigma,
                ),
                child: Container(
                  decoration: BoxDecoration(
                    gradient: widget.customGradient ??
                        (widget.glowColor != null
                            ? PsychologyGlass.gradient(effectiveGlowColor)
                            : LinearGradient(
                                begin: Alignment.topLeft,
                                end: Alignment.bottomRight,
                                colors: [
                                  Colors.white.withValues(alpha: 0.08),
                                  Colors.white.withValues(alpha: 0.04),
                                ],
                              )),
                    borderRadius: borderRadius,
                    border: Border.all(
                      color: Colors.white.withValues(
                        alpha: _isPressed ? 0.15 : PsychologyGlass.borderOpacity,
                      ),
                      width: 1,
                    ),
                  ),
                  child: Stack(
                    children: [
                      // Top highlight
                      Positioned(
                        top: 0,
                        left: 0,
                        right: 0,
                        height: 50,
                        child: Container(
                          decoration: BoxDecoration(
                            borderRadius: BorderRadius.vertical(
                              top: borderRadius.topLeft,
                            ),
                            gradient: PsychologyGlass.topHighlight,
                          ),
                        ),
                      ),
                      // Content
                      Padding(
                        padding: widget.padding ?? PsychologySpacing.cardPadding,
                        child: widget.child,
                      ),
                    ],
                  ),
                ),
              ),
            ),
          ),
        );
      },
    );

    if (widget.onTap != null) {
      return GestureDetector(
        onTapDown: _handleTapDown,
        onTapUp: _handleTapUp,
        onTapCancel: _handleTapCancel,
        onTap: widget.onTap,
        child: content,
      );
    }

    return content;
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// SUCCESS CELEBRATION OVERLAY
// ═══════════════════════════════════════════════════════════════════════════

/// Full-screen success celebration with confetti
class SuccessCelebration extends StatefulWidget {
  final String title;
  final String? subtitle;
  final VoidCallback? onComplete;
  final Duration displayDuration;

  const SuccessCelebration({
    super.key,
    required this.title,
    this.subtitle,
    this.onComplete,
    this.displayDuration = const Duration(seconds: 3),
  });

  @override
  State<SuccessCelebration> createState() => _SuccessCelebrationState();
}

class _SuccessCelebrationState extends State<SuccessCelebration>
    with TickerProviderStateMixin {
  late AnimationController _scaleController;
  late AnimationController _confettiController;
  late Animation<double> _scaleAnimation;
  late Animation<double> _opacityAnimation;

  final List<_ConfettiParticle> _particles = [];
  final _random = math.Random();

  @override
  void initState() {
    super.initState();

    // Scale animation
    _scaleController = AnimationController(
      vsync: this,
      duration: PsychologyAnimations.slow,
    );
    _scaleAnimation = Tween<double>(begin: 0.5, end: 1.0).animate(
      CurvedAnimation(parent: _scaleController, curve: PsychologyAnimations.bounce),
    );
    _opacityAnimation = Tween<double>(begin: 0.0, end: 1.0).animate(
      CurvedAnimation(parent: _scaleController, curve: Curves.easeOut),
    );

    // Confetti animation
    _confettiController = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 3),
    );

    // Generate confetti particles
    _generateParticles();

    // Start animations
    HapticFeedback.heavyImpact();
    _scaleController.forward();
    _confettiController.forward();

    // Auto dismiss
    Future.delayed(widget.displayDuration, () {
      if (mounted) {
        widget.onComplete?.call();
      }
    });
  }

  void _generateParticles() {
    final colors = [
      PsychologyColors.primary,
      PsychologyColors.secondary,
      PsychologyColors.success,
      PsychologyColors.gold,
      PsychologyColors.streakFlame,
    ];

    for (int i = 0; i < 50; i++) {
      _particles.add(_ConfettiParticle(
        x: _random.nextDouble(),
        y: -0.1 - _random.nextDouble() * 0.3,
        velocityX: (_random.nextDouble() - 0.5) * 0.02,
        velocityY: 0.01 + _random.nextDouble() * 0.02,
        rotation: _random.nextDouble() * math.pi * 2,
        rotationVelocity: (_random.nextDouble() - 0.5) * 0.1,
        size: 8 + _random.nextDouble() * 8,
        color: colors[_random.nextInt(colors.length)],
      ));
    }
  }

  @override
  void dispose() {
    _scaleController.dispose();
    _confettiController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: Listenable.merge([_scaleController, _confettiController]),
      builder: (context, child) {
        return Stack(
          children: [
            // Backdrop
            Container(
              color: Colors.black.withValues(alpha: _opacityAnimation.value * 0.8),
            ),

            // Confetti
            CustomPaint(
              size: Size.infinite,
              painter: _ConfettiPainter(
                particles: _particles,
                progress: _confettiController.value,
              ),
            ),

            // Content
            Center(
              child: Transform.scale(
                scale: _scaleAnimation.value,
                child: Opacity(
                  opacity: _opacityAnimation.value,
                  child: Column(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      // Success icon
                      Container(
                        width: 80,
                        height: 80,
                        decoration: BoxDecoration(
                          shape: BoxShape.circle,
                          gradient: PsychologyColors.successGradient,
                          boxShadow: PsychologyShadows.glow(
                            PsychologyColors.success,
                            intensity: 0.5,
                            blur: 40,
                          ),
                        ),
                        child: const Icon(
                          Icons.check_rounded,
                          color: Colors.white,
                          size: 48,
                        ),
                      ),
                      const SizedBox(height: 24),
                      // Title
                      Text(
                        widget.title,
                        style: PsychologyTypography.headlineMedium.copyWith(
                          color: Colors.white,
                        ),
                        textAlign: TextAlign.center,
                      ),
                      if (widget.subtitle != null) ...[
                        const SizedBox(height: 8),
                        Text(
                          widget.subtitle!,
                          style: PsychologyTypography.bodyMedium.copyWith(
                            color: PsychologyColors.textSecondary,
                          ),
                          textAlign: TextAlign.center,
                        ),
                      ],
                    ],
                  ),
                ),
              ),
            ),
          ],
        );
      },
    );
  }
}

class _ConfettiParticle {
  double x;
  double y;
  double velocityX;
  double velocityY;
  double rotation;
  double rotationVelocity;
  double size;
  Color color;

  _ConfettiParticle({
    required this.x,
    required this.y,
    required this.velocityX,
    required this.velocityY,
    required this.rotation,
    required this.rotationVelocity,
    required this.size,
    required this.color,
  });
}

class _ConfettiPainter extends CustomPainter {
  final List<_ConfettiParticle> particles;
  final double progress;

  _ConfettiPainter({required this.particles, required this.progress});

  @override
  void paint(Canvas canvas, Size size) {
    for (final particle in particles) {
      final x = (particle.x + particle.velocityX * progress * 100) * size.width;
      final y = (particle.y + particle.velocityY * progress * 100 + progress * 0.5) * size.height;
      final rotation = particle.rotation + particle.rotationVelocity * progress * 100;

      if (y > size.height + 50) continue;

      canvas.save();
      canvas.translate(x, y);
      canvas.rotate(rotation);

      final paint = Paint()
        ..color = particle.color.withValues(alpha: 1.0 - progress * 0.5)
        ..style = PaintingStyle.fill;

      canvas.drawRRect(
        RRect.fromRectAndRadius(
          Rect.fromCenter(center: Offset.zero, width: particle.size, height: particle.size * 0.6),
          const Radius.circular(2),
        ),
        paint,
      );

      canvas.restore();
    }
  }

  @override
  bool shouldRepaint(_ConfettiPainter oldDelegate) => true;
}

// ═══════════════════════════════════════════════════════════════════════════
// LEVEL PROGRESS BAR
// ═══════════════════════════════════════════════════════════════════════════

/// Horizontal progress bar with shimmer effect
class LevelProgressBar extends StatefulWidget {
  final double progress; // 0.0 to 1.0
  final double height;
  final Color? color;
  final Color? backgroundColor;
  final bool showShimmer;
  final BorderRadius? borderRadius;

  const LevelProgressBar({
    super.key,
    required this.progress,
    this.height = 8,
    this.color,
    this.backgroundColor,
    this.showShimmer = true,
    this.borderRadius,
  });

  @override
  State<LevelProgressBar> createState() => _LevelProgressBarState();
}

class _LevelProgressBarState extends State<LevelProgressBar>
    with SingleTickerProviderStateMixin {
  late AnimationController _shimmerController;

  @override
  void initState() {
    super.initState();
    _shimmerController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 2000),
    );
    if (widget.showShimmer) {
      _shimmerController.repeat();
    }
  }

  @override
  void dispose() {
    _shimmerController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final radius = widget.borderRadius ?? BorderRadius.circular(widget.height / 2);
    final color = widget.color ?? PsychologyColors.primary;
    final bgColor = widget.backgroundColor ?? PsychologyColors.surfaceElevated;

    return Container(
      height: widget.height,
      decoration: BoxDecoration(
        color: bgColor,
        borderRadius: radius,
      ),
      child: ClipRRect(
        borderRadius: radius,
        child: Stack(
          children: [
            // Progress fill
            FractionallySizedBox(
              alignment: Alignment.centerLeft,
              widthFactor: widget.progress.clamp(0.0, 1.0),
              child: AnimatedBuilder(
                animation: _shimmerController,
                builder: (context, child) {
                  return Container(
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        colors: [
                          color,
                          color.withValues(alpha: 0.8),
                          color,
                        ],
                        stops: widget.showShimmer
                            ? [
                                (_shimmerController.value - 0.3).clamp(0.0, 1.0),
                                _shimmerController.value.clamp(0.0, 1.0),
                                (_shimmerController.value + 0.3).clamp(0.0, 1.0),
                              ]
                            : const [0.0, 0.5, 1.0],
                      ),
                      borderRadius: radius,
                    ),
                  );
                },
              ),
            ),
          ],
        ),
      ),
    );
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// GRADIENT BORDER
// ═══════════════════════════════════════════════════════════════════════════

/// Widget with animated gradient border
class GradientBorder extends StatelessWidget {
  final Widget child;
  final double borderWidth;
  final double borderRadius;
  final LinearGradient gradient;

  const GradientBorder({
    super.key,
    required this.child,
    this.borderWidth = 1.5,
    this.borderRadius = 20,
    required this.gradient,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: BoxDecoration(
        gradient: gradient,
        borderRadius: BorderRadius.circular(borderRadius),
      ),
      child: Container(
        margin: EdgeInsets.all(borderWidth),
        decoration: BoxDecoration(
          color: PsychologyColors.surface,
          borderRadius: BorderRadius.circular(borderRadius - borderWidth),
        ),
        child: child,
      ),
    );
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// ACCESSIBLE TEXT HELPER
// ═══════════════════════════════════════════════════════════════════════════

/// Accessible text with scaling support
class AccessibleText {
  AccessibleText._();

  /// Create text style with accessibility scaling
  static TextStyle scaled(
    BuildContext context, {
    required double fontSize,
    FontWeight fontWeight = FontWeight.w400,
    Color? color,
    double? letterSpacing,
    double? height,
    double maxScale = 1.5,
  }) {
    final mediaQuery = MediaQuery.of(context);
    final textScaler = mediaQuery.textScaler;
    final scale = textScaler.scale(1.0).clamp(1.0, maxScale);

    return TextStyle(
      fontSize: fontSize * scale,
      fontWeight: fontWeight,
      color: color ?? PsychologyColors.textPrimary,
      letterSpacing: letterSpacing,
      height: height,
    );
  }
}


--- FILE: lib/core/theme/theme.dart ---

// VANTAG PSYCHOLOGY DESIGN SYSTEM 2026
// Barrel file for all theme exports

export 'psychology_design_system.dart';
export 'psychology_effects.dart';
export 'psychology_widgets.dart';


--- FILE: lib/constants/app_limits.dart ---

/// Centralized app limits for free tier and premium features.
/// Single source of truth for all feature limits.
class AppLimits {
  AppLimits._(); // Prevent instantiation

  // ===== AI CHAT =====
  /// Free users can use 4 AI preset buttons per day (no free text input).
  /// Free text input is PREMIUM ONLY.
  static const int freeAiChatsPerDay = 4;

  // ===== VOICE INPUT =====
  /// Free users can use voice input 3 times per day (very cheap, good UX).
  static const int freeVoiceInputPerDay = 3;

  /// Pro users can use voice input 10 times per day (shown as unlimited).
  static const int proVoiceInputPerDay = 10;

  // ===== PURSUITS =====
  /// Free users can have 1 active pursuit (savings goal).
  static const int freePursuits = 1;

  // ===== EXPENSE HISTORY =====
  /// Free users can view last 30 days of expense history.
  static const int freeHistoryDays = 30;

  // ===== CURRENCY =====
  /// Free users can only use TRY currency.
  static const String freeCurrency = 'TRY';

  // ===== REPORTS =====
  /// Free users can only view weekly reports.
  static const String freeReportPeriod = 'weekly';
}


--- FILE: lib/providers/locale_provider.dart ---

import 'dart:io' show Platform;
import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';

/// Kullanıcının dil tercihini yöneten provider
class LocaleProvider extends ChangeNotifier {
  static const String _localeKey = 'app_locale';
  static const String _firstLaunchKey = 'locale_first_launch_done';

  Locale? _locale;

  /// Mevcut locale (null ise sistem dili kullanılır)
  Locale? get locale => _locale;

  /// Desteklenen diller
  static const List<Locale> supportedLocales = [
    Locale('tr'), // Türkçe
    Locale('en'), // İngilizce
  ];

  /// Provider'ı başlat ve kaydedilmiş dili yükle
  Future<void> initialize() async {
    final prefs = await SharedPreferences.getInstance();
    final localeCode = prefs.getString(_localeKey);
    final firstLaunchDone = prefs.getBool(_firstLaunchKey) ?? false;

    if (localeCode != null) {
      // User has a saved preference
      _locale = Locale(localeCode);
    } else if (!firstLaunchDone) {
      // First launch - set based on phone language
      final phoneLocale = _getPhoneLocale();
      if (phoneLocale == 'tr') {
        _locale = const Locale('tr');
      } else {
        _locale = const Locale('en');
      }
      // Save the initial preference
      await prefs.setString(_localeKey, _locale!.languageCode);
      await prefs.setBool(_firstLaunchKey, true);
    }

    notifyListeners();
  }

  /// Get phone's language code
  String _getPhoneLocale() {
    try {
      final localeName = Platform.localeName; // e.g., "tr_TR", "en_US"
      if (localeName.isNotEmpty) {
        return localeName.split('_').first.toLowerCase();
      }
    } catch (e) {
      debugPrint('[LocaleProvider] Error getting phone locale: $e');
    }
    return 'en'; // Default to English if detection fails
  }

  /// Check if phone language is Turkish
  static bool isPhoneTurkish() {
    try {
      final localeName = Platform.localeName;
      return localeName.toLowerCase().startsWith('tr');
    } catch (e) {
      return false;
    }
  }

  /// Dili değiştir ve kaydet
  Future<void> setLocale(Locale locale) async {
    if (!supportedLocales.contains(locale)) return;

    _locale = locale;
    notifyListeners();

    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(_localeKey, locale.languageCode);
  }

  /// Sistem diline dön
  Future<void> clearLocale() async {
    _locale = null;
    notifyListeners();

    final prefs = await SharedPreferences.getInstance();
    await prefs.remove(_localeKey);
  }

  /// Dil kodu'ndan okunabilir isim döndür
  String getLanguageName(String code) {
    switch (code) {
      case 'tr':
        return 'Türkçe';
      case 'en':
        return 'English';
      default:
        return code;
    }
  }

  /// Mevcut dil Türkçe mi?
  bool get isTurkish => _locale?.languageCode == 'tr';

  /// Mevcut dil İngilizce mi?
  bool get isEnglish => _locale?.languageCode == 'en';
}


--- FILE: lib/providers/finance_provider.dart ---

import 'package:flutter/widgets.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:firebase_auth/firebase_auth.dart';
import '../models/models.dart';
import '../services/services.dart';

class FinanceProvider extends ChangeNotifier {
  final ExpenseHistoryService _expenseService = ExpenseHistoryService();
  final StreakService _streakService = StreakService();
  final AchievementsService _achievementsService = AchievementsService();
  final ProfileService _profileService = ProfileService();
  final SubscriptionService _subscriptionService = SubscriptionService();
  final CalculationService _calculationService = CalculationService();

  static const _keyAutoRecordedDate = 'auto_recorded_subscriptions_date';

  // State
  List<Expense> _expenses = [];
  DecisionStats _stats = const DecisionStats();
  StreakData _streakData = const StreakData(currentStreak: 0, longestStreak: 0);
  List<Achievement> _achievements = [];
  UserProfile? _userProfile;
  bool _isLoading = true;
  bool _isInitialized = false;

  // Widget sync parameters (cached for auto-sync after expense changes)
  String _widgetCurrencySymbol = '₺';
  String _widgetLocale = 'tr';
  String? _widgetPursuitName;
  double? _widgetPursuitProgress;
  double? _widgetPursuitTarget;

  // Getters - Genel
  UserProfile? get userProfile => _userProfile;
  List<Expense> get expenses => List.unmodifiable(_expenses);
  List<Expense> get realExpenses => _expenses.where((e) => e.isReal).toList();
  DecisionStats get stats => _stats;
  StreakData get streakData => _streakData;
  List<Achievement> get achievements => List.unmodifiable(_achievements);
  bool get isLoading => _isLoading;
  bool get isInitialized => _isInitialized;

  // Getters - Gelir (82.500 Fix Burada)
  List<IncomeSource> get incomeSources => _userProfile?.incomeSources ?? [];
  double get totalMonthlyIncome => _userProfile?.monthlyIncome ?? 0;
  int get incomeSourceCount => _userProfile?.incomeSourceCount ?? 0;

  // Getters - Salary & Balance
  int? get salaryDay => _userProfile?.salaryDay;
  double? get currentBalance => _userProfile?.currentBalance;
  bool get hasBalanceTracking => _userProfile?.currentBalance != null;

  // Getters - Abonelikler (AI Context için)
  Future<List<Subscription>> getSubscriptions() async {
    return await _subscriptionService.getSubscriptions();
  }

  Future<List<Subscription>> getActiveSubscriptions() async {
    return await _subscriptionService.getActiveSubscriptions();
  }

  // Başlatma
  Future<void> initialize() async {
    if (_isInitialized) return;
    _isLoading = true;
    notifyListeners();
    try {
      await Future.wait([_loadExpenses(), _loadStreakData(), _loadProfile()]);
      _isInitialized = true;

      // Otomatik abonelik kayıtlarını işle
      await _processAutoSubscriptionRecords();
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  /// Bugün yenilenen ve autoRecord=true olan abonelikleri otomatik harcama olarak kaydet
  Future<void> _processAutoSubscriptionRecords() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      final today = DateTime.now();
      final todayKey = '${today.year}-${today.month}-${today.day}';

      // Bugün zaten işlenmiş mi kontrol et
      final lastProcessedDate = prefs.getString(_keyAutoRecordedDate);
      if (lastProcessedDate == todayKey) return;

      // Bugün yenilenecek ve autoRecord açık olan abonelikleri getir
      final todayRenewals = await _subscriptionService
          .getAutoRecordSubscriptionsForToday();
      if (todayRenewals.isEmpty) {
        await prefs.setString(_keyAutoRecordedDate, todayKey);
        return;
      }

      // Her abonelik için harcama oluştur
      for (final sub in todayRenewals) {
        // Hesaplama yap
        final result = _calculationService.calculateExpense(
          userProfile:
              _userProfile ??
              UserProfile(incomeSources: [], dailyHours: 8, workDaysPerWeek: 5),
          expenseAmount: sub.amount,
          month: today.month,
          year: today.year,
        );

        final expense = Expense(
          amount: sub.amount,
          category: 'Abonelik',
          subCategory: sub.name,
          date: today,
          hoursRequired: result.hoursRequired,
          daysRequired: result.daysRequired,
          decision: ExpenseDecision.yes,
          decisionDate: today,
          recordType: RecordType.real,
        );

        await addExpense(expense);
      }

      // İşlenen tarihi kaydet
      await prefs.setString(_keyAutoRecordedDate, todayKey);
    } catch (e) {
      // Hata sessizce geçilir
    }
  }

  Future<void> _loadProfile() async {
    _userProfile = await _profileService.getProfile();
  }

  Future<void> _loadExpenses() async {
    _expenses = await _expenseService.getAllExpenses();
    _calculateStats();
  }

  /// Refresh expenses from storage (e.g., after simulation cleanup)
  Future<void> refresh() async {
    await _loadExpenses();
    notifyListeners();
  }

  void _calculateStats() {
    _stats = DecisionStats.fromExpenses(realExpenses);
  }

  // ============================================
  // HARCAMA (EXPENSE) İŞLEMLERİ (Geri Getirilenler)
  // ============================================

  Future<void> addExpense(Expense expense) async {
    // Check if this is the first expense (before adding)
    final isFirstExpense = _expenses.isEmpty;

    _expenses.insert(0, expense);

    // Enforce cache limit - keep only the most recent expenses in memory
    if (_expenses.length > ExpenseHistoryService.maxLocalExpenses) {
      _expenses = _expenses
          .take(ExpenseHistoryService.maxLocalExpenses)
          .toList();
    }

    _calculateStats();
    notifyListeners();
    await _expenseService.addExpense(expense);
    if (expense.isReal) await _updateStreakAfterEntry();

    // Sync widget data after expense is added
    await _autoSyncWidget();

    // First expense celebration and referral reward
    if (isFirstExpense && expense.isReal) {
      _handleFirstExpense(expense);
    }
  }

  /// Handle first expense - schedule celebration notification and reward referrer
  Future<void> _handleFirstExpense(Expense expense) async {
    try {
      // Schedule first expense celebration notification
      final savedHours = expense.hoursRequired.toStringAsFixed(1);
      await NotificationService().scheduleFirstExpenseCelebration(
        savedHours: savedHours,
      );
      debugPrint('[FinanceProvider] First expense celebration scheduled');

      // Reward referrer if this user was referred
      await ReferralService().rewardReferrerOnFirstExpense(
        FirebaseAuth.instance.currentUser?.uid ?? '',
      );
    } catch (e) {
      debugPrint('[FinanceProvider] Error handling first expense: $e');
    }
  }

  Future<void> updateExpense(int index, Expense expense) async {
    if (index < 0 || index >= _expenses.length) return;
    _expenses[index] = expense;
    _calculateStats();
    notifyListeners();
    await _expenseService.updateExpense(index, expense);
    await _autoSyncWidget();
  }

  Future<void> deleteExpense(int index) async {
    if (index < 0 || index >= _expenses.length) return;
    _expenses.removeAt(index);
    _calculateStats();
    notifyListeners();
    await _expenseService.deleteExpense(index);
    await _autoSyncWidget();
  }

  Future<void> updateDecision(int index, ExpenseDecision decision) async {
    if (index < 0 || index >= _expenses.length) return;
    final updated = _expenses[index].copyWith(
      decision: decision,
      decisionDate: DateTime.now(),
    );
    await updateExpense(index, updated);
  }

  /// Alias for updateDecision - for backwards compatibility
  Future<void> updateExpenseDecision(
    int index,
    ExpenseDecision decision,
  ) async {
    await updateDecision(index, decision);
  }

  // ============================================
  // GELİR (INCOME) İŞLEMLERİ - STRICT FIX
  // ============================================

  void setUserProfile(UserProfile profile) {
    _userProfile = profile;
    _calculateStats();
    notifyListeners();
  }

  Future<void> setIncomeSources(List<IncomeSource> sources) async {
    final updatedProfile =
        (_userProfile ?? UserProfile(dailyHours: 8, workDaysPerWeek: 5))
            .copyWith(incomeSources: List<IncomeSource>.from(sources));

    _userProfile = updatedProfile;
    _calculateStats();
    notifyListeners();
    await _profileService.saveProfile(updatedProfile);
  }

  /// Para birimi değiştiğinde tüm gelir kaynaklarını yeni para birimine convert et
  /// [convertedSources] - CurrencyProvider.convertIncomeSources() ile convert edilmiş liste
  Future<void> updateIncomeSourcesWithConversion(
    List<IncomeSource> convertedSources,
  ) async {
    if (_userProfile == null) return;

    _userProfile = _userProfile!.copyWith(incomeSources: convertedSources);

    _calculateStats();
    notifyListeners();
    await _profileService.saveProfile(_userProfile!);
  }

  /// Gelir kaynağının orijinal tutarını güncelle (maaş zammı vb.)
  /// Bu işlem hem mevcut hem orijinal değerleri günceller
  Future<void> updateIncomeSourceAmount({
    required String sourceId,
    required double newAmount,
    required String currencyCode,
  }) async {
    if (_userProfile == null) return;

    final sources = _userProfile!.incomeSources.map((source) {
      if (source.id == sourceId) {
        // Hem amount hem originalAmount güncellenir
        return source.copyWith(
          amount: newAmount,
          currencyCode: currencyCode,
          originalAmount: newAmount,
          originalCurrencyCode: currencyCode,
        );
      }
      return source;
    }).toList();

    await setIncomeSources(sources);
  }

  Future<void> updateWorkSchedule({
    double? dailyHours,
    int? workDaysPerWeek,
  }) async {
    if (_userProfile == null) return;
    _userProfile = _userProfile!.copyWith(
      dailyHours: dailyHours,
      workDaysPerWeek: workDaysPerWeek,
    );
    notifyListeners();
    await _profileService.saveProfile(_userProfile!);
  }

  /// Set base currency (locked for FREE users)
  /// Should only be set once from first salary entry
  Future<void> setBaseCurrency(String currencyCode) async {
    if (_userProfile == null) return;
    _userProfile = _userProfile!.copyWith(baseCurrency: currencyCode);
    notifyListeners();
    await _profileService.saveProfile(_userProfile!);
  }

  // ============================================
  // BÜTÇE VE TASARRUF HEDEFLERI
  // ============================================

  /// Aylık bütçe güncelle
  Future<void> updateMonthlyBudget(double? budget) async {
    if (_userProfile == null) return;
    _userProfile = _userProfile!.copyWith(monthlyBudget: budget);
    notifyListeners();
    await _profileService.saveProfile(_userProfile!);
  }

  /// Tasarruf hedefi güncelle
  Future<void> updateSavingsGoal(double? goal) async {
    if (_userProfile == null) return;
    _userProfile = _userProfile!.copyWith(monthlySavingsGoal: goal);
    notifyListeners();
    await _profileService.saveProfile(_userProfile!);
  }

  // ============================================
  // MAAŞ GÜNÜ VE BAKİYE YÖNETİMİ
  // ============================================

  /// Maaş gününü güncelle (1-31)
  Future<void> updateSalaryDay(int? day) async {
    if (_userProfile == null) return;
    _userProfile = _userProfile!.copyWith(salaryDay: day);
    notifyListeners();
    await _profileService.saveProfile(_userProfile!);

    // Schedule payday notification
    if (day != null) {
      await NotificationService().schedulePaydayNotification(salaryDay: day);
    } else {
      await NotificationService().cancelPaydayNotification();
    }
  }

  /// Güncel bakiyeyi güncelle
  Future<void> updateCurrentBalance(double? balance) async {
    if (_userProfile == null) return;
    _userProfile = _userProfile!.copyWith(currentBalance: balance);
    notifyListeners();
    await _profileService.saveProfile(_userProfile!);
  }

  /// Bakiyeden harcama düş
  Future<void> deductFromBalance(double amount) async {
    if (_userProfile == null) return;

    final currentBalance = _userProfile!.currentBalance ?? 0;
    final newBalance = currentBalance - amount;

    _userProfile = _userProfile!.copyWith(currentBalance: newBalance);
    notifyListeners();
    await _profileService.saveProfile(_userProfile!);
  }

  /// Bakiyeye gelir ekle
  Future<void> addToBalance(double amount) async {
    if (_userProfile == null) return;

    final currentBalance = _userProfile!.currentBalance ?? 0;
    final newBalance = currentBalance + amount;

    _userProfile = _userProfile!.copyWith(currentBalance: newBalance);
    notifyListeners();
    await _profileService.saveProfile(_userProfile!);
  }

  /// Maaş alındığını onayla
  Future<void> confirmSalaryReceived({double? newBalance}) async {
    if (_userProfile == null) return;

    final balance =
        newBalance ??
        ((_userProfile!.currentBalance ?? 0) + _userProfile!.monthlyIncome);

    _userProfile = _userProfile!.copyWith(
      lastSalaryConfirmedDate: DateTime.now(),
      currentBalance: balance,
    );
    notifyListeners();
    await _profileService.saveProfile(_userProfile!);
  }

  /// Bugün maaş günü mü ve henüz onaylanmamış mı kontrol et
  bool get shouldShowPaydayDialog {
    if (_userProfile == null) return false;
    return _userProfile!.isPayday && !_userProfile!.isSalaryConfirmedThisMonth;
  }

  /// Maaşa kaç gün kaldı
  int get daysUntilPayday => _userProfile?.daysUntilPayday ?? -1;

  /// Saatlik ücret (fallback ile)
  double get hourlyRate {
    if (_userProfile == null) return 0;
    final rate = _userProfile!.hourlyRate;
    if (rate <= 0) {
      // Fallback: aylık gelir / 160 saat
      return _userProfile!.monthlyIncome / 160;
    }
    return rate;
  }

  // ============================================
  // HARCAMA FİLTRELERİ VE HESAPLAMALAR
  // ============================================

  /// Bu ayki harcamalar
  List<Expense> get currentMonthExpenses {
    final now = DateTime.now();
    return _expenses
        .where((e) => e.date.year == now.year && e.date.month == now.month)
        .toList();
  }

  /// Aktif taksitler listesi
  List<Expense> get activeInstallments {
    return _expenses
        .where(
          (e) => e.type == ExpenseType.installment && !e.isInstallmentCompleted,
        )
        .toList();
  }

  /// Bu ayki zorunlu giderler toplamı
  /// NOT: "Vazgeçtim" (decision=no) harcamalar hariç
  double get mandatoryExpensesTotal {
    return currentMonthExpenses
        .where((e) => e.isMandatory && e.decision != ExpenseDecision.no)
        .fold(0.0, (sum, e) => sum + e.amount);
  }

  /// Bu ayki isteğe bağlı giderler toplamı
  /// NOT: "Vazgeçtim" (decision=no) harcamalar hariç - bunlar gerçek harcama değil
  double get discretionaryExpensesTotal {
    return currentMonthExpenses
        .where((e) => !e.isMandatory && e.decision != ExpenseDecision.no)
        .fold(0.0, (sum, e) => sum + e.amount);
  }

  // ============================================
  // HOME SCREEN WIDGET SYNC
  // ============================================

  /// Sync data to home screen widgets
  /// Call this after expenses change, or on app launch
  Future<void> syncWidgetData({
    required String currencySymbol,
    required String locale,
    String? pursuitName,
    double? pursuitProgress,
    double? pursuitTarget,
  }) async {
    try {
      // Calculate today's spending
      final todayData = getTodaySpendingData();

      // Calculate spending level
      final spendingLevel = WidgetService.calculateSpendingLevel(
        todaySpending: todayData.amount,
        dailyAverage: dailyAverageSpending,
      );

      // Update widget
      await widgetService.updateWidgetData(
        todayHours: todayData.hours,
        todayMinutes: todayData.minutes,
        todayAmount: todayData.amount,
        currencySymbol: currencySymbol,
        spendingLevel: spendingLevel,
        pursuitName: pursuitName,
        pursuitProgress: pursuitProgress,
        pursuitTarget: pursuitTarget,
        locale: locale,
      );
    } catch (e) {
      debugPrint('[FinanceProvider] Widget sync error: $e');
    }
  }

  /// Set widget sync parameters (call from main_screen on init and when params change)
  void setWidgetParams({
    required String currencySymbol,
    required String locale,
    String? pursuitName,
    double? pursuitProgress,
    double? pursuitTarget,
  }) {
    _widgetCurrencySymbol = currencySymbol;
    _widgetLocale = locale;
    _widgetPursuitName = pursuitName;
    _widgetPursuitProgress = pursuitProgress;
    _widgetPursuitTarget = pursuitTarget;
  }

  /// Auto-sync widget using cached parameters (called after expense changes)
  Future<void> _autoSyncWidget() async {
    try {
      debugPrint('[FinanceProvider] _autoSyncWidget called - currency: $_widgetCurrencySymbol, locale: $_widgetLocale');
      final todayData = getTodaySpendingData();
      debugPrint('[FinanceProvider] Today data: ${todayData.hours}h ${todayData.minutes}m, ${todayData.amount} TL');
      await syncWidgetData(
        currencySymbol: _widgetCurrencySymbol,
        locale: _widgetLocale,
        pursuitName: _widgetPursuitName,
        pursuitProgress: _widgetPursuitProgress,
        pursuitTarget: _widgetPursuitTarget,
      );
      debugPrint('[FinanceProvider] Widget sync completed');
    } catch (e) {
      debugPrint('[FinanceProvider] Auto widget sync error: $e');
    }
  }

  /// Get today's spending data for widgets
  TodaySpendingData getTodaySpendingData() {
    final now = DateTime.now();
    final todayExpenses = _expenses
        .where(
          (e) =>
              e.date.year == now.year &&
              e.date.month == now.month &&
              e.date.day == now.day &&
              e.decision == ExpenseDecision.yes,
        )
        .toList();

    final totalAmount = todayExpenses.fold(0.0, (sum, e) => sum + e.amount);
    final totalHoursDecimal = todayExpenses.fold(
      0.0,
      (sum, e) => sum + e.hoursRequired,
    );

    // Convert decimal hours to hours and minutes
    final hours = totalHoursDecimal.floor().toDouble();
    final minutes = ((totalHoursDecimal - hours) * 60).round();

    return TodaySpendingData(
      amount: totalAmount,
      hours: hours,
      minutes: minutes,
      expenseCount: todayExpenses.length,
    );
  }

  /// Calculate daily average spending (last 30 days)
  double get dailyAverageSpending {
    final now = DateTime.now();
    final thirtyDaysAgo = now.subtract(const Duration(days: 30));

    final recentExpenses = _expenses
        .where(
          (e) =>
              e.date.isAfter(thirtyDaysAgo) &&
              e.decision == ExpenseDecision.yes,
        )
        .toList();

    if (recentExpenses.isEmpty) return 0;

    final totalAmount = recentExpenses.fold(0.0, (sum, e) => sum + e.amount);
    return totalAmount / 30;
  }

  // ============================================
  // DİĞER SERVİSLER
  // ============================================
  Future<void> _updateStreakAfterEntry() async {
    await _streakService.recordEntry();
    _streakData = await _streakService.getStreakData();
    notifyListeners();
  }

  Future<void> _loadStreakData() async =>
      _streakData = await _streakService.getStreakData();

  /// Refresh achievements with localized titles (requires BuildContext)
  Future<void> refreshAchievements(BuildContext context) async {
    _achievements = await _achievementsService.getAchievements(context);
    notifyListeners();
  }

  // ============================================
  // TAM SIFIRLAMA (WIPE)
  // ============================================

  /// Tüm verileri sıfırla - hem disk hem memory
  Future<void> resetAllData() async {
    // 1. Disk'teki tüm verileri sil
    await _profileService.resetAllData();

    // 2. Memory'deki tüm state'i sıfırla
    _expenses = [];
    _stats = const DecisionStats();
    _streakData = const StreakData(currentStreak: 0, longestStreak: 0);
    _achievements = [];
    _userProfile = null;
    _isLoading = false;
    _isInitialized = false;

    notifyListeners();
  }

  // ============================================
  // PRO FEATURES: ARŞİVLENMİŞ VERİLER
  // ============================================

  /// Firestore'daki toplam expense sayısını getir
  Future<int> getTotalExpenseCount() async {
    return await _expenseService.getTotalExpenseCount();
  }

  /// Firestore'dan arşivlenmiş expense'leri getir (Pro kullanıcılar için)
  Future<List<Expense>> fetchArchivedExpenses({
    int offset = 0,
    int limit = 50,
  }) async {
    return await _expenseService.fetchArchivedExpenses(
      offset: offset,
      limit: limit,
    );
  }

  /// Firestore'dan TÜM expense'leri getir (Pro export için)
  Future<List<Expense>> fetchAllExpensesFromFirestore() async {
    return await _expenseService.fetchAllExpensesFromFirestore();
  }

  // ============================================
  // DEBUG: TEST METODLARI
  // ============================================

  /// Debug: Toplu test expense'leri ekle
  Future<void> addTestExpenses(int count) async {
    final categories = [
      'Yiyecek',
      'Dijital',
      'Ulaşım',
      'Giyim',
      'Eğlence',
      'Sağlık',
    ];
    final random = DateTime.now().millisecondsSinceEpoch;

    for (int i = 0; i < count; i++) {
      final amount = ((random + i * 137) % 900) + 100.0; // 100-1000 arası
      final categoryIndex = (random + i) % categories.length;
      final daysAgo = i;

      final result = _calculationService.calculateExpense(
        userProfile:
            _userProfile ??
            UserProfile(incomeSources: [], dailyHours: 8, workDaysPerWeek: 5),
        expenseAmount: amount,
        month: DateTime.now().month,
        year: DateTime.now().year,
      );

      final expense = Expense(
        amount: amount,
        category: categories[categoryIndex],
        date: DateTime.now().subtract(Duration(days: daysAgo)),
        hoursRequired: result.hoursRequired,
        daysRequired: result.daysRequired,
        decision: ExpenseDecision.yes,
        decisionDate: DateTime.now(),
        recordType: RecordType.simulation,
      );

      await addExpense(expense);
    }
  }
}

/// Data class for today's spending information
class TodaySpendingData {
  final double amount;
  final double hours;
  final int minutes;
  final int expenseCount;

  const TodaySpendingData({
    required this.amount,
    required this.hours,
    required this.minutes,
    required this.expenseCount,
  });

  /// Total time in decimal hours
  double get totalHours => hours + (minutes / 60);

  /// Formatted time string (e.g., "2h 45m")
  String formattedTime(String hourAbbrev, String minAbbrev) {
    return '${hours.toInt()}$hourAbbrev $minutes$minAbbrev';
  }
}


--- FILE: lib/providers/category_budget_provider.dart ---

import 'package:flutter/foundation.dart';
import '../models/category_budget.dart';
import '../models/expense.dart';
import '../services/category_budget_service.dart';

/// Provider for managing category budget state
class CategoryBudgetProvider extends ChangeNotifier {
  final CategoryBudgetService _service = CategoryBudgetService();

  List<CategoryBudgetWithSpent> _budgets = [];
  BudgetSummary? _summary;
  bool _isLoading = false;
  String? _error;

  // Current month context
  int _currentMonth = DateTime.now().month;
  int _currentYear = DateTime.now().year;

  // Cached expenses reference
  List<Expense> _expenses = [];

  // Getters
  List<CategoryBudgetWithSpent> get budgets => _budgets;
  BudgetSummary? get summary => _summary;
  bool get isLoading => _isLoading;
  String? get error => _error;
  int get currentMonth => _currentMonth;
  int get currentYear => _currentYear;

  /// All active budgets
  List<CategoryBudget> get activeBudgets =>
      _budgets.map((b) => b.budget).toList();

  /// Budgets that need attention (80%+)
  List<CategoryBudgetWithSpent> get warningBudgets =>
      _budgets.where((b) => b.percentUsed >= 80).toList();

  /// Budgets over limit
  List<CategoryBudgetWithSpent> get overBudgets =>
      _budgets.where((b) => b.isOverBudget).toList();

  /// Budgets near limit (80-100%)
  List<CategoryBudgetWithSpent> get nearLimitBudgets =>
      _budgets.where((b) => b.isNearLimit).toList();

  /// Budgets on track (<80%)
  List<CategoryBudgetWithSpent> get onTrackBudgets =>
      _budgets.where((b) => b.isOnTrack).toList();

  /// Has any budgets configured
  bool get hasBudgets => _budgets.isNotEmpty;

  /// Has any warnings
  bool get hasWarnings => warningBudgets.isNotEmpty;

  /// Initialize/load budgets
  Future<void> initialize(List<Expense> expenses) async {
    _expenses = expenses;
    await loadBudgets();
  }

  /// Update expenses reference and refresh
  Future<void> updateExpenses(List<Expense> expenses) async {
    _expenses = expenses;
    await _refreshBudgets();
  }

  /// Set month context
  Future<void> setMonth(int month, int year) async {
    _currentMonth = month;
    _currentYear = year;
    await _refreshBudgets();
  }

  /// Load all budgets with spent amounts
  Future<void> loadBudgets() async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      _budgets = await _service.getBudgetsWithSpent(
        _expenses,
        _currentMonth,
        _currentYear,
      );

      _summary = await _service.getSummary(
        _expenses,
        _currentMonth,
        _currentYear,
      );

      // Sort by percent used (highest first)
      _budgets.sort((a, b) => b.percentUsed.compareTo(a.percentUsed));

      _error = null;
    } catch (e) {
      _error = e.toString();
      debugPrint('Error loading category budgets: $e');
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  /// Refresh budgets (internal)
  Future<void> _refreshBudgets() async {
    try {
      _budgets = await _service.getBudgetsWithSpent(
        _expenses,
        _currentMonth,
        _currentYear,
      );

      _summary = await _service.getSummary(
        _expenses,
        _currentMonth,
        _currentYear,
      );

      _budgets.sort((a, b) => b.percentUsed.compareTo(a.percentUsed));
      notifyListeners();
    } catch (e) {
      debugPrint('Error refreshing category budgets: $e');
    }
  }

  /// Add a new budget
  Future<bool> addBudget(CategoryBudget budget) async {
    try {
      await _service.saveBudget(budget);
      await _refreshBudgets();
      return true;
    } catch (e) {
      _error = e.toString();
      notifyListeners();
      return false;
    }
  }

  /// Update an existing budget
  Future<bool> updateBudget(CategoryBudget budget) async {
    try {
      await _service.updateBudget(budget);
      await _refreshBudgets();
      return true;
    } catch (e) {
      _error = e.toString();
      notifyListeners();
      return false;
    }
  }

  /// Delete a budget
  Future<bool> deleteBudget(String id) async {
    try {
      await _service.deleteBudget(id);
      await _refreshBudgets();
      return true;
    } catch (e) {
      _error = e.toString();
      notifyListeners();
      return false;
    }
  }

  /// Get budget for a specific category
  CategoryBudgetWithSpent? getBudgetForCategory(String category) {
    try {
      return _budgets.firstWhere((b) => b.budget.category == category);
    } catch (_) {
      return null;
    }
  }

  /// Check if category has a budget
  bool hasBudgetForCategory(String category) {
    return _budgets.any((b) => b.budget.category == category);
  }

  /// Check if adding expense would affect budget
  Future<BudgetCheckResult> checkExpenseImpact(
    String category,
    double amount,
  ) async {
    return await _service.checkBudgetOnExpense(
      _expenses,
      category,
      amount,
      _currentMonth,
      _currentYear,
    );
  }

  /// Get categories without budgets
  List<String> getCategoriesWithoutBudget(List<String> allCategories) {
    final budgetedCategories = _budgets.map((b) => b.budget.category).toSet();
    return allCategories.where((c) => !budgetedCategories.contains(c)).toList();
  }
}


--- FILE: lib/providers/currency_provider.dart ---

import 'package:flutter/foundation.dart';
import '../models/currency.dart';
import '../models/income_source.dart';
import '../services/currency_preference_service.dart';
import '../services/currency_service.dart';
import '../services/exchange_rate_service.dart';

/// Provider for managing the selected currency and exchange rates
class CurrencyProvider extends ChangeNotifier {
  Currency _currency = supportedCurrencies.first; // Default to TRY
  bool _isInitialized = false;
  bool _isLoadingRates = false;
  String? _rateError;

  // Exchange rate service singleton
  final ExchangeRateService _exchangeService = ExchangeRateService();

  // TCMB rates from CurrencyService (fallback when Firestore is empty)
  ExchangeRates? _tcmbRates;

  // Getters
  Currency get currency => _currency;
  bool get isInitialized => _isInitialized;
  bool get isLoadingRates => _isLoadingRates;
  String? get rateError => _rateError;
  bool get hasRates => _exchangeService.hasRates;

  /// Initialize and load saved currency
  Future<void> loadCurrency() async {
    if (_isInitialized) return;

    _currency = await CurrencyPreferenceService.getCurrency();
    _isInitialized = true;

    // Initialize exchange service from cache
    await _exchangeService.initialize();

    // Also load TCMB rates (from cache first, then API)
    try {
      final currencyService = CurrencyService();
      _tcmbRates = await currencyService.getRates();
      debugPrint(
        '💱 [CurrencyProvider] Initialized with TCMB rates: USD=${_tcmbRates?.usdRate}, EUR=${_tcmbRates?.eurRate}',
      );
    } catch (e) {
      debugPrint('⚠️ [CurrencyProvider] Failed to load TCMB rates: $e');
    }

    notifyListeners();
  }

  /// Set currency and persist
  Future<void> setCurrency(Currency currency) async {
    if (_currency.code == currency.code) return;

    _currency = currency;
    await CurrencyPreferenceService.setCurrency(currency.code);
    notifyListeners();
  }

  /// Fetch latest exchange rates
  Future<void> fetchRates({bool forceRefresh = false}) async {
    if (_isLoadingRates && !forceRefresh) return;

    _isLoadingRates = true;
    _rateError = null;
    notifyListeners();

    try {
      // Try to fetch from Firestore first
      await _exchangeService.fetchAllRates(forceRefresh: forceRefresh);

      // Also fetch TCMB rates as backup (these are always fresh from API)
      final currencyService = CurrencyService();
      _tcmbRates = await currencyService.getRates(forceRefresh: forceRefresh);

      debugPrint(
        '💱 [CurrencyProvider] TCMB rates loaded: USD=${_tcmbRates?.usdRate}, EUR=${_tcmbRates?.eurRate}',
      );

      if (!_exchangeService.hasRates && _tcmbRates == null) {
        _rateError = 'Failed to fetch exchange rates';
      }
    } catch (e) {
      _rateError = e.toString();
    } finally {
      _isLoadingRates = false;
      notifyListeners();
    }
  }

  /// Format amount with current currency
  String format(double amount) {
    return CurrencyPreferenceService.format(_currency, amount);
  }

  /// Format amount with decimals
  String formatWithDecimals(double amount, {int decimalDigits = 2}) {
    return CurrencyPreferenceService.format(
      _currency,
      amount,
      decimalDigits: decimalDigits,
    );
  }

  /// Format without symbol
  String formatWithoutSymbol(double amount, {int decimalDigits = 0}) {
    return CurrencyPreferenceService.formatWithoutSymbol(
      _currency,
      amount,
      decimalDigits: decimalDigits,
    );
  }

  /// Get just the symbol
  String get symbol => _currency.symbol;

  /// Get currency code
  String get code => _currency.code;

  // ═══════════════════════════════════════════════════════════════════
  // EXCHANGE RATE METHODS
  // ═══════════════════════════════════════════════════════════════════

  /// Convert amount between currencies
  /// Returns null if rates are not available
  double? convert(double amount, String from, String to) {
    return _exchangeService.convert(amount, from, to);
  }

  /// Convert amount to current currency
  double? convertToCurrent(double amount, String from) {
    return _exchangeService.convert(amount, from, _currency.code);
  }

  /// Convert amount from current currency
  double? convertFromCurrent(double amount, String to) {
    return _exchangeService.convert(amount, _currency.code, to);
  }

  /// Get rate between two currencies
  double? getRate(String from, String to) {
    return _exchangeService.getRate(from, to);
  }

  /// Get display rates for current currency
  CurrencyDisplayRates getDisplayRates() {
    return _exchangeService.getDisplayRates(_currency.code);
  }

  /// Get gold price in current currency
  double? get goldPrice {
    return _exchangeService.getGoldPrice(_currency.code);
  }

  /// Get gold unit for current currency
  String get goldUnit => _currency.goldUnit;

  /// Get formatted gold price
  String? get goldPriceFormatted {
    final price = goldPrice;
    if (price == null) return null;
    return formatWithDecimals(price, decimalDigits: goldUnit == 'gr' ? 2 : 2);
  }

  // ═══════════════════════════════════════════════════════════════════
  // UTILITY METHODS
  // ═══════════════════════════════════════════════════════════════════

  /// Get all supported currencies
  List<Currency> get supportedCurrencyList => supportedCurrencies;

  /// Get currencies except current
  List<Currency> get otherCurrencies {
    return supportedCurrencies.where((c) => c.code != _currency.code).toList();
  }

  /// Check if a currency is supported
  bool isCurrencySupported(String code) {
    return supportedCurrencies.any((c) => c.code == code);
  }

  /// Convert TRY amount to current currency
  /// Uses TCMB rates first (most accurate), falls back to ExchangeRateService
  /// If current currency is TRY, returns the same amount
  /// If rates not available, returns the original amount
  double convertFromTRY(double amountTRY) {
    if (_currency.code == 'TRY') return amountTRY;

    // Try TCMB rates first (direct from API, most accurate)
    if (_tcmbRates != null) {
      double? rate;
      switch (_currency.code) {
        case 'USD':
          rate = _tcmbRates!.usdRate;
          break;
        case 'EUR':
          rate = _tcmbRates!.eurRate;
          break;
        case 'GBP':
          // GBP not directly available, approximate via USD
          rate = _tcmbRates!.usdRate * 1.27;
          break;
        case 'SAR':
          // SAR pegged to USD at 3.75
          rate = _tcmbRates!.usdRate / 3.75;
          break;
      }

      if (rate != null && rate > 0) {
        final result = amountTRY / rate;
        debugPrint('💱 [convertFromTRY] $amountTRY TRY → ${_currency.code}');
        debugPrint('   Using TCMB rate: $rate, Result: $result');
        return result;
      }
    }

    // Fallback to ExchangeRateService
    final converted = _exchangeService.convert(
      amountTRY,
      'TRY',
      _currency.code,
    );
    return converted ?? amountTRY;
  }

  /// Format amount converting from TRY if needed
  String formatFromTRY(double amountTRY, {int decimalDigits = 0}) {
    final converted = convertFromTRY(amountTRY);
    return CurrencyPreferenceService.format(
      _currency,
      converted,
      decimalDigits: decimalDigits,
    );
  }

  /// Convert amount from current currency TO TRY
  /// Uses TCMB rates first (most accurate)
  double convertToTRY(double amount) {
    if (_currency.code == 'TRY') return amount;

    // Try TCMB rates first
    if (_tcmbRates != null) {
      double? rate;
      switch (_currency.code) {
        case 'USD':
          rate = _tcmbRates!.usdRate;
          break;
        case 'EUR':
          rate = _tcmbRates!.eurRate;
          break;
        case 'GBP':
          rate = _tcmbRates!.usdRate * 1.27;
          break;
        case 'SAR':
          rate = _tcmbRates!.usdRate / 3.75;
          break;
      }

      if (rate != null && rate > 0) {
        final result = amount * rate;
        debugPrint('💱 [convertToTRY] $amount ${_currency.code} → TRY');
        debugPrint('   Using TCMB rate: $rate, Result: $result');
        return result;
      }
    }

    // Fallback to ExchangeRateService
    final converted = _exchangeService.convert(amount, _currency.code, 'TRY');
    return converted ?? amount;
  }

  /// Get TCMB rates (for direct access if needed)
  ExchangeRates? get tcmbRates => _tcmbRates;

  /// Check if we have valid TCMB rates
  bool get hasTcmbRates => _tcmbRates != null;

  // ═══════════════════════════════════════════════════════════════════
  // SALARY CONVERSION METHODS
  // ═══════════════════════════════════════════════════════════════════

  /// Convert a single income source to target currency
  /// Returns a new IncomeSource with converted amount, preserving original values
  IncomeSource? convertIncomeSource(
    IncomeSource source,
    String targetCurrency,
  ) {
    if (source.originalCurrencyCode == targetCurrency) {
      // Same as original - return with original amount
      return source.convertedTo(
        newAmount: source.originalAmount,
        newCurrencyCode: targetCurrency,
      );
    }

    final converted = _exchangeService.convert(
      source.originalAmount,
      source.originalCurrencyCode,
      targetCurrency,
    );

    if (converted == null) return null;

    return source.convertedTo(
      newAmount: converted,
      newCurrencyCode: targetCurrency,
    );
  }

  /// Convert all income sources to target currency
  /// Returns list of converted IncomeSource objects
  List<IncomeSource>? convertIncomeSources(
    List<IncomeSource> sources,
    String targetCurrency,
  ) {
    final converted = <IncomeSource>[];

    for (final source in sources) {
      final convertedSource = convertIncomeSource(source, targetCurrency);
      if (convertedSource == null) return null;
      converted.add(convertedSource);
    }

    return converted;
  }

  /// Get formatted salary conversion info for display
  /// Returns a string like "25,000 TL → $725" or null if conversion fails
  String? getSalaryConversionInfo({
    required double originalAmount,
    required String originalCurrency,
    required String targetCurrency,
  }) {
    if (originalCurrency == targetCurrency) return null;

    final converted = _exchangeService.convert(
      originalAmount,
      originalCurrency,
      targetCurrency,
    );

    if (converted == null) return null;

    final originalCurrencyObj = getCurrencyByCode(originalCurrency);
    final targetCurrencyObj = getCurrencyByCode(targetCurrency);

    final originalFormatted = CurrencyPreferenceService.format(
      originalCurrencyObj,
      originalAmount,
      decimalDigits: 0,
    );

    final convertedFormatted = CurrencyPreferenceService.format(
      targetCurrencyObj,
      converted,
      decimalDigits: 0,
    );

    return '$originalFormatted → $convertedFormatted';
  }
}


--- FILE: lib/providers/pro_provider.dart ---

import 'dart:async';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:flutter/foundation.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:vantag/services/analytics_service.dart';
import 'package:vantag/services/purchase_service.dart';

/// Provider for Pro subscription status (RevenueCat + Firestore promo override)
class ProProvider extends ChangeNotifier {
  static const _keyIsPro = 'is_pro_user';
  static const _keyIsPromo = 'is_promo_user';

  bool _isPro = false;
  bool _isPromo = false; // Firestore promo_users override
  bool _isLoading = true;
  String? _promoType; // "gift", "tester", "influencer"
  StreamSubscription<bool>? _proStatusSubscription;
  StreamSubscription<DocumentSnapshot>? _promoSubscription;

  bool get isPro => _isPro || _isPromo;
  bool get isPromo => _isPromo;
  String? get promoType => _promoType;
  bool get isLoading => _isLoading;

  /// Initialize and load Pro status from RevenueCat + Firestore
  Future<void> initialize() async {
    _isLoading = true;
    notifyListeners();

    try {
      // 0. Login to RevenueCat with Firebase UID (links purchases to user)
      final user = FirebaseAuth.instance.currentUser;
      if (user != null && !user.isAnonymous) {
        try {
          await PurchaseService().login(user.uid);
          debugPrint('✅ [ProProvider] RevenueCat login: ${user.uid}');
        } catch (e) {
          debugPrint('⚠️ [ProProvider] RevenueCat login error: $e');
        }
      }

      // 1. Check RevenueCat entitlement
      _isPro = await PurchaseService().checkProStatus();
      debugPrint('📊 [ProProvider] RevenueCat Pro status: $_isPro');

      // 2. Check Firestore promo_users collection
      await _checkPromoStatus();

      // Fallback to local storage if both fail
      if (!_isPro && !_isPromo) {
        final prefs = await SharedPreferences.getInstance();
        _isPro = prefs.getBool(_keyIsPro) ?? false;
        _isPromo = prefs.getBool(_keyIsPromo) ?? false;
      }

      // Listen to RevenueCat status changes
      _proStatusSubscription = PurchaseService().proStatusStream.listen((
        isPro,
      ) {
        _setPro(isPro);
      });

      // Listen to Firestore promo_users changes
      _listenToPromoStatus();
    } catch (e) {
      debugPrint('ProProvider initialization error: $e');
      // Fallback to local storage
      final prefs = await SharedPreferences.getInstance();
      _isPro = prefs.getBool(_keyIsPro) ?? false;
      _isPromo = prefs.getBool(_keyIsPromo) ?? false;
    } finally {
      _isLoading = false;
      debugPrint(
        '✅ [ProProvider] Initialized - isPro: $isPro (RevenueCat: $_isPro, Promo: $_isPromo)',
      );
      // Set user type at initialization
      AnalyticsService().setUserType(isPro);
      notifyListeners();
    }
  }

  /// Check Firestore promo_users collection for current user
  Future<void> _checkPromoStatus() async {
    final user = FirebaseAuth.instance.currentUser;
    if (user == null) {
      _isPromo = false;
      _promoType = null;
      return;
    }

    try {
      final doc = await FirebaseFirestore.instance
          .collection('promo_users')
          .doc(user.uid)
          .get();

      if (doc.exists) {
        _isPromo = true;
        _promoType = doc.data()?['type'] as String?;
        debugPrint(
          '✅ [ProProvider] Promo user found: ${user.uid}, type: $_promoType',
        );

        // Persist locally
        final prefs = await SharedPreferences.getInstance();
        await prefs.setBool(_keyIsPromo, true);
      } else {
        _isPromo = false;
        _promoType = null;
      }
    } catch (e) {
      debugPrint('❌ [ProProvider] Promo check error: $e');
      // Don't change status on error, keep previous value
    }
  }

  /// Listen to Firestore promo_users changes in real-time
  void _listenToPromoStatus() {
    final user = FirebaseAuth.instance.currentUser;
    if (user == null) return;

    _promoSubscription?.cancel();
    _promoSubscription = FirebaseFirestore.instance
        .collection('promo_users')
        .doc(user.uid)
        .snapshots()
        .listen(
          (snapshot) {
            final wasPromo = _isPromo;

            if (snapshot.exists) {
              _isPromo = true;
              _promoType = snapshot.data()?['type'] as String?;
            } else {
              _isPromo = false;
              _promoType = null;
            }

            if (wasPromo != _isPromo) {
              debugPrint('🔄 [ProProvider] Promo status changed: $_isPromo');
              notifyListeners();
              _persistPromoStatus(_isPromo);
            }
          },
          onError: (e) {
            debugPrint('❌ [ProProvider] Promo listener error: $e');
          },
        );
  }

  /// Persist promo status to local storage
  Future<void> _persistPromoStatus(bool value) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_keyIsPromo, value);
  }

  /// Internal setter for RevenueCat status
  void _setPro(bool value) {
    if (_isPro != value) {
      _isPro = value;
      notifyListeners();
      _persistProStatus(value);
      // Track user type change for analytics
      AnalyticsService().setUserType(isPro);
    }
  }

  /// Persist Pro status to local storage (backup)
  Future<void> _persistProStatus(bool value) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_keyIsPro, value);
  }

  /// Set Pro status (called after successful purchase)
  Future<void> setPro(bool value) async {
    _isPro = value;
    notifyListeners();
    await _persistProStatus(value);
  }

  /// Toggle Pro status (for testing only)
  Future<void> togglePro() async {
    await setPro(!_isPro);
  }

  /// Refresh Pro status from RevenueCat + Firestore
  Future<void> refresh() async {
    _isLoading = true;
    notifyListeners();

    try {
      // Ensure RevenueCat is logged in with correct user
      final user = FirebaseAuth.instance.currentUser;
      if (user != null && !user.isAnonymous) {
        await PurchaseService().login(user.uid);
      }

      _isPro = await PurchaseService().checkProStatus();
      await _checkPromoStatus();
      debugPrint('🔄 [ProProvider] Refreshed - isPro: $isPro');
    } catch (e) {
      debugPrint('ProProvider refresh error: $e');
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  /// Called when user logs in - re-check promo status and RevenueCat
  Future<void> onUserLogin() async {
    final user = FirebaseAuth.instance.currentUser;
    if (user == null) return;

    debugPrint('🔐 [ProProvider] User login detected: ${user.uid}');

    // 1. Login to RevenueCat with Firebase UID (links purchases to user)
    try {
      await PurchaseService().login(user.uid);
      debugPrint('✅ [ProProvider] RevenueCat login successful');
    } catch (e) {
      debugPrint('❌ [ProProvider] RevenueCat login error: $e');
    }

    // 2. Re-check RevenueCat Pro status (fetch from server)
    try {
      _isPro = await PurchaseService().checkProStatus();
      debugPrint('📊 [ProProvider] RevenueCat Pro status: $_isPro');

      // Persist to local storage
      if (_isPro) {
        await _persistProStatus(true);
      }
    } catch (e) {
      debugPrint('❌ [ProProvider] RevenueCat status check error: $e');
    }

    // 3. Check Firestore promo_users collection
    await _checkPromoStatus();
    _listenToPromoStatus();

    debugPrint(
      '✅ [ProProvider] Final isPro: $isPro (RevenueCat: $_isPro, Promo: $_isPromo)',
    );
    notifyListeners();
  }

  /// Called when user logs out - clear promo status
  Future<void> onUserLogout() async {
    _promoSubscription?.cancel();
    _isPromo = false;
    _promoType = null;

    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_keyIsPromo, false);

    notifyListeners();
  }

  @override
  void dispose() {
    _proStatusSubscription?.cancel();
    _promoSubscription?.cancel();
    super.dispose();
  }
}


--- FILE: lib/providers/pursuit_provider.dart ---

import 'package:flutter/foundation.dart';
import '../models/models.dart';
import '../services/pursuit_service.dart';

/// Provider for managing pursuits (savings goals) state
class PursuitProvider extends ChangeNotifier {
  final PursuitService _service = PursuitService();

  List<Pursuit> _pursuits = [];
  bool _isLoading = false;
  bool _isInitialized = false;
  String? _error;

  // ============================================
  // GETTERS
  // ============================================

  /// All pursuits (both active and completed)
  List<Pursuit> get allPursuits => List.unmodifiable(_pursuits);

  /// Active pursuits (not archived, not completed)
  List<Pursuit> get activePursuits =>
      _pursuits.where((p) => !p.isArchived && !p.isCompleted).toList()
        ..sort((a, b) => a.sortOrder.compareTo(b.sortOrder));

  /// Completed pursuits
  List<Pursuit> get completedPursuits =>
      _pursuits.where((p) => p.isCompleted).toList()..sort(
        (a, b) => (b.completedAt ?? b.updatedAt).compareTo(
          a.completedAt ?? a.updatedAt,
        ),
      );

  /// Total saved amount across all active pursuits
  double get totalSaved =>
      activePursuits.fold(0.0, (sum, p) => sum + p.savedAmount);

  /// Total target amount across all active pursuits
  double get totalTarget =>
      activePursuits.fold(0.0, (sum, p) => sum + p.targetAmount);

  /// Overall progress percentage (0.0 to 1.0)
  double get overallProgress =>
      totalTarget > 0 ? (totalSaved / totalTarget).clamp(0.0, 1.0) : 0.0;

  bool get isLoading => _isLoading;
  bool get isInitialized => _isInitialized;
  String? get error => _error;
  bool get hasError => _error != null;

  /// Number of active pursuits
  int get activePursuitCount => activePursuits.length;

  /// Number of completed pursuits
  int get completedPursuitCount => completedPursuits.length;

  // ============================================
  // INITIALIZATION
  // ============================================

  /// Initialize the provider and load pursuits
  Future<void> initialize() async {
    if (_isInitialized) return;

    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      _pursuits = await _service.getAllPursuits();
      _isInitialized = true;
    } catch (e) {
      _error = e.toString();
      debugPrint('PursuitProvider initialization error: $e');
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  /// Refresh pursuits from storage
  Future<void> refresh() async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      _pursuits = await _service.getAllPursuits();
    } catch (e) {
      _error = e.toString();
      debugPrint('PursuitProvider refresh error: $e');
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  // ============================================
  // CRUD OPERATIONS
  // ============================================

  /// Create a new pursuit
  /// Returns true if successful, false if limit reached (free tier)
  Future<bool> createPursuit(Pursuit pursuit, {bool isPremium = false}) async {
    final canCreate = await _service.canCreatePursuit(isPremium);
    if (!canCreate) {
      return false;
    }

    try {
      await _service.createPursuit(pursuit);
      _pursuits.insert(0, pursuit);
      notifyListeners();
      return true;
    } catch (e) {
      _error = e.toString();
      debugPrint('PursuitProvider createPursuit error: $e');
      notifyListeners();
      return false;
    }
  }

  /// Update an existing pursuit
  Future<void> updatePursuit(Pursuit pursuit) async {
    try {
      await _service.updatePursuit(pursuit);
      final index = _pursuits.indexWhere((p) => p.id == pursuit.id);
      if (index != -1) {
        _pursuits[index] = pursuit.copyWith(updatedAt: DateTime.now());
        notifyListeners();
      }
    } catch (e) {
      _error = e.toString();
      debugPrint('PursuitProvider updatePursuit error: $e');
      notifyListeners();
    }
  }

  /// Add savings to a pursuit
  /// Returns true if pursuit reached 100% (for celebration)
  Future<bool> addSavings(
    String pursuitId,
    double amount, {
    TransactionSource source = TransactionSource.manual,
    String? note,
    String? currency,
  }) async {
    try {
      await _service.addSavings(
        pursuitId,
        amount,
        source,
        note: note,
        currency: currency,
      );

      final index = _pursuits.indexWhere((p) => p.id == pursuitId);
      if (index != -1) {
        final pursuit = _pursuits[index];
        final newSavedAmount = pursuit.savedAmount + amount;
        final updated = pursuit.copyWith(
          savedAmount: newSavedAmount,
          updatedAt: DateTime.now(),
        );
        _pursuits[index] = updated;
        notifyListeners();

        // Check if pursuit reached target
        return updated.hasReachedTarget && !pursuit.hasReachedTarget;
      }
      return false;
    } catch (e) {
      _error = e.toString();
      debugPrint('PursuitProvider addSavings error: $e');
      notifyListeners();
      return false;
    }
  }

  /// Mark a pursuit as completed
  Future<void> completePursuit(String pursuitId) async {
    try {
      await _service.completePursuit(pursuitId);

      final index = _pursuits.indexWhere((p) => p.id == pursuitId);
      if (index != -1) {
        _pursuits[index] = _pursuits[index].copyWith(
          completedAt: DateTime.now(),
          updatedAt: DateTime.now(),
        );
        notifyListeners();
      }
    } catch (e) {
      _error = e.toString();
      debugPrint('PursuitProvider completePursuit error: $e');
      notifyListeners();
    }
  }

  /// Archive a pursuit (soft delete)
  Future<void> archivePursuit(String pursuitId) async {
    try {
      await _service.archivePursuit(pursuitId);

      final index = _pursuits.indexWhere((p) => p.id == pursuitId);
      if (index != -1) {
        _pursuits[index] = _pursuits[index].copyWith(
          isArchived: true,
          updatedAt: DateTime.now(),
        );
        notifyListeners();
      }
    } catch (e) {
      _error = e.toString();
      debugPrint('PursuitProvider archivePursuit error: $e');
      notifyListeners();
    }
  }

  /// Delete a pursuit permanently
  Future<void> deletePursuit(String pursuitId) async {
    try {
      await _service.deletePursuit(pursuitId);
      _pursuits.removeWhere((p) => p.id == pursuitId);
      notifyListeners();
    } catch (e) {
      _error = e.toString();
      debugPrint('PursuitProvider deletePursuit error: $e');
      notifyListeners();
    }
  }

  // ============================================
  // UTILITY METHODS
  // ============================================

  /// Get a pursuit by ID
  Pursuit? getPursuitById(String id) {
    try {
      return _pursuits.firstWhere((p) => p.id == id);
    } catch (e) {
      return null;
    }
  }

  /// Get transactions for a pursuit
  Future<List<PursuitTransaction>> getTransactions(String pursuitId) async {
    return await _service.getTransactions(pursuitId);
  }

  /// Check if user can create a new pursuit
  Future<bool> canCreatePursuit(bool isPremium) async {
    return await _service.canCreatePursuit(isPremium);
  }

  /// Clear error state
  void clearError() {
    _error = null;
    notifyListeners();
  }

  /// Sync from Firestore (for restore)
  Future<void> syncFromCloud() async {
    _isLoading = true;
    notifyListeners();

    try {
      await _service.syncFromFirestore();
      _pursuits = await _service.getAllPursuits();
    } catch (e) {
      _error = e.toString();
      debugPrint('PursuitProvider syncFromCloud error: $e');
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  /// Sync to Firestore (for backup)
  Future<void> syncToCloud() async {
    try {
      await _service.syncAllToFirestore();
    } catch (e) {
      _error = e.toString();
      debugPrint('PursuitProvider syncToCloud error: $e');
      notifyListeners();
    }
  }
}


--- FILE: lib/providers/providers.dart ---

// Providers barrel export
export 'finance_provider.dart';
export 'locale_provider.dart';
export 'currency_provider.dart';
export 'pro_provider.dart';
export 'pursuit_provider.dart';
export 'savings_pool_provider.dart';
export 'theme_provider.dart';
export 'category_budget_provider.dart';


--- FILE: lib/providers/theme_provider.dart ---

import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';

/// Theme modes supported by the app
enum AppThemeMode { dark, light, automatic }

/// Provider for managing app theme (dark/light mode)
class ThemeProvider extends ChangeNotifier {
  static const String _themeKey = 'app_theme_mode';

  // Time-based automatic theme settings
  static const int _dayStartHour = 7; // 07:00 - Light mode starts
  static const int _nightStartHour = 19; // 19:00 - Dark mode starts

  AppThemeMode _themeMode = AppThemeMode.dark;
  bool _isInitialized = false;

  /// Current theme mode
  AppThemeMode get themeMode => _themeMode;

  /// Whether the provider has been initialized
  bool get isInitialized => _isInitialized;

  /// Get the current ThemeMode for MaterialApp
  ThemeMode get materialThemeMode {
    switch (_themeMode) {
      case AppThemeMode.dark:
        return ThemeMode.dark;
      case AppThemeMode.light:
        return ThemeMode.light;
      case AppThemeMode.automatic:
        // Time-based: 07:00-19:00 light, 19:00-07:00 dark
        return _isNightTime() ? ThemeMode.dark : ThemeMode.light;
    }
  }

  /// Check if current time is night time (19:00 - 07:00)
  bool _isNightTime() {
    final hour = DateTime.now().hour;
    return hour >= _nightStartHour || hour < _dayStartHour;
  }

  /// Whether dark mode is currently active
  bool isDarkMode(BuildContext context) {
    if (_themeMode == AppThemeMode.automatic) {
      return _isNightTime();
    }
    return _themeMode == AppThemeMode.dark;
  }

  /// Initialize theme from storage
  Future<void> initialize() async {
    if (_isInitialized) return;

    final prefs = await SharedPreferences.getInstance();
    final savedTheme = prefs.getString(_themeKey);

    if (savedTheme != null) {
      // Handle migration from old 'system' value to 'automatic'
      if (savedTheme == 'system') {
        _themeMode = AppThemeMode.automatic;
        await prefs.setString(_themeKey, 'automatic');
      } else {
        _themeMode = AppThemeMode.values.firstWhere(
          (mode) => mode.name == savedTheme,
          orElse: () => AppThemeMode.dark,
        );
      }
    }
    // Default is dark (already set in field initialization)

    _isInitialized = true;
    notifyListeners();
  }

  /// Refresh theme - call when app comes to foreground
  /// This rechecks the time for automatic mode
  void refreshTheme() {
    if (_themeMode == AppThemeMode.automatic) {
      notifyListeners();
    }
  }

  /// Set theme mode
  Future<void> setThemeMode(AppThemeMode mode) async {
    if (_themeMode == mode) return;

    _themeMode = mode;
    notifyListeners();

    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(_themeKey, mode.name);
  }

  /// Toggle between dark and light mode
  Future<void> toggleTheme() async {
    final newMode = _themeMode == AppThemeMode.dark
        ? AppThemeMode.light
        : AppThemeMode.dark;
    await setThemeMode(newMode);
  }

  /// Get theme mode display name (deprecated - use localization instead)
  String getThemeModeName(BuildContext context, AppThemeMode mode) {
    switch (mode) {
      case AppThemeMode.dark:
        return 'Dark';
      case AppThemeMode.light:
        return 'Light';
      case AppThemeMode.automatic:
        return 'Automatic';
    }
  }
}


--- FILE: lib/providers/savings_pool_provider.dart ---

import 'dart:async';
import 'package:flutter/foundation.dart';
import '../models/savings_pool.dart';
import '../services/savings_pool_service.dart';

/// Tasarruf Havuzu State Provider
class SavingsPoolProvider extends ChangeNotifier {
  final SavingsPoolService _service = SavingsPoolService();

  SavingsPool _pool = SavingsPool.empty();
  StreamSubscription<SavingsPool>? _subscription;
  bool _isLoading = true;
  String? _error;

  // Getters
  SavingsPool get pool => _pool;
  bool get isLoading => _isLoading;
  String? get error => _error;

  double get totalSaved => _pool.totalSaved;
  double get allocatedToDreams => _pool.allocatedToDreams;
  double get available => _pool.available;
  double get shadowDebt => _pool.shadowDebt;
  bool get hasDebt => _pool.hasDebt;
  bool get canUseJoker => _pool.canUseJoker;
  bool get jokerUsedThisMonth => _pool.jokerUsedThisMonth;

  /// Provider'ı başlat ve stream'e bağlan
  Future<void> initialize() async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      // İlk olarak local'den yükle (hızlı başlangıç için)
      _pool = await _service.getPool();
      _isLoading = false;
      notifyListeners();
      debugPrint(
        '💰 [SavingsPoolProvider] Initial load: available=${_pool.available}, debt=${_pool.shadowDebt}',
      );

      // Aylık joker reset kontrolü
      await _service.resetMonthlyJoker();

      // Stream'e bağlan (background updates için)
      _subscription?.cancel();
      _subscription = _service.poolStream.listen(
        (pool) {
          _pool = pool;
          _isLoading = false;
          _error = null;
          notifyListeners();
          debugPrint(
            '💰 [SavingsPoolProvider] Pool updated: available=${pool.available}, debt=${pool.shadowDebt}',
          );
        },
        onError: (e) {
          // Stream hatası olsa bile local data'yı kullan, loading'i kapat
          _error = e.toString();
          _isLoading = false;
          notifyListeners();
          debugPrint('❌ [SavingsPoolProvider] Stream error: $e');
        },
      );
    } catch (e) {
      _error = e.toString();
      _isLoading = false;
      notifyListeners();
      debugPrint('❌ [SavingsPoolProvider] Initialize error: $e');
    }
  }

  /// Tasarruf ekle (vazgeçme durumunda)
  Future<void> addSavings(double amount) async {
    if (amount <= 0) return;

    try {
      await _service.addSavings(amount);
      debugPrint('✅ [SavingsPoolProvider] Added savings: $amount');
    } catch (e) {
      _error = e.toString();
      notifyListeners();
      debugPrint('❌ [SavingsPoolProvider] addSavings error: $e');
    }
  }

  /// Hayale para ayır
  /// Returns true if successful, false if needs budget shift dialog
  Future<AllocationResult> allocateToDream(
    double amount,
    String dreamId, {
    BudgetShiftSource? source,
  }) async {
    if (amount <= 0) {
      return AllocationResult.error('Invalid amount');
    }

    // Yeterli bakiye var mı kontrol et
    if (source == null && available < amount) {
      if (available > 0) {
        // Kısmi bakiye var, bütçe kaydırma gerekiyor
        return AllocationResult.needsBudgetShift(amount - available);
      } else {
        // Hiç bakiye yok, tam kaynak belirtmeli
        return AllocationResult.needsFullSource(amount);
      }
    }

    try {
      final success = await _service.allocateToDream(
        amount,
        dreamId,
        source: source,
      );
      if (success) {
        return AllocationResult.success();
      } else {
        if (source == BudgetShiftSource.joker && jokerUsedThisMonth) {
          return AllocationResult.jokerAlreadyUsed();
        }
        return AllocationResult.error('Allocation failed');
      }
    } catch (e) {
      _error = e.toString();
      notifyListeners();
      return AllocationResult.error(e.toString());
    }
  }

  /// Joker kullan
  Future<bool> useJoker(double amount, String dreamId) async {
    if (!canUseJoker) return false;

    final result = await allocateToDream(
      amount,
      dreamId,
      source: BudgetShiftSource.joker,
    );
    return result.isSuccess;
  }

  /// Gölge borç oluştur
  Future<void> createShadowDebt(double amount, String dreamId) async {
    try {
      await _service.createShadowDebt(amount, dreamId);
    } catch (e) {
      _error = e.toString();
      notifyListeners();
    }
  }

  /// Borç öde
  Future<void> repayDebt(double amount) async {
    try {
      await _service.repayDebt(amount);
    } catch (e) {
      _error = e.toString();
      notifyListeners();
    }
  }

  /// Hayalden para geri al (hayal silindiğinde veya tamamlandığında)
  Future<void> deallocateFromDream(double amount) async {
    try {
      await _service.deallocateFromDream(amount);
    } catch (e) {
      _error = e.toString();
      notifyListeners();
    }
  }

  /// Yenile
  Future<void> refresh() async {
    await initialize();
  }

  @override
  void dispose() {
    _subscription?.cancel();
    super.dispose();
  }
}

/// Havuz allocation sonucu
class AllocationResult {
  final AllocationStatus status;
  final double? shortfall; // Eksik miktar
  final String? errorMessage;

  const AllocationResult._({
    required this.status,
    this.shortfall,
    this.errorMessage,
  });

  factory AllocationResult.success() =>
      const AllocationResult._(status: AllocationStatus.success);

  factory AllocationResult.needsBudgetShift(double shortfall) =>
      AllocationResult._(
        status: AllocationStatus.needsBudgetShift,
        shortfall: shortfall,
      );

  factory AllocationResult.needsFullSource(double amount) => AllocationResult._(
    status: AllocationStatus.needsFullSource,
    shortfall: amount,
  );

  factory AllocationResult.jokerAlreadyUsed() =>
      const AllocationResult._(status: AllocationStatus.jokerAlreadyUsed);

  factory AllocationResult.error(String message) =>
      AllocationResult._(status: AllocationStatus.error, errorMessage: message);

  bool get isSuccess => status == AllocationStatus.success;
  bool get needsBudgetShift => status == AllocationStatus.needsBudgetShift;
  bool get needsFullSource => status == AllocationStatus.needsFullSource;
  bool get isJokerAlreadyUsed => status == AllocationStatus.jokerAlreadyUsed;
  bool get isError => status == AllocationStatus.error;
}

enum AllocationStatus {
  success,
  needsBudgetShift,
  needsFullSource,
  jokerAlreadyUsed,
  error,
}


--- FILE: lib/firebase_options.dart ---

// File generated by FlutterFire CLI.
// ignore_for_file: type=lint
import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
import 'package:flutter/foundation.dart'
    show defaultTargetPlatform, kIsWeb, TargetPlatform;

/// Default [FirebaseOptions] for use with your Firebase apps.
///
/// Example:
/// ```dart
/// import 'firebase_options.dart';
/// // ...
/// await Firebase.initializeApp(
///   options: DefaultFirebaseOptions.currentPlatform,
/// );
/// ```
class DefaultFirebaseOptions {
  static FirebaseOptions get currentPlatform {
    if (kIsWeb) {
      return web;
    }
    switch (defaultTargetPlatform) {
      case TargetPlatform.android:
        return android;
      case TargetPlatform.iOS:
        return ios;
      case TargetPlatform.macOS:
        return macos;
      case TargetPlatform.windows:
        return windows;
      case TargetPlatform.linux:
        throw UnsupportedError(
          'DefaultFirebaseOptions have not been configured for linux - '
          'you can reconfigure this by running the FlutterFire CLI again.',
        );
      default:
        throw UnsupportedError(
          'DefaultFirebaseOptions are not supported for this platform.',
        );
    }
  }

  static const FirebaseOptions web = FirebaseOptions(
    apiKey: 'AIzaSyAQVP-oTs9H0GH9D-zKw6aYzjDEnlZcjcg',
    appId: '1:240571866446:web:43360c5e28810922f4121f',
    messagingSenderId: '240571866446',
    projectId: 'flutter-ai-playground-b188b',
    authDomain: 'flutter-ai-playground-b188b.firebaseapp.com',
    storageBucket: 'flutter-ai-playground-b188b.firebasestorage.app',
  );

  static const FirebaseOptions android = FirebaseOptions(
    apiKey: 'AIzaSyBsYnOnzX0JYGVsWY9zAiBU9bNsL2fA9T4',
    appId: '1:240571866446:android:dda6b905f909c210f4121f',
    messagingSenderId: '240571866446',
    projectId: 'flutter-ai-playground-b188b',
    storageBucket: 'flutter-ai-playground-b188b.firebasestorage.app',
  );

  static const FirebaseOptions ios = FirebaseOptions(
    apiKey: 'AIzaSyDvNjRGOSL-vp5tYfOy6k_4iFXXsKfP9WY',
    appId: '1:240571866446:ios:3d86e8be3329a06df4121f',
    messagingSenderId: '240571866446',
    projectId: 'flutter-ai-playground-b188b',
    storageBucket: 'flutter-ai-playground-b188b.firebasestorage.app',
    iosBundleId: 'com.vantag.app',
  );

  static const FirebaseOptions macos = FirebaseOptions(
    apiKey: 'AIzaSyDvNjRGOSL-vp5tYfOy6k_4iFXXsKfP9WY',
    appId: '1:240571866446:ios:0e7af21024f900a4f4121f',
    messagingSenderId: '240571866446',
    projectId: 'flutter-ai-playground-b188b',
    storageBucket: 'flutter-ai-playground-b188b.firebasestorage.app',
    iosBundleId: 'com.example.mmrApp',
  );

  static const FirebaseOptions windows = FirebaseOptions(
    apiKey: 'AIzaSyAQVP-oTs9H0GH9D-zKw6aYzjDEnlZcjcg',
    appId: '1:240571866446:web:d63cda7c2c20d8bbf4121f',
    messagingSenderId: '240571866446',
    projectId: 'flutter-ai-playground-b188b',
    authDomain: 'flutter-ai-playground-b188b.firebaseapp.com',
    storageBucket: 'flutter-ai-playground-b188b.firebasestorage.app',
  );
}


--- FILE: lib/utils/habit_calculator.dart ---

// Viral Alışkanlık Hesaplayıcı
// Kullanıcının alışkanlıkları için yılda kaç gün çalıştığını hesaplar

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:vantag/l10n/app_localizations.dart';
import 'package:vantag/theme/app_theme.dart';

class HabitCategory {
  final String key; // Localization key
  final String name; // Display name (localized)
  final IconData icon;
  final Color color;

  const HabitCategory(this.key, this.name, this.icon, this.color);
}

/// Category definitions with icons and colors (key-based)
class HabitCategoryDef {
  final String key;
  final IconData icon;
  final Color color;

  const HabitCategoryDef(this.key, this.icon, this.color);
}

final List<HabitCategoryDef> _habitCategoryDefs = [
  HabitCategoryDef('coffee', CupertinoIcons.cart_fill, AppColors.coffeeColor),
  HabitCategoryDef(
    'smoking',
    CupertinoIcons.cloud_fill,
    AppColors.smokingGray,
  ),
  HabitCategoryDef(
    'eatingOut',
    CupertinoIcons.cart_fill,
    AppColors.categoryFood,
  ),
  HabitCategoryDef(
    'gaming',
    CupertinoIcons.gamecontroller_fill,
    AppColors.categoryBills,
  ),
  HabitCategoryDef(
    'clothing',
    CupertinoIcons.tag_fill,
    AppColors.categoryShopping,
  ),
  HabitCategoryDef('taxi', CupertinoIcons.car_fill, AppColors.secondary),
];

/// Get localized category name from key
String getLocalizedHabitCategory(String key, AppLocalizations l10n) {
  switch (key) {
    case 'coffee':
      return l10n.habitCatCoffee;
    case 'smoking':
      return l10n.habitCatSmoking;
    case 'eatingOut':
      return l10n.habitCatEatingOut;
    case 'gaming':
      return l10n.habitCatGaming;
    case 'clothing':
      return l10n.habitCatClothing;
    case 'taxi':
      return l10n.habitCatTaxi;
    default:
      return key;
  }
}

/// Get localized habit categories list (call with l10n context)
List<HabitCategory> getLocalizedHabitCategories(AppLocalizations l10n) {
  return _habitCategoryDefs
      .map(
        (def) => HabitCategory(
          def.key,
          getLocalizedHabitCategory(def.key, l10n),
          def.icon,
          def.color,
        ),
      )
      .toList();
}

/// Legacy: for backward compatibility (returns Turkish names)
final List<HabitCategory> defaultHabitCategories = [
  HabitCategory(
    'coffee',
    'Kahve',
    CupertinoIcons.cart_fill,
    AppColors.coffeeColor,
  ),
  HabitCategory(
    'smoking',
    'Sigara',
    CupertinoIcons.cloud_fill,
    AppColors.smokingGray,
  ),
  HabitCategory(
    'eatingOut',
    'Dışarıda Yemek',
    CupertinoIcons.cart_fill,
    AppColors.categoryFood,
  ),
  HabitCategory(
    'gaming',
    'Oyun/Eğlence',
    CupertinoIcons.gamecontroller_fill,
    AppColors.categoryBills,
  ),
  HabitCategory(
    'clothing',
    'Kıyafet',
    CupertinoIcons.tag_fill,
    AppColors.categoryShopping,
  ),
  HabitCategory(
    'taxi',
    'Taksi/Uber',
    CupertinoIcons.car_fill,
    AppColors.secondary,
  ),
];

class HabitResult {
  final double yearlyAmount;
  final int yearlyDays;
  final int monthlyDays;
  final int monthlyExtraHours;
  final double monthlyAmount;

  const HabitResult({
    required this.yearlyAmount,
    required this.yearlyDays,
    required this.monthlyDays,
    required this.monthlyExtraHours,
    required this.monthlyAmount,
  });
}

class HabitCalculator {
  /// Frequency keys with their multipliers
  static const Map<String, int> frequencyMultipliers = {
    'onceDaily': 365,
    'twiceDaily': 730,
    'everyTwoDays': 182,
    'onceWeekly': 52,
    'twoThreeWeekly': 130,
    'fewMonthly': 24,
  };

  /// Frequency keys (use getLocalizedFrequencies for display)
  static const List<String> frequencyKeys = [
    'onceDaily',
    'twiceDaily',
    'everyTwoDays',
    'onceWeekly',
    'twoThreeWeekly',
    'fewMonthly',
  ];

  /// Get localized frequency name from key
  static String getLocalizedFrequency(String key, AppLocalizations l10n) {
    switch (key) {
      case 'onceDaily':
        return l10n.freqOnceDaily;
      case 'twiceDaily':
        return l10n.freqTwiceDaily;
      case 'everyTwoDays':
        return l10n.freqEveryTwoDays;
      case 'onceWeekly':
        return l10n.freqOnceWeekly;
      case 'twoThreeWeekly':
        return l10n.freqTwoThreeWeekly;
      case 'fewMonthly':
        return l10n.freqFewMonthly;
      default:
        return key;
    }
  }

  /// Get list of localized frequency strings
  static List<String> getLocalizedFrequencies(AppLocalizations l10n) {
    return frequencyKeys
        .map((key) => getLocalizedFrequency(key, l10n))
        .toList();
  }

  /// Legacy: for backward compatibility (Turkish names)
  static const List<String> frequencies = [
    'Günde 1',
    'Günde 2',
    '2 günde 1',
    'Haftada 1',
    'Haftada 2-3',
    'Ayda birkaç',
  ];

  /// Alışkanlık maliyetini hesapla
  /// [price] - Bir seferinde harcanan tutar (TL)
  /// [frequency] - Sıklık (frequencyMultipliers key'lerinden biri)
  /// [monthlyIncome] - Aylık gelir (TL)
  static HabitResult calculate({
    required double price,
    required String frequency,
    required double monthlyIncome,
  }) {
    final multiplier = frequencyMultipliers[frequency] ?? 365;
    final yearlyAmount = price * multiplier;
    final hourlyWage = monthlyIncome / 176; // aylık 176 saat (22 gün x 8 saat)
    final yearlyHours = yearlyAmount / hourlyWage;
    final yearlyDays = (yearlyHours / 8).round();

    final monthlyHours = yearlyHours / 12;
    final monthlyDays = (monthlyHours / 8).floor();
    final monthlyExtraHours = (monthlyHours % 8).round();
    final monthlyAmount = yearlyAmount / 12;

    return HabitResult(
      yearlyAmount: yearlyAmount,
      yearlyDays: yearlyDays,
      monthlyDays: monthlyDays,
      monthlyExtraHours: monthlyExtraHours,
      monthlyAmount: monthlyAmount,
    );
  }
}


--- FILE: lib/utils/duplicate_checker.dart ---

import '../models/expense.dart';

/// Harcama tekrar tespiti için yardımcı sınıf
class DuplicateChecker {
  /// Verilen parametrelerle eşleşen harcamaları bul
  /// Aynı gün + aynı kategori + aynı tutar olan harcamaları döndürür
  static List<DuplicateMatch> findDuplicates({
    required List<Expense> expenses,
    required double amount,
    required String category,
    DateTime? date,
  }) {
    final checkDate = date ?? DateTime.now();
    final matches = <DuplicateMatch>[];

    for (final expense in expenses) {
      // Aynı gün mü?
      if (!_isSameDay(expense.date, checkDate)) continue;

      // Aynı kategori mi?
      if (expense.category != category) continue;

      // Aynı tutar mı? (küçük farklılıklar için 0.01 tolerans)
      if ((expense.amount - amount).abs() > 0.01) continue;

      // Eşleşme bulundu
      final timeDiff = DateTime.now().difference(expense.date);
      matches.add(DuplicateMatch(expense: expense, timeSinceEntry: timeDiff));
    }

    // En yeni eşleşme önce
    matches.sort((a, b) => b.expense.date.compareTo(a.expense.date));
    return matches;
  }

  /// İki tarihin aynı gün olup olmadığını kontrol et
  static bool _isSameDay(DateTime a, DateTime b) {
    return a.year == b.year && a.month == b.month && a.day == b.day;
  }
}

/// Eşleşen harcama bilgisi
class DuplicateMatch {
  final Expense expense;
  final Duration timeSinceEntry;

  const DuplicateMatch({required this.expense, required this.timeSinceEntry});
}


--- FILE: lib/utils/finance_utils.dart ---

import '../models/expense.dart';

/// AI için finansal hesaplama yardımcı fonksiyonları

/// Bu ayki toplam harcamayı hesaplar
double calculateMonthlySpent(List<Expense> expenses) {
  final now = DateTime.now();
  return expenses
      .where(
        (e) =>
            e.date.month == now.month &&
            e.date.year == now.year &&
            e.decision == ExpenseDecision.yes,
      )
      .fold(0.0, (sum, e) => sum + e.amount);
}

/// Tutarı çalışma saati olarak formatlar
String formatAsHours(double amount, double hourlyRate) {
  if (hourlyRate <= 0) return '-';
  final hours = amount / hourlyRate;
  return '${hours.toStringAsFixed(1)}h';
}

/// Bu ayki tasarruf miktarını hesaplar (vazgeçilen + smart choice)
double calculateMonthlySaved(List<Expense> expenses) {
  final now = DateTime.now();
  return expenses
      .where((e) => e.date.month == now.month && e.date.year == now.year)
      .fold(0.0, (sum, e) {
        double saved = 0.0;
        // Vazgeçilen harcamalar
        if (e.decision == ExpenseDecision.no) {
          saved += e.amount;
        }
        // Smart Choice tasarrufları
        if (e.isSmartChoice && e.savedAmount > 0) {
          saved += e.savedAmount;
        }
        return sum + saved;
      });
}

/// Belirli bir kategorideki bu ayki harcamayı hesaplar
double calculateCategorySpent(List<Expense> expenses, String category) {
  final now = DateTime.now();
  return expenses
      .where(
        (e) =>
            e.date.month == now.month &&
            e.date.year == now.year &&
            e.category == category &&
            e.decision == ExpenseDecision.yes,
      )
      .fold(0.0, (sum, e) => sum + e.amount);
}

/// Günlük ortalama harcamayı hesaplar
double calculateDailyAverage(List<Expense> expenses) {
  final now = DateTime.now();
  final thisMonthExpenses = expenses.where(
    (e) =>
        e.date.month == now.month &&
        e.date.year == now.year &&
        e.decision == ExpenseDecision.yes,
  );

  if (thisMonthExpenses.isEmpty) return 0.0;

  final total = thisMonthExpenses.fold(0.0, (sum, e) => sum + e.amount);
  final daysInMonth = now.day;
  return total / daysInMonth;
}


--- FILE: lib/utils/utils.dart ---

// Utils barrel export
export 'currency_utils.dart';
export 'currency_helper.dart';
export 'habit_calculator.dart';
export 'category_utils.dart';
export 'achievement_utils.dart';
export 'finance_utils.dart';
export 'duplicate_checker.dart';
export 'global_merchants.dart';
export 'emoji_helper.dart';
export 'security_utils.dart';
export 'error_handler.dart';


--- FILE: lib/utils/category_utils.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:vantag/l10n/app_localizations.dart';
import 'package:vantag/theme/app_theme.dart';

/// Utility class for category localization
class CategoryUtils {
  /// Internal category keys (stored in database)
  static const List<String> internalKeys = [
    'Yiyecek',
    'Ulaşım',
    'Giyim',
    'Elektronik',
    'Eğlence',
    'Sağlık',
    'Eğitim',
    'Faturalar',
    'Abonelik',
    'Diğer',
  ];

  /// Get localized category name from internal key
  static String getLocalizedName(BuildContext context, String internalKey) {
    final l10n = AppLocalizations.of(context);

    switch (internalKey) {
      case 'Yiyecek':
        return l10n.categoryFood;
      case 'Ulaşım':
        return l10n.categoryTransport;
      case 'Giyim':
        return l10n.categoryClothing;
      case 'Elektronik':
        return l10n.categoryElectronics;
      case 'Eğlence':
        return l10n.categoryEntertainment;
      case 'Sağlık':
        return l10n.categoryHealth;
      case 'Eğitim':
        return l10n.categoryEducation;
      case 'Faturalar':
        return l10n.categoryBills;
      case 'Abonelik':
        return l10n.categorySubscription;
      case 'Diğer':
        return l10n.categoryOther;
      // Additional categories
      case 'Alışveriş':
        return l10n.categoryShopping;
      case 'Dijital':
        return l10n.categoryDigital;
      case 'Spor':
        return l10n.categorySports;
      case 'Haberleşme':
        return l10n.categoryCommunication;
      default:
        return internalKey;
    }
  }

  /// Get all categories as localized list
  static List<String> getLocalizedCategories(BuildContext context) {
    return internalKeys.map((key) => getLocalizedName(context, key)).toList();
  }

  /// Get localized full weekday name
  static String getLocalizedWeekday(BuildContext context, int weekday) {
    final l10n = AppLocalizations.of(context);

    switch (weekday) {
      case 1:
        return l10n.weekdayMonday;
      case 2:
        return l10n.weekdayTuesday;
      case 3:
        return l10n.weekdayWednesday;
      case 4:
        return l10n.weekdayThursday;
      case 5:
        return l10n.weekdayFriday;
      case 6:
        return l10n.weekdaySaturday;
      case 7:
        return l10n.weekdaySunday;
      default:
        return '';
    }
  }

  /// Get category icon (Cupertino icon)
  static IconData getIcon(String internalKey) {
    switch (internalKey) {
      case 'Yiyecek':
        return CupertinoIcons.cart_fill;
      case 'Ulaşım':
        return CupertinoIcons.car_fill;
      case 'Giyim':
        return CupertinoIcons.tag_fill;
      case 'Elektronik':
        return CupertinoIcons.device_phone_portrait;
      case 'Eğlence':
        return CupertinoIcons.gamecontroller_fill;
      case 'Sağlık':
        return CupertinoIcons.heart_fill;
      case 'Eğitim':
        return CupertinoIcons.book_fill;
      case 'Faturalar':
        return CupertinoIcons.doc_text_fill;
      case 'Abonelik':
        return CupertinoIcons.bell_fill;
      case 'Alışveriş':
        return CupertinoIcons.bag_fill;
      case 'Dijital':
        return CupertinoIcons.desktopcomputer;
      case 'Spor':
        return CupertinoIcons.sportscourt_fill;
      case 'Haberleşme':
        return CupertinoIcons.phone_fill;
      case 'Diğer':
      default:
        return CupertinoIcons.cube_box_fill;
    }
  }

  /// Get category color
  static Color getColor(String internalKey) {
    switch (internalKey) {
      case 'Yiyecek':
        return AppColors.categoryFood;
      case 'Ulaşım':
        return AppColors.categoryTransport;
      case 'Giyim':
        return AppColors.categoryShopping;
      case 'Elektronik':
        return AppColors.categoryEntertainment;
      case 'Eğlence':
        return AppColors.categoryBills;
      case 'Sağlık':
        return AppColors.categoryHealth;
      case 'Eğitim':
        return AppColors.categoryEducation;
      case 'Faturalar':
        return AppColors.categoryOther;
      case 'Abonelik':
        return AppColors.primary;
      case 'Alışveriş':
        return AppColors.categoryShoppingPink;
      case 'Dijital':
        return AppColors.categoryDigitalCyan;
      case 'Spor':
        return AppColors.categorySportsGreen;
      case 'Haberleşme':
        return AppColors.categoryCommGray;
      case 'Diğer':
      default:
        return AppColors.categoryDefault;
    }
  }
}


--- FILE: lib/utils/achievement_utils.dart ---

import 'package:flutter/material.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/achievement.dart';

/// Utility class for achievement localization
class AchievementUtils {
  /// Get localized tier label
  static String getTierLabel(BuildContext context, AchievementTier tier) {
    final l10n = AppLocalizations.of(context);

    switch (tier) {
      case AchievementTier.bronze:
        return l10n.tierBronze;
      case AchievementTier.silver:
        return l10n.tierSilver;
      case AchievementTier.gold:
        return l10n.tierGold;
      case AchievementTier.platinum:
        return l10n.tierPlatinum;
    }
  }

  /// Get localized category label
  static String getCategoryLabel(
    BuildContext context,
    AchievementCategory category,
  ) {
    final l10n = AppLocalizations.of(context);

    switch (category) {
      case AchievementCategory.streak:
        return l10n.achievementCategoryStreak;
      case AchievementCategory.savings:
        return l10n.achievementCategorySavings;
      case AchievementCategory.decision:
        return l10n.achievementCategoryDecision;
      case AchievementCategory.record:
        return l10n.achievementCategoryRecord;
      case AchievementCategory.hidden:
        return l10n.achievementCategoryHidden;
    }
  }

  /// Get localized difficulty label
  static String getDifficultyLabel(
    BuildContext context,
    HiddenDifficulty difficulty,
  ) {
    final l10n = AppLocalizations.of(context);

    switch (difficulty) {
      case HiddenDifficulty.easy:
        return l10n.difficultyEasy;
      case HiddenDifficulty.medium:
        return l10n.difficultyMedium;
      case HiddenDifficulty.hard:
        return l10n.difficultyHard;
      case HiddenDifficulty.legendary:
        return l10n.difficultyLegendary;
    }
  }

  /// Get localized achievement title by ID
  static String getTitle(BuildContext context, String id) {
    final l10n = AppLocalizations.of(context);

    switch (id) {
      // Streak achievements
      case 'streak_b1':
        return l10n.achievementStreakB1Title;
      case 'streak_b2':
        return l10n.achievementStreakB2Title;
      case 'streak_b3':
        return l10n.achievementStreakB3Title;
      case 'streak_s1':
        return l10n.achievementStreakS1Title;
      case 'streak_s2':
        return l10n.achievementStreakS2Title;
      case 'streak_s3':
        return l10n.achievementStreakS3Title;
      case 'streak_g1':
        return l10n.achievementStreakG1Title;
      case 'streak_g2':
        return l10n.achievementStreakG2Title;
      case 'streak_g3':
        return l10n.achievementStreakG3Title;
      case 'streak_p':
        return l10n.achievementStreakPTitle;
      // Savings achievements
      case 'savings_b1':
        return l10n.achievementSavingsB1Title;
      case 'savings_b2':
        return l10n.achievementSavingsB2Title;
      case 'savings_b3':
        return l10n.achievementSavingsB3Title;
      case 'savings_s1':
        return l10n.achievementSavingsS1Title;
      case 'savings_s2':
        return l10n.achievementSavingsS2Title;
      case 'savings_s3':
        return l10n.achievementSavingsS3Title;
      case 'savings_g1':
        return l10n.achievementSavingsG1Title;
      case 'savings_g2':
        return l10n.achievementSavingsG2Title;
      case 'savings_g3':
        return l10n.achievementSavingsG3Title;
      case 'savings_p1':
        return l10n.achievementSavingsP1Title;
      case 'savings_p2':
        return l10n.achievementSavingsP2Title;
      case 'savings_p3':
        return l10n.achievementSavingsP3Title;
      // Decision achievements
      case 'decision_b1':
        return l10n.achievementDecisionB1Title;
      case 'decision_b2':
        return l10n.achievementDecisionB2Title;
      case 'decision_b3':
        return l10n.achievementDecisionB3Title;
      case 'decision_s1':
        return l10n.achievementDecisionS1Title;
      case 'decision_s2':
        return l10n.achievementDecisionS2Title;
      case 'decision_s3':
        return l10n.achievementDecisionS3Title;
      case 'decision_g1':
        return l10n.achievementDecisionG1Title;
      case 'decision_g2':
        return l10n.achievementDecisionG2Title;
      case 'decision_g3':
        return l10n.achievementDecisionG3Title;
      case 'decision_p':
        return l10n.achievementDecisionPTitle;
      // Record achievements
      case 'record_b1':
        return l10n.achievementRecordB1Title;
      case 'record_b2':
        return l10n.achievementRecordB2Title;
      case 'record_b3':
        return l10n.achievementRecordB3Title;
      case 'record_s1':
        return l10n.achievementRecordS1Title;
      case 'record_s2':
        return l10n.achievementRecordS2Title;
      case 'record_s3':
        return l10n.achievementRecordS3Title;
      case 'record_g1':
        return l10n.achievementRecordG1Title;
      case 'record_g2':
        return l10n.achievementRecordG2Title;
      case 'record_g3':
        return l10n.achievementRecordG3Title;
      case 'record_p':
        return l10n.achievementRecordPTitle;
      // Hidden achievements
      case 'hidden_night':
        return l10n.achievementHiddenNightTitle;
      case 'hidden_early':
        return l10n.achievementHiddenEarlyTitle;
      case 'hidden_weekend':
        return l10n.achievementHiddenWeekendTitle;
      case 'hidden_first_scan':
        return l10n.achievementHiddenOcrTitle;
      case 'hidden_balanced_week':
        return l10n.achievementHiddenBalancedTitle;
      case 'hidden_all_categories':
        return l10n.achievementHiddenCategoriesTitle;
      case 'hidden_gold_equiv':
        return l10n.achievementHiddenGoldTitle;
      case 'hidden_usd_equiv':
        return l10n.achievementHiddenUsdTitle;
      case 'hidden_subscriptions':
        return l10n.achievementHiddenSubsTitle;
      case 'hidden_no_spend_month':
        return l10n.achievementHiddenNoSpendTitle;
      case 'hidden_gold_kg':
        return l10n.achievementHiddenGoldKgTitle;
      case 'hidden_usd_10k':
        return l10n.achievementHiddenUsd10kTitle;
      case 'hidden_anniversary':
        return l10n.achievementHiddenAnniversaryTitle;
      case 'hidden_early_adopter':
        return l10n.achievementHiddenEarlyAdopterTitle;
      case 'hidden_ultimate':
        return l10n.achievementHiddenUltimateTitle;
      case 'hidden_collector':
        return l10n.achievementHiddenCollectorTitle;
      case 'curious_cat':
        return l10n.curiousCatTitle;
      default:
        return id;
    }
  }

  /// Get localized achievement description by ID
  static String getDescription(BuildContext context, String id) {
    final l10n = AppLocalizations.of(context);

    switch (id) {
      // Streak achievements
      case 'streak_b1':
        return l10n.achievementStreakB1Desc;
      case 'streak_b2':
        return l10n.achievementStreakB2Desc;
      case 'streak_b3':
        return l10n.achievementStreakB3Desc;
      case 'streak_s1':
        return l10n.achievementStreakS1Desc;
      case 'streak_s2':
        return l10n.achievementStreakS2Desc;
      case 'streak_s3':
        return l10n.achievementStreakS3Desc;
      case 'streak_g1':
        return l10n.achievementStreakG1Desc;
      case 'streak_g2':
        return l10n.achievementStreakG2Desc;
      case 'streak_g3':
        return l10n.achievementStreakG3Desc;
      case 'streak_p':
        return l10n.achievementStreakPDesc;
      // Savings achievements
      case 'savings_b1':
        return l10n.achievementSavingsB1Desc;
      case 'savings_b2':
        return l10n.achievementSavingsB2Desc;
      case 'savings_b3':
        return l10n.achievementSavingsB3Desc;
      case 'savings_s1':
        return l10n.achievementSavingsS1Desc;
      case 'savings_s2':
        return l10n.achievementSavingsS2Desc;
      case 'savings_s3':
        return l10n.achievementSavingsS3Desc;
      case 'savings_g1':
        return l10n.achievementSavingsG1Desc;
      case 'savings_g2':
        return l10n.achievementSavingsG2Desc;
      case 'savings_g3':
        return l10n.achievementSavingsG3Desc;
      case 'savings_p1':
        return l10n.achievementSavingsP1Desc;
      case 'savings_p2':
        return l10n.achievementSavingsP2Desc;
      case 'savings_p3':
        return l10n.achievementSavingsP3Desc;
      // Decision achievements
      case 'decision_b1':
        return l10n.achievementDecisionB1Desc;
      case 'decision_b2':
        return l10n.achievementDecisionB2Desc;
      case 'decision_b3':
        return l10n.achievementDecisionB3Desc;
      case 'decision_s1':
        return l10n.achievementDecisionS1Desc;
      case 'decision_s2':
        return l10n.achievementDecisionS2Desc;
      case 'decision_s3':
        return l10n.achievementDecisionS3Desc;
      case 'decision_g1':
        return l10n.achievementDecisionG1Desc;
      case 'decision_g2':
        return l10n.achievementDecisionG2Desc;
      case 'decision_g3':
        return l10n.achievementDecisionG3Desc;
      case 'decision_p':
        return l10n.achievementDecisionPDesc;
      // Record achievements
      case 'record_b1':
        return l10n.achievementRecordB1Desc;
      case 'record_b2':
        return l10n.achievementRecordB2Desc;
      case 'record_b3':
        return l10n.achievementRecordB3Desc;
      case 'record_s1':
        return l10n.achievementRecordS1Desc;
      case 'record_s2':
        return l10n.achievementRecordS2Desc;
      case 'record_s3':
        return l10n.achievementRecordS3Desc;
      case 'record_g1':
        return l10n.achievementRecordG1Desc;
      case 'record_g2':
        return l10n.achievementRecordG2Desc;
      case 'record_g3':
        return l10n.achievementRecordG3Desc;
      case 'record_p':
        return l10n.achievementRecordPDesc;
      // Hidden achievements
      case 'hidden_night':
        return l10n.achievementHiddenNightDesc;
      case 'hidden_early':
        return l10n.achievementHiddenEarlyDesc;
      case 'hidden_weekend':
        return l10n.achievementHiddenWeekendDesc;
      case 'hidden_first_scan':
        return l10n.achievementHiddenOcrDesc;
      case 'hidden_balanced_week':
        return l10n.achievementHiddenBalancedDesc;
      case 'hidden_all_categories':
        return l10n.achievementHiddenCategoriesDesc;
      case 'hidden_gold_equiv':
        return l10n.achievementHiddenGoldDesc;
      case 'hidden_usd_equiv':
        return l10n.achievementHiddenUsdDesc;
      case 'hidden_subscriptions':
        return l10n.achievementHiddenSubsDesc;
      case 'hidden_no_spend_month':
        return l10n.achievementHiddenNoSpendDesc;
      case 'hidden_gold_kg':
        return l10n.achievementHiddenGoldKgDesc;
      case 'hidden_usd_10k':
        return l10n.achievementHiddenUsd10kDesc;
      case 'hidden_anniversary':
        return l10n.achievementHiddenAnniversaryDesc;
      case 'hidden_early_adopter':
        return l10n.achievementHiddenEarlyAdopterDesc;
      case 'hidden_ultimate':
        return l10n.achievementHiddenUltimateDesc;
      case 'hidden_collector':
        return l10n.achievementHiddenCollectorDesc;
      case 'curious_cat':
        return l10n.curiousCatDescription;
      default:
        return id;
    }
  }

  /// Get full tier label with subTier (e.g., "Bronze 1", "Silver 2")
  static String getFullTierLabel(
    BuildContext context,
    AchievementTier tier,
    int subTier,
  ) {
    final tierLabel = getTierLabel(context, tier);
    if (tier == AchievementTier.platinum) {
      return tierLabel;
    }
    return '$tierLabel $subTier';
  }
}


--- FILE: lib/utils/currency_helper.dart ---

/// Currency helper for displaying currency info with flags
class CurrencyHelper {
  static const Map<String, Map<String, String>> currencies = {
    'TRY': {'flag': '🇹🇷', 'name': 'Türk Lirası'},
    'USD': {'flag': '🇺🇸', 'name': 'ABD Doları'},
    'EUR': {'flag': '🇪🇺', 'name': 'Euro'},
    'GBP': {'flag': '🇬🇧', 'name': 'İngiliz Sterlini'},
  };

  static String getFlag(String code) => currencies[code]?['flag'] ?? '🏳️';
  static String getName(String code) => currencies[code]?['name'] ?? code;
  static String getDisplay(String code) => '${getFlag(code)} $code';
  static List<String> get allCodes => currencies.keys.toList();
}


--- FILE: lib/utils/error_handler.dart ---

import 'package:firebase_crashlytics/firebase_crashlytics.dart';
import 'package:flutter/material.dart';

/// Centralized error handling utility with Crashlytics integration
class ErrorHandler {
  /// Log error to Crashlytics and debug console
  static void handle(dynamic error, StackTrace? stack, {String? context}) {
    // Log to Crashlytics
    FirebaseCrashlytics.instance.recordError(
      error,
      stack,
      reason: context ?? 'Unknown error',
    );

    debugPrint('❌ [${context ?? 'Error'}] $error');
    if (stack != null) {
      debugPrint('Stack: $stack');
    }
  }

  /// Show user-friendly error message via SnackBar
  static void showUserError(BuildContext context, String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: Colors.red.shade700,
        behavior: SnackBarBehavior.floating,
        margin: const EdgeInsets.all(16),
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
        duration: const Duration(seconds: 4),
      ),
    );
  }

  /// Show success message via SnackBar
  static void showSuccess(BuildContext context, String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: Colors.green.shade700,
        behavior: SnackBarBehavior.floating,
        margin: const EdgeInsets.all(16),
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
        duration: const Duration(seconds: 3),
      ),
    );
  }

  /// Execute async operation with error handling
  /// Returns [fallback] on error, logs to Crashlytics
  static Future<T?> tryAsync<T>(
    Future<T> Function() action, {
    String? context,
    T? fallback,
  }) async {
    try {
      return await action();
    } catch (e, stack) {
      handle(e, stack, context: context);
      return fallback;
    }
  }

  /// Execute sync operation with error handling
  static T? trySync<T>(
    T Function() action, {
    String? context,
    T? fallback,
  }) {
    try {
      return action();
    } catch (e, stack) {
      handle(e, stack, context: context);
      return fallback;
    }
  }

  /// Log a non-fatal error without throwing
  static void logNonFatal(String message, {String? context}) {
    FirebaseCrashlytics.instance.log('[$context] $message');
    debugPrint('⚠️ [${context ?? 'Warning'}] $message');
  }

  /// Set custom key for debugging
  static void setCustomKey(String key, dynamic value) {
    FirebaseCrashlytics.instance.setCustomKey(key, value.toString());
  }
}


--- FILE: lib/utils/global_merchants.dart ---

/// Global merchant database for automatic category matching
/// Only contains WORLDWIDE known brands (50+ merchants)
class GlobalMerchants {
  GlobalMerchants._();

  /// Map of normalized merchant names to categories
  static const Map<String, String> merchants = {
    // Digital Services
    'NETFLIX': 'entertainment',
    'SPOTIFY': 'entertainment',
    'YOUTUBE': 'entertainment',
    'APPLE': 'digital',
    'GOOGLE': 'digital',
    'AMAZON': 'shopping',
    'STEAM': 'entertainment',
    'PLAYSTATION': 'entertainment',
    'XBOX': 'entertainment',
    'ADOBE': 'digital',
    'MICROSOFT': 'digital',
    'DISCORD': 'digital',
    'TWITCH': 'entertainment',
    'CHATGPT': 'digital',
    'OPENAI': 'digital',
    'NOTION': 'digital',
    'FIGMA': 'digital',
    'CANVA': 'digital',
    'DROPBOX': 'digital',
    'ICLOUD': 'digital',

    // Global Fast Food
    'MCDONALDS': 'food',
    'MCDONALD': 'food',
    'BURGER KING': 'food',
    'KFC': 'food',
    'STARBUCKS': 'food',
    'DOMINOS': 'food',
    'PIZZA HUT': 'food',
    'SUBWAY': 'food',
    'PAPA JOHNS': 'food',
    'POPEYES': 'food',
    'WENDYS': 'food',
    'TACO BELL': 'food',
    'DUNKIN': 'food',
    'COSTA COFFEE': 'food',
    'LITTLE CAESARS': 'food',

    // Global Clothing
    'ZARA': 'clothing',
    'H&M': 'clothing',
    'HM': 'clothing',
    'NIKE': 'clothing',
    'ADIDAS': 'clothing',
    'PUMA': 'clothing',
    'UNIQLO': 'clothing',
    'GAP': 'clothing',
    'LEVIS': 'clothing',
    'GUESS': 'clothing',
    'TOMMY HILFIGER': 'clothing',
    'CALVIN KLEIN': 'clothing',
    'UNDER ARMOUR': 'clothing',
    'NEW BALANCE': 'clothing',
    'FOREVER 21': 'clothing',
    'PULL BEAR': 'clothing',
    'BERSHKA': 'clothing',
    'MASSIMO DUTTI': 'clothing',
    'MANGO': 'clothing',
    'LACOSTE': 'clothing',

    // Global Gas Stations
    'SHELL': 'transport',
    'BP': 'transport',
    'TOTAL': 'transport',
    'ESSO': 'transport',
    'CHEVRON': 'transport',
    'EXXON': 'transport',
    'MOBIL': 'transport',
    'OPET': 'transport',
    'PETROL OFISI': 'transport',
    'TURKIYE PETROLLERI': 'transport',

    // Global Electronics / Tech
    'SAMSUNG': 'electronics',
    'SONY': 'electronics',
    'LG': 'electronics',
    'APPLE STORE': 'electronics',
    'MEDIAMARKT': 'electronics',
    'MEDIA MARKT': 'electronics',
    'BEST BUY': 'electronics',
    'TEKNOSA': 'electronics',
    'VATAN': 'electronics',

    // Global E-commerce
    'EBAY': 'shopping',
    'ALIEXPRESS': 'shopping',
    'ALIBABA': 'shopping',
    'WISH': 'shopping',
    'ETSY': 'shopping',
    'SHEIN': 'clothing',
    'TEMU': 'shopping',
    'TRENDYOL': 'shopping',
    'HEPSIBURADA': 'shopping',
    'N11': 'shopping',
    'GITTIGIDIYOR': 'shopping',

    // Transport / Ride-sharing
    'UBER': 'transport',
    'BOLT': 'transport',
    'LYFT': 'transport',
    'GRAB': 'transport',
    'BITAKSI': 'transport',

    // Global Furniture / Home
    'IKEA': 'shopping',
    'KOTON': 'clothing',

    // Airlines
    'TURKISH AIRLINES': 'transport',
    'THY': 'transport',
    'LUFTHANSA': 'transport',
    'EMIRATES': 'transport',
    'RYANAIR': 'transport',
    'EASYJET': 'transport',
    'PEGASUS': 'transport',
    'SUNCOUNTRY': 'transport',

    // Turkish Supermarkets
    'MIGROS': 'food',
    'CARREFOUR': 'food',
    'BIM': 'food',
    'A101': 'food',
    'SOK': 'food',
    'METRO': 'food',
    'MACRO': 'food',
    'GETIR': 'food',
    'YEMEKSEPETI': 'food',
  };

  /// Get category for a normalized description
  static String? getCategory(String normalized) {
    // First try exact key match
    if (merchants.containsKey(normalized)) {
      return merchants[normalized];
    }

    // Then try contains match (for descriptions like "NETFLIX SUBSCRIPTION")
    for (final entry in merchants.entries) {
      if (normalized.contains(entry.key)) {
        return entry.value;
      }
    }
    return null;
  }

  /// Get merchant name from normalized description
  static String? getMerchantName(String normalized) {
    // First try exact key match
    if (merchants.containsKey(normalized)) {
      return normalized;
    }

    // Then try contains match
    for (final key in merchants.keys) {
      if (normalized.contains(key)) {
        return key;
      }
    }
    return null;
  }

  /// Get display-friendly merchant name (Title Case)
  static String getDisplayName(String merchantKey) {
    // Convert to title case
    return merchantKey
        .split(' ')
        .map(
          (word) => word.isNotEmpty
              ? '${word[0].toUpperCase()}${word.substring(1).toLowerCase()}'
              : '',
        )
        .join(' ');
  }
}


--- FILE: lib/utils/currency_utils.dart ---

import 'package:intl/intl.dart';
import 'dart:math';
import 'package:flutter/services.dart';

/// Premium Türkçe Para Formatı Utilities
/// - Sınırsız tutar desteği (milyarlara kadar)
/// - Akıllı nokta/virgül dönüşümü
/// - Kullanıcı dostu format

// ============================================
// PARSE FONKSİYONLARI
// ============================================

/// Herhangi bir formattaki tutar string'ini double'a çevir
/// Desteklenen formatlar:
/// - Türkçe: "1.234.567,89" veya "1.234.567"
/// - İngilizce: "1,234,567.89" veya "1234567.89"
/// - Karışık: "1234567" veya "1.234567" veya "1,234,567"
double? parseAmount(String? text) {
  if (text == null || text.trim().isEmpty) return null;

  String normalized = text.trim();

  // Tüm boşlukları kaldır
  normalized = normalized.replaceAll(' ', '');

  // TL, ₺ gibi sembolleri kaldır
  normalized = normalized.replaceAll(
    RegExp(r'[TL₺\$€]', caseSensitive: false),
    '',
  );

  // Eğer hem nokta hem virgül varsa, hangisinin ondalık olduğunu belirle
  final hasComma = normalized.contains(',');
  final hasDot = normalized.contains('.');

  if (hasComma && hasDot) {
    // Son ayracı bul - o ondalık
    final lastComma = normalized.lastIndexOf(',');
    final lastDot = normalized.lastIndexOf('.');

    if (lastComma > lastDot) {
      // Türkçe format: 1.234.567,89
      normalized = normalized.replaceAll('.', '').replaceAll(',', '.');
    } else {
      // İngilizce format: 1,234,567.89
      normalized = normalized.replaceAll(',', '');
    }
  } else if (hasComma) {
    // Sadece virgül var
    final commaCount = ','.allMatches(normalized).length;
    final lastCommaIndex = normalized.lastIndexOf(',');
    final afterComma = normalized.substring(lastCommaIndex + 1);

    if (commaCount == 1 && afterComma.length <= 2) {
      // Ondalık virgül: 1234,50
      normalized = normalized.replaceAll(',', '.');
    } else {
      // Binlik virgül (İngilizce): 1,234,567
      normalized = normalized.replaceAll(',', '');
    }
  } else if (hasDot) {
    // Sadece nokta var
    final dotCount = '.'.allMatches(normalized).length;
    final lastDotIndex = normalized.lastIndexOf('.');
    final afterDot = normalized.substring(lastDotIndex + 1);

    if (dotCount == 1 && afterDot.length <= 2) {
      // Ondalık nokta: 1234.50 - olduğu gibi bırak
    } else {
      // Binlik nokta (Türkçe): 1.234.567
      normalized = normalized.replaceAll('.', '');
    }
  }

  // Sayı olmayan karakterleri kaldır (nokta hariç)
  normalized = normalized.replaceAll(RegExp(r'[^\d.]'), '');

  // Birden fazla nokta varsa sadece ilkini tut
  final dotCount = '.'.allMatches(normalized).length;
  if (dotCount > 1) {
    final firstDot = normalized.indexOf('.');
    normalized =
        normalized.substring(0, firstDot + 1) +
        normalized.substring(firstDot + 1).replaceAll('.', '');
  }

  return double.tryParse(normalized);
}

/// Türkçe formatlı metni double'a çevir (legacy uyumluluk)
/// "1.234,50" → 1234.50
double? parseTurkishCurrency(String text) => parseAmount(text);

// ============================================
// FORMAT FONKSİYONLARI
// ============================================

/// Double'ı Türkçe para formatına çevir
/// 1234567.89 → "1.234.567,89"
/// Yuvarlama yapmaz, sadece truncate eder
String formatTurkishCurrency(
  double value, {
  int decimalDigits = 2,
  bool showDecimals = true,
}) {
  if (value.isNaN || value.isInfinite) return '0';

  final isNegative = value < 0;
  final absValue = value.abs();

  // Tam sayı mı kontrol et
  final isWholeNumber = absValue == absValue.truncateToDouble();

  String result;
  if (!showDecimals || (isWholeNumber && decimalDigits == 0)) {
    // Tam sayı formatı
    result = _formatInteger(absValue.truncate());
  } else {
    // Ondalıklı format - yuvarlama yapmadan truncate et
    final multiplier = pow(10, decimalDigits);
    final truncated = (absValue * multiplier).truncate() / multiplier;
    final parts = truncated.toString().split('.');
    final integerPart = int.parse(parts[0]);
    final decimalPart = parts.length > 1
        ? parts[1].padRight(decimalDigits, '0').substring(0, decimalDigits)
        : '0'.padRight(decimalDigits, '0');

    result = '${_formatInteger(integerPart)},$decimalPart';
  }

  return isNegative ? '-$result' : result;
}

/// Kompakt format (K, M, B)
/// 1234567 → "1,23M"
/// Yuvarlama yapmaz, sadece truncate eder
String formatCompact(double value) {
  if (value.isNaN || value.isInfinite) return '0';

  final absValue = value.abs();
  final isNegative = value < 0;
  String result;

  if (absValue >= 1000000000) {
    // Milyar için: 2 ondalık basamak
    final multiplier = 100;
    final truncated =
        ((absValue / 1000000000) * multiplier).truncate() / multiplier;
    final parts = truncated.toString().split('.');
    final integerPart = parts[0];
    final decimalPart = parts.length > 1
        ? parts[1].padRight(2, '0').substring(0, 2)
        : '00';
    result = '$integerPart,${decimalPart}B';
  } else if (absValue >= 1000000) {
    // Milyon için: 2 ondalık basamak
    final multiplier = 100;
    final truncated =
        ((absValue / 1000000) * multiplier).truncate() / multiplier;
    final parts = truncated.toString().split('.');
    final integerPart = parts[0];
    final decimalPart = parts.length > 1
        ? parts[1].padRight(2, '0').substring(0, 2)
        : '00';
    result = '$integerPart,${decimalPart}M';
  } else if (absValue >= 1000) {
    // Bin için: 1 ondalık basamak
    final multiplier = 10;
    final truncated = ((absValue / 1000) * multiplier).truncate() / multiplier;
    final parts = truncated.toString().split('.');
    final integerPart = parts[0];
    final decimalPart = parts.length > 1 ? parts[1] : '0';
    result = '$integerPart,${decimalPart}K';
  } else {
    result = absValue.truncate().toString();
  }

  return isNegative ? '-$result' : result;
}

/// Kısa para formatı (tam sayı, ondalık yok)
/// 1234567.89 → "1.234.567 TL"
/// Yuvarlama yapmaz, sadece truncate eder
String formatCurrencyShort(double value, {bool showSymbol = true}) {
  final formatted = formatTurkishCurrency(
    value.truncateToDouble(),
    decimalDigits: 0,
    showDecimals: false,
  );
  return showSymbol ? '$formatted TL' : formatted;
}

/// Tam para formatı
/// 1234567.89 → "1.234.567,89 TL"
String formatCurrencyFull(double value, {bool showSymbol = true}) {
  final formatted = formatTurkishCurrency(value);
  return showSymbol ? '$formatted TL' : formatted;
}

/// Integer'ı binlik ayraçlı string'e çevir
String _formatInteger(int value) {
  if (value == 0) return '0';

  final isNegative = value < 0;
  final absValue = value.abs();
  final str = absValue.toString();
  final buffer = StringBuffer();
  final length = str.length;

  for (int i = 0; i < length; i++) {
    if (i > 0 && (length - i) % 3 == 0) {
      buffer.write('.');
    }
    buffer.write(str[i]);
  }

  return isNegative ? '-${buffer.toString()}' : buffer.toString();
}

// ============================================
// INPUT FORMATTER
// ============================================

/// Premium Türkçe para girişi formatter
/// - Sınırsız tutar (12 digit'e kadar = trilyonlar)
/// - Akıllı cursor pozisyonu
/// - Otomatik binlik ayraç
class PremiumCurrencyFormatter extends TextInputFormatter {
  PremiumCurrencyFormatter({
    this.maxIntegerDigits = 12, // Trilyonlara kadar
    this.maxDecimalDigits = 2,
    this.allowDecimals = true,
  });

  final int maxIntegerDigits;
  final int maxDecimalDigits;
  final bool allowDecimals;

  @override
  TextEditingValue formatEditUpdate(
    TextEditingValue oldValue,
    TextEditingValue newValue,
  ) {
    if (newValue.text.isEmpty) {
      return newValue;
    }

    String text = newValue.text;

    // Nokta ve virgülü normalize et
    // Kullanıcı her ikisini de girebilir, virgüle çevir
    text = text.replaceAll('.', ',');

    // Sadece rakam ve virgül
    text = text.replaceAll(RegExp(r'[^\d,]'), '');

    // Ondalık işleme
    if (text.contains(',')) {
      if (!allowDecimals) {
        // Ondalık izin verilmiyorsa virgülü kaldır
        text = text.replaceAll(',', '');
      } else {
        // Birden fazla virgül varsa sadece ilkini tut
        final firstComma = text.indexOf(',');
        text =
            text.substring(0, firstComma + 1) +
            text.substring(firstComma + 1).replaceAll(',', '');

        // Ondalık kısmı sınırla
        final parts = text.split(',');
        final intPart = parts[0];
        var decPart = parts.length > 1 ? parts[1] : '';

        if (decPart.length > maxDecimalDigits) {
          decPart = decPart.substring(0, maxDecimalDigits);
        }

        // Integer limit kontrolü
        final cleanInt = intPart.replaceAll(RegExp(r'[^\d]'), '');
        if (cleanInt.length > maxIntegerDigits) {
          return oldValue;
        }

        text = '$intPart,$decPart';
      }
    } else {
      // Integer limit kontrolü
      final cleanInt = text.replaceAll(RegExp(r'[^\d]'), '');
      if (cleanInt.length > maxIntegerDigits) {
        return oldValue;
      }
    }

    // Binlik ayraç ekle
    text = _addThousandSeparators(text);

    // Cursor pozisyonu
    final cursorOffset = _calculateCursor(oldValue, newValue, text);

    return TextEditingValue(
      text: text,
      selection: TextSelection.collapsed(offset: cursorOffset),
    );
  }

  String _addThousandSeparators(String text) {
    if (text.isEmpty) return text;

    String intPart;
    String decPart = '';

    if (text.contains(',')) {
      final parts = text.split(',');
      intPart = parts[0].replaceAll('.', '');
      decPart = ',${parts[1]}';
    } else {
      intPart = text.replaceAll('.', '');
    }

    // Başındaki sıfırları kaldır
    if (intPart.length > 1) {
      intPart = intPart.replaceFirst(RegExp(r'^0+'), '');
      if (intPart.isEmpty) intPart = '0';
    }

    // Binlik ayraç
    final buffer = StringBuffer();
    final len = intPart.length;
    for (int i = 0; i < len; i++) {
      if (i > 0 && (len - i) % 3 == 0) {
        buffer.write('.');
      }
      buffer.write(intPart[i]);
    }

    return buffer.toString() + decPart;
  }

  int _calculateCursor(
    TextEditingValue oldValue,
    TextEditingValue newValue,
    String formattedText,
  ) {
    // Basit yaklaşım: ekleme/silmeye göre cursor ayarla
    final oldLen = oldValue.text.length;
    final newLen = newValue.text.length;
    final formattedLen = formattedText.length;

    if (newLen > oldLen) {
      // Ekleme
      final diff = formattedLen - oldLen;
      return (oldValue.selection.baseOffset + diff).clamp(0, formattedLen);
    } else {
      // Silme
      return (newValue.selection.baseOffset).clamp(0, formattedLen);
    }
  }
}

// ============================================
// LEGACY UYUMLULUK
// ============================================

class TurkishCurrencyInputFormatter extends TextInputFormatter {
  @override
  TextEditingValue formatEditUpdate(
    TextEditingValue oldValue,
    TextEditingValue newValue,
  ) {
    if (newValue.text.isEmpty) return newValue;

    // 1. Binlik noktalarını temizle, her şeyi saf sayıya çek
    String cleanText = newValue.text.replaceAll('.', '');

    // 2. Noktayı virgüle çevir (Kullanıcı hangisine basarsa bassın kuruşa geçsin)
    cleanText = cleanText.replaceAll(',', '.');

    // 3. Birden fazla virgül/nokta koyulmasını engelle
    List<String> parts = cleanText.split('.');
    if (parts.length > 2) return oldValue;

    String beforeDecimal = parts[0].replaceAll(RegExp(r'[^0-9]'), '');
    String? afterDecimal = parts.length > 1 ? parts[1] : null;

    // KURUŞ SINIRI: Maksimum 2 hane (555 yazarsa 55'te durur)
    if (afterDecimal != null && afterDecimal.length > 2) {
      afterDecimal = afterDecimal.substring(0, 2);
    }

    if (beforeDecimal.isEmpty) return newValue;

    // 4. Binlik ayırıcıyı (nokta) ekle
    final formatter = NumberFormat('#,###', 'tr_TR');
    // int.parse hata vermesin diye kontrol (çok büyük sayılar için)
    int? parsedBefore = int.tryParse(beforeDecimal);
    if (parsedBefore == null) return oldValue;

    String formattedBefore = formatter
        .format(parsedBefore)
        .replaceAll(',', '.');

    // 5. Sonucu birleştir (Virgül ile kuruşu ayır)
    String finalString =
        formattedBefore + (afterDecimal != null ? ',$afterDecimal' : '');

    return TextEditingValue(
      text: finalString,
      selection: TextSelection.collapsed(offset: finalString.length),
    );
  }
}

/// Simülasyon zamanı için iki bloklu sonuç
/// UI'da yan yana iki kutucuk göstermek için kullanılır
class SimulationTimeDisplay {
  final String value1;
  final String unit1;
  final String value2;
  final String unit2;
  final bool isYearMode; // true = Yıl+Gün, false = Saat+Gün

  const SimulationTimeDisplay({
    required this.value1,
    required this.unit1,
    required this.value2,
    required this.unit2,
    required this.isYearMode,
  });
}

/// Saatleri okunabilir formata çevirir
/// "1 gün 5.5 saat" veya "2 hours 30 min" formatında döndürür
/// workHoursPerDay: Kullanıcının günlük çalışma saati (varsayılan 8)
/// locale: 'tr' veya 'en' - dil desteği
String formatWorkTime(
  double totalHours, {
  double workHoursPerDay = 8,
  String locale = 'tr',
}) {
  if (totalHours <= 0) {
    return locale == 'tr' ? '0 saat' : '0 hours';
  }

  final days = (totalHours / workHoursPerDay).floor();
  final remainingHours = totalHours - (days * workHoursPerDay);

  if (locale == 'tr') {
    if (days > 0 && remainingHours > 0.1) {
      return '$days gün ${remainingHours.toStringAsFixed(1)} saat';
    } else if (days > 0) {
      return '$days gün';
    } else {
      return '${totalHours.toStringAsFixed(1)} saat';
    }
  } else {
    if (days > 0 && remainingHours > 0.1) {
      return '$days day${days > 1 ? 's' : ''} ${remainingHours.toStringAsFixed(1)} hr';
    } else if (days > 0) {
      return '$days day${days > 1 ? 's' : ''}';
    } else {
      return '${totalHours.toStringAsFixed(1)} hours';
    }
  }
}

/// Locale'e göre para formatı için binlik ayraç
/// Türkçe: 100.000 (nokta ile)
/// İngilizce: 100,000 (virgül ile)
String formatCurrencyWithLocale(
  double value, {
  String locale = 'tr',
  int decimalDigits = 2,
  bool showDecimals = true,
  String? currencySymbol,
}) {
  if (value.isNaN || value.isInfinite) return '0';

  final isNegative = value < 0;
  final absValue = value.abs();

  // Tam sayı mı kontrol et
  final isWholeNumber = absValue == absValue.truncateToDouble();

  String result;
  if (!showDecimals || (isWholeNumber && decimalDigits == 0)) {
    // Tam sayı formatı
    result = _formatIntegerWithLocale(absValue.truncate(), locale);
  } else {
    // Ondalıklı format
    final multiplier = pow(10, decimalDigits);
    final truncated = (absValue * multiplier).truncate() / multiplier;
    final parts = truncated.toString().split('.');
    final integerPart = int.parse(parts[0]);
    final decimalPart = parts.length > 1
        ? parts[1].padRight(decimalDigits, '0').substring(0, decimalDigits)
        : '0'.padRight(decimalDigits, '0');

    final decimalSeparator = locale == 'tr' ? ',' : '.';
    result = '${_formatIntegerWithLocale(integerPart, locale)}$decimalSeparator$decimalPart';
  }

  final prefix = isNegative ? '-' : '';
  if (currencySymbol != null) {
    // Türkçe için sembol sonda, İngilizce için başta
    if (locale == 'tr') {
      return '$prefix$result $currencySymbol';
    } else {
      return '$prefix$currencySymbol$result';
    }
  }
  return '$prefix$result';
}

/// Integer'ı locale'e göre binlik ayraçlı string'e çevir
String _formatIntegerWithLocale(int value, String locale) {
  if (value == 0) return '0';

  final isNegative = value < 0;
  final absValue = value.abs();
  final str = absValue.toString();
  final buffer = StringBuffer();
  final length = str.length;

  // Türkçe için nokta, İngilizce için virgül
  final separator = locale == 'tr' ? '.' : ',';

  for (int i = 0; i < length; i++) {
    if (i > 0 && (length - i) % 3 == 0) {
      buffer.write(separator);
    }
    buffer.write(str[i]);
  }

  return isNegative ? '-${buffer.toString()}' : buffer.toString();
}

/// Saatleri iki ayrı birime çevirir (yan yana gösterim için)
/// workHoursPerDay: Kullanıcının günlük çalışma saati (varsayılan 8)
/// workDaysPerWeek: Kullanıcının haftalık çalışma günü (varsayılan 5)
///
/// < 1 yıllık çalışma: Sol blok = Toplam SAAT, Sağ blok = Toplam İŞ GÜNÜ
/// >= 1 yıllık çalışma: Sol blok = Toplam YIL, Sağ blok = Toplam İŞ GÜNÜ
SimulationTimeDisplay getSimulationTimeDisplay(
  double totalHours, {
  double workHoursPerDay = 8,
  int workDaysPerWeek = 5,
}) {
  // Yıllık çalışma saati: haftalık iş günü * 52 hafta * günlük saat
  final double hoursPerYear = workDaysPerWeek * 52 * workHoursPerDay;

  if (totalHours <= 0) {
    return const SimulationTimeDisplay(
      value1: '0',
      unit1: 'Saat',
      value2: '0',
      unit2: 'Gün',
      isYearMode: false,
    );
  }

  if (totalHours >= hoursPerYear) {
    // 1 yıl ve üstü: Yıl + İş Günü (toplam değerler)
    final totalYears = totalHours / hoursPerYear;
    final totalWorkDays = totalHours / workHoursPerDay;

    return SimulationTimeDisplay(
      value1: totalYears.toStringAsFixed(1),
      unit1: 'Yıl',
      value2: formatTurkishCurrency(
        totalWorkDays,
        decimalDigits: 0,
        showDecimals: false,
      ),
      unit2: 'Gün',
      isYearMode: true,
    );
  } else {
    // 1 yılın altı: Saat + İş Günü (toplam değerler)
    final totalWorkDays = totalHours / workHoursPerDay;

    return SimulationTimeDisplay(
      value1: formatTurkishCurrency(totalHours, decimalDigits: 1),
      unit1: 'Saat',
      value2: totalWorkDays.toStringAsFixed(1),
      unit2: 'Gün',
      isYearMode: false,
    );
  }
}


--- FILE: lib/utils/security_utils.dart ---

import 'package:flutter/foundation.dart';

/// Security utilities for input validation and sanitization
class SecurityUtils {
  SecurityUtils._();

  // Maximum lengths for input fields
  static const int maxDescriptionLength = 200;
  static const int maxCategoryLength = 50;
  static const int maxNameLength = 100;

  // ─────────────────────────────────────────────────────────────────
  // INPUT VALIDATION
  // ─────────────────────────────────────────────────────────────────

  /// Validate email format
  static bool isValidEmail(String email) {
    final emailRegex = RegExp(
      r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$',
    );
    return emailRegex.hasMatch(email.trim());
  }

  /// Validate amount (positive number)
  static bool isValidAmount(String input) {
    final amount = double.tryParse(input.replaceAll(',', '.'));
    return amount != null && amount > 0;
  }

  /// Parse amount safely
  static double? parseAmount(String input) {
    if (input.isEmpty) return null;
    final normalized = input
        .replaceAll(',', '.')
        .replaceAll(RegExp(r'[^\d.]'), '');
    return double.tryParse(normalized);
  }

  /// Validate percentage (0-100)
  static bool isValidPercentage(String input) {
    final value = double.tryParse(input);
    return value != null && value >= 0 && value <= 100;
  }

  // ─────────────────────────────────────────────────────────────────
  // INPUT SANITIZATION
  // ─────────────────────────────────────────────────────────────────

  /// Sanitize text input (remove control characters)
  static String sanitizeText(String input) {
    // Remove control characters except newlines and tabs
    return input.replaceAll(RegExp(r'[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]'), '');
  }

  /// Sanitize and trim text
  static String sanitizeAndTrim(String input, {int maxLength = 500}) {
    final sanitized = sanitizeText(input.trim());
    if (sanitized.length > maxLength) {
      return sanitized.substring(0, maxLength);
    }
    return sanitized;
  }

  /// Sanitize filename
  static String sanitizeFilename(String filename) {
    // Remove or replace characters that are unsafe in filenames
    return filename
        .replaceAll(RegExp(r'[<>:"/\\|?*\x00-\x1F]'), '_')
        .replaceAll(RegExp(r'\.{2,}'), '.')
        .trim();
  }

  // ─────────────────────────────────────────────────────────────────
  // DATA MASKING (FOR LOGGING)
  // ─────────────────────────────────────────────────────────────────

  /// Mask email for logging (show first 2 chars and domain)
  static String maskEmail(String email) {
    final parts = email.split('@');
    if (parts.length != 2) return '***';

    final name = parts[0];
    final domain = parts[1];

    if (name.length <= 2) return '**@$domain';
    return '${name.substring(0, 2)}***@$domain';
  }

  /// Mask phone number for logging
  static String maskPhone(String phone) {
    final digits = phone.replaceAll(RegExp(r'\D'), '');
    if (digits.length < 4) return '****';
    return '****${digits.substring(digits.length - 4)}';
  }

  /// Mask user ID for logging (show first 4 and last 4 chars)
  static String maskUserId(String userId) {
    if (userId.length <= 8) return '****';
    return '${userId.substring(0, 4)}...${userId.substring(userId.length - 4)}';
  }

  // ─────────────────────────────────────────────────────────────────
  // RATE LIMITING HELPERS
  // ─────────────────────────────────────────────────────────────────

  /// Check if action should be rate limited
  static bool shouldRateLimit({
    required DateTime? lastAction,
    required Duration minInterval,
  }) {
    if (lastAction == null) return false;
    return DateTime.now().difference(lastAction) < minInterval;
  }

  // ─────────────────────────────────────────────────────────────────
  // SECURE COMPARISON
  // ─────────────────────────────────────────────────────────────────

  /// Constant-time string comparison (prevents timing attacks)
  static bool secureCompare(String a, String b) {
    if (a.length != b.length) return false;

    var result = 0;
    for (var i = 0; i < a.length; i++) {
      result |= a.codeUnitAt(i) ^ b.codeUnitAt(i);
    }
    return result == 0;
  }
}

/// Throttle helper for preventing button spam
/// Tracks last action time per key to prevent rapid repeated actions
class ActionThrottle {
  static final Map<String, DateTime> _lastActions = {};

  /// Check if action is allowed (not throttled)
  /// Returns true if action is allowed, false if throttled
  static bool canPerform(String actionKey, {Duration minInterval = const Duration(milliseconds: 500)}) {
    final now = DateTime.now();
    final lastAction = _lastActions[actionKey];

    if (lastAction != null && now.difference(lastAction) < minInterval) {
      debugPrint('[Throttle] Action "$actionKey" throttled');
      return false;
    }

    _lastActions[actionKey] = now;
    return true;
  }

  /// Reset throttle for a specific action
  static void reset(String actionKey) {
    _lastActions.remove(actionKey);
  }

  /// Clear all throttles
  static void clearAll() {
    _lastActions.clear();
  }
}


--- FILE: lib/utils/emoji_helper.dart ---

// Smart emoji helper for pursuits/dreams
// Returns context-aware emojis based on pursuit name keywords

/// Get a smart default emoji based on the pursuit name
/// This provides more specific emojis than category-based defaults
String getDefaultPursuitEmoji(String pursuitName) {
  final name = pursuitName.toLowerCase().trim();

  // Tech devices
  if (name.contains('iphone') ||
      name.contains('telefon') ||
      name.contains('phone') ||
      name.contains('samsung') ||
      name.contains('pixel')) {
    return '📱';
  }

  if (name.contains('macbook') ||
      name.contains('laptop') ||
      name.contains('bilgisayar') ||
      name.contains('computer') ||
      name.contains('notebook') ||
      name.contains('pc')) {
    return '💻';
  }

  if (name.contains('airpods') ||
      name.contains('kulaklık') ||
      name.contains('headphone') ||
      name.contains('earbuds') ||
      name.contains('earphone')) {
    return '🎧';
  }

  if (name.contains('saat') ||
      name.contains('watch') ||
      name.contains('apple watch') ||
      name.contains('smartwatch')) {
    return '⌚';
  }

  if (name.contains('playstation') ||
      name.contains('ps5') ||
      name.contains('ps4') ||
      name.contains('xbox') ||
      name.contains('gaming') ||
      name.contains('nintendo') ||
      name.contains('switch') ||
      name.contains('konsol')) {
    return '🎮';
  }

  if (name.contains('ipad') || name.contains('tablet')) {
    return '📱';
  }

  if (name.contains('kamera') ||
      name.contains('camera') ||
      name.contains('gopro') ||
      name.contains('fotoğraf')) {
    return '📷';
  }

  if (name.contains('tv') ||
      name.contains('televizyon') ||
      name.contains('television')) {
    return '📺';
  }

  // Vehicles
  if (name.contains('araba') ||
      name.contains('car') ||
      name.contains('tesla') ||
      name.contains('bmw') ||
      name.contains('mercedes') ||
      name.contains('audi') ||
      name.contains('otomobil')) {
    return '🚗';
  }

  if (name.contains('motorsiklet') ||
      name.contains('motorcycle') ||
      name.contains('motor') ||
      name.contains('scooter') ||
      name.contains('vespa')) {
    return '🏍️';
  }

  if (name.contains('bisiklet') ||
      name.contains('bike') ||
      name.contains('bicycle')) {
    return '🚴';
  }

  // Home
  if (name.contains('ev') ||
      name.contains('house') ||
      name.contains('home') ||
      name.contains('apartment') ||
      name.contains('daire') ||
      name.contains('konut')) {
    return '🏠';
  }

  if (name.contains('mobilya') ||
      name.contains('furniture') ||
      name.contains('koltuk') ||
      name.contains('sofa') ||
      name.contains('kanepe') ||
      name.contains('yatak') ||
      name.contains('bed')) {
    return '🛋️';
  }

  // Travel
  if (name.contains('tatil') ||
      name.contains('vacation') ||
      name.contains('holiday') ||
      name.contains('travel') ||
      name.contains('seyahat') ||
      name.contains('gezi') ||
      name.contains('trip')) {
    return '✈️';
  }

  if (name.contains('otel') ||
      name.contains('hotel') ||
      name.contains('resort')) {
    return '🏨';
  }

  // Education
  if (name.contains('kurs') ||
      name.contains('course') ||
      name.contains('education') ||
      name.contains('eğitim') ||
      name.contains('bootcamp') ||
      name.contains('sertifika') ||
      name.contains('certificate')) {
    return '🎓';
  }

  if (name.contains('kitap') ||
      name.contains('book') ||
      name.contains('kindle') ||
      name.contains('e-reader')) {
    return '📚';
  }

  // Health & Fitness
  if (name.contains('spor') ||
      name.contains('gym') ||
      name.contains('fitness') ||
      name.contains('workout') ||
      name.contains('egzersiz')) {
    return '💪';
  }

  if (name.contains('koşu') ||
      name.contains('running') ||
      name.contains('maraton') ||
      name.contains('marathon')) {
    return '🏃';
  }

  // Life events
  if (name.contains('düğün') ||
      name.contains('wedding') ||
      name.contains('evlilik') ||
      name.contains('nişan') ||
      name.contains('engagement')) {
    return '💒';
  }

  if (name.contains('bebek') ||
      name.contains('baby') ||
      name.contains('çocuk') ||
      name.contains('child')) {
    return '👶';
  }

  // Fashion
  if (name.contains('çanta') ||
      name.contains('bag') ||
      name.contains('purse') ||
      name.contains('handbag')) {
    return '👜';
  }

  if (name.contains('ayakkabı') ||
      name.contains('shoe') ||
      name.contains('sneaker') ||
      name.contains('bot') ||
      name.contains('boot')) {
    return '👟';
  }

  if (name.contains('gözlük') ||
      name.contains('glasses') ||
      name.contains('sunglasses') ||
      name.contains('güneş gözlüğü')) {
    return '🕶️';
  }

  // Other
  if (name.contains('hediye') ||
      name.contains('gift') ||
      name.contains('present')) {
    return '🎁';
  }

  if (name.contains('yatırım') ||
      name.contains('investment') ||
      name.contains('hisse') ||
      name.contains('stock') ||
      name.contains('kripto') ||
      name.contains('crypto')) {
    return '📈';
  }

  if (name.contains('acil') ||
      name.contains('emergency') ||
      name.contains('güvence') ||
      name.contains('fon') ||
      name.contains('fund')) {
    return '🏦';
  }

  // Default - target/goal emoji
  return '🎯';
}

/// Check if name matches any known keyword pattern
bool hasSmartEmoji(String pursuitName) {
  final emoji = getDefaultPursuitEmoji(pursuitName);
  return emoji != '🎯'; // Returns true if we found a specific match
}


--- FILE: lib/models/category_budget.dart ---

import 'package:uuid/uuid.dart';

/// Represents a monthly budget limit for a specific expense category
class CategoryBudget {
  final String id;
  final String category;
  final double monthlyLimit;
  final DateTime createdAt;
  final DateTime? updatedAt;
  final bool isActive;

  CategoryBudget({
    String? id,
    required this.category,
    required this.monthlyLimit,
    DateTime? createdAt,
    this.updatedAt,
    this.isActive = true,
  }) : id = id ?? const Uuid().v4(),
       createdAt = createdAt ?? DateTime.now();

  CategoryBudget copyWith({
    String? id,
    String? category,
    double? monthlyLimit,
    DateTime? createdAt,
    DateTime? updatedAt,
    bool? isActive,
  }) {
    return CategoryBudget(
      id: id ?? this.id,
      category: category ?? this.category,
      monthlyLimit: monthlyLimit ?? this.monthlyLimit,
      createdAt: createdAt ?? this.createdAt,
      updatedAt: updatedAt ?? this.updatedAt,
      isActive: isActive ?? this.isActive,
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'category': category,
      'monthlyLimit': monthlyLimit,
      'createdAt': createdAt.toIso8601String(),
      'updatedAt': updatedAt?.toIso8601String(),
      'isActive': isActive,
    };
  }

  factory CategoryBudget.fromJson(Map<String, dynamic> json) {
    return CategoryBudget(
      id: json['id'] as String,
      category: json['category'] as String,
      monthlyLimit: (json['monthlyLimit'] as num).toDouble(),
      createdAt: DateTime.parse(json['createdAt'] as String),
      updatedAt: json['updatedAt'] != null
          ? DateTime.parse(json['updatedAt'] as String)
          : null,
      isActive: json['isActive'] as bool? ?? true,
    );
  }

  @override
  String toString() =>
      'CategoryBudget(id: $id, category: $category, limit: $monthlyLimit)';

  @override
  bool operator ==(Object other) =>
      identical(this, other) ||
      other is CategoryBudget &&
          runtimeType == other.runtimeType &&
          id == other.id;

  @override
  int get hashCode => id.hashCode;
}

/// Budget with calculated spent amount for a specific month
class CategoryBudgetWithSpent {
  final CategoryBudget budget;
  final double spent;
  final int month;
  final int year;

  CategoryBudgetWithSpent({
    required this.budget,
    required this.spent,
    required this.month,
    required this.year,
  });

  /// Remaining amount (can be negative if over budget)
  double get remaining => budget.monthlyLimit - spent;

  /// Percentage of budget used (0-100+)
  double get percentUsed =>
      budget.monthlyLimit > 0 ? (spent / budget.monthlyLimit * 100) : 0;

  /// Clamped percentage for progress bars (0-100)
  double get percentUsedClamped => percentUsed.clamp(0, 100);

  /// Is over the budget limit?
  bool get isOverBudget => spent > budget.monthlyLimit;

  /// Is near the limit (80%+)?
  bool get isNearLimit => percentUsed >= 80 && !isOverBudget;

  /// Is on track (<80%)?
  bool get isOnTrack => percentUsed < 80;

  /// Warning level: 0=green, 1=yellow, 2=orange, 3=red
  int get warningLevel {
    if (percentUsed < 50) return 0;
    if (percentUsed < 80) return 1;
    if (percentUsed < 100) return 2;
    return 3;
  }

  @override
  String toString() =>
      'CategoryBudgetWithSpent(${budget.category}: $spent / ${budget.monthlyLimit})';
}


--- FILE: lib/models/expense.dart ---

import 'dart:convert';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:vantag/l10n/app_localizations.dart';
import 'package:vantag/theme/app_theme.dart';

enum ExpenseDecision {
  yes,
  thinking,
  no;

  /// Returns the localized label for UI display
  String getLocalizedLabel(AppLocalizations l10n) {
    switch (this) {
      case ExpenseDecision.yes:
        return l10n.bought;
      case ExpenseDecision.thinking:
        return l10n.thinking;
      case ExpenseDecision.no:
        return l10n.passed;
    }
  }

  /// Internal key for data export/serialization (not for UI display)
  String get label {
    switch (this) {
      case ExpenseDecision.yes:
        return 'yes';
      case ExpenseDecision.thinking:
        return 'thinking';
      case ExpenseDecision.no:
        return 'no';
    }
  }
}

enum RecordType {
  real,
  simulation;

  String get label {
    switch (this) {
      case RecordType.real:
        return 'Gerçek';
      case RecordType.simulation:
        return 'Simülasyon';
    }
  }
}

/// Gider tipi: tek seferlik, tekrarlayan veya taksitli
enum ExpenseType {
  single,
  recurring,
  installment;

  String get label {
    switch (this) {
      case ExpenseType.single:
        return 'Tek Seferlik';
      case ExpenseType.recurring:
        return 'Tekrarlayan';
      case ExpenseType.installment:
        return 'Taksitli';
    }
  }
}

/// Wealth Coach: Expense Status - aktif, düşünüyor veya arşivlenmiş
enum ExpenseStatus {
  active,
  thinking,
  archived;

  String get label {
    switch (this) {
      case ExpenseStatus.active:
        return 'Aktif';
      case ExpenseStatus.thinking:
        return 'Karar Aşamasında';
      case ExpenseStatus.archived:
        return 'İrade Zaferi';
    }
  }

  String get displayName => label;
}

/// Wealth Coach: Kategori bazlı eşik değerleri (Smart Choice için varsayılan tutarlar)
class CategoryThresholds {
  static const Map<String, double> defaults = {
    'Yiyecek': 150.0, // Kahve yerine evde demle
    'Ulaşım': 100.0, // Taksi yerine toplu taşıma
    'Giyim': 500.0, // Marka yerine alternatif
    'Elektronik': 2000.0, // Yeni model yerine eski
    'Eğlence': 200.0, // Sinema yerine evde film
    'Sağlık': 100.0, // Vitamin vs
    'Eğitim': 300.0, // Kurs alternatifleri
    'Faturalar': 200.0, // Paket downgrade
    'Abonelik': 100.0, // Abonelik harcaması
    'Diğer': 150.0,
  };

  static double getDefault(String category) {
    return defaults[category] ?? 150.0;
  }
}

/// Wealth Coach: Kategori bazlı düşünme süreleri (saat cinsinden)
class ThinkingDurations {
  static const Map<String, int> hours = {
    'Yiyecek': 24, // 1 gün - hızlı karar
    'Ulaşım': 48, // 2 gün
    'Giyim': 72, // 3 gün
    'Elektronik': 168, // 7 gün - büyük alım
    'Eğlence': 48, // 2 gün
    'Sağlık': 24, // 1 gün - acil olabilir
    'Eğitim': 120, // 5 gün
    'Faturalar': 72, // 3 gün
    'Abonelik': 24, // 1 gün - otomatik kayıt
    'Diğer': 48, // 2 gün
  };

  static int getHours(String category) {
    return hours[category] ?? 48;
  }

  static Duration getDuration(String category) {
    return Duration(hours: getHours(category));
  }
}

class Expense {
  final double amount;
  final String category;
  final String? subCategory; // Opsiyonel alt kategori
  final DateTime date;
  final double hoursRequired;
  final double daysRequired;
  final ExpenseDecision? decision;
  final DateTime? decisionDate;
  final RecordType recordType;

  // Wealth Coach: Yeni alanlar
  final ExpenseStatus status;
  final double? savedFrom; // Smart Choice için alternatif tutar
  final bool isSmartChoice; // Smart Choice toggle kullanıldı mı
  final DateTime? archivedAt; // Arşivlenme tarihi
  final String? archiveReason; // Arşivlenme nedeni

  // Multi-currency: Orijinal para birimi bilgisi
  final double? originalAmount; // Girilen tutar (farklı para biriminde)
  final String? originalCurrency; // Girilen para birimi kodu (USD, EUR, vb.)

  // Gider tipi ve zorunluluk
  final ExpenseType type;
  final bool isMandatory; // Zorunlu gider mi? (kira, fatura, kredi)

  // Taksit bilgileri
  final int? installmentCount; // Toplam taksit sayısı
  final int? currentInstallment; // Şu anki taksit (1, 2, 3...)
  final double? cashPrice; // Peşin fiyat
  final double? installmentTotal; // Taksitli toplam (vade farkı dahil)
  final DateTime? installmentStartDate; // Taksit başlangıç tarihi

  // Otomatik abonelik kaydı
  final bool isAutoRecorded; // Abonelikten otomatik oluşturuldu mu?
  final String? subscriptionId; // Kaynak abonelik ID'si

  const Expense({
    required this.amount,
    required this.category,
    this.subCategory,
    required this.date,
    required this.hoursRequired,
    required this.daysRequired,
    this.decision,
    this.decisionDate,
    this.recordType = RecordType.real,
    // Wealth Coach: Yeni alanlar
    this.status = ExpenseStatus.active,
    this.savedFrom,
    this.isSmartChoice = false,
    this.archivedAt,
    this.archiveReason,
    // Multi-currency
    this.originalAmount,
    this.originalCurrency,
    // Gider tipi ve taksit
    this.type = ExpenseType.single,
    this.isMandatory = false,
    this.installmentCount,
    this.currentInstallment,
    this.cashPrice,
    this.installmentTotal,
    this.installmentStartDate,
    // Otomatik abonelik kaydı
    this.isAutoRecorded = false,
    this.subscriptionId,
  });

  bool get isSimulation => recordType == RecordType.simulation;
  bool get isReal => recordType == RecordType.real;

  // Taksit getter'ları
  /// Aylık taksit tutarı
  double get installmentAmount {
    if (installmentTotal != null &&
        installmentCount != null &&
        installmentCount! > 0) {
      return installmentTotal! / installmentCount!;
    }
    return amount;
  }

  /// Vade farkı tutarı
  double get interestAmount {
    if (installmentTotal != null && cashPrice != null) {
      return installmentTotal! - cashPrice!;
    }
    return 0;
  }

  /// Vade farkı yüzdesi
  double get interestRate {
    if (cashPrice != null && cashPrice! > 0 && interestAmount > 0) {
      return (interestAmount / cashPrice!) * 100;
    }
    return 0;
  }

  /// Kalan taksit sayısı
  int get remainingInstallments {
    if (installmentCount != null && currentInstallment != null) {
      return installmentCount! - currentInstallment!;
    }
    return 0;
  }

  /// Taksit bitti mi?
  bool get isInstallmentCompleted {
    return type == ExpenseType.installment && remainingInstallments <= 0;
  }

  // Wealth Coach: Smart Choice tasarruf tutarı
  double get savedAmount => isSmartChoice && savedFrom != null
      ? (savedFrom! - amount).clamp(0, double.infinity)
      : 0;

  /// Wealth Coach: Thinking items için son kullanma tarihi
  DateTime? get expirationDate {
    if (decision != ExpenseDecision.thinking) return null;
    final duration = ThinkingDurations.getDuration(category);
    return (decisionDate ?? date).add(duration);
  }

  /// Wealth Coach: Thinking item süresi dolmuş mu?
  bool get isExpired {
    final expDate = expirationDate;
    if (expDate == null) return false;
    return DateTime.now().isAfter(expDate);
  }

  /// Wealth Coach: Kalan süre (thinking items için)
  Duration? get remainingTime {
    final expDate = expirationDate;
    if (expDate == null) return null;
    final remaining = expDate.difference(DateTime.now());
    return remaining.isNegative ? Duration.zero : remaining;
  }

  // Simulation thresholds (fixed, salary-independent)
  static const double _realMaxThreshold = 250000; // Below this: always real
  static const double _simulationMinThreshold =
      750000; // Above this: always simulation

  /// Check if amount requires user dialog (middle range: 250k - 750k)
  static bool needsSimulationDialog(double amount) {
    return amount >= _realMaxThreshold && amount <= _simulationMinThreshold;
  }

  /// Otomatik simülasyon tespiti (sabit limitler, maaştan bağımsız)
  /// < 250,000₺ = gerçek harcama
  /// > 750,000₺ = simülasyon
  /// 250,000₺ - 750,000₺ arası = kullanıcıya sor (needsSimulationDialog)
  static RecordType detectRecordType(double amount, double hoursRequired) {
    if (amount < _realMaxThreshold) {
      return RecordType.real;
    }
    if (amount > _simulationMinThreshold) {
      return RecordType.simulation;
    }
    // Middle range: default to real, but caller should use needsSimulationDialog first
    return RecordType.real;
  }

  Expense copyWith({
    double? amount,
    String? category,
    String? subCategory,
    DateTime? date,
    double? hoursRequired,
    double? daysRequired,
    ExpenseDecision? decision,
    DateTime? decisionDate,
    RecordType? recordType,
    // Wealth Coach: Yeni alanlar
    ExpenseStatus? status,
    double? savedFrom,
    bool? isSmartChoice,
    DateTime? archivedAt,
    String? archiveReason,
    // Multi-currency
    double? originalAmount,
    String? originalCurrency,
    // Gider tipi ve taksit
    ExpenseType? type,
    bool? isMandatory,
    int? installmentCount,
    int? currentInstallment,
    double? cashPrice,
    double? installmentTotal,
    DateTime? installmentStartDate,
    // Otomatik abonelik kaydı
    bool? isAutoRecorded,
    String? subscriptionId,
  }) {
    return Expense(
      amount: amount ?? this.amount,
      category: category ?? this.category,
      subCategory: subCategory ?? this.subCategory,
      date: date ?? this.date,
      hoursRequired: hoursRequired ?? this.hoursRequired,
      daysRequired: daysRequired ?? this.daysRequired,
      decision: decision ?? this.decision,
      decisionDate: decisionDate ?? this.decisionDate,
      recordType: recordType ?? this.recordType,
      // Wealth Coach: Yeni alanlar
      status: status ?? this.status,
      savedFrom: savedFrom ?? this.savedFrom,
      isSmartChoice: isSmartChoice ?? this.isSmartChoice,
      archivedAt: archivedAt ?? this.archivedAt,
      archiveReason: archiveReason ?? this.archiveReason,
      // Multi-currency
      originalAmount: originalAmount ?? this.originalAmount,
      originalCurrency: originalCurrency ?? this.originalCurrency,
      // Gider tipi ve taksit
      type: type ?? this.type,
      isMandatory: isMandatory ?? this.isMandatory,
      installmentCount: installmentCount ?? this.installmentCount,
      currentInstallment: currentInstallment ?? this.currentInstallment,
      cashPrice: cashPrice ?? this.cashPrice,
      installmentTotal: installmentTotal ?? this.installmentTotal,
      installmentStartDate: installmentStartDate ?? this.installmentStartDate,
      // Otomatik abonelik kaydı
      isAutoRecorded: isAutoRecorded ?? this.isAutoRecorded,
      subscriptionId: subscriptionId ?? this.subscriptionId,
    );
  }

  Map<String, dynamic> toJson() => {
    'amount': amount,
    'category': category,
    if (subCategory != null) 'subCategory': subCategory,
    'date': date.toIso8601String(),
    'hoursRequired': hoursRequired,
    'daysRequired': daysRequired,
    'decision': decision?.name,
    'decisionDate': decisionDate?.toIso8601String(),
    'recordType': recordType.name,
    // Wealth Coach: Yeni alanlar
    'status': status.name,
    if (savedFrom != null) 'savedFrom': savedFrom,
    'isSmartChoice': isSmartChoice,
    if (archivedAt != null) 'archivedAt': archivedAt!.toIso8601String(),
    if (archiveReason != null) 'archiveReason': archiveReason,
    // Multi-currency
    if (originalAmount != null) 'originalAmount': originalAmount,
    if (originalCurrency != null) 'originalCurrency': originalCurrency,
    // Gider tipi ve taksit
    'type': type.name,
    'isMandatory': isMandatory,
    if (installmentCount != null) 'installmentCount': installmentCount,
    if (currentInstallment != null) 'currentInstallment': currentInstallment,
    if (cashPrice != null) 'cashPrice': cashPrice,
    if (installmentTotal != null) 'installmentTotal': installmentTotal,
    if (installmentStartDate != null)
      'installmentStartDate': installmentStartDate!.toIso8601String(),
    // Otomatik abonelik kaydı
    'isAutoRecorded': isAutoRecorded,
    if (subscriptionId != null) 'subscriptionId': subscriptionId,
  };

  factory Expense.fromJson(Map<String, dynamic> json) => Expense(
    amount: (json['amount'] as num).toDouble(),
    category: json['category'] as String,
    // Eski kayıtlar için null (backward compatible)
    subCategory: json['subCategory'] as String?,
    date: DateTime.parse(json['date'] as String),
    hoursRequired: (json['hoursRequired'] as num).toDouble(),
    daysRequired: (json['daysRequired'] as num).toDouble(),
    decision: json['decision'] != null
        ? ExpenseDecision.values.byName(json['decision'] as String)
        : null,
    decisionDate: json['decisionDate'] != null
        ? DateTime.parse(json['decisionDate'] as String)
        : null,
    // Eski kayıtlar için varsayılan: real
    recordType: json['recordType'] != null
        ? RecordType.values.byName(json['recordType'] as String)
        : RecordType.real,
    // Wealth Coach: Yeni alanlar (backward compatible)
    status: json['status'] != null
        ? ExpenseStatus.values.byName(json['status'] as String)
        : ExpenseStatus.active,
    savedFrom: json['savedFrom'] != null
        ? (json['savedFrom'] as num).toDouble()
        : null,
    isSmartChoice: json['isSmartChoice'] as bool? ?? false,
    archivedAt: json['archivedAt'] != null
        ? DateTime.parse(json['archivedAt'] as String)
        : null,
    archiveReason: json['archiveReason'] as String?,
    // Multi-currency (backward compatible)
    originalAmount: json['originalAmount'] != null
        ? (json['originalAmount'] as num).toDouble()
        : null,
    originalCurrency: json['originalCurrency'] as String?,
    // Gider tipi ve taksit (backward compatible)
    type: json['type'] != null
        ? ExpenseType.values.firstWhere(
            (e) => e.name == json['type'],
            orElse: () => ExpenseType.single,
          )
        : ExpenseType.single,
    isMandatory: json['isMandatory'] as bool? ?? false,
    installmentCount: json['installmentCount'] as int?,
    currentInstallment: json['currentInstallment'] as int?,
    cashPrice: json['cashPrice'] != null
        ? (json['cashPrice'] as num).toDouble()
        : null,
    installmentTotal: json['installmentTotal'] != null
        ? (json['installmentTotal'] as num).toDouble()
        : null,
    installmentStartDate: json['installmentStartDate'] != null
        ? DateTime.parse(json['installmentStartDate'] as String)
        : null,
    // Otomatik abonelik kaydı (backward compatible)
    isAutoRecorded: json['isAutoRecorded'] as bool? ?? false,
    subscriptionId: json['subscriptionId'] as String?,
  );

  static String encodeList(List<Expense> expenses) =>
      jsonEncode(expenses.map((e) => e.toJson()).toList());

  static List<Expense> decodeList(String json) =>
      (jsonDecode(json) as List).map((e) => Expense.fromJson(e)).toList();
}

class ExpenseCategory {
  static const List<String> all = [
    'Yiyecek',
    'Ulaşım',
    'Giyim',
    'Elektronik',
    'Eğlence',
    'Sağlık',
    'Eğitim',
    'Faturalar',
    'Abonelik',
    'Diğer',
  ];

  /// Kategori ikonu (Cupertino icon)
  static IconData getIcon(String category) {
    switch (category) {
      case 'Yiyecek':
        return CupertinoIcons.cart_fill;
      case 'Ulaşım':
        return CupertinoIcons.car_fill;
      case 'Giyim':
        return CupertinoIcons.tag_fill;
      case 'Elektronik':
        return CupertinoIcons.device_phone_portrait;
      case 'Eğlence':
        return CupertinoIcons.gamecontroller_fill;
      case 'Sağlık':
        return CupertinoIcons.heart_fill;
      case 'Eğitim':
        return CupertinoIcons.book_fill;
      case 'Faturalar':
        return CupertinoIcons.doc_text_fill;
      case 'Abonelik':
        return CupertinoIcons.bell_fill;
      case 'Diğer':
      default:
        return CupertinoIcons.cube_box_fill;
    }
  }

  /// Kategori rengi
  static Color getColor(String category) {
    switch (category) {
      case 'Yiyecek':
        return AppColors.categoryFood;
      case 'Ulaşım':
        return AppColors.categoryTransport;
      case 'Giyim':
        return AppColors.categoryShopping;
      case 'Elektronik':
        return AppColors.categoryEntertainment;
      case 'Eğlence':
        return AppColors.categoryBills;
      case 'Sağlık':
        return AppColors.categoryHealth;
      case 'Eğitim':
        return AppColors.categoryEducation;
      case 'Faturalar':
        return AppColors.categoryOther;
      case 'Abonelik':
        return AppColors.primary;
      case 'Diğer':
      default:
        return AppColors.categoryDefault;
    }
  }

  /// Lokalize kategori ismi (UI gösterimi için)
  static String getLocalizedName(String category, AppLocalizations l10n) {
    switch (category) {
      case 'Yiyecek':
        return l10n.categoryFood;
      case 'Ulaşım':
        return l10n.categoryTransport;
      case 'Giyim':
        return l10n.categoryClothing;
      case 'Elektronik':
        return l10n.categoryElectronics;
      case 'Eğlence':
        return l10n.categoryEntertainment;
      case 'Sağlık':
        return l10n.categoryHealth;
      case 'Eğitim':
        return l10n.categoryEducation;
      case 'Faturalar':
        return l10n.categoryBills;
      case 'Abonelik':
        return l10n.categorySubscription;
      case 'Diğer':
      default:
        return l10n.categoryOther;
    }
  }
}

class DecisionStats {
  final int yesCount;
  final double yesTotal;
  final int noCount;
  final double noTotal;
  final int thinkingCount;
  final double thinkingTotal;
  final double savedHours;
  final double savedDays;
  // Wealth Coach: Yeni istatistikler
  final double smartChoiceSaved; // Smart Choice ile tasarruf
  final int smartChoiceCount; // Smart Choice kullanan harcama sayısı

  const DecisionStats({
    this.yesCount = 0,
    this.yesTotal = 0,
    this.noCount = 0,
    this.noTotal = 0,
    this.thinkingCount = 0,
    this.thinkingTotal = 0,
    this.savedHours = 0,
    this.savedDays = 0,
    // Wealth Coach
    this.smartChoiceSaved = 0,
    this.smartChoiceCount = 0,
  });

  factory DecisionStats.fromExpenses(List<Expense> expenses) {
    int yesCount = 0;
    double yesTotal = 0;
    int noCount = 0;
    double noTotal = 0;
    int thinkingCount = 0;
    double thinkingTotal = 0;
    double savedHours = 0;
    double savedDays = 0;
    // Wealth Coach
    double smartChoiceSaved = 0;
    int smartChoiceCount = 0;

    for (final expense in expenses) {
      // Wealth Coach: Smart Choice hesaplamaları
      if (expense.isSmartChoice && expense.savedAmount > 0) {
        smartChoiceCount++;
        smartChoiceSaved += expense.savedAmount;
      }

      switch (expense.decision) {
        case ExpenseDecision.yes:
          yesCount++;
          yesTotal += expense.amount;
          break;
        case ExpenseDecision.no:
          noCount++;
          noTotal += expense.amount;
          savedHours += expense.hoursRequired;
          savedDays += expense.daysRequired;
          break;
        case ExpenseDecision.thinking:
          thinkingCount++;
          thinkingTotal += expense.amount;
          break;
        case null:
          break;
      }
    }

    return DecisionStats(
      yesCount: yesCount,
      yesTotal: yesTotal,
      noCount: noCount,
      noTotal: noTotal,
      thinkingCount: thinkingCount,
      thinkingTotal: thinkingTotal,
      savedHours: savedHours,
      savedDays: savedDays,
      // Wealth Coach
      smartChoiceSaved: smartChoiceSaved,
      smartChoiceCount: smartChoiceCount,
    );
  }

  double get savedAmount => noTotal;
  int get totalDecisions => yesCount + noCount + thinkingCount;

  // Wealth Coach: Toplam tasarruf (vazgeçilen + smart choice)
  double get totalSaved => noTotal + smartChoiceSaved;
}


--- FILE: lib/models/expense_result.dart ---

class ExpenseResult {
  final double expenseAmount;
  final double hoursRequired;
  final double daysRequired;

  const ExpenseResult({
    required this.expenseAmount,
    required this.hoursRequired,
    required this.daysRequired,
  });

  String get formattedResult {
    return 'Bu ürünü almak için ~${hoursRequired.toStringAsFixed(1)} saat veya ${daysRequired.toStringAsFixed(1)} gün çalışmanız gerekir';
  }
}


--- FILE: lib/models/savings_pool.dart ---

import 'package:cloud_firestore/cloud_firestore.dart';

/// Tasarruf Havuzu - Kullanıcının vazgeçtiği paraları ve hayallere ayırdığı tutarları takip eder
class SavingsPool {
  /// Toplam tasarruf (vazgeçilen paralar)
  final double totalSaved;

  /// Hayallere ayrılan tutar
  final double allocatedToDreams;

  /// Gölge borç - havuz eksiye düşerse
  final double shadowDebt;

  /// Bu ay joker kullanıldı mı
  final bool jokerUsedThisMonth;

  /// Joker reset tarihi (ay başı)
  final DateTime jokerResetDate;

  /// Son güncelleme tarihi
  final DateTime lastUpdated;

  const SavingsPool({
    this.totalSaved = 0,
    this.allocatedToDreams = 0,
    this.shadowDebt = 0,
    this.jokerUsedThisMonth = false,
    required this.jokerResetDate,
    required this.lastUpdated,
  });

  /// Kullanılabilir tutar (hayallere ayrılmamış)
  double get available => totalSaved - allocatedToDreams - shadowDebt;

  /// Havuz eksiye düşmüş mü
  bool get hasDebt => shadowDebt > 0;

  /// Joker kullanılabilir mi
  bool get canUseJoker => !jokerUsedThisMonth;

  /// Boş havuz oluştur
  factory SavingsPool.empty() {
    final now = DateTime.now();
    return SavingsPool(
      totalSaved: 0,
      allocatedToDreams: 0,
      shadowDebt: 0,
      jokerUsedThisMonth: false,
      jokerResetDate: DateTime(now.year, now.month, 1),
      lastUpdated: now,
    );
  }

  /// Firestore veya JSON'dan oluştur (hybrid support)
  factory SavingsPool.fromFirestore(Map<String, dynamic> data) {
    // Handle both Timestamp (Firestore) and int (JSON) for dates
    DateTime parseDate(dynamic value, DateTime defaultValue) {
      if (value == null) return defaultValue;
      if (value is Timestamp) return value.toDate();
      if (value is int) return DateTime.fromMillisecondsSinceEpoch(value);
      if (value is String) return DateTime.tryParse(value) ?? defaultValue;
      return defaultValue;
    }

    final now = DateTime.now();
    return SavingsPool(
      totalSaved: (data['totalSaved'] as num?)?.toDouble() ?? 0,
      allocatedToDreams: (data['allocatedToDreams'] as num?)?.toDouble() ?? 0,
      shadowDebt: (data['shadowDebt'] as num?)?.toDouble() ?? 0,
      jokerUsedThisMonth: data['jokerUsedThisMonth'] as bool? ?? false,
      jokerResetDate: parseDate(
        data['jokerResetDate'],
        DateTime(now.year, now.month, 1),
      ),
      lastUpdated: parseDate(data['lastUpdated'], now),
    );
  }

  /// Firestore'a kaydet (uses Timestamp for Firestore compatibility)
  Map<String, dynamic> toFirestore({bool forLocalStorage = false}) {
    return {
      'totalSaved': totalSaved,
      'allocatedToDreams': allocatedToDreams,
      'shadowDebt': shadowDebt,
      'jokerUsedThisMonth': jokerUsedThisMonth,
      'jokerResetDate': forLocalStorage
          ? jokerResetDate.millisecondsSinceEpoch
          : Timestamp.fromDate(jokerResetDate),
      'lastUpdated': forLocalStorage
          ? lastUpdated.millisecondsSinceEpoch
          : Timestamp.fromDate(lastUpdated),
    };
  }

  /// Kopyala ve güncelle
  SavingsPool copyWith({
    double? totalSaved,
    double? allocatedToDreams,
    double? shadowDebt,
    bool? jokerUsedThisMonth,
    DateTime? jokerResetDate,
    DateTime? lastUpdated,
  }) {
    return SavingsPool(
      totalSaved: totalSaved ?? this.totalSaved,
      allocatedToDreams: allocatedToDreams ?? this.allocatedToDreams,
      shadowDebt: shadowDebt ?? this.shadowDebt,
      jokerUsedThisMonth: jokerUsedThisMonth ?? this.jokerUsedThisMonth,
      jokerResetDate: jokerResetDate ?? this.jokerResetDate,
      lastUpdated: lastUpdated ?? DateTime.now(),
    );
  }

  @override
  String toString() {
    return 'SavingsPool(total: $totalSaved, allocated: $allocatedToDreams, available: $available, debt: $shadowDebt, joker: $jokerUsedThisMonth)';
  }
}

/// Bütçe kaydırma kaynakları
enum BudgetShiftSource {
  food,
  entertainment,
  clothing,
  transport,
  shopping,
  health,
  education,
  extraIncome,
  joker,
}

extension BudgetShiftSourceExtension on BudgetShiftSource {
  String get labelTR {
    switch (this) {
      case BudgetShiftSource.food:
        return 'Yemek bütçemden';
      case BudgetShiftSource.entertainment:
        return 'Eğlence bütçemden';
      case BudgetShiftSource.clothing:
        return 'Giyim bütçemden';
      case BudgetShiftSource.transport:
        return 'Ulaşım bütçemden';
      case BudgetShiftSource.shopping:
        return 'Alışveriş bütçemden';
      case BudgetShiftSource.health:
        return 'Sağlık bütçemden';
      case BudgetShiftSource.education:
        return 'Eğitim bütçemden';
      case BudgetShiftSource.extraIncome:
        return 'Ekstra gelir elde ettim';
      case BudgetShiftSource.joker:
        return 'Joker Kullan (ayda 1)';
    }
  }

  String get labelEN {
    switch (this) {
      case BudgetShiftSource.food:
        return 'From my food budget';
      case BudgetShiftSource.entertainment:
        return 'From my entertainment budget';
      case BudgetShiftSource.clothing:
        return 'From my clothing budget';
      case BudgetShiftSource.transport:
        return 'From my transport budget';
      case BudgetShiftSource.shopping:
        return 'From my shopping budget';
      case BudgetShiftSource.health:
        return 'From my health budget';
      case BudgetShiftSource.education:
        return 'From my education budget';
      case BudgetShiftSource.extraIncome:
        return 'I earned extra income';
      case BudgetShiftSource.joker:
        return 'Use Joker (1/month)';
    }
  }

  String get emoji {
    switch (this) {
      case BudgetShiftSource.food:
        return '🍔';
      case BudgetShiftSource.entertainment:
        return '🎬';
      case BudgetShiftSource.clothing:
        return '👕';
      case BudgetShiftSource.transport:
        return '🚗';
      case BudgetShiftSource.shopping:
        return '🛒';
      case BudgetShiftSource.health:
        return '💊';
      case BudgetShiftSource.education:
        return '📚';
      case BudgetShiftSource.extraIncome:
        return '💰';
      case BudgetShiftSource.joker:
        return '🃏';
    }
  }

  /// Expense kategorisi karşılığı
  String? get expenseCategory {
    switch (this) {
      case BudgetShiftSource.food:
        return 'Yemek';
      case BudgetShiftSource.entertainment:
        return 'Eğlence';
      case BudgetShiftSource.clothing:
        return 'Giyim';
      case BudgetShiftSource.transport:
        return 'Ulaşım';
      case BudgetShiftSource.shopping:
        return 'Alışveriş';
      case BudgetShiftSource.health:
        return 'Sağlık';
      case BudgetShiftSource.education:
        return 'Eğitim';
      case BudgetShiftSource.extraIncome:
      case BudgetShiftSource.joker:
        return null;
    }
  }
}


--- FILE: lib/models/income.dart ---

import 'dart:convert';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:vantag/l10n/app_localizations.dart';
import 'package:vantag/theme/app_theme.dart';

/// One-time income types
enum IncomeType {
  salary, // Regular monthly salary
  bonus, // Work bonus
  gift, // Gift money
  refund, // Refund/cashback
  freelance, // Freelance work
  rental, // Rental income
  investment, // Investment returns
  other; // Other income

  IconData get icon {
    switch (this) {
      case IncomeType.salary:
        return CupertinoIcons.briefcase_fill;
      case IncomeType.bonus:
        return CupertinoIcons.rosette;
      case IncomeType.gift:
        return CupertinoIcons.gift_fill;
      case IncomeType.refund:
        return CupertinoIcons.arrow_counterclockwise;
      case IncomeType.freelance:
        return CupertinoIcons.desktopcomputer;
      case IncomeType.rental:
        return CupertinoIcons.house_fill;
      case IncomeType.investment:
        return CupertinoIcons.chart_bar_fill;
      case IncomeType.other:
        return CupertinoIcons.money_dollar_circle_fill;
    }
  }

  Color get color {
    switch (this) {
      case IncomeType.salary:
        return AppColors.incomeSalary;
      case IncomeType.bonus:
        return AppColors.incomeBonus;
      case IncomeType.gift:
        return AppColors.incomeFreelance;
      case IncomeType.refund:
        return AppColors.incomePassive;
      case IncomeType.freelance:
        return AppColors.incomeRental;
      case IncomeType.rental:
        return AppColors.incomeSideJob;
      case IncomeType.investment:
        return AppColors.incomeOther;
      case IncomeType.other:
        return AppColors.incomeDefault;
    }
  }

  /// Get localized label for UI display
  String getLocalizedLabel(AppLocalizations l10n) {
    switch (this) {
      case IncomeType.salary:
        return l10n.incomeTypeSalary;
      case IncomeType.bonus:
        return l10n.incomeTypeBonus;
      case IncomeType.gift:
        return l10n.incomeTypeGift;
      case IncomeType.refund:
        return l10n.incomeTypeRefund;
      case IncomeType.freelance:
        return l10n.incomeTypeFreelance;
      case IncomeType.rental:
        return l10n.incomeTypeRental;
      case IncomeType.investment:
        return l10n.incomeTypeInvestment;
      case IncomeType.other:
        return l10n.incomeTypeOther;
    }
  }

  static IncomeType fromString(String value) {
    return IncomeType.values.firstWhere(
      (e) => e.name == value,
      orElse: () => IncomeType.other,
    );
  }
}

/// One-time income model for tracking bonus, gift, refund, etc.
class Income {
  final String id;
  final String title;
  final double amount;
  final String currencyCode;
  final IncomeType type;
  final DateTime date;
  final String? notes;
  final bool isRecurring;

  const Income({
    required this.id,
    required this.title,
    required this.amount,
    this.currencyCode = 'TRY',
    required this.type,
    required this.date,
    this.notes,
    this.isRecurring = false,
  });

  /// Generate unique ID
  static String generateId() {
    return DateTime.now().millisecondsSinceEpoch.toString();
  }

  /// Factory for salary income (monthly)
  factory Income.salary({
    required double amount,
    required String title,
    String currencyCode = 'TRY',
    DateTime? date,
  }) {
    return Income(
      id: generateId(),
      title: title,
      amount: amount,
      currencyCode: currencyCode,
      type: IncomeType.salary,
      date: date ?? DateTime.now(),
      isRecurring: true,
    );
  }

  /// Factory for bonus income
  factory Income.bonus({
    required double amount,
    required String title,
    String currencyCode = 'TRY',
    String? notes,
  }) {
    return Income(
      id: generateId(),
      title: title,
      amount: amount,
      currencyCode: currencyCode,
      type: IncomeType.bonus,
      date: DateTime.now(),
      notes: notes,
    );
  }

  /// Factory for gift income
  factory Income.gift({
    required double amount,
    String? title,
    String currencyCode = 'TRY',
    String? notes,
  }) {
    return Income(
      id: generateId(),
      title: title ?? 'Gift',
      amount: amount,
      currencyCode: currencyCode,
      type: IncomeType.gift,
      date: DateTime.now(),
      notes: notes,
    );
  }

  /// Factory for refund income
  factory Income.refund({
    required double amount,
    required String title,
    String currencyCode = 'TRY',
    String? notes,
  }) {
    return Income(
      id: generateId(),
      title: title,
      amount: amount,
      currencyCode: currencyCode,
      type: IncomeType.refund,
      date: DateTime.now(),
      notes: notes,
    );
  }

  Income copyWith({
    String? id,
    String? title,
    double? amount,
    String? currencyCode,
    IncomeType? type,
    DateTime? date,
    String? notes,
    bool? isRecurring,
  }) {
    return Income(
      id: id ?? this.id,
      title: title ?? this.title,
      amount: amount ?? this.amount,
      currencyCode: currencyCode ?? this.currencyCode,
      type: type ?? this.type,
      date: date ?? this.date,
      notes: notes ?? this.notes,
      isRecurring: isRecurring ?? this.isRecurring,
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'title': title,
      'amount': amount,
      'currencyCode': currencyCode,
      'type': type.name,
      'date': date.toIso8601String(),
      'notes': notes,
      'isRecurring': isRecurring,
    };
  }

  factory Income.fromJson(Map<String, dynamic> json) {
    return Income(
      id: json['id'] as String,
      title: json['title'] as String,
      amount: (json['amount'] as num).toDouble(),
      currencyCode: json['currencyCode'] as String? ?? 'TRY',
      type: IncomeType.fromString(json['type'] as String),
      date: DateTime.parse(json['date'] as String),
      notes: json['notes'] as String?,
      isRecurring: json['isRecurring'] as bool? ?? false,
    );
  }

  static String encodeList(List<Income> incomes) {
    return jsonEncode(incomes.map((i) => i.toJson()).toList());
  }

  static List<Income> decodeList(String json) {
    final list = jsonDecode(json) as List;
    return list
        .map((item) => Income.fromJson(item as Map<String, dynamic>))
        .toList();
  }

  @override
  String toString() =>
      'Income(title: $title, amount: $amount, type: ${type.name})';
}


--- FILE: lib/models/pursuit.dart ---

import 'dart:convert';
import 'package:uuid/uuid.dart';

/// Pursuit categories with emoji representation
enum PursuitCategory {
  tech, // 📱 Teknoloji
  travel, // ✈️ Seyahat
  home, // 🏠 Ev
  fashion, // 👗 Moda
  vehicle, // 🚗 Araç
  education, // 📚 Eğitim
  health, // 💊 Sağlık
  other; // 📦 Diğer

  String get emoji {
    switch (this) {
      case PursuitCategory.tech:
        return '📱';
      case PursuitCategory.travel:
        return '✈️';
      case PursuitCategory.home:
        return '🏠';
      case PursuitCategory.fashion:
        return '👗';
      case PursuitCategory.vehicle:
        return '🚗';
      case PursuitCategory.education:
        return '📚';
      case PursuitCategory.health:
        return '💊';
      case PursuitCategory.other:
        return '📦';
    }
  }

  String get labelTr {
    switch (this) {
      case PursuitCategory.tech:
        return 'Teknoloji';
      case PursuitCategory.travel:
        return 'Seyahat';
      case PursuitCategory.home:
        return 'Ev';
      case PursuitCategory.fashion:
        return 'Moda';
      case PursuitCategory.vehicle:
        return 'Araç';
      case PursuitCategory.education:
        return 'Eğitim';
      case PursuitCategory.health:
        return 'Sağlık';
      case PursuitCategory.other:
        return 'Diğer';
    }
  }

  String get labelEn {
    switch (this) {
      case PursuitCategory.tech:
        return 'Tech';
      case PursuitCategory.travel:
        return 'Travel';
      case PursuitCategory.home:
        return 'Home';
      case PursuitCategory.fashion:
        return 'Fashion';
      case PursuitCategory.vehicle:
        return 'Vehicle';
      case PursuitCategory.education:
        return 'Education';
      case PursuitCategory.health:
        return 'Health';
      case PursuitCategory.other:
        return 'Other';
    }
  }
}

/// A savings goal (pursuit/dream) that the user is working toward
class Pursuit {
  final String id;
  final String name;
  final double targetAmount;
  final String currency;
  final double savedAmount;
  final String? imageUrl;
  final String emoji;
  final PursuitCategory category;
  final DateTime createdAt;
  final DateTime updatedAt;
  final DateTime? completedAt;
  final bool isArchived;
  final int sortOrder;

  const Pursuit({
    required this.id,
    required this.name,
    required this.targetAmount,
    required this.currency,
    this.savedAmount = 0,
    this.imageUrl,
    required this.emoji,
    required this.category,
    required this.createdAt,
    required this.updatedAt,
    this.completedAt,
    this.isArchived = false,
    this.sortOrder = 0,
  });

  /// Progress percentage (0.0 to 1.0)
  double get progressPercent =>
      targetAmount > 0 ? (savedAmount / targetAmount).clamp(0.0, 1.0) : 0.0;

  /// Progress percentage for display (0 to 100)
  int get progressPercentDisplay => (progressPercent * 100).round();

  /// Check if the pursuit is completed
  bool get isCompleted => completedAt != null;

  /// Remaining amount to reach target
  double get remainingAmount =>
      (targetAmount - savedAmount).clamp(0.0, double.infinity);

  /// Check if target has been reached (for completion detection)
  bool get hasReachedTarget => savedAmount >= targetAmount;

  /// Days since creation
  int get daysSinceCreation => DateTime.now().difference(createdAt).inDays;

  /// Factory to create a new pursuit with UUID
  factory Pursuit.create({
    required String name,
    required double targetAmount,
    required String currency,
    required PursuitCategory category,
    String? imageUrl,
    String? emoji,
    double initialSavings = 0,
  }) {
    final now = DateTime.now();
    return Pursuit(
      id: const Uuid().v4(),
      name: name,
      targetAmount: targetAmount,
      currency: currency,
      savedAmount: initialSavings,
      imageUrl: imageUrl,
      emoji: emoji ?? category.emoji,
      category: category,
      createdAt: now,
      updatedAt: now,
      sortOrder: now.millisecondsSinceEpoch,
    );
  }

  Pursuit copyWith({
    String? id,
    String? name,
    double? targetAmount,
    String? currency,
    double? savedAmount,
    String? imageUrl,
    String? emoji,
    PursuitCategory? category,
    DateTime? createdAt,
    DateTime? updatedAt,
    DateTime? completedAt,
    bool? isArchived,
    int? sortOrder,
  }) {
    return Pursuit(
      id: id ?? this.id,
      name: name ?? this.name,
      targetAmount: targetAmount ?? this.targetAmount,
      currency: currency ?? this.currency,
      savedAmount: savedAmount ?? this.savedAmount,
      imageUrl: imageUrl ?? this.imageUrl,
      emoji: emoji ?? this.emoji,
      category: category ?? this.category,
      createdAt: createdAt ?? this.createdAt,
      updatedAt: updatedAt ?? this.updatedAt,
      completedAt: completedAt ?? this.completedAt,
      isArchived: isArchived ?? this.isArchived,
      sortOrder: sortOrder ?? this.sortOrder,
    );
  }

  Map<String, dynamic> toJson() => {
    'id': id,
    'name': name,
    'targetAmount': targetAmount,
    'currency': currency,
    'savedAmount': savedAmount,
    if (imageUrl != null) 'imageUrl': imageUrl,
    'emoji': emoji,
    'category': category.name,
    'createdAt': createdAt.toIso8601String(),
    'updatedAt': updatedAt.toIso8601String(),
    if (completedAt != null) 'completedAt': completedAt!.toIso8601String(),
    'isArchived': isArchived,
    'sortOrder': sortOrder,
  };

  factory Pursuit.fromJson(Map<String, dynamic> json) {
    return Pursuit(
      id: json['id'] as String,
      name: json['name'] as String,
      targetAmount: (json['targetAmount'] as num).toDouble(),
      currency: json['currency'] as String? ?? 'TRY',
      savedAmount: (json['savedAmount'] as num?)?.toDouble() ?? 0,
      imageUrl: json['imageUrl'] as String?,
      emoji: json['emoji'] as String? ?? '📦',
      category: PursuitCategory.values.firstWhere(
        (e) => e.name == json['category'],
        orElse: () => PursuitCategory.other,
      ),
      createdAt: json['createdAt'] != null
          ? DateTime.parse(json['createdAt'] as String)
          : DateTime.now(),
      updatedAt: json['updatedAt'] != null
          ? DateTime.parse(json['updatedAt'] as String)
          : DateTime.now(),
      completedAt: json['completedAt'] != null
          ? DateTime.parse(json['completedAt'] as String)
          : null,
      isArchived: json['isArchived'] as bool? ?? false,
      sortOrder: json['sortOrder'] as int? ?? 0,
    );
  }

  static String encodeList(List<Pursuit> pursuits) =>
      jsonEncode(pursuits.map((p) => p.toJson()).toList());

  static List<Pursuit> decodeList(String json) =>
      (jsonDecode(json) as List).map((e) => Pursuit.fromJson(e)).toList();

  @override
  bool operator ==(Object other) =>
      identical(this, other) ||
      other is Pursuit && runtimeType == other.runtimeType && id == other.id;

  @override
  int get hashCode => id.hashCode;

  @override
  String toString() =>
      'Pursuit(id: $id, name: $name, progress: $progressPercentDisplay%)';
}


--- FILE: lib/models/user_profile.dart ---

import 'dart:math';
import 'income_source.dart';

class UserProfile {
  final List<IncomeSource> incomeSources;
  final double dailyHours;
  final int workDaysPerWeek;

  // Bütçe ayarları
  final double? monthlyBudget; // Kullanıcının belirlediği harcama limiti
  final double? monthlySavingsGoal; // Aylık tasarruf hedefi

  // Referral system
  final String? referralCode; // User's unique referral code (VANTAG-XXXXX)
  final String? referredBy; // Code used when signing up (if any)
  final int referralCount; // How many people used their code

  // Salary & Balance Management
  final int? salaryDay; // Day of month salary is received (1-31)
  final double? currentBalance; // Current bank balance
  final DateTime?
  lastSalaryConfirmedDate; // Last time user confirmed salary received

  // Base currency (locked for FREE users, from first salary entry)
  final String? baseCurrency; // TRY, USD, EUR, etc.

  const UserProfile({
    this.incomeSources = const [],
    this.dailyHours = 8,
    this.workDaysPerWeek = 5,
    this.monthlyBudget,
    this.monthlySavingsGoal,
    this.referralCode,
    this.referredBy,
    this.referralCount = 0,
    this.salaryDay,
    this.currentBalance,
    this.lastSalaryConfirmedDate,
    this.baseCurrency,
  });

  /// Generate a unique referral code (VANTAG-XXXXX)
  /// Uses characters that are not easily confused (no 0,O,1,I,L)
  static String generateReferralCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    final random = Random();
    final code = List.generate(
      5,
      (_) => chars[random.nextInt(chars.length)],
    ).join();
    return 'VANTAG-$code';
  }

  /// Toplam aylık gelir (tüm kaynakların toplamı)
  double get monthlyIncome {
    if (incomeSources.isEmpty) return 0;
    return incomeSources.fold<double>(0, (sum, source) => sum + source.amount);
  }

  /// Ana maaş (primary income)
  double get primaryIncome {
    final primary = incomeSources.where((s) => s.isPrimary).toList();
    if (primary.isEmpty) return 0;
    return primary.fold<double>(0, (sum, s) => sum + s.amount);
  }

  /// Ek gelirler toplamı
  double get additionalIncome {
    final additional = incomeSources.where((s) => !s.isPrimary).toList();
    if (additional.isEmpty) return 0;
    return additional.fold<double>(0, (sum, s) => sum + s.amount);
  }

  /// Ek gelir kaynakları
  List<IncomeSource> get additionalSources {
    return incomeSources.where((s) => !s.isPrimary).toList();
  }

  /// Ana gelir kaynağı
  IncomeSource? get primarySource {
    try {
      return incomeSources.firstWhere((s) => s.isPrimary);
    } catch (_) {
      return incomeSources.isNotEmpty ? incomeSources.first : null;
    }
  }

  /// Gelir kaynağı sayısı
  int get incomeSourceCount => incomeSources.length;

  /// Birden fazla gelir kaynağı var mı?
  bool get hasMultipleIncomeSources => incomeSources.length > 1;

  /// Aylık toplam çalışma saati (ortalama 4 hafta)
  double get monthlyWorkHours {
    return dailyHours * workDaysPerWeek * 4;
  }

  /// Saatlik ücret
  double get hourlyRate {
    if (monthlyWorkHours <= 0) return 0;
    return monthlyIncome / monthlyWorkHours;
  }

  /// Harcanabilir bütçe (bütçe - tasarruf hedefi)
  double get availableBudget {
    final budget = monthlyBudget ?? monthlyIncome;
    final savings = monthlySavingsGoal ?? 0;
    return budget - savings;
  }

  /// Bugün maaş günü mü?
  bool get isPayday {
    if (salaryDay == null) return false;
    final today = DateTime.now();
    return today.day == salaryDay;
  }

  /// Maaş bu ay onaylandı mı?
  bool get isSalaryConfirmedThisMonth {
    if (lastSalaryConfirmedDate == null) return false;
    final now = DateTime.now();
    return lastSalaryConfirmedDate!.year == now.year &&
        lastSalaryConfirmedDate!.month == now.month;
  }

  /// Maaş günü geçti mi (bu ay)?
  bool get hasPaydayPassedThisMonth {
    if (salaryDay == null) return false;
    final now = DateTime.now();
    return now.day > salaryDay!;
  }

  /// Sonraki maaş gününe kaç gün kaldı?
  int get daysUntilPayday {
    if (salaryDay == null) return -1;
    final now = DateTime.now();
    final thisMonth = DateTime(now.year, now.month, salaryDay!);

    if (now.day < salaryDay!) {
      // Bu ayın maaş günü henüz gelmedi
      return thisMonth.difference(now).inDays;
    } else {
      // Gelecek ayın maaş günü
      final nextMonth = DateTime(now.year, now.month + 1, salaryDay!);
      return nextMonth.difference(now).inDays;
    }
  }

  UserProfile copyWith({
    List<IncomeSource>? incomeSources,
    double? dailyHours,
    int? workDaysPerWeek,
    double? monthlyBudget,
    double? monthlySavingsGoal,
    String? referralCode,
    String? referredBy,
    int? referralCount,
    int? salaryDay,
    double? currentBalance,
    DateTime? lastSalaryConfirmedDate,
    String? baseCurrency,
  }) {
    return UserProfile(
      incomeSources: incomeSources ?? this.incomeSources,
      dailyHours: dailyHours ?? this.dailyHours,
      workDaysPerWeek: workDaysPerWeek ?? this.workDaysPerWeek,
      monthlyBudget: monthlyBudget ?? this.monthlyBudget,
      monthlySavingsGoal: monthlySavingsGoal ?? this.monthlySavingsGoal,
      referralCode: referralCode ?? this.referralCode,
      referredBy: referredBy ?? this.referredBy,
      referralCount: referralCount ?? this.referralCount,
      salaryDay: salaryDay ?? this.salaryDay,
      currentBalance: currentBalance ?? this.currentBalance,
      lastSalaryConfirmedDate:
          lastSalaryConfirmedDate ?? this.lastSalaryConfirmedDate,
      baseCurrency: baseCurrency ?? this.baseCurrency,
    );
  }

  /// Gelir kaynağı ekle
  UserProfile addIncomeSource(IncomeSource source) {
    return copyWith(incomeSources: [...incomeSources, source]);
  }

  /// Gelir kaynağı güncelle
  UserProfile updateIncomeSource(String id, IncomeSource updatedSource) {
    final newList = incomeSources.map((s) {
      return s.id == id ? updatedSource : s;
    }).toList();
    return copyWith(incomeSources: newList);
  }

  /// Gelir kaynağı sil
  UserProfile removeIncomeSource(String id) {
    return copyWith(
      incomeSources: incomeSources.where((s) => s.id != id).toList(),
    );
  }

  /// Legacy constructor - eski monthlyIncome parametresi için
  factory UserProfile.legacy({
    required double monthlyIncome,
    required double dailyHours,
    required int workDaysPerWeek,
  }) {
    // Eski format: tek maaş kaynağı oluştur
    final salarySource = IncomeSource.salary(
      amount: monthlyIncome,
      title: 'Main Salary',
    );
    return UserProfile(
      incomeSources: [salarySource],
      dailyHours: dailyHours,
      workDaysPerWeek: workDaysPerWeek,
    );
  }
}


--- FILE: lib/models/currency.dart ---

/// Currency model for multi-currency support
/// Adding a new currency = 1 line in supportedCurrencies list
class Currency {
  final String code;
  final String symbol;
  final String name;
  final String flag;
  final bool symbolBefore;
  final String thousandSeparator;
  final String decimalSeparator;
  final String goldUnit; // 'oz' (ounce) or 'gr' (gram)
  final String? defaultLocale; // Language code that defaults to this currency

  const Currency({
    required this.code,
    required this.symbol,
    required this.name,
    required this.flag,
    this.symbolBefore = true,
    this.thousandSeparator = ',',
    this.decimalSeparator = '.',
    this.goldUnit = 'oz',
    this.defaultLocale,
  });

  @override
  bool operator ==(Object other) =>
      identical(this, other) ||
      other is Currency &&
          runtimeType == other.runtimeType &&
          code == other.code;

  @override
  int get hashCode => code.hashCode;
}

/// Supported currencies list
/// YENİ CURRENCY EKLEMEK = 1 SATIR - Başka hiçbir yere dokunma!
const List<Currency> supportedCurrencies = [
  // Turkish Lira - symbol after, Turkish separators, gold in grams
  Currency(
    code: 'TRY',
    symbol: '₺',
    name: 'Türk Lirası',
    flag: '🇹🇷',
    symbolBefore: false,
    thousandSeparator: '.',
    decimalSeparator: ',',
    goldUnit: 'gr',
    defaultLocale: 'tr',
  ),
  // US Dollar - symbol before, standard separators, gold in ounces
  Currency(
    code: 'USD',
    symbol: '\$',
    name: 'US Dollar',
    flag: '🇺🇸',
    defaultLocale: 'en',
  ),
  // Euro - symbol before, standard separators
  Currency(
    code: 'EUR',
    symbol: '€',
    name: 'Euro',
    flag: '🇪🇺',
    defaultLocale: 'de',
  ),
  // British Pound
  Currency(code: 'GBP', symbol: '£', name: 'British Pound', flag: '🇬🇧'),
  // Saudi Riyal - symbol after
  Currency(
    code: 'SAR',
    symbol: '﷼',
    name: 'Saudi Riyal',
    flag: '🇸🇦',
    symbolBefore: false,
    defaultLocale: 'ar',
  ),

  // ═══════════════════════════════════════════════════════════════════
  // İLERİDE EKLEMEK İÇİN - Sadece bu satırları uncomment et:
  // ═══════════════════════════════════════════════════════════════════
  // Currency(code: 'AED', symbol: 'د.إ', name: 'UAE Dirham', flag: '🇦🇪', symbolBefore: false),
  // Currency(code: 'JPY', symbol: '¥', name: 'Japanese Yen', flag: '🇯🇵'),
  // Currency(code: 'CAD', symbol: 'C\$', name: 'Canadian Dollar', flag: '🇨🇦'),
  // Currency(code: 'AUD', symbol: 'A\$', name: 'Australian Dollar', flag: '🇦🇺'),
  // Currency(code: 'CHF', symbol: 'Fr', name: 'Swiss Franc', flag: '🇨🇭'),
  // Currency(code: 'INR', symbol: '₹', name: 'Indian Rupee', flag: '🇮🇳'),
  // Currency(code: 'KRW', symbol: '₩', name: 'Korean Won', flag: '🇰🇷'),
  // Currency(code: 'CNY', symbol: '¥', name: 'Chinese Yuan', flag: '🇨🇳'),
  // Currency(code: 'RUB', symbol: '₽', name: 'Russian Ruble', flag: '🇷🇺'),
  // Currency(code: 'BRL', symbol: 'R\$', name: 'Brazilian Real', flag: '🇧🇷'),
];

/// Get currency by code
Currency getCurrencyByCode(String code) {
  return supportedCurrencies.firstWhere(
    (c) => c.code == code,
    orElse: () => supportedCurrencies.first,
  );
}

/// Get default currency for locale - no switch case, data-driven!
Currency getDefaultCurrencyForLocale(String languageCode) {
  // Find currency that has this locale as default
  final match = supportedCurrencies
      .where((c) => c.defaultLocale == languageCode)
      .firstOrNull;
  if (match != null) return match;

  // Fallback to USD
  return getCurrencyByCode('USD');
}

/// Get all currency codes
List<String> get allCurrencyCodes =>
    supportedCurrencies.map((c) => c.code).toList();


--- FILE: lib/models/income_source.dart ---

import 'dart:convert';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:vantag/l10n/app_localizations.dart';
import 'package:vantag/theme/app_theme.dart';

/// Gelir kategorileri
enum IncomeCategory {
  salary,
  freelance,
  rental,
  passive,
  other;

  /// Internal label for debugging/logging only - use getLocalizedLabel for UI
  String get label => name;

  IconData get icon {
    switch (this) {
      case IncomeCategory.salary:
        return CupertinoIcons.briefcase_fill;
      case IncomeCategory.freelance:
        return CupertinoIcons.desktopcomputer;
      case IncomeCategory.rental:
        return CupertinoIcons.house_fill;
      case IncomeCategory.passive:
        return CupertinoIcons.chart_bar_fill;
      case IncomeCategory.other:
        return CupertinoIcons.money_dollar_circle_fill;
    }
  }

  Color get color {
    switch (this) {
      case IncomeCategory.salary:
        return AppColors.incomeSalary;
      case IncomeCategory.freelance:
        return AppColors.incomeRental;
      case IncomeCategory.rental:
        return AppColors.incomeSideJob;
      case IncomeCategory.passive:
        return AppColors.incomeOther;
      case IncomeCategory.other:
        return AppColors.incomeDefault;
    }
  }

  /// Get localized label for UI display
  String getLocalizedLabel(AppLocalizations l10n) {
    switch (this) {
      case IncomeCategory.salary:
        return l10n.incomeCategorySalary;
      case IncomeCategory.freelance:
        return l10n.incomeCategoryFreelance;
      case IncomeCategory.rental:
        return l10n.incomeCategoryRental;
      case IncomeCategory.passive:
        return l10n.incomeCategoryPassive;
      case IncomeCategory.other:
        return l10n.incomeCategoryOther;
    }
  }

  /// Get localized description for UI display
  String getLocalizedDescription(AppLocalizations l10n) {
    switch (this) {
      case IncomeCategory.salary:
        return l10n.incomeCategorySalaryDesc;
      case IncomeCategory.freelance:
        return l10n.incomeCategoryFreelanceDesc;
      case IncomeCategory.rental:
        return l10n.incomeCategoryRentalDesc;
      case IncomeCategory.passive:
        return l10n.incomeCategoryPassiveDesc;
      case IncomeCategory.other:
        return l10n.incomeCategoryOtherDesc;
    }
  }

  static IncomeCategory fromString(String value) {
    return IncomeCategory.values.firstWhere(
      (e) => e.name == value,
      orElse: () => IncomeCategory.other,
    );
  }
}

/// Gelir kaynağı modeli
class IncomeSource {
  final String id;
  final String title;
  final double amount; // Gösterilen tutar (display currency'de)
  final String
  currencyCode; // Gösterilen para birimi kodu (TRY, USD, EUR, etc.)
  final IncomeCategory category;
  final DateTime createdAt;
  final bool isPrimary; // Ana gelir mi?

  // Orijinal değerler (para birimi değişse bile bunlar sabit kalır)
  final double originalAmount; // İlk girilen tutar
  final String originalCurrencyCode; // İlk girilen para birimi

  const IncomeSource({
    required this.id,
    required this.title,
    required this.amount,
    this.currencyCode = 'TRY',
    required this.category,
    required this.createdAt,
    this.isPrimary = false,
    double? originalAmount,
    String? originalCurrencyCode,
  }) : originalAmount = originalAmount ?? amount,
       originalCurrencyCode = originalCurrencyCode ?? currencyCode;

  /// Benzersiz ID oluştur
  static String generateId() {
    return DateTime.now().millisecondsSinceEpoch.toString();
  }

  /// Ana maaş için factory
  /// [title] should be localized using l10n.mainSalary
  factory IncomeSource.salary({
    required double amount,
    required String title,
    String currencyCode = 'TRY',
  }) {
    return IncomeSource(
      id: generateId(),
      title: title,
      amount: amount,
      currencyCode: currencyCode,
      category: IncomeCategory.salary,
      createdAt: DateTime.now(),
      isPrimary: true,
      originalAmount: amount,
      originalCurrencyCode: currencyCode,
    );
  }

  /// Ek gelir için factory
  factory IncomeSource.additional({
    required String title,
    required double amount,
    required IncomeCategory category,
    String currencyCode = 'TRY',
  }) {
    return IncomeSource(
      id: generateId(),
      title: title,
      amount: amount,
      currencyCode: currencyCode,
      category: category,
      createdAt: DateTime.now(),
      isPrimary: false,
      originalAmount: amount,
      originalCurrencyCode: currencyCode,
    );
  }

  IncomeSource copyWith({
    String? id,
    String? title,
    double? amount,
    String? currencyCode,
    IncomeCategory? category,
    DateTime? createdAt,
    bool? isPrimary,
    double? originalAmount,
    String? originalCurrencyCode,
  }) {
    return IncomeSource(
      id: id ?? this.id,
      title: title ?? this.title,
      amount: amount ?? this.amount,
      currencyCode: currencyCode ?? this.currencyCode,
      category: category ?? this.category,
      createdAt: createdAt ?? this.createdAt,
      isPrimary: isPrimary ?? this.isPrimary,
      originalAmount: originalAmount ?? this.originalAmount,
      originalCurrencyCode: originalCurrencyCode ?? this.originalCurrencyCode,
    );
  }

  /// Para birimi değiştirildiğinde convert edilmiş kopya oluştur
  /// Orijinal değerler korunur, sadece amount ve currencyCode değişir
  IncomeSource convertedTo({
    required double newAmount,
    required String newCurrencyCode,
  }) {
    return IncomeSource(
      id: id,
      title: title,
      amount: newAmount,
      currencyCode: newCurrencyCode,
      category: category,
      createdAt: createdAt,
      isPrimary: isPrimary,
      originalAmount: originalAmount, // Orijinal değişmez!
      originalCurrencyCode: originalCurrencyCode, // Orijinal değişmez!
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'title': title,
      'amount': amount,
      'currencyCode': currencyCode,
      'category': category.name,
      'createdAt': createdAt.toIso8601String(),
      'isPrimary': isPrimary,
      'originalAmount': originalAmount,
      'originalCurrencyCode': originalCurrencyCode,
    };
  }

  factory IncomeSource.fromJson(Map<String, dynamic> json) {
    final amount = (json['amount'] as num).toDouble();
    final currencyCode = json['currencyCode'] as String? ?? 'TRY';

    return IncomeSource(
      id: json['id'] as String,
      title: json['title'] as String,
      amount: amount,
      currencyCode: currencyCode,
      category: IncomeCategory.fromString(json['category'] as String),
      createdAt: DateTime.parse(json['createdAt'] as String),
      isPrimary: json['isPrimary'] as bool? ?? false,
      // Eski veriler için fallback: mevcut değerleri orijinal olarak kullan
      originalAmount: (json['originalAmount'] as num?)?.toDouble() ?? amount,
      originalCurrencyCode:
          json['originalCurrencyCode'] as String? ?? currencyCode,
    );
  }

  static String encodeList(List<IncomeSource> sources) {
    return jsonEncode(sources.map((s) => s.toJson()).toList());
  }

  static List<IncomeSource> decodeList(String json) {
    final list = jsonDecode(json) as List;
    return list
        .map((item) => IncomeSource.fromJson(item as Map<String, dynamic>))
        .toList();
  }

  @override
  String toString() =>
      'IncomeSource(title: $title, amount: $amount, category: ${category.label})';
}


--- FILE: lib/models/pursuit_transaction.dart ---

import 'dart:convert';
import 'package:uuid/uuid.dart';

/// Source of a savings transaction
enum TransactionSource {
  manual, // User manually added savings
  pool, // Transferred from savings pool
  expenseCancelled; // Redirected from a cancelled expense (Vazgeçtim)

  String get labelTr {
    switch (this) {
      case TransactionSource.manual:
        return 'Manuel Ekleme';
      case TransactionSource.pool:
        return 'Havuzdan Transfer';
      case TransactionSource.expenseCancelled:
        return 'Vazgeçilen Harcama';
    }
  }

  String get labelEn {
    switch (this) {
      case TransactionSource.manual:
        return 'Manual Entry';
      case TransactionSource.pool:
        return 'Pool Transfer';
      case TransactionSource.expenseCancelled:
        return 'Cancelled Expense';
    }
  }
}

/// A transaction record for adding/removing savings from a pursuit
class PursuitTransaction {
  final String id;
  final String pursuitId;
  final double amount;
  final String currency;
  final TransactionSource source;
  final String? note;
  final DateTime createdAt;

  const PursuitTransaction({
    required this.id,
    required this.pursuitId,
    required this.amount,
    required this.currency,
    required this.source,
    this.note,
    required this.createdAt,
  });

  /// Factory to create a new transaction with UUID
  factory PursuitTransaction.create({
    required String pursuitId,
    required double amount,
    required String currency,
    required TransactionSource source,
    String? note,
  }) {
    return PursuitTransaction(
      id: const Uuid().v4(),
      pursuitId: pursuitId,
      amount: amount,
      currency: currency,
      source: source,
      note: note,
      createdAt: DateTime.now(),
    );
  }

  Map<String, dynamic> toJson() => {
    'id': id,
    'pursuitId': pursuitId,
    'amount': amount,
    'currency': currency,
    'source': source.name,
    if (note != null) 'note': note,
    'createdAt': createdAt.toIso8601String(),
  };

  factory PursuitTransaction.fromJson(Map<String, dynamic> json) {
    return PursuitTransaction(
      id: json['id'] as String,
      pursuitId: json['pursuitId'] as String,
      amount: (json['amount'] as num).toDouble(),
      currency: json['currency'] as String? ?? 'TRY',
      source: TransactionSource.values.firstWhere(
        (e) => e.name == json['source'],
        orElse: () => TransactionSource.manual,
      ),
      note: json['note'] as String?,
      createdAt: json['createdAt'] != null
          ? DateTime.parse(json['createdAt'] as String)
          : DateTime.now(),
    );
  }

  static String encodeList(List<PursuitTransaction> transactions) =>
      jsonEncode(transactions.map((t) => t.toJson()).toList());

  static List<PursuitTransaction> decodeList(String json) =>
      (jsonDecode(json) as List)
          .map((e) => PursuitTransaction.fromJson(e))
          .toList();

  @override
  bool operator ==(Object other) =>
      identical(this, other) ||
      other is PursuitTransaction &&
          runtimeType == other.runtimeType &&
          id == other.id;

  @override
  int get hashCode => id.hashCode;

  @override
  String toString() =>
      'PursuitTransaction(id: $id, pursuitId: $pursuitId, amount: $amount)';
}


--- FILE: lib/models/personality_mode.dart ---

/// AI kişilik modu - hitap tarzını belirler
/// Task 63: AI Personality Modes
enum PersonalityMode {
  /// Resmi hitap - "Siz" kullanımı, profesyonel ton
  professional,

  /// Samimi hitap - "Sen" kullanımı, arkadaşça ton
  friendly,

  /// Koç modu - Motive edici, hedef odaklı
  coach,

  /// Sert modu - Doğrudan, dürtüsel harcamalara karşı sert uyarılar
  strict,

  /// Mizahi mod - Espirili, hafif ton
  humorous,
}

extension PersonalityModeExtension on PersonalityMode {
  String get displayName {
    switch (this) {
      case PersonalityMode.professional:
        return 'Profesyonel';
      case PersonalityMode.friendly:
        return 'Arkadaşça';
      case PersonalityMode.coach:
        return 'Koç';
      case PersonalityMode.strict:
        return 'Sert';
      case PersonalityMode.humorous:
        return 'Mizahi';
    }
  }

  String get displayNameEn {
    switch (this) {
      case PersonalityMode.professional:
        return 'Professional';
      case PersonalityMode.friendly:
        return 'Friendly';
      case PersonalityMode.coach:
        return 'Coach';
      case PersonalityMode.strict:
        return 'Strict';
      case PersonalityMode.humorous:
        return 'Humorous';
    }
  }

  String get description {
    switch (this) {
      case PersonalityMode.professional:
        return 'Resmi ve profesyonel ton';
      case PersonalityMode.friendly:
        return 'Samimi ve arkadaşça yaklaşım';
      case PersonalityMode.coach:
        return 'Motive edici ve hedef odaklı';
      case PersonalityMode.strict:
        return 'Dürtüsel harcamalara karşı sert';
      case PersonalityMode.humorous:
        return 'Espirili ve eğlenceli';
    }
  }

  String get emoji {
    switch (this) {
      case PersonalityMode.professional:
        return '👔';
      case PersonalityMode.friendly:
        return '😊';
      case PersonalityMode.coach:
        return '💪';
      case PersonalityMode.strict:
        return '🚨';
      case PersonalityMode.humorous:
        return '😄';
    }
  }

  /// System prompt modifier for this personality
  String get systemPromptModifier {
    switch (this) {
      case PersonalityMode.professional:
        return '''
Resmi bir ton kullan. Kullanıcıya "siz" diye hitap et.
Profesyonel ve saygılı ol. Gereksiz espri yapma.
''';
      case PersonalityMode.friendly:
        return '''
Samimi bir ton kullan. Kullanıcıya "sen" diye hitap et.
Arkadaş gibi konuş ama saygıyı koru.
''';
      case PersonalityMode.coach:
        return '''
Motive edici bir ton kullan. Kullanıcıyı cesaretlendir.
Hedeflerine odaklan. "Yapabilirsin!" gibi ifadeler kullan.
Başarıları kutla, zorlukları fırsata çevir.
''';
      case PersonalityMode.strict:
        return '''
Doğrudan ve sert ol. Gereksiz harcamaları eleştir.
"Bu gerçekten gerekli mi?" gibi sorular sor.
Dürtüsel harcamaları engellemek için uyar.
''';
      case PersonalityMode.humorous:
        return '''
Espirili ve eğlenceli ol. Uygun yerlerde hafif şakalar yap.
Ama ciddi konularda dengeli kal. Para konusunu
eğlenceli hale getir ama önemini küçümseme.
''';
    }
  }
}


--- FILE: lib/models/subscription.dart ---

import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:vantag/theme/app_theme.dart';

/// Abonelik renk paleti
class SubscriptionColors {
  static List<Color> get palette => AppColors.subscriptionColors;

  /// Index'e göre renk döndür (mod 8 ile sınırla)
  static Color get(int index) => palette[index % 8];

  /// Renk sayısı
  static int get count => palette.length;
}

class Subscription {
  final String id;
  final String name;
  final double amount;
  final int renewalDay; // 1-31
  final String category;
  final bool isActive;
  final bool autoRecord; // Otomatik harcama kaydı oluştur
  final DateTime createdAt;
  final int colorIndex; // Renk paleti indeksi (0-7)
  final String? notes; // Kullanıcı notları

  const Subscription({
    required this.id,
    required this.name,
    required this.amount,
    required this.renewalDay,
    required this.category,
    this.isActive = true,
    this.autoRecord = true, // Varsayılan olarak otomatik kayıt açık
    required this.createdAt,
    this.colorIndex = 0,
    this.notes,
  });

  /// Abonelik rengi
  Color get color => SubscriptionColors.get(colorIndex);

  /// Sonraki yenileme tarihini hesapla
  DateTime get nextRenewalDate {
    final now = DateTime.now();
    final thisMonth = DateTime(
      now.year,
      now.month,
      _clampDay(now.year, now.month),
    );

    if (thisMonth.isAfter(now) || thisMonth.isAtSameMomentAs(now)) {
      return thisMonth;
    } else {
      // Sonraki ay
      final nextMonth = now.month == 12 ? 1 : now.month + 1;
      final nextYear = now.month == 12 ? now.year + 1 : now.year;
      return DateTime(nextYear, nextMonth, _clampDay(nextYear, nextMonth));
    }
  }

  /// Ayın gün sayısına göre günü sınırla (örn: 31 Şubat → 28/29)
  int _clampDay(int year, int month) {
    final daysInMonth = DateTime(year, month + 1, 0).day;
    return renewalDay > daysInMonth ? daysInMonth : renewalDay;
  }

  /// Belirli bir ay/yıl için yenileme günü (takvim görünümü için)
  int getRenewalDayForMonth(int year, int month) {
    return _clampDay(year, month);
  }

  /// Yenilemeye kaç gün kaldı
  int get daysUntilRenewal {
    final now = DateTime.now();
    final today = DateTime(now.year, now.month, now.day);
    final renewal = DateTime(
      nextRenewalDate.year,
      nextRenewalDate.month,
      nextRenewalDate.day,
    );
    return renewal.difference(today).inDays;
  }

  /// Yarın mı yenileniyor?
  bool get isRenewalTomorrow => daysUntilRenewal == 1;

  /// Bugün mü yenileniyor?
  bool get isRenewalToday => daysUntilRenewal == 0;

  /// Yenilenmeye kaç saat kaldı
  int get hoursUntilRenewal {
    final now = DateTime.now();
    final renewal = DateTime(
      nextRenewalDate.year,
      nextRenewalDate.month,
      nextRenewalDate.day,
    );
    return renewal.difference(now).inHours.clamp(0, 999);
  }

  /// Kaç gündür abone (createdAt'tan bugüne)
  int get daysSinceSubscription {
    return DateTime.now().difference(createdAt).inDays;
  }

  /// Kaç ay abone (yaklaşık)
  int get monthsSubscribed {
    final now = DateTime.now();
    return (now.year - createdAt.year) * 12 + (now.month - createdAt.month);
  }

  /// Toplam ödenen tutar (tahmini)
  double get totalPaid {
    final months = monthsSubscribed;
    return months > 0 ? months * amount : amount;
  }

  Subscription copyWith({
    String? name,
    double? amount,
    int? renewalDay,
    String? category,
    bool? isActive,
    bool? autoRecord,
    int? colorIndex,
    String? notes,
  }) {
    return Subscription(
      id: id,
      name: name ?? this.name,
      amount: amount ?? this.amount,
      renewalDay: renewalDay ?? this.renewalDay,
      category: category ?? this.category,
      isActive: isActive ?? this.isActive,
      autoRecord: autoRecord ?? this.autoRecord,
      createdAt: createdAt,
      colorIndex: colorIndex ?? this.colorIndex,
      notes: notes ?? this.notes,
    );
  }

  Map<String, dynamic> toJson() => {
    'id': id,
    'name': name,
    'amount': amount,
    'renewalDay': renewalDay,
    'category': category,
    'isActive': isActive,
    'autoRecord': autoRecord,
    'createdAt': createdAt.toIso8601String(),
    'colorIndex': colorIndex,
    'notes': notes,
  };

  factory Subscription.fromJson(Map<String, dynamic> json) => Subscription(
    id: json['id'] as String,
    name: json['name'] as String,
    amount: (json['amount'] as num).toDouble(),
    renewalDay: json['renewalDay'] as int,
    category: json['category'] as String,
    isActive: json['isActive'] as bool? ?? true,
    autoRecord: json['autoRecord'] as bool? ?? true,
    createdAt: DateTime.parse(json['createdAt'] as String),
    colorIndex: json['colorIndex'] as int? ?? 0,
    notes: json['notes'] as String?,
  );

  static String encodeList(List<Subscription> subs) =>
      jsonEncode(subs.map((s) => s.toJson()).toList());

  static List<Subscription> decodeList(String json) =>
      (jsonDecode(json) as List).map((s) => Subscription.fromJson(s)).toList();
}


--- FILE: lib/models/achievement.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:vantag/theme/app_theme.dart';

enum AchievementTier {
  bronze,
  silver,
  gold,
  platinum;

  String get label {
    switch (this) {
      case AchievementTier.bronze:
        return 'Bronz';
      case AchievementTier.silver:
        return 'Gümüş';
      case AchievementTier.gold:
        return 'Altın';
      case AchievementTier.platinum:
        return 'Platin';
    }
  }

  int get sortOrder {
    switch (this) {
      case AchievementTier.bronze:
        return 0;
      case AchievementTier.silver:
        return 1;
      case AchievementTier.gold:
        return 2;
      case AchievementTier.platinum:
        return 3;
    }
  }
}

enum AchievementCategory {
  streak,
  savings,
  decision,
  record,
  hidden;

  String get label {
    switch (this) {
      case AchievementCategory.streak:
        return 'Seri';
      case AchievementCategory.savings:
        return 'Tasarruf';
      case AchievementCategory.decision:
        return 'Karar';
      case AchievementCategory.record:
        return 'Kayıt';
      case AchievementCategory.hidden:
        return 'Gizli';
    }
  }

  IconData get icon {
    switch (this) {
      case AchievementCategory.streak:
        return CupertinoIcons.flame_fill;
      case AchievementCategory.savings:
        return CupertinoIcons.money_dollar_circle_fill;
      case AchievementCategory.decision:
        return CupertinoIcons.scope;
      case AchievementCategory.record:
        return CupertinoIcons.doc_text_fill;
      case AchievementCategory.hidden:
        return CupertinoIcons.eye_slash_fill;
    }
  }

  Color get iconColor {
    switch (this) {
      case AchievementCategory.streak:
        return AppColors.achievementStreak;
      case AchievementCategory.savings:
        return AppColors.achievementSavings;
      case AchievementCategory.decision:
        return AppColors.achievementGoals;
      case AchievementCategory.record:
        return AppColors.achievementTracker;
      case AchievementCategory.hidden:
        return AppColors.achievementMystery;
    }
  }
}

enum HiddenDifficulty {
  easy,
  medium,
  hard,
  legendary;

  String get label {
    switch (this) {
      case HiddenDifficulty.easy:
        return 'Kolay';
      case HiddenDifficulty.medium:
        return 'Orta';
      case HiddenDifficulty.hard:
        return 'Zor';
      case HiddenDifficulty.legendary:
        return 'Efsanevi';
    }
  }
}

class Achievement {
  final String id;
  final String title;
  final String description;
  final AchievementCategory category;
  final AchievementTier tier;
  final int subTier; // 1, 2, or 3 for Bronze 1, Bronze 2, etc.
  final double progress; // 0.0 - 1.0
  final int currentValue;
  final int targetValue;
  final DateTime? unlockedAt;
  final bool isHidden;
  final HiddenDifficulty? hiddenDifficulty;

  const Achievement({
    required this.id,
    required this.title,
    required this.description,
    required this.category,
    required this.tier,
    this.subTier = 1,
    required this.progress,
    required this.currentValue,
    required this.targetValue,
    this.unlockedAt,
    this.isHidden = false,
    this.hiddenDifficulty,
  });

  bool get isUnlocked => unlockedAt != null;

  bool get isNewlyUnlocked {
    if (unlockedAt == null) return false;
    final now = DateTime.now();
    final today = DateTime(now.year, now.month, now.day);
    final unlockDate = DateTime(
      unlockedAt!.year,
      unlockedAt!.month,
      unlockedAt!.day,
    );
    return unlockDate == today;
  }

  Achievement copyWith({
    double? progress,
    int? currentValue,
    DateTime? unlockedAt,
  }) {
    return Achievement(
      id: id,
      title: title,
      description: description,
      category: category,
      tier: tier,
      subTier: subTier,
      progress: progress ?? this.progress,
      currentValue: currentValue ?? this.currentValue,
      targetValue: targetValue,
      unlockedAt: unlockedAt ?? this.unlockedAt,
      isHidden: isHidden,
      hiddenDifficulty: hiddenDifficulty,
    );
  }

  /// Tier ve subTier'a göre sıralama için kullanılır
  int get sortKey => tier.sortOrder * 10 + subTier;

  /// Görüntülenecek tier etiketi (örn: "Bronz 1", "Gümüş 2")
  String get tierLabel {
    if (tier == AchievementTier.platinum) {
      return tier.label;
    }
    return '${tier.label} $subTier';
  }
}


--- FILE: lib/models/voice_parse_result.dart ---

/// Confidence level of voice parsing result
enum VoiceConfidence {
  /// High confidence - can auto-save
  high,

  /// Medium confidence - show with edit option
  medium,

  /// Low confidence - require user confirmation
  low,
}

/// Source of the parsing result
enum VoiceParseSource {
  /// Parsed using regex patterns (fast, free)
  regex,

  /// Parsed using GPT-4o (smart, API cost)
  gpt,

  /// Direct input (not from voice)
  direct,
}

/// Result of voice input parsing
class VoiceParseResult {
  /// Parsed amount (null if not detected)
  final double? amount;

  /// Detected category
  final String? category;

  /// Description/note for the expense
  final String description;

  /// Confidence level of the parsing
  final VoiceConfidence confidence;

  /// Source of parsing (regex or GPT)
  final VoiceParseSource source;

  /// Original voice text
  final String originalText;

  /// Suggested display name (for merchant learning)
  final String? merchantName;

  /// Store/shop name where purchase was made
  final String? store;

  /// Item/product that was purchased (subCategory)
  final String? item;

  /// Date for the expense (null = today)
  final DateTime? date;

  const VoiceParseResult({
    this.amount,
    this.category,
    required this.description,
    required this.confidence,
    required this.source,
    required this.originalText,
    this.merchantName,
    this.store,
    this.item,
    this.date,
  });

  /// True if result has enough data to create an expense
  bool get isValid => amount != null && amount! > 0;

  /// True if can be auto-saved without confirmation
  bool get canAutoSave => isValid && confidence == VoiceConfidence.high;

  /// True if needs user confirmation before saving
  bool get needsConfirmation => !isValid || confidence == VoiceConfidence.low;

  /// Create from GPT JSON response
  factory VoiceParseResult.fromGptJson(
    Map<String, dynamic> json,
    String originalText,
  ) {
    final confidenceStr = json['confidence'] as String? ?? 'low';
    final confidence = switch (confidenceStr.toLowerCase()) {
      'high' => VoiceConfidence.high,
      'medium' => VoiceConfidence.medium,
      _ => VoiceConfidence.low,
    };

    return VoiceParseResult(
      amount: (json['amount'] as num?)?.toDouble(),
      category: json['category'] as String?,
      description: json['description'] as String? ?? originalText,
      confidence: confidence,
      source: VoiceParseSource.gpt,
      originalText: originalText,
      merchantName: json['merchant'] as String?,
      store: json['store'] as String?,
      item: json['item'] as String?,
    );
  }

  /// Create from regex parsing
  factory VoiceParseResult.fromRegex({
    required double? amount,
    required String? category,
    required String description,
    required String originalText,
    String? merchantName,
    String? store,
    String? item,
  }) {
    // Determine confidence based on what was detected
    VoiceConfidence confidence;
    if (amount != null && category != null) {
      confidence = VoiceConfidence.high;
    } else if (amount != null) {
      confidence = VoiceConfidence.medium;
    } else {
      confidence = VoiceConfidence.low;
    }

    return VoiceParseResult(
      amount: amount,
      category: category,
      description: description,
      confidence: confidence,
      source: VoiceParseSource.regex,
      originalText: originalText,
      merchantName: merchantName,
      store: store,
      item: item,
    );
  }

  /// Create a failed parse result
  factory VoiceParseResult.failed(String originalText) {
    return VoiceParseResult(
      description: originalText,
      confidence: VoiceConfidence.low,
      source: VoiceParseSource.regex,
      originalText: originalText,
    );
  }

  /// Copy with modifications
  VoiceParseResult copyWith({
    double? amount,
    String? category,
    String? description,
    VoiceConfidence? confidence,
    VoiceParseSource? source,
    String? originalText,
    String? merchantName,
    String? store,
    String? item,
    DateTime? date,
  }) {
    return VoiceParseResult(
      amount: amount ?? this.amount,
      category: category ?? this.category,
      description: description ?? this.description,
      confidence: confidence ?? this.confidence,
      source: source ?? this.source,
      originalText: originalText ?? this.originalText,
      merchantName: merchantName ?? this.merchantName,
      store: store ?? this.store,
      item: item ?? this.item,
      date: date ?? this.date,
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'amount': amount,
      'category': category,
      'description': description,
      'confidence': confidence.name,
      'source': source.name,
      'originalText': originalText,
      'merchantName': merchantName,
      'store': store,
      'item': item,
      'date': date?.toIso8601String(),
    };
  }

  @override
  String toString() {
    return 'VoiceParseResult(amount: $amount, category: $category, '
        'description: $description, confidence: $confidence, source: $source)';
  }
}


--- FILE: lib/models/models.dart ---

export 'user_profile.dart';
export 'income_source.dart';
export 'income.dart';
export 'expense_result.dart';
export 'expense.dart';
export 'achievement.dart';
export 'subscription.dart';
export 'currency.dart';
export 'personality_mode.dart';
export 'voice_parse_result.dart';
export 'pursuit.dart';
export 'pursuit_transaction.dart';
export 'savings_pool.dart';
export 'category_budget.dart';


--- FILE: lib/screens/expense_screen.dart ---

import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_animate/flutter_animate.dart';
import 'package:liquid_glass_widgets/liquid_glass_widgets.dart' as lg;
import 'package:provider/provider.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:showcaseview/showcaseview.dart';
import '../core/theme/psychology_design_system.dart';
import '../core/theme/psychology_widgets.dart';
import '../models/models.dart';
import '../services/services.dart';
import '../widgets/widgets.dart';
import '../theme/theme.dart';
import '../providers/providers.dart';
import 'package:vantag/l10n/app_localizations.dart';
import 'subscription_screen.dart';
import 'habit_calculator_screen.dart';
import 'profile_modal.dart';
import 'paywall_screen.dart';
import 'report_screen.dart';
import 'pursuit_list_screen.dart';

class ExpenseScreen extends StatefulWidget {
  final UserProfile userProfile;
  final ExchangeRates? exchangeRates;
  final bool isLoadingRates;
  final bool hasRateError;
  final VoidCallback? onRetryRates;
  final VoidCallback? onStreakUpdated;

  const ExpenseScreen({
    super.key,
    required this.userProfile,
    this.exchangeRates,
    this.isLoadingRates = false,
    this.hasRateError = false,
    this.onRetryRates,
    this.onStreakUpdated,
  });

  @override
  State<ExpenseScreen> createState() => _ExpenseScreenState();
}

class _ExpenseScreenState extends State<ExpenseScreen> {
  final _subscriptionService = SubscriptionService();
  final _authService = AuthService();
  final ScrollController _scrollController = ScrollController();
  final _streakWidgetKey = GlobalKey<StreakWidgetState>();

  int _upcomingSubscriptionCount = 0;
  bool _showSwipeHint = false;

  // Post-onboarding prompt states
  bool _loginPromptDismissed = false;
  bool _additionalIncomeAsked = false;
  bool _promptStatesLoaded = false;

  static const _keySwipeHintShown = 'swipe_hint_shown';
  static const _keyLoginPromptDismissed = 'login_prompt_dismissed';
  static const _keyAdditionalIncomeAsked = 'additional_income_asked';
  static const int _recentExpensesLimit = 5;

  @override
  void initState() {
    super.initState();
    _checkSwipeHint();
    _loadUpcomingSubscriptions();
    _loadPromptStates();
  }

  @override
  void dispose() {
    _scrollController.dispose();
    super.dispose();
  }

  String _getCurrentMonthYear(BuildContext context) {
    final now = DateTime.now();
    final locale = Localizations.localeOf(context).languageCode;
    final months = locale == 'tr'
        ? ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran',
           'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık']
        : ['January', 'February', 'March', 'April', 'May', 'June',
           'July', 'August', 'September', 'October', 'November', 'December'];
    return '${months[now.month - 1]} ${now.year}';
  }

  Future<void> _checkSwipeHint() async {
    final prefs = await SharedPreferences.getInstance();
    final shown = prefs.getBool(_keySwipeHintShown) ?? false;
    if (!shown) {
      setState(() => _showSwipeHint = true);
      await prefs.setBool(_keySwipeHintShown, true);
    }
  }

  Future<void> _loadUpcomingSubscriptions() async {
    final upcoming = await _subscriptionService.getUpcomingSubscriptions(
      withinDays: 3,
    );
    if (mounted) {
      setState(() => _upcomingSubscriptionCount = upcoming.length);
    }
  }

  Future<void> _loadPromptStates() async {
    final prefs = await SharedPreferences.getInstance();
    if (mounted) {
      setState(() {
        _loginPromptDismissed = prefs.getBool(_keyLoginPromptDismissed) ?? false;
        _additionalIncomeAsked = prefs.getBool(_keyAdditionalIncomeAsked) ?? false;
        _promptStatesLoaded = true;
      });
    }
  }

  Future<void> _dismissLoginPrompt() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_keyLoginPromptDismissed, true);
    if (mounted) {
      setState(() => _loginPromptDismissed = true);
    }
  }

  Future<void> _onLoginSuccess() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_keyLoginPromptDismissed, true);
    if (mounted) {
      setState(() => _loginPromptDismissed = true);
    }
  }

  Future<void> _dismissAdditionalIncomePrompt() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_keyAdditionalIncomeAsked, true);
    if (mounted) {
      setState(() => _additionalIncomeAsked = true);
    }
  }

  /// Determines which prompt card to show (if any)
  /// Order: Login Prompt -> Additional Income -> Onboarding Checklist
  Widget? _buildPromptCard() {
    if (!_promptStatesLoaded) return null;

    final isLoggedIn = !_authService.isAnonymous;

    // 1. Login Prompt: Show if not logged in and not dismissed
    if (!isLoggedIn && !_loginPromptDismissed) {
      return Padding(
        padding: const EdgeInsets.only(bottom: 16),
        child: LoginPromptCard(
          onDismiss: _dismissLoginPrompt,
          onLoginSuccess: _onLoginSuccess,
        ),
      );
    }

    // 2. Additional Income Prompt: Show after login prompt is handled
    if (!_additionalIncomeAsked) {
      return Padding(
        padding: const EdgeInsets.only(bottom: 16),
        child: AdditionalIncomePrompt(
          onYes: _dismissAdditionalIncomePrompt,
          onNo: _dismissAdditionalIncomePrompt,
        ),
      );
    }

    // 3. Onboarding Checklist: Show after both prompts are handled
    // OnboardingChecklist handles its own dismissal state internally
    return OnboardingChecklist(
      onAddExpense: () {
        HapticFeedback.lightImpact();
        showAddExpenseSheet(
          context,
          exchangeRates: widget.exchangeRates,
          onExpenseAdded: () {
            _streakWidgetKey.currentState?.refresh();
            widget.onStreakUpdated?.call();
          },
        );
      },
      onViewReport: () {
        HapticFeedback.lightImpact();
        Navigator.push(
          context,
          MaterialPageRoute(
            builder: (context) => ReportScreen(
              userProfile: widget.userProfile,
            ),
          ),
        );
      },
      onCreatePursuit: () {
        HapticFeedback.lightImpact();
        Navigator.push(
          context,
          MaterialPageRoute(
            builder: (context) => const PursuitListScreen(),
          ),
        );
      },
    );
  }

  void _showSubscriptionSheet() {
    Navigator.push(
      context,
      MaterialPageRoute(builder: (context) => const SubscriptionScreen()),
    ).then((_) => _loadUpcomingSubscriptions());
  }

  void _openHabitCalculator() {
    Navigator.push(
      context,
      MaterialPageRoute(builder: (context) => const HabitCalculatorScreen()),
    );
  }

  String _getGreeting(AppLocalizations l10n) {
    final hour = DateTime.now().hour;
    if (hour < 12) return l10n.greetingMorning;
    if (hour < 18) return l10n.greetingAfternoon;
    return l10n.greetingEvening;
  }

  Widget _buildHeaderAction({
    required IconData icon,
    int? badge,
    required VoidCallback onTap,
    String? semanticLabel,
  }) {
    return Semantics(
      label: semanticLabel,
      button: true,
      child: GestureDetector(
        onTap: () {
          HapticFeedback.lightImpact();
          onTap();
        },
        child: lg.GlassContainer(
          width: 44,
          height: 44,
          shape: const lg.LiquidRoundedSuperellipse(borderRadius: 16),
          child: Stack(
            alignment: Alignment.center,
            children: [
              Icon(icon, size: 20, color: context.appColors.textSecondary),
              if (badge != null)
                Positioned(
                  top: 6,
                  right: 6,
                  child: Container(
                    width: 16,
                    height: 16,
                    decoration: BoxDecoration(
                      color: context.appColors.gold.withValues(alpha: 0.15),
                      shape: BoxShape.circle,
                      border: Border.all(
                        color: context.appColors.gold.withValues(alpha: 0.3),
                        width: 1,
                      ),
                    ),
                    child: Center(
                      child: Text(
                        '$badge',
                        style: TextStyle(
                          fontSize: 9,
                          fontWeight: FontWeight.w700,
                          color: context.appColors.gold,
                        ),
                      ),
                    ),
                  ),
                ),
            ],
          ),
        ),
      ),
    );
  }

  /// Avatar button that opens profile modal
  Widget _buildAvatarButton(BuildContext context) {
    final authService = AuthService();
    final user = authService.currentUser;
    final photoUrl = user?.photoURL;
    final l10n = AppLocalizations.of(context);

    return Semantics(
      label: l10n.profile,
      button: true,
      child: GestureDetector(
        onTap: () => ProfileModal.show(context),
        child: Container(
          width: 48,
          height: 48,
          decoration: BoxDecoration(
            shape: BoxShape.circle,
            gradient: LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: [
                context.appColors.primary.withValues(alpha: 0.3),
                context.appColors.secondary.withValues(alpha: 0.3),
              ],
            ),
            border: Border.all(
              color: context.appColors.primary.withValues(alpha: 0.5),
              width: 2,
            ),
            boxShadow: [
              BoxShadow(
                color: context.appColors.primary.withValues(alpha: 0.3),
                blurRadius: 12,
                spreadRadius: 0,
              ),
            ],
          ),
          child: ClipOval(
            child: photoUrl != null
                ? Image.network(
                    photoUrl,
                    fit: BoxFit.cover,
                    cacheWidth: 100,
                    cacheHeight: 100,
                    errorBuilder: (_, __, ___) => _buildDefaultAvatarIcon(),
                  )
                : _buildDefaultAvatarIcon(),
          ),
        ),
      ),
    );
  }

  Widget _buildDefaultAvatarIcon() {
    return Container(
      color: context.appColors.surfaceLight,
      child: Icon(
        CupertinoIcons.person_fill,
        size: 24,
        color: context.appColors.textTertiary,
      ),
    );
  }

  Widget _buildHabitCalculatorBanner() {
    final l10n = AppLocalizations.of(context);
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20),
      child: Semantics(
        label: l10n.habitCalculator,
        button: true,
        child: GestureDetector(
          onTap: () {
            HapticFeedback.mediumImpact();
            _openHabitCalculator();
          },
          child: lg.GlassCard(
            shape: const lg.LiquidRoundedSuperellipse(borderRadius: 16),
            child: Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  colors: [
                    AppColors.primary.withValues(alpha: 0.8),
                    AppColors.secondary.withValues(alpha: 0.8),
                  ],
                  begin: Alignment.centerLeft,
                  end: Alignment.centerRight,
                ),
                borderRadius: BorderRadius.circular(16),
              ),
              child: Row(
                children: [
                  lg.GlassContainer(
                    width: 48,
                    height: 48,
                    shape: const lg.LiquidRoundedSuperellipse(borderRadius: 16),
                    child: Center(
                      child: Icon(
                        CupertinoIcons.bolt_fill,
                        size: 28,
                        color: context.appColors.textPrimary,
                      ),
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Builder(
                      builder: (context) {
                        final l10n = AppLocalizations.of(context);
                        return Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              l10n.habitQuestion,
                              style: TextStyle(
                                fontSize: 15,
                                fontWeight: FontWeight.bold,
                                color: context.appColors.textPrimary,
                              ),
                            ),
                            const SizedBox(height: 2),
                            Text(
                              l10n.calculateAndShock,
                              style: TextStyle(
                                fontSize: 13,
                                color: context.appColors.textPrimary.withValues(
                                  alpha: 0.9,
                                ),
                              ),
                            ),
                          ],
                        );
                      },
                    ),
                  ),
                  Icon(
                    CupertinoIcons.chevron_right,
                    color: context.appColors.textPrimary.withValues(alpha: 0.9),
                    size: 24,
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }

  /// Build budget warning banner if any budgets are at risk
  Widget _buildBudgetWarningBanner() {
    return Consumer<CategoryBudgetProvider>(
      builder: (context, budgetProvider, _) {
        // Initialize if needed
        if (budgetProvider.budgets.isEmpty && !budgetProvider.isLoading) {
          final financeProvider = context.read<FinanceProvider>();
          final now = DateTime.now();
          WidgetsBinding.instance.addPostFrameCallback((_) {
            budgetProvider.initialize(financeProvider.expenses);
            budgetProvider.setMonth(now.month, now.year);
          });
        }

        // Only show if there are warning budgets
        if (!budgetProvider.hasWarnings) {
          return const SizedBox.shrink();
        }

        return Padding(
          padding: const EdgeInsets.only(bottom: 12),
          child: BudgetWarningBanner(
            budgets: budgetProvider.warningBudgets,
            onTap: () {
              // Show snackbar directing to Reports tab
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(
                  content: Text(
                    AppLocalizations.of(context).viewBudgetsInReports,
                  ),
                  behavior: SnackBarBehavior.floating,
                  action: SnackBarAction(
                    label: AppLocalizations.of(context).viewAll,
                    onPressed: () {
                      // User can navigate to Reports tab
                    },
                  ),
                ),
              );
            },
          ),
        );
      },
    );
  }

  Future<void> _deleteExpense(int index) async {
    final financeProvider = context.read<FinanceProvider>();
    await financeProvider.deleteExpense(index);
  }

  void _editExpense(int index) {
    final financeProvider = context.read<FinanceProvider>();
    final expense = financeProvider.expenses[index];

    // Open AddExpenseSheet in edit mode
    showAddExpenseSheet(
      context,
      exchangeRates: widget.exchangeRates,
      existingExpense: expense,
      onExpenseUpdated: (updatedExpense) async {
        await financeProvider.updateExpense(index, updatedExpense);
        _streakWidgetKey.currentState?.refresh();
        widget.onStreakUpdated?.call();
      },
    );
  }

  Future<void> _updateDecision(int index, ExpenseDecision decision) async {
    final financeProvider = context.read<FinanceProvider>();
    await financeProvider.updateExpenseDecision(index, decision);

    if (!mounted) return;

    final l10n = AppLocalizations.of(context);
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(
          decision == ExpenseDecision.yes
              ? l10n.decisionUpdatedBought
              : l10n.moneySavedInPocket,
        ),
        duration: const Duration(seconds: 2),
        behavior: SnackBarBehavior.floating,
      ),
    );
  }

  void _showFullHistory(List<Expense> allExpenses) {
    final l10n = AppLocalizations.of(context);
    final isPro = context.read<ProProvider>().isPro;

    // Free: 30, Pro: all
    final visibleExpenses = isPro ? allExpenses : allExpenses.take(30).toList();
    final hasMoreLocked = !isPro && allExpenses.length > 30;
    final totalCount = allExpenses.length;

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      builder: (context) => DraggableScrollableSheet(
        initialChildSize: 0.9,
        minChildSize: 0.5,
        maxChildSize: 0.95,
        builder: (context, scrollController) {
          return ClipRRect(
            borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
            child: BackdropFilter(
              filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
              child: Container(
                decoration: BoxDecoration(
                  color: context.appColors.gradientMid,
                  borderRadius: const BorderRadius.vertical(
                    top: Radius.circular(24),
                  ),
                  border: Border.all(
                    color: context.appColors.textPrimary.withValues(alpha: 0.1),
                    width: 1,
                  ),
                ),
                child: Column(
                  children: [
                    // Handle bar
                    Padding(
                      padding: const EdgeInsets.only(top: 12, bottom: 8),
                      child: Container(
                        width: 40,
                        height: 4,
                        decoration: BoxDecoration(
                          color: context.appColors.textTertiary.withValues(
                            alpha: 0.5,
                          ),
                          borderRadius: BorderRadius.circular(2),
                        ),
                      ),
                    ),

                    // Header
                    Padding(
                      padding: const EdgeInsets.symmetric(
                        horizontal: 20,
                        vertical: 8,
                      ),
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text(
                                l10n.expenseHistory,
                                style: TextStyle(
                                  fontSize: 22,
                                  fontWeight: FontWeight.w700,
                                  color: context.appColors.textPrimary,
                                  letterSpacing: -0.5,
                                ),
                              ),
                              const SizedBox(height: 4),
                              Text(
                                isPro
                                    ? l10n.recordCount(totalCount)
                                    : l10n.recordCountLimited(
                                        visibleExpenses.length,
                                        totalCount,
                                      ),
                                style: TextStyle(
                                  fontSize: 12,
                                  fontWeight: FontWeight.w500,
                                  color: context.appColors.textTertiary,
                                ),
                              ),
                            ],
                          ),
                          IconButton(
                            onPressed: () => Navigator.pop(context),
                            tooltip: l10n.close,
                            icon: Container(
                              width: 36,
                              height: 36,
                              decoration: BoxDecoration(
                                color: context.appColors.surfaceLight,
                                shape: BoxShape.circle,
                              ),
                              child: Icon(
                                CupertinoIcons.xmark,
                                size: 20,
                                color: context.appColors.textSecondary,
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),

                    const SizedBox(height: 8),

                    // Expense list
                    Expanded(
                      child: ListView.builder(
                        controller: scrollController,
                        padding: const EdgeInsets.symmetric(horizontal: 20),
                        itemCount:
                            visibleExpenses.length + (hasMoreLocked ? 1 : 0),
                        itemBuilder: (context, index) {
                          // Pro upsell at end
                          if (hasMoreLocked &&
                              index == visibleExpenses.length) {
                            return _buildProUpsell(
                              l10n,
                              totalCount - visibleExpenses.length,
                            );
                          }

                          return Padding(
                            padding: const EdgeInsets.only(bottom: 12),
                            child: ExpenseHistoryCard(
                              expense: visibleExpenses[index],
                              dailyWorkHours: widget.userProfile.dailyHours,
                              onDelete: () async {
                                await _deleteExpense(index);
                                if (context.mounted) Navigator.pop(context);
                              },
                              onEdit: () {
                                Navigator.pop(context);
                                _editExpense(index);
                              },
                              onDecisionUpdate: (decision) async {
                                await _updateDecision(index, decision);
                                if (context.mounted) Navigator.pop(context);
                              },
                              showHint: false,
                            ),
                          );
                        },
                      ),
                    ),
                  ],
                ),
              ),
            ),
          );
        },
      ),
    );
  }

  Widget _buildProUpsell(AppLocalizations l10n, int lockedCount) {
    return Container(
      margin: const EdgeInsets.only(bottom: 24, top: 8),
      child: lg.GlassCard(
        shape: const lg.LiquidRoundedSuperellipse(borderRadius: 16),
        child: Container(
          padding: const EdgeInsets.all(20),
          decoration: BoxDecoration(
            gradient: LinearGradient(
              colors: [
                context.appColors.primary.withValues(alpha: 0.15),
                context.appColors.primary.withValues(alpha: 0.05),
              ],
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
            ),
            borderRadius: BorderRadius.circular(16),
          ),
          child: Column(
            children: [
              lg.GlassContainer(
                width: 56,
                height: 56,
                shape: const lg.LiquidOval(),
                child: Icon(
                  CupertinoIcons.star_fill,
                  size: 28,
                  color: context.appColors.primary,
                ),
              ),
              const SizedBox(height: 16),
              Text(
                l10n.unlockFullHistory,
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textPrimary,
                ),
              ),
              const SizedBox(height: 8),
              Text(
                l10n.proHistoryDescription(lockedCount),
                textAlign: TextAlign.center,
                style: TextStyle(
                  fontSize: 14,
                  color: context.appColors.textSecondary,
                  height: 1.4,
                ),
              ),
              const SizedBox(height: 20),
              lg.GlassButton.custom(
                onTap: () {
                  HapticFeedback.mediumImpact();
                  _showPaywall();
                },
                width: 180,
                height: 48,
                shape: const lg.LiquidRoundedSuperellipse(borderRadius: 16),
                child: Text(
                  l10n.upgradeToPro,
                  style: TextStyle(
                    fontSize: 14,
                    fontWeight: FontWeight.w600,
                    color: context.appColors.textPrimary,
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  void _showPaywall() {
    Navigator.push(
      context,
      MaterialPageRoute(builder: (context) => const PaywallScreen()),
    );
  }

  @override
  Widget build(BuildContext context) {
    final financeProvider = context.watch<FinanceProvider>();
    final expenses = financeProvider.expenses;
    final stats = financeProvider.stats;
    final l10n = AppLocalizations.of(context);
    final colors = context.appColors;

    // Recent expenses: only show last 5
    final recentExpenses = expenses.take(_recentExpensesLimit).toList();
    final hasMoreExpenses = expenses.length > _recentExpensesLimit;

    return Scaffold(
      backgroundColor: const Color(0xFF050508),
      body: lg.LiquidGlassLayer(
        settings: lg.LiquidGlassSettings(
          thickness: 0.0, // Invisible
          blur: 0.0,
          refractiveIndex: 1.0,
          glassColor: Colors.transparent,
          lightIntensity: 0.0,
          ambientStrength: 0.0,
        ),
        child: Container(
          color: const Color(0xFF050508), // Pure black OLED background
          child: SafeArea(
            bottom: false,
            child: CustomScrollView(
            controller: _scrollController,
            slivers: [
              // Premium Header
              SliverToBoxAdapter(
                child: Padding(
                  padding: const EdgeInsets.fromLTRB(24, 16, 24, 0),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      // Top row: Avatar + Calendar + Streak
                      Row(
                        children: [
                          // Avatar
                          _buildAvatarButton(context),
                          const Spacer(),
                          // Calendar button
                          Showcase(
                            key: TourKeys.subscriptionButton,
                            title: l10n.subscriptions,
                            description: l10n.subscriptionsDescription,
                            titleTextStyle: TextStyle(
                              fontWeight: FontWeight.bold,
                              color: context.appColors.textPrimary,
                              fontSize: 16,
                            ),
                            descTextStyle: TextStyle(
                              color: context.appColors.textSecondary,
                              fontSize: 14,
                            ),
                            tooltipBackgroundColor: context.appColors.surface,
                            overlayColor: Colors.black,
                            overlayOpacity: 0.95,
                            targetBorderRadius: BorderRadius.circular(16),
                            child: _buildHeaderAction(
                              icon: CupertinoIcons.calendar,
                              badge: _upcomingSubscriptionCount > 0
                                  ? _upcomingSubscriptionCount
                                  : null,
                              onTap: _showSubscriptionSheet,
                              semanticLabel: l10n.subscriptions,
                            ),
                          ),
                          const SizedBox(width: 8),
                          // Streak widget
                          Showcase(
                            key: TourKeys.streakWidget,
                            title: l10n.streakTracking,
                            description: l10n.streakTrackingDescription,
                            titleTextStyle: TextStyle(
                              fontWeight: FontWeight.bold,
                              color: context.appColors.textPrimary,
                              fontSize: 16,
                            ),
                            descTextStyle: TextStyle(
                              color: context.appColors.textSecondary,
                              fontSize: 14,
                            ),
                            tooltipBackgroundColor: context.appColors.surface,
                            overlayColor: Colors.black,
                            overlayOpacity: 0.95,
                            targetBorderRadius: BorderRadius.circular(16),
                            child: StreakWidget(key: _streakWidgetKey),
                          ),
                        ],
                      ),
                      const SizedBox(height: 12),
                      // Greeting
                      Text(
                        '${_getGreeting(l10n)} 👋',
                        style: TextStyle(
                          fontSize: 15,
                          fontWeight: FontWeight.w500,
                          color: colors.textSecondary,
                        ),
                      ),
                      const SizedBox(height: 4),
                      // Month/Year title - cleaner look
                      GestureDetector(
                        onTap: () => ProfileModal.show(context),
                        child: Text(
                          _getCurrentMonthYear(context),
                          style: TextStyle(
                            fontSize: 24,
                            fontWeight: FontWeight.w700,
                            color: colors.textPrimary,
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              ),

              const SliverToBoxAdapter(child: SizedBox(height: 16)),

              // Post-onboarding prompt cards (Login, Additional Income, Checklist)
              if (_buildPromptCard() != null)
                SliverToBoxAdapter(child: _buildPromptCard()!),

              // Renewal Warning Banner
              SliverToBoxAdapter(
                child: RenewalWarningBanner(
                  withinHours: 48,
                  onTap: _showSubscriptionSheet,
                ),
              ),

              const SliverToBoxAdapter(child: SizedBox(height: 12)),

              // Habit Calculator Banner
              SliverToBoxAdapter(child: _buildHabitCalculatorBanner()),

              const SliverToBoxAdapter(child: SizedBox(height: 12)),

              // Category Budget Warning Banner
              SliverToBoxAdapter(child: _buildBudgetWarningBanner()),

              // Premium Hero Card - Hours & Days Display
              SliverToBoxAdapter(
                child: Showcase(
                  key: TourKeys.financialSnapshot,
                  title: l10n.financialSummary,
                  description: l10n.financialSummaryDescription,
                  titleTextStyle: TextStyle(
                    fontWeight: FontWeight.bold,
                    color: context.appColors.textPrimary,
                    fontSize: 16,
                  ),
                  descTextStyle: TextStyle(
                    color: context.appColors.textSecondary,
                    fontSize: 14,
                  ),
                  tooltipBackgroundColor: context.appColors.surface,
                  overlayColor: Colors.black,
                  overlayOpacity: 0.95,
                  targetBorderRadius: BorderRadius.circular(24),
                  child: Builder(
                    builder: (context) {
                      // Calculate hours worked from spending
                      final dailyHours = widget.userProfile.dailyHours.toDouble();
                      final workDaysPerMonth = widget.userProfile.workDaysPerWeek * 4.0;
                      final monthlyIncome = financeProvider.totalMonthlyIncome;
                      final totalSpent = stats.yesTotal;

                      // Hourly rate calculation
                      final hourlyRate = monthlyIncome > 0
                          ? monthlyIncome / (workDaysPerMonth * dailyHours)
                          : 1.0;

                      // Hours and days worked to afford spending
                      final hoursWorked = totalSpent / hourlyRate;
                      final daysWorked = hoursWorked / dailyHours;

                      // Budget percentage
                      final budgetPercentage = monthlyIncome > 0
                          ? (totalSpent / monthlyIncome * 100).clamp(0.0, 100.0)
                          : 0.0;

                      return PremiumHeroCard(
                        hoursWorked: hoursWorked,
                        daysWorked: daysWorked,
                        budgetPercentage: budgetPercentage,
                      );
                    },
                  ),
                ),
              ),

              const SliverToBoxAdapter(child: SizedBox(height: 24)),

              // Recent Expenses Header
              SliverToBoxAdapter(
                child: Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 24),
                  child: Row(
                    children: [
                      Container(
                        width: 4,
                        height: 20,
                        decoration: BoxDecoration(
                          gradient: AppGradients.primaryButton,
                          borderRadius: BorderRadius.circular(2),
                        ),
                      ),
                      const SizedBox(width: 12),
                      Text(
                        l10n.recentExpenses,
                        style: TextStyle(
                          fontSize: 18,
                          fontWeight: FontWeight.w600,
                          color: context.appColors.textPrimary,
                        ),
                      ),
                      const Spacer(),
                      if (hasMoreExpenses)
                        Semantics(
                          label: l10n.seeMore,
                          button: true,
                          child: GestureDetector(
                            onTap: () => _showFullHistory(expenses),
                            child: Container(
                              padding: const EdgeInsets.symmetric(
                                horizontal: 12,
                                vertical: 6,
                              ),
                              decoration: BoxDecoration(
                                color: context.appColors.primary.withValues(
                                  alpha: 0.15,
                                ),
                                borderRadius: BorderRadius.circular(16),
                                border: Border.all(
                                  color: context.appColors.primary.withValues(
                                    alpha: 0.3,
                                  ),
                                ),
                              ),
                              child: Row(
                                mainAxisSize: MainAxisSize.min,
                                children: [
                                  Text(
                                    l10n.seeMore,
                                    style: TextStyle(
                                      fontSize: 12,
                                      fontWeight: FontWeight.w600,
                                      color: context.appColors.primary,
                                    ),
                                  ),
                                  const SizedBox(width: 4),
                                  Icon(
                                    CupertinoIcons.chevron_right,
                                    size: 14,
                                    color: context.appColors.primary,
                                  ),
                                ],
                              ),
                            ),
                          ),
                        ),
                    ],
                  ),
                ),
              ),

              const SliverToBoxAdapter(child: SizedBox(height: 16)),

              // Recent Expenses List (max 5) or Empty State
              recentExpenses.isEmpty
                  ? SliverToBoxAdapter(
                      child: Padding(
                        padding: const EdgeInsets.symmetric(horizontal: 24),
                        child: _buildEmptyState(l10n),
                      ),
                    )
                  : SliverPadding(
                      padding: const EdgeInsets.symmetric(horizontal: 24),
                      sliver: SliverList(
                        delegate: SliverChildBuilderDelegate((context, index) {
                          return ExpenseHistoryCard(
                                expense: recentExpenses[index],
                                dailyWorkHours: widget.userProfile.dailyHours,
                                onDelete: () => _deleteExpense(index),
                                onEdit: () => _editExpense(index),
                                onDecisionUpdate: (decision) =>
                                    _updateDecision(index, decision),
                                showHint: _showSwipeHint && index == 0,
                              )
                              .animate()
                              .fadeIn(duration: 300.ms, delay: (index * 100).ms)
                              .slideX(
                                begin: 0.2,
                                end: 0,
                                duration: 300.ms,
                                delay: (index * 100).ms,
                                curve: Curves.easeOutCubic,
                              );
                        }, childCount: recentExpenses.length),
                      ),
                    ),

              // Bottom padding for nav bar
              const SliverToBoxAdapter(child: SizedBox(height: 100)),
            ],
          ),
        ),
      ),
      ),
    );
  }

  Widget _buildEmptyState(AppLocalizations l10n) {
    return lg.GlassCard(
      shape: const lg.LiquidRoundedSuperellipse(borderRadius: 24),
      child: Padding(
        padding: const EdgeInsets.symmetric(vertical: 48, horizontal: 24),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            lg.GlassContainer(
              width: 72,
              height: 72,
              shape: const lg.LiquidRoundedSuperellipse(borderRadius: 24),
              child: Icon(
                CupertinoIcons.doc_text,
                size: 32,
                color: context.appColors.textSecondary,
              ),
            ),
            const SizedBox(height: 20),
            Text(
              l10n.noExpenses,
              style: TextStyle(
                fontSize: 16,
                fontWeight: FontWeight.w600,
                color: context.appColors.textPrimary,
              ),
            ),
            const SizedBox(height: 8),
            Text(
              l10n.tapPlusToAdd,
              style: TextStyle(
                fontSize: 14,
                color: context.appColors.textSecondary,
              ),
              textAlign: TextAlign.center,
            ),
          ],
        ),
      ),
    );
  }
}


--- FILE: lib/screens/paywall_screen.dart ---

import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:purchases_flutter/purchases_flutter.dart';
import 'package:url_launcher/url_launcher.dart';
import 'package:vantag/l10n/app_localizations.dart';
import 'package:vantag/providers/locale_provider.dart';
import 'package:vantag/services/analytics_service.dart';
import 'package:vantag/services/purchase_service.dart';
import 'package:vantag/theme/app_theme.dart';

/// Premium paywall screen with subscription options
class PaywallScreen extends StatefulWidget {
  /// Optional feature that triggered the paywall
  final String? featureName;

  const PaywallScreen({super.key, this.featureName});

  @override
  State<PaywallScreen> createState() => _PaywallScreenState();
}

class _PaywallScreenState extends State<PaywallScreen>
    with TickerProviderStateMixin {
  Offerings? _offerings;
  Package? _selectedPackage;
  bool _isLoading = true;
  bool _isPurchasing = false;
  String? _error;
  late AnimationController _animationController;
  late Animation<double> _fadeAnimation;
  late Animation<Offset> _slideAnimation;

  // iOS 26 Liquid Glass: Animated breathing glow
  late AnimationController _glowController;
  late Animation<double> _glowAnimation;

  @override
  void initState() {
    super.initState();
    _animationController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 600),
    );
    _fadeAnimation = Tween<double>(begin: 0.0, end: 1.0).animate(
      CurvedAnimation(parent: _animationController, curve: Curves.easeOut),
    );
    _slideAnimation =
        Tween<Offset>(begin: const Offset(0, 0.1), end: Offset.zero).animate(
          CurvedAnimation(parent: _animationController, curve: Curves.easeOut),
        );

    // iOS 26 Liquid Glass: Breathing glow effect
    _glowController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 2500),
    )..repeat(reverse: true);

    _glowAnimation = Tween<double>(begin: 0.3, end: 0.6).animate(
      CurvedAnimation(parent: _glowController, curve: Curves.easeInOut),
    );

    _loadOfferings();
    _animationController.forward();
    // Track paywall viewed for conversion funnel
    AnalyticsService().logPaywallViewed(source: widget.featureName);
  }

  @override
  void dispose() {
    _animationController.dispose();
    _glowController.dispose();
    super.dispose();
  }

  Future<void> _loadOfferings() async {
    setState(() {
      _isLoading = true;
      _error = null;
    });

    try {
      final offerings = await PurchaseService().getOfferings();

      if (offerings != null && offerings.current != null) {
        setState(() {
          _offerings = offerings;
          // Select yearly by default (best value)
          _selectedPackage = offerings.current!.availablePackages.firstWhere(
            (p) =>
                p.identifier.contains('yearly') ||
                p.identifier.contains('annual'),
            orElse: () => offerings.current!.availablePackages.first,
          );
          _isLoading = false;
        });
      } else {
        setState(() {
          _error = 'No offerings available';
          _isLoading = false;
        });
      }
    } catch (e) {
      setState(() {
        _error = 'Failed to load packages';
        _isLoading = false;
      });
    }
  }

  Future<void> _purchase() async {
    if (_selectedPackage == null) return;

    HapticFeedback.mediumImpact();
    setState(() => _isPurchasing = true);

    final result = await PurchaseService().purchasePackage(_selectedPackage!);

    setState(() => _isPurchasing = false);

    if (mounted) {
      if (result.success) {
        Navigator.of(context).pop(true); // Return success
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(result.message),
            backgroundColor: context.appColors.success,
          ),
        );
      } else {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(result.message),
            backgroundColor: context.appColors.error,
          ),
        );
      }
    }
  }

  Future<void> _restorePurchases() async {
    setState(() => _isPurchasing = true);

    final result = await PurchaseService().restorePurchases();

    setState(() => _isPurchasing = false);

    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(result.message),
          backgroundColor: result.isPro == true
              ? context.appColors.success
              : context.appColors.textSecondary,
        ),
      );

      if (result.isPro == true) {
        Navigator.of(context).pop(true);
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(gradient: AppGradients.background),
        child: SafeArea(
          child: Column(
            children: [
              // Header with close button
              Padding(
                padding: const EdgeInsets.all(16),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.end,
                  children: [
                    IconButton(
                      onPressed: () => Navigator.of(context).pop(false),
                      icon: const Icon(CupertinoIcons.xmark),
                      tooltip: l10n.close,
                      style: IconButton.styleFrom(
                        backgroundColor: context.appColors.surface,
                        foregroundColor: context.appColors.textSecondary,
                      ),
                    ),
                  ],
                ),
              ),

              Expanded(
                child: SingleChildScrollView(
                  padding: const EdgeInsets.symmetric(horizontal: 24),
                  child: Column(
                    children: [
                      // Pro Badge
                      _buildProBadge(),
                      const SizedBox(height: 24),

                      // FREE TRIAL BANNER - Prominent
                      _buildFreeTrialBanner(l10n),
                      const SizedBox(height: 24),

                      // Title
                      Text(
                        l10n.paywallTitle,
                        style: Theme.of(context).textTheme.headlineMedium
                            ?.copyWith(fontWeight: FontWeight.bold),
                        textAlign: TextAlign.center,
                      ),
                      const SizedBox(height: 8),

                      // Subtitle
                      Text(
                        l10n.paywallSubtitle,
                        style: Theme.of(context).textTheme.bodyLarge?.copyWith(
                          color: context.appColors.textSecondary,
                        ),
                        textAlign: TextAlign.center,
                      ),
                      const SizedBox(height: 32),

                      // Feature comparison
                      _buildFeatureComparison(l10n),
                      const SizedBox(height: 32),

                      // Package cards with animation
                      if (_isLoading)
                        _buildLoadingSkeleton()
                      else if (_error != null)
                        _buildErrorState()
                      else
                        FadeTransition(
                          opacity: _fadeAnimation,
                          child: SlideTransition(
                            position: _slideAnimation,
                            child: _buildPackageCards(),
                          ),
                        ),
                      const SizedBox(height: 24),

                      // Purchase button
                      if (!_isLoading && _error == null)
                        _buildPurchaseButton(l10n),
                      const SizedBox(height: 16),

                      // Trust indicators
                      _buildTrustIndicators(l10n),
                      const SizedBox(height: 16),

                      // Auto-renewal disclosure (Apple App Store requirement)
                      Padding(
                        padding: const EdgeInsets.symmetric(horizontal: 16),
                        child: Text(
                          l10n.subscriptionAutoRenewalNotice,
                          style: TextStyle(
                            color: context.appColors.textTertiary,
                            fontSize: 10,
                            height: 1.4,
                          ),
                          textAlign: TextAlign.center,
                        ),
                      ),
                      const SizedBox(height: 16),

                      // Restore purchases
                      TextButton(
                        onPressed: _isPurchasing ? null : _restorePurchases,
                        child: Text(
                          l10n.restorePurchases,
                          style: TextStyle(
                            color: context.appColors.textSecondary,
                          ),
                        ),
                      ),
                      const SizedBox(height: 16),

                      // Legal links
                      Row(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          TextButton(
                            onPressed: () {
                              final localeProvider = context.read<LocaleProvider>();
                              final langCode = localeProvider.locale?.languageCode ?? 'tr';
                              final privacyUrl = langCode == 'tr'
                                  ? 'https://violencia19.github.io/Vantag/privacy-tr'
                                  : 'https://violencia19.github.io/Vantag/privacy-en';
                              launchUrl(Uri.parse(privacyUrl));
                            },
                            child: Text(
                              l10n.privacyPolicy,
                              style: TextStyle(
                                color: context.appColors.textTertiary,
                                fontSize: 12,
                              ),
                            ),
                          ),
                          Text(
                            ' • ',
                            style: TextStyle(
                              color: context.appColors.textTertiary,
                            ),
                          ),
                          TextButton(
                            onPressed: () {
                              final localeProvider = context.read<LocaleProvider>();
                              final langCode = localeProvider.locale?.languageCode ?? 'tr';
                              final termsUrl = langCode == 'tr'
                                  ? 'https://violencia19.github.io/Vantag/terms-tr'
                                  : 'https://violencia19.github.io/Vantag/terms-en';
                              launchUrl(Uri.parse(termsUrl));
                            },
                            child: Text(
                              l10n.termsOfService,
                              style: TextStyle(
                                color: context.appColors.textTertiary,
                                fontSize: 12,
                              ),
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 32),
                    ],
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildProBadge() {
    // iOS 26 Liquid Glass: Animated Pro badge
    return AnimatedBuilder(
      animation: _glowAnimation,
      builder: (context, child) {
        return Container(
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(32),
            boxShadow: [
              // Animated breathing glow
              BoxShadow(
                color: const Color(0xFF8B5CF6).withValues(
                  alpha: _glowAnimation.value,
                ),
                blurRadius: 32,
                spreadRadius: 0,
                offset: const Offset(0, 8),
              ),
            ],
          ),
          child: ClipRRect(
            borderRadius: BorderRadius.circular(32),
            child: BackdropFilter(
              filter: ImageFilter.blur(sigmaX: 20, sigmaY: 20),
              child: Container(
                padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 12),
                decoration: BoxDecoration(
                  // iOS 26 Liquid Glass: Premium gradient
                  gradient: LinearGradient(
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                    colors: [
                      const Color(0xFF8B5CF6).withValues(alpha: 0.5),
                      const Color(0xFF06B6D4).withValues(alpha: 0.3),
                    ],
                  ),
                  borderRadius: BorderRadius.circular(32),
                  border: Border.all(
                    color: Colors.white.withValues(alpha: 0.25),
                    width: 1.5,
                  ),
                ),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Icon(
                      CupertinoIcons.star_fill,
                      color: Colors.white,
                      size: 24,
                      shadows: [
                        Shadow(
                          color: const Color(0xFF8B5CF6).withValues(alpha: 0.6),
                          blurRadius: 12,
                        ),
                      ],
                    ),
                    const SizedBox(width: 8),
                    Text(
                      'VANTAG PRO',
                      style: Theme.of(context).textTheme.titleMedium?.copyWith(
                        color: Colors.white,
                        fontWeight: FontWeight.bold,
                        letterSpacing: 2,
                        shadows: [
                          Shadow(
                            color: const Color(0xFF8B5CF6).withValues(alpha: 0.5),
                            blurRadius: 8,
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ),
        );
      },
    );
  }

  Widget _buildFreeTrialBanner(AppLocalizations l10n) {
    // iOS 26 Liquid Glass: Free trial banner with glass effect
    return Container(
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(28),
        boxShadow: [
          // Success glow
          BoxShadow(
            color: context.appColors.success.withValues(alpha: 0.4),
            blurRadius: 24,
            spreadRadius: 0,
            offset: const Offset(0, 8),
          ),
        ],
      ),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(28),
        child: BackdropFilter(
          filter: ImageFilter.blur(sigmaX: 20, sigmaY: 20),
          child: Container(
            width: double.infinity,
            padding: const EdgeInsets.all(20),
            decoration: BoxDecoration(
              // iOS 26 Liquid Glass: Success gradient
              gradient: LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: [
                  context.appColors.success.withValues(alpha: 0.3),
                  context.appColors.success.withValues(alpha: 0.15),
                  const Color(0xFF1E1B4B).withValues(alpha: 0.25),
                ],
                stops: const [0.0, 0.5, 1.0],
              ),
              borderRadius: BorderRadius.circular(28),
              border: Border.all(
                color: context.appColors.success.withValues(alpha: 0.5),
                width: 2,
              ),
            ),
      child: Column(
        children: [
          // Badge
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
            decoration: BoxDecoration(
              color: context.appColors.success,
              borderRadius: BorderRadius.circular(24),
            ),
            child: Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                Icon(
                  CupertinoIcons.gift_fill,
                  color: context.appColors.textPrimary,
                  size: 18,
                ),
                const SizedBox(width: 8),
                Text(
                  l10n.freeTrialBanner,
                  style: TextStyle(
                    color: context.appColors.textPrimary,
                    fontSize: 14,
                    fontWeight: FontWeight.bold,
                    letterSpacing: 1,
                  ),
                ),
              ],
            ),
          ),
          const SizedBox(height: 16),

          // Main text
          Text(
            l10n.startFreeTrial,
            style: Theme.of(context).textTheme.headlineSmall?.copyWith(
              fontWeight: FontWeight.bold,
              color: context.appColors.success,
            ),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 8),

          // Description
          Text(
            l10n.freeTrialDescription,
            style: Theme.of(context).textTheme.bodyMedium?.copyWith(
              color: context.appColors.textSecondary,
            ),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 12),

          // No payment now indicator
          Row(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Icon(
                CupertinoIcons.checkmark_shield_fill,
                color: context.appColors.success.withValues(alpha: 0.8),
                size: 16,
              ),
              const SizedBox(width: 6),
              Text(
                l10n.noPaymentNow,
                style: Theme.of(context).textTheme.bodySmall?.copyWith(
                  color: context.appColors.success,
                  fontWeight: FontWeight.w500,
                ),
              ),
            ],
          ),
        ],
      ),
    ),
  ),
),
    );
  }

  Widget _buildFeatureComparison(AppLocalizations l10n) {
    final features = [
      _Feature(
        l10n.featureAiChat,
        l10n.featureAiChatFree,
        l10n.featureUnlimited,
      ),
      _Feature(
        l10n.featureHistory,
        l10n.featureHistory30Days,
        l10n.featureUnlimited,
      ),
      _Feature(l10n.featureExport, l10n.featureNo, l10n.featureYes),
      _Feature(l10n.featureWidgets, l10n.featureNo, l10n.featureYes),
      _Feature(l10n.featureAds, l10n.featureYes, l10n.featureNo),
    ];

    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: context.appColors.cardBackground,
        borderRadius: BorderRadius.circular(24),
        border: Border.all(color: context.appColors.cardBorder),
      ),
      child: Column(
        children: [
          // Header
          Row(
            children: [
              Expanded(
                flex: 2,
                child: Text(
                  l10n.feature,
                  style: Theme.of(context).textTheme.labelMedium,
                ),
              ),
              Expanded(
                child: Text(
                  'Free',
                  style: Theme.of(context).textTheme.labelMedium,
                  textAlign: TextAlign.center,
                ),
              ),
              Expanded(
                child: ShaderMask(
                  shaderCallback: (bounds) => LinearGradient(
                    colors: [
                      context.appColors.primary,
                      context.appColors.secondary,
                    ],
                  ).createShader(bounds),
                  child: Text(
                    'Pro',
                    style: Theme.of(context).textTheme.labelLarge?.copyWith(
                      color: context.appColors.textPrimary,
                    ),
                    textAlign: TextAlign.center,
                  ),
                ),
              ),
            ],
          ),
          const SizedBox(height: 16),
          Divider(color: context.appColors.cardBorder),
          const SizedBox(height: 8),
          // Features
          ...features.map((f) => _buildFeatureRow(f)),
        ],
      ),
    );
  }

  Widget _buildFeatureRow(_Feature feature) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8),
      child: Row(
        children: [
          Expanded(
            flex: 2,
            child: Text(
              feature.name,
              style: Theme.of(context).textTheme.bodyMedium,
            ),
          ),
          Expanded(
            child: Text(
              feature.free,
              style: Theme.of(context).textTheme.bodySmall?.copyWith(
                color: context.appColors.textTertiary,
              ),
              textAlign: TextAlign.center,
            ),
          ),
          Expanded(
            child:
                feature.pro.toLowerCase() == 'yes' ||
                    feature.pro.toLowerCase() == 'evet' ||
                    feature.pro == AppLocalizations.of(context).featureUnlimited
                ? Icon(
                    CupertinoIcons.checkmark,
                    color: context.appColors.success,
                    size: 20,
                  )
                : feature.pro.toLowerCase() == 'no' ||
                      feature.pro.toLowerCase() == 'hayır'
                ? Icon(CupertinoIcons.xmark, color: context.appColors.error, size: 20)
                : Text(
                    feature.pro,
                    style: Theme.of(context).textTheme.bodySmall?.copyWith(
                      color: context.appColors.success,
                    ),
                    textAlign: TextAlign.center,
                  ),
          ),
        ],
      ),
    );
  }

  Widget _buildPackageCards() {
    final packages = _offerings?.current?.availablePackages ?? [];
    final l10n = AppLocalizations.of(context);

    return Column(
      children: packages.map((package) {
        final isSelected = _selectedPackage?.identifier == package.identifier;
        final id = package.identifier.toLowerCase();
        final isYearly = id.contains('yearly') || id.contains('annual');
        final isLifetime = id.contains('lifetime');

        return Semantics(
          button: true,
          selected: isSelected,
          label:
              '${_getPackageTitle(package)} ${package.storeProduct.priceString}',
          child: GestureDetector(
            onTap: () {
              HapticFeedback.selectionClick();
              setState(() => _selectedPackage = package);
            },
            child: AnimatedContainer(
              duration: const Duration(milliseconds: 200),
              margin: const EdgeInsets.only(bottom: 12),
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                gradient: isSelected
                    ? LinearGradient(
                        colors: [
                          AppColors.surfaceElevated,
                          AppColors.cardBackground,
                        ],
                      )
                    : null,
                color: isSelected ? null : context.appColors.cardBackground,
                borderRadius: BorderRadius.circular(16),
                border: Border.all(
                  color: isSelected
                      ? context.appColors.primary
                      : context.appColors.cardBorder,
                  width: isSelected ? 2 : 1,
                ),
                boxShadow: isSelected
                    ? [
                        BoxShadow(
                          color: context.appColors.primary.withValues(
                            alpha: 0.2,
                          ),
                          blurRadius: 12,
                          offset: const Offset(0, 4),
                        ),
                      ]
                    : null,
              ),
              child: Stack(
                clipBehavior: Clip.none,
                children: [
                  Row(
                    children: [
                      // Radio indicator
                      Container(
                        width: 24,
                        height: 24,
                        decoration: BoxDecoration(
                          shape: BoxShape.circle,
                          border: Border.all(
                            color: isSelected
                                ? context.appColors.primary
                                : context.appColors.textTertiary,
                            width: 2,
                          ),
                        ),
                        child: isSelected
                            ? Center(
                                child: Container(
                                  width: 12,
                                  height: 12,
                                  decoration: BoxDecoration(
                                    shape: BoxShape.circle,
                                    gradient: LinearGradient(
                                      colors: [
                                        context.appColors.primary,
                                        context.appColors.secondary,
                                      ],
                                    ),
                                  ),
                                ),
                              )
                            : null,
                      ),
                      const SizedBox(width: 16),

                      // Package info
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              _getPackageTitle(package),
                              style: Theme.of(context).textTheme.titleMedium
                                  ?.copyWith(fontWeight: FontWeight.w600),
                            ),
                            const SizedBox(height: 4),
                            Text(
                              _getPackageSubtitle(package),
                              style: Theme.of(context).textTheme.bodySmall
                                  ?.copyWith(
                                    color: context.appColors.textSecondary,
                                  ),
                            ),
                          ],
                        ),
                      ),

                      // Price
                      Column(
                        crossAxisAlignment: CrossAxisAlignment.end,
                        children: [
                          Text(
                            package.storeProduct.priceString,
                            style: Theme.of(context).textTheme.titleLarge
                                ?.copyWith(fontWeight: FontWeight.bold),
                          ),
                          Text(
                            _getPricePeriod(package),
                            style: Theme.of(context).textTheme.bodySmall
                                ?.copyWith(
                                  color: context.appColors.textTertiary,
                                ),
                          ),
                        ],
                      ),
                    ],
                  ),

                  // Lifetime badge (purple)
                  if (isLifetime)
                    Positioned(
                      top: -8,
                      right: -8,
                      child: Container(
                        padding: const EdgeInsets.symmetric(
                          horizontal: 8,
                          vertical: 4,
                        ),
                        decoration: BoxDecoration(
                          gradient: LinearGradient(
                            colors: [
                              AppColors.premiumPurple,
                              AppColors.premiumPurple.withValues(alpha: 0.8),
                            ],
                          ),
                          borderRadius: BorderRadius.circular(8),
                          boxShadow: [
                            BoxShadow(
                              color: AppColors.premiumPurple.withValues(
                                alpha: 0.4,
                              ),
                              blurRadius: 8,
                              offset: const Offset(0, 2),
                            ),
                          ],
                        ),
                        child: Row(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            Icon(
                              CupertinoIcons.infinite,
                              size: 10,
                              color: context.appColors.textPrimary,
                            ),
                            const SizedBox(width: 4),
                            Text(
                              l10n.forever,
                              style: TextStyle(
                                color: context.appColors.textPrimary,
                                fontSize: 10,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ),

                  // Most popular badge (yearly - gold)
                  if (isYearly && !isLifetime)
                    Positioned(
                      top: -10,
                      left: 40,
                      child: Container(
                        padding: const EdgeInsets.symmetric(
                          horizontal: 10,
                          vertical: 5,
                        ),
                        decoration: BoxDecoration(
                          gradient: LinearGradient(
                            colors: [
                              context.appColors.gold,
                              AppColors.currencyGold,
                            ],
                          ),
                          borderRadius: BorderRadius.circular(8),
                          boxShadow: [
                            BoxShadow(
                              color: context.appColors.gold.withValues(
                                alpha: 0.4,
                              ),
                              blurRadius: 8,
                              offset: const Offset(0, 2),
                            ),
                          ],
                        ),
                        child: Text(
                          l10n.mostPopular,
                          style: TextStyle(
                            color: context.appColors.background,
                            fontSize: 10,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                      ),
                    ),
                ],
              ),
            ),
          ),
        );
      }).toList(),
    );
  }

  String _getPackageTitle(Package package) {
    final l10n = AppLocalizations.of(context);
    final id = package.identifier.toLowerCase();

    if (id.contains('lifetime')) return l10n.lifetime;
    if (id.contains('monthly')) return l10n.monthly;
    if (id.contains('yearly') || id.contains('annual')) return l10n.yearly;
    return package.storeProduct.title;
  }

  String _getPackageSubtitle(Package package) {
    final l10n = AppLocalizations.of(context);
    final id = package.identifier.toLowerCase();

    if (id.contains('lifetime')) {
      return l10n.lifetimeDescription;
    }
    if (id.contains('yearly') || id.contains('annual')) {
      return l10n.yearlySavings;
    }
    return l10n.cancelAnytime;
  }

  String _getPricePeriod(Package package) {
    final l10n = AppLocalizations.of(context);
    final id = package.identifier.toLowerCase();

    if (id.contains('lifetime')) return l10n.oneTime;
    if (id.contains('monthly')) return '/ ${l10n.month}';
    if (id.contains('yearly') || id.contains('annual')) return '/ ${l10n.year}';
    return '';
  }

  Widget _buildPurchaseButton(AppLocalizations l10n) {
    // Check if selected package has a trial
    final id = _selectedPackage?.identifier.toLowerCase() ?? '';
    final isMonthlyWithTrial = id.contains('monthly');
    final buttonText = isMonthlyWithTrial
        ? l10n.startFreeTrial
        : l10n.subscribeToPro;
    final buttonColor = isMonthlyWithTrial
        ? context.appColors.success
        : context.appColors.primary;
    final buttonColorEnd = isMonthlyWithTrial
        ? AppColors.premiumGreen
        : context.appColors.secondary;

    return SizedBox(
      width: double.infinity,
      height: 60,
      child: ElevatedButton(
        onPressed: _isPurchasing ? null : _purchase,
        style: ElevatedButton.styleFrom(
          padding: EdgeInsets.zero,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(16),
          ),
        ),
        child: Ink(
          decoration: BoxDecoration(
            gradient: LinearGradient(colors: [buttonColor, buttonColorEnd]),
            borderRadius: BorderRadius.circular(16),
            boxShadow: [
              BoxShadow(
                color: buttonColor.withValues(alpha: 0.4),
                blurRadius: 12,
                offset: const Offset(0, 4),
              ),
            ],
          ),
          child: Container(
            alignment: Alignment.center,
            child: _isPurchasing
                ? SizedBox(
                    width: 24,
                    height: 24,
                    child: CircularProgressIndicator(
                      color: context.appColors.textPrimary,
                      strokeWidth: 2,
                    ),
                  )
                : Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      if (isMonthlyWithTrial) ...[
                        Icon(
                          CupertinoIcons.gift_fill,
                          color: context.appColors.textPrimary,
                          size: 20,
                        ),
                        const SizedBox(width: 8),
                      ],
                      Text(
                        buttonText,
                        style: TextStyle(
                          color: context.appColors.textPrimary,
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ],
                  ),
          ),
        ),
      ),
    );
  }

  Widget _buildTrustIndicators(AppLocalizations l10n) {
    return Container(
      padding: const EdgeInsets.symmetric(vertical: 16),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceEvenly,
        children: [
          _buildTrustItem(CupertinoIcons.checkmark_shield_fill, l10n.securePayment),
          _buildTrustItem(CupertinoIcons.lock_fill, l10n.encrypted),
          _buildTrustItem(CupertinoIcons.arrow_counterclockwise, l10n.cancelAnytime),
        ],
      ),
    );
  }

  Widget _buildTrustItem(IconData icon, String label) {
    return Column(
      children: [
        Icon(icon, color: context.appColors.textTertiary, size: 20),
        const SizedBox(height: 6),
        Text(
          label,
          style: Theme.of(context).textTheme.bodySmall?.copyWith(
            color: context.appColors.textTertiary,
            fontSize: 10,
          ),
        ),
      ],
    );
  }

  Widget _buildErrorState() {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: context.appColors.cardBackground,
        borderRadius: BorderRadius.circular(16),
      ),
      child: Column(
        children: [
          Icon(
            CupertinoIcons.exclamationmark_circle_fill,
            color: context.appColors.error,
            size: 48,
          ),
          const SizedBox(height: 16),
          Text(
            _error ?? 'An error occurred',
            style: Theme.of(context).textTheme.bodyMedium,
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 16),
          TextButton.icon(
            onPressed: _loadOfferings,
            icon: const Icon(CupertinoIcons.arrow_clockwise),
            label: Text(AppLocalizations.of(context).retry),
          ),
        ],
      ),
    );
  }

  Widget _buildLoadingSkeleton() {
    return Column(
      children: List.generate(
        3,
        (index) => Container(
          margin: const EdgeInsets.only(bottom: 12),
          height: 80,
          decoration: BoxDecoration(
            color: context.appColors.cardBackground,
            borderRadius: BorderRadius.circular(16),
            border: Border.all(color: context.appColors.cardBorder),
          ),
          child: Row(
            children: [
              const SizedBox(width: 16),
              // Radio placeholder
              Container(
                width: 24,
                height: 24,
                decoration: BoxDecoration(
                  shape: BoxShape.circle,
                  border: Border.all(
                    color: context.appColors.textTertiary,
                    width: 2,
                  ),
                ),
              ),
              const SizedBox(width: 16),
              // Text placeholders
              Expanded(
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    _ShimmerBox(width: 80 + (index * 20), height: 16),
                    const SizedBox(height: 8),
                    _ShimmerBox(width: 120 + (index * 10), height: 12),
                  ],
                ),
              ),
              // Price placeholder
              Padding(
                padding: const EdgeInsets.only(right: 16),
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  crossAxisAlignment: CrossAxisAlignment.end,
                  children: [
                    _ShimmerBox(width: 60, height: 20),
                    const SizedBox(height: 4),
                    _ShimmerBox(width: 40, height: 12),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

/// Shimmer loading box
class _ShimmerBox extends StatefulWidget {
  final double width;
  final double height;

  const _ShimmerBox({required this.width, required this.height});

  @override
  State<_ShimmerBox> createState() => _ShimmerBoxState();
}

class _ShimmerBoxState extends State<_ShimmerBox>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _animation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 1500),
    )..repeat();
    _animation = Tween<double>(
      begin: 0.3,
      end: 0.6,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeInOut));
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: _animation,
      builder: (context, child) {
        return Container(
          width: widget.width,
          height: widget.height,
          decoration: BoxDecoration(
            color: context.appColors.textTertiary.withValues(
              alpha: _animation.value,
            ),
            borderRadius: BorderRadius.circular(4),
          ),
        );
      },
    );
  }
}

class _Feature {
  final String name;
  final String free;
  final String pro;

  _Feature(this.name, this.free, this.pro);
}


--- FILE: lib/screens/currency_detail_screen.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../services/services.dart';
import '../theme/theme.dart';

class CurrencyDetailScreen extends StatelessWidget {
  final ExchangeRates rates;

  const CurrencyDetailScreen({super.key, required this.rates});

  String _formatRate(double rate) {
    if (rate >= 1000) {
      return rate
          .toStringAsFixed(2)
          .replaceAllMapped(
            RegExp(r'(\d{1,3})(?=(\d{3})+(?!\d))'),
            (Match m) => '${m[1]},',
          );
    }
    return rate.toStringAsFixed(4);
  }

  String _formatLastUpdated(BuildContext context, DateTime dateTime) {
    final now = DateTime.now();
    final difference = now.difference(dateTime);

    // For recent times, just show the datetime format
    if (difference.inHours < 24) {
      final hour = dateTime.hour.toString().padLeft(2, '0');
      final minute = dateTime.minute.toString().padLeft(2, '0');
      return '$hour:$minute';
    } else {
      final day = dateTime.day.toString().padLeft(2, '0');
      final month = dateTime.month.toString().padLeft(2, '0');
      final year = dateTime.year;
      final hour = dateTime.hour.toString().padLeft(2, '0');
      final minute = dateTime.minute.toString().padLeft(2, '0');
      return '$day.$month.$year $hour:$minute';
    }
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    return Scaffold(
      backgroundColor: context.appColors.background,
      appBar: AppBar(
        backgroundColor: context.appColors.background,
        leading: IconButton(
          icon: Icon(
            CupertinoIcons.arrow_left,
            color: context.appColors.textPrimary,
          ),
          onPressed: () => Navigator.pop(context),
        ),
        title: Text(
          l10n.currencyRates,
          style: TextStyle(
            fontSize: 20,
            fontWeight: FontWeight.w700,
            color: context.appColors.textPrimary,
          ),
        ),
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Last update info
            Container(
              width: double.infinity,
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: context.appColors.surface,
                borderRadius: BorderRadius.circular(16),
                border: Border.all(color: context.appColors.cardBorder),
              ),
              child: Row(
                children: [
                  Container(
                    width: 40,
                    height: 40,
                    decoration: BoxDecoration(
                      color: context.appColors.primary.withValues(alpha: 0.1),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Icon(
                      CupertinoIcons.arrow_2_circlepath,
                      size: 20,
                      color: context.appColors.primary,
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          l10n.lastUpdate,
                          style: TextStyle(
                            fontSize: 12,
                            color: context.appColors.textSecondary,
                          ),
                        ),
                        const SizedBox(height: 2),
                        Text(
                          _formatLastUpdated(context, rates.lastUpdated),
                          style: TextStyle(
                            fontSize: 14,
                            fontWeight: FontWeight.w600,
                            color: context.appColors.textPrimary,
                          ),
                        ),
                      ],
                    ),
                  ),
                  Container(
                    padding: const EdgeInsets.symmetric(
                      horizontal: 10,
                      vertical: 4,
                    ),
                    decoration: BoxDecoration(
                      color: context.appColors.primary.withValues(alpha: 0.1),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Text(
                      'TCMB',
                      style: TextStyle(
                        fontSize: 11,
                        fontWeight: FontWeight.w600,
                        color: context.appColors.primary,
                      ),
                    ),
                  ),
                ],
              ),
            ),

            const SizedBox(height: 24),

            // Rates title
            Text(
              l10n.rates,
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.w700,
                color: context.appColors.textPrimary,
              ),
            ),

            const SizedBox(height: 16),

            // USD
            _buildCurrencyCard(
              context: context,
              flag: '\$',
              name: l10n.usDollar,
              code: 'USD',
              buying: rates.usdBuying,
              selling: rates.usdSelling,
              color: AppColors.currencyPositive,
            ),

            const SizedBox(height: 12),

            // EUR
            _buildCurrencyCard(
              context: context,
              flag: '\u20AC',
              name: l10n.euro,
              code: 'EUR',
              buying: rates.eurBuying,
              selling: rates.eurSelling,
              color: AppColors.currencyNeutral,
            ),

            const SizedBox(height: 12),

            // Gold
            _buildCurrencyCard(
              context: context,
              flag: 'Au',
              name: l10n.gramGold,
              code: 'XAU',
              buying: rates.goldBuying,
              selling: rates.goldSelling,
              color: AppColors.currencyGold,
              isGold: true,
            ),

            const SizedBox(height: 32),

            // Info note
            Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: context.appColors.surfaceLight,
                borderRadius: BorderRadius.circular(16),
              ),
              child: Row(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Icon(
                    CupertinoIcons.info_circle,
                    size: 18,
                    color: context.appColors.textTertiary.withValues(
                      alpha: 0.8,
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Text(
                      l10n.tcmbNotice,
                      style: TextStyle(
                        fontSize: 12,
                        color: context.appColors.textTertiary,
                        height: 1.4,
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildCurrencyCard({
    required BuildContext context,
    required String flag,
    required String name,
    required String code,
    required double buying,
    required double selling,
    required Color color,
    bool isGold = false,
  }) {
    final l10n = AppLocalizations.of(context);
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: context.appColors.cardBorder),
      ),
      child: Column(
        children: [
          // Top section - currency info
          Row(
            children: [
              Container(
                width: 44,
                height: 44,
                decoration: BoxDecoration(
                  color: color.withValues(alpha: 0.15),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Center(
                  child: Text(
                    flag,
                    style: TextStyle(
                      fontSize: isGold ? 14 : 20,
                      fontWeight: FontWeight.w700,
                      color: color,
                    ),
                  ),
                ),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      name,
                      style: TextStyle(
                        fontSize: 15,
                        fontWeight: FontWeight.w600,
                        color: context.appColors.textPrimary,
                      ),
                    ),
                    Text(
                      code,
                      style: TextStyle(
                        fontSize: 12,
                        color: context.appColors.textTertiary,
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),

          const SizedBox(height: 16),

          // Bottom section - buy/sell
          Row(
            children: [
              Expanded(child: _buildPriceColumn(context, l10n.buy, buying)),
              Container(
                width: 1,
                height: 40,
                color: context.appColors.cardBorder,
              ),
              Expanded(child: _buildPriceColumn(context, l10n.sell, selling)),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildPriceColumn(BuildContext context, String label, double value) {
    return Column(
      children: [
        Text(
          label,
          style: TextStyle(fontSize: 11, color: context.appColors.textTertiary),
        ),
        const SizedBox(height: 4),
        Text(
          '${_formatRate(value)} \u20BA',
          style: TextStyle(
            fontSize: 16,
            fontWeight: FontWeight.w700,
            color: context.appColors.textPrimary,
          ),
        ),
      ],
    );
  }
}


--- FILE: lib/screens/pin_setup_screen.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../services/lock_service.dart';
import '../services/haptic_service.dart';
import '../theme/theme.dart';

/// Screen for setting up a new PIN
class PinSetupScreen extends StatefulWidget {
  /// If true, this is changing an existing PIN
  final bool isChanging;

  const PinSetupScreen({super.key, this.isChanging = false});

  @override
  State<PinSetupScreen> createState() => _PinSetupScreenState();
}

class _PinSetupScreenState extends State<PinSetupScreen>
    with SingleTickerProviderStateMixin {
  String _enteredPin = '';
  String _firstPin = '';
  bool _isConfirming = false;
  String? _error;

  late AnimationController _shakeController;
  late Animation<double> _shakeAnimation;

  @override
  void initState() {
    super.initState();
    _shakeController = AnimationController(
      duration: const Duration(milliseconds: 500),
      vsync: this,
    );
    _shakeAnimation = Tween<double>(
      begin: 0,
      end: 24,
    ).chain(CurveTween(curve: Curves.elasticIn)).animate(_shakeController);
  }

  @override
  void dispose() {
    _shakeController.dispose();
    super.dispose();
  }

  void _onNumberPressed(String number) {
    if (_enteredPin.length < 4) {
      haptics.light();
      setState(() {
        _enteredPin += number;
        _error = null;
      });

      if (_enteredPin.length == 4) {
        _processPin();
      }
    }
  }

  void _onDeletePressed() {
    if (_enteredPin.isNotEmpty) {
      haptics.light();
      setState(() {
        _enteredPin = _enteredPin.substring(0, _enteredPin.length - 1);
        _error = null;
      });
    }
  }

  void _processPin() {
    if (!_isConfirming) {
      // First entry - store and ask for confirmation
      setState(() {
        _firstPin = _enteredPin;
        _enteredPin = '';
        _isConfirming = true;
      });
    } else {
      // Confirming - check if they match
      if (_enteredPin == _firstPin) {
        _savePin();
      } else {
        haptics.error();
        _shakeController.forward().then((_) => _shakeController.reset());
        setState(() {
          _error = AppLocalizations.of(context).pinMismatch;
          _enteredPin = '';
          _firstPin = '';
          _isConfirming = false;
        });
      }
    }
  }

  Future<void> _savePin() async {
    await LockService.setPin(_firstPin);
    await LockService.setLockEnabled(true);

    haptics.success();

    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(AppLocalizations.of(context).pinSet),
          backgroundColor: context.appColors.success,
          behavior: SnackBarBehavior.floating,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(8),
          ),
        ),
      );
      Navigator.pop(context, true);
    }
  }

  void _reset() {
    haptics.light();
    setState(() {
      _enteredPin = '';
      _firstPin = '';
      _isConfirming = false;
      _error = null;
    });
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return Scaffold(
      backgroundColor: context.appColors.background,
      appBar: AppBar(
        backgroundColor: Colors.transparent,
        elevation: 0,
        leading: IconButton(
          icon: Icon(
            CupertinoIcons.arrow_left,
            color: context.appColors.textPrimary,
          ),
          onPressed: () => Navigator.pop(context, false),
        ),
        actions: [
          if (_isConfirming)
            TextButton(
              onPressed: _reset,
              child: Text(
                l10n.reset,
                style: TextStyle(color: context.appColors.textSecondary),
              ),
            ),
        ],
      ),
      body: SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(24),
          child: Column(
            children: [
              const Spacer(flex: 1),

              // Icon
              Container(
                width: 80,
                height: 80,
                decoration: BoxDecoration(
                  color: context.appColors.primary.withValues(alpha: 0.15),
                  borderRadius: BorderRadius.circular(24),
                ),
                child: Icon(
                  _isConfirming
                      ? CupertinoIcons.lock_shield_fill
                      : CupertinoIcons.lock_fill,
                  size: 40,
                  color: context.appColors.primary,
                ),
              ),
              const SizedBox(height: 24),

              // Title
              Text(
                _isConfirming ? l10n.confirmPin : l10n.createPin,
                style: TextStyle(
                  fontSize: 24,
                  fontWeight: FontWeight.bold,
                  color: context.appColors.textPrimary,
                ),
              ),
              const SizedBox(height: 8),
              Text(
                _isConfirming
                    ? l10n.confirmPinDescription
                    : l10n.createPinDescription,
                style: TextStyle(
                  fontSize: 14,
                  color: context.appColors.textSecondary,
                ),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 32),

              // PIN dots with shake animation
              AnimatedBuilder(
                animation: _shakeAnimation,
                builder: (context, child) {
                  return Transform.translate(
                    offset: Offset(
                      _shakeAnimation.value *
                          ((_shakeController.value * 10).toInt().isEven
                              ? 1
                              : -1),
                      0,
                    ),
                    child: child,
                  );
                },
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: List.generate(4, (index) {
                    final isFilled = index < _enteredPin.length;
                    return AnimatedContainer(
                      duration: const Duration(milliseconds: 150),
                      width: 20,
                      height: 20,
                      margin: const EdgeInsets.symmetric(horizontal: 10),
                      decoration: BoxDecoration(
                        shape: BoxShape.circle,
                        color: isFilled
                            ? context.appColors.primary
                            : Colors.transparent,
                        border: Border.all(
                          color: _error != null
                              ? context.appColors.error
                              : context.appColors.primary,
                          width: 2,
                        ),
                      ),
                    );
                  }),
                ),
              ),

              // Error message
              const SizedBox(height: 20),
              SizedBox(
                height: 20,
                child: _error != null
                    ? Text(
                        _error!,
                        style: TextStyle(
                          color: context.appColors.error,
                          fontSize: 14,
                          fontWeight: FontWeight.w500,
                        ),
                      )
                    : null,
              ),

              const Spacer(),

              // Number pad
              _buildNumberPad(),

              const Spacer(),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildNumberPad() {
    return Column(
      children: [
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceEvenly,
          children: ['1', '2', '3'].map(_buildNumberButton).toList(),
        ),
        const SizedBox(height: 16),
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceEvenly,
          children: ['4', '5', '6'].map(_buildNumberButton).toList(),
        ),
        const SizedBox(height: 16),
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceEvenly,
          children: ['7', '8', '9'].map(_buildNumberButton).toList(),
        ),
        const SizedBox(height: 16),
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceEvenly,
          children: [
            const SizedBox(width: 72),
            _buildNumberButton('0'),
            _buildDeleteButton(),
          ],
        ),
      ],
    );
  }

  Widget _buildNumberButton(String number) {
    return GestureDetector(
      onTap: () => _onNumberPressed(number),
      child: Container(
        width: 72,
        height: 72,
        decoration: BoxDecoration(
          shape: BoxShape.circle,
          color: context.appColors.surface,
          border: Border.all(color: context.appColors.cardBorder, width: 1),
        ),
        child: Center(
          child: Text(
            number,
            style: TextStyle(
              fontSize: 28,
              fontWeight: FontWeight.w600,
              color: context.appColors.textPrimary,
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildDeleteButton() {
    return GestureDetector(
      onTap: _onDeletePressed,
      child: SizedBox(
        width: 72,
        height: 72,
        child: Center(
          child: Icon(
            CupertinoIcons.delete_left,
            size: 28,
            color: context.appColors.textSecondary,
          ),
        ),
      ),
    );
  }
}


--- FILE: lib/screens/profile_modal.dart ---

import 'dart:io';
import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:image_picker/image_picker.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../providers/finance_provider.dart';
import '../providers/pro_provider.dart';
import '../services/auth_service.dart';
import '../services/profile_service.dart';
import '../theme/theme.dart';
import '../theme/app_theme.dart';
import '../utils/currency_utils.dart';
import 'onboarding_screen.dart';
import 'income_wizard_screen.dart';

/// Profile Modal - Shows user profile information
/// Displayed when user taps on avatar in header
class ProfileModal extends StatefulWidget {
  const ProfileModal({super.key});

  static Future<void> show(BuildContext context) {
    return showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      builder: (context) => const ProfileModal(),
    );
  }

  @override
  State<ProfileModal> createState() => _ProfileModalState();
}

class _ProfileModalState extends State<ProfileModal> {
  final _profileService = ProfileService();
  final _imagePicker = ImagePicker();
  String? _localPhotoPath;
  bool _isPhotoLoading = false;
  bool _isLinkingGoogle = false;
  bool _isLinkingApple = false;

  @override
  void initState() {
    super.initState();
    _loadLocalPhoto();
    WidgetsBinding.instance.addPostFrameCallback((_) {
      context.read<FinanceProvider>().refreshAchievements(context);
    });
  }

  Future<void> _loadLocalPhoto() async {
    final path = await _profileService.getProfilePhotoPath();
    if (mounted) {
      setState(() => _localPhotoPath = path);
    }
  }

  Future<void> _pickImage(ImageSource source) async {
    try {
      setState(() => _isPhotoLoading = true);

      final pickedFile = await _imagePicker.pickImage(
        source: source,
        maxWidth: 512,
        maxHeight: 512,
        imageQuality: 85,
      );

      if (pickedFile == null) {
        setState(() => _isPhotoLoading = false);
        return;
      }

      final savedPath = await _profileService.saveProfilePhoto(
        File(pickedFile.path),
      );

      if (mounted) {
        setState(() {
          _localPhotoPath = savedPath;
          _isPhotoLoading = false;
        });
        HapticFeedback.mediumImpact();
      }
    } catch (e) {
      if (mounted) {
        setState(() => _isPhotoLoading = false);
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(AppLocalizations.of(context).photoSelectError),
            backgroundColor: context.appColors.error,
          ),
        );
      }
    }
  }

  Future<void> _deletePhoto() async {
    await _profileService.deleteProfilePhoto();
    if (mounted) {
      setState(() => _localPhotoPath = null);
      HapticFeedback.mediumImpact();
    }
  }

  void _showPhotoOptions(AppLocalizations l10n) {
    showModalBottomSheet(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      backgroundColor: Colors.transparent,
      builder: (context) => _PhotoOptionsSheet(
        localPhotoPath: _localPhotoPath,
        onCameraTap: () {
          Navigator.pop(context);
          _pickImage(ImageSource.camera);
        },
        onGalleryTap: () {
          Navigator.pop(context);
          _pickImage(ImageSource.gallery);
        },
        onDeleteTap: () {
          Navigator.pop(context);
          _deletePhoto();
        },
        l10n: l10n,
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final authService = AuthService();
    final financeProvider = context.watch<FinanceProvider>();
    final proProvider = context.watch<ProProvider>();
    final isPro = proProvider.isPro;

    // Calculate saved time (total spent / hourly rate)
    final userProfile = financeProvider.userProfile;
    final totalSaved = financeProvider.stats.savedAmount;
    final hourlyRate = userProfile != null && userProfile.dailyHours > 0
        ? userProfile.monthlyIncome /
              (userProfile.dailyHours * userProfile.workDaysPerWeek * 4)
        : 0.0;
    final savedHours = hourlyRate > 0 ? totalSaved / hourlyRate : 0.0;

    // Get membership days (from first expense or 0)
    final expenses = financeProvider.realExpenses;
    final firstExpenseDate = expenses.isNotEmpty
        ? expenses.map((e) => e.date).reduce((a, b) => a.isBefore(b) ? a : b)
        : DateTime.now();
    final memberDays = DateTime.now().difference(firstExpenseDate).inDays;

    // Get badges count - count unlocked achievements
    final badgesEarned = financeProvider.achievements
        .where((a) => a.isUnlocked)
        .length;

    // Stack with opaque background to ensure proper dark overlay
    return Stack(
      children: [
        // Opaque background layer - tapping dismisses modal
        Positioned.fill(
          child: GestureDetector(
            onTap: () => Navigator.of(context).pop(),
            child: Container(color: Colors.black.withValues(alpha: 0.85)),
          ),
        ),
        // The actual draggable sheet
        DraggableScrollableSheet(
          initialChildSize: 0.75,
          minChildSize: 0.5,
          maxChildSize: 0.9,
          builder: (context, scrollController) {
            return Container(
              decoration: BoxDecoration(
                color: context.appColors.surface,
                borderRadius: const BorderRadius.vertical(
                  top: Radius.circular(24),
                ),
                border: Border.all(
                  color: context.appColors.cardBorder,
                  width: 1,
                ),
              ),
              child: Column(
                children: [
                  // Handle bar
                  Container(
                    width: 40,
                    height: 4,
                    margin: const EdgeInsets.only(top: 12),
                    decoration: BoxDecoration(
                      color: context.appColors.textTertiary.withValues(
                        alpha: 0.3,
                      ),
                      borderRadius: BorderRadius.circular(2),
                    ),
                  ),

                  Expanded(
                    child: SingleChildScrollView(
                      controller: scrollController,
                      padding: const EdgeInsets.all(24),
                      child: Column(
                        children: [
                          // Avatar + Name + Email
                          _buildProfileHeader(
                            context,
                            authService,
                            isPro,
                            l10n,
                          ),

                          const SizedBox(height: 20),

                          // Action Buttons Row (Photo, Salary, Add Income)
                          _buildActionButtonsRow(
                            context,
                            l10n,
                            financeProvider,
                          ),

                          const SizedBox(height: 24),

                          // Saved Time Counter
                          _buildSavedTimeCard(context, savedHours, l10n),

                          const SizedBox(height: 24),

                          // Stats Row
                          _buildStatsRow(
                            context,
                            memberDays,
                            badgesEarned,
                            l10n,
                          ),

                          const SizedBox(height: 24),

                          // Google Connection Status
                          _buildGoogleStatus(context, authService, l10n),

                          const SizedBox(height: 12),

                          // Apple Connection Status
                          _buildAppleStatus(context, authService, l10n),

                          const SizedBox(height: 32),

                          // Sign Out Button
                          _buildSignOutButton(context, authService, l10n),
                        ],
                      ),
                    ),
                  ),
                ],
              ),
            );
          },
        ),
      ],
    );
  }

  Widget _buildProfileHeader(
    BuildContext context,
    AuthService authService,
    bool isPro,
    AppLocalizations l10n,
  ) {
    final user = authService.currentUser;
    final googlePhotoUrl = user?.photoURL;
    final displayName = user?.displayName ?? l10n.profile;
    final email = user?.email ?? '';

    return Column(
      children: [
        // Avatar - Tappable for photo change
        GestureDetector(
          onTap: () => _showPhotoOptions(l10n),
          child: Stack(
            children: [
              Container(
                width: 100,
                height: 100,
                decoration: BoxDecoration(
                  shape: BoxShape.circle,
                  gradient: LinearGradient(
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                    colors: [
                      context.appColors.primary.withValues(alpha: 0.3),
                      context.appColors.secondary.withValues(alpha: 0.3),
                    ],
                  ),
                  border: Border.all(
                    color: isPro
                        ? AppColors.medalGold
                        : context.appColors.primary,
                    width: isPro ? 3 : 2,
                  ),
                  boxShadow: isPro
                      ? [
                          BoxShadow(
                            color: AppColors.medalGold.withValues(alpha: 0.4),
                            blurRadius: 20,
                            spreadRadius: 2,
                          ),
                        ]
                      : null,
                ),
                child: ClipOval(
                  child: _isPhotoLoading
                      ? Center(
                          child: CircularProgressIndicator(
                            strokeWidth: 2,
                            valueColor: AlwaysStoppedAnimation<Color>(
                              context.appColors.primary,
                            ),
                          ),
                        )
                      : _localPhotoPath != null
                      ? Image.file(
                          File(_localPhotoPath!),
                          fit: BoxFit.cover,
                          width: 100,
                          height: 100,
                          errorBuilder: (context, error, stackTrace) =>
                              _buildAvatarContent(googlePhotoUrl),
                        )
                      : _buildAvatarContent(googlePhotoUrl),
                ),
              ),
              // Camera edit indicator
              Positioned(
                bottom: 0,
                right: isPro ? 30 : 0,
                child: Container(
                  width: 28,
                  height: 28,
                  decoration: BoxDecoration(
                    color: context.appColors.primary,
                    shape: BoxShape.circle,
                    border: Border.all(
                      color: context.appColors.surface,
                      width: 2,
                    ),
                  ),
                  child: Icon(
                    CupertinoIcons.camera,
                    size: 14,
                    color: context.appColors.background,
                  ),
                ),
              ),
              // Pro Badge
              if (isPro)
                Positioned(
                  bottom: 0,
                  right: 0,
                  child: Container(
                    padding: const EdgeInsets.symmetric(
                      horizontal: 8,
                      vertical: 4,
                    ),
                    decoration: BoxDecoration(
                      gradient: const LinearGradient(
                        colors: [AppColors.medalGold, AppColors.orange],
                      ),
                      borderRadius: BorderRadius.circular(16),
                      boxShadow: [
                        BoxShadow(
                          color: AppColors.medalGold.withValues(alpha: 0.5),
                          blurRadius: 8,
                        ),
                      ],
                    ),
                    child: Text(
                      'PRO',
                      style: TextStyle(
                        fontSize: 10,
                        fontWeight: FontWeight.w800,
                        color: context.appColors.background,
                      ),
                    ),
                  ),
                ),
            ],
          ),
        ),

        const SizedBox(height: 16),

        // Name
        Text(
          displayName,
          style: TextStyle(
            fontSize: 24,
            fontWeight: FontWeight.w700,
            color: context.appColors.textPrimary,
          ),
        ),

        if (email.isNotEmpty) ...[
          const SizedBox(height: 4),
          Text(
            email,
            style: TextStyle(
              fontSize: 14,
              color: context.appColors.textSecondary,
            ),
          ),
        ],
      ],
    );
  }

  Widget _buildAvatarContent(String? googlePhotoUrl) {
    if (googlePhotoUrl != null) {
      return Image.network(
        googlePhotoUrl,
        fit: BoxFit.cover,
        width: 100,
        height: 100,
        cacheWidth: 200,
        cacheHeight: 200,
        errorBuilder: (context, error, stackTrace) => _defaultAvatar(),
      );
    }
    return _defaultAvatar();
  }

  Widget _defaultAvatar() {
    return Container(
      color: context.appColors.surfaceLight,
      child: Icon(
        CupertinoIcons.person,
        size: 50,
        color: context.appColors.textTertiary,
      ),
    );
  }

  Widget _buildActionButtonsRow(
    BuildContext context,
    AppLocalizations l10n,
    FinanceProvider financeProvider,
  ) {
    return Wrap(
      alignment: WrapAlignment.center,
      spacing: 12,
      runSpacing: 12,
      children: [
        // Photo Button
        _buildActionButton(
          icon: CupertinoIcons.camera,
          label: l10n.changePhoto,
          onTap: () => _showPhotoOptions(l10n),
        ),
        // Salary Button
        _buildActionButton(
          icon: CupertinoIcons.money_dollar_circle,
          label: l10n.editSalary,
          onTap: () => _showEditSalarySheet(context, l10n, financeProvider),
        ),
        // Work Hours Button
        _buildActionButton(
          icon: CupertinoIcons.clock,
          label: l10n.editWorkHours,
          onTap: () => _showEditWorkHoursSheet(context, l10n, financeProvider),
        ),
        // Add Income Button
        _buildActionButton(
          icon: CupertinoIcons.plus_circle,
          label: l10n.addIncome,
          onTap: () => _navigateToAddIncome(context, financeProvider),
        ),
      ],
    );
  }

  Widget _buildActionButton({
    required IconData icon,
    required String label,
    required VoidCallback onTap,
  }) {
    return GestureDetector(
      onTap: () {
        HapticFeedback.selectionClick();
        onTap();
      },
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),
        decoration: BoxDecoration(
          color: context.appColors.surfaceLight,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: context.appColors.cardBorder),
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(icon, size: 18, color: context.appColors.primary),
            const SizedBox(width: 6),
            Text(
              label,
              style: TextStyle(
                fontSize: 13,
                fontWeight: FontWeight.w500,
                color: context.appColors.textPrimary,
              ),
            ),
          ],
        ),
      ),
    );
  }

  void _showEditSalarySheet(
    BuildContext context,
    AppLocalizations l10n,
    FinanceProvider financeProvider,
  ) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      backgroundColor: Colors.transparent,
      builder: (ctx) => _EditSalarySheet(
        financeProvider: financeProvider,
        l10n: l10n,
        onSaved: () {
          if (mounted) setState(() {});
        },
      ),
    );
  }

  void _showEditWorkHoursSheet(
    BuildContext context,
    AppLocalizations l10n,
    FinanceProvider financeProvider,
  ) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      backgroundColor: Colors.transparent,
      builder: (ctx) => _EditWorkHoursSheet(
        financeProvider: financeProvider,
        l10n: l10n,
        onSaved: () {
          if (mounted) setState(() {});
        },
      ),
    );
  }

  void _navigateToAddIncome(
    BuildContext context,
    FinanceProvider financeProvider,
  ) {
    Navigator.pop(context); // Close modal first
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (_) => IncomeWizardScreen(
          existingProfile: financeProvider.userProfile,
          existingSources: financeProvider.incomeSources,
          isEditing: true,
          skipToAdditional: true,
        ),
      ),
    );
  }

  Widget _buildSavedTimeCard(
    BuildContext context,
    double savedHours,
    AppLocalizations l10n,
  ) {
    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            context.appColors.primary.withValues(alpha: 0.25),
            context.appColors.secondary.withValues(alpha: 0.25),
          ],
        ),
        borderRadius: BorderRadius.circular(24),
        border: Border.all(
          color: context.appColors.primary.withValues(alpha: 0.4),
          width: 1,
        ),
      ),
      child: Column(
        children: [
          Icon(
            CupertinoIcons.clock,
            size: 32,
            color: context.appColors.primary,
          ),
          const SizedBox(height: 12),
          Text(
            l10n.profileSavedTime,
            style: TextStyle(
              fontSize: 14,
              fontWeight: FontWeight.w500,
              color: context.appColors.textSecondary,
            ),
          ),
          const SizedBox(height: 8),
          Text(
            l10n.profileHours(savedHours.toStringAsFixed(1)),
            style: TextStyle(
              fontSize: 36,
              fontWeight: FontWeight.w800,
              color: context.appColors.textPrimary,
              letterSpacing: -1,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildStatsRow(
    BuildContext context,
    int memberDays,
    int badgesEarned,
    AppLocalizations l10n,
  ) {
    return Row(
      children: [
        Expanded(
          child: _buildStatCard(
            icon: CupertinoIcons.calendar_badge_plus,
            label: l10n.profileMemberSince,
            value: l10n.profileDays(memberDays > 0 ? memberDays : 1),
          ),
        ),
        const SizedBox(width: 16),
        Expanded(
          child: _buildStatCard(
            icon: CupertinoIcons.rosette,
            label: l10n.profileBadgesEarned,
            value: badgesEarned.toString(),
          ),
        ),
      ],
    );
  }

  Widget _buildStatCard({
    required IconData icon,
    required String label,
    required String value,
  }) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: context.appColors.surfaceLight,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: context.appColors.cardBorder),
      ),
      child: Column(
        children: [
          Icon(icon, size: 24, color: context.appColors.primary),
          const SizedBox(height: 8),
          Text(
            value,
            style: TextStyle(
              fontSize: 20,
              fontWeight: FontWeight.w700,
              color: context.appColors.textPrimary,
            ),
          ),
          const SizedBox(height: 4),
          Text(
            label,
            style: TextStyle(
              fontSize: 12,
              color: context.appColors.textSecondary,
            ),
            textAlign: TextAlign.center,
          ),
        ],
      ),
    );
  }

  Widget _buildGoogleStatus(
    BuildContext context,
    AuthService authService,
    AppLocalizations l10n,
  ) {
    final isLinked = authService.isLinkedWithGoogle;

    return Container(
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: Colors.white.withValues(alpha: 0.06),
          width: 1,
        ),
        boxShadow: AppDesign.shadowSubtle,
      ),
      child: Material(
        color: Colors.transparent,
        child: InkWell(
          onTap: isLinked || _isLinkingGoogle
              ? null
              : () => _linkGoogleAccount(authService, l10n),
          borderRadius: BorderRadius.circular(16),
          child: Padding(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
            child: Row(
              children: [
                // Google Logo Container - Revolut style
                Container(
                  width: 44,
                  height: 44,
                  decoration: BoxDecoration(
                    color: Colors.white,
                    borderRadius: BorderRadius.circular(16),
                  ),
                  child: _isLinkingGoogle
                      ? Center(
                          child: SizedBox(
                            width: 20,
                            height: 20,
                            child: CircularProgressIndicator(
                              strokeWidth: 2,
                              valueColor: AlwaysStoppedAnimation(
                                context.appColors.primary,
                              ),
                            ),
                          ),
                        )
                      : const Center(
                          child: Text(
                            'G',
                            style: TextStyle(
                              fontSize: 22,
                              fontWeight: FontWeight.w700,
                              color: Color(0xFF4285F4),
                            ),
                          ),
                        ),
                ),
                const SizedBox(width: 14),
                // Text Content
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        'Google',
                        style: TextStyle(
                          fontSize: 15,
                          fontWeight: FontWeight.w600,
                          color: context.appColors.textPrimary,
                        ),
                      ),
                      const SizedBox(height: 2),
                      Text(
                        isLinked
                            ? l10n.profileGoogleConnected
                            : l10n.dataNotBackedUp,
                        style: TextStyle(
                          fontSize: 13,
                          color: isLinked
                              ? context.appColors.success
                              : context.appColors.textTertiary,
                        ),
                      ),
                    ],
                  ),
                ),
                // Status / Action Button
                if (_isLinkingGoogle)
                  Text(
                    l10n.linking,
                    style: TextStyle(
                      fontSize: 13,
                      fontWeight: FontWeight.w500,
                      color: context.appColors.textTertiary,
                    ),
                  )
                else if (isLinked)
                  Icon(
                    CupertinoIcons.checkmark_circle_fill,
                    size: 22,
                    color: context.appColors.success,
                  )
                else
                  Container(
                    padding: const EdgeInsets.symmetric(
                      horizontal: 14,
                      vertical: 8,
                    ),
                    decoration: BoxDecoration(
                      color: context.appColors.primary,
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Text(
                      l10n.linkWithGoogle,
                      style: const TextStyle(
                        fontSize: 13,
                        fontWeight: FontWeight.w600,
                        color: Colors.white,
                      ),
                    ),
                  ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Future<void> _linkGoogleAccount(
    AuthService authService,
    AppLocalizations l10n,
  ) async {
    setState(() => _isLinkingGoogle = true);
    HapticFeedback.mediumImpact();

    try {
      final result = await authService.signInWithGoogle();

      if (!mounted) return;

      if (result.success) {
        HapticFeedback.heavyImpact();
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                const Icon(Icons.check_circle, color: Colors.white, size: 20),
                const SizedBox(width: 12),
                Expanded(child: Text(l10n.googleLinkedSuccess)),
              ],
            ),
            backgroundColor: context.appColors.success,
            behavior: SnackBarBehavior.floating,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(16),
            ),
          ),
        );
        // Refresh UI to show linked status
        setState(() {});
      } else {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                const Icon(Icons.error_outline, color: Colors.white, size: 20),
                const SizedBox(width: 12),
                Expanded(
                  child: Text(result.errorMessage ?? l10n.googleLinkFailed),
                ),
              ],
            ),
            backgroundColor: context.appColors.error,
            behavior: SnackBarBehavior.floating,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(16),
            ),
          ),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(l10n.googleLinkFailed),
            backgroundColor: context.appColors.error,
            behavior: SnackBarBehavior.floating,
          ),
        );
      }
    } finally {
      if (mounted) {
        setState(() => _isLinkingGoogle = false);
      }
    }
  }

  Widget _buildAppleStatus(
    BuildContext context,
    AuthService authService,
    AppLocalizations l10n,
  ) {
    final isLinked = authService.isLinkedWithApple;

    return Container(
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: Colors.white.withValues(alpha: 0.06),
          width: 1,
        ),
        boxShadow: AppDesign.shadowSubtle,
      ),
      child: Material(
        color: Colors.transparent,
        child: InkWell(
          onTap: isLinked || _isLinkingApple
              ? null
              : () => _linkAppleAccount(authService, l10n),
          borderRadius: BorderRadius.circular(16),
          child: Padding(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
            child: Row(
              children: [
                // Apple Logo Container - Revolut style
                Container(
                  width: 44,
                  height: 44,
                  decoration: BoxDecoration(
                    color: Colors.black,
                    borderRadius: BorderRadius.circular(16),
                  ),
                  child: _isLinkingApple
                      ? const Center(
                          child: SizedBox(
                            width: 20,
                            height: 20,
                            child: CircularProgressIndicator(
                              strokeWidth: 2,
                              valueColor: AlwaysStoppedAnimation(Colors.white),
                            ),
                          ),
                        )
                      : const Center(
                          child: Icon(
                            Icons.apple,
                            size: 26,
                            color: Colors.white,
                          ),
                        ),
                ),
                const SizedBox(width: 14),
                // Text Content
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            'Apple',
                            style: TextStyle(
                              fontSize: 15,
                              fontWeight: FontWeight.w600,
                              color: context.appColors.textPrimary,
                            ),
                          ),
                          const SizedBox(height: 2),
                          Text(
                            isLinked
                                ? l10n.profileAppleConnected
                                : l10n.profileAppleNotConnected,
                            style: TextStyle(
                              fontSize: 13,
                              color: isLinked
                                  ? context.appColors.success
                                  : context.appColors.textTertiary,
                            ),
                          ),
                        ],
                      ),
                    ),
                    // Status / Action Button - Revolut style
                    if (_isLinkingApple)
                      Text(
                        l10n.linking,
                        style: TextStyle(
                          fontSize: 13,
                          fontWeight: FontWeight.w500,
                          color: context.appColors.textTertiary,
                        ),
                      )
                    else if (isLinked)
                      Icon(
                        CupertinoIcons.checkmark_circle_fill,
                        size: 22,
                        color: context.appColors.success,
                      )
                    else
                      Container(
                        padding: const EdgeInsets.symmetric(
                          horizontal: 14,
                          vertical: 8,
                        ),
                        decoration: BoxDecoration(
                          color: Colors.black,
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: Text(
                          l10n.linkWithApple,
                          style: const TextStyle(
                            fontSize: 13,
                            fontWeight: FontWeight.w600,
                            color: Colors.white,
                          ),
                        ),
                      ),
                  ],
                ),
              ),
            ),
          ),
    );
  }

  Future<void> _linkAppleAccount(
    AuthService authService,
    AppLocalizations l10n,
  ) async {
    setState(() => _isLinkingApple = true);
    HapticFeedback.mediumImpact();

    try {
      final result = await authService.signInWithApple();

      if (!mounted) return;

      if (result.success) {
        HapticFeedback.heavyImpact();
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                const Icon(Icons.check_circle, color: Colors.white, size: 20),
                const SizedBox(width: 12),
                Expanded(child: Text(l10n.appleLinkedSuccess)),
              ],
            ),
            backgroundColor: context.appColors.success,
            behavior: SnackBarBehavior.floating,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(16),
            ),
          ),
        );
        // Refresh UI to show linked status
        setState(() {});
      } else {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                const Icon(Icons.error_outline, color: Colors.white, size: 20),
                const SizedBox(width: 12),
                Expanded(
                  child: Text(result.errorMessage ?? l10n.appleLinkFailed),
                ),
              ],
            ),
            backgroundColor: context.appColors.error,
            behavior: SnackBarBehavior.floating,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(16),
            ),
          ),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(l10n.appleLinkFailed),
            backgroundColor: context.appColors.error,
            behavior: SnackBarBehavior.floating,
          ),
        );
      }
    } finally {
      if (mounted) {
        setState(() => _isLinkingApple = false);
      }
    }
  }

  Widget _buildSignOutButton(
    BuildContext context,
    AuthService authService,
    AppLocalizations l10n,
  ) {
    return SizedBox(
      width: double.infinity,
      child: OutlinedButton.icon(
        onPressed: () => _confirmSignOut(context, authService, l10n),
        style: OutlinedButton.styleFrom(
          padding: const EdgeInsets.symmetric(vertical: 16),
          side: BorderSide(
            color: context.appColors.error.withValues(alpha: 0.5),
          ),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(16),
          ),
        ),
        icon: Icon(
          CupertinoIcons.square_arrow_right,
          size: 20,
          color: context.appColors.error,
        ),
        label: Text(
          l10n.profileSignOut,
          style: TextStyle(
            fontSize: 14,
            fontWeight: FontWeight.w600,
            color: context.appColors.error,
          ),
        ),
      ),
    );
  }

  Future<void> _confirmSignOut(
    BuildContext context,
    AuthService authService,
    AppLocalizations l10n,
  ) async {
    final confirmed = await showDialog<bool>(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      builder: (context) => AlertDialog(
        backgroundColor: context.appColors.surface,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(24)),
        title: Text(
          l10n.profileSignOut,
          style: TextStyle(
            color: context.appColors.textPrimary,
            fontWeight: FontWeight.w600,
          ),
        ),
        content: Text(
          l10n.profileSignOutConfirm,
          style: TextStyle(color: context.appColors.textSecondary),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: Text(
              l10n.cancel,
              style: TextStyle(color: context.appColors.textSecondary),
            ),
          ),
          ElevatedButton(
            onPressed: () => Navigator.pop(context, true),
            style: ElevatedButton.styleFrom(
              backgroundColor: context.appColors.error,
              foregroundColor: context.appColors.textPrimary,
            ),
            child: Text(l10n.profileSignOut),
          ),
        ],
      ),
    );

    if (confirmed == true && context.mounted) {
      HapticFeedback.heavyImpact();
      await authService.signOut();

      if (context.mounted) {
        Navigator.of(context).pushAndRemoveUntil(
          MaterialPageRoute(builder: (_) => const OnboardingScreen()),
          (route) => false,
        );
      }
    }
  }
}

// ============================================================================
// PHOTO OPTIONS SHEET
// ============================================================================

class _PhotoOptionsSheet extends StatelessWidget {
  final String? localPhotoPath;
  final VoidCallback onCameraTap;
  final VoidCallback onGalleryTap;
  final VoidCallback onDeleteTap;
  final AppLocalizations l10n;

  const _PhotoOptionsSheet({
    required this.localPhotoPath,
    required this.onCameraTap,
    required this.onGalleryTap,
    required this.onDeleteTap,
    required this.l10n,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
      ),
      child: SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(24),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Container(
                width: 40,
                height: 4,
                decoration: BoxDecoration(
                  color: context.appColors.textTertiary,
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
              const SizedBox(height: 24),
              Text(
                l10n.changePhoto,
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textPrimary,
                ),
              ),
              const SizedBox(height: 20),
              _buildOption(
                context: context,
                icon: CupertinoIcons.camera,
                label: l10n.takePhoto,
                onTap: onCameraTap,
              ),
              const SizedBox(height: 12),
              _buildOption(
                context: context,
                icon: CupertinoIcons.photo,
                label: l10n.selectFromGallery,
                onTap: onGalleryTap,
              ),
              if (localPhotoPath != null) ...[
                const SizedBox(height: 12),
                _buildOption(
                  context: context,
                  icon: CupertinoIcons.trash,
                  label: l10n.removePhoto,
                  onTap: onDeleteTap,
                  isDestructive: true,
                ),
              ],
              const SizedBox(height: 12),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildOption({
    required BuildContext context,
    required IconData icon,
    required String label,
    required VoidCallback onTap,
    bool isDestructive = false,
  }) {
    return Material(
      color: Colors.transparent,
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(16),
        child: Container(
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: isDestructive
                ? context.appColors.error.withValues(alpha: 0.1)
                : context.appColors.surfaceLight,
            borderRadius: BorderRadius.circular(16),
          ),
          child: Row(
            children: [
              Icon(
                icon,
                color: isDestructive
                    ? context.appColors.error
                    : context.appColors.textSecondary,
                size: 24,
              ),
              const SizedBox(width: 16),
              Text(
                label,
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.w500,
                  color: isDestructive
                      ? context.appColors.error
                      : context.appColors.textPrimary,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

// ============================================================================
// EDIT SALARY SHEET
// ============================================================================

class _EditSalarySheet extends StatefulWidget {
  final FinanceProvider financeProvider;
  final AppLocalizations l10n;
  final VoidCallback onSaved;

  const _EditSalarySheet({
    required this.financeProvider,
    required this.l10n,
    required this.onSaved,
  });

  @override
  State<_EditSalarySheet> createState() => _EditSalarySheetState();
}

class _EditSalarySheetState extends State<_EditSalarySheet> {
  final _amountController = TextEditingController();
  final _profileService = ProfileService();
  bool _isLoading = false;

  @override
  void initState() {
    super.initState();
    // Pre-fill with current salary
    final primarySource = widget.financeProvider.userProfile?.primarySource;
    if (primarySource != null) {
      _amountController.text = formatTurkishCurrency(primarySource.amount);
    }
  }

  @override
  void dispose() {
    _amountController.dispose();
    super.dispose();
  }

  double? get _amount {
    final text = _amountController.text.trim();
    if (text.isEmpty) return null;
    return parseTurkishCurrency(text);
  }

  bool get _canSave => _amount != null && _amount! > 0;

  Future<void> _saveSalary() async {
    if (!_canSave || _isLoading) return;

    setState(() => _isLoading = true);
    HapticFeedback.mediumImpact();

    try {
      final profile = widget.financeProvider.userProfile;
      if (profile == null) return;

      final primarySource = profile.primarySource;
      if (primarySource == null) return;

      // Update primary source amount
      final updatedSource = primarySource.copyWith(amount: _amount!);
      final updatedProfile = await _profileService.updateIncomeSource(
        primarySource.id,
        updatedSource,
      );

      if (updatedProfile != null && mounted) {
        widget.financeProvider.setUserProfile(updatedProfile);
        widget.onSaved();

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(widget.l10n.incomesUpdated),
            backgroundColor: context.appColors.success,
            behavior: SnackBarBehavior.floating,
          ),
        );

        Navigator.pop(context);
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Error: $e'),
            backgroundColor: context.appColors.error,
            behavior: SnackBarBehavior.floating,
          ),
        );
      }
    } finally {
      if (mounted) {
        setState(() => _isLoading = false);
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    final l10n = widget.l10n;
    final bottomPadding = MediaQuery.of(context).viewInsets.bottom;
    final primarySource = widget.financeProvider.userProfile?.primarySource;
    final currencySymbol = primarySource?.currencyCode == 'TRY' ? '₺' : '\$';

    return Container(
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
      ),
      child: ClipRRect(
        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
        child: BackdropFilter(
          filter: ImageFilter.blur(sigmaX: 20, sigmaY: 20),
          child: SafeArea(
            child: Padding(
              padding: EdgeInsets.fromLTRB(20, 12, 20, 20 + bottomPadding),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                crossAxisAlignment: CrossAxisAlignment.stretch,
                children: [
                  // Handle bar
                  Center(
                    child: Container(
                      width: 40,
                      height: 4,
                      decoration: BoxDecoration(
                        color: context.appColors.textTertiary.withValues(
                          alpha: 0.3,
                        ),
                        borderRadius: BorderRadius.circular(2),
                      ),
                    ),
                  ),
                  const SizedBox(height: 20),

                  // Header
                  Row(
                    children: [
                      Container(
                        width: 48,
                        height: 48,
                        decoration: BoxDecoration(
                          color: context.appColors.primary.withValues(
                            alpha: 0.15,
                          ),
                          borderRadius: BorderRadius.circular(16),
                        ),
                        child: Icon(
                          CupertinoIcons.money_dollar_circle,
                          color: context.appColors.primary,
                          size: 24,
                        ),
                      ),
                      const SizedBox(width: 16),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              l10n.editSalary,
                              style: TextStyle(
                                fontSize: 20,
                                fontWeight: FontWeight.w700,
                                color: context.appColors.textPrimary,
                              ),
                            ),
                            Text(
                              l10n.editSalarySubtitle,
                              style: TextStyle(
                                fontSize: 14,
                                color: context.appColors.textSecondary,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 24),

                  // Amount Input
                  Text(
                    l10n.monthlyIncome,
                    style: TextStyle(
                      fontSize: 14,
                      fontWeight: FontWeight.w600,
                      color: context.appColors.textSecondary,
                    ),
                  ),
                  const SizedBox(height: 8),
                  TextField(
                    controller: _amountController,
                    keyboardType: const TextInputType.numberWithOptions(
                      decimal: true,
                    ),
                    inputFormatters: [TurkishCurrencyInputFormatter()],
                    autofocus: true,
                    onChanged: (_) => setState(() {}),
                    style: TextStyle(
                      fontSize: 32,
                      fontWeight: FontWeight.w700,
                      color: context.appColors.textPrimary,
                    ),
                    textAlign: TextAlign.center,
                    decoration: InputDecoration(
                      hintText: '0',
                      hintStyle: TextStyle(
                        fontSize: 32,
                        fontWeight: FontWeight.w700,
                        color: context.appColors.textTertiary,
                      ),
                      filled: true,
                      fillColor: context.appColors.surfaceLight,
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(16),
                        borderSide: BorderSide.none,
                      ),
                      contentPadding: const EdgeInsets.symmetric(
                        horizontal: 20,
                        vertical: 20,
                      ),
                      prefixText: '$currencySymbol ',
                      prefixStyle: TextStyle(
                        fontSize: 28,
                        fontWeight: FontWeight.w600,
                        color: context.appColors.textSecondary,
                      ),
                    ),
                  ),
                  const SizedBox(height: 24),

                  // Save Button
                  GestureDetector(
                    onTap: _canSave && !_isLoading ? _saveSalary : null,
                    child: AnimatedContainer(
                      duration: const Duration(milliseconds: 200),
                      width: double.infinity,
                      padding: const EdgeInsets.symmetric(vertical: 16),
                      decoration: BoxDecoration(
                        color: _canSave && !_isLoading
                            ? context.appColors.primary
                            : context.appColors.surfaceLight,
                        borderRadius: BorderRadius.circular(16),
                        boxShadow: _canSave && !_isLoading
                            ? [
                                BoxShadow(
                                  color: context.appColors.primary.withValues(
                                    alpha: 0.3,
                                  ),
                                  blurRadius: 16,
                                  offset: const Offset(0, 6),
                                ),
                              ]
                            : null,
                      ),
                      child: _isLoading
                          ? Center(
                              child: SizedBox(
                                width: 24,
                                height: 24,
                                child: CircularProgressIndicator(
                                  strokeWidth: 2,
                                  valueColor: AlwaysStoppedAnimation(
                                    context.appColors.background,
                                  ),
                                ),
                              ),
                            )
                          : Row(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                Icon(
                                  CupertinoIcons.checkmark,
                                  size: 20,
                                  color: _canSave
                                      ? context.appColors.background
                                      : context.appColors.textTertiary,
                                ),
                                const SizedBox(width: 8),
                                Text(
                                  l10n.save,
                                  style: TextStyle(
                                    fontSize: 16,
                                    fontWeight: FontWeight.w600,
                                    color: _canSave
                                        ? context.appColors.background
                                        : context.appColors.textTertiary,
                                  ),
                                ),
                              ],
                            ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

// ============================================================================
// EDIT WORK HOURS SHEET
// ============================================================================

class _EditWorkHoursSheet extends StatefulWidget {
  final FinanceProvider financeProvider;
  final AppLocalizations l10n;
  final VoidCallback onSaved;

  const _EditWorkHoursSheet({
    required this.financeProvider,
    required this.l10n,
    required this.onSaved,
  });

  @override
  State<_EditWorkHoursSheet> createState() => _EditWorkHoursSheetState();
}

class _EditWorkHoursSheetState extends State<_EditWorkHoursSheet> {
  final _profileService = ProfileService();
  late double _selectedHours;
  bool _isLoading = false;

  @override
  void initState() {
    super.initState();
    _selectedHours = widget.financeProvider.userProfile?.dailyHours ?? 8;
  }

  Future<void> _saveWorkHours() async {
    if (_isLoading) return;

    setState(() => _isLoading = true);
    HapticFeedback.mediumImpact();

    try {
      final profile = widget.financeProvider.userProfile;
      if (profile == null) return;

      final updatedProfile = profile.copyWith(dailyHours: _selectedHours);
      await _profileService.saveProfile(updatedProfile);

      if (mounted) {
        widget.financeProvider.setUserProfile(updatedProfile);
        widget.onSaved();

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(widget.l10n.workHoursUpdated),
            backgroundColor: context.appColors.success,
            behavior: SnackBarBehavior.floating,
          ),
        );

        Navigator.pop(context);
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Error: $e'),
            backgroundColor: context.appColors.error,
            behavior: SnackBarBehavior.floating,
          ),
        );
      }
    } finally {
      if (mounted) {
        setState(() => _isLoading = false);
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    final l10n = widget.l10n;
    final bottomPadding = MediaQuery.of(context).viewInsets.bottom;

    return Container(
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
      ),
      child: ClipRRect(
        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
        child: BackdropFilter(
          filter: ImageFilter.blur(sigmaX: 20, sigmaY: 20),
          child: SafeArea(
            child: Padding(
              padding: EdgeInsets.fromLTRB(20, 12, 20, 20 + bottomPadding),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                crossAxisAlignment: CrossAxisAlignment.stretch,
                children: [
                  // Handle bar
                  Center(
                    child: Container(
                      width: 40,
                      height: 4,
                      decoration: BoxDecoration(
                        color: context.appColors.textTertiary.withValues(
                          alpha: 0.3,
                        ),
                        borderRadius: BorderRadius.circular(2),
                      ),
                    ),
                  ),
                  const SizedBox(height: 20),

                  // Header
                  Row(
                    children: [
                      Container(
                        width: 48,
                        height: 48,
                        decoration: BoxDecoration(
                          color: context.appColors.primary.withValues(
                            alpha: 0.15,
                          ),
                          borderRadius: BorderRadius.circular(16),
                        ),
                        child: Icon(
                          CupertinoIcons.clock,
                          color: context.appColors.primary,
                          size: 24,
                        ),
                      ),
                      const SizedBox(width: 16),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              l10n.editWorkHours,
                              style: TextStyle(
                                fontSize: 20,
                                fontWeight: FontWeight.w700,
                                color: context.appColors.textPrimary,
                              ),
                            ),
                            Text(
                              l10n.editWorkHoursSubtitle,
                              style: TextStyle(
                                fontSize: 14,
                                color: context.appColors.textSecondary,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 32),

                  // Hours Display
                  Center(
                    child: Text(
                      l10n.hoursPerDay(_selectedHours.toStringAsFixed(1)),
                      style: TextStyle(
                        fontSize: 36,
                        fontWeight: FontWeight.w800,
                        color: context.appColors.textPrimary,
                      ),
                    ),
                  ),
                  const SizedBox(height: 16),

                  // Slider
                  SliderTheme(
                    data: SliderTheme.of(context).copyWith(
                      activeTrackColor: context.appColors.primary,
                      inactiveTrackColor: context.appColors.surfaceLight,
                      thumbColor: context.appColors.primary,
                      overlayColor: context.appColors.primary.withValues(alpha: 0.2),
                      trackHeight: 8,
                      thumbShape: const RoundSliderThumbShape(enabledThumbRadius: 14),
                    ),
                    child: Slider(
                      value: _selectedHours,
                      min: 1,
                      max: 16,
                      divisions: 30,
                      onChanged: (value) {
                        HapticFeedback.selectionClick();
                        setState(() => _selectedHours = value);
                      },
                    ),
                  ),

                  // Quick select buttons
                  const SizedBox(height: 16),
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                    children: [4.0, 6.0, 8.0, 10.0, 12.0].map((hours) {
                      final isSelected = _selectedHours == hours;
                      return GestureDetector(
                        onTap: () {
                          HapticFeedback.selectionClick();
                          setState(() => _selectedHours = hours);
                        },
                        child: Container(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 16,
                            vertical: 10,
                          ),
                          decoration: BoxDecoration(
                            color: isSelected
                                ? context.appColors.primary
                                : context.appColors.surfaceLight,
                            borderRadius: BorderRadius.circular(16),
                            border: Border.all(
                              color: isSelected
                                  ? context.appColors.primary
                                  : context.appColors.cardBorder,
                            ),
                          ),
                          child: Text(
                            '${hours.toInt()}h',
                            style: TextStyle(
                              fontSize: 14,
                              fontWeight: FontWeight.w600,
                              color: isSelected
                                  ? context.appColors.background
                                  : context.appColors.textSecondary,
                            ),
                          ),
                        ),
                      );
                    }).toList(),
                  ),
                  const SizedBox(height: 24),

                  // Save Button
                  GestureDetector(
                    onTap: _isLoading ? null : _saveWorkHours,
                    child: AnimatedContainer(
                      duration: const Duration(milliseconds: 200),
                      width: double.infinity,
                      padding: const EdgeInsets.symmetric(vertical: 16),
                      decoration: BoxDecoration(
                        color: context.appColors.primary,
                        borderRadius: BorderRadius.circular(16),
                        boxShadow: [
                          BoxShadow(
                            color: context.appColors.primary.withValues(
                              alpha: 0.3,
                            ),
                            blurRadius: 16,
                            offset: const Offset(0, 6),
                          ),
                        ],
                      ),
                      child: _isLoading
                          ? Center(
                              child: SizedBox(
                                width: 24,
                                height: 24,
                                child: CircularProgressIndicator(
                                  strokeWidth: 2,
                                  valueColor: AlwaysStoppedAnimation(
                                    context.appColors.background,
                                  ),
                                ),
                              ),
                            )
                          : Row(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                Icon(
                                  CupertinoIcons.checkmark,
                                  size: 20,
                                  color: context.appColors.background,
                                ),
                                const SizedBox(width: 8),
                                Text(
                                  l10n.save,
                                  style: TextStyle(
                                    fontSize: 16,
                                    fontWeight: FontWeight.w600,
                                    color: context.appColors.background,
                                  ),
                                ),
                              ],
                            ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}


--- FILE: lib/screens/settings_screen.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:share_plus/share_plus.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:url_launcher/url_launcher.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../providers/locale_provider.dart';
import '../providers/currency_provider.dart';
import '../providers/pro_provider.dart';
import '../providers/finance_provider.dart';
import '../providers/theme_provider.dart';
import '../services/auth_service.dart';
import '../services/export_service.dart';
import '../services/purchase_service.dart';
import '../services/sound_service.dart';
import '../services/referral_service.dart';
import '../services/deep_link_service.dart';
import '../services/simple_mode_service.dart';
import '../services/lock_service.dart';
import '../services/backup_service.dart';
import 'dart:io' show Platform;
import '../theme/theme.dart';
import '../widgets/currency_selector.dart';
import 'paywall_screen.dart';
import 'onboarding_screen.dart';
import 'achievements_screen.dart';
import 'notification_settings_screen.dart';
import 'voice_input_screen.dart';
import 'pin_setup_screen.dart';
import 'import_statement_screen.dart';

/// Settings Screen - Replaces Profile in bottom nav
class SettingsScreen extends StatefulWidget {
  const SettingsScreen({super.key});

  @override
  State<SettingsScreen> createState() => _SettingsScreenState();
}

class _SettingsScreenState extends State<SettingsScreen> {
  bool _isExporting = false;
  bool _isRestoring = false;
  bool _soundEnabled = true;
  bool _simpleModeEnabled = false;

  // Referral system
  String? _referralCode;
  int _referralCount = 0;
  bool _isLoadingReferral = true;

  @override
  void initState() {
    super.initState();
    _loadSettings();
    _loadReferralData();
  }

  Future<void> _loadSettings() async {
    // Initialize simple mode service
    await simpleModeService.initialize();

    setState(() {
      _soundEnabled = soundService.isEnabled;
      _simpleModeEnabled = simpleModeService.isEnabled;
    });
  }

  Future<void> _loadReferralData() async {
    try {
      final referralService = ReferralService();

      // Get or create referral code
      final code = await referralService.getOrCreateReferralCode();

      // Get referral stats
      final stats = await referralService.getReferralStats();

      if (mounted) {
        setState(() {
          _referralCode = code;
          _referralCount = stats.totalReferrals;
          _isLoadingReferral = false;
        });
      }
    } catch (e) {
      debugPrint('[Settings] Error loading referral data: $e');
      if (mounted) {
        setState(() => _isLoadingReferral = false);
      }
    }
  }

  Future<void> _toggleSound(bool value) async {
    await soundService.setEnabled(value);
    setState(() => _soundEnabled = value);
    HapticFeedback.selectionClick();

    // Play success sound as feedback when enabling
    if (value) {
      soundService.playSuccess();
    }
  }

  Future<void> _toggleSimpleMode(bool value) async {
    await simpleModeService.setEnabled(value);
    setState(() => _simpleModeEnabled = value);
    HapticFeedback.selectionClick();
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final proProvider = context.watch<ProProvider>();
    final isPro = proProvider.isPro;

    return Scaffold(
      backgroundColor: context.appColors.background,
      body: SafeArea(
        child: CustomScrollView(
          slivers: [
            // Header
            SliverToBoxAdapter(
              child: Padding(
                padding: const EdgeInsets.fromLTRB(24, 16, 24, 24),
                child: Semantics(
                  header: true,
                  child: Text(
                    l10n.navSettings,
                    style: TextStyle(
                      fontSize: 28,
                      fontWeight: FontWeight.w700,
                      color: context.appColors.textPrimary,
                    ),
                  ),
                ),
              ),
            ),

            // Growth Section (Invite Friends)
            SliverToBoxAdapter(child: _buildGrowthSection(l10n)),

            const SliverToBoxAdapter(child: SizedBox(height: 24)),

            // General Section
            SliverToBoxAdapter(
              child: _buildSection(
                title: l10n.settingsGeneral,
                children: [
                  _buildCurrencyTile(l10n),
                  _buildDivider(),
                  _buildLanguageTile(l10n),
                  _buildDivider(),
                  _buildThemeTile(l10n),
                  _buildDivider(),
                  _buildSimpleModeTile(l10n),
                ],
              ),
            ),

            const SliverToBoxAdapter(child: SizedBox(height: 16)),

            // Notifications Section
            SliverToBoxAdapter(
              child: _buildSection(
                title: l10n.settingsNotifications,
                children: [
                  _buildRemindersTile(l10n),
                  _buildDivider(),
                  _buildSoundEffectsTile(l10n),
                ],
              ),
            ),

            const SliverToBoxAdapter(child: SizedBox(height: 16)),

            // Security Section
            SliverToBoxAdapter(child: _buildSecuritySection(l10n)),

            const SliverToBoxAdapter(child: SizedBox(height: 16)),

            // Pro & Purchases Section
            SliverToBoxAdapter(
              child: _buildSection(
                title: l10n.settingsProPurchases,
                children: [
                  _buildProTile(l10n, isPro),
                  _buildDivider(),
                  _buildRestorePurchasesTile(l10n),
                ],
              ),
            ),

            const SliverToBoxAdapter(child: SizedBox(height: 16)),

            // Achievements Section
            SliverToBoxAdapter(
              child: _buildSection(
                title: l10n.navAchievements,
                children: [_buildAchievementsTile(l10n)],
              ),
            ),

            const SliverToBoxAdapter(child: SizedBox(height: 16)),

            // Voice & Shortcuts Section (NEW)
            SliverToBoxAdapter(child: _buildVoiceSection(l10n)),

            const SliverToBoxAdapter(child: SizedBox(height: 16)),

            // Data & Privacy Section
            SliverToBoxAdapter(
              child: _buildSection(
                title: l10n.settingsDataPrivacy,
                children: [
                  _buildGoogleAccountTile(l10n),
                  _buildDivider(),
                  _buildExportTile(l10n, isPro),
                  _buildDivider(),
                  _buildImportStatementTile(l10n, isPro),
                  _buildDivider(),
                  _buildPrivacyPolicyTile(l10n),
                  _buildDivider(),
                  _buildTermsOfServiceTile(l10n),
                  _buildDivider(),
                  _buildDeleteAccountTile(l10n),
                ],
              ),
            ),

            const SliverToBoxAdapter(child: SizedBox(height: 16)),

            // Backup & Share Section
            SliverToBoxAdapter(
              child: _buildSection(
                title: l10n.settingsDataPrivacy,
                children: [
                  _buildBackupTile(l10n),
                  _buildDivider(),
                  _buildRestoreTile(l10n),
                ],
              ),
            ),

            const SliverToBoxAdapter(child: SizedBox(height: 16)),

            // About Section
            SliverToBoxAdapter(
              child: _buildSection(
                title: l10n.settingsAbout,
                children: [
                  _buildShareAppTile(l10n),
                  _buildDivider(),
                  _buildRateAppTile(l10n),
                  _buildDivider(),
                  _buildFeedbackTile(l10n),
                  _buildDivider(),
                  _buildVersionTile(l10n),
                  _buildDivider(),
                  _buildContactUsTile(l10n),
                ],
              ),
            ),

            // Bottom padding for nav bar
            const SliverToBoxAdapter(child: SizedBox(height: 120)),
          ],
        ),
      ),
    );
  }

  Widget _buildGrowthSection(AppLocalizations l10n) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20),
      child: Container(
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: [context.appColors.primary, context.appColors.secondary],
          ),
          borderRadius: BorderRadius.circular(24),
          boxShadow: [
            BoxShadow(
              color: context.appColors.primary.withValues(alpha: 0.4),
              blurRadius: 20,
              offset: const Offset(0, 8),
            ),
          ],
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Header row
            Row(
              children: [
                Container(
                  width: 48,
                  height: 48,
                  decoration: BoxDecoration(
                    color: context.appColors.textPrimary.withValues(alpha: 0.2),
                    borderRadius: BorderRadius.circular(16),
                  ),
                  child: Icon(
                    CupertinoIcons.gift_fill,
                    size: 24,
                    color: context.appColors.textPrimary,
                  ),
                ),
                const SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        l10n.inviteFriends,
                        style: TextStyle(
                          fontSize: 16,
                          fontWeight: FontWeight.w700,
                          color: context.appColors.textPrimary,
                        ),
                      ),
                      const SizedBox(height: 4),
                      Text(
                        l10n.referralRewardInfo,
                        style: TextStyle(
                          fontSize: 12,
                          color: context.appColors.textPrimary.withValues(
                            alpha: 0.9,
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),

            const SizedBox(height: 20),

            // Referral code display
            if (_isLoadingReferral)
              Center(
                child: SizedBox(
                  width: 20,
                  height: 20,
                  child: CircularProgressIndicator(
                    strokeWidth: 2,
                    color: context.appColors.textPrimary.withValues(alpha: 0.9),
                  ),
                ),
              )
            else if (_referralCode != null) ...[
              // Code card
              Semantics(
                button: true,
                label: l10n.codeCopied.replaceAll('!', ''),
                hint: l10n.yourReferralCode,
                child: GestureDetector(
                  onTap: _copyReferralCode,
                  child: Container(
                    padding: const EdgeInsets.symmetric(
                      horizontal: 16,
                      vertical: 12,
                    ),
                    decoration: BoxDecoration(
                      color: context.appColors.textPrimary.withValues(
                        alpha: 0.15,
                      ),
                      borderRadius: BorderRadius.circular(16),
                      border: Border.all(
                        color: context.appColors.textPrimary.withValues(
                          alpha: 0.2,
                        ),
                        width: 1,
                      ),
                    ),
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              l10n.yourReferralCode,
                              style: TextStyle(
                                fontSize: 11,
                                fontWeight: FontWeight.w500,
                                color: context.appColors.textPrimary.withValues(
                                  alpha: 0.9,
                                ),
                              ),
                            ),
                            const SizedBox(height: 4),
                            Text(
                              _referralCode!,
                              style: TextStyle(
                                fontSize: 18,
                                fontWeight: FontWeight.w700,
                                color: context.appColors.textPrimary,
                                letterSpacing: 1.2,
                              ),
                            ),
                          ],
                        ),
                        Container(
                          padding: const EdgeInsets.all(10),
                          decoration: BoxDecoration(
                            color: context.appColors.textPrimary.withValues(
                              alpha: 0.2,
                            ),
                            borderRadius: BorderRadius.circular(8),
                          ),
                          child: Icon(
                            CupertinoIcons.doc_on_doc_fill,
                            size: 20,
                            color: context.appColors.textPrimary,
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              ),

              const SizedBox(height: 12),

              // Stats row
              Row(
                children: [
                  // Friends joined count
                  Expanded(
                    child: Container(
                      padding: const EdgeInsets.symmetric(vertical: 12),
                      decoration: BoxDecoration(
                        color: context.appColors.textPrimary.withValues(
                          alpha: 0.1,
                        ),
                        borderRadius: BorderRadius.circular(8),
                      ),
                      child: Column(
                        children: [
                          Text(
                            '$_referralCount',
                            style: TextStyle(
                              fontSize: 24,
                              fontWeight: FontWeight.w700,
                              color: context.appColors.textPrimary,
                            ),
                          ),
                          const SizedBox(height: 4),
                          Text(
                            l10n
                                .referralStats(_referralCount)
                                .replaceAll('$_referralCount ', ''),
                            style: TextStyle(
                              fontSize: 11,
                              color: context.appColors.textPrimary.withValues(
                                alpha: 0.9,
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                  const SizedBox(width: 12),
                  // Share button
                  Expanded(
                    child: Semantics(
                      button: true,
                      label: l10n.shareInviteLink,
                      child: GestureDetector(
                        onTap: _shareApp,
                        child: Container(
                          padding: const EdgeInsets.symmetric(vertical: 16),
                          decoration: BoxDecoration(
                            color: Colors.white,
                            borderRadius: BorderRadius.circular(8),
                          ),
                          child: Row(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              Icon(
                                CupertinoIcons.share,
                                size: 18,
                                color: context.appColors.primary,
                              ),
                              const SizedBox(width: 8),
                              Text(
                                l10n.shareInviteLink,
                                style: TextStyle(
                                  fontSize: 13,
                                  fontWeight: FontWeight.w600,
                                  color: context.appColors.primary,
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            ],
          ],
        ),
      ),
    );
  }

  void _shareApp() {
    final l10n = AppLocalizations.of(context);
    HapticFeedback.mediumImpact();

    // Generate referral link
    final referralLink = _referralCode != null
        ? DeepLinkService.generateReferralLink(_referralCode!).toString()
        : 'https://play.google.com/store/apps/details?id=com.vantag.app';

    Share.share(l10n.shareDefaultMessage(referralLink));
  }

  void _copyReferralCode() {
    if (_referralCode == null) return;

    HapticFeedback.mediumImpact();
    Clipboard.setData(ClipboardData(text: _referralCode!));
    soundService.playSuccess();

    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Row(
          children: [
            const Icon(Icons.check_circle, color: Colors.white, size: 20),
            const SizedBox(width: 12),
            Text(AppLocalizations.of(context).codeCopied),
          ],
        ),
        backgroundColor: context.appColors.success,
        behavior: SnackBarBehavior.floating,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
        duration: const Duration(seconds: 2),
      ),
    );
  }

  Widget _buildSection({
    required String title,
    required List<Widget> children,
  }) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Padding(
            padding: const EdgeInsets.only(left: 4, bottom: 12),
            child: Text(
              title.toUpperCase(),
              style: TextStyle(
                fontSize: 12,
                fontWeight: FontWeight.w600,
                letterSpacing: 1.2,
                color: context.appColors.textTertiary,
              ),
            ),
          ),
          Container(
            decoration: BoxDecoration(
              color: context.appColors.surface,
              borderRadius: BorderRadius.circular(16),
              border: Border.all(color: context.appColors.cardBorder),
            ),
            child: Column(children: children),
          ),
        ],
      ),
    );
  }

  /// Voice & Shortcuts section with NEW badge
  Widget _buildVoiceSection(AppLocalizations l10n) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Section header with NEW badge
          Padding(
            padding: const EdgeInsets.only(left: 4, bottom: 12),
            child: Row(
              children: [
                Text(
                  l10n.voiceAndShortcuts.toUpperCase(),
                  style: TextStyle(
                    fontSize: 12,
                    fontWeight: FontWeight.w600,
                    letterSpacing: 1.2,
                    color: context.appColors.textTertiary,
                  ),
                ),
                const SizedBox(width: 8),
                Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 8,
                    vertical: 2,
                  ),
                  decoration: BoxDecoration(
                    color: context.appColors.primary,
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Text(
                    l10n.newBadge,
                    style: const TextStyle(
                      color: Colors.white,
                      fontSize: 10,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ],
            ),
          ),
          Semantics(
            button: true,
            label: l10n.voiceInput,
            hint: l10n.voiceInputHint,
            child: Container(
              decoration: BoxDecoration(
                color: context.appColors.surface,
                borderRadius: BorderRadius.circular(16),
                border: Border.all(color: context.appColors.cardBorder),
              ),
              child: Material(
                color: Colors.transparent,
                child: InkWell(
                  onTap: () => _showVoiceHelpSheet(context, l10n),
                  borderRadius: BorderRadius.circular(16),
                  child: Padding(
                    padding: const EdgeInsets.symmetric(
                      horizontal: 16,
                      vertical: 14,
                    ),
                    child: Row(
                      children: [
                        Container(
                          width: 36,
                          height: 36,
                          decoration: BoxDecoration(
                            color: context.appColors.primary.withValues(
                              alpha: 0.15,
                            ),
                            borderRadius: BorderRadius.circular(8),
                          ),
                          child: Icon(
                            CupertinoIcons.mic_fill,
                            size: 20,
                            color: context.appColors.primary,
                          ),
                        ),
                        const SizedBox(width: 14),
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text(
                                l10n.voiceInput,
                                style: TextStyle(
                                  fontSize: 15,
                                  fontWeight: FontWeight.w500,
                                  color: context.appColors.textPrimary,
                                ),
                              ),
                              const SizedBox(height: 2),
                              Text(
                                l10n.voiceInputHint,
                                style: TextStyle(
                                  fontSize: 12,
                                  color: context.appColors.textSecondary,
                                ),
                              ),
                            ],
                          ),
                        ),
                        Icon(
                          CupertinoIcons.arrow_right,
                          size: 20,
                          color: context.appColors.textTertiary,
                        ),
                      ],
                    ),
                  ),
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  /// Show voice help bottom sheet
  void _showVoiceHelpSheet(BuildContext context, AppLocalizations l10n) {
    showModalBottomSheet(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      backgroundColor: context.appColors.surface,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      builder: (context) => Padding(
        padding: const EdgeInsets.all(24),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(
              CupertinoIcons.mic_fill,
              size: 48,
              color: context.appColors.primary,
            ),
            const SizedBox(height: 16),
            Text(
              l10n.howToUseVoice,
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.bold,
                color: context.appColors.textPrimary,
              ),
            ),
            const SizedBox(height: 20),

            // Method 1: Long-press FAB
            Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: context.appColors.cardBackground,
                borderRadius: BorderRadius.circular(16),
              ),
              child: Row(
                children: [
                  Container(
                    width: 40,
                    height: 40,
                    decoration: BoxDecoration(
                      color: context.appColors.primary.withValues(alpha: 0.15),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Icon(
                      CupertinoIcons.plus_circle_fill,
                      color: context.appColors.primary,
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          l10n.longPressFab,
                          style: TextStyle(
                            fontWeight: FontWeight.w600,
                            color: context.appColors.textPrimary,
                          ),
                        ),
                        Text(
                          l10n.longPressFabHint,
                          style: TextStyle(
                            fontSize: 12,
                            color: context.appColors.textSecondary,
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),

            const SizedBox(height: 12),

            // Method 2: Mic button
            Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: context.appColors.cardBackground,
                borderRadius: BorderRadius.circular(16),
              ),
              child: Row(
                children: [
                  Container(
                    width: 40,
                    height: 40,
                    decoration: BoxDecoration(
                      color: context.appColors.primary.withValues(alpha: 0.15),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Icon(
                      CupertinoIcons.mic_fill,
                      color: context.appColors.primary,
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          l10n.micButton,
                          style: TextStyle(
                            fontWeight: FontWeight.w600,
                            color: context.appColors.textPrimary,
                          ),
                        ),
                        Text(
                          l10n.micButtonHint,
                          style: TextStyle(
                            fontSize: 12,
                            color: context.appColors.textSecondary,
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),

            const SizedBox(height: 20),

            Text(
              l10n.exampleCommands,
              style: TextStyle(
                fontWeight: FontWeight.w600,
                color: context.appColors.textPrimary,
              ),
            ),
            const SizedBox(height: 8),
            Wrap(
              spacing: 8,
              runSpacing: 8,
              alignment: WrapAlignment.center,
              children: [
                _buildExampleChip(l10n.voiceExample1),
                _buildExampleChip(l10n.voiceExample2),
                _buildExampleChip(l10n.voiceExample3),
              ],
            ),

            const SizedBox(height: 20),

            SizedBox(
              width: double.infinity,
              child: Semantics(
                button: true,
                label: l10n.tryNow,
                hint: l10n.voiceInput,
                child: ElevatedButton.icon(
                  icon: const Icon(CupertinoIcons.mic_fill),
                  label: Text(l10n.tryNow),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: context.appColors.primary,
                    foregroundColor: Colors.white,
                    padding: const EdgeInsets.symmetric(vertical: 14),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(16),
                    ),
                  ),
                  onPressed: () {
                    Navigator.pop(context);
                    Navigator.push(
                      context,
                      MaterialPageRoute(
                        builder: (_) => const VoiceInputScreen(),
                      ),
                    );
                  },
                ),
              ),
            ),
            const SizedBox(height: 16),
          ],
        ),
      ),
    );
  }

  Widget _buildExampleChip(String text) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
      decoration: BoxDecoration(
        color: context.appColors.primary.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(24),
        border: Border.all(
          color: context.appColors.primary.withValues(alpha: 0.3),
        ),
      ),
      child: Text(
        text,
        style: TextStyle(
          fontSize: 13,
          color: context.appColors.primary,
          fontWeight: FontWeight.w500,
        ),
      ),
    );
  }

  /// Security section with PIN and biometric toggles
  Widget _buildSecuritySection(AppLocalizations l10n) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Section header
          Padding(
            padding: const EdgeInsets.only(left: 4, bottom: 12),
            child: Text(
              l10n.security.toUpperCase(),
              style: TextStyle(
                fontSize: 12,
                fontWeight: FontWeight.w600,
                letterSpacing: 1.2,
                color: context.appColors.textTertiary,
              ),
            ),
          ),
          Container(
            decoration: BoxDecoration(
              color: context.appColors.surface,
              borderRadius: BorderRadius.circular(16),
              border: Border.all(color: context.appColors.cardBorder),
            ),
            child: Column(
              children: [
                // PIN Lock Toggle
                FutureBuilder<bool>(
                  future: LockService.isLockEnabled(),
                  builder: (context, snapshot) {
                    final isEnabled = snapshot.data ?? false;
                    return _buildSecurityTile(
                      icon: CupertinoIcons.lock_fill,
                      title: l10n.pinLock,
                      subtitle: l10n.pinLockDescription,
                      value: isEnabled,
                      onChanged: (value) async {
                        if (value) {
                          // Navigate to PIN setup
                          final result = await Navigator.push<bool>(
                            context,
                            MaterialPageRoute(
                              builder: (_) => const PinSetupScreen(),
                            ),
                          );
                          if (result == true) {
                            setState(() {});
                          }
                        } else {
                          await LockService.removePin();
                          setState(() {});
                        }
                      },
                    );
                  },
                ),

                // Biometric Toggle (only if PIN is enabled and biometrics available)
                FutureBuilder<List<bool>>(
                  future: Future.wait([
                    LockService.isLockEnabled(),
                    LockService.canUseBiometrics(),
                  ]),
                  builder: (context, snapshot) {
                    final results = snapshot.data ?? [false, false];
                    final pinEnabled = results[0];
                    final canUseBio = results[1];

                    if (!pinEnabled || !canUseBio) {
                      return const SizedBox.shrink();
                    }

                    return Column(
                      children: [
                        _buildDivider(),
                        FutureBuilder<bool>(
                          future: LockService.isBiometricEnabled(),
                          builder: (context, bioSnapshot) {
                            return _buildSecurityTile(
                              icon: CupertinoIcons.hand_raised_fill,
                              title: l10n.biometricUnlock,
                              subtitle: l10n.biometricDescription,
                              value: bioSnapshot.data ?? false,
                              onChanged: (value) async {
                                if (value) {
                                  // Test biometric before enabling
                                  final success =
                                      await LockService.authenticateWithBiometrics(
                                        l10n.unlockWithBiometric,
                                      );
                                  if (success) {
                                    await LockService.setBiometricEnabled(true);
                                  }
                                } else {
                                  await LockService.setBiometricEnabled(false);
                                }
                                setState(() {});
                              },
                            );
                          },
                        ),
                      ],
                    );
                  },
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSecurityTile({
    required IconData icon,
    required String title,
    required String subtitle,
    required bool value,
    required ValueChanged<bool> onChanged,
  }) {
    final l10n = AppLocalizations.of(context);
    final toggleState = value
        ? l10n.accessibilityToggleOn
        : l10n.accessibilityToggleOff;

    return Semantics(
      toggled: value,
      label: '$title, $toggleState',
      hint: subtitle,
      child: Padding(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
        child: Row(
          children: [
            Container(
              width: 36,
              height: 36,
              decoration: BoxDecoration(
                color: context.appColors.primary.withValues(alpha: 0.15),
                borderRadius: BorderRadius.circular(8),
              ),
              child: Icon(icon, size: 20, color: context.appColors.primary),
            ),
            const SizedBox(width: 14),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    title,
                    style: TextStyle(
                      fontSize: 15,
                      fontWeight: FontWeight.w500,
                      color: context.appColors.textPrimary,
                    ),
                  ),
                  const SizedBox(height: 2),
                  Text(
                    subtitle,
                    style: TextStyle(
                      fontSize: 12,
                      color: context.appColors.textSecondary,
                    ),
                  ),
                ],
              ),
            ),
            Switch.adaptive(
              value: value,
              onChanged: onChanged,
              activeColor: context.appColors.primary,
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildListTile({
    required IconData icon,
    required Color iconColor,
    required String title,
    Color? titleColor,
    Widget? trailing,
    bool showArrow = true,
    VoidCallback? onTap,
    String? semanticHint,
  }) {
    return Semantics(
      button: onTap != null,
      label: title,
      hint: semanticHint,
      child: Material(
        color: Colors.transparent,
        child: InkWell(
          onTap: onTap,
          borderRadius: BorderRadius.circular(16),
          child: Padding(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
            child: Row(
              children: [
                Container(
                  width: 36,
                  height: 36,
                  decoration: BoxDecoration(
                    color: iconColor.withValues(alpha: 0.15),
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Icon(icon, size: 20, color: iconColor),
                ),
                const SizedBox(width: 14),
                Expanded(
                  child: Text(
                    title,
                    style: TextStyle(
                      fontSize: 15,
                      fontWeight: FontWeight.w500,
                      color: titleColor ?? context.appColors.textPrimary,
                    ),
                  ),
                ),
                if (trailing != null) trailing,
                if (showArrow && trailing == null)
                  Icon(
                    CupertinoIcons.chevron_right,
                    size: 18,
                    color: context.appColors.textTertiary,
                  ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildDivider() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 16),
      child: Divider(height: 1, color: context.appColors.cardBorder),
    );
  }

  Widget _buildCurrencyTile(AppLocalizations l10n) {
    final currencyProvider = context.watch<CurrencyProvider>();
    final currency = currencyProvider.currency;

    return _buildListTile(
      icon: CupertinoIcons.money_dollar_circle_fill,
      iconColor: AppColors.achievementStreak,
      title: l10n.settingsCurrency,
      trailing: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Text(currency.flag, style: const TextStyle(fontSize: 16)),
          const SizedBox(width: 6),
          Text(
            currency.code,
            style: TextStyle(
              color: context.appColors.textSecondary,
              fontSize: 14,
              fontWeight: FontWeight.w500,
            ),
          ),
          const SizedBox(width: 4),
          Icon(
            CupertinoIcons.chevron_right,
            size: 18,
            color: context.appColors.textTertiary,
          ),
        ],
      ),
      showArrow: false,
      onTap: () => showCurrencySelector(context),
    );
  }

  Widget _buildLanguageTile(AppLocalizations l10n) {
    final localeProvider = context.watch<LocaleProvider>();
    final currentLang = localeProvider.locale?.languageCode ?? 'tr';
    final langName = currentLang == 'tr' ? 'Türkçe' : 'English';

    return _buildListTile(
      icon: CupertinoIcons.globe,
      iconColor: AppColors.categoryEntertainment,
      title: l10n.settingsLanguage,
      trailing: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Text(
            langName,
            style: TextStyle(
              color: context.appColors.textSecondary,
              fontSize: 14,
              fontWeight: FontWeight.w500,
            ),
          ),
          const SizedBox(width: 4),
          Icon(
            CupertinoIcons.chevron_right,
            size: 18,
            color: context.appColors.textTertiary,
          ),
        ],
      ),
      showArrow: false,
      onTap: () => _showLanguageSelector(localeProvider, l10n),
    );
  }

  void _showLanguageSelector(
    LocaleProvider localeProvider,
    AppLocalizations l10n,
  ) {
    showModalBottomSheet(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      backgroundColor: context.appColors.surface,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      builder: (context) => SafeArea(
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Container(
              width: 40,
              height: 4,
              margin: const EdgeInsets.only(top: 12, bottom: 20),
              decoration: BoxDecoration(
                color: context.appColors.textTertiary.withValues(alpha: 0.3),
                borderRadius: BorderRadius.circular(2),
              ),
            ),
            ListTile(
              leading: const Text('🇹🇷', style: TextStyle(fontSize: 24)),
              title: const Text('Türkçe'),
              trailing: localeProvider.locale?.languageCode == 'tr'
                  ? Icon(
                      CupertinoIcons.checkmark_circle_fill,
                      color: context.appColors.primary,
                    )
                  : null,
              onTap: () {
                localeProvider.setLocale(const Locale('tr'));
                Navigator.pop(context);
                HapticFeedback.selectionClick();
              },
            ),
            ListTile(
              leading: const Text('🇺🇸', style: TextStyle(fontSize: 24)),
              title: const Text('English'),
              trailing: localeProvider.locale?.languageCode == 'en'
                  ? Icon(
                      CupertinoIcons.checkmark_circle_fill,
                      color: context.appColors.primary,
                    )
                  : null,
              onTap: () {
                localeProvider.setLocale(const Locale('en'));
                Navigator.pop(context);
                HapticFeedback.selectionClick();
              },
            ),
            const SizedBox(height: 20),
          ],
        ),
      ),
    );
  }

  Widget _buildThemeTile(AppLocalizations l10n) {
    final themeProvider = context.watch<ThemeProvider>();
    final currentTheme = themeProvider.themeMode;

    String themeName;
    IconData themeIcon;
    switch (currentTheme) {
      case AppThemeMode.dark:
        themeName = l10n.settingsThemeDark;
        themeIcon = CupertinoIcons.moon_fill;
        break;
      case AppThemeMode.light:
        themeName = l10n.settingsThemeLight;
        themeIcon = CupertinoIcons.sun_max_fill;
        break;
      case AppThemeMode.automatic:
        themeName = l10n.settingsThemeAutomatic;
        themeIcon = CupertinoIcons.clock_fill;
        break;
    }

    return _buildListTile(
      icon: themeIcon,
      iconColor: AppColors.categoryShopping,
      title: l10n.settingsTheme,
      trailing: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Text(
            themeName,
            style: TextStyle(
              color: context.appColors.textSecondary,
              fontSize: 14,
              fontWeight: FontWeight.w500,
            ),
          ),
          const SizedBox(width: 4),
          Icon(
            CupertinoIcons.chevron_right,
            size: 18,
            color: context.appColors.textTertiary,
          ),
        ],
      ),
      showArrow: false,
      onTap: () => _showThemeSelector(themeProvider, l10n),
    );
  }

  void _showThemeSelector(ThemeProvider themeProvider, AppLocalizations l10n) {
    showModalBottomSheet(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      backgroundColor: context.appColors.surface,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      builder: (context) => SafeArea(
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Container(
              width: 40,
              height: 4,
              margin: const EdgeInsets.only(top: 12, bottom: 20),
              decoration: BoxDecoration(
                color: context.appColors.textTertiary.withValues(alpha: 0.3),
                borderRadius: BorderRadius.circular(2),
              ),
            ),
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 8),
              child: Text(
                l10n.settingsTheme,
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textPrimary,
                ),
              ),
            ),
            ListTile(
              leading: Container(
                width: 40,
                height: 40,
                decoration: BoxDecoration(
                  color: AppColors.background,
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Icon(
                  CupertinoIcons.moon_fill,
                  color: context.appColors.textPrimary,
                  size: 20,
                ),
              ),
              title: Text(l10n.settingsThemeDark),
              trailing: themeProvider.themeMode == AppThemeMode.dark
                  ? Icon(
                      CupertinoIcons.checkmark_circle_fill,
                      color: context.appColors.primary,
                    )
                  : null,
              onTap: () {
                themeProvider.setThemeMode(AppThemeMode.dark);
                Navigator.pop(context);
                HapticFeedback.selectionClick();
              },
            ),
            ListTile(
              leading: Container(
                width: 40,
                height: 40,
                decoration: BoxDecoration(
                  color: AppColorsLight.background,
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Icon(
                  CupertinoIcons.sun_max_fill,
                  color: AppColorsLight.textPrimary,
                  size: 20,
                ),
              ),
              title: Text(l10n.settingsThemeLight),
              trailing: themeProvider.themeMode == AppThemeMode.light
                  ? Icon(
                      CupertinoIcons.checkmark_circle_fill,
                      color: context.appColors.primary,
                    )
                  : null,
              onTap: () {
                themeProvider.setThemeMode(AppThemeMode.light);
                Navigator.pop(context);
                HapticFeedback.selectionClick();
              },
            ),
            ListTile(
              leading: Container(
                width: 40,
                height: 40,
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    colors: [AppColors.background, AppColorsLight.background],
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                  ),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Icon(
                  CupertinoIcons.clock_fill,
                  color: context.appColors.textPrimary,
                  size: 20,
                ),
              ),
              title: Text(l10n.settingsThemeAutomatic),
              subtitle: Text(
                '07:00-19:00 ☀️ / 19:00-07:00 🌙',
                style: TextStyle(
                  fontSize: 12,
                  color: context.appColors.textTertiary,
                ),
              ),
              trailing: themeProvider.themeMode == AppThemeMode.automatic
                  ? Icon(
                      CupertinoIcons.checkmark_circle_fill,
                      color: context.appColors.primary,
                    )
                  : null,
              onTap: () {
                themeProvider.setThemeMode(AppThemeMode.automatic);
                Navigator.pop(context);
                HapticFeedback.selectionClick();
              },
            ),
            const SizedBox(height: 20),
          ],
        ),
      ),
    );
  }

  Widget _buildSimpleModeTile(AppLocalizations l10n) {
    return _buildListTile(
      icon: CupertinoIcons.leaf_arrow_circlepath,
      iconColor: AppColors.premiumGreen,
      title: l10n.simpleMode,
      trailing: Switch.adaptive(
        value: _simpleModeEnabled,
        onChanged: _toggleSimpleMode,
        activeTrackColor: context.appColors.primary,
      ),
      showArrow: false,
    );
  }

  Widget _buildRemindersTile(AppLocalizations l10n) {
    return _buildListTile(
      icon: CupertinoIcons.bell_fill,
      iconColor: AppColors.categoryEducation,
      title: l10n.notificationSettings,
      onTap: () {
        Navigator.push(
          context,
          MaterialPageRoute(builder: (_) => const NotificationSettingsScreen()),
        );
      },
    );
  }

  Widget _buildSoundEffectsTile(AppLocalizations l10n) {
    return _buildListTile(
      icon: CupertinoIcons.speaker_3_fill,
      iconColor: AppColors.categoryShopping,
      title: l10n.settingsSoundEffects,
      trailing: Switch.adaptive(
        value: _soundEnabled,
        onChanged: _toggleSound,
        activeTrackColor: context.appColors.primary,
      ),
      showArrow: false,
    );
  }

  Widget _buildProTile(AppLocalizations l10n, bool isPro) {
    return _buildListTile(
      icon: CupertinoIcons.bolt_fill,
      iconColor: isPro ? AppColors.medalGold : context.appColors.textTertiary,
      title: l10n.settingsVantagPro,
      trailing: isPro
          ? Container(
              padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  colors: [AppColors.medalGold, AppColors.incomeBonus],
                ),
                borderRadius: BorderRadius.circular(8),
              ),
              child: Text(
                'PRO',
                style: TextStyle(
                  fontSize: 11,
                  fontWeight: FontWeight.w700,
                  color: context.appColors.background,
                ),
              ),
            )
          : Icon(
              CupertinoIcons.chevron_right,
              size: 18,
              color: context.appColors.textTertiary,
            ),
      showArrow: false,
      onTap: () {
        if (isPro) {
          HapticFeedback.lightImpact();
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text(l10n.proMemberToast),
              behavior: SnackBarBehavior.floating,
              backgroundColor: context.appColors.success,
            ),
          );
        } else {
          Navigator.push(
            context,
            MaterialPageRoute(builder: (_) => const PaywallScreen()),
          );
        }
      },
    );
  }

  Widget _buildRestorePurchasesTile(AppLocalizations l10n) {
    return _buildListTile(
      icon: CupertinoIcons.arrow_counterclockwise,
      iconColor: AppColors.secondary,
      title: l10n.settingsRestorePurchases,
      trailing: _isRestoring
          ? const SizedBox(
              width: 20,
              height: 20,
              child: CircularProgressIndicator(strokeWidth: 2),
            )
          : null,
      showArrow: !_isRestoring,
      onTap: _isRestoring ? null : _restorePurchases,
    );
  }

  Widget _buildAchievementsTile(AppLocalizations l10n) {
    return _buildListTile(
      icon: CupertinoIcons.rosette,
      iconColor: AppColors.medalGold,
      title: l10n.badges,
      onTap: () {
        Navigator.push(
          context,
          MaterialPageRoute(builder: (_) => const AchievementsScreen()),
        );
      },
    );
  }

  Future<void> _restorePurchases() async {
    final l10n = AppLocalizations.of(context);
    setState(() => _isRestoring = true);

    try {
      final result = await PurchaseService().restorePurchases();
      final restored = result.isPro ?? false;

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(
              restored ? l10n.settingsRestoreSuccess : l10n.settingsRestoreNone,
            ),
            behavior: SnackBarBehavior.floating,
            backgroundColor: restored
                ? context.appColors.success
                : context.appColors.surfaceLight,
          ),
        );
      }
    } finally {
      if (mounted) {
        setState(() => _isRestoring = false);
      }
    }
  }

  bool _isLinkingGoogle = false;

  Widget _buildGoogleAccountTile(AppLocalizations l10n) {
    final authService = AuthService();
    final isAnonymous = authService.isAnonymous;
    final isLinkedWithGoogle = authService.isLinkedWithGoogle;
    final user = authService.currentUser;

    if (!isAnonymous && isLinkedWithGoogle) {
      // User is linked with Google - show account info
      return _buildListTile(
        icon: CupertinoIcons.globe,
        iconColor: AppColors.premiumGreen,
        title: l10n.googleLinked,
        trailing: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            if (user?.email != null)
              Flexible(
                child: Text(
                  user!.email!,
                  style: TextStyle(
                    color: context.appColors.textSecondary,
                    fontSize: 12,
                    fontWeight: FontWeight.w500,
                  ),
                  overflow: TextOverflow.ellipsis,
                ),
              ),
            const SizedBox(width: 8),
            Icon(
              CupertinoIcons.checkmark_circle_fill,
              size: 18,
              color: AppColors.premiumGreen,
            ),
          ],
        ),
        showArrow: false,
        semanticHint: user?.email,
      );
    }

    // User is anonymous - show link option
    return StatefulBuilder(
      builder: (context, setLocalState) {
        return _buildListTile(
          icon: CupertinoIcons.globe,
          iconColor: AppColors.categoryBills,
          title: l10n.googleNotLinked,
          trailing: _isLinkingGoogle
              ? SizedBox(
                  width: 20,
                  height: 20,
                  child: CircularProgressIndicator(
                    strokeWidth: 2,
                    color: context.appColors.primary,
                  ),
                )
              : Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Container(
                      padding: const EdgeInsets.symmetric(
                        horizontal: 8,
                        vertical: 4,
                      ),
                      decoration: BoxDecoration(
                        color: context.appColors.warning.withValues(
                          alpha: 0.15,
                        ),
                        borderRadius: BorderRadius.circular(6),
                      ),
                      child: Text(
                        l10n.dataNotBackedUp,
                        style: TextStyle(
                          fontSize: 10,
                          fontWeight: FontWeight.w600,
                          color: context.appColors.warning,
                        ),
                      ),
                    ),
                    const SizedBox(width: 4),
                    Icon(
                      CupertinoIcons.chevron_right,
                      size: 18,
                      color: context.appColors.textTertiary,
                    ),
                  ],
                ),
          showArrow: false,
          onTap: _isLinkingGoogle ? null : () => _linkGoogleAccount(l10n),
          semanticHint: l10n.dataNotBackedUp,
        );
      },
    );
  }

  Future<void> _linkGoogleAccount(AppLocalizations l10n) async {
    setState(() => _isLinkingGoogle = true);
    HapticFeedback.mediumImpact();

    try {
      final authService = AuthService();
      final result = await authService.signInWithGoogle();

      if (!mounted) return;

      if (result.success) {
        soundService.playSuccess();
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                const Icon(Icons.check_circle, color: Colors.white, size: 20),
                const SizedBox(width: 12),
                Expanded(
                  child: Text(
                    result.wasLinked
                        ? l10n.googleLinkedSuccess
                        : l10n.googleLinkedSuccess,
                  ),
                ),
              ],
            ),
            backgroundColor: context.appColors.success,
            behavior: SnackBarBehavior.floating,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(16),
            ),
          ),
        );
        // Refresh state to show linked status
        setState(() {});
      } else {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                Icon(Icons.error_outline, color: Colors.white, size: 20),
                const SizedBox(width: 12),
                Expanded(
                  child: Text(result.errorMessage ?? l10n.googleLinkFailed),
                ),
              ],
            ),
            backgroundColor: context.appColors.error,
            behavior: SnackBarBehavior.floating,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(16),
            ),
          ),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(l10n.googleLinkFailed),
            backgroundColor: context.appColors.error,
            behavior: SnackBarBehavior.floating,
          ),
        );
      }
    } finally {
      if (mounted) {
        setState(() => _isLinkingGoogle = false);
      }
    }
  }

  Widget _buildExportTile(AppLocalizations l10n, bool isPro) {
    return _buildListTile(
      icon: CupertinoIcons.doc_chart_fill,
      iconColor: AppColors.premiumGreen,
      title: l10n.settingsExportData,
      trailing: _isExporting
          ? const SizedBox(
              width: 20,
              height: 20,
              child: CircularProgressIndicator(strokeWidth: 2),
            )
          : !isPro
          ? Container(
              padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  colors: [
                    context.appColors.primary.withValues(alpha: 0.2),
                    context.appColors.secondary.withValues(alpha: 0.2),
                  ],
                ),
                borderRadius: BorderRadius.circular(6),
              ),
              child: Text(
                'PRO',
                style: TextStyle(
                  fontSize: 10,
                  fontWeight: FontWeight.w700,
                  color: context.appColors.primary,
                ),
              ),
            )
          : null,
      showArrow: !_isExporting && isPro,
      onTap: _isExporting ? null : () => _exportData(isPro),
    );
  }

  Future<void> _exportData(bool isPro) async {
    if (!isPro) {
      Navigator.push(
        context,
        MaterialPageRoute(builder: (_) => const PaywallScreen()),
      );
      return;
    }

    final l10n = AppLocalizations.of(context);
    setState(() => _isExporting = true);

    try {
      final exportService = ExportService();
      // Use Excel (xlsx) export - phones can open this directly
      final file = await exportService.exportToExcel(context);

      if (file != null) {
        // Log file path for debugging
        debugPrint('[Export] File created at: ${file.path}');

        if (!mounted) return;

        // Show dialog with two options: Share or Save to Downloads
        final action = await _showExportOptionsDialog(l10n);

        if (action == 'share') {
          await exportService.shareFile(file);
          if (mounted) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: Text(l10n.exportSuccess),
                backgroundColor: AppColors.premiumGreen,
                behavior: SnackBarBehavior.floating,
              ),
            );
          }
        } else if (action == 'save') {
          final result = await exportService.saveToDownloads(file);
          if (mounted) {
            if (result.file != null && result.path != null) {
              // Show success with path
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(
                  content: Column(
                    mainAxisSize: MainAxisSize.min,
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        l10n.exportSuccess,
                        style: const TextStyle(fontWeight: FontWeight.w600),
                      ),
                      const SizedBox(height: 4),
                      Text(
                        result.path!,
                        style: const TextStyle(fontSize: 12),
                        maxLines: 2,
                        overflow: TextOverflow.ellipsis,
                      ),
                    ],
                  ),
                  backgroundColor: AppColors.premiumGreen,
                  behavior: SnackBarBehavior.floating,
                  duration: const Duration(seconds: 5),
                ),
              );
            } else {
              // Show error and fallback to share
              debugPrint('[Export] Save failed: ${result.error}');
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(
                  content: Text(
                    '${l10n.exportError}: ${result.error ?? "Unknown"}',
                  ),
                  backgroundColor: AppColors.categoryBills,
                  behavior: SnackBarBehavior.floating,
                  action: SnackBarAction(
                    label: l10n.exportShareOption,
                    textColor: Colors.white,
                    onPressed: () => exportService.shareFile(file),
                  ),
                ),
              );
            }
          }
        }
      } else {
        throw Exception('File creation failed');
      }
    } catch (e) {
      debugPrint('[Export] Error: $e');
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(l10n.exportError),
            backgroundColor: AppColors.categoryBills,
            behavior: SnackBarBehavior.floating,
          ),
        );
      }
    } finally {
      if (mounted) {
        setState(() => _isExporting = false);
      }
    }
  }

  /// Show dialog with export options: Share or Save to Downloads
  Future<String?> _showExportOptionsDialog(AppLocalizations l10n) async {
    return showDialog<String>(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: context.appColors.cardBackground,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
        title: Row(
          children: [
            Icon(
              CupertinoIcons.arrow_down_doc_fill,
              color: context.appColors.primary,
              size: 24,
            ),
            const SizedBox(width: 8),
            Expanded(
              child: Text(
                l10n.exportComplete,
                style: TextStyle(
                  color: context.appColors.textPrimary,
                  fontSize: 18,
                  fontWeight: FontWeight.w600,
                ),
              ),
            ),
          ],
        ),
        content: Text(
          l10n.exportChooseAction,
          style: TextStyle(
            color: context.appColors.textSecondary,
            fontSize: 14,
          ),
        ),
        actions: [
          // Save to Downloads button
          TextButton.icon(
            onPressed: () => Navigator.pop(context, 'save'),
            icon: Icon(
              CupertinoIcons.folder_fill,
              size: 18,
              color: context.appColors.textSecondary,
            ),
            label: Text(
              l10n.exportSaveOption,
              style: TextStyle(color: context.appColors.textSecondary),
            ),
          ),
          // Share button
          ElevatedButton.icon(
            onPressed: () => Navigator.pop(context, 'share'),
            icon: const Icon(CupertinoIcons.share, size: 18),
            style: ElevatedButton.styleFrom(
              backgroundColor: context.appColors.primary,
              foregroundColor: Colors.white,
            ),
            label: Text(l10n.exportShareOption),
          ),
        ],
      ),
    );
  }

  Widget _buildImportStatementTile(AppLocalizations l10n, bool isPro) {
    return _buildListTile(
      icon: CupertinoIcons.arrow_up_doc_fill,
      iconColor: AppColors.categoryBills,
      title: l10n.settingsImportStatement,
      trailing: !isPro
          ? Container(
              padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  colors: [
                    context.appColors.primary.withValues(alpha: 0.2),
                    context.appColors.secondary.withValues(alpha: 0.2),
                  ],
                ),
                borderRadius: BorderRadius.circular(6),
              ),
              child: Text(
                'PRO',
                style: TextStyle(
                  fontSize: 10,
                  fontWeight: FontWeight.w700,
                  color: context.appColors.primary,
                ),
              ),
            )
          : null,
      showArrow: isPro,
      onTap: () => _openImportStatement(isPro),
      semanticHint: l10n.settingsImportStatementDesc,
    );
  }

  Future<void> _openImportStatement(bool isPro) async {
    if (!isPro) {
      Navigator.push(
        context,
        MaterialPageRoute(builder: (_) => const PaywallScreen()),
      );
      return;
    }

    Navigator.push(
      context,
      MaterialPageRoute(builder: (_) => const ImportStatementScreen()),
    );
  }

  Widget _buildPrivacyPolicyTile(AppLocalizations l10n) {
    final localeProvider = context.watch<LocaleProvider>();
    final langCode = localeProvider.locale?.languageCode ?? 'tr';
    final privacyUrl = langCode == 'tr'
        ? 'https://violencia19.github.io/Vantag/privacy-tr'
        : 'https://violencia19.github.io/Vantag/privacy-en';

    return _buildListTile(
      icon: CupertinoIcons.shield_fill,
      iconColor: AppColors.categoryEntertainment,
      title: l10n.settingsPrivacyPolicy,
      onTap: () => launchUrl(Uri.parse(privacyUrl)),
    );
  }

  Widget _buildTermsOfServiceTile(AppLocalizations l10n) {
    final localeProvider = context.watch<LocaleProvider>();
    final langCode = localeProvider.locale?.languageCode ?? 'tr';
    final termsUrl = langCode == 'tr'
        ? 'https://violencia19.github.io/Vantag/terms-tr'
        : 'https://violencia19.github.io/Vantag/terms-en';

    return _buildListTile(
      icon: CupertinoIcons.doc_text_fill,
      iconColor: AppColors.categoryShopping,
      title: l10n.termsOfService,
      onTap: () => launchUrl(Uri.parse(termsUrl)),
    );
  }

  Widget _buildDeleteAccountTile(AppLocalizations l10n) {
    return _buildListTile(
      icon: CupertinoIcons.person_badge_minus_fill,
      iconColor: context.appColors.error,
      title: l10n.deleteAccount,
      titleColor: context.appColors.error,
      showArrow: false,
      onTap: () => _deleteAccount(l10n),
    );
  }

  Future<void> _deleteAccount(AppLocalizations l10n) async {
    final confirmWord = l10n.deleteAccountConfirmWord;

    final confirmed = await showDialog<bool>(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      barrierDismissible: false,
      builder: (context) =>
          _DeleteAccountDialog(confirmWord: confirmWord, l10n: l10n),
    );

    if (confirmed == true && mounted) {
      HapticFeedback.heavyImpact();

      // Show loading indicator
      showDialog(
        context: context,
        barrierDismissible: false,
        barrierColor: Colors.black.withValues(alpha: 0.85),
        builder: (context) => Center(
          child: CircularProgressIndicator(color: context.appColors.primary),
        ),
      );

      try {
        final authService = AuthService();
        final result = await authService.deleteAccount();

        if (!result.success) {
          if (mounted) {
            Navigator.pop(context);
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: Text(result.errorMessage ?? l10n.deleteAccountError),
                backgroundColor: context.appColors.error,
              ),
            );
          }
          return;
        }

        final prefs = await SharedPreferences.getInstance();
        await prefs.clear();

        if (mounted) {
          final provider = context.read<FinanceProvider>();
          await provider.resetAllData();
        }

        if (!mounted) return;

        Navigator.pop(context);

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(l10n.deleteAccountSuccess),
            backgroundColor: context.appColors.success,
          ),
        );

        Navigator.pushAndRemoveUntil(
          context,
          MaterialPageRoute(builder: (context) => const OnboardingScreen()),
          (route) => false,
        );
      } catch (e) {
        if (mounted) {
          Navigator.pop(context);
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text(l10n.deleteAccountError),
              backgroundColor: context.appColors.error,
            ),
          );
        }
      }
    }
  }

  Widget _buildBackupTile(AppLocalizations l10n) {
    return _buildListTile(
      icon: CupertinoIcons.cloud_upload_fill,
      iconColor: AppColors.categoryHealth,
      title: l10n.backupData,
      onTap: _handleBackup,
    );
  }

  Widget _buildRestoreTile(AppLocalizations l10n) {
    return _buildListTile(
      icon: CupertinoIcons.cloud_download_fill,
      iconColor: AppColors.categoryEducation,
      title: l10n.restoreData,
      onTap: _handleRestore,
    );
  }

  Future<void> _handleBackup() async {
    final l10n = AppLocalizations.of(context);
    final backupService = BackupService();

    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text(l10n.backupCreating)),
    );

    final path = await backupService.exportBackup();
    if (!mounted) return;

    if (path != null) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text(l10n.backupSuccess)),
      );
    } else {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text(l10n.backupError)),
      );
    }
  }

  Future<void> _handleRestore() async {
    final l10n = AppLocalizations.of(context);
    final backupService = BackupService();

    final result = await backupService.importBackup();
    if (!mounted) return;

    if (result.success) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text(l10n.restoreSuccess(
          result.expensesRestored,
          result.pursuitsRestored,
          result.subscriptionsRestored,
        ))),
      );
      // Reload data
      await context.read<FinanceProvider>().refresh();
    } else {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text(result.error ?? l10n.restoreError)),
      );
    }
  }

  Widget _buildShareAppTile(AppLocalizations l10n) {
    return _buildListTile(
      icon: CupertinoIcons.share,
      iconColor: AppColors.categoryEntertainment,
      title: l10n.shareApp,
      onTap: _shareApp,
    );
  }

  Widget _buildRateAppTile(AppLocalizations l10n) {
    return _buildListTile(
      icon: CupertinoIcons.star_fill,
      iconColor: AppColors.gold,
      title: l10n.rateApp,
      onTap: _rateAppFromAbout,
    );
  }

  Widget _buildFeedbackTile(AppLocalizations l10n) {
    return _buildListTile(
      icon: CupertinoIcons.chat_bubble_text_fill,
      iconColor: AppColors.categoryTransport,
      title: l10n.sendFeedback,
      onTap: _sendFeedbackFromAbout,
    );
  }

  Future<void> _rateAppFromAbout() async {
    final url = Platform.isIOS
        ? 'https://apps.apple.com/app/id6740157696?action=write-review'
        : 'https://play.google.com/store/apps/details?id=com.vantag.app';

    await launchUrl(Uri.parse(url), mode: LaunchMode.externalApplication);
  }

  Future<void> _sendFeedbackFromAbout() async {
    final url = Uri(
      scheme: 'mailto',
      path: 'feedback@vantag.app',
      queryParameters: {'subject': 'Vantag App Feedback'},
    );

    await launchUrl(url);
  }

  Widget _buildVersionTile(AppLocalizations l10n) {
    return _buildListTile(
      icon: CupertinoIcons.info_circle_fill,
      iconColor: AppColors.categoryOther,
      title: l10n.settingsVersion,
      trailing: Text(
        '1.0.3+5',
        style: TextStyle(
          color: context.appColors.textSecondary,
          fontSize: 14,
          fontWeight: FontWeight.w500,
        ),
      ),
      showArrow: false,
    );
  }

  Widget _buildContactUsTile(AppLocalizations l10n) {
    return _buildListTile(
      icon: CupertinoIcons.envelope_fill,
      iconColor: AppColors.categoryBills,
      title: l10n.settingsContactUs,
      onTap: () => launchUrl(Uri.parse('mailto:support@vantag.app')),
    );
  }
}

/// Delete Account Confirmation Dialog
class _DeleteAccountDialog extends StatefulWidget {
  final String confirmWord;
  final AppLocalizations l10n;

  const _DeleteAccountDialog({required this.confirmWord, required this.l10n});

  @override
  State<_DeleteAccountDialog> createState() => _DeleteAccountDialogState();
}

class _DeleteAccountDialogState extends State<_DeleteAccountDialog> {
  final _textController = TextEditingController();
  bool _isConfirmed = false;

  @override
  void initState() {
    super.initState();
    _textController.addListener(_checkConfirmation);
  }

  @override
  void dispose() {
    _textController.dispose();
    super.dispose();
  }

  void _checkConfirmation() {
    final isConfirmed = _textController.text.trim() == widget.confirmWord;
    if (isConfirmed != _isConfirmed) {
      setState(() => _isConfirmed = isConfirmed);
    }
  }

  @override
  Widget build(BuildContext context) {
    final l10n = widget.l10n;

    return AlertDialog(
      backgroundColor: context.appColors.surface,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(24)),
      contentPadding: const EdgeInsets.fromLTRB(24, 24, 24, 16),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          Container(
            width: 64,
            height: 64,
            decoration: BoxDecoration(
              color: context.appColors.error.withValues(alpha: 0.15),
              borderRadius: BorderRadius.circular(16),
            ),
            child: Icon(
              CupertinoIcons.exclamationmark_triangle_fill,
              color: context.appColors.error,
              size: 32,
            ),
          ),
          const SizedBox(height: 20),
          Text(
            l10n.deleteAccountWarningTitle,
            style: TextStyle(
              fontSize: 20,
              fontWeight: FontWeight.w700,
              color: context.appColors.textPrimary,
            ),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 16),
          Text(
            l10n.deleteAccountWarningMessage,
            style: TextStyle(
              fontSize: 14,
              color: context.appColors.textSecondary,
              height: 1.5,
            ),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 24),
          TextField(
            controller: _textController,
            decoration: InputDecoration(
              hintText: l10n.deleteAccountConfirmPlaceholder,
              hintStyle: TextStyle(
                color: context.appColors.textTertiary,
                fontSize: 14,
              ),
              filled: true,
              fillColor: context.appColors.background,
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(16),
                borderSide: BorderSide(color: context.appColors.cardBorder),
              ),
              enabledBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(16),
                borderSide: BorderSide(color: context.appColors.cardBorder),
              ),
              focusedBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(16),
                borderSide: BorderSide(
                  color: context.appColors.error,
                  width: 2,
                ),
              ),
              contentPadding: const EdgeInsets.symmetric(
                horizontal: 16,
                vertical: 14,
              ),
            ),
            style: TextStyle(
              color: context.appColors.textPrimary,
              fontSize: 14,
            ),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 8),
          Text(
            '"${widget.confirmWord}"',
            style: TextStyle(
              fontSize: 12,
              color: context.appColors.textTertiary,
              fontStyle: FontStyle.italic,
            ),
          ),
          const SizedBox(height: 24),
          Row(
            children: [
              Expanded(
                child: TextButton(
                  onPressed: () => Navigator.pop(context, false),
                  style: TextButton.styleFrom(
                    padding: const EdgeInsets.symmetric(vertical: 14),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(16),
                    ),
                  ),
                  child: Text(
                    l10n.cancel,
                    style: TextStyle(
                      color: context.appColors.textSecondary,
                      fontSize: 14,
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                ),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: ElevatedButton(
                  onPressed: _isConfirmed
                      ? () => Navigator.pop(context, true)
                      : null,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: context.appColors.error,
                    foregroundColor: Colors.white,
                    disabledBackgroundColor: context.appColors.error.withValues(
                      alpha: 0.3,
                    ),
                    disabledForegroundColor: context.appColors.textPrimary
                        .withValues(alpha: 0.5),
                    padding: const EdgeInsets.symmetric(vertical: 14),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(16),
                    ),
                    elevation: 0,
                  ),
                  child: Text(
                    l10n.deleteAccountButton,
                    style: const TextStyle(
                      fontSize: 14,
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }
}


--- FILE: lib/screens/habit_calculator_screen.dart ---

import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../providers/currency_provider.dart';
import '../providers/finance_provider.dart';
import '../theme/theme.dart';
import '../utils/currency_utils.dart';
import '../utils/habit_calculator.dart';
import '../widgets/premium_share_card.dart';

/// Viral Habit Calculator
/// 3-step wizard to calculate how many work days user's habits cost
class HabitCalculatorScreen extends StatefulWidget {
  const HabitCalculatorScreen({super.key});

  @override
  State<HabitCalculatorScreen> createState() => _HabitCalculatorScreenState();
}

class _HabitCalculatorScreenState extends State<HabitCalculatorScreen> {
  final PageController _pageController = PageController();
  final TextEditingController _priceController = TextEditingController();
  final TextEditingController _incomeController = TextEditingController();

  // State
  HabitCategory? _selectedCategory;
  String _customCategoryName = '';
  IconData _customCategoryIcon = CupertinoIcons.sparkles;
  Color _customCategoryColor = AppColors.primary;
  double _price = 0;
  String? _selectedFrequency;
  double _monthlyIncome = 0;
  bool _dontWantToSay = false;
  HabitResult? _result;

  // Icon options for custom category
  static final List<IconData> _iconOptions = [
    CupertinoIcons.sparkles,
    CupertinoIcons.scope,
    CupertinoIcons.money_dollar_circle_fill,
    CupertinoIcons.gift_fill,
    CupertinoIcons.drop_fill,
    CupertinoIcons.flame_fill,
    CupertinoIcons.circle_grid_3x3_fill,
    CupertinoIcons.ticket_fill,
    CupertinoIcons.film_fill,
    CupertinoIcons.device_phone_portrait,
    CupertinoIcons.desktopcomputer,
    CupertinoIcons.headphones,
    CupertinoIcons.sportscourt_fill,
    CupertinoIcons.heart_fill,
    CupertinoIcons.paintbrush_fill,
    CupertinoIcons.bolt_fill,
  ];

  static final List<Color> _colorOptions = [
    AppColors.primary,
    AppColors.secondary,
    AppColors.categoryFood,
    AppColors.categoryEducation,
    AppColors.categoryHealth,
    AppColors.categoryShopping,
    AppColors.achievementMystery,
    AppColors.categoryEntertainment,
  ];

  bool _hasLoadedInitialIncome = false;

  @override
  void didChangeDependencies() {
    super.didChangeDependencies();
    // Load user's monthly income as default value (only once)
    if (!_hasLoadedInitialIncome) {
      _hasLoadedInitialIncome = true;
      final financeProvider = context.read<FinanceProvider>();
      final userIncome = financeProvider.userProfile?.monthlyIncome ?? 0;
      if (userIncome > 0) {
        _monthlyIncome = userIncome;
        _incomeController.text = formatTurkishCurrency(
          userIncome,
          decimalDigits: 0,
          showDecimals: false,
        );
      }
    }
  }

  @override
  void dispose() {
    _pageController.dispose();
    _priceController.dispose();
    _incomeController.dispose();
    super.dispose();
  }

  void _selectCategory(HabitCategory category) {
    HapticFeedback.lightImpact();
    setState(() {
      _selectedCategory = category;
    });
    _goToNextPage();
  }

  void _showCustomCategoryDialog() {
    HapticFeedback.lightImpact();
    String tempName = _customCategoryName;
    IconData tempIcon = _customCategoryIcon;
    Color tempColor = _customCategoryColor;

    showModalBottomSheet(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => StatefulBuilder(
        builder: (context, setModalState) => Container(
          padding: EdgeInsets.only(
            bottom: MediaQuery.of(context).viewInsets.bottom,
          ),
          decoration: BoxDecoration(
            color: context.appColors.background,
            borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
            border: Border.all(color: context.appColors.cardBorder),
          ),
          child: Padding(
            padding: const EdgeInsets.all(24),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // Handle
                Center(
                  child: Container(
                    width: 40,
                    height: 4,
                    decoration: BoxDecoration(
                      color: context.appColors.textTertiary,
                      borderRadius: BorderRadius.circular(2),
                    ),
                  ),
                ),
                const SizedBox(height: 24),
                Text(
                  AppLocalizations.of(context).createOwnCategory,
                  style: TextStyle(
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                    color: context.appColors.textPrimary,
                  ),
                ),
                const SizedBox(height: 24),
                // Icon picker
                Text(
                  AppLocalizations.of(context).selectEmoji,
                  style: TextStyle(
                    fontSize: 14,
                    color: context.appColors.textSecondary,
                  ),
                ),
                const SizedBox(height: 12),
                Wrap(
                  spacing: 8,
                  runSpacing: 8,
                  children: _iconOptions.map((iconData) {
                    final isSelected = iconData == tempIcon;
                    return GestureDetector(
                      onTap: () {
                        HapticFeedback.selectionClick();
                        setModalState(() => tempIcon = iconData);
                      },
                      child: Container(
                        width: 48,
                        height: 48,
                        decoration: BoxDecoration(
                          color: isSelected
                              ? tempColor.withValues(alpha: 0.2)
                              : context.appColors.surfaceLight,
                          borderRadius: BorderRadius.circular(16),
                          border: Border.all(
                            color: isSelected ? tempColor : Colors.transparent,
                            width: 2,
                          ),
                        ),
                        child: Center(
                          child: Icon(
                            iconData,
                            size: 24,
                            color: isSelected
                                ? tempColor
                                : context.appColors.textSecondary,
                          ),
                        ),
                      ),
                    );
                  }).toList(),
                ),
                const SizedBox(height: 16),
                // Color picker
                Wrap(
                  spacing: 8,
                  runSpacing: 8,
                  children: _colorOptions.map((color) {
                    final isSelected = color == tempColor;
                    return GestureDetector(
                      onTap: () {
                        HapticFeedback.selectionClick();
                        setModalState(() => tempColor = color);
                      },
                      child: Container(
                        width: 36,
                        height: 36,
                        decoration: BoxDecoration(
                          color: color,
                          shape: BoxShape.circle,
                          border: Border.all(
                            color: isSelected
                                ? context.appColors.textPrimary
                                : Colors.transparent,
                            width: 2,
                          ),
                          boxShadow: isSelected
                              ? [
                                  BoxShadow(
                                    color: color.withValues(alpha: 0.5),
                                    blurRadius: 8,
                                  ),
                                ]
                              : null,
                        ),
                        child: isSelected
                            ? Icon(
                                CupertinoIcons.checkmark,
                                color: context.appColors.textPrimary,
                                size: 18,
                              )
                            : null,
                      ),
                    );
                  }).toList(),
                ),
                const SizedBox(height: 24),
                // Name input
                TextField(
                  autofocus: true,
                  style: TextStyle(
                    color: context.appColors.textPrimary,
                    fontSize: 16,
                  ),
                  decoration: InputDecoration(
                    labelText: AppLocalizations.of(context).categoryName,
                    labelStyle: TextStyle(
                      color: context.appColors.textSecondary,
                    ),
                    hintText: AppLocalizations.of(context).categoryNameHint,
                    hintStyle: TextStyle(
                      color: context.appColors.textTertiary.withValues(
                        alpha: 0.5,
                      ),
                    ),
                    filled: true,
                    fillColor: context.appColors.surfaceLight,
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(16),
                      borderSide: BorderSide.none,
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(16),
                      borderSide: BorderSide(color: context.appColors.primary),
                    ),
                  ),
                  onChanged: (value) => tempName = value,
                ),
                const SizedBox(height: 24),
                // Save button
                SizedBox(
                  width: double.infinity,
                  child: ElevatedButton(
                    onPressed: tempName.trim().isNotEmpty
                        ? () {
                            HapticFeedback.mediumImpact();
                            setState(() {
                              _customCategoryName = tempName.trim();
                              _customCategoryIcon = tempIcon;
                              _customCategoryColor = tempColor;
                              _selectedCategory = HabitCategory(
                                'custom', // key
                                _customCategoryName, // display name
                                _customCategoryIcon,
                                _customCategoryColor,
                              );
                            });
                            Navigator.pop(context);
                            _goToNextPage();
                          }
                        : null,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: context.appColors.primary,
                      foregroundColor: context.appColors.textPrimary,
                      padding: const EdgeInsets.symmetric(vertical: 16),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(16),
                      ),
                      disabledBackgroundColor: context.appColors.surfaceLight,
                    ),
                    child: Text(
                      AppLocalizations.of(context).continueButton,
                      style: const TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                  ),
                ),
                const SizedBox(height: 16),
              ],
            ),
          ),
        ),
      ),
    );
  }

  void _goToNextPage() {
    _pageController.nextPage(
      duration: const Duration(milliseconds: 300),
      curve: Curves.easeOutCubic,
    );
  }

  void _goToPreviousPage() {
    HapticFeedback.lightImpact();
    _pageController.previousPage(
      duration: const Duration(milliseconds: 300),
      curve: Curves.easeOutCubic,
    );
  }

  void _calculate() {
    if (!_isValid) return;

    HapticFeedback.mediumImpact();

    final income = _dontWantToSay ? 40000.0 : _monthlyIncome;
    final result = HabitCalculator.calculate(
      price: _price,
      frequency: _selectedFrequency!,
      monthlyIncome: income,
    );

    setState(() {
      _result = result;
    });

    _goToNextPage();
  }

  void _resetAndRestart() {
    HapticFeedback.lightImpact();
    setState(() {
      _selectedCategory = null;
      _price = 0;
      _priceController.clear();
      _selectedFrequency = null;
      _monthlyIncome = 0;
      _incomeController.clear();
      _dontWantToSay = false;
      _result = null;
    });
    _pageController.jumpToPage(0);
  }

  bool get _isValid {
    return _selectedCategory != null &&
        _price > 0 &&
        _selectedFrequency != null &&
        (_monthlyIncome > 0 || _dontWantToSay);
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: context.appColors.background,
      body: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              context.appColors.gradientStart,
              context.appColors.gradientMid,
              context.appColors.gradientEnd,
            ],
          ),
        ),
        child: SafeArea(
          child: PageView(
            controller: _pageController,
            physics: const NeverScrollableScrollPhysics(),
            children: [
              _buildStep1CategorySelect(),
              _buildStep2Details(),
              _buildStep3Result(),
            ],
          ),
        ),
      ),
    );
  }

  // ═══════════════════════════════════════════════════════════════
  // STEP 1 - SELECT CATEGORY
  // ═══════════════════════════════════════════════════════════════
  Widget _buildStep1CategorySelect() {
    final l10n = AppLocalizations.of(context);
    return Column(
      children: [
        // Header
        Padding(
          padding: const EdgeInsets.all(20),
          child: Row(
            children: [
              GestureDetector(
                onTap: () => Navigator.pop(context),
                child: Container(
                  width: 40,
                  height: 40,
                  decoration: BoxDecoration(
                    color: context.appColors.surfaceLight,
                    borderRadius: BorderRadius.circular(16),
                  ),
                  child: Icon(
                    CupertinoIcons.xmark,
                    color: context.appColors.textSecondary,
                    size: 20,
                  ),
                ),
              ),
            ],
          ),
        ),
        // Titles
        Padding(
          padding: const EdgeInsets.symmetric(horizontal: 24),
          child: Column(
            children: [
              Text(
                l10n.howManyDaysForHabit,
                style: TextStyle(
                  fontSize: 28,
                  fontWeight: FontWeight.bold,
                  color: context.appColors.textPrimary,
                ),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 8),
              Text(
                l10n.selectHabitShock,
                style: TextStyle(
                  fontSize: 16,
                  color: context.appColors.textSecondary,
                ),
                textAlign: TextAlign.center,
              ),
            ],
          ),
        ),
        const SizedBox(height: 32),
        // Grid
        Expanded(
          child: Padding(
            padding: const EdgeInsets.symmetric(horizontal: 24),
            child: GridView.builder(
              gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                crossAxisCount: 2,
                crossAxisSpacing: 16,
                mainAxisSpacing: 16,
                childAspectRatio: 1.1,
              ),
              itemCount: getLocalizedHabitCategories(l10n).length,
              itemBuilder: (context, index) {
                final category = getLocalizedHabitCategories(l10n)[index];
                return _buildCategoryCard(category);
              },
            ),
          ),
        ),
        // Custom category button
        Padding(
          padding: const EdgeInsets.all(24),
          child: TextButton.icon(
            onPressed: _showCustomCategoryDialog,
            icon: Icon(CupertinoIcons.pencil, size: 18),
            label: Text(l10n.addMyOwnCategory),
            style: TextButton.styleFrom(
              foregroundColor: context.appColors.textSecondary,
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildCategoryCard(HabitCategory category) {
    return GestureDetector(
      onTap: () => _selectCategory(category),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(24),
        child: BackdropFilter(
          filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
          child: Container(
            decoration: BoxDecoration(
              color: context.appColors.surface,
              borderRadius: BorderRadius.circular(24),
              border: Border.all(color: context.appColors.cardBorder),
            ),
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Container(
                  width: 72,
                  height: 72,
                  decoration: BoxDecoration(
                    color: category.color.withValues(alpha: 0.15),
                    shape: BoxShape.circle,
                  ),
                  child: Icon(category.icon, size: 40, color: category.color),
                ),
                const SizedBox(height: 12),
                Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 8),
                  child: Text(
                    category.name,
                    style: TextStyle(
                      fontSize: 16,
                      fontWeight: FontWeight.w600,
                      color: context.appColors.textPrimary,
                    ),
                    textAlign: TextAlign.center,
                    maxLines: 2,
                    overflow: TextOverflow.ellipsis,
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  // ═══════════════════════════════════════════════════════════════
  // STEP 2 - DETAILS
  // ═══════════════════════════════════════════════════════════════
  Widget _buildStep2Details() {
    final l10n = AppLocalizations.of(context);
    final currencyProvider = context.watch<CurrencyProvider>();
    return Column(
      children: [
        // Header with back button
        Padding(
          padding: const EdgeInsets.all(20),
          child: Row(
            children: [
              GestureDetector(
                onTap: _goToPreviousPage,
                child: Container(
                  width: 40,
                  height: 40,
                  decoration: BoxDecoration(
                    color: context.appColors.surfaceLight,
                    borderRadius: BorderRadius.circular(16),
                  ),
                  child: Icon(
                    CupertinoIcons.chevron_left,
                    color: context.appColors.textSecondary,
                    size: 20,
                  ),
                ),
              ),
            ],
          ),
        ),
        // Content
        Expanded(
          child: SingleChildScrollView(
            padding: const EdgeInsets.symmetric(horizontal: 24),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // Selected category display
                Center(
                  child: Column(
                    children: [
                      Container(
                        width: 80,
                        height: 80,
                        decoration: BoxDecoration(
                          color:
                              (_selectedCategory?.color ??
                                      context.appColors.primary)
                                  .withValues(alpha: 0.15),
                          shape: BoxShape.circle,
                        ),
                        child: Icon(
                          _selectedCategory?.icon ?? CupertinoIcons.sparkles,
                          size: 44,
                          color:
                              _selectedCategory?.color ??
                              context.appColors.primary,
                        ),
                      ),
                      const SizedBox(height: 8),
                      Text(
                        _selectedCategory?.name ?? '',
                        style: TextStyle(
                          fontSize: 24,
                          fontWeight: FontWeight.bold,
                          color: context.appColors.textPrimary,
                        ),
                      ),
                    ],
                  ),
                ),
                const SizedBox(height: 32),

                // Price input
                _buildSectionTitle(l10n.howMuchPerTime),
                const SizedBox(height: 12),
                Row(
                  children: [
                    // Slider
                    Expanded(
                      child: SliderTheme(
                        data: SliderTheme.of(context).copyWith(
                          activeTrackColor: context.appColors.primary,
                          inactiveTrackColor: context.appColors.surfaceLight,
                          thumbColor: context.appColors.primary,
                          overlayColor: context.appColors.primary.withValues(
                            alpha: 0.2,
                          ),
                          trackHeight: 6,
                        ),
                        child: Slider(
                          value: _price.clamp(20, 1000),
                          min: 20,
                          max: 1000,
                          divisions: 98,
                          onChanged: (value) {
                            setState(() {
                              _price = value;
                              _priceController.text = value.round().toString();
                            });
                          },
                        ),
                      ),
                    ),
                    const SizedBox(width: 12),
                    // Input box
                    SizedBox(
                      width: 80,
                      child: TextField(
                        controller: _priceController,
                        keyboardType: TextInputType.number,
                        textAlign: TextAlign.center,
                        style: TextStyle(
                          color: context.appColors.textPrimary,
                          fontSize: 16,
                          fontWeight: FontWeight.w600,
                        ),
                        decoration: InputDecoration(
                          filled: true,
                          fillColor: context.appColors.surfaceLight,
                          contentPadding: const EdgeInsets.symmetric(
                            horizontal: 12,
                            vertical: 12,
                          ),
                          border: OutlineInputBorder(
                            borderRadius: BorderRadius.circular(16),
                            borderSide: BorderSide.none,
                          ),
                          focusedBorder: OutlineInputBorder(
                            borderRadius: BorderRadius.circular(16),
                            borderSide: BorderSide(
                              color: context.appColors.primary,
                            ),
                          ),
                        ),
                        onChanged: (value) {
                          final parsed = double.tryParse(value);
                          if (parsed != null) {
                            setState(() {
                              _price = parsed;
                            });
                          }
                        },
                      ),
                    ),
                    const SizedBox(width: 8),
                    Text(
                      currencyProvider.code,
                      style: TextStyle(
                        color: context.appColors.textSecondary,
                        fontSize: 16,
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 32),

                // Frequency
                _buildSectionTitle(l10n.howOften),
                const SizedBox(height: 12),
                SingleChildScrollView(
                  scrollDirection: Axis.horizontal,
                  child: Row(
                    children: HabitCalculator.frequencyKeys.map((freqKey) {
                      final isSelected = _selectedFrequency == freqKey;
                      return Padding(
                        padding: const EdgeInsets.only(right: 8),
                        child: ChoiceChip(
                          label: Text(
                            HabitCalculator.getLocalizedFrequency(
                              freqKey,
                              l10n,
                            ),
                          ),
                          selected: isSelected,
                          onSelected: (selected) {
                            HapticFeedback.selectionClick();
                            setState(() {
                              _selectedFrequency = selected ? freqKey : null;
                            });
                          },
                          selectedColor: context.appColors.primary,
                          backgroundColor: context.appColors.surfaceLight,
                          labelStyle: TextStyle(
                            color: isSelected
                                ? context.appColors.textPrimary
                                : context.appColors.textSecondary,
                            fontWeight: isSelected
                                ? FontWeight.w600
                                : FontWeight.normal,
                          ),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(24),
                            side: BorderSide(
                              color: isSelected
                                  ? context.appColors.primary
                                  : Colors.transparent,
                            ),
                          ),
                          showCheckmark: false,
                        ),
                      );
                    }).toList(),
                  ),
                ),
                const SizedBox(height: 32),

                // Income
                _buildSectionTitle(l10n.whatIsYourIncome),
                const SizedBox(height: 12),
                Row(
                  children: [
                    Expanded(
                      child: TextField(
                        controller: _incomeController,
                        keyboardType: const TextInputType.numberWithOptions(
                          decimal: true,
                        ),
                        enabled: !_dontWantToSay,
                        inputFormatters: [
                          PremiumCurrencyFormatter(
                            allowDecimals: false,
                            maxIntegerDigits: 12,
                          ),
                        ],
                        style: TextStyle(
                          color: _dontWantToSay
                              ? context.appColors.textTertiary
                              : context.appColors.textPrimary,
                          fontSize: 16,
                        ),
                        decoration: InputDecoration(
                          hintText: l10n.exampleAmount,
                          hintStyle: TextStyle(
                            color: context.appColors.textTertiary.withValues(
                              alpha: 0.5,
                            ),
                          ),
                          filled: true,
                          fillColor: _dontWantToSay
                              ? context.appColors.surface
                              : context.appColors.surfaceLight,
                          contentPadding: const EdgeInsets.symmetric(
                            horizontal: 16,
                            vertical: 16,
                          ),
                          border: OutlineInputBorder(
                            borderRadius: BorderRadius.circular(16),
                            borderSide: BorderSide.none,
                          ),
                          focusedBorder: OutlineInputBorder(
                            borderRadius: BorderRadius.circular(16),
                            borderSide: BorderSide(
                              color: context.appColors.primary,
                            ),
                          ),
                        ),
                        onChanged: (value) {
                          final parsed = parseAmount(value);
                          setState(() {
                            _monthlyIncome = parsed ?? 0;
                          });
                        },
                      ),
                    ),
                    const SizedBox(width: 8),
                    Text(
                      currencyProvider.code,
                      style: TextStyle(
                        color: context.appColors.textSecondary,
                        fontSize: 16,
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 12),
                Row(
                  children: [
                    SizedBox(
                      width: 24,
                      height: 24,
                      child: Checkbox(
                        value: _dontWantToSay,
                        onChanged: (value) {
                          HapticFeedback.selectionClick();
                          setState(() {
                            _dontWantToSay = value ?? false;
                            if (_dontWantToSay) {
                              _incomeController.text = '40.000';
                              _monthlyIncome = 40000;
                            } else {
                              _incomeController.clear();
                              _monthlyIncome = 0;
                            }
                          });
                        },
                        activeColor: context.appColors.primary,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(4),
                        ),
                      ),
                    ),
                    const SizedBox(width: 8),
                    GestureDetector(
                      onTap: () {
                        HapticFeedback.selectionClick();
                        setState(() {
                          _dontWantToSay = !_dontWantToSay;
                          if (_dontWantToSay) {
                            _incomeController.text = '40.000';
                            _monthlyIncome = 40000;
                          } else {
                            _incomeController.clear();
                            _monthlyIncome = 0;
                          }
                        });
                      },
                      child: Text(
                        l10n.dontWantToSay,
                        style: TextStyle(
                          color: context.appColors.textSecondary,
                          fontSize: 14,
                        ),
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 40),

                // Calculate button
                SizedBox(
                  width: double.infinity,
                  child: Container(
                    decoration: BoxDecoration(
                      gradient: _isValid
                          ? LinearGradient(
                              colors: [AppColors.primary, AppColors.secondary],
                            )
                          : null,
                      color: _isValid ? null : context.appColors.surfaceLight,
                      borderRadius: BorderRadius.circular(16),
                    ),
                    child: ElevatedButton(
                      onPressed: _isValid ? _calculate : null,
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.transparent,
                        foregroundColor: context.appColors.textPrimary,
                        shadowColor: Colors.transparent,
                        padding: const EdgeInsets.symmetric(vertical: 18),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(16),
                        ),
                        disabledBackgroundColor: Colors.transparent,
                        disabledForegroundColor: context.appColors.textTertiary,
                      ),
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          Text(
                            l10n.calculate,
                            style: TextStyle(
                              fontSize: 18,
                              fontWeight: FontWeight.w600,
                              color: _isValid
                                  ? Colors.white
                                  : context.appColors.textTertiary,
                            ),
                          ),
                          const SizedBox(width: 8),
                          Icon(
                            CupertinoIcons.arrow_right,
                            size: 20,
                            color: _isValid
                                ? context.appColors.textPrimary
                                : context.appColors.textTertiary,
                          ),
                        ],
                      ),
                    ),
                  ),
                ),
                const SizedBox(height: 40),
              ],
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildSectionTitle(String title) {
    return Text(
      title,
      style: TextStyle(
        fontSize: 16,
        fontWeight: FontWeight.w600,
        color: context.appColors.textPrimary,
      ),
    );
  }

  // ═══════════════════════════════════════════════════════════════
  // STEP 3 - RESULT
  // ═══════════════════════════════════════════════════════════════
  Widget _buildStep3Result() {
    if (_result == null) {
      return const SizedBox();
    }
    final l10n = AppLocalizations.of(context);

    return TweenAnimationBuilder<double>(
      tween: Tween(begin: 0.0, end: 1.0),
      duration: const Duration(milliseconds: 300),
      curve: Curves.easeOutCubic,
      builder: (context, animValue, child) {
        return Opacity(
          opacity: animValue,
          child: Transform.scale(scale: 0.9 + (0.1 * animValue), child: child),
        );
      },
      child: SingleChildScrollView(
        padding: const EdgeInsets.all(24),
        child: Column(
          children: [
            const SizedBox(height: 40),
            // Icon
            Container(
              width: 120,
              height: 120,
              decoration: BoxDecoration(
                color: (_selectedCategory?.color ?? context.appColors.primary)
                    .withValues(alpha: 0.15),
                shape: BoxShape.circle,
              ),
              child: Icon(
                _selectedCategory?.icon ?? CupertinoIcons.sparkles,
                size: 64,
                color: _selectedCategory?.color ?? context.appColors.primary,
              ),
            ),
            const SizedBox(height: 24),
            // Animated counter
            TweenAnimationBuilder<int>(
              tween: IntTween(begin: 0, end: _result!.yearlyDays),
              duration: const Duration(milliseconds: 1500),
              curve: Curves.easeOutCubic,
              builder: (context, value, child) {
                return FittedBox(
                  fit: BoxFit.scaleDown,
                  child: Text(
                    l10n.resultDays(value.toString()),
                    style: TextStyle(
                      fontSize: 64,
                      fontWeight: FontWeight.bold,
                      color: context.appColors.textPrimary,
                    ),
                  ),
                );
              },
            ),
            const SizedBox(height: 12),
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 16),
              child: Text(
                l10n.yearlyHabitCost(_selectedCategory?.name ?? ''),
                style: TextStyle(
                  fontSize: 18,
                  color: context.appColors.textSecondary,
                ),
                textAlign: TextAlign.center,
                maxLines: 3,
                overflow: TextOverflow.ellipsis,
              ),
            ),
            const SizedBox(height: 32),
            // Divider
            Container(
              height: 1,
              color: context.appColors.textPrimary.withValues(alpha: 0.2),
            ),
            const SizedBox(height: 24),
            // Detail row
            Text(
              l10n.monthlyYearlyCost(
                l10n.habitMonthlyDetail(
                  _result!.monthlyDays,
                  _result!.monthlyExtraHours,
                ),
                _formatCurrency(_result!.yearlyAmount),
              ),
              style: TextStyle(
                fontSize: 14,
                color: context.appColors.textSecondary,
              ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 48),
            // Buttons
            _buildGradientButton(
              icon: CupertinoIcons.share_solid,
              text: l10n.shareOnStory,
              onTap: _shareResult,
            ),
            const SizedBox(height: 12),
            OutlinedButton.icon(
              onPressed: _resetAndRestart,
              icon: Icon(CupertinoIcons.arrow_counterclockwise, size: 20),
              label: Text(l10n.tryAnotherHabit),
              style: OutlinedButton.styleFrom(
                foregroundColor: context.appColors.textPrimary,
                side: BorderSide(color: context.appColors.textTertiary),
                padding: const EdgeInsets.symmetric(
                  horizontal: 24,
                  vertical: 16,
                ),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(16),
                ),
                minimumSize: const Size(double.infinity, 50),
              ),
            ),
            const SizedBox(height: 12),
            TextButton.icon(
              onPressed: () => Navigator.pop(context),
              icon: Icon(CupertinoIcons.list_bullet, size: 20),
              label: Text(l10n.trackAllExpenses),
              style: TextButton.styleFrom(
                foregroundColor: context.appColors.textSecondary,
              ),
            ),
            const SizedBox(height: 40),
          ],
        ),
      ),
    );
  }

  Widget _buildGradientButton({
    required IconData icon,
    required String text,
    required VoidCallback onTap,
  }) {
    return GestureDetector(
      onTap: () {
        HapticFeedback.mediumImpact();
        onTap();
      },
      child: Container(
        width: double.infinity,
        padding: const EdgeInsets.symmetric(vertical: 18),
        decoration: BoxDecoration(
          gradient: LinearGradient(
            colors: [AppColors.primary, AppColors.secondary],
          ),
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            BoxShadow(
              color: AppColors.primary.withValues(alpha: 0.3),
              blurRadius: 20,
              offset: const Offset(0, 8),
            ),
          ],
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(icon, size: 22, color: context.appColors.textPrimary),
            const SizedBox(width: 8),
            Text(
              text,
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.w600,
                color: context.appColors.textPrimary,
              ),
            ),
          ],
        ),
      ),
    );
  }

  void _shareResult() {
    HapticFeedback.mediumImpact();
    final l10n = AppLocalizations.of(context);
    final currencyProvider = context.read<CurrencyProvider>();
    showHabitShareCardPreview(
      context,
      icon: _selectedCategory!.icon,
      iconColor: _selectedCategory!.color,
      categoryName: _selectedCategory!.name,
      yearlyDays: _result!.yearlyDays,
      yearlyAmount: _result!.yearlyAmount,
      frequency: HabitCalculator.getLocalizedFrequency(
        _selectedFrequency!,
        l10n,
      ),
      monthlyDays: _result!.monthlyDays,
      monthlyExtraHours: _result!.monthlyExtraHours,
      monthlyAmount: _result!.monthlyAmount,
      currencySymbol: currencyProvider.symbol,
    );
  }

  String _formatCurrency(double amount) {
    final currencyProvider = context.read<CurrencyProvider>();
    final symbol = currencyProvider.symbol;
    if (amount >= 1000000) {
      return '$symbol${(amount / 1000000).toStringAsFixed(1)}M';
    } else if (amount >= 1000) {
      return '$symbol${(amount / 1000).toStringAsFixed(0)}K';
    }
    return '$symbol${amount.toStringAsFixed(0)}';
  }
}


--- FILE: lib/screens/voice_input_screen.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:speech_to_text/speech_to_text.dart';
import 'package:permission_handler/permission_handler.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';
import '../providers/providers.dart';
import '../services/services.dart';
import '../screens/paywall_screen.dart';
import '../theme/theme.dart';
import '../theme/app_theme.dart';

/// Full-screen voice input experience
/// Opens with microphone auto-started for seamless voice entry
class VoiceInputScreen extends StatefulWidget {
  /// If true, auto-start listening when screen opens
  final bool autoStart;

  /// If true, return parsed result instead of saving directly
  final bool returnResult;

  const VoiceInputScreen({
    super.key,
    this.autoStart = true,
    this.returnResult = false,
  });

  @override
  State<VoiceInputScreen> createState() => _VoiceInputScreenState();
}

class _VoiceInputScreenState extends State<VoiceInputScreen>
    with SingleTickerProviderStateMixin {
  final SpeechToText _speech = SpeechToText();
  final VoiceParserService _parser = VoiceParserService();

  bool _isInitialized = false;
  bool _isListening = false;
  bool _isProcessing = false;
  String _recognizedText = '';
  String _statusText = '';
  double _soundLevel = 0;

  late AnimationController _pulseController;
  late Animation<double> _pulseAnimation;

  @override
  void initState() {
    super.initState();

    _pulseController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 1200),
    );

    _pulseAnimation = Tween<double>(begin: 1.0, end: 1.25).animate(
      CurvedAnimation(parent: _pulseController, curve: Curves.easeInOut),
    );

    WidgetsBinding.instance.addPostFrameCallback((_) {
      // Check if coming from deep link
      final deepLink = DeepLinkService();
      if (deepLink.shouldAutoStartVoice) {
        deepLink.consumeAutoStartFlag();
      }

      // Auto-start if requested
      if (widget.autoStart) {
        _startListening();
      }
    });
  }

  @override
  void dispose() {
    _pulseController.dispose();
    _speech.stop();
    super.dispose();
  }

  Future<void> _initSpeech() async {
    if (_isInitialized) return;

    try {
      _isInitialized = await _speech.initialize(
        onStatus: (status) {
          // Only stop animation when done - processing happens in onResult with finalResult
          if (status == 'done' || status == 'notListening') {
            if (!_isProcessing) {
              _stopListening();
            }
          }
        },
        onError: (error) {
          debugPrint('[Voice] Error: ${error.errorMsg}');
          if (mounted) {
            setState(() {
              _statusText = _getErrorMessage(error.errorMsg);
              _isListening = false;
            });
            _pulseController.stop();
          }
        },
      );
    } catch (e) {
      debugPrint('[Voice] Init error: $e');
      if (mounted) {
        final l10n = AppLocalizations.of(context);
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(l10n.voiceNotAvailable),
            backgroundColor: context.appColors.error,
            behavior: SnackBarBehavior.floating,
          ),
        );
      }
    }
  }

  String _getErrorMessage(String error) {
    if (!mounted) return '';
    final l10n = AppLocalizations.of(context);
    if (error.contains('network')) {
      return l10n.networkRequired;
    } else if (error.contains('permission')) {
      return l10n.microphonePermissionRequired;
    }
    return l10n.errorTryAgain;
  }

  Future<void> _startListening() async {
    // Check voice input limit first
    final limitCheck = await _checkVoiceInputLimit();
    if (!limitCheck) return;

    // Check microphone permission
    final status = await Permission.microphone.request();
    if (status != PermissionStatus.granted) {
      _showPermissionDenied();
      return;
    }

    await _initSpeech();

    if (!_isInitialized) {
      if (mounted) {
        final l10n = AppLocalizations.of(context);
        setState(() => _statusText = l10n.voiceNotAvailable);
      }
      return;
    }

    if (mounted) {
      final l10n = AppLocalizations.of(context);
      setState(() {
        _isListening = true;
        _statusText = l10n.listening;
        _recognizedText = '';
      });
    }

    _pulseController.repeat(reverse: true);

    // Determine locale
    if (!mounted) return;
    final locale = Localizations.localeOf(context);
    final localeId = locale.languageCode == 'tr' ? 'tr_TR' : 'en_US';

    await _speech.listen(
      onResult: (result) {
        if (mounted) {
          setState(() {
            _recognizedText = result.recognizedWords;
          });

          // Process only when we get final result
          if (result.finalResult &&
              _recognizedText.isNotEmpty &&
              !_isProcessing) {
            _processVoiceInput();
          }
        }
      },
      onSoundLevelChange: (level) {
        if (mounted) {
          setState(() {
            _soundLevel = level.clamp(0, 10) / 10;
          });
        }
      },
      localeId: localeId,
      listenFor: const Duration(seconds: 15),
      pauseFor: const Duration(seconds: 3),
      listenOptions: SpeechListenOptions(
        partialResults: true,
        cancelOnError: false,
        listenMode: ListenMode.confirmation,
      ),
    );
  }

  void _stopListening() {
    _speech.stop();
    if (mounted) {
      setState(() {
        _isListening = false;
      });
    }
    _pulseController.stop();
    _pulseController.reset();
  }

  Future<void> _processVoiceInput() async {
    if (_recognizedText.isEmpty) return;

    _stopListening();

    if (mounted) {
      final l10n = AppLocalizations.of(context);
      setState(() {
        _isProcessing = true;
        _statusText = l10n.understanding;
      });
    }

    try {
      final result = await _parser.parse(_recognizedText);

      if (!mounted) return;

      setState(() => _isProcessing = false);

      if (result.isValid) {
        // Always show decision dialog for valid results
        _showDecisionDialog(result);
      } else {
        _showRetryOption();
      }
    } catch (e) {
      debugPrint('[Voice] Parse error: $e');
      if (mounted) {
        final l10n = AppLocalizations.of(context);
        setState(() {
          _isProcessing = false;
          _statusText = l10n.couldNotUnderstandTryAgain;
        });
      }
    }
  }

  /// Show decision dialog with Aldım/Düşünüyorum/Vazgeçtim buttons
  /// Auto-selects "Aldım" after 2 seconds
  void _showDecisionDialog(VoiceParseResult result) {
    final category = VoiceParserService.mapToAppCategory(result.category);
    final currencySymbol = context.read<CurrencyProvider>().currency.symbol;

    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (dialogContext) => _DecisionDialog(
        result: result,
        category: category,
        currencySymbol: currencySymbol,
        onDecision: (decision) async {
          Navigator.pop(dialogContext);
          await _saveExpenseWithDecision(result, decision);
        },
        onRetry: () {
          Navigator.pop(dialogContext);
          _startListening();
        },
      ),
    );
  }

  /// Save expense with the given decision
  Future<void> _saveExpenseWithDecision(
    VoiceParseResult result,
    ExpenseDecision decision,
  ) async {
    // Increment voice input count only on successful save
    await FreeTierService().incrementVoiceInputCount();

    final category = VoiceParserService.mapToAppCategory(result.category);
    final amount = result.amount!;

    // If returnResult is true, just return the data without saving
    if (widget.returnResult) {
      HapticFeedback.mediumImpact();
      if (mounted) {
        Navigator.of(context).pop({
          'amount': amount,
          'description': result.description,
          'category': category,
          'decision': decision.name,
        });
      }
      return;
    }

    // Get expense service
    final expenseService = ExpenseHistoryService();

    // Calculate work time (simplified)
    final hoursRequired = amount / 50.0;
    final daysRequired = hoursRequired / 8.0;

    // Create expense with the selected decision
    final expense = Expense(
      amount: amount,
      category: category,
      subCategory: result.item ?? result.description,
      date: DateTime.now(),
      hoursRequired: hoursRequired,
      daysRequired: daysRequired,
      decision: decision,
    );

    try {
      await expenseService.addExpense(expense);
      // Track voice expense added
      AnalyticsService().logExpenseAdded(
        method: 'voice',
        amount: expense.amount,
        category: expense.category,
        decision: decision.name,
      );
    } catch (e) {
      debugPrint('[Voice] Error adding expense: $e');
    }

    HapticFeedback.mediumImpact();

    if (mounted) {
      final l10n = AppLocalizations.of(context);
      final currencySymbol = context.read<CurrencyProvider>().currency.symbol;
      final decisionText = switch (decision) {
        ExpenseDecision.yes => l10n.bought,
        ExpenseDecision.thinking => l10n.thinking,
        ExpenseDecision.no => l10n.passed,
      };

      Navigator.of(context).pop();

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Row(
            children: [
              Icon(
                decision == ExpenseDecision.yes
                    ? CupertinoIcons.checkmark_circle_fill
                    : decision == ExpenseDecision.no
                    ? CupertinoIcons.xmark_circle_fill
                    : CupertinoIcons.clock_fill,
                color: Colors.white,
                size: 20,
              ),
              const SizedBox(width: 12),
              Expanded(
                child: Text(
                  '${amount.toStringAsFixed(0)} $currencySymbol ${result.item ?? result.description} - $decisionText',
                ),
              ),
            ],
          ),
          backgroundColor: decision == ExpenseDecision.yes
              ? context.appColors.success
              : decision == ExpenseDecision.no
              ? context.appColors.error
              : context.appColors.warning,
          behavior: SnackBarBehavior.floating,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(16),
          ),
        ),
      );
    }
  }

  void _showRetryOption() {
    if (mounted) {
      final l10n = AppLocalizations.of(context);
      setState(() => _statusText = l10n.couldNotUnderstandSayAgain);
      Future.delayed(const Duration(seconds: 1), () {
        if (mounted && !_isListening) {
          _startListening();
        }
      });
    }
  }

  void _showPermissionDenied() {
    if (!mounted) return;
    final l10n = AppLocalizations.of(context);

    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(l10n.microphonePermissionDenied),
        behavior: SnackBarBehavior.floating,
        action: SnackBarAction(
          label: l10n.settings,
          onPressed: () => openAppSettings(),
        ),
      ),
    );
  }

  /// Check voice input daily limit
  Future<bool> _checkVoiceInputLimit() async {
    final proProvider = context.read<ProProvider>();
    final isPremium = proProvider.isPro;
    final freeTierService = FreeTierService();

    final result = await freeTierService.canUseVoiceInput(isPremium);

    if (!result.canUse && mounted) {
      _showLimitReachedDialog(result.limitType!);
      return false;
    }

    return true;
  }

  /// Show appropriate dialog when limit is reached
  void _showLimitReachedDialog(VoiceInputLimitType limitType) {
    final l10n = AppLocalizations.of(context);

    if (limitType == VoiceInputLimitType.freeLimitReached) {
      // Free user: show upgrade prompt
      showDialog(
        context: context,
        barrierColor: Colors.black.withValues(alpha: 0.85),
        builder: (ctx) => AlertDialog(
          backgroundColor: context.appColors.surface,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(24),
          ),
          title: Row(
            children: [
              Icon(
                CupertinoIcons.mic_fill,
                color: context.appColors.warning,
                size: 28,
              ),
              const SizedBox(width: 12),
              Expanded(
                child: Text(
                  l10n.voiceLimitReachedTitle,
                  style: TextStyle(
                    color: context.appColors.textPrimary,
                    fontSize: 18,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ),
            ],
          ),
          content: Text(
            l10n.voiceLimitReachedFree,
            style: TextStyle(
              color: context.appColors.textSecondary,
              fontSize: 15,
            ),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(ctx),
              child: Text(
                l10n.close,
                style: TextStyle(color: context.appColors.textTertiary),
              ),
            ),
            ElevatedButton.icon(
              onPressed: () {
                Navigator.pop(ctx);
                Navigator.pop(context); // Close voice input screen
                Navigator.push(
                  context,
                  MaterialPageRoute(builder: (_) => const PaywallScreen()),
                );
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: context.appColors.primary,
                foregroundColor: context.appColors.textPrimary,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(16),
                ),
              ),
              icon: const Icon(CupertinoIcons.star_fill, size: 18),
              label: Text(l10n.upgradeToPro),
            ),
          ],
        ),
      );
    } else {
      // Pro user: show server busy message
      showDialog(
        context: context,
        barrierColor: Colors.black.withValues(alpha: 0.85),
        builder: (ctx) => AlertDialog(
          backgroundColor: context.appColors.surface,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(24),
          ),
          title: Row(
            children: [
              Icon(
                CupertinoIcons.clock_fill,
                color: context.appColors.warning,
                size: 28,
              ),
              const SizedBox(width: 12),
              Expanded(
                child: Text(
                  l10n.voiceServerBusyTitle,
                  style: TextStyle(
                    color: context.appColors.textPrimary,
                    fontSize: 18,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ),
            ],
          ),
          content: Text(
            l10n.voiceServerBusyMessage,
            style: TextStyle(
              color: context.appColors.textSecondary,
              fontSize: 15,
            ),
          ),
          actions: [
            ElevatedButton(
              onPressed: () => Navigator.pop(ctx),
              style: ElevatedButton.styleFrom(
                backgroundColor: context.appColors.primary,
                foregroundColor: context.appColors.textPrimary,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(16),
                ),
              ),
              child: Text(l10n.ok),
            ),
          ],
        ),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return Scaffold(
      backgroundColor: context.appColors.background,
      body: SafeArea(
        child: Column(
          children: [
            // Top bar
            Padding(
              padding: const EdgeInsets.all(16),
              child: Row(
                children: [
                  IconButton(
                    icon: Icon(
                      CupertinoIcons.xmark,
                      color: context.appColors.textSecondary,
                    ),
                    tooltip: l10n.accessibilityCloseSheet,
                    onPressed: () => Navigator.pop(context),
                  ),
                  const Spacer(),
                  Column(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Text(
                        l10n.voiceInput,
                        style: TextStyle(
                          color: context.appColors.textPrimary,
                          fontSize: 18,
                          fontWeight: FontWeight.w600,
                        ),
                      ),
                      // Usage indicator for free users
                      _VoiceUsageIndicator(),
                    ],
                  ),
                  const Spacer(),
                  const SizedBox(width: 48),
                ],
              ),
            ),

            const Spacer(),

            // Microphone animation
            AnimatedBuilder(
              animation: _pulseAnimation,
              builder: (_, child) {
                final scale = _isListening ? _pulseAnimation.value : 1.0;
                return Transform.scale(
                  scale: scale,
                  child: Semantics(
                    label: l10n.tapToSpeak,
                    button: true,
                    child: GestureDetector(
                      onTap: _isListening || _isProcessing
                          ? null
                          : _startListening,
                      child: Container(
                        width: 140,
                        height: 140,
                        decoration: BoxDecoration(
                          shape: BoxShape.circle,
                          gradient: LinearGradient(
                            begin: Alignment.topLeft,
                            end: Alignment.bottomRight,
                            colors: _isListening
                                ? [
                                    AppColors.categoryBills,
                                    AppColors.dangerRedDark,
                                  ]
                                : [
                                    context.appColors.primary,
                                    context.appColors.secondary,
                                  ],
                          ),
                          boxShadow: [
                            BoxShadow(
                              color:
                                  (_isListening
                                          ? AppColors.categoryBills
                                          : context.appColors.primary)
                                      .withValues(
                                        alpha: _isListening ? 0.6 : 0.4,
                                      ),
                              blurRadius: _isListening ? 50 : 25,
                              spreadRadius: _isListening ? 10 : 0,
                            ),
                          ],
                        ),
                        child: Center(
                          child: _isProcessing
                              ? SizedBox(
                                  width: 40,
                                  height: 40,
                                  child: CircularProgressIndicator(
                                    color: context.appColors.textPrimary,
                                    strokeWidth: 3,
                                  ),
                                )
                              : Icon(
                                  _isListening
                                      ? CupertinoIcons.stop_fill
                                      : CupertinoIcons.mic_fill,
                                  color: context.appColors.textPrimary,
                                  size: 56,
                                ),
                        ),
                      ),
                    ),
                  ),
                );
              },
            ),

            const SizedBox(height: 32),

            // Sound level indicator
            if (_isListening)
              Container(
                width: 200,
                height: 4,
                decoration: BoxDecoration(
                  color: context.appColors.surfaceLight,
                  borderRadius: BorderRadius.circular(2),
                ),
                child: FractionallySizedBox(
                  alignment: Alignment.centerLeft,
                  widthFactor: 0.2 + (_soundLevel * 0.8),
                  child: Container(
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        colors: [
                          context.appColors.primary,
                          context.appColors.secondary,
                        ],
                      ),
                      borderRadius: BorderRadius.circular(2),
                    ),
                  ),
                ),
              ),

            const SizedBox(height: 24),

            // Status text
            Text(
              _statusText.isEmpty ? l10n.tapToSpeak : _statusText,
              style: TextStyle(
                color: _isListening
                    ? AppColors.categoryBills
                    : context.appColors.textSecondary,
                fontSize: 16,
                fontWeight: FontWeight.w500,
              ),
            ),

            const SizedBox(height: 24),

            // Recognized text
            if (_recognizedText.isNotEmpty)
              Container(
                margin: const EdgeInsets.symmetric(horizontal: 32),
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: context.appColors.surfaceLight,
                  borderRadius: BorderRadius.circular(16),
                  border: Border.all(
                    color: context.appColors.primary.withValues(alpha: 0.3),
                  ),
                ),
                child: Text(
                  _recognizedText,
                  style: TextStyle(
                    color: context.appColors.textPrimary,
                    fontSize: 20,
                    fontWeight: FontWeight.w500,
                  ),
                  textAlign: TextAlign.center,
                ),
              ),

            const Spacer(),

            // Tips section
            Container(
              margin: const EdgeInsets.all(24),
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: context.appColors.surfaceLight,
                borderRadius: BorderRadius.circular(16),
              ),
              child: Column(
                children: [
                  Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(
                        CupertinoIcons.lightbulb_fill,
                        color: context.appColors.warning,
                        size: 20,
                      ),
                      const SizedBox(width: 8),
                      Text(
                        l10n.speakExpense,
                        style: TextStyle(
                          color: context.appColors.textSecondary,
                          fontSize: 14,
                          fontWeight: FontWeight.w600,
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 12),
                  Text(
                    l10n.voiceExamplesMultiline,
                    style: TextStyle(
                      color: context.appColors.textTertiary,
                      fontSize: 13,
                      height: 1.6,
                    ),
                    textAlign: TextAlign.center,
                  ),
                ],
              ),
            ),

            const SizedBox(height: 16),
          ],
        ),
      ),
    );
  }
}

/// Decision dialog with auto-select countdown
class _DecisionDialog extends StatefulWidget {
  final VoiceParseResult result;
  final String category;
  final String currencySymbol;
  final Function(ExpenseDecision) onDecision;
  final VoidCallback onRetry;

  const _DecisionDialog({
    required this.result,
    required this.category,
    required this.currencySymbol,
    required this.onDecision,
    required this.onRetry,
  });

  @override
  State<_DecisionDialog> createState() => _DecisionDialogState();
}

class _DecisionDialogState extends State<_DecisionDialog>
    with SingleTickerProviderStateMixin {
  late AnimationController _timerController;
  bool _autoSelectCancelled = false;

  static const _autoSelectDuration = Duration(milliseconds: 2000);

  @override
  void initState() {
    super.initState();
    _timerController = AnimationController(
      vsync: this,
      duration: _autoSelectDuration,
    );

    _timerController.addStatusListener((status) {
      if (status == AnimationStatus.completed && !_autoSelectCancelled) {
        // Auto-select "Aldım" when timer completes
        HapticFeedback.mediumImpact();
        widget.onDecision(ExpenseDecision.yes);
      }
    });

    // Start the countdown
    _timerController.forward();
  }

  @override
  void dispose() {
    _timerController.dispose();
    super.dispose();
  }

  void _cancelAutoSelect() {
    _autoSelectCancelled = true;
    _timerController.stop();
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final colors = context.appColors;

    return AlertDialog(
      backgroundColor: colors.surface,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(24)),
      contentPadding: const EdgeInsets.fromLTRB(24, 20, 24, 16),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          // Amount display
          Text(
            '${widget.result.amount?.toStringAsFixed(0) ?? "?"} ${widget.currencySymbol}',
            style: TextStyle(
              color: colors.textPrimary,
              fontSize: 36,
              fontWeight: FontWeight.w700,
            ),
          ),

          const SizedBox(height: 8),

          // Store and item info
          if (widget.result.store != null || widget.result.item != null) ...[
            Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                if (widget.result.store != null)
                  Container(
                    padding: const EdgeInsets.symmetric(
                      horizontal: 10,
                      vertical: 4,
                    ),
                    decoration: BoxDecoration(
                      color: colors.primary.withValues(alpha: 0.15),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Text(
                      widget.result.store!,
                      style: TextStyle(
                        color: colors.primary,
                        fontSize: 14,
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                  ),
                if (widget.result.store != null && widget.result.item != null)
                  const SizedBox(width: 8),
                if (widget.result.item != null)
                  Text(
                    widget.result.item!,
                    style: TextStyle(color: colors.textSecondary, fontSize: 16),
                  ),
              ],
            ),
            const SizedBox(height: 8),
          ] else if (widget.result.description.isNotEmpty) ...[
            Text(
              widget.result.description,
              style: TextStyle(color: colors.textSecondary, fontSize: 16),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 8),
          ],

          // Category chip
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
            decoration: BoxDecoration(
              color: colors.surfaceLight,
              borderRadius: BorderRadius.circular(8),
            ),
            child: Text(
              widget.category,
              style: TextStyle(color: colors.textTertiary, fontSize: 13),
            ),
          ),

          const SizedBox(height: 24),

          // Decision buttons
          Row(
            children: [
              // Vazgeçtim (No)
              Expanded(
                child: _DecisionButton(
                  label: l10n.passed,
                  icon: CupertinoIcons.xmark_circle_fill,
                  color: colors.error,
                  onTap: () {
                    _cancelAutoSelect();
                    widget.onDecision(ExpenseDecision.no);
                  },
                ),
              ),
              const SizedBox(width: 8),
              // Düşünüyorum (Thinking)
              Expanded(
                child: _DecisionButton(
                  label: l10n.thinking,
                  icon: CupertinoIcons.clock_fill,
                  color: colors.warning,
                  onTap: () {
                    _cancelAutoSelect();
                    widget.onDecision(ExpenseDecision.thinking);
                  },
                ),
              ),
              const SizedBox(width: 8),
              // Aldım (Yes) - highlighted with timer
              Expanded(
                child: Stack(
                  children: [
                    _DecisionButton(
                      label: l10n.bought,
                      icon: CupertinoIcons.checkmark_circle_fill,
                      color: colors.success,
                      isHighlighted: true,
                      onTap: () {
                        _cancelAutoSelect();
                        widget.onDecision(ExpenseDecision.yes);
                      },
                    ),
                    // Timer indicator
                    if (!_autoSelectCancelled)
                      Positioned(
                        bottom: 0,
                        left: 0,
                        right: 0,
                        child: AnimatedBuilder(
                          animation: _timerController,
                          builder: (_, __) {
                            return Container(
                              height: 3,
                              margin: const EdgeInsets.symmetric(horizontal: 4),
                              child: ClipRRect(
                                borderRadius: BorderRadius.circular(2),
                                child: LinearProgressIndicator(
                                  value: _timerController.value,
                                  backgroundColor: colors.success.withValues(
                                    alpha: 0.3,
                                  ),
                                  valueColor: AlwaysStoppedAnimation(
                                    colors.success,
                                  ),
                                ),
                              ),
                            );
                          },
                        ),
                      ),
                  ],
                ),
              ),
            ],
          ),

          const SizedBox(height: 16),

          // Retry button
          TextButton.icon(
            onPressed: () {
              _cancelAutoSelect();
              widget.onRetry();
            },
            icon: Icon(
              CupertinoIcons.arrow_counterclockwise,
              size: 18,
              color: colors.textTertiary,
            ),
            label: Text(
              l10n.sayAgain,
              style: TextStyle(color: colors.textTertiary, fontSize: 14),
            ),
          ),
        ],
      ),
    );
  }
}

/// Individual decision button
class _DecisionButton extends StatelessWidget {
  final String label;
  final IconData icon;
  final Color color;
  final bool isHighlighted;
  final VoidCallback onTap;

  const _DecisionButton({
    required this.label,
    required this.icon,
    required this.color,
    this.isHighlighted = false,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    final colors = context.appColors;

    return GestureDetector(
      onTap: () {
        HapticFeedback.lightImpact();
        onTap();
      },
      child: Container(
        padding: const EdgeInsets.symmetric(vertical: 14),
        decoration: BoxDecoration(
          color: isHighlighted
              ? color.withValues(alpha: 0.15)
              : colors.surfaceLight,
          borderRadius: BorderRadius.circular(16),
          border: isHighlighted
              ? Border.all(color: color.withValues(alpha: 0.5), width: 1.5)
              : null,
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(icon, color: color, size: 24),
            const SizedBox(height: 4),
            Text(
              label,
              style: TextStyle(
                color: isHighlighted ? color : colors.textSecondary,
                fontSize: 12,
                fontWeight: isHighlighted ? FontWeight.w600 : FontWeight.w500,
              ),
            ),
          ],
        ),
      ),
    );
  }
}

/// Voice usage indicator widget for free users
class _VoiceUsageIndicator extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final isPremium = context.watch<ProProvider>().isPro;

    // PRO users don't need to see usage
    if (isPremium) {
      return const SizedBox.shrink();
    }

    return FutureBuilder<(int, int)>(
      future: FreeTierService().getVoiceInputUsage(false),
      builder: (context, snapshot) {
        if (!snapshot.hasData) return const SizedBox.shrink();

        final (used, total) = snapshot.data!;
        final l10n = AppLocalizations.of(context);
        final remaining = total - used;
        final isLimitReached = remaining <= 0;

        return Padding(
          padding: const EdgeInsets.only(top: 4),
          child: Container(
            padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
            decoration: BoxDecoration(
              color: isLimitReached
                  ? context.appColors.error.withValues(alpha: 0.15)
                  : context.appColors.primary.withValues(alpha: 0.1),
              borderRadius: BorderRadius.circular(16),
            ),
            child: Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                Icon(
                  isLimitReached
                      ? CupertinoIcons.exclamationmark_triangle_fill
                      : CupertinoIcons.mic_fill,
                  size: 12,
                  color: isLimitReached
                      ? context.appColors.error
                      : context.appColors.primary,
                ),
                const SizedBox(width: 4),
                Text(
                  l10n.voiceUsageIndicator(used, total),
                  style: TextStyle(
                    fontSize: 11,
                    fontWeight: FontWeight.w500,
                    color: isLimitReached
                        ? context.appColors.error
                        : context.appColors.primary,
                  ),
                ),
              ],
            ),
          ),
        );
      },
    );
  }
}


--- FILE: lib/screens/onboarding_try_screen.dart ---

import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../providers/providers.dart';
import '../services/services.dart';
import '../theme/theme.dart';
import '../utils/currency_utils.dart';
import 'onboarding_pursuit_screen.dart';

/// Onboarding "Aha Moment" screen
/// Shows after profile creation, before main app
/// Lets user try a sample calculation without saving
class OnboardingTryScreen extends StatefulWidget {
  const OnboardingTryScreen({super.key});

  @override
  State<OnboardingTryScreen> createState() => _OnboardingTryScreenState();
}

class _OnboardingTryScreenState extends State<OnboardingTryScreen>
    with SingleTickerProviderStateMixin {
  final _amountController = TextEditingController();
  final _calculationService = CalculationService();

  bool _showResult = false;
  double _hoursRequired = 0;
  double _daysRequired = 0;
  double _enteredAmount = 0;

  late AnimationController _pulseController;
  late Animation<double> _pulseAnimation;

  @override
  void initState() {
    super.initState();
    _pulseController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 800),
    );
    _pulseAnimation = Tween<double>(begin: 0.98, end: 1.0).animate(
      CurvedAnimation(parent: _pulseController, curve: Curves.easeInOut),
    );
  }

  @override
  void dispose() {
    _amountController.dispose();
    _pulseController.dispose();
    super.dispose();
  }

  void _calculate() {
    final amount = parseTurkishCurrency(_amountController.text);
    if (amount == null || amount <= 0) return;

    HapticFeedback.mediumImpact();

    final financeProvider = context.read<FinanceProvider>();
    final profile = financeProvider.userProfile;

    if (profile == null) return;

    final now = DateTime.now();
    final result = _calculationService.calculateExpense(
      userProfile: profile,
      expenseAmount: amount,
      month: now.month,
      year: now.year,
    );

    setState(() {
      _enteredAmount = amount;
      _hoursRequired = result.hoursRequired;
      _daysRequired = result.daysRequired;
      _showResult = true;
    });

    // Start pulsing animation
    _pulseController.repeat(reverse: true);

    // Haptic on result
    Future.delayed(const Duration(milliseconds: 300), () {
      HapticFeedback.lightImpact();
    });
  }

  void _continueToApp() {
    HapticFeedback.lightImpact();
    Navigator.pushReplacement(
      context,
      PageRouteBuilder(
        pageBuilder: (context, animation, secondaryAnimation) =>
            const OnboardingPursuitScreen(),
        transitionsBuilder: (context, animation, secondaryAnimation, child) {
          return FadeTransition(opacity: animation, child: child);
        },
        transitionDuration: const Duration(milliseconds: 400),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final currencyProvider = context.watch<CurrencyProvider>();

    return Scaffold(
      backgroundColor: context.appColors.background,
      body: SafeArea(
        child: AnimatedSwitcher(
          duration: const Duration(milliseconds: 400),
          child: _showResult
              ? _buildResultView(l10n, currencyProvider)
              : _buildInputView(l10n, currencyProvider),
        ),
      ),
    );
  }

  Widget _buildInputView(
    AppLocalizations l10n,
    CurrencyProvider currencyProvider,
  ) {
    return Padding(
      key: const ValueKey('input'),
      padding: const EdgeInsets.all(24),
      child: Column(
        children: [
          const Spacer(),
          // Icon
          Container(
            width: 80,
            height: 80,
            decoration: BoxDecoration(
              gradient: AppGradients.primaryButton,
              shape: BoxShape.circle,
              boxShadow: [
                BoxShadow(
                  color: context.appColors.primary.withValues(alpha: 0.3),
                  blurRadius: 20,
                  offset: const Offset(0, 8),
                ),
              ],
            ),
            child: Icon(
              CupertinoIcons.scope,
              size: 40,
              color: context.appColors.textPrimary,
            ),
          ),
          const SizedBox(height: 32),

          // Title
          Text(
            l10n.onboardingTryTitle,
            style: TextStyle(
              fontSize: 28,
              fontWeight: FontWeight.w700,
              color: context.appColors.textPrimary,
            ),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 12),

          // Subtitle
          Text(
            l10n.onboardingTrySubtitle,
            style: TextStyle(
              fontSize: 16,
              color: context.appColors.textSecondary,
              height: 1.5,
            ),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 48),

          // Amount Input Card
          ClipRRect(
            borderRadius: BorderRadius.circular(24),
            child: BackdropFilter(
              filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
              child: Container(
                padding: const EdgeInsets.all(24),
                decoration: BoxDecoration(
                  color: context.appColors.surfaceLight,
                  borderRadius: BorderRadius.circular(24),
                  border: Border.all(color: context.appColors.cardBorder),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      l10n.amount,
                      style: TextStyle(
                        fontSize: 14,
                        fontWeight: FontWeight.w600,
                        color: context.appColors.textSecondary,
                      ),
                    ),
                    const SizedBox(height: 12),
                    TextField(
                      controller: _amountController,
                      keyboardType: const TextInputType.numberWithOptions(
                        decimal: true,
                      ),
                      style: TextStyle(
                        fontSize: 32,
                        fontWeight: FontWeight.w600,
                        color: context.appColors.textPrimary,
                      ),
                      decoration: InputDecoration(
                        hintText: '0',
                        hintStyle: TextStyle(
                          fontSize: 32,
                          fontWeight: FontWeight.w600,
                          color: context.appColors.textTertiary,
                        ),
                        prefixText: '${currencyProvider.symbol} ',
                        prefixStyle: TextStyle(
                          fontSize: 32,
                          fontWeight: FontWeight.w600,
                          color: context.appColors.textPrimary,
                        ),
                        border: InputBorder.none,
                        contentPadding: EdgeInsets.zero,
                      ),
                      inputFormatters: [
                        FilteringTextInputFormatter.allow(RegExp(r'[\d.,]')),
                      ],
                      onSubmitted: (_) => _calculate(),
                    ),
                  ],
                ),
              ),
            ),
          ),
          const Spacer(),

          // Calculate Button
          SizedBox(
            width: double.infinity,
            height: 56,
            child: Container(
              decoration: BoxDecoration(
                gradient: AppGradients.primaryButton,
                borderRadius: BorderRadius.circular(16),
                boxShadow: [
                  BoxShadow(
                    color: context.appColors.primary.withValues(alpha: 0.3),
                    blurRadius: 12,
                    offset: const Offset(0, 4),
                  ),
                ],
              ),
              child: ElevatedButton(
                onPressed: _calculate,
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.transparent,
                  shadowColor: Colors.transparent,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(16),
                  ),
                ),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Text(
                      l10n.onboardingTryButton,
                      style: TextStyle(
                        fontSize: 18,
                        fontWeight: FontWeight.w600,
                        color: context.appColors.textPrimary,
                      ),
                    ),
                    const SizedBox(width: 8),
                    Icon(CupertinoIcons.equal_square, size: 24),
                  ],
                ),
              ),
            ),
          ),
          const SizedBox(height: 16),

          // Skip button
          TextButton(
            onPressed: _continueToApp,
            child: Text(
              l10n.skip,
              style: TextStyle(
                fontSize: 16,
                color: context.appColors.textTertiary,
              ),
            ),
          ),
          const SizedBox(height: 24),
        ],
      ),
    );
  }

  Widget _buildResultView(
    AppLocalizations l10n,
    CurrencyProvider currencyProvider,
  ) {
    return Padding(
      key: const ValueKey('result'),
      padding: const EdgeInsets.all(24),
      child: Column(
        children: [
          const Spacer(),

          // Pulsing Result Card
          AnimatedBuilder(
            animation: _pulseAnimation,
            builder: (context, child) {
              return Transform.scale(
                scale: _pulseAnimation.value,
                child: Opacity(
                  opacity:
                      0.7 + (_pulseAnimation.value - 0.98) * 15, // 0.7 to 1.0
                  child: child,
                ),
              );
            },
            child: _buildResultCard(l10n, currencyProvider),
          ),

          const SizedBox(height: 32),

          // Result Text with pulse
          AnimatedBuilder(
            animation: _pulseAnimation,
            builder: (context, child) {
              return Opacity(
                opacity: 0.7 + (_pulseAnimation.value - 0.98) * 15,
                child: child,
              );
            },
            child: Text(
              l10n.onboardingTryResult(_hoursRequired.toStringAsFixed(1)),
              style: TextStyle(
                fontSize: 20,
                fontWeight: FontWeight.w600,
                color: context.appColors.textPrimary,
              ),
              textAlign: TextAlign.center,
            ),
          ),

          const Spacer(),

          // Disclaimer
          Container(
            padding: const EdgeInsets.all(20),
            decoration: BoxDecoration(
              color: context.appColors.surfaceLight,
              borderRadius: BorderRadius.circular(16),
              border: Border.all(color: context.appColors.cardBorder),
            ),
            child: Column(
              children: [
                Row(
                  children: [
                    Icon(
                      CupertinoIcons.lightbulb_fill,
                      size: 20,
                      color: context.appColors.warning,
                    ),
                    const SizedBox(width: 8),
                    Expanded(
                      child: Text(
                        l10n.onboardingTryDisclaimer,
                        style: TextStyle(
                          fontSize: 14,
                          color: context.appColors.textSecondary,
                          height: 1.4,
                        ),
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 12),
                Row(
                  children: [
                    Icon(
                      CupertinoIcons.doc_text_fill,
                      size: 20,
                      color: context.appColors.info,
                    ),
                    const SizedBox(width: 8),
                    Expanded(
                      child: Text(
                        l10n.onboardingTryNotSaved,
                        style: TextStyle(
                          fontSize: 14,
                          color: context.appColors.textSecondary,
                          height: 1.4,
                        ),
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),

          const SizedBox(height: 32),

          // Continue Button
          SizedBox(
            width: double.infinity,
            height: 56,
            child: Container(
              decoration: BoxDecoration(
                gradient: AppGradients.primaryButton,
                borderRadius: BorderRadius.circular(16),
                boxShadow: [
                  BoxShadow(
                    color: context.appColors.primary.withValues(alpha: 0.3),
                    blurRadius: 12,
                    offset: const Offset(0, 4),
                  ),
                ],
              ),
              child: ElevatedButton(
                onPressed: _continueToApp,
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.transparent,
                  shadowColor: Colors.transparent,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(16),
                  ),
                ),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Text(
                      l10n.onboardingContinue,
                      style: TextStyle(
                        fontSize: 18,
                        fontWeight: FontWeight.w600,
                        color: context.appColors.textPrimary,
                      ),
                    ),
                    const SizedBox(width: 8),
                    Icon(CupertinoIcons.arrow_right, size: 24),
                  ],
                ),
              ),
            ),
          ),
          const SizedBox(height: 24),
        ],
      ),
    );
  }

  Widget _buildResultCard(
    AppLocalizations l10n,
    CurrencyProvider currencyProvider,
  ) {
    return ClipRRect(
      borderRadius: BorderRadius.circular(24),
      child: BackdropFilter(
        filter: ImageFilter.blur(sigmaX: 15, sigmaY: 15),
        child: Container(
          padding: const EdgeInsets.all(32),
          decoration: BoxDecoration(
            gradient: LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: [
                context.appColors.primary.withValues(alpha: 0.2),
                context.appColors.secondary.withValues(alpha: 0.1),
              ],
            ),
            borderRadius: BorderRadius.circular(24),
            border: Border.all(
              color: context.appColors.primary.withValues(alpha: 0.3),
              width: 1.5,
            ),
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              // Amount
              Text(
                currencyProvider.format(_enteredAmount),
                style: TextStyle(
                  fontSize: 36,
                  fontWeight: FontWeight.w700,
                  color: context.appColors.textPrimary,
                ),
              ),
              const SizedBox(height: 8),
              Text(
                '=',
                style: TextStyle(
                  fontSize: 24,
                  color: context.appColors.textTertiary,
                ),
              ),
              const SizedBox(height: 8),

              // Hours
              Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(
                    CupertinoIcons.clock_fill,
                    size: 32,
                    color: context.appColors.warning,
                  ),
                  const SizedBox(width: 12),
                  Text(
                    '${_hoursRequired.toStringAsFixed(1)} ${l10n.hourAbbreviation}',
                    style: TextStyle(
                      fontSize: 32,
                      fontWeight: FontWeight.w700,
                      color: context.appColors.warning,
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 4),
              Text(
                '≈ ${_daysRequired.toStringAsFixed(1)} ${l10n.workDays}',
                style: TextStyle(
                  fontSize: 16,
                  color: context.appColors.textSecondary,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}


--- FILE: lib/screens/screens.dart ---

export 'user_profile_screen.dart';
export 'expense_screen.dart';
export 'main_screen.dart';
export 'report_screen.dart';
export 'achievements_screen.dart';
export 'settings_screen.dart';
export 'profile_modal.dart';
export 'currency_detail_screen.dart';
export 'notification_settings_screen.dart';
export 'onboarding_screen.dart';
export 'income_wizard_screen.dart';
export 'splash_screen.dart';
// Abonelik Yönetimi
export 'subscription_screen.dart';
// Viral Özellikler
export 'habit_calculator_screen.dart';
// Voice Input
export 'voice_input_screen.dart';
// In-App Purchases
export 'paywall_screen.dart';
export 'credit_purchase_screen.dart';
// Import Statement
export 'import_statement_screen.dart';
// Pursuits
export 'pursuit_list_screen.dart';
// Onboarding
export 'onboarding_try_screen.dart';
export 'onboarding_pursuit_screen.dart';
export 'onboarding_salary_day_screen.dart';
export 'onboarding_v2_screen.dart';
// Security
export 'lock_screen.dart';
export 'pin_setup_screen.dart';
// Simple Mode
export 'simple/simple_main_screen.dart';
export 'simple/simple_transactions_screen.dart';
export 'simple/simple_statistics_screen.dart';
export 'simple/simple_settings_screen.dart';


--- FILE: lib/screens/profile_screen.dart ---

import 'dart:async';
import 'dart:io';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:vantag/l10n/app_localizations.dart';
import 'package:provider/provider.dart';
import 'package:url_launcher/url_launcher.dart';
import 'package:file_picker/file_picker.dart';
import '../services/statement_parse_service.dart';
import 'package:firebase_auth/firebase_auth.dart';
import '../models/models.dart';
import '../providers/finance_provider.dart';
import '../providers/locale_provider.dart';
import '../providers/currency_provider.dart';
import '../providers/pro_provider.dart';
import '../services/achievements_service.dart';
import '../services/tour_service.dart';
import '../services/export_service.dart';
import '../services/auth_service.dart';
import 'package:shared_preferences/shared_preferences.dart';
import '../theme/theme.dart';
import '../widgets/widgets.dart';
import 'user_profile_screen.dart';
import 'notification_settings_screen.dart';
import 'onboarding_screen.dart';
import 'paywall_screen.dart';

class ProfileScreen extends StatefulWidget {
  final UserProfile userProfile;
  final Function(UserProfile) onProfileUpdated;
  final VoidCallback? onStartTour;

  const ProfileScreen({
    super.key,
    required this.userProfile,
    required this.onProfileUpdated,
    this.onStartTour,
  });

  @override
  State<ProfileScreen> createState() => _ProfileScreenState();
}

class _ProfileScreenState extends State<ProfileScreen> {
  late UserProfile _userProfile;
  int _easterEggTaps = 0;
  Timer? _easterEggTimer;
  bool _isExporting = false;
  bool _isImporting = false;

  @override
  void initState() {
    super.initState();
    _userProfile = widget.userProfile;
  }

  @override
  void didUpdateWidget(ProfileScreen oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (oldWidget.userProfile != widget.userProfile) {
      _userProfile = widget.userProfile;
    }
  }

  @override
  void dispose() {
    _easterEggTimer?.cancel();
    super.dispose();
  }

  Future<void> _editProfile() async {
    final updatedProfile = await Navigator.push<UserProfile>(
      context,
      MaterialPageRoute(
        builder: (context) => UserProfileScreen(existingProfile: _userProfile),
      ),
    );

    if (updatedProfile != null) {
      setState(() => _userProfile = updatedProfile);
      widget.onProfileUpdated(updatedProfile);
    }
  }

  double _calculateHourlyWage() {
    final monthlyHours =
        _userProfile.dailyHours * _userProfile.workDaysPerWeek * 4;
    if (monthlyHours <= 0) return 0;
    return _userProfile.monthlyIncome / monthlyHours;
  }

  Future<void> _exportToExcel() async {
    final l10n = AppLocalizations.of(context);
    final proProvider = context.read<ProProvider>();

    // Pro kontrolü
    if (!proProvider.isPro) {
      _showProPaywall(l10n);
      return;
    }

    setState(() => _isExporting = true);

    try {
      final exportService = ExportService();
      final file = await exportService.exportToExcel(context);

      if (file != null && mounted) {
        await exportService.shareExcel(file);
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(l10n.exportSuccess),
            behavior: SnackBarBehavior.floating,
            backgroundColor: context.appColors.success,
          ),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('${l10n.exportError}: $e'),
            behavior: SnackBarBehavior.floating,
            backgroundColor: context.appColors.error,
          ),
        );
      }
    } finally {
      if (mounted) {
        setState(() => _isExporting = false);
      }
    }
  }

  void _showProPaywall(AppLocalizations l10n, {String feature = 'export'}) {
    final title = feature == 'import'
        ? l10n.importPremiumOnly
        : l10n.proFeatureExport;
    final subtitle = feature == 'import'
        ? l10n.upgradeForImport
        : l10n.upgradeForExport;

    showModalBottomSheet(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      backgroundColor: context.appColors.cardBackground,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      builder: (context) => SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(24),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    colors: [
                      context.appColors.primary.withValues(alpha: 0.2),
                      context.appColors.secondary.withValues(alpha: 0.2),
                    ],
                  ),
                  shape: BoxShape.circle,
                ),
                child: Icon(
                  CupertinoIcons.star_fill,
                  size: 48,
                  color: context.appColors.warning,
                ),
              ),
              const SizedBox(height: 16),
              Text(
                title,
                style: TextStyle(
                  fontSize: 20,
                  fontWeight: FontWeight.w700,
                  color: context.appColors.textPrimary,
                ),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 8),
              Text(
                subtitle,
                style: TextStyle(
                  fontSize: 14,
                  color: context.appColors.textSecondary,
                ),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 24),
              SizedBox(
                width: double.infinity,
                child: ElevatedButton(
                  onPressed: () {
                    Navigator.pop(context);
                    Navigator.push(
                      context,
                      MaterialPageRoute(
                        builder: (context) => const PaywallScreen(),
                      ),
                    );
                  },
                  style: ElevatedButton.styleFrom(
                    backgroundColor: context.appColors.primary,
                    foregroundColor: context.appColors.textPrimary,
                    padding: const EdgeInsets.symmetric(vertical: 16),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(16),
                    ),
                  ),
                  child: Text(l10n.upgradeToPro),
                ),
              ),
              const SizedBox(height: 12),
              TextButton(
                onPressed: () => Navigator.pop(context),
                child: Text(
                  l10n.cancel,
                  style: TextStyle(color: context.appColors.textSecondary),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Future<void> _importFromCSV() async {
    final l10n = AppLocalizations.of(context);
    final proProvider = context.read<ProProvider>();

    // Premium check for import
    if (!proProvider.isPro) {
      _showProPaywall(l10n, feature: 'import');
      return;
    }

    final user = FirebaseAuth.instance.currentUser;

    if (user == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(l10n.importError),
          behavior: SnackBarBehavior.floating,
          backgroundColor: context.appColors.error,
        ),
      );
      return;
    }

    try {
      // Pick PDF or CSV file
      final result = await FilePicker.platform.pickFiles(
        type: FileType.custom,
        allowedExtensions: ['pdf', 'csv'],
        allowMultiple: false,
      );

      if (result == null || result.files.isEmpty) return;

      setState(() => _isImporting = true);

      final file = File(result.files.single.path!);
      final fileName = result.files.single.name;
      final isPDF = fileName.toLowerCase().endsWith('.pdf');

      // Use AI-powered statement parser for both PDF and CSV
      final parseService = StatementParseService();
      final parseResult = await parseService.parseFile(file);

      if (!mounted) return;

      if (parseResult.hasError) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(parseResult.error!),
            behavior: SnackBarBehavior.floating,
            backgroundColor: context.appColors.error,
          ),
        );
        return;
      }

      if (parseResult.isEmpty) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(l10n.importNoTransactions),
            behavior: SnackBarBehavior.floating,
            backgroundColor: context.appColors.warning,
          ),
        );
        return;
      }

      // Show AI parse result
      _showAIParseResult(l10n, parseResult, isPDF);
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('${l10n.importError}: $e'),
            behavior: SnackBarBehavior.floating,
            backgroundColor: context.appColors.error,
          ),
        );
      }
    } finally {
      if (mounted) {
        setState(() => _isImporting = false);
      }
    }
  }

  void _showAIParseResult(
    AppLocalizations l10n,
    StatementParseResult result,
    bool isPDF,
  ) {
    showModalBottomSheet(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      backgroundColor: context.appColors.surface,
      isScrollControlled: true,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      builder: (context) {
        final selectedItems = ValueNotifier<Set<int>>(
          Set.from(List.generate(result.transactions.length, (i) => i)),
        );
        final isSaving = ValueNotifier<bool>(false);

        return DraggableScrollableSheet(
          initialChildSize: 0.7,
          minChildSize: 0.5,
          maxChildSize: 0.95,
          expand: false,
          builder: (context, scrollController) => SafeArea(
            child: Column(
              children: [
                // Handle
                Container(
                  width: 40,
                  height: 4,
                  margin: const EdgeInsets.only(top: 12, bottom: 16),
                  decoration: BoxDecoration(
                    color: context.appColors.textTertiary,
                    borderRadius: BorderRadius.circular(2),
                  ),
                ),

                // Header
                Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 20),
                  child: Column(
                    children: [
                      Row(
                        children: [
                          Icon(
                            isPDF
                                ? CupertinoIcons.doc_fill
                                : CupertinoIcons.doc_text_fill,
                            color: context.appColors.primary,
                            size: 28,
                          ),
                          const SizedBox(width: 12),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  l10n.importAIParsed,
                                  style: TextStyle(
                                    fontSize: 18,
                                    fontWeight: FontWeight.w700,
                                    color: context.appColors.textPrimary,
                                  ),
                                ),
                                if (result.bankName != null)
                                  Text(
                                    result.bankName!,
                                    style: TextStyle(
                                      fontSize: 13,
                                      color: context.appColors.textSecondary,
                                    ),
                                  ),
                              ],
                            ),
                          ),
                          Container(
                            padding: const EdgeInsets.symmetric(
                              horizontal: 10,
                              vertical: 4,
                            ),
                            decoration: BoxDecoration(
                              color: context.appColors.success.withValues(
                                alpha: 0.15,
                              ),
                              borderRadius: BorderRadius.circular(8),
                            ),
                            child: Text(
                              '${result.transactions.length} ${l10n.transactions}',
                              style: TextStyle(
                                fontSize: 13,
                                fontWeight: FontWeight.w600,
                                color: context.appColors.success,
                              ),
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 12),

                      // Select all / none
                      ValueListenableBuilder<Set<int>>(
                        valueListenable: selectedItems,
                        builder: (context, selected, _) => Row(
                          children: [
                            TextButton(
                              onPressed: () {
                                selectedItems.value = Set.from(
                                  List.generate(
                                    result.transactions.length,
                                    (i) => i,
                                  ),
                                );
                              },
                              child: Text(l10n.selectAll),
                            ),
                            TextButton(
                              onPressed: () {
                                selectedItems.value = {};
                              },
                              child: Text(l10n.selectNone),
                            ),
                            const Spacer(),
                            Text(
                              '${selected.length} ${l10n.selected}',
                              style: TextStyle(
                                fontSize: 13,
                                color: context.appColors.textSecondary,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),

                Divider(color: context.appColors.cardBorder),

                // Transaction list
                Expanded(
                  child: ValueListenableBuilder<Set<int>>(
                    valueListenable: selectedItems,
                    builder: (context, selected, _) => ListView.builder(
                      controller: scrollController,
                      padding: const EdgeInsets.symmetric(horizontal: 16),
                      itemCount: result.transactions.length,
                      itemBuilder: (context, index) {
                        final t = result.transactions[index];
                        final isSelected = selected.contains(index);

                        return InkWell(
                          onTap: () {
                            final newSet = Set<int>.from(selected);
                            if (isSelected) {
                              newSet.remove(index);
                            } else {
                              newSet.add(index);
                            }
                            selectedItems.value = newSet;
                          },
                          child: Container(
                            margin: const EdgeInsets.only(bottom: 8),
                            padding: const EdgeInsets.all(12),
                            decoration: BoxDecoration(
                              color: isSelected
                                  ? context.appColors.primary.withValues(
                                      alpha: 0.1,
                                    )
                                  : context.appColors.surfaceLight,
                              borderRadius: BorderRadius.circular(8),
                              border: Border.all(
                                color: isSelected
                                    ? context.appColors.primary
                                    : Colors.transparent,
                                width: 1.5,
                              ),
                            ),
                            child: Row(
                              children: [
                                // Checkbox
                                Icon(
                                  isSelected
                                      ? CupertinoIcons.checkmark_circle_fill
                                      : CupertinoIcons.circle,
                                  color: isSelected
                                      ? context.appColors.primary
                                      : context.appColors.textTertiary,
                                  size: 22,
                                ),
                                const SizedBox(width: 12),

                                // Details
                                Expanded(
                                  child: Column(
                                    crossAxisAlignment:
                                        CrossAxisAlignment.start,
                                    children: [
                                      Text(
                                        t.merchant ?? t.description,
                                        style: TextStyle(
                                          fontSize: 14,
                                          fontWeight: FontWeight.w600,
                                          color: context.appColors.textPrimary,
                                        ),
                                        maxLines: 1,
                                        overflow: TextOverflow.ellipsis,
                                      ),
                                      const SizedBox(height: 2),
                                      Row(
                                        children: [
                                          Text(
                                            t.category,
                                            style: TextStyle(
                                              fontSize: 12,
                                              color: context
                                                  .appColors
                                                  .textSecondary,
                                            ),
                                          ),
                                          Text(
                                            ' • ',
                                            style: TextStyle(
                                              color: context
                                                  .appColors
                                                  .textTertiary,
                                            ),
                                          ),
                                          Text(
                                            '${t.date.day}/${t.date.month}/${t.date.year}',
                                            style: TextStyle(
                                              fontSize: 12,
                                              color: context
                                                  .appColors
                                                  .textTertiary,
                                            ),
                                          ),
                                        ],
                                      ),
                                    ],
                                  ),
                                ),

                                // Amount
                                Text(
                                  '₺${t.amount.toStringAsFixed(2)}',
                                  style: TextStyle(
                                    fontSize: 15,
                                    fontWeight: FontWeight.w700,
                                    color: context.appColors.error,
                                  ),
                                ),
                              ],
                            ),
                          ),
                        );
                      },
                    ),
                  ),
                ),

                // Save button
                Padding(
                  padding: const EdgeInsets.all(16),
                  child: ValueListenableBuilder<Set<int>>(
                    valueListenable: selectedItems,
                    builder: (context, selected, _) =>
                        ValueListenableBuilder<bool>(
                          valueListenable: isSaving,
                          builder: (context, saving, _) => SizedBox(
                            width: double.infinity,
                            child: ElevatedButton.icon(
                              onPressed: selected.isEmpty || saving
                                  ? null
                                  : () async {
                                      isSaving.value = true;
                                      await _saveAIParsedExpenses(
                                        result.transactions,
                                        selected,
                                      );
                                      if (context.mounted) {
                                        Navigator.pop(context);
                                        ScaffoldMessenger.of(
                                          context,
                                        ).showSnackBar(
                                          SnackBar(
                                            content: Text(
                                              l10n.importSuccess(
                                                selected.length,
                                              ),
                                            ),
                                            behavior: SnackBarBehavior.floating,
                                            backgroundColor:
                                                context.appColors.success,
                                          ),
                                        );
                                      }
                                    },
                              icon: saving
                                  ? const SizedBox(
                                      width: 18,
                                      height: 18,
                                      child: CircularProgressIndicator(
                                        strokeWidth: 2,
                                        color: Colors.white,
                                      ),
                                    )
                                  : const Icon(
                                      CupertinoIcons.floppy_disk,
                                      size: 20,
                                    ),
                              label: Text(
                                saving
                                    ? l10n.saving
                                    : l10n.importSelected(selected.length),
                              ),
                              style: ElevatedButton.styleFrom(
                                backgroundColor: context.appColors.primary,
                                foregroundColor: Colors.white,
                                padding: const EdgeInsets.symmetric(
                                  vertical: 14,
                                ),
                                shape: RoundedRectangleBorder(
                                  borderRadius: BorderRadius.circular(16),
                                ),
                              ),
                            ),
                          ),
                        ),
                  ),
                ),
              ],
            ),
          ),
        );
      },
    );
  }

  Future<void> _saveAIParsedExpenses(
    List<ParsedTransaction> transactions,
    Set<int> selectedIndices,
  ) async {
    final financeProvider = context.read<FinanceProvider>();
    final profile = financeProvider.userProfile;

    if (profile == null) return;

    final hourlyRate = profile.hourlyRate;

    for (final index in selectedIndices) {
      final t = transactions[index];

      final hoursRequired = hourlyRate > 0 ? t.amount / hourlyRate : 0.0;
      final daysRequired = hoursRequired / profile.dailyHours;

      final expense = Expense(
        amount: t.amount,
        category: t.category,
        subCategory: t.merchant ?? t.description,
        date: t.date,
        hoursRequired: hoursRequired,
        daysRequired: daysRequired,
        decision: ExpenseDecision.yes,
      );

      await financeProvider.addExpense(expense);
    }
  }

  void _showLanguageSelector() {
    final localeProvider = context.read<LocaleProvider>();
    final currentLocale = Localizations.localeOf(context);

    showModalBottomSheet(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      backgroundColor: context.appColors.surface,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      builder: (context) => SafeArea(
        child: Padding(
          padding: const EdgeInsets.symmetric(vertical: 16),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Container(
                width: 40,
                height: 4,
                margin: const EdgeInsets.only(bottom: 16),
                decoration: BoxDecoration(
                  color: context.appColors.textTertiary,
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
              _buildLanguageOption(
                context: context,
                localeProvider: localeProvider,
                locale: const Locale('tr'),
                name: 'Türkçe',
                flag: '🇹🇷',
                isSelected: currentLocale.languageCode == 'tr',
              ),
              _buildLanguageOption(
                context: context,
                localeProvider: localeProvider,
                locale: const Locale('en'),
                name: 'English',
                flag: '🇺🇸',
                isSelected: currentLocale.languageCode == 'en',
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildLanguageOption({
    required BuildContext context,
    required LocaleProvider localeProvider,
    required Locale locale,
    required String name,
    required String flag,
    required bool isSelected,
  }) {
    return ListTile(
      leading: Text(flag, style: const TextStyle(fontSize: 24)),
      title: Text(
        name,
        style: TextStyle(
          color: context.appColors.textPrimary,
          fontWeight: isSelected ? FontWeight.w600 : FontWeight.w400,
        ),
      ),
      trailing: isSelected
          ? Icon(
              CupertinoIcons.checkmark_circle_fill,
              color: context.appColors.primary,
            )
          : null,
      onTap: () async {
        Navigator.pop(context);
        await localeProvider.setLocale(locale);
        HapticFeedback.lightImpact();
      },
    );
  }

  Future<void> _deleteAccount() async {
    final l10n = AppLocalizations.of(context);
    final confirmWord = l10n.deleteAccountConfirmWord;

    final confirmed = await showDialog<bool>(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      barrierDismissible: false,
      builder: (context) =>
          _DeleteAccountDialog(confirmWord: confirmWord, l10n: l10n),
    );

    if (confirmed == true && mounted) {
      HapticFeedback.heavyImpact();

      // Show loading indicator
      showDialog(
        context: context,
        barrierDismissible: false,
        barrierColor: Colors.black.withValues(alpha: 0.85),
        builder: (ctx) => Center(
          child: CircularProgressIndicator(color: ctx.appColors.primary),
        ),
      );

      try {
        // 1. Delete Firebase account (also deletes Firestore data)
        final authService = AuthService();
        final result = await authService.deleteAccount();

        if (!result.success) {
          if (mounted) {
            Navigator.pop(context); // Close loading
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: Text(result.errorMessage ?? l10n.deleteAccountError),
                backgroundColor: context.appColors.error,
              ),
            );
          }
          return;
        }

        // 2. Clear SharedPreferences
        final prefs = await SharedPreferences.getInstance();
        await prefs.clear();

        // 3. Reset local provider data
        if (mounted) {
          final provider = context.read<FinanceProvider>();
          await provider.resetAllData();
        }

        if (!mounted) return;

        // Close loading dialog and navigate
        Navigator.pop(context);

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(l10n.deleteAccountSuccess),
            backgroundColor: context.appColors.success,
          ),
        );

        Navigator.pushAndRemoveUntil(
          context,
          MaterialPageRoute(builder: (context) => const OnboardingScreen()),
          (route) => false,
        );
      } catch (e) {
        if (mounted) {
          Navigator.pop(context); // Close loading
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text(l10n.deleteAccountError),
              backgroundColor: context.appColors.error,
            ),
          );
        }
      }
    }
  }

  void _onVersionTap() {
    HapticFeedback.lightImpact();

    // Cancel existing timer and start a new one
    _easterEggTimer?.cancel();
    _easterEggTimer = Timer(const Duration(seconds: 2), () {
      setState(() => _easterEggTaps = 0);
    });

    setState(() => _easterEggTaps++);

    // Unlock achievement at 5 taps
    if (_easterEggTaps >= 5) {
      _easterEggTimer?.cancel();
      _unlockCuriousCatAchievement();
    }
  }

  Future<void> _unlockCuriousCatAchievement() async {
    final l10n = AppLocalizations.of(context);
    final achievementsService = AchievementsService();

    // Unlock the achievement
    await achievementsService.unlockManualAchievement('curious_cat');

    if (!mounted) return;

    // Reset counter
    setState(() => _easterEggTaps = 0);

    // Haptic feedback
    HapticFeedback.heavyImpact();

    // Show achievement unlocked dialog
    showDialog(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      builder: (context) => AlertDialog(
        backgroundColor: context.appColors.surface,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(24)),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            const SizedBox(height: 16),
            Container(
              width: 80,
              height: 80,
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  colors: [
                    context.appColors.warning.withValues(alpha: 0.3),
                    context.appColors.primary.withValues(alpha: 0.3),
                  ],
                ),
                shape: BoxShape.circle,
                boxShadow: [
                  BoxShadow(
                    color: context.appColors.warning.withValues(alpha: 0.4),
                    blurRadius: 20,
                    spreadRadius: -5,
                  ),
                ],
              ),
              child: Center(
                child: Icon(
                  CupertinoIcons.smiley,
                  size: 40,
                  color: context.appColors.warning,
                ),
              ),
            ),
            const SizedBox(height: 20),
            Text(
              l10n.achievementUnlocked,
              style: TextStyle(
                fontSize: 14,
                color: context.appColors.primary,
                fontWeight: FontWeight.w500,
              ),
            ),
            const SizedBox(height: 8),
            Text(
              l10n.curiousCatTitle,
              style: TextStyle(
                fontSize: 22,
                fontWeight: FontWeight.w700,
                color: context.appColors.textPrimary,
              ),
            ),
            const SizedBox(height: 8),
            Text(
              l10n.curiousCatDescription,
              textAlign: TextAlign.center,
              style: TextStyle(
                fontSize: 14,
                color: context.appColors.textSecondary,
              ),
            ),
            const SizedBox(height: 24),
            SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                onPressed: () => Navigator.pop(context),
                style: ElevatedButton.styleFrom(
                  backgroundColor: context.appColors.primary,
                  foregroundColor: context.appColors.textPrimary,
                  padding: const EdgeInsets.symmetric(vertical: 14),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(16),
                  ),
                ),
                child: Text(l10n.great),
              ),
            ),
          ],
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return Scaffold(
      backgroundColor: context.appColors.background,
      appBar: AppBar(
        backgroundColor: context.appColors.background,
        title: Text(
          l10n.profile,
          style: TextStyle(
            fontSize: 28,
            fontWeight: FontWeight.w700,
            color: context.appColors.textPrimary,
          ),
        ),
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.symmetric(horizontal: 20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // ==================== HEADER SECTION ====================
            _buildHeaderSection(l10n),

            const SizedBox(height: 32),

            // ==================== SETTINGS SECTION ====================
            _buildSectionTitle(l10n.settings),
            const SizedBox(height: 12),
            _buildSettingsSection(l10n),

            const SizedBox(height: 24),

            // ==================== ABOUT SECTION ====================
            _buildSectionTitle(l10n.about),
            const SizedBox(height: 12),
            _buildAboutSection(l10n),

            const SizedBox(height: 24),

            // ==================== DANGER ZONE ====================
            _buildSectionTitle(l10n.dangerZone, isDestructive: true),
            const SizedBox(height: 12),
            _buildDangerSection(l10n),

            // Extra space for nav bar
            const SizedBox(height: 100),
          ],
        ),
      ),
    );
  }

  // ==================== HEADER SECTION ====================
  Widget _buildHeaderSection(AppLocalizations l10n) {
    return Column(
      children: [
        const SizedBox(height: 8),
        // Profile photo
        const ProfilePhotoWidget(size: 100),
        const SizedBox(height: 8),
        Text(
          l10n.tapToAddPhoto,
          style: TextStyle(fontSize: 12, color: context.appColors.textTertiary),
        ),
        const SizedBox(height: 20),

        // Info cards in 2x2 grid
        Row(
          children: [
            Expanded(
              child: _buildCompactInfoCard(
                icon: CupertinoIcons.creditcard_fill,
                title: l10n.monthlyIncome,
                value: formatTurkishCurrency(
                  _userProfile.monthlyIncome,
                  decimalDigits: 0,
                ),
              ),
            ),
            const SizedBox(width: 12),
            Expanded(
              child: _buildCompactInfoCard(
                icon: CupertinoIcons.clock_fill,
                title: l10n.dailyWork,
                value:
                    '${_userProfile.dailyHours.toStringAsFixed(0)} ${l10n.hours}',
              ),
            ),
          ],
        ),
        const SizedBox(height: 12),
        Row(
          children: [
            Expanded(
              child: _buildCompactInfoCard(
                icon: CupertinoIcons.calendar,
                title: l10n.weeklyWorkingDays,
                value: '${_userProfile.workDaysPerWeek} ${l10n.days}',
              ),
            ),
            const SizedBox(width: 12),
            Expanded(
              child: _buildCompactInfoCard(
                icon: CupertinoIcons.arrow_up_right,
                title: l10n.hourlyEarnings,
                value:
                    '${formatTurkishCurrency(_calculateHourlyWage(), decimalDigits: 2)}/${l10n.hourAbbreviation}',
                highlight: true,
              ),
            ),
          ],
        ),
        const SizedBox(height: 16),

        // Quick action buttons row
        Row(
          children: [
            // Edit Photo button
            Expanded(
              child: _buildQuickActionButton(
                icon: CupertinoIcons.camera_fill,
                label: l10n.changePhoto,
                onTap: () => _showPhotoOptions(l10n),
              ),
            ),
            const SizedBox(width: 12),
            // Edit Income button
            Expanded(
              child: _buildQuickActionButton(
                icon: CupertinoIcons.creditcard_fill,
                label: l10n.editIncome,
                onTap: _editProfile,
              ),
            ),
            const SizedBox(width: 12),
            // Add Income Source button
            Expanded(
              child: _buildQuickActionButton(
                icon: CupertinoIcons.plus_circle_fill,
                label: l10n.addIncome,
                onTap: _editProfile,
                highlight: true,
              ),
            ),
          ],
        ),
      ],
    );
  }

  Widget _buildQuickActionButton({
    required IconData icon,
    required String label,
    required VoidCallback onTap,
    bool highlight = false,
  }) {
    return Semantics(
      label: label,
      button: true,
      child: GestureDetector(
        onTap: onTap,
        child: Container(
          padding: const EdgeInsets.symmetric(vertical: 12, horizontal: 8),
          decoration: BoxDecoration(
            color: highlight
                ? context.appColors.primary.withValues(alpha: 0.15)
                : context.appColors.surface,
            borderRadius: BorderRadius.circular(16),
            border: Border.all(
              color: highlight
                  ? context.appColors.primary.withValues(alpha: 0.3)
                  : context.appColors.cardBorder,
            ),
          ),
          child: Column(
            children: [
              Icon(
                icon,
                size: 22,
                color: highlight
                    ? context.appColors.primary
                    : context.appColors.textSecondary,
              ),
              const SizedBox(height: 6),
              Text(
                label,
                style: TextStyle(
                  fontSize: 11,
                  fontWeight: FontWeight.w500,
                  color: highlight
                      ? context.appColors.primary
                      : context.appColors.textSecondary,
                ),
                textAlign: TextAlign.center,
                maxLines: 1,
                overflow: TextOverflow.ellipsis,
              ),
            ],
          ),
        ),
      ),
    );
  }

  void _showPhotoOptions(AppLocalizations l10n) {
    showModalBottomSheet(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      backgroundColor: context.appColors.cardBackground,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      builder: (context) => SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(24),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              ListTile(
                leading: Icon(
                  CupertinoIcons.camera_fill,
                  color: context.appColors.primary,
                ),
                title: Text(l10n.takePhoto),
                onTap: () {
                  Navigator.pop(context);
                  // ProfilePhotoWidget handles photo capture
                },
              ),
              ListTile(
                leading: Icon(
                  CupertinoIcons.photo_fill,
                  color: context.appColors.primary,
                ),
                title: Text(l10n.chooseFromGallery),
                onTap: () {
                  Navigator.pop(context);
                  // ProfilePhotoWidget handles photo selection
                },
              ),
            ],
          ),
        ),
      ),
    );
  }

  // ==================== SETTINGS SECTION ====================
  Widget _buildSettingsSection(AppLocalizations l10n) {
    // Watch locale provider for reactive updates
    final localeProvider = context.watch<LocaleProvider>();
    final currentLangCode =
        localeProvider.locale?.languageCode ??
        Localizations.localeOf(context).languageCode;
    final currentLangName = currentLangCode == 'tr' ? 'Türkçe' : 'English';

    return Container(
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: context.appColors.cardBorder),
      ),
      child: Column(
        children: [
          _buildListTile(
            icon: CupertinoIcons.bell_fill,
            iconColor: AppColors.categoryEntertainment,
            title: l10n.notificationSettings,
            onTap: () {
              Navigator.push(
                context,
                MaterialPageRoute(
                  builder: (context) => const NotificationSettingsScreen(),
                ),
              );
            },
          ),
          _buildDivider(),
          _buildListTile(
            icon: CupertinoIcons.compass_fill,
            iconColor: AppColors.categoryShopping,
            title: l10n.repeatTour,
            onTap: () async {
              await TourService.resetTour();
              if (mounted && widget.onStartTour != null) {
                widget.onStartTour!();
              }
            },
          ),
          _buildDivider(),
          _buildListTile(
            icon: CupertinoIcons.globe,
            iconColor: AppColors.categoryHealth,
            title: l10n.language,
            trailing: Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                Text(
                  currentLangName,
                  style: TextStyle(
                    color: context.appColors.textSecondary,
                    fontSize: 14,
                    fontWeight: FontWeight.w500,
                  ),
                ),
                const SizedBox(width: 4),
                Icon(
                  CupertinoIcons.chevron_right,
                  size: 18,
                  color: context.appColors.textTertiary,
                ),
              ],
            ),
            showArrow: false,
            onTap: _showLanguageSelector,
          ),
          _buildDivider(),
          _buildCurrencyTile(l10n),
          _buildDivider(),
          _buildExportTile(l10n),
          _buildDivider(),
          _buildImportTile(l10n),
        ],
      ),
    );
  }

  Widget _buildCurrencyTile(AppLocalizations l10n) {
    final currencyProvider = context.watch<CurrencyProvider>();
    final currency = currencyProvider.currency;

    return _buildListTile(
      icon: CupertinoIcons.money_dollar_circle_fill,
      iconColor: AppColors.achievementStreak,
      title: l10n.currency,
      trailing: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Text(currency.flag, style: const TextStyle(fontSize: 16)),
          const SizedBox(width: 6),
          Text(
            currency.code,
            style: TextStyle(
              color: context.appColors.textSecondary,
              fontSize: 14,
              fontWeight: FontWeight.w500,
            ),
          ),
          const SizedBox(width: 4),
          Icon(
            CupertinoIcons.chevron_right,
            size: 18,
            color: context.appColors.textTertiary,
          ),
        ],
      ),
      showArrow: false,
      onTap: () => showCurrencySelector(context),
    );
  }

  Widget _buildExportTile(AppLocalizations l10n) {
    final proProvider = context.watch<ProProvider>();
    final isPro = proProvider.isPro;

    return _buildListTile(
      icon: CupertinoIcons.doc_chart_fill,
      iconColor: AppColors.premiumGreen,
      title: l10n.exportToExcel,
      trailing: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          if (_isExporting)
            SizedBox(
              width: 18,
              height: 18,
              child: CircularProgressIndicator(
                strokeWidth: 2,
                color: context.appColors.primary,
              ),
            )
          else if (!isPro)
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  colors: [
                    context.appColors.primary.withValues(alpha: 0.2),
                    context.appColors.secondary.withValues(alpha: 0.2),
                  ],
                ),
                borderRadius: BorderRadius.circular(6),
              ),
              child: Text(
                'PRO',
                style: TextStyle(
                  fontSize: 10,
                  fontWeight: FontWeight.w700,
                  color: context.appColors.primary,
                ),
              ),
            )
          else
            Icon(
              CupertinoIcons.chevron_right,
              size: 18,
              color: context.appColors.textTertiary,
            ),
        ],
      ),
      showArrow: false,
      onTap: _isExporting ? null : _exportToExcel,
    );
  }

  Widget _buildImportTile(AppLocalizations l10n) {
    final proProvider = context.watch<ProProvider>();
    final isPro = proProvider.isPro;

    return _buildListTile(
      icon: CupertinoIcons.arrow_down_circle_fill,
      iconColor: AppColors.categoryEntertainment,
      title: l10n.importStatement,
      trailing: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          if (_isImporting)
            SizedBox(
              width: 18,
              height: 18,
              child: CircularProgressIndicator(
                strokeWidth: 2,
                color: context.appColors.primary,
              ),
            )
          else if (!isPro)
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  colors: [
                    context.appColors.primary.withValues(alpha: 0.2),
                    context.appColors.secondary.withValues(alpha: 0.2),
                  ],
                ),
                borderRadius: BorderRadius.circular(6),
              ),
              child: Text(
                'PRO',
                style: TextStyle(
                  fontSize: 10,
                  fontWeight: FontWeight.w700,
                  color: context.appColors.primary,
                ),
              ),
            )
          else
            Icon(
              CupertinoIcons.chevron_right,
              size: 18,
              color: context.appColors.textTertiary,
            ),
        ],
      ),
      showArrow: false,
      onTap: _isImporting ? null : _importFromCSV,
    );
  }

  // ==================== ABOUT SECTION ====================
  Widget _buildAboutSection(AppLocalizations l10n) {
    // Use provider locale or fall back to system locale
    final localeProvider = context.watch<LocaleProvider>();
    final langCode =
        localeProvider.locale?.languageCode ??
        Localizations.localeOf(context).languageCode;
    final isTurkish = langCode == 'tr';
    final privacyUrl = isTurkish
        ? 'https://violencia19.github.io/Vantag/privacy-tr'
        : 'https://violencia19.github.io/Vantag/privacy-en';
    final termsUrl = isTurkish
        ? 'https://violencia19.github.io/Vantag/terms-tr'
        : 'https://violencia19.github.io/Vantag/terms-en';

    return Container(
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: context.appColors.cardBorder),
      ),
      child: Column(
        children: [
          _buildListTile(
            icon: CupertinoIcons.shield_fill,
            iconColor: AppColors.secondary,
            title: l10n.privacyPolicy,
            onTap: () => launchUrl(Uri.parse(privacyUrl)),
          ),
          _buildDivider(),
          _buildListTile(
            icon: CupertinoIcons.doc_text_fill,
            iconColor: AppColors.categoryEducation,
            title: l10n.termsOfService,
            onTap: () => launchUrl(Uri.parse(termsUrl)),
          ),
          _buildDivider(),
          _buildListTile(
            icon: CupertinoIcons.info_circle_fill,
            iconColor: AppColors.categoryOther,
            title: l10n.appVersion,
            trailing: Text(
              '1.0.0',
              style: TextStyle(
                color: context.appColors.textSecondary,
                fontSize: 14,
                fontWeight: FontWeight.w500,
              ),
            ),
            showArrow: false,
            onTap: _onVersionTap,
          ),
        ],
      ),
    );
  }

  // ==================== DANGER ZONE ====================
  Widget _buildDangerSection(AppLocalizations l10n) {
    return Container(
      decoration: BoxDecoration(
        color: context.appColors.error.withValues(alpha: 0.15),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: context.appColors.error.withValues(alpha: 0.4),
        ),
      ),
      child: _buildListTile(
        icon: CupertinoIcons.person_badge_minus_fill,
        iconColor: context.appColors.error,
        title: l10n.deleteAccount,
        titleColor: context.appColors.error,
        showArrow: false,
        onTap: _deleteAccount,
      ),
    );
  }

  // ==================== HELPER WIDGETS ====================
  Widget _buildSectionTitle(String title, {bool isDestructive = false}) {
    return Padding(
      padding: const EdgeInsets.only(left: 4),
      child: Text(
        title.toUpperCase(),
        style: TextStyle(
          fontSize: 12,
          fontWeight: FontWeight.w600,
          letterSpacing: 1.2,
          color: isDestructive
              ? context.appColors.error
              : context.appColors.textTertiary,
        ),
      ),
    );
  }

  Widget _buildCompactInfoCard({
    required IconData icon,
    required String title,
    required String value,
    bool highlight = false,
  }) {
    return Container(
      padding: const EdgeInsets.all(14),
      decoration: BoxDecoration(
        color: highlight
            ? context.appColors.primary.withValues(alpha: 0.1)
            : context.appColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: highlight
              ? context.appColors.primary.withValues(alpha: 0.3)
              : context.appColors.cardBorder,
        ),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(
                icon,
                size: 18,
                color: highlight
                    ? context.appColors.primary
                    : context.appColors.textTertiary,
              ),
              const SizedBox(width: 6),
              Expanded(
                child: Text(
                  title,
                  style: TextStyle(
                    fontSize: 11,
                    color: context.appColors.textTertiary,
                  ),
                  overflow: TextOverflow.ellipsis,
                ),
              ),
            ],
          ),
          const SizedBox(height: 8),
          Text(
            value,
            style: TextStyle(
              fontSize: 15,
              fontWeight: FontWeight.w600,
              color: highlight
                  ? context.appColors.primary
                  : context.appColors.textPrimary,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildListTile({
    required IconData icon,
    required Color iconColor,
    required String title,
    Color? titleColor,
    Widget? trailing,
    bool showArrow = true,
    VoidCallback? onTap,
    String? semanticLabel,
  }) {
    return Semantics(
      label: semanticLabel ?? title,
      button: onTap != null,
      child: Material(
        color: Colors.transparent,
        child: InkWell(
          onTap: onTap,
          borderRadius: BorderRadius.circular(16),
          child: Padding(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
            child: Row(
              children: [
                Container(
                  width: 36,
                  height: 36,
                  decoration: BoxDecoration(
                    color: iconColor.withValues(alpha: 0.15),
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Icon(icon, size: 20, color: iconColor),
                ),
                const SizedBox(width: 14),
                Expanded(
                  child: Text(
                    title,
                    style: TextStyle(
                      fontSize: 15,
                      fontWeight: FontWeight.w500,
                      color: titleColor ?? context.appColors.textPrimary,
                    ),
                  ),
                ),
                if (trailing != null) trailing,
                if (showArrow && trailing == null)
                  Icon(
                    CupertinoIcons.chevron_right,
                    size: 18,
                    color: context.appColors.textTertiary,
                  ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildDivider() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 16),
      child: Divider(height: 1, color: context.appColors.cardBorder),
    );
  }
}

/// Delete Account Confirmation Dialog
class _DeleteAccountDialog extends StatefulWidget {
  final String confirmWord;
  final AppLocalizations l10n;

  const _DeleteAccountDialog({required this.confirmWord, required this.l10n});

  @override
  State<_DeleteAccountDialog> createState() => _DeleteAccountDialogState();
}

class _DeleteAccountDialogState extends State<_DeleteAccountDialog> {
  final _textController = TextEditingController();
  bool _isConfirmed = false;

  @override
  void initState() {
    super.initState();
    _textController.addListener(_checkConfirmation);
  }

  @override
  void dispose() {
    _textController.dispose();
    super.dispose();
  }

  void _checkConfirmation() {
    final isConfirmed = _textController.text.trim() == widget.confirmWord;
    if (isConfirmed != _isConfirmed) {
      setState(() => _isConfirmed = isConfirmed);
    }
  }

  @override
  Widget build(BuildContext context) {
    final l10n = widget.l10n;

    return AlertDialog(
      backgroundColor: context.appColors.surface,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(24)),
      contentPadding: const EdgeInsets.fromLTRB(24, 24, 24, 16),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          // Warning Icon
          Container(
            width: 64,
            height: 64,
            decoration: BoxDecoration(
              color: context.appColors.error.withValues(alpha: 0.15),
              borderRadius: BorderRadius.circular(16),
            ),
            child: Icon(
              CupertinoIcons.exclamationmark_triangle_fill,
              color: context.appColors.error,
              size: 32,
            ),
          ),
          const SizedBox(height: 20),

          // Title
          Text(
            l10n.deleteAccountWarningTitle,
            style: TextStyle(
              fontSize: 20,
              fontWeight: FontWeight.w700,
              color: context.appColors.textPrimary,
            ),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 16),

          // Warning Message
          Text(
            l10n.deleteAccountWarningMessage,
            style: TextStyle(
              fontSize: 14,
              color: context.appColors.textSecondary,
              height: 1.5,
            ),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 24),

          // Confirmation TextField
          TextField(
            controller: _textController,
            decoration: InputDecoration(
              hintText: l10n.deleteAccountConfirmPlaceholder,
              hintStyle: TextStyle(
                color: context.appColors.textTertiary,
                fontSize: 14,
              ),
              filled: true,
              fillColor: context.appColors.background,
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(16),
                borderSide: BorderSide(color: context.appColors.cardBorder),
              ),
              enabledBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(16),
                borderSide: BorderSide(color: context.appColors.cardBorder),
              ),
              focusedBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(16),
                borderSide: BorderSide(
                  color: context.appColors.error,
                  width: 2,
                ),
              ),
              contentPadding: const EdgeInsets.symmetric(
                horizontal: 16,
                vertical: 14,
              ),
            ),
            style: TextStyle(
              color: context.appColors.textPrimary,
              fontSize: 14,
            ),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 8),

          // Hint text
          Text(
            '"${widget.confirmWord}"',
            style: TextStyle(
              fontSize: 12,
              color: context.appColors.textTertiary,
              fontStyle: FontStyle.italic,
            ),
          ),
          const SizedBox(height: 24),

          // Buttons
          Row(
            children: [
              Expanded(
                child: TextButton(
                  onPressed: () => Navigator.pop(context, false),
                  style: TextButton.styleFrom(
                    padding: const EdgeInsets.symmetric(vertical: 14),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(16),
                    ),
                  ),
                  child: Text(
                    l10n.cancel,
                    style: TextStyle(
                      color: context.appColors.textSecondary,
                      fontSize: 14,
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                ),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: ElevatedButton(
                  onPressed: _isConfirmed
                      ? () => Navigator.pop(context, true)
                      : null,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: context.appColors.error,
                    foregroundColor: context.appColors.textPrimary,
                    disabledBackgroundColor: context.appColors.error.withValues(
                      alpha: 0.3,
                    ),
                    disabledForegroundColor: context.appColors.textPrimary
                        .withValues(alpha: 0.5),
                    padding: const EdgeInsets.symmetric(vertical: 14),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(16),
                    ),
                    elevation: 0,
                  ),
                  child: Text(
                    l10n.deleteAccountButton,
                    style: const TextStyle(
                      fontSize: 14,
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }
}


--- FILE: lib/screens/notification_settings_screen.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../services/services.dart';
import '../theme/theme.dart';

class NotificationSettingsScreen extends StatefulWidget {
  const NotificationSettingsScreen({super.key});

  @override
  State<NotificationSettingsScreen> createState() =>
      _NotificationSettingsScreenState();
}

class _NotificationSettingsScreenState
    extends State<NotificationSettingsScreen> {
  final _notificationService = NotificationService();
  Map<String, bool> _settings = {};
  bool _isLoading = true;
  int _dailyReminderHour = 20;
  int _dailyReminderMinute = 0;
  int? _trialDaysRemaining;

  @override
  void initState() {
    super.initState();
    _loadSettings();
  }

  Future<void> _loadSettings() async {
    final settings = await _notificationService.getSettings();
    final dailyTime = await _notificationService.getDailyReminderTime();
    final trialDays = await _notificationService.getTrialDaysRemaining();

    if (mounted) {
      setState(() {
        _settings = settings;
        _dailyReminderHour = dailyTime?.hour ?? 20;
        _dailyReminderMinute = dailyTime?.minute ?? 0;
        _trialDaysRemaining = trialDays;
        _isLoading = false;
      });
    }
  }

  Future<void> _updateSetting(String key, bool value) async {
    setState(() => _settings[key] = value);
    await _notificationService.updateSetting(key, value);
  }

  Future<void> _selectDailyReminderTime() async {
    final picked = await showTimePicker(
      context: context,
      initialTime: TimeOfDay(
        hour: _dailyReminderHour,
        minute: _dailyReminderMinute,
      ),
    );

    if (picked != null && mounted) {
      setState(() {
        _dailyReminderHour = picked.hour;
        _dailyReminderMinute = picked.minute;
      });
      await _notificationService.scheduleDailyReminder(
        hour: picked.hour,
        minute: picked.minute,
      );
    }
  }

  String _formatTime(int hour, int minute) {
    final h = hour.toString().padLeft(2, '0');
    final m = minute.toString().padLeft(2, '0');
    return '$h:$m';
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    return Scaffold(
      backgroundColor: context.appColors.background,
      appBar: AppBar(
        backgroundColor: context.appColors.background,
        leading: IconButton(
          icon: Icon(
            CupertinoIcons.arrow_left,
            color: context.appColors.textPrimary,
          ),
          onPressed: () => Navigator.pop(context),
        ),
        title: Text(
          l10n.notificationSettings,
          style: TextStyle(
            fontSize: 20,
            fontWeight: FontWeight.w600,
            color: context.appColors.textPrimary,
          ),
        ),
      ),
      body: _isLoading
          ? const Center(child: CircularProgressIndicator())
          : SingleChildScrollView(
              padding: const EdgeInsets.all(20),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // Master switch
                  _buildMasterSwitch(context),
                  const SizedBox(height: 24),

                  // Notification types
                  if (_settings['enabled'] == true) ...[
                    Text(
                      l10n.notificationTypes,
                      style: TextStyle(
                        fontSize: 13,
                        fontWeight: FontWeight.w600,
                        color: context.appColors.textSecondary,
                        letterSpacing: 0.5,
                      ),
                    ),
                    const SizedBox(height: 12),

                    _buildSettingTile(
                      title: l10n.awarenessReminder,
                      subtitle: l10n.awarenessReminderDesc,
                      key: 'delayedAwareness',
                      icon: CupertinoIcons.lightbulb_fill,
                    ),
                    const SizedBox(height: 12),

                    _buildSettingTile(
                      title: l10n.giveUpCongrats,
                      subtitle: l10n.giveUpCongratsDesc,
                      key: 'reinforce',
                      icon: CupertinoIcons.star_fill,
                    ),
                    const SizedBox(height: 12),

                    _buildSettingTile(
                      title: l10n.streakReminder,
                      subtitle: l10n.streakReminderDesc,
                      key: 'streakReminder',
                      icon: CupertinoIcons.flame_fill,
                    ),
                    const SizedBox(height: 12),

                    _buildSettingTile(
                      title: l10n.weeklySummary,
                      subtitle: l10n.weeklySummaryDesc,
                      key: 'weeklyInsight',
                      icon: CupertinoIcons.chart_bar_fill,
                    ),
                    const SizedBox(height: 12),

                    _buildSettingTile(
                      title: l10n.subscriptionReminder,
                      subtitle: l10n.subscriptionReminderDesc,
                      key: 'subscriptionReminder',
                      icon: CupertinoIcons.calendar_badge_plus,
                    ),

                    const SizedBox(height: 24),

                    // Trial & Daily Reminders Section
                    Text(
                      l10n.trialReminderEnabled,
                      style: TextStyle(
                        fontSize: 13,
                        fontWeight: FontWeight.w600,
                        color: context.appColors.textSecondary,
                        letterSpacing: 0.5,
                      ),
                    ),
                    const SizedBox(height: 12),

                    // Trial days remaining indicator
                    if (_trialDaysRemaining != null &&
                        _trialDaysRemaining! > 0) ...[
                      Container(
                        padding: const EdgeInsets.all(16),
                        decoration: BoxDecoration(
                          gradient: LinearGradient(
                            colors: [
                              context.appColors.primary.withValues(alpha: 0.1),
                              context.appColors.accent.withValues(alpha: 0.1),
                            ],
                          ),
                          borderRadius: BorderRadius.circular(16),
                          border: Border.all(
                            color: context.appColors.primary.withValues(
                              alpha: 0.3,
                            ),
                          ),
                        ),
                        child: Row(
                          children: [
                            Icon(
                              CupertinoIcons.clock_fill,
                              size: 24,
                              color: context.appColors.primary,
                            ),
                            const SizedBox(width: 12),
                            Text(
                              l10n.trialDaysRemaining(_trialDaysRemaining!),
                              style: TextStyle(
                                fontSize: 15,
                                fontWeight: FontWeight.w600,
                                color: context.appColors.textPrimary,
                              ),
                            ),
                          ],
                        ),
                      ),
                      const SizedBox(height: 12),
                    ],

                    _buildSettingTile(
                      title: l10n.trialReminderEnabled,
                      subtitle: l10n.trialReminderDesc,
                      key: 'trialReminder',
                      icon: CupertinoIcons.gift_fill,
                    ),
                    const SizedBox(height: 12),

                    _buildSettingTile(
                      title: l10n.dailyReminderEnabled,
                      subtitle: l10n.dailyReminderDesc,
                      key: 'dailyReminder',
                      icon: CupertinoIcons.alarm_fill,
                    ),

                    // Daily reminder time picker
                    if (_settings['dailyReminder'] == true) ...[
                      const SizedBox(height: 12),
                      _buildTimePicker(l10n),
                    ],

                    const SizedBox(height: 32),

                    // Info note
                    Container(
                      padding: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        color: context.appColors.surface,
                        borderRadius: BorderRadius.circular(16),
                        border: Border.all(color: context.appColors.cardBorder),
                      ),
                      child: Row(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Icon(
                            CupertinoIcons.info_circle_fill,
                            size: 18,
                            color: context.appColors.textTertiary,
                          ),
                          const SizedBox(width: 12),
                          Expanded(
                            child: Text(
                              l10n.nightModeNotice,
                              style: TextStyle(
                                fontSize: 13,
                                color: context.appColors.textTertiary,
                                height: 1.4,
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ],
              ),
            ),
    );
  }

  Widget _buildMasterSwitch(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final isEnabled = _settings['enabled'] ?? true;

    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: isEnabled
            ? context.appColors.primary.withValues(alpha: 0.1)
            : context.appColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: isEnabled
              ? context.appColors.primary.withValues(alpha: 0.3)
              : context.appColors.cardBorder,
        ),
      ),
      child: Row(
        children: [
          Container(
            width: 48,
            height: 48,
            decoration: BoxDecoration(
              color: isEnabled
                  ? context.appColors.primary.withValues(alpha: 0.2)
                  : context.appColors.surfaceLight,
              borderRadius: BorderRadius.circular(16),
            ),
            child: Icon(
              isEnabled
                  ? CupertinoIcons.bell_fill
                  : CupertinoIcons.bell_slash_fill,
              size: 24,
              color: isEnabled
                  ? context.appColors.primary
                  : context.appColors.textTertiary,
            ),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  l10n.notifications,
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.w600,
                    color: context.appColors.textPrimary,
                  ),
                ),
                const SizedBox(height: 2),
                Text(
                  isEnabled ? l10n.on : l10n.off,
                  style: TextStyle(
                    fontSize: 13,
                    color: isEnabled
                        ? context.appColors.primary
                        : context.appColors.textTertiary,
                  ),
                ),
              ],
            ),
          ),
          Switch(
            value: isEnabled,
            onChanged: (value) => _updateSetting('enabled', value),
            activeTrackColor: context.appColors.primary,
          ),
        ],
      ),
    );
  }

  Widget _buildTimePicker(AppLocalizations l10n) {
    return GestureDetector(
      onTap: _selectDailyReminderTime,
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: context.appColors.surface,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: context.appColors.cardBorder),
        ),
        child: Row(
          children: [
            Container(
              width: 40,
              height: 40,
              decoration: BoxDecoration(
                color: context.appColors.surfaceLight,
                borderRadius: BorderRadius.circular(8),
              ),
              child: Icon(
                CupertinoIcons.clock,
                size: 20,
                color: context.appColors.textSecondary,
              ),
            ),
            const SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    l10n.dailyReminderTime,
                    style: TextStyle(
                      fontSize: 15,
                      fontWeight: FontWeight.w500,
                      color: context.appColors.textPrimary,
                    ),
                  ),
                  const SizedBox(height: 2),
                  Text(
                    _formatTime(_dailyReminderHour, _dailyReminderMinute),
                    style: TextStyle(
                      fontSize: 12,
                      color: context.appColors.primary,
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                ],
              ),
            ),
            Icon(
              CupertinoIcons.chevron_right,
              size: 20,
              color: context.appColors.textTertiary,
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildSettingTile({
    required String title,
    required String subtitle,
    required String key,
    required IconData icon,
  }) {
    final isEnabled = _settings[key] ?? true;

    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: context.appColors.cardBorder),
      ),
      child: Row(
        children: [
          Container(
            width: 40,
            height: 40,
            decoration: BoxDecoration(
              color: context.appColors.surfaceLight,
              borderRadius: BorderRadius.circular(8),
            ),
            child: Icon(
              icon,
              size: 20,
              color: isEnabled
                  ? context.appColors.textSecondary
                  : context.appColors.textTertiary,
            ),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  title,
                  style: TextStyle(
                    fontSize: 15,
                    fontWeight: FontWeight.w500,
                    color: isEnabled
                        ? context.appColors.textPrimary
                        : context.appColors.textTertiary,
                  ),
                ),
                const SizedBox(height: 2),
                Text(
                  subtitle,
                  style: TextStyle(
                    fontSize: 12,
                    color: context.appColors.textTertiary,
                  ),
                ),
              ],
            ),
          ),
          Switch(
            value: isEnabled,
            onChanged: (value) => _updateSetting(key, value),
            activeTrackColor: context.appColors.primary,
          ),
        ],
      ),
    );
  }
}


--- FILE: lib/screens/report_screen.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:fl_chart/fl_chart.dart';
import 'package:provider/provider.dart';
import '../models/models.dart';
import '../services/services.dart';
import '../theme/theme.dart';
import '../widgets/widgets.dart';
import '../providers/providers.dart';
import '../utils/category_utils.dart';
import 'package:vantag/l10n/app_localizations.dart';

enum TimeFilter { week, month, all }

class ReportScreen extends StatefulWidget {
  final UserProfile userProfile;

  const ReportScreen({super.key, required this.userProfile});

  @override
  State<ReportScreen> createState() => _ReportScreenState();
}

class _ReportScreenState extends State<ReportScreen>
    with TickerProviderStateMixin {
  final _subscriptionService = SubscriptionService();
  TimeFilter _selectedFilter = TimeFilter.month;
  double _totalSubscriptionAmount = 0;
  int _subscriptionCount = 0;

  // Animasyon kontrolleri
  late AnimationController _contentAnimController;
  late Animation<double> _contentAnimation;
  bool _showCharts = false;

  // Spending trend selected month
  int? _selectedMonthIndex;

  @override
  void initState() {
    super.initState();
    _setupAnimations();
    _loadSubscriptions();
  }

  void _setupAnimations() {
    _contentAnimController = AnimationController(
      vsync: this,
      duration: AppAnimations.long,
    );

    _contentAnimation = CurvedAnimation(
      parent: _contentAnimController,
      curve: AppAnimations.standardCurve,
    );

    // Provider zaten yüklendiyse animasyonu başlat
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _startContentAnimation();
    });
  }

  @override
  void dispose() {
    _contentAnimController.dispose();
    super.dispose();
  }

  Future<void> _loadSubscriptions() async {
    final subscriptions = await _subscriptionService.getActiveSubscriptions();
    final totalSub = await _subscriptionService.getTotalMonthlyAmount();

    if (mounted) {
      setState(() {
        _subscriptionCount = subscriptions.length;
        _totalSubscriptionAmount = totalSub;
      });
    }
  }

  Future<void> _startContentAnimation() async {
    await Future.delayed(AppAnimations.initialDelay);
    if (mounted) {
      _contentAnimController.forward();
      await Future.delayed(AppAnimations.medium);
      if (mounted) {
        setState(() => _showCharts = true);
      }
    }
  }

  List<Expense> _getFilteredExpenses(List<Expense> allExpenses) {
    final now = DateTime.now();
    final today = DateTime(now.year, now.month, now.day);

    return allExpenses.where((expense) {
      switch (_selectedFilter) {
        case TimeFilter.week:
          final weekAgo = today.subtract(const Duration(days: 7));
          return expense.date.isAfter(weekAgo);
        case TimeFilter.month:
          final monthAgo = DateTime(now.year, now.month - 1, now.day);
          return expense.date.isAfter(monthAgo);
        case TimeFilter.all:
          return true;
      }
    }).toList();
  }

  List<Expense> _getPreviousPeriodExpenses(List<Expense> allExpenses) {
    final now = DateTime.now();
    final today = DateTime(now.year, now.month, now.day);

    return allExpenses.where((expense) {
      switch (_selectedFilter) {
        case TimeFilter.week:
          final weekAgo = today.subtract(const Duration(days: 7));
          final twoWeeksAgo = today.subtract(const Duration(days: 14));
          return expense.date.isAfter(twoWeeksAgo) &&
              expense.date.isBefore(weekAgo);
        case TimeFilter.month:
          final monthAgo = DateTime(now.year, now.month - 1, now.day);
          final twoMonthsAgo = DateTime(now.year, now.month - 2, now.day);
          return expense.date.isAfter(twoMonthsAgo) &&
              expense.date.isBefore(monthAgo);
        case TimeFilter.all:
          return false;
      }
    }).toList();
  }

  /// Calculate hourly rate from user profile
  double _calculateHourlyRate() {
    final profile = widget.userProfile;
    final monthlyIncome = profile.monthlyIncome;
    final dailyHours = profile.dailyHours;
    final workDaysPerWeek = profile.workDaysPerWeek;

    // Monthly work hours = daily hours × work days per week × 4 weeks
    final monthlyHours = dailyHours * workDaysPerWeek * 4;
    if (monthlyHours <= 0) return 1;

    return monthlyIncome / monthlyHours;
  }

  /// Get last month's expenses for comparison
  List<Expense> _getLastMonthExpenses(List<Expense> allExpenses) {
    final now = DateTime.now();
    final firstDayThisMonth = DateTime(now.year, now.month, 1);
    final firstDayLastMonth = DateTime(now.year, now.month - 1, 1);

    return allExpenses.where((expense) {
      return expense.date.isAfter(
            firstDayLastMonth.subtract(const Duration(days: 1)),
          ) &&
          expense.date.isBefore(firstDayThisMonth);
    }).toList();
  }

  /// Get this month's expenses for comparison
  List<Expense> _getThisMonthExpenses(List<Expense> allExpenses) {
    final now = DateTime.now();
    final firstDayThisMonth = DateTime(now.year, now.month, 1);

    return allExpenses.where((expense) {
      return expense.date.isAfter(
        firstDayThisMonth.subtract(const Duration(days: 1)),
      );
    }).toList();
  }

  @override
  Widget build(BuildContext context) {
    // Provider'dan reaktif olarak veri al
    final financeProvider = context.watch<FinanceProvider>();
    final allExpenses = financeProvider.realExpenses;
    final isLoading = financeProvider.isLoading;
    final l10n = AppLocalizations.of(context);

    if (isLoading) {
      return Scaffold(
        backgroundColor: context.appColors.background,
        body: SafeArea(
          child: Padding(
            padding: const EdgeInsets.all(20),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  l10n.reports,
                  style: TextStyle(
                    fontSize: 28,
                    fontWeight: FontWeight.w700,
                    color: context.appColors.textPrimary,
                  ),
                ),
                const SizedBox(height: 24),
                const ListLoadingPlaceholder(itemCount: 4, itemHeight: 100),
              ],
            ),
          ),
        ),
      );
    }

    final expenses = _getFilteredExpenses(allExpenses);
    final hasData = expenses.isNotEmpty;

    return Scaffold(
      backgroundColor: context.appColors.background,
      body: SafeArea(
        child: CustomScrollView(
          slivers: [
            // Header
            SliverToBoxAdapter(
              child: Padding(
                padding: const EdgeInsets.fromLTRB(20, 16, 20, 0),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      l10n.reports,
                      style: TextStyle(
                        fontSize: 28,
                        fontWeight: FontWeight.w700,
                        color: context.appColors.textPrimary,
                      ),
                    ),
                    const SizedBox(height: 20),
                    _buildTimeFilter(l10n),
                  ],
                ),
              ),
            ),

            const SliverToBoxAdapter(child: SizedBox(height: 24)),

            // Content
            if (!hasData)
              SliverFillRemaining(
                hasScrollBody: false,
                child: EmptyState.reports(
                  message: l10n.notEnoughDataForReports,
                ),
              )
            else ...[
              // Summary cards with staggered animation
              SliverToBoxAdapter(
                child: FadeTransition(
                  opacity: _contentAnimation,
                  child: SlideTransition(
                    position: Tween<Offset>(
                      begin: const Offset(0, 0.1),
                      end: Offset.zero,
                    ).animate(_contentAnimation),
                    child: Padding(
                      padding: const EdgeInsets.symmetric(horizontal: 20),
                      child: _buildSummaryCards(expenses, l10n),
                    ),
                  ),
                ),
              ),

              const SliverToBoxAdapter(child: SizedBox(height: 24)),

              // NEW: Month Comparison Card (This Month vs Last Month)
              if (_selectedFilter == TimeFilter.month)
                SliverToBoxAdapter(
                  child: _AnimatedSlideIn(
                    delay: const Duration(milliseconds: 50),
                    child: Padding(
                      padding: const EdgeInsets.symmetric(horizontal: 20),
                      child: _buildMonthComparisonCard(allExpenses, l10n),
                    ),
                  ),
                ),

              if (_selectedFilter == TimeFilter.month)
                const SliverToBoxAdapter(child: SizedBox(height: 24)),

              // Sub-category comparison insight (PRO) (if any)
              if (_hasComparisonInsight(expenses, allExpenses))
                SliverToBoxAdapter(
                  child: _AnimatedSlideIn(
                    delay: const Duration(milliseconds: 100),
                    child: Padding(
                      padding: const EdgeInsets.symmetric(horizontal: 20),
                      child: LockedProFeature(
                        featureName: l10n.proFeatureTimeAnalysis,
                        child: _buildSubCategoryInsightCard(
                          expenses,
                          allExpenses,
                          l10n,
                        ),
                      ),
                    ),
                  ),
                ),

              if (_hasComparisonInsight(expenses, allExpenses))
                const SliverToBoxAdapter(child: SizedBox(height: 16)),

              // Category chart with animation (PRO - pie chart)
              SliverToBoxAdapter(
                child: Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 20),
                  child: LockedProFeature(
                    featureName: l10n.proFeatureCategoryBreakdown,
                    child: _buildAnimatedCategoryChart(expenses, l10n),
                  ),
                ),
              ),

              const SliverToBoxAdapter(child: SizedBox(height: 24)),

              // Category Budget Progress (PRO)
              SliverToBoxAdapter(
                child: _AnimatedSlideIn(
                  delay: const Duration(milliseconds: 150),
                  child: LockedProFeature(
                    featureName: l10n.proFeatureBudgetBreakdown,
                    child: _buildBudgetSection(l10n),
                  ),
                ),
              ),

              const SliverToBoxAdapter(child: SizedBox(height: 24)),

              // Category-based Work Hours Bar Chart (PRO)
              SliverToBoxAdapter(
                child: _AnimatedSlideIn(
                  delay: const Duration(milliseconds: 200),
                  child: Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 20),
                    child: LockedProFeature(
                      featureName: l10n.proFeatureTimeAnalysis,
                      child: _buildWorkHoursBarChart(expenses, l10n),
                    ),
                  ),
                ),
              ),

              const SliverToBoxAdapter(child: SizedBox(height: 24)),

              // Sub-category breakdown (PRO) (if any)
              if (_hasSubCategories(expenses))
                SliverToBoxAdapter(
                  child: _AnimatedSlideIn(
                    delay: const Duration(milliseconds: 250),
                    child: Padding(
                      padding: const EdgeInsets.symmetric(horizontal: 20),
                      child: LockedProFeature(
                        featureName: l10n.proFeatureCategoryBreakdown,
                        child: _buildSubCategoryBreakdown(expenses, l10n),
                      ),
                    ),
                  ),
                ),

              if (_hasSubCategories(expenses))
                const SliverToBoxAdapter(child: SizedBox(height: 24)),

              // Statistics with animation (PRO)
              SliverToBoxAdapter(
                child: _AnimatedSlideIn(
                  delay: const Duration(milliseconds: 300),
                  child: Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 20),
                    child: LockedProFeature(
                      featureName: l10n.proFeatureTimeAnalysis,
                      child: _buildStatistics(expenses, l10n),
                    ),
                  ),
                ),
              ),

              const SliverToBoxAdapter(child: SizedBox(height: 24)),

              // Smart Insight Cards (PRO)
              SliverToBoxAdapter(
                child: _AnimatedSlideIn(
                  delay: const Duration(milliseconds: 350),
                  child: Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 20),
                    child: LockedProFeature(
                      featureName: l10n.proFeatureSpendingTrends,
                      child: _buildSmartInsightCards(
                        expenses,
                        allExpenses,
                        l10n,
                      ),
                    ),
                  ),
                ),
              ),

              const SliverToBoxAdapter(child: SizedBox(height: 24)),

              // Trend with animation (PRO)
              if (_selectedFilter != TimeFilter.all)
                SliverToBoxAdapter(
                  child: _AnimatedSlideIn(
                    delay: const Duration(milliseconds: 400),
                    child: Padding(
                      padding: const EdgeInsets.symmetric(horizontal: 20),
                      child: LockedProFeature(
                        featureName: l10n.proFeatureSpendingTrends,
                        child: _buildTrendCard(expenses, allExpenses, l10n),
                      ),
                    ),
                  ),
                ),

              if (_selectedFilter != TimeFilter.all)
                const SliverToBoxAdapter(child: SizedBox(height: 24)),

              // Yearly Heatmap (PRO)
              SliverToBoxAdapter(
                child: _AnimatedSlideIn(
                  delay: const Duration(milliseconds: 450),
                  child: Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 20),
                    child: LockedProFeature(
                      featureName: l10n.proFeatureHeatmap,
                      child: _buildYearlyHeatmap(allExpenses, l10n),
                    ),
                  ),
                ),
              ),

              const SliverToBoxAdapter(child: SizedBox(height: 100)),
            ],
          ],
        ),
      ),
    );
  }

  Widget _buildTimeFilter(AppLocalizations l10n) {
    final isPremium = context.watch<ProProvider>().isPro;

    return Container(
      padding: const EdgeInsets.all(4),
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: context.appColors.cardBorder),
      ),
      child: Row(
        children: [
          _buildFilterButton(l10n.thisWeek, TimeFilter.week, isPremium),
          _buildFilterButton(l10n.thisMonth, TimeFilter.month, isPremium),
          _buildFilterButton(l10n.allTime, TimeFilter.all, isPremium),
        ],
      ),
    );
  }

  Widget _buildFilterButton(String label, TimeFilter filter, bool isPremium) {
    final isSelected = _selectedFilter == filter;
    // Lock month and all-time for free users
    final isLocked = !isPremium && filter != TimeFilter.week;
    final l10n = AppLocalizations.of(context);

    // Build semantic label based on state
    String semanticLabel;
    if (isLocked) {
      semanticLabel = l10n.lockedFilterPremium(label);
    } else if (isSelected) {
      semanticLabel = l10n.selectedFilter(label);
    } else {
      semanticLabel = l10n.selectTimeFilter(label);
    }

    return Expanded(
      child: Semantics(
        label: semanticLabel,
        button: true,
        selected: isSelected,
        child: GestureDetector(
          onTap: () {
            if (isLocked) {
              // Show upgrade dialog for locked filters
              UpgradeDialog.show(context, l10n.reportsPremiumOnly);
              return;
            }
            setState(() {
              _selectedFilter = filter;
              _showCharts = false;
            });
            // Kısa gecikme sonra chart'ları göster
            Future.delayed(AppAnimations.initialDelay, () {
              if (mounted) setState(() => _showCharts = true);
            });
          },
          child: AnimatedContainer(
            duration: AppAnimations.short,
            curve: AppAnimations.standardCurve,
            padding: const EdgeInsets.symmetric(vertical: 12),
            decoration: BoxDecoration(
              color: isSelected
                  ? context.appColors.primary
                  : Colors.transparent,
              borderRadius: BorderRadius.circular(8),
            ),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.center,
              mainAxisSize: MainAxisSize.min,
              children: [
                if (isLocked) ...[
                  Icon(
                    CupertinoIcons.lock,
                    size: 12,
                    color: context.appColors.textTertiary,
                  ),
                  const SizedBox(width: 4),
                ],
                Flexible(
                  child: Text(
                    label,
                    textAlign: TextAlign.center,
                    overflow: TextOverflow.ellipsis,
                    style: TextStyle(
                      fontSize: 13,
                      fontWeight: FontWeight.w600,
                      color: isLocked
                          ? context.appColors.textTertiary
                          : isSelected
                          ? context.appColors.background
                          : context.appColors.textSecondary,
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildSummaryCards(List<Expense> expenses, AppLocalizations l10n) {
    final stats = DecisionStats.fromExpenses(expenses);
    final totalSpent = stats.yesTotal;
    final totalSaved = stats.savedAmount;
    final totalCount = expenses.length;
    final savingsRate = totalCount > 0
        ? (stats.noCount / totalCount * 100)
        : 0.0;

    final spentHours = expenses
        .where((e) => e.decision == ExpenseDecision.yes)
        .fold<double>(0, (sum, e) => sum + e.hoursRequired);

    return Column(
      children: [
        Row(
          children: [
            Expanded(
              child: _AnimatedSummaryCard(
                delay: Duration.zero,
                title: l10n.totalSpent,
                value: totalSpent,
                suffix: ' TL',
                subtitle: l10n.hoursEquivalent(spentHours.toStringAsFixed(1)),
                color: context.appColors.decisionYes,
                icon: CupertinoIcons.cart_fill,
              ),
            ),
            const SizedBox(width: 12),
            Expanded(
              child: _AnimatedSummaryCard(
                delay: const Duration(milliseconds: 50),
                title: l10n.totalSaved,
                value: totalSaved,
                suffix: ' TL',
                subtitle: l10n.hoursRequired(
                  stats.savedHours.toStringAsFixed(1),
                ),
                color: context.appColors.decisionNo,
                icon: CupertinoIcons.shield_fill,
              ),
            ),
          ],
        ),
        const SizedBox(height: 12),
        Row(
          children: [
            Expanded(
              child: _AnimatedSummaryCard(
                delay: const Duration(milliseconds: 100),
                title: l10n.expenseCount,
                value: totalCount.toDouble(),
                isInteger: true,
                subtitle: l10n.boughtPassed(stats.yesCount, stats.noCount),
                color: context.appColors.info,
                icon: CupertinoIcons.doc_text_fill,
              ),
            ),
            const SizedBox(width: 12),
            Expanded(
              child: _AnimatedSummaryCard(
                delay: const Duration(milliseconds: 150),
                title: l10n.passRate,
                value: savingsRate,
                prefix: '%',
                isInteger: true,
                subtitle: savingsRate >= 50
                    ? l10n.doingGreat
                    : l10n.canDoBetter,
                color: savingsRate >= 50
                    ? context.appColors.success
                    : context.appColors.warning,
                icon: CupertinoIcons.arrow_up_right,
              ),
            ),
          ],
        ),
        if (_subscriptionCount > 0) ...[
          const SizedBox(height: 12),
          _AnimatedSummaryCard(
            delay: const Duration(milliseconds: 200),
            title: l10n.monthlySubscriptions,
            value: _totalSubscriptionAmount,
            suffix: ' TL',
            subtitle: l10n.activeSubscriptions(_subscriptionCount),
            color: context.appColors.primary,
            icon: CupertinoIcons.calendar,
            isFullWidth: true,
          ),
        ],
      ],
    );
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // NEW: MONTH COMPARISON CARD (This Month vs Last Month)
  // ═══════════════════════════════════════════════════════════════════════════

  Widget _buildMonthComparisonCard(
    List<Expense> allExpenses,
    AppLocalizations l10n,
  ) {
    final thisMonthExpenses = _getThisMonthExpenses(allExpenses);
    final lastMonthExpenses = _getLastMonthExpenses(allExpenses);

    final thisMonthTotal = thisMonthExpenses
        .where((e) => e.decision == ExpenseDecision.yes)
        .fold<double>(0, (sum, e) => sum + e.amount);

    final lastMonthTotal = lastMonthExpenses
        .where((e) => e.decision == ExpenseDecision.yes)
        .fold<double>(0, (sum, e) => sum + e.amount);

    final hasLastMonthData = lastMonthExpenses.isNotEmpty;
    final percentChange = hasLastMonthData && lastMonthTotal > 0
        ? ((thisMonthTotal - lastMonthTotal) / lastMonthTotal * 100)
        : 0.0;

    final isDecrease = percentChange < 0;
    final isNoChange = percentChange.abs() < 1;

    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: context.appColors.cardBorder),
        boxShadow: [
          BoxShadow(
            color: context.appColors.primary.withValues(alpha: 0.05),
            blurRadius: 20,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Container(
                width: 32,
                height: 32,
                decoration: BoxDecoration(
                  color: context.appColors.primary.withValues(alpha: 0.15),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Icon(
                  CupertinoIcons.chart_bar_alt_fill,
                  size: 18,
                  color: context.appColors.primary,
                ),
              ),
              const SizedBox(width: 12),
              Text(
                l10n.monthComparison,
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textPrimary,
                ),
              ),
            ],
          ),
          const SizedBox(height: 20),
          Row(
            children: [
              // This Month
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      l10n.thisMonth,
                      style: TextStyle(
                        fontSize: 12,
                        color: context.appColors.textSecondary,
                      ),
                    ),
                    const SizedBox(height: 4),
                    TweenAnimationBuilder<double>(
                      tween: Tween(begin: 0, end: thisMonthTotal),
                      duration: AppAnimations.counter,
                      builder: (context, value, child) {
                        return Text(
                          '${formatTurkishCurrency(value, decimalDigits: 0)} TL',
                          style: TextStyle(
                            fontSize: 24,
                            fontWeight: FontWeight.w700,
                            color: context.appColors.textPrimary,
                          ),
                        );
                      },
                    ),
                  ],
                ),
              ),
              // VS Arrow and Percentage
              Container(
                padding: const EdgeInsets.symmetric(
                  horizontal: 12,
                  vertical: 8,
                ),
                decoration: BoxDecoration(
                  color: isNoChange
                      ? context.appColors.surfaceLight
                      : (isDecrease
                            ? context.appColors.success.withValues(alpha: 0.15)
                            : context.appColors.warning.withValues(
                                alpha: 0.15,
                              )),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Column(
                  children: [
                    if (!hasLastMonthData)
                      Text(
                        l10n.noLastMonthData,
                        style: TextStyle(
                          fontSize: 10,
                          color: context.appColors.textTertiary,
                        ),
                        textAlign: TextAlign.center,
                      )
                    else ...[
                      Text(
                        isNoChange
                            ? l10n.noChange
                            : (isDecrease
                                  ? l10n.decreasedBy(
                                      percentChange.abs().toStringAsFixed(0),
                                    )
                                  : l10n.increasedBy(
                                      percentChange.abs().toStringAsFixed(0),
                                    )),
                        style: TextStyle(
                          fontSize: 12,
                          fontWeight: FontWeight.w600,
                          color: isNoChange
                              ? context.appColors.textSecondary
                              : (isDecrease
                                    ? context.appColors.success
                                    : context.appColors.warning),
                        ),
                      ),
                      const SizedBox(height: 2),
                      Text(
                        isNoChange
                            ? ''
                            : (isDecrease ? l10n.greatProgress : l10n.watchOut),
                        style: TextStyle(
                          fontSize: 10,
                          color: isDecrease
                              ? context.appColors.success
                              : context.appColors.warning,
                        ),
                      ),
                    ],
                  ],
                ),
              ),
              // Last Month
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.end,
                  children: [
                    Text(
                      l10n.lastMonth,
                      style: TextStyle(
                        fontSize: 12,
                        color: context.appColors.textSecondary,
                      ),
                    ),
                    const SizedBox(height: 4),
                    Text(
                      hasLastMonthData
                          ? '${formatTurkishCurrency(lastMonthTotal, decimalDigits: 0)} TL'
                          : '-',
                      style: TextStyle(
                        fontSize: 24,
                        fontWeight: FontWeight.w700,
                        color: hasLastMonthData
                            ? context.appColors.textSecondary
                            : context.appColors.textTertiary,
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // NEW: WORK HOURS BAR CHART
  // ═══════════════════════════════════════════════════════════════════════════

  Widget _buildWorkHoursBarChart(
    List<Expense> expenses,
    AppLocalizations l10n,
  ) {
    final hourlyRate = _calculateHourlyRate();

    // Calculate work hours per category
    final categoryHours = <String, double>{};
    for (final expense in expenses) {
      if (expense.decision == ExpenseDecision.yes) {
        final hours = expense.amount / hourlyRate;
        categoryHours[expense.category] =
            (categoryHours[expense.category] ?? 0) + hours;
      }
    }

    if (categoryHours.isEmpty) {
      return const SizedBox.shrink();
    }

    // Sort by hours descending
    final sortedCategories = categoryHours.entries.toList()
      ..sort((a, b) => b.value.compareTo(a.value));

    final totalHours = categoryHours.values.fold<double>(0, (a, b) => a + b);
    final maxHours = sortedCategories.first.value;

    final colors = [
      context.appColors.primary,
      context.appColors.warning,
      context.appColors.info,
      context.appColors.error,
      AppColors.categoryShopping,
      AppColors.achievementStreak,
      AppColors.achievementMystery,
      AppColors.categoryEntertainment,
      AppColors.categoryDefault,
    ];

    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: context.appColors.cardBorder),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Container(
                width: 32,
                height: 32,
                decoration: BoxDecoration(
                  color: context.appColors.warning.withValues(alpha: 0.15),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Icon(
                  CupertinoIcons.clock_fill,
                  size: 18,
                  color: context.appColors.warning,
                ),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      l10n.workHoursDistribution,
                      style: TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.w600,
                        color: context.appColors.textPrimary,
                      ),
                    ),
                    Text(
                      l10n.workHoursDistributionDesc,
                      style: TextStyle(
                        fontSize: 11,
                        color: context.appColors.textTertiary,
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
          const SizedBox(height: 20),
          ...sortedCategories.take(6).toList().asMap().entries.map((entry) {
            final index = entry.key;
            final category = entry.value.key;
            final hours = entry.value.value;
            final percent = totalHours > 0 ? (hours / totalHours * 100) : 0.0;
            final barWidth = maxHours > 0 ? hours / maxHours : 0.0;
            final color = colors[index % colors.length];
            final categoryIcon = ExpenseCategory.getIcon(category);

            return Padding(
              padding: EdgeInsets.only(
                bottom: index < sortedCategories.length - 1 ? 12 : 0,
              ),
              child: TweenAnimationBuilder<double>(
                tween: Tween(begin: 0, end: _showCharts ? 1.0 : 0),
                duration: Duration(milliseconds: 400 + (index * 80)),
                curve: Curves.easeOutCubic,
                builder: (context, animValue, child) {
                  return Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        children: [
                          Icon(categoryIcon, size: 18, color: color),
                          const SizedBox(width: 8),
                          Expanded(
                            child: Text(
                              CategoryUtils.getLocalizedName(context, category),
                              style: TextStyle(
                                fontSize: 13,
                                fontWeight: FontWeight.w500,
                                color: context.appColors.textPrimary,
                              ),
                            ),
                          ),
                          Text(
                            '${hours.toStringAsFixed(1)}h',
                            style: TextStyle(
                              fontSize: 13,
                              fontWeight: FontWeight.w600,
                              color: color,
                            ),
                          ),
                          const SizedBox(width: 8),
                          Container(
                            padding: const EdgeInsets.symmetric(
                              horizontal: 6,
                              vertical: 2,
                            ),
                            decoration: BoxDecoration(
                              color: color.withValues(alpha: 0.15),
                              borderRadius: BorderRadius.circular(4),
                            ),
                            child: Text(
                              '%${percent.toStringAsFixed(0)}',
                              style: TextStyle(
                                fontSize: 10,
                                fontWeight: FontWeight.w600,
                                color: color,
                              ),
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 6),
                      Container(
                        height: 8,
                        width: double.infinity,
                        decoration: BoxDecoration(
                          color: context.appColors.surfaceLight,
                          borderRadius: BorderRadius.circular(4),
                        ),
                        child: FractionallySizedBox(
                          alignment: Alignment.centerLeft,
                          widthFactor: barWidth * animValue,
                          child: Container(
                            decoration: BoxDecoration(
                              gradient: LinearGradient(
                                colors: [color, color.withValues(alpha: 0.7)],
                              ),
                              borderRadius: BorderRadius.circular(4),
                              boxShadow: [
                                BoxShadow(
                                  color: color.withValues(alpha: 0.3),
                                  blurRadius: 4,
                                  offset: const Offset(0, 2),
                                ),
                              ],
                            ),
                          ),
                        ),
                      ),
                    ],
                  );
                },
              ),
            );
          }),
          if (sortedCategories.length > 6) ...[
            const SizedBox(height: 8),
            Text(
              l10n.moreCategories(sortedCategories.length - 6),
              style: TextStyle(
                fontSize: 11,
                color: context.appColors.textTertiary,
              ),
            ),
          ],
        ],
      ),
    );
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // NEW: SMART INSIGHT CARDS
  // ═══════════════════════════════════════════════════════════════════════════

  Widget _buildSmartInsightCards(
    List<Expense> expenses,
    List<Expense> allExpenses,
    AppLocalizations l10n,
  ) {
    final hourlyRate = _calculateHourlyRate();

    // 1. Most Expensive Day
    final dayTotals = <int, List<double>>{};
    for (final expense in expenses) {
      if (expense.decision == ExpenseDecision.yes) {
        final weekday = expense.date.weekday;
        dayTotals[weekday] ??= [];
        dayTotals[weekday]!.add(expense.amount);
      }
    }

    String? mostExpensiveDay;
    double mostExpensiveDayAvg = 0;
    if (dayTotals.isNotEmpty) {
      final dayAverages = dayTotals.map((day, amounts) {
        return MapEntry(day, amounts.reduce((a, b) => a + b) / amounts.length);
      });
      final maxEntry = dayAverages.entries.reduce(
        (a, b) => a.value > b.value ? a : b,
      );
      mostExpensiveDay = _getDayName(maxEntry.key, l10n);
      mostExpensiveDayAvg = maxEntry.value;
    }

    // 2. Most Passed Category
    final passedCounts = <String, int>{};
    for (final expense in expenses) {
      if (expense.decision == ExpenseDecision.no) {
        passedCounts[expense.category] =
            (passedCounts[expense.category] ?? 0) + 1;
      }
    }
    String? mostPassedCategory;
    int mostPassedCount = 0;
    if (passedCounts.isNotEmpty) {
      final maxEntry = passedCounts.entries.reduce(
        (a, b) => a.value > b.value ? a : b,
      );
      mostPassedCategory = maxEntry.key;
      mostPassedCount = maxEntry.value;
    }

    // 3. Savings Opportunity (highest category)
    final categoryTotals = <String, double>{};
    for (final expense in expenses) {
      if (expense.decision == ExpenseDecision.yes) {
        categoryTotals[expense.category] =
            (categoryTotals[expense.category] ?? 0) + expense.amount;
      }
    }
    String? highestCategory;
    double savingsHours = 0;
    if (categoryTotals.isNotEmpty) {
      final maxEntry = categoryTotals.entries.reduce(
        (a, b) => a.value > b.value ? a : b,
      );
      highestCategory = maxEntry.key;
      // 20% savings in hours
      savingsHours = hourlyRate > 0 ? (maxEntry.value * 0.2) / hourlyRate : 0.0;
    }

    // 4. Weekly Trend (last 4 weeks)
    final weeklyTotals = <int, double>{};
    final now = DateTime.now();
    for (int i = 0; i < 4; i++) {
      final weekStart = now.subtract(Duration(days: 7 * (i + 1)));
      final weekEnd = now.subtract(Duration(days: 7 * i));
      final weekTotal = allExpenses
          .where(
            (e) =>
                e.decision == ExpenseDecision.yes &&
                e.date.isAfter(weekStart) &&
                e.date.isBefore(weekEnd),
          )
          .fold<double>(0, (sum, e) => sum + e.amount);
      weeklyTotals[i] = weekTotal;
    }

    String trendArrows = '';
    String trendDescription = l10n.noTrendData;
    if (weeklyTotals.length >= 2) {
      int upCount = 0;
      int downCount = 0;
      for (int i = 0; i < 3; i++) {
        final current = weeklyTotals[i] ?? 0;
        final previous = weeklyTotals[i + 1] ?? 0;
        if (current > previous) {
          trendArrows = '↑$trendArrows';
          upCount++;
        } else if (current < previous) {
          trendArrows = '↓$trendArrows';
          downCount++;
        } else {
          trendArrows = '→$trendArrows';
        }
      }
      if (downCount >= 2) {
        trendDescription = l10n.overallDecreasing;
      } else if (upCount >= 2) {
        trendDescription = l10n.overallIncreasing;
      } else {
        trendDescription = l10n.stableTrend;
      }
    }

    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: context.appColors.cardBorder),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Container(
                width: 32,
                height: 32,
                decoration: BoxDecoration(
                  color: context.appColors.secondary.withValues(alpha: 0.15),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Icon(
                  CupertinoIcons.lightbulb_fill,
                  size: 18,
                  color: context.appColors.secondary,
                ),
              ),
              const SizedBox(width: 12),
              Text(
                l10n.smartInsights,
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textPrimary,
                ),
              ),
            ],
          ),
          const SizedBox(height: 16),
          // 2x2 Grid of insight cards
          Row(
            children: [
              Expanded(
                child: _InsightMiniCard(
                  icon: CupertinoIcons.calendar,
                  iconColor: context.appColors.warning,
                  title: l10n.mostExpensiveDay,
                  value: mostExpensiveDay != null
                      ? l10n.mostExpensiveDayValue(
                          mostExpensiveDay,
                          formatTurkishCurrency(
                            mostExpensiveDayAvg,
                            decimalDigits: 0,
                          ),
                        )
                      : '-',
                ),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: _InsightMiniCard(
                  icon: CupertinoIcons.nosign,
                  iconColor: context.appColors.success,
                  title: l10n.mostPassedCategory,
                  value: mostPassedCategory != null
                      ? l10n.mostPassedCategoryValue(
                          CategoryUtils.getLocalizedName(
                            context,
                            mostPassedCategory,
                          ),
                          mostPassedCount,
                        )
                      : '-',
                ),
              ),
            ],
          ),
          const SizedBox(height: 12),
          Row(
            children: [
              Expanded(
                child: _InsightMiniCard(
                  icon: CupertinoIcons.money_dollar_circle_fill,
                  iconColor: context.appColors.primary,
                  title: l10n.savingsOpportunity,
                  value: highestCategory != null
                      ? l10n.savingsOpportunityValue(
                          CategoryUtils.getLocalizedName(
                            context,
                            highestCategory,
                          ),
                          savingsHours.toStringAsFixed(1),
                        )
                      : '-',
                ),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: _InsightMiniCard(
                  icon: CupertinoIcons.chart_bar_alt_fill,
                  iconColor: context.appColors.info,
                  title: l10n.weeklyTrend,
                  value: trendArrows.isNotEmpty
                      ? l10n.weeklyTrendValue('$trendArrows $trendDescription')
                      : l10n.noTrendData,
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  String _getDayName(int weekday, AppLocalizations l10n) {
    switch (weekday) {
      case 1:
        return l10n.weekdayMonday;
      case 2:
        return l10n.weekdayTuesday;
      case 3:
        return l10n.weekdayWednesday;
      case 4:
        return l10n.weekdayThursday;
      case 5:
        return l10n.weekdayFriday;
      case 6:
        return l10n.weekdaySaturday;
      case 7:
        return l10n.weekdaySunday;
      default:
        return '';
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // SPENDING TREND CHART (Area Chart)
  // ═══════════════════════════════════════════════════════════════════════════

  Widget _buildYearlyHeatmap(List<Expense> allExpenses, AppLocalizations l10n) {
    // Get last 12 months data
    final now = DateTime.now();
    final monthlyData = <int, _MonthData>{};

    // Initialize last 12 months
    for (int i = 11; i >= 0; i--) {
      final monthDate = DateTime(now.year, now.month - i, 1);
      final normalizedMonth = DateTime(monthDate.year, monthDate.month, 1);
      monthlyData[11 - i] = _MonthData(
        month: normalizedMonth.month,
        year: normalizedMonth.year,
        total: 0,
        count: 0,
      );
    }

    // Group expenses by month
    for (final expense in allExpenses) {
      if (expense.decision == ExpenseDecision.yes) {
        // Find which index this expense belongs to
        for (int i = 0; i < 12; i++) {
          final data = monthlyData[i]!;
          if (expense.date.year == data.year &&
              expense.date.month == data.month) {
            monthlyData[i] = _MonthData(
              month: data.month,
              year: data.year,
              total: data.total + expense.amount,
              count: data.count + 1,
            );
            break;
          }
        }
      }
    }

    // Find max for scaling
    final maxAmount = monthlyData.values
        .map((d) => d.total)
        .fold(0.0, (a, b) => a > b ? a : b);
    final safeMax = maxAmount > 0 ? maxAmount : 1.0;

    // Create chart spots
    final spots = <FlSpot>[];
    for (int i = 0; i < 12; i++) {
      spots.add(FlSpot(i.toDouble(), monthlyData[i]!.total));
    }

    // Get month names
    final monthNames = [
      l10n.monthJan,
      l10n.monthFeb,
      l10n.monthMar,
      l10n.monthApr,
      l10n.monthMay,
      l10n.monthJun,
      l10n.monthJul,
      l10n.monthAug,
      l10n.monthSep,
      l10n.monthOct,
      l10n.monthNov,
      l10n.monthDec,
    ];

    // Currency symbol
    final currencyProvider = context.read<CurrencyProvider>();
    final symbol = currencyProvider.currency.symbol;

    // Selected month info
    String? selectedMonthInfo;
    if (_selectedMonthIndex != null &&
        _selectedMonthIndex! >= 0 &&
        _selectedMonthIndex! < 12) {
      final data = monthlyData[_selectedMonthIndex!]!;
      final monthName = monthNames[data.month - 1];
      selectedMonthInfo = l10n.selectedMonthExpenses(
        monthName,
        '$symbol${formatTurkishCurrency(data.total, decimalDigits: 0)}',
        data.count,
      );
    }

    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: context.appColors.cardBorder),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Header
          Row(
            children: [
              Container(
                width: 32,
                height: 32,
                decoration: BoxDecoration(
                  color: context.appColors.primary.withValues(alpha: 0.15),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Icon(
                  CupertinoIcons.chart_bar_alt_fill,
                  size: 18,
                  color: context.appColors.primary,
                ),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        Text(
                          l10n.yearlyHeatmap,
                          style: TextStyle(
                            fontSize: 16,
                            fontWeight: FontWeight.w600,
                            color: context.appColors.textPrimary,
                          ),
                        ),
                        const SizedBox(width: 8),
                        _ProBadge(),
                      ],
                    ),
                    Text(
                      l10n.yearlyHeatmapDesc,
                      style: TextStyle(
                        fontSize: 11,
                        color: context.appColors.textTertiary,
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
          const SizedBox(height: 20),

          // Area Chart
          SizedBox(
            height: 180,
            child: LineChart(
              LineChartData(
                gridData: FlGridData(
                  show: true,
                  drawVerticalLine: false,
                  horizontalInterval: safeMax / 4,
                  getDrawingHorizontalLine: (value) {
                    return FlLine(
                      color: context.appColors.cardBorder,
                      strokeWidth: 0.5,
                    );
                  },
                ),
                titlesData: FlTitlesData(
                  leftTitles: AxisTitles(
                    sideTitles: SideTitles(
                      showTitles: true,
                      reservedSize: 45,
                      getTitlesWidget: (value, meta) {
                        if (value == 0) return const SizedBox.shrink();
                        return Padding(
                          padding: const EdgeInsets.only(right: 8),
                          child: Text(
                            _formatAmount(value),
                            style: TextStyle(
                              fontSize: 10,
                              color: context.appColors.textTertiary,
                            ),
                          ),
                        );
                      },
                    ),
                  ),
                  bottomTitles: AxisTitles(
                    sideTitles: SideTitles(
                      showTitles: true,
                      reservedSize: 28,
                      interval: 1,
                      getTitlesWidget: (value, meta) {
                        final index = value.toInt();
                        if (index < 0 || index >= 12) {
                          return const SizedBox.shrink();
                        }
                        // Show every other month to prevent crowding
                        if (index % 2 != 0 && index != 11) {
                          return const SizedBox.shrink();
                        }
                        final data = monthlyData[index]!;
                        return Padding(
                          padding: const EdgeInsets.only(top: 8),
                          child: Text(
                            monthNames[data.month - 1],
                            style: TextStyle(
                              fontSize: 10,
                              color: _selectedMonthIndex == index
                                  ? context.appColors.primary
                                  : context.appColors.textTertiary,
                              fontWeight: _selectedMonthIndex == index
                                  ? FontWeight.w600
                                  : FontWeight.w400,
                            ),
                          ),
                        );
                      },
                    ),
                  ),
                  topTitles: const AxisTitles(
                    sideTitles: SideTitles(showTitles: false),
                  ),
                  rightTitles: const AxisTitles(
                    sideTitles: SideTitles(showTitles: false),
                  ),
                ),
                borderData: FlBorderData(show: false),
                minX: 0,
                maxX: 11,
                minY: 0,
                maxY: safeMax * 1.1,
                lineTouchData: LineTouchData(
                  enabled: true,
                  touchTooltipData: LineTouchTooltipData(
                    getTooltipColor: (touchedSpot) =>
                        context.appColors.cardBackground,
                    tooltipBorder: BorderSide(
                      color: context.appColors.primary,
                      width: 1,
                    ),
                    getTooltipItems: (touchedSpots) {
                      return touchedSpots.map((spot) {
                        final index = spot.x.toInt();
                        final data = monthlyData[index]!;
                        final monthName = monthNames[data.month - 1];
                        return LineTooltipItem(
                          '$monthName\n$symbol${formatTurkishCurrency(data.total, decimalDigits: 0)}',
                          TextStyle(
                            color: context.appColors.textPrimary,
                            fontWeight: FontWeight.w600,
                            fontSize: 12,
                          ),
                        );
                      }).toList();
                    },
                  ),
                  touchCallback: (event, response) {
                    if (event is FlTapUpEvent &&
                        response?.lineBarSpots != null) {
                      final spot = response!.lineBarSpots!.first;
                      setState(() {
                        _selectedMonthIndex = spot.x.toInt();
                      });
                    }
                  },
                  handleBuiltInTouches: true,
                ),
                lineBarsData: [
                  LineChartBarData(
                    spots: spots,
                    isCurved: true,
                    curveSmoothness: 0.3,
                    color: context.appColors.primary,
                    barWidth: 3,
                    isStrokeCapRound: true,
                    dotData: FlDotData(
                      show: true,
                      getDotPainter: (spot, percent, bar, index) {
                        final isSelected = _selectedMonthIndex == index;
                        return FlDotCirclePainter(
                          radius: isSelected ? 6 : 4,
                          color: isSelected
                              ? context.appColors.primary
                              : context.appColors.primary.withValues(
                                  alpha: 0.8,
                                ),
                          strokeWidth: isSelected ? 2 : 0,
                          strokeColor: context.appColors.textPrimary,
                        );
                      },
                    ),
                    belowBarData: BarAreaData(
                      show: true,
                      gradient: LinearGradient(
                        begin: Alignment.topCenter,
                        end: Alignment.bottomCenter,
                        colors: [
                          context.appColors.primary.withValues(alpha: 0.4),
                          context.appColors.primary.withValues(alpha: 0.1),
                          context.appColors.primary.withValues(alpha: 0.0),
                        ],
                        stops: const [0.0, 0.5, 1.0],
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),

          // Selected month info or hint
          if (selectedMonthInfo != null) ...[
            const SizedBox(height: 16),
            Container(
              width: double.infinity,
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: context.appColors.primary.withValues(alpha: 0.1),
                borderRadius: BorderRadius.circular(8),
                border: Border.all(
                  color: context.appColors.primary.withValues(alpha: 0.3),
                ),
              ),
              child: Text(
                selectedMonthInfo,
                style: TextStyle(
                  fontSize: 13,
                  fontWeight: FontWeight.w500,
                  color: context.appColors.textPrimary,
                ),
                textAlign: TextAlign.center,
              ),
            ),
          ] else ...[
            const SizedBox(height: 12),
            Center(
              child: Text(
                l10n.tapMonthForDetails,
                style: TextStyle(
                  fontSize: 11,
                  color: context.appColors.textTertiary,
                ),
              ),
            ),
          ],
        ],
      ),
    );
  }

  /// Format amount with K/M suffix
  String _formatAmount(double value) {
    if (value >= 1000000) {
      return '${(value / 1000000).toStringAsFixed(1)}M';
    } else if (value >= 1000) {
      return '${(value / 1000).toStringAsFixed(1)}K';
    }
    return value.toStringAsFixed(0);
  }

  /// Build the category budget progress section
  Widget _buildBudgetSection(AppLocalizations l10n) {
    return Consumer<CategoryBudgetProvider>(
      builder: (context, budgetProvider, _) {
        // Initialize budget provider if not done
        if (budgetProvider.budgets.isEmpty && !budgetProvider.isLoading) {
          final financeProvider = context.read<FinanceProvider>();
          final now = DateTime.now();
          WidgetsBinding.instance.addPostFrameCallback((_) {
            budgetProvider.initialize(financeProvider.expenses);
            budgetProvider.setMonth(now.month, now.year);
          });
        }

        return Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Section header
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 20),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Row(
                    children: [
                      Icon(
                        CupertinoIcons.creditcard_fill,
                        size: 20,
                        color: context.appColors.primary,
                      ),
                      const SizedBox(width: 8),
                      Text(
                        l10n.budgetProgress,
                        style: TextStyle(
                          fontSize: 16,
                          fontWeight: FontWeight.w600,
                          color: context.appColors.textPrimary,
                        ),
                      ),
                    ],
                  ),
                  Semantics(
                    label: l10n.addBudget,
                    button: true,
                    child: GestureDetector(
                      onTap: () => CreateBudgetSheet.show(context),
                      child: Container(
                        padding: const EdgeInsets.symmetric(
                          horizontal: 12,
                          vertical: 6,
                        ),
                        decoration: BoxDecoration(
                          color: context.appColors.primary.withValues(
                            alpha: 0.1,
                          ),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: Row(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            Icon(
                              CupertinoIcons.plus,
                              size: 16,
                              color: context.appColors.primary,
                            ),
                            const SizedBox(width: 4),
                            Text(
                              l10n.addBudget,
                              style: TextStyle(
                                fontSize: 12,
                                fontWeight: FontWeight.w600,
                                color: context.appColors.primary,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            ),
            const SizedBox(height: 16),

            // Budget cards or empty state
            if (budgetProvider.isLoading)
              const Center(
                child: Padding(
                  padding: EdgeInsets.all(20),
                  child: CircularProgressIndicator(),
                ),
              )
            else if (!budgetProvider.hasBudgets)
              BudgetSummaryCard(
                onAddBudget: () => CreateBudgetSheet.show(context),
              )
            else
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 20),
                child: Column(
                  children: budgetProvider.budgets
                      .asMap()
                      .entries
                      .map(
                        (entry) => Padding(
                          padding: EdgeInsets.only(
                            bottom:
                                entry.key < budgetProvider.budgets.length - 1
                                ? 12
                                : 0,
                          ),
                          child: CategoryBudgetCard(
                            budget: entry.value,
                            animationIndex: entry.key,
                            onTap: () {
                              CreateBudgetSheet.show(
                                context,
                                existingBudget: entry.value.budget,
                              );
                            },
                          ),
                        ),
                      )
                      .toList(),
                ),
              ),
          ],
        );
      },
    );
  }

  Widget _buildAnimatedCategoryChart(
    List<Expense> expenses,
    AppLocalizations l10n,
  ) {
    final categoryTotals = <String, double>{};
    for (final expense in expenses) {
      if (expense.decision == ExpenseDecision.yes) {
        categoryTotals[expense.category] =
            (categoryTotals[expense.category] ?? 0) + expense.amount;
      }
    }

    if (categoryTotals.isEmpty) {
      return _AnimatedSlideIn(
        delay: const Duration(milliseconds: 200),
        child: Container(
          padding: const EdgeInsets.all(24),
          decoration: BoxDecoration(
            color: context.appColors.surface,
            borderRadius: BorderRadius.circular(16),
            border: Border.all(color: context.appColors.cardBorder),
          ),
          child: Center(
            child: Text(
              l10n.noExpenses,
              style: TextStyle(color: context.appColors.textSecondary),
            ),
          ),
        ),
      );
    }

    final sortedCategories = categoryTotals.entries.toList()
      ..sort((a, b) => b.value.compareTo(a.value));

    final total = categoryTotals.values.fold<double>(0, (a, b) => a + b);

    final colors = [
      context.appColors.primary,
      context.appColors.warning,
      context.appColors.info,
      context.appColors.error,
      AppColors.categoryShopping,
      AppColors.achievementStreak,
      AppColors.achievementMystery,
      AppColors.categoryEntertainment,
      AppColors.categoryDefault,
    ];

    return _AnimatedSlideIn(
      delay: const Duration(milliseconds: 200),
      child: Container(
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: context.appColors.surface,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: context.appColors.cardBorder),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              l10n.categoryDistribution,
              style: TextStyle(
                fontSize: 16,
                fontWeight: FontWeight.w600,
                color: context.appColors.textPrimary,
              ),
            ),
            const SizedBox(height: 20),
            SizedBox(
              height: 180,
              child: Row(
                children: [
                  // Animated Pie chart
                  Expanded(
                    child: RepaintBoundary(
                      child: PieChart(
                        PieChartData(
                          sectionsSpace: 2,
                          centerSpaceRadius: 40,
                          // Clockwise animasyon
                          startDegreeOffset: -90,
                          sections: _showCharts
                              ? sortedCategories.asMap().entries.map((entry) {
                                  final index = entry.key;
                                  final value = entry.value.value;
                                  final percentage = total > 0
                                      ? (value / total * 100)
                                      : 0.0;
                                  final isTop = index == 0;

                                  return PieChartSectionData(
                                    value: value,
                                    title: isTop
                                        ? '%${percentage.toStringAsFixed(0)}'
                                        : '',
                                    color: colors[index % colors.length],
                                    radius: isTop ? 50 : 40,
                                    titleStyle: const TextStyle(
                                      fontSize: 12,
                                      fontWeight: FontWeight.bold,
                                      color: Colors.white,
                                    ),
                                  );
                                }).toList()
                              : [
                                  PieChartSectionData(
                                    value: 1,
                                    title: '',
                                    color: context.appColors.surfaceLight,
                                    radius: 40,
                                  ),
                                ],
                        ),
                      ),
                    ),
                  ),
                  const SizedBox(width: 16),
                  // Animated Legend
                  Expanded(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: sortedCategories
                          .take(5)
                          .toList()
                          .asMap()
                          .entries
                          .map((entry) {
                            final index = entry.key;
                            final category = entry.value.key;
                            final value = entry.value.value;
                            final percentage = total > 0
                                ? (value / total * 100)
                                : 0.0;
                            final isTop = index == 0;

                            return TweenAnimationBuilder<double>(
                              tween: Tween<double>(
                                begin: 0,
                                end: _showCharts ? 1.0 : 0,
                              ),
                              duration: Duration(
                                milliseconds: 300 + (index * 50),
                              ),
                              curve: AppAnimations.standardCurve,
                              builder: (context, animValue, child) {
                                return Opacity(
                                  opacity: animValue,
                                  child: Transform.translate(
                                    offset: Offset(20 * (1 - animValue), 0),
                                    child: Padding(
                                      padding: const EdgeInsets.symmetric(
                                        vertical: 4,
                                      ),
                                      child: Row(
                                        children: [
                                          // Soft glow for top category
                                          Container(
                                            width: 10,
                                            height: 10,
                                            decoration: BoxDecoration(
                                              color:
                                                  colors[index % colors.length],
                                              borderRadius:
                                                  BorderRadius.circular(2),
                                              boxShadow: isTop
                                                  ? [
                                                      BoxShadow(
                                                        color:
                                                            colors[index %
                                                                    colors
                                                                        .length]
                                                                .withValues(
                                                                  alpha: 0.5,
                                                                ),
                                                        blurRadius: 6,
                                                        spreadRadius: 1,
                                                      ),
                                                    ]
                                                  : null,
                                            ),
                                          ),
                                          const SizedBox(width: 8),
                                          Expanded(
                                            child: Text(
                                              CategoryUtils.getLocalizedName(
                                                context,
                                                category,
                                              ),
                                              style: TextStyle(
                                                fontSize: 12,
                                                fontWeight: isTop
                                                    ? FontWeight.w600
                                                    : FontWeight.w400,
                                                color: isTop
                                                    ? context
                                                          .appColors
                                                          .textPrimary
                                                    : context
                                                          .appColors
                                                          .textSecondary,
                                              ),
                                              overflow: TextOverflow.ellipsis,
                                            ),
                                          ),
                                          Text(
                                            '%${percentage.toStringAsFixed(0)}',
                                            style: TextStyle(
                                              fontSize: 12,
                                              fontWeight: FontWeight.w500,
                                              color: isTop
                                                  ? colors[index %
                                                        colors.length]
                                                  : context
                                                        .appColors
                                                        .textTertiary,
                                            ),
                                          ),
                                        ],
                                      ),
                                    ),
                                  ),
                                );
                              },
                            );
                          })
                          .toList(),
                    ),
                  ),
                ],
              ),
            ),
            if (sortedCategories.length > 5) ...[
              const SizedBox(height: 8),
              Text(
                l10n.moreCategories(sortedCategories.length - 5),
                style: TextStyle(
                  fontSize: 11,
                  color: context.appColors.textTertiary,
                ),
              ),
            ],
          ],
        ),
      ),
    );
  }

  /// Alt kategori karşılaştırmalı insight
  ({String subCategory, double changePercent, bool isIncrease})?
  _getSubCategoryComparisonInsight(
    List<Expense> currentExpenses,
    List<Expense> previousExpenses,
  ) {
    if (_selectedFilter == TimeFilter.all) return null;
    if (previousExpenses.isEmpty) return null;

    Map<String, double> calculateSubCategoryTotals(List<Expense> expenses) {
      final totals = <String, double>{};
      for (final expense in expenses) {
        if (expense.decision != ExpenseDecision.yes) continue;
        if (expense.subCategory == null || expense.subCategory!.isEmpty) {
          continue;
        }
        totals[expense.subCategory!] =
            (totals[expense.subCategory!] ?? 0) + expense.amount;
      }
      return totals;
    }

    final currentTotals = calculateSubCategoryTotals(currentExpenses);
    final previousTotals = calculateSubCategoryTotals(previousExpenses);

    if (currentTotals.isEmpty && previousTotals.isEmpty) return null;

    String? bestSubCategory;
    double bestChangePercent = 0;
    bool bestIsIncrease = false;

    for (final entry in currentTotals.entries) {
      final subCat = entry.key;
      final currentAmount = entry.value;
      final previousAmount = previousTotals[subCat] ?? 0;

      if (previousAmount > 0) {
        final changePercent =
            ((currentAmount - previousAmount) / previousAmount) * 100;
        if (changePercent.abs() > bestChangePercent.abs()) {
          bestSubCategory = subCat;
          bestChangePercent = changePercent;
          bestIsIncrease = changePercent > 0;
        }
      }
    }

    if (bestSubCategory == null || bestChangePercent.abs() < 5) return null;

    return (
      subCategory: bestSubCategory,
      changePercent: bestChangePercent.abs(),
      isIncrease: bestIsIncrease,
    );
  }

  Widget _buildSubCategoryInsightCard(
    List<Expense> expenses,
    List<Expense> allExpenses,
    AppLocalizations l10n,
  ) {
    final previousExpenses = _getPreviousPeriodExpenses(allExpenses);
    final insight = _getSubCategoryComparisonInsight(
      expenses,
      previousExpenses,
    );
    if (insight == null) return const SizedBox.shrink();

    final periodLabel = switch (_selectedFilter) {
      TimeFilter.week => l10n.thisWeek,
      TimeFilter.month => l10n.thisMonth,
      TimeFilter.all => '',
    };

    final previousLabel = switch (_selectedFilter) {
      TimeFilter.week => l10n.periodWeek,
      TimeFilter.month => l10n.periodMonth,
      TimeFilter.all => '',
    };

    final changeText = insight.isIncrease ? l10n.increased : l10n.decreased;
    final accentColor = insight.isIncrease
        ? context.appColors.warning
        : context.appColors.success;

    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [
            accentColor.withValues(alpha: 0.08),
            accentColor.withValues(alpha: 0.02),
          ],
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: accentColor.withValues(alpha: 0.15)),
      ),
      child: Row(
        children: [
          Container(
            width: 40,
            height: 40,
            decoration: BoxDecoration(
              color: accentColor.withValues(alpha: 0.12),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Icon(
              insight.isIncrease
                  ? CupertinoIcons.arrow_up_right
                  : CupertinoIcons.arrow_down_right,
              size: 20,
              color: accentColor,
            ),
          ),
          const SizedBox(width: 14),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  l10n.subCategoryChange(
                    periodLabel,
                    insight.subCategory,
                    changeText,
                    insight.changePercent.toStringAsFixed(0),
                    previousLabel,
                  ),
                  style: TextStyle(
                    fontSize: 14,
                    fontWeight: FontWeight.w500,
                    color: context.appColors.textPrimary,
                    height: 1.3,
                  ),
                ),
                const SizedBox(height: 3),
                Text(
                  l10n.comparedToPrevious,
                  style: TextStyle(
                    fontSize: 12,
                    color: context.appColors.textTertiary.withValues(
                      alpha: 0.8,
                    ),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  bool _hasComparisonInsight(
    List<Expense> expenses,
    List<Expense> allExpenses,
  ) {
    if (_selectedFilter == TimeFilter.all) return false;
    final previousExpenses = _getPreviousPeriodExpenses(allExpenses);
    return _getSubCategoryComparisonInsight(expenses, previousExpenses) != null;
  }

  bool _hasSubCategories(List<Expense> expenses) {
    return expenses.any(
      (e) =>
          e.subCategory != null &&
          e.subCategory!.isNotEmpty &&
          e.decision == ExpenseDecision.yes,
    );
  }

  Widget _buildSubCategoryBreakdown(
    List<Expense> expenses,
    AppLocalizations l10n,
  ) {
    final Map<String, Map<String, double>> categoryBreakdown = {};

    for (final expense in expenses) {
      if (expense.decision != ExpenseDecision.yes) continue;
      if (expense.subCategory == null || expense.subCategory!.isEmpty) continue;

      final mainCat = expense.category;
      final subCat = expense.subCategory!;

      categoryBreakdown[mainCat] ??= {};
      categoryBreakdown[mainCat]![subCat] =
          (categoryBreakdown[mainCat]![subCat] ?? 0) + expense.amount;
    }

    if (categoryBreakdown.isEmpty) {
      return const SizedBox.shrink();
    }

    final sortedMainCategories = categoryBreakdown.entries.toList()
      ..sort((a, b) {
        final totalA = a.value.values.fold<double>(0, (sum, v) => sum + v);
        final totalB = b.value.values.fold<double>(0, (sum, v) => sum + v);
        return totalB.compareTo(totalA);
      });

    final colors = [
      context.appColors.primary,
      context.appColors.warning,
      context.appColors.info,
      context.appColors.error,
      AppColors.categoryShopping,
      AppColors.achievementStreak,
      AppColors.achievementMystery,
      AppColors.categoryEntertainment,
      AppColors.categoryDefault,
    ];

    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: context.appColors.cardBorder),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Container(
                width: 32,
                height: 32,
                decoration: BoxDecoration(
                  color: context.appColors.primary.withValues(alpha: 0.15),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Icon(
                  CupertinoIcons.square_grid_2x2_fill,
                  size: 18,
                  color: context.appColors.primary,
                ),
              ),
              const SizedBox(width: 12),
              Text(
                l10n.subCategoryDetail,
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textPrimary,
                ),
              ),
            ],
          ),
          const SizedBox(height: 16),
          ...sortedMainCategories.asMap().entries.map((mainEntry) {
            final mainIndex = mainEntry.key;
            final mainCategory = mainEntry.value.key;
            final subCategories = mainEntry.value.value;
            final mainColor = colors[mainIndex % colors.length];

            final sortedSubs = subCategories.entries.toList()
              ..sort((a, b) => b.value.compareTo(a.value));

            final mainTotal = subCategories.values.fold<double>(
              0,
              (s, v) => s + v,
            );

            return Padding(
              padding: EdgeInsets.only(
                bottom: mainIndex < sortedMainCategories.length - 1 ? 16 : 0,
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    children: [
                      Container(
                        width: 8,
                        height: 8,
                        decoration: BoxDecoration(
                          color: mainColor,
                          borderRadius: BorderRadius.circular(2),
                        ),
                      ),
                      const SizedBox(width: 8),
                      Expanded(
                        child: Text(
                          CategoryUtils.getLocalizedName(context, mainCategory),
                          style: TextStyle(
                            fontSize: 14,
                            fontWeight: FontWeight.w600,
                            color: context.appColors.textPrimary,
                          ),
                        ),
                      ),
                      Text(
                        '${formatTurkishCurrency(mainTotal, decimalDigits: 2)} TL',
                        style: TextStyle(
                          fontSize: 13,
                          fontWeight: FontWeight.w600,
                          color: mainColor,
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 8),
                  ...sortedSubs.map((subEntry) {
                    final subName = subEntry.key;
                    final subAmount = subEntry.value;
                    final subPercent = (subAmount / mainTotal * 100);

                    return Padding(
                      padding: const EdgeInsets.only(left: 16, bottom: 6),
                      child: Row(
                        children: [
                          Container(
                            width: 4,
                            height: 4,
                            decoration: BoxDecoration(
                              color: mainColor.withValues(alpha: 0.5),
                              shape: BoxShape.circle,
                            ),
                          ),
                          const SizedBox(width: 8),
                          Expanded(
                            child: Text(
                              subName,
                              style: TextStyle(
                                fontSize: 13,
                                color: context.appColors.textSecondary,
                              ),
                            ),
                          ),
                          Text(
                            '${formatTurkishCurrency(subAmount, decimalDigits: 2)} TL',
                            style: TextStyle(
                              fontSize: 12,
                              fontWeight: FontWeight.w500,
                              color: context.appColors.textSecondary,
                            ),
                          ),
                          const SizedBox(width: 8),
                          Container(
                            padding: const EdgeInsets.symmetric(
                              horizontal: 6,
                              vertical: 2,
                            ),
                            decoration: BoxDecoration(
                              color: mainColor.withValues(alpha: 0.1),
                              borderRadius: BorderRadius.circular(4),
                            ),
                            child: Text(
                              '%${subPercent.toStringAsFixed(0)}',
                              style: TextStyle(
                                fontSize: 10,
                                fontWeight: FontWeight.w600,
                                color: mainColor,
                              ),
                            ),
                          ),
                        ],
                      ),
                    );
                  }),
                ],
              ),
            );
          }),
        ],
      ),
    );
  }

  Widget _buildStatistics(List<Expense> expenses, AppLocalizations l10n) {
    final yesExpenses = expenses
        .where((e) => e.decision == ExpenseDecision.yes)
        .toList();
    final totalSpent = yesExpenses.fold<double>(0, (sum, e) => sum + e.amount);

    int dayCount;
    switch (_selectedFilter) {
      case TimeFilter.week:
        dayCount = 7;
        break;
      case TimeFilter.month:
        dayCount = 30;
        break;
      case TimeFilter.all:
        if (expenses.isEmpty) {
          dayCount = 1;
        } else {
          final dates = expenses.map((e) => e.date).toList();
          final earliest = dates.reduce((a, b) => a.isBefore(b) ? a : b);
          dayCount = DateTime.now().difference(earliest).inDays + 1;
        }
    }

    final dailyAverage = totalSpent / dayCount;

    final highestExpense = yesExpenses.isNotEmpty
        ? yesExpenses.reduce((a, b) => a.amount > b.amount ? a : b)
        : null;

    final noExpenses = expenses
        .where((e) => e.decision == ExpenseDecision.no)
        .toList();
    final noCategoryCounts = <String, int>{};
    for (final expense in noExpenses) {
      noCategoryCounts[expense.category] =
          (noCategoryCounts[expense.category] ?? 0) + 1;
    }
    String? mostDeclinedCategory;
    int mostDeclinedCount = 0;
    for (final entry in noCategoryCounts.entries) {
      if (entry.value > mostDeclinedCount) {
        mostDeclinedCount = entry.value;
        mostDeclinedCategory = entry.key;
      }
    }

    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: context.appColors.cardBorder),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            l10n.statistics,
            style: TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.w600,
              color: context.appColors.textPrimary,
            ),
          ),
          const SizedBox(height: 16),
          _buildStatRow(
            icon: CupertinoIcons.calendar,
            label: l10n.avgDailyExpense,
            value:
                '${formatTurkishCurrency(dailyAverage, decimalDigits: 2)} TL',
          ),
          const SizedBox(height: 12),
          _buildStatRow(
            icon: CupertinoIcons.arrow_up,
            label: l10n.highestSingleExpense,
            value: highestExpense != null
                ? '${formatTurkishCurrency(highestExpense.amount, decimalDigits: 2)} TL (${CategoryUtils.getLocalizedName(context, highestExpense.category)})'
                : '-',
          ),
          const SizedBox(height: 12),
          _buildStatRow(
            icon: CupertinoIcons.nosign,
            label: l10n.mostDeclinedCategory,
            value: mostDeclinedCategory != null
                ? '${CategoryUtils.getLocalizedName(context, mostDeclinedCategory)} (${l10n.times(mostDeclinedCount)})'
                : '-',
            valueColor: context.appColors.decisionNo,
          ),
        ],
      ),
    );
  }

  Widget _buildStatRow({
    required IconData icon,
    required String label,
    required String value,
    Color? valueColor,
  }) {
    return Row(
      children: [
        Icon(icon, size: 18, color: context.appColors.textTertiary),
        const SizedBox(width: 12),
        Expanded(
          child: Text(
            label,
            style: TextStyle(
              fontSize: 13,
              color: context.appColors.textSecondary,
            ),
          ),
        ),
        Flexible(
          child: Text(
            value,
            style: TextStyle(
              fontSize: 13,
              fontWeight: FontWeight.w600,
              color: valueColor ?? context.appColors.textPrimary,
            ),
            textAlign: TextAlign.end,
            overflow: TextOverflow.ellipsis,
          ),
        ),
      ],
    );
  }

  Widget _buildTrendCard(
    List<Expense> expenses,
    List<Expense> allExpenses,
    AppLocalizations l10n,
  ) {
    final previousExpenses = _getPreviousPeriodExpenses(allExpenses);

    final currentSpent = expenses
        .where((e) => e.decision == ExpenseDecision.yes)
        .fold<double>(0, (sum, e) => sum + e.amount);

    final previousSpent = previousExpenses
        .where((e) => e.decision == ExpenseDecision.yes)
        .fold<double>(0, (sum, e) => sum + e.amount);

    if (previousSpent == 0 && currentSpent == 0) {
      return const SizedBox.shrink();
    }

    final difference = previousSpent > 0
        ? ((currentSpent - previousSpent) / previousSpent * 100)
        : 0.0;

    final isPositive = difference <= 0;
    final periodLabel = _selectedFilter == TimeFilter.week
        ? l10n.periodWeek
        : l10n.periodMonth;

    String message;
    if (previousSpent == 0) {
      message = l10n.trendSpentThisPeriod(
        formatTurkishCurrency(currentSpent, decimalDigits: 2),
        periodLabel,
      );
    } else if (difference == 0) {
      message = l10n.trendSameAsPrevious(periodLabel);
    } else {
      final absPercent = difference.abs().toStringAsFixed(0);
      message = isPositive
          ? l10n.trendSpentLess(absPercent, periodLabel)
          : l10n.trendSpentMore(absPercent, periodLabel);
    }

    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: isPositive
            ? context.appColors.success.withValues(alpha: 0.1)
            : context.appColors.warning.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: isPositive
              ? context.appColors.success.withValues(alpha: 0.3)
              : context.appColors.warning.withValues(alpha: 0.3),
        ),
      ),
      child: Row(
        children: [
          Container(
            width: 40,
            height: 40,
            decoration: BoxDecoration(
              color: isPositive
                  ? context.appColors.success.withValues(alpha: 0.2)
                  : context.appColors.warning.withValues(alpha: 0.2),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Icon(
              isPositive
                  ? CupertinoIcons.arrow_down_right
                  : CupertinoIcons.arrow_up_right,
              color: isPositive
                  ? context.appColors.success
                  : context.appColors.warning,
              size: 22,
            ),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  l10n.trend,
                  style: TextStyle(
                    fontSize: 12,
                    color: context.appColors.textSecondary,
                  ),
                ),
                const SizedBox(height: 2),
                Text(
                  message,
                  style: TextStyle(
                    fontSize: 14,
                    fontWeight: FontWeight.w600,
                    color: isPositive
                        ? context.appColors.success
                        : context.appColors.warning,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// DATA CLASSES
// ═══════════════════════════════════════════════════════════════════════════

/// Monthly data for spending trend chart
class _MonthData {
  final int month;
  final int year;
  final double total;
  final int count;

  const _MonthData({
    required this.month,
    required this.year,
    required this.total,
    required this.count,
  });
}

// ═══════════════════════════════════════════════════════════════════════════
// HELPER WIDGETS
// ═══════════════════════════════════════════════════════════════════════════

/// PRO Badge Widget
class _ProBadge extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [
            context.appColors.gold.withValues(alpha: 0.9),
            context.appColors.gold.withValues(alpha: 0.7),
          ],
        ),
        borderRadius: BorderRadius.circular(4),
        boxShadow: [
          BoxShadow(
            color: context.appColors.gold.withValues(alpha: 0.3),
            blurRadius: 4,
            offset: const Offset(0, 1),
          ),
        ],
      ),
      child: Text(
        'PRO',
        style: TextStyle(
          fontSize: 8,
          fontWeight: FontWeight.w800,
          color: context.appColors.background,
          letterSpacing: 0.5,
        ),
      ),
    );
  }
}

/// Insight Mini Card Widget
class _InsightMiniCard extends StatelessWidget {
  final IconData icon;
  final Color iconColor;
  final String title;
  final String value;

  const _InsightMiniCard({
    required this.icon,
    required this.iconColor,
    required this.title,
    required this.value,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: context.appColors.surfaceLight,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: context.appColors.cardBorder),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Container(
                width: 24,
                height: 24,
                decoration: BoxDecoration(
                  color: iconColor.withValues(alpha: 0.15),
                  borderRadius: BorderRadius.circular(6),
                ),
                child: Icon(icon, size: 14, color: iconColor),
              ),
              const SizedBox(width: 8),
              Expanded(
                child: Text(
                  title,
                  style: TextStyle(
                    fontSize: 10,
                    fontWeight: FontWeight.w600,
                    color: context.appColors.textSecondary,
                  ),
                  overflow: TextOverflow.ellipsis,
                ),
              ),
            ],
          ),
          const SizedBox(height: 8),
          Text(
            value,
            style: TextStyle(
              fontSize: 11,
              fontWeight: FontWeight.w500,
              color: context.appColors.textPrimary,
              height: 1.3,
            ),
            maxLines: 2,
            overflow: TextOverflow.ellipsis,
          ),
        ],
      ),
    );
  }
}

/// Gecikmeli slide-in animasyonu
class _AnimatedSlideIn extends StatefulWidget {
  final Widget child;
  final Duration delay;

  const _AnimatedSlideIn({required this.child, this.delay = Duration.zero});

  @override
  State<_AnimatedSlideIn> createState() => _AnimatedSlideInState();
}

class _AnimatedSlideInState extends State<_AnimatedSlideIn>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _fadeAnimation;
  late Animation<Offset> _slideAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: AppAnimations.medium,
    );

    _fadeAnimation = CurvedAnimation(
      parent: _controller,
      curve: AppAnimations.standardCurve,
    );

    _slideAnimation = Tween<Offset>(
      begin: const Offset(0, 0.1),
      end: Offset.zero,
    ).animate(_fadeAnimation);

    Future.delayed(widget.delay, () {
      if (mounted) _controller.forward();
    });
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return FadeTransition(
      opacity: _fadeAnimation,
      child: SlideTransition(position: _slideAnimation, child: widget.child),
    );
  }
}

/// Animasyonlu özet kartı
class _AnimatedSummaryCard extends StatefulWidget {
  final Duration delay;
  final String title;
  final double value;
  final String? prefix;
  final String? suffix;
  final String subtitle;
  final Color color;
  final IconData icon;
  final bool isFullWidth;
  final bool isInteger;

  const _AnimatedSummaryCard({
    this.delay = Duration.zero,
    required this.title,
    required this.value,
    this.prefix,
    this.suffix,
    required this.subtitle,
    required this.color,
    required this.icon,
    this.isFullWidth = false,
    this.isInteger = false,
  });

  @override
  State<_AnimatedSummaryCard> createState() => _AnimatedSummaryCardState();
}

class _AnimatedSummaryCardState extends State<_AnimatedSummaryCard>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _scaleAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: AppAnimations.medium,
    );

    _scaleAnimation = Tween<double>(begin: 0.95, end: 1.0).animate(
      CurvedAnimation(parent: _controller, curve: AppAnimations.standardCurve),
    );

    Future.delayed(widget.delay, () {
      if (mounted) _controller.forward();
    });
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return FadeTransition(
      opacity: _controller,
      child: ScaleTransition(
        scale: _scaleAnimation,
        child: Container(
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: context.appColors.surface,
            borderRadius: BorderRadius.circular(16),
            border: Border.all(color: context.appColors.cardBorder),
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                children: [
                  Container(
                    width: 32,
                    height: 32,
                    decoration: BoxDecoration(
                      color: widget.color.withValues(alpha: 0.15),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Icon(widget.icon, size: 18, color: widget.color),
                  ),
                  const Spacer(),
                ],
              ),
              const SizedBox(height: 12),
              Text(
                widget.title,
                style: TextStyle(
                  fontSize: 12,
                  color: context.appColors.textSecondary,
                ),
              ),
              const SizedBox(height: 4),
              // Animated counter
              TweenAnimationBuilder<double>(
                tween: Tween<double>(begin: 0, end: widget.value),
                duration: AppAnimations.counter,
                curve: AppAnimations.standardCurve,
                builder: (context, animValue, child) {
                  String text;
                  if (widget.isInteger) {
                    text =
                        '${widget.prefix ?? ''}${animValue.toInt()}${widget.suffix ?? ''}';
                  } else {
                    text =
                        '${widget.prefix ?? ''}${animValue.toStringAsFixed(0)}${widget.suffix ?? ''}';
                  }
                  return Text(
                    text,
                    style: TextStyle(
                      fontSize: 22,
                      fontWeight: FontWeight.w700,
                      color: widget.color,
                    ),
                  );
                },
              ),
              const SizedBox(height: 4),
              Text(
                widget.subtitle,
                style: TextStyle(
                  fontSize: 11,
                  color: context.appColors.textTertiary,
                ),
                maxLines: 1,
                overflow: TextOverflow.ellipsis,
              ),
            ],
          ),
        ),
      ),
    );
  }
}


--- FILE: lib/screens/onboarding_screen.dart ---

import 'dart:async';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../theme/theme.dart';
import '../services/services.dart';
import 'screens.dart';

/// Onboarding page data - immutable
@immutable
class OnboardingPageData {
  final String title;
  final String subtitle;
  final IconData? icon;
  final Color? iconColor;
  final bool showDecisionButtons;
  final bool showStartButton;
  final bool showCoffeeClockAnimation;

  const OnboardingPageData({
    required this.title,
    required this.subtitle,
    this.icon,
    this.iconColor,
    this.showDecisionButtons = false,
    this.showStartButton = false,
    this.showCoffeeClockAnimation = false,
  });
}

/// Build localized onboarding pages
List<OnboardingPageData> _buildOnboardingPages(
  AppLocalizations l10n,
  BuildContext context,
) {
  return [
    // Slide 1: Hook - Coffee to Clock animation
    OnboardingPageData(
      title: l10n.onboardingHookTitle,
      subtitle: l10n.onboardingHookSubtitle,
      showCoffeeClockAnimation: true,
    ),
    // Slide 2: Decision buttons
    OnboardingPageData(
      title: l10n.everyExpenseDecision,
      subtitle: l10n.youDecide,
      showDecisionButtons: true,
    ),
    // Slide 3: Start button
    OnboardingPageData(
      title: l10n.oneExpenseEnough,
      subtitle: l10n.startSmall,
      icon: CupertinoIcons.rocket_fill,
      iconColor: context.appColors.primary,
      showStartButton: true,
    ),
  ];
}

class OnboardingScreen extends StatefulWidget {
  const OnboardingScreen({super.key});

  @override
  State<OnboardingScreen> createState() => _OnboardingScreenState();
}

class _OnboardingScreenState extends State<OnboardingScreen>
    with TickerProviderStateMixin {
  final PageController _pageController = PageController();
  int _currentPage = 0;

  late AnimationController _buttonAnimationController;
  late Animation<double> _buttonScaleAnimation;

  // Coffee-clock animation
  late AnimationController _iconAnimationController;
  bool _showClock = false;
  Timer? _iconToggleTimer;

  @override
  void initState() {
    super.initState();
    _buttonAnimationController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 150),
    );
    _buttonScaleAnimation = Tween<double>(begin: 1.0, end: 0.95).animate(
      CurvedAnimation(
        parent: _buttonAnimationController,
        curve: Curves.easeInOut,
      ),
    );

    // Setup icon animation controller for crossfade
    _iconAnimationController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 600),
    );

    // Start coffee-clock toggle timer
    _startIconToggle();
  }

  void _startIconToggle() {
    _iconToggleTimer = Timer.periodic(const Duration(seconds: 2), (_) {
      if (mounted) {
        setState(() {
          _showClock = !_showClock;
        });
      }
    });
  }

  @override
  void dispose() {
    _pageController.dispose();
    _buttonAnimationController.dispose();
    _iconAnimationController.dispose();
    _iconToggleTimer?.cancel();
    super.dispose();
  }

  Future<void> _completeOnboarding() async {
    final profileService = ProfileService();
    final success = await profileService.setOnboardingCompleted();
    debugPrint('[Onboarding] ✓ Onboarding completed flag saved: $success');

    if (!mounted) return;

    Navigator.pushReplacement(
      context,
      PageRouteBuilder(
        pageBuilder: (context, animation, secondaryAnimation) =>
            const UserProfileScreen(),
        transitionsBuilder: (context, animation, secondaryAnimation, child) {
          return FadeTransition(opacity: animation, child: child);
        },
        transitionDuration: const Duration(milliseconds: 400),
      ),
    );
  }

  void _onPageChanged(int page) {
    setState(() {
      _currentPage = page;
    });
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final pages = _buildOnboardingPages(l10n, context);

    return Scaffold(
      backgroundColor: context.appColors.background,
      body: SafeArea(
        child: Stack(
          children: [
            // PageView - wrapped with RepaintBoundary
            RepaintBoundary(
              child: PageView.builder(
                controller: _pageController,
                onPageChanged: _onPageChanged,
                itemCount: pages.length,
                itemBuilder: (context, index) {
                  return _OnboardingPage(
                    data: pages[index],
                    onStartPressed: _completeOnboarding,
                    buttonAnimationController: _buttonAnimationController,
                    buttonScaleAnimation: _buttonScaleAnimation,
                    l10n: l10n,
                    showClock: _showClock,
                  );
                },
              ),
            ),

            // Skip button (top right)
            Positioned(top: 16, right: 16, child: _SkipButton(l10n: l10n)),

            // Page indicators (bottom)
            Positioned(
              bottom: 48,
              left: 0,
              right: 0,
              child: _PageIndicators(
                pageCount: pages.length,
                currentPage: _currentPage,
              ),
            ),
          ],
        ),
      ),
    );
  }
}

/// Skip button - separate optimized widget
class _SkipButton extends StatelessWidget {
  final AppLocalizations l10n;

  const _SkipButton({required this.l10n});

  @override
  Widget build(BuildContext context) {
    return TextButton(
      onPressed: () async {
        final profileService = ProfileService();
        final success = await profileService.setOnboardingCompleted();
        debugPrint('[Onboarding] ✓ Onboarding skipped, flag saved: $success');

        if (!context.mounted) return;

        Navigator.pushReplacement(
          context,
          PageRouteBuilder(
            pageBuilder: (context, animation, secondaryAnimation) =>
                const UserProfileScreen(),
            transitionsBuilder:
                (context, animation, secondaryAnimation, child) {
                  return FadeTransition(opacity: animation, child: child);
                },
            transitionDuration: const Duration(milliseconds: 400),
          ),
        );
      },
      child: Text(
        l10n.skip,
        style: TextStyle(
          color: context.appColors.textSecondary,
          fontSize: 16,
          fontWeight: FontWeight.w500,
        ),
      ),
    );
  }
}

/// Page indicators - separate widget with RepaintBoundary
class _PageIndicators extends StatelessWidget {
  final int pageCount;
  final int currentPage;

  const _PageIndicators({required this.pageCount, required this.currentPage});

  @override
  Widget build(BuildContext context) {
    return RepaintBoundary(
      child: Row(
        mainAxisAlignment: MainAxisAlignment.center,
        children: List.generate(
          pageCount,
          (index) => _PageIndicator(isActive: index == currentPage),
        ),
      ),
    );
  }
}

class _OnboardingPage extends StatelessWidget {
  final OnboardingPageData data;
  final VoidCallback onStartPressed;
  final AnimationController buttonAnimationController;
  final Animation<double> buttonScaleAnimation;
  final AppLocalizations l10n;
  final bool showClock;

  const _OnboardingPage({
    required this.data,
    required this.onStartPressed,
    required this.buttonAnimationController,
    required this.buttonScaleAnimation,
    required this.l10n,
    required this.showClock,
  });

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 32),
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          const Spacer(flex: 2),

          // Coffee-Clock animation (Slide 1 hook)
          if (data.showCoffeeClockAnimation) ...[
            _CoffeeClockAnimation(showClock: showClock),
            const SizedBox(height: 48),
          ],

          // Icon or visual content
          if (data.icon != null) ...[
            Container(
              width: 140,
              height: 140,
              decoration: BoxDecoration(
                color:
                    data.iconColor?.withValues(alpha: 0.1) ??
                    context.appColors.primary.withValues(alpha: 0.1),
                shape: BoxShape.circle,
                border: Border.all(
                  color:
                      data.iconColor?.withValues(alpha: 0.2) ??
                      context.appColors.primary.withValues(alpha: 0.2),
                  width: 2,
                ),
              ),
              child: Icon(
                data.icon,
                size: 64,
                color: data.iconColor ?? context.appColors.primary,
              ),
            ),
            const SizedBox(height: 48),
          ],

          // Decision buttons visual
          if (data.showDecisionButtons) ...[
            _DecisionButtonsVisual(l10n: l10n),
            const SizedBox(height: 48),
          ],

          // Title
          Text(
            data.title,
            textAlign: TextAlign.center,
            style: TextStyle(
              fontSize: 28,
              fontWeight: FontWeight.w700,
              color: context.appColors.textPrimary,
              letterSpacing: -0.5,
              height: 1.2,
            ),
          ),
          const SizedBox(height: 16),

          // Subtitle
          Text(
            data.subtitle,
            textAlign: TextAlign.center,
            style: TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.w400,
              color: context.appColors.textSecondary,
              height: 1.5,
            ),
          ),

          const Spacer(flex: 1),

          // Start button - animation isolation with RepaintBoundary
          if (data.showStartButton) ...[
            RepaintBoundary(
              child: GestureDetector(
                onTapDown: (_) => buttonAnimationController.forward(),
                onTapUp: (_) {
                  buttonAnimationController.reverse();
                  onStartPressed();
                },
                onTapCancel: () => buttonAnimationController.reverse(),
                child: ScaleTransition(
                  scale: buttonScaleAnimation,
                  child: Container(
                    width: double.infinity,
                    padding: const EdgeInsets.symmetric(vertical: 18),
                    decoration: BoxDecoration(
                      color: context.appColors.primary,
                      borderRadius: BorderRadius.circular(16),
                      boxShadow: [
                        BoxShadow(
                          color: context.appColors.primary.withValues(
                            alpha: 0.3,
                          ),
                          blurRadius: 20,
                          offset: const Offset(0, 8),
                        ),
                      ],
                    ),
                    child: Text(
                      l10n.start,
                      textAlign: TextAlign.center,
                      style: TextStyle(
                        fontSize: 18,
                        fontWeight: FontWeight.w600,
                        color: context.appColors.background,
                      ),
                    ),
                  ),
                ),
              ),
            ),
            const SizedBox(height: 32),
          ],

          const Spacer(flex: 2),
        ],
      ),
    );
  }
}

/// Animated coffee-to-clock icon for the hook slide
class _CoffeeClockAnimation extends StatelessWidget {
  final bool showClock;

  const _CoffeeClockAnimation({required this.showClock});

  @override
  Widget build(BuildContext context) {
    return Container(
      width: 160,
      height: 160,
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            context.appColors.primary.withValues(alpha: 0.15),
            context.appColors.accent.withValues(alpha: 0.1),
          ],
        ),
        shape: BoxShape.circle,
        border: Border.all(
          color: context.appColors.primary.withValues(alpha: 0.3),
          width: 2,
        ),
        boxShadow: [
          BoxShadow(
            color: context.appColors.primary.withValues(alpha: 0.2),
            blurRadius: 30,
            spreadRadius: 5,
          ),
        ],
      ),
      child: AnimatedSwitcher(
        duration: const Duration(milliseconds: 600),
        switchInCurve: Curves.easeOutBack,
        switchOutCurve: Curves.easeIn,
        transitionBuilder: (child, animation) {
          return ScaleTransition(
            scale: animation,
            child: FadeTransition(opacity: animation, child: child),
          );
        },
        child: showClock
            ? Icon(
                CupertinoIcons.clock_fill,
                key: const ValueKey('clock'),
                size: 72,
                color: context.appColors.primary,
              )
            : Icon(
                CupertinoIcons.cart_fill,
                key: const ValueKey('coffee'),
                size: 72,
                color: context.appColors.accent,
              ),
      ),
    );
  }
}

class _DecisionButtonsVisual extends StatelessWidget {
  final AppLocalizations l10n;

  const _DecisionButtonsVisual({required this.l10n});

  @override
  Widget build(BuildContext context) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        _DecisionButton(
          color: context.appColors.decisionNo,
          icon: CupertinoIcons.xmark,
          label: l10n.passed,
        ),
        const SizedBox(width: 12),
        _DecisionButton(
          color: context.appColors.decisionThinking,
          icon: CupertinoIcons.hourglass,
          label: l10n.thinking,
        ),
        const SizedBox(width: 12),
        _DecisionButton(
          color: context.appColors.decisionYes,
          icon: CupertinoIcons.checkmark,
          label: l10n.bought,
        ),
      ],
    );
  }
}

class _DecisionButton extends StatelessWidget {
  final Color color;
  final IconData icon;
  final String label;

  const _DecisionButton({
    required this.color,
    required this.icon,
    required this.label,
  });

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        Container(
          width: 64,
          height: 64,
          decoration: BoxDecoration(
            color: color.withValues(alpha: 0.15),
            borderRadius: BorderRadius.circular(16),
            border: Border.all(color: color.withValues(alpha: 0.3), width: 2),
          ),
          child: Icon(icon, size: 28, color: color),
        ),
        const SizedBox(height: 8),
        Text(
          label,
          style: TextStyle(
            fontSize: 11,
            fontWeight: FontWeight.w500,
            color: color,
          ),
        ),
      ],
    );
  }
}

class _PageIndicator extends StatelessWidget {
  final bool isActive;

  const _PageIndicator({required this.isActive});

  @override
  Widget build(BuildContext context) {
    return AnimatedContainer(
      duration: const Duration(milliseconds: 300),
      curve: Curves.easeInOut,
      margin: const EdgeInsets.symmetric(horizontal: 4),
      width: isActive ? 24 : 8,
      height: 8,
      decoration: BoxDecoration(
        color: isActive
            ? context.appColors.primary
            : context.appColors.surfaceLight,
        borderRadius: BorderRadius.circular(4),
      ),
    );
  }
}


--- FILE: lib/screens/simple/simple_transactions_screen.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:intl/intl.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../../models/models.dart';
import '../../providers/providers.dart';
import '../../theme/theme.dart';
import '../../utils/currency_utils.dart';

/// Simple Mode - Transactions Screen (Excel/Accounting style)
class SimpleTransactionsScreen extends StatefulWidget {
  const SimpleTransactionsScreen({super.key});

  @override
  State<SimpleTransactionsScreen> createState() =>
      _SimpleTransactionsScreenState();
}

class _SimpleTransactionsScreenState extends State<SimpleTransactionsScreen> {
  DateTime _selectedMonth = DateTime.now();

  void _previousMonth() {
    HapticFeedback.selectionClick();
    setState(() {
      _selectedMonth = DateTime(_selectedMonth.year, _selectedMonth.month - 1);
    });
  }

  void _nextMonth() {
    HapticFeedback.selectionClick();
    final now = DateTime.now();
    final nextMonth = DateTime(_selectedMonth.year, _selectedMonth.month + 1);
    if (nextMonth.isBefore(DateTime(now.year, now.month + 1))) {
      setState(() {
        _selectedMonth = nextMonth;
      });
    }
  }

  List<Expense> _getMonthExpenses(List<Expense> allExpenses) {
    return allExpenses.where((e) {
      return e.date.year == _selectedMonth.year &&
          e.date.month == _selectedMonth.month;
    }).toList()..sort((a, b) => b.date.compareTo(a.date));
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final financeProvider = context.watch<FinanceProvider>();
    final currencyProvider = context.watch<CurrencyProvider>();
    final expenses = financeProvider.realExpenses;
    final monthExpenses = _getMonthExpenses(expenses);

    // Calculate totals
    double totalIncome = 0;
    double totalExpense = 0;
    for (final expense in monthExpenses) {
      if (expense.decision == ExpenseDecision.yes) {
        totalExpense += expense.amount;
      }
    }
    // For now, income is from profile
    totalIncome = financeProvider.userProfile?.monthlyIncome ?? 0;
    final balance = totalIncome - totalExpense;

    final currencySymbol = currencyProvider.currency.symbol;

    return Scaffold(
      backgroundColor: context.appColors.background,
      body: SafeArea(
        child: Column(
          children: [
            // Month Selector
            _buildMonthSelector(l10n),

            // Summary Row
            _buildSummaryRow(
              l10n,
              currencySymbol,
              totalIncome,
              totalExpense,
              balance,
            ),

            // Divider
            Divider(color: context.appColors.cardBorder, height: 1),

            // Transaction List
            Expanded(
              child: monthExpenses.isEmpty
                  ? _buildEmptyState(l10n)
                  : _buildTransactionList(monthExpenses, currencySymbol, l10n),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildMonthSelector(AppLocalizations l10n) {
    final now = DateTime.now();
    final isCurrentMonth =
        _selectedMonth.year == now.year && _selectedMonth.month == now.month;

    final locale = Localizations.localeOf(context).languageCode;
    final monthFormat = DateFormat.yMMMM(locale);
    final monthName = monthFormat.format(_selectedMonth);

    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          IconButton(
            onPressed: _previousMonth,
            icon: Icon(
              CupertinoIcons.chevron_left,
              color: context.appColors.textPrimary,
            ),
          ),
          Text(
            monthName,
            style: TextStyle(
              fontSize: 18,
              fontWeight: FontWeight.w600,
              color: context.appColors.textPrimary,
            ),
          ),
          IconButton(
            onPressed: isCurrentMonth ? null : _nextMonth,
            icon: Icon(
              CupertinoIcons.chevron_right,
              color: isCurrentMonth
                  ? context.appColors.textTertiary
                  : context.appColors.textPrimary,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSummaryRow(
    AppLocalizations l10n,
    String currencySymbol,
    double income,
    double expense,
    double balance,
  ) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
      child: Row(
        children: [
          // Income
          Expanded(
            child: _buildSummaryItem(
              label: l10n.simpleIncome,
              amount: income,
              currencySymbol: currencySymbol,
              color: context.appColors.success,
            ),
          ),
          Container(width: 1, height: 40, color: context.appColors.cardBorder),
          // Expense
          Expanded(
            child: _buildSummaryItem(
              label: l10n.simpleExpense,
              amount: expense,
              currencySymbol: currencySymbol,
              color: context.appColors.error,
            ),
          ),
          Container(width: 1, height: 40, color: context.appColors.cardBorder),
          // Balance
          Expanded(
            child: _buildSummaryItem(
              label: l10n.simpleBalance,
              amount: balance,
              currencySymbol: currencySymbol,
              color: context.appColors.textPrimary,
              isBold: true,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSummaryItem({
    required String label,
    required double amount,
    required String currencySymbol,
    required Color color,
    bool isBold = false,
  }) {
    return Column(
      children: [
        Text(
          label,
          style: TextStyle(
            fontSize: 12,
            color: context.appColors.textSecondary,
          ),
        ),
        const SizedBox(height: 4),
        Text(
          '$currencySymbol${formatTurkishCurrency(amount, decimalDigits: 0)}',
          style: TextStyle(
            fontSize: 16,
            fontWeight: isBold ? FontWeight.w700 : FontWeight.w600,
            color: color,
          ),
        ),
      ],
    );
  }

  Widget _buildEmptyState(AppLocalizations l10n) {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            CupertinoIcons.doc_text,
            size: 64,
            color: context.appColors.textTertiary,
          ),
          const SizedBox(height: 16),
          Text(
            l10n.simpleNoTransactions,
            style: TextStyle(
              fontSize: 16,
              color: context.appColors.textSecondary,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildTransactionList(
    List<Expense> expenses,
    String currencySymbol,
    AppLocalizations l10n,
  ) {
    return ListView.separated(
      padding: const EdgeInsets.symmetric(vertical: 8),
      itemCount: expenses.length,
      separatorBuilder: (_, __) => Divider(
        color: context.appColors.cardBorder,
        height: 1,
        indent: 16,
        endIndent: 16,
      ),
      itemBuilder: (context, index) {
        final expense = expenses[index];
        return _buildTransactionRow(expense, currencySymbol, l10n);
      },
    );
  }

  Widget _buildTransactionRow(
    Expense expense,
    String currencySymbol,
    AppLocalizations l10n,
  ) {
    final dateFormat = DateFormat('dd/MM');
    final dateStr = dateFormat.format(expense.date);

    final isExpense = expense.decision == ExpenseDecision.yes;
    final amountColor = isExpense
        ? context.appColors.error
        : context.appColors.success;
    final amountPrefix = isExpense ? '-' : '+';

    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
      child: Row(
        children: [
          // Date
          SizedBox(
            width: 50,
            child: Text(
              dateStr,
              style: TextStyle(
                fontSize: 13,
                color: context.appColors.textSecondary,
                fontFamily: 'monospace',
              ),
            ),
          ),
          // Category
          SizedBox(
            width: 80,
            child: Text(
              expense.category,
              style: TextStyle(
                fontSize: 13,
                color: context.appColors.textSecondary,
              ),
              overflow: TextOverflow.ellipsis,
            ),
          ),
          // Description (subCategory)
          Expanded(
            child: Text(
              expense.subCategory ?? '',
              style: TextStyle(
                fontSize: 14,
                color: context.appColors.textPrimary,
              ),
              overflow: TextOverflow.ellipsis,
            ),
          ),
          // Amount
          Text(
            '$amountPrefix$currencySymbol${formatTurkishCurrency(expense.amount, decimalDigits: 0)}',
            style: TextStyle(
              fontSize: 14,
              fontWeight: FontWeight.w600,
              color: amountColor,
              fontFamily: 'monospace',
            ),
          ),
        ],
      ),
    );
  }
}


--- FILE: lib/screens/simple/simple_settings_screen.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../../providers/locale_provider.dart';
import '../../providers/currency_provider.dart';
import '../../providers/theme_provider.dart';
import '../../services/simple_mode_service.dart';
import '../../theme/theme.dart';
import '../../widgets/currency_selector.dart';

/// Simple Mode - Settings Screen (minimal)
class SimpleSettingsScreen extends StatefulWidget {
  const SimpleSettingsScreen({super.key});

  @override
  State<SimpleSettingsScreen> createState() => _SimpleSettingsScreenState();
}

class _SimpleSettingsScreenState extends State<SimpleSettingsScreen> {
  bool _simpleModeEnabled = true;

  @override
  void initState() {
    super.initState();
    _loadSettings();
  }

  Future<void> _loadSettings() async {
    await simpleModeService.initialize();
    setState(() {
      _simpleModeEnabled = simpleModeService.isEnabled;
    });
  }

  Future<void> _toggleSimpleMode(bool value) async {
    await simpleModeService.setEnabled(value);
    setState(() => _simpleModeEnabled = value);
    HapticFeedback.selectionClick();
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return Scaffold(
      backgroundColor: context.appColors.background,
      body: SafeArea(
        child: Column(
          children: [
            // Header
            Padding(
              padding: const EdgeInsets.all(16),
              child: Text(
                l10n.simpleSettings,
                style: TextStyle(
                  fontSize: 20,
                  fontWeight: FontWeight.w700,
                  color: context.appColors.textPrimary,
                ),
              ),
            ),

            // Settings List
            Expanded(
              child: ListView(
                padding: const EdgeInsets.symmetric(horizontal: 16),
                children: [
                  // Currency
                  _buildSettingTile(
                    icon: CupertinoIcons.money_dollar_circle,
                    iconColor: AppColors.achievementStreak,
                    title: l10n.settingsCurrency,
                    trailing: _buildCurrencyTrailing(),
                    onTap: () => showCurrencySelector(context),
                  ),

                  const SizedBox(height: 8),

                  // Language
                  _buildSettingTile(
                    icon: CupertinoIcons.globe,
                    iconColor: AppColors.categoryEntertainment,
                    title: l10n.settingsLanguage,
                    trailing: _buildLanguageTrailing(),
                    onTap: () => _showLanguageSelector(),
                  ),

                  const SizedBox(height: 8),

                  // Theme
                  _buildSettingTile(
                    icon: CupertinoIcons.moon_fill,
                    iconColor: AppColors.categoryShopping,
                    title: l10n.settingsTheme,
                    trailing: _buildThemeTrailing(),
                    onTap: () => _showThemeSelector(),
                  ),

                  const SizedBox(height: 24),

                  // Simple Mode Toggle
                  _buildSettingTile(
                    icon: CupertinoIcons.leaf_arrow_circlepath,
                    iconColor: AppColors.premiumGreen,
                    title: l10n.simpleMode,
                    subtitle: l10n.simpleModeDescription,
                    trailing: Switch.adaptive(
                      value: _simpleModeEnabled,
                      onChanged: _toggleSimpleMode,
                      activeTrackColor: context.appColors.primary,
                    ),
                  ),

                  const SizedBox(height: 16),

                  // Info text
                  Padding(
                    padding: const EdgeInsets.all(12),
                    child: Text(
                      l10n.simpleModeHint,
                      style: TextStyle(
                        fontSize: 13,
                        color: context.appColors.textTertiary,
                      ),
                      textAlign: TextAlign.center,
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildSettingTile({
    required IconData icon,
    required Color iconColor,
    required String title,
    String? subtitle,
    Widget? trailing,
    VoidCallback? onTap,
  }) {
    return Container(
      decoration: BoxDecoration(
        color: context.appColors.surfaceLight,
        borderRadius: BorderRadius.circular(16),
      ),
      child: Material(
        color: Colors.transparent,
        child: InkWell(
          onTap: onTap,
          borderRadius: BorderRadius.circular(16),
          child: Padding(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
            child: Row(
              children: [
                Container(
                  width: 36,
                  height: 36,
                  decoration: BoxDecoration(
                    color: iconColor.withValues(alpha: 0.15),
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Icon(icon, size: 20, color: iconColor),
                ),
                const SizedBox(width: 14),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        title,
                        style: TextStyle(
                          fontSize: 15,
                          fontWeight: FontWeight.w500,
                          color: context.appColors.textPrimary,
                        ),
                      ),
                      if (subtitle != null) ...[
                        const SizedBox(height: 2),
                        Text(
                          subtitle,
                          style: TextStyle(
                            fontSize: 12,
                            color: context.appColors.textSecondary,
                          ),
                        ),
                      ],
                    ],
                  ),
                ),
                if (trailing != null) trailing,
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildCurrencyTrailing() {
    final currencyProvider = context.watch<CurrencyProvider>();
    final currency = currencyProvider.currency;

    return Row(
      mainAxisSize: MainAxisSize.min,
      children: [
        Text(currency.flag, style: const TextStyle(fontSize: 16)),
        const SizedBox(width: 6),
        Text(
          currency.code,
          style: TextStyle(
            color: context.appColors.textSecondary,
            fontSize: 14,
            fontWeight: FontWeight.w500,
          ),
        ),
        const SizedBox(width: 4),
        Icon(
          CupertinoIcons.chevron_right,
          size: 18,
          color: context.appColors.textTertiary,
        ),
      ],
    );
  }

  Widget _buildLanguageTrailing() {
    final localeProvider = context.watch<LocaleProvider>();
    final currentLang = localeProvider.locale?.languageCode ?? 'tr';
    final langName = currentLang == 'tr' ? 'Turkce' : 'English';

    return Row(
      mainAxisSize: MainAxisSize.min,
      children: [
        Text(
          langName,
          style: TextStyle(
            color: context.appColors.textSecondary,
            fontSize: 14,
            fontWeight: FontWeight.w500,
          ),
        ),
        const SizedBox(width: 4),
        Icon(
          CupertinoIcons.chevron_right,
          size: 18,
          color: context.appColors.textTertiary,
        ),
      ],
    );
  }

  Widget _buildThemeTrailing() {
    final themeProvider = context.watch<ThemeProvider>();
    final l10n = AppLocalizations.of(context);

    String themeName;
    switch (themeProvider.themeMode) {
      case AppThemeMode.dark:
        themeName = l10n.settingsThemeDark;
        break;
      case AppThemeMode.light:
        themeName = l10n.settingsThemeLight;
        break;
      case AppThemeMode.automatic:
        themeName = l10n.settingsThemeAutomatic;
        break;
    }

    return Row(
      mainAxisSize: MainAxisSize.min,
      children: [
        Text(
          themeName,
          style: TextStyle(
            color: context.appColors.textSecondary,
            fontSize: 14,
            fontWeight: FontWeight.w500,
          ),
        ),
        const SizedBox(width: 4),
        Icon(
          CupertinoIcons.chevron_right,
          size: 18,
          color: context.appColors.textTertiary,
        ),
      ],
    );
  }

  void _showLanguageSelector() {
    final localeProvider = context.read<LocaleProvider>();

    showModalBottomSheet(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      backgroundColor: context.appColors.surface,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      builder: (context) => SafeArea(
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Container(
              width: 40,
              height: 4,
              margin: const EdgeInsets.only(top: 12, bottom: 20),
              decoration: BoxDecoration(
                color: context.appColors.textTertiary.withValues(alpha: 0.3),
                borderRadius: BorderRadius.circular(2),
              ),
            ),
            ListTile(
              leading: const Text('🇹🇷', style: TextStyle(fontSize: 24)),
              title: const Text('Turkce'),
              trailing: localeProvider.locale?.languageCode == 'tr'
                  ? Icon(
                      CupertinoIcons.checkmark_circle_fill,
                      color: context.appColors.primary,
                    )
                  : null,
              onTap: () {
                localeProvider.setLocale(const Locale('tr'));
                Navigator.pop(context);
                HapticFeedback.selectionClick();
              },
            ),
            ListTile(
              leading: const Text('🇺🇸', style: TextStyle(fontSize: 24)),
              title: const Text('English'),
              trailing: localeProvider.locale?.languageCode == 'en'
                  ? Icon(
                      CupertinoIcons.checkmark_circle_fill,
                      color: context.appColors.primary,
                    )
                  : null,
              onTap: () {
                localeProvider.setLocale(const Locale('en'));
                Navigator.pop(context);
                HapticFeedback.selectionClick();
              },
            ),
            const SizedBox(height: 20),
          ],
        ),
      ),
    );
  }

  void _showThemeSelector() {
    final themeProvider = context.read<ThemeProvider>();
    final l10n = AppLocalizations.of(context);

    showModalBottomSheet(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      backgroundColor: context.appColors.surface,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      builder: (context) => SafeArea(
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Container(
              width: 40,
              height: 4,
              margin: const EdgeInsets.only(top: 12, bottom: 20),
              decoration: BoxDecoration(
                color: context.appColors.textTertiary.withValues(alpha: 0.3),
                borderRadius: BorderRadius.circular(2),
              ),
            ),
            ListTile(
              leading: Icon(
                CupertinoIcons.moon_fill,
                color: context.appColors.textPrimary,
              ),
              title: Text(l10n.settingsThemeDark),
              trailing: themeProvider.themeMode == AppThemeMode.dark
                  ? Icon(
                      CupertinoIcons.checkmark_circle_fill,
                      color: context.appColors.primary,
                    )
                  : null,
              onTap: () {
                themeProvider.setThemeMode(AppThemeMode.dark);
                Navigator.pop(context);
                HapticFeedback.selectionClick();
              },
            ),
            ListTile(
              leading: Icon(
                CupertinoIcons.sun_max_fill,
                color: context.appColors.textPrimary,
              ),
              title: Text(l10n.settingsThemeLight),
              trailing: themeProvider.themeMode == AppThemeMode.light
                  ? Icon(
                      CupertinoIcons.checkmark_circle_fill,
                      color: context.appColors.primary,
                    )
                  : null,
              onTap: () {
                themeProvider.setThemeMode(AppThemeMode.light);
                Navigator.pop(context);
                HapticFeedback.selectionClick();
              },
            ),
            ListTile(
              leading: Icon(
                CupertinoIcons.clock_fill,
                color: context.appColors.textPrimary,
              ),
              title: Text(l10n.settingsThemeAutomatic),
              subtitle: Text(
                '07:00-19:00 ☀️ / 19:00-07:00 🌙',
                style: TextStyle(
                  fontSize: 12,
                  color: context.appColors.textTertiary,
                ),
              ),
              trailing: themeProvider.themeMode == AppThemeMode.automatic
                  ? Icon(
                      CupertinoIcons.checkmark_circle_fill,
                      color: context.appColors.primary,
                    )
                  : null,
              onTap: () {
                themeProvider.setThemeMode(AppThemeMode.automatic);
                Navigator.pop(context);
                HapticFeedback.selectionClick();
              },
            ),
            const SizedBox(height: 20),
          ],
        ),
      ),
    );
  }
}


--- FILE: lib/screens/simple/simple_statistics_screen.dart ---

import 'package:fl_chart/fl_chart.dart';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:intl/intl.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../../models/models.dart';
import '../../providers/providers.dart';
import '../../theme/theme.dart';
import '../../utils/currency_utils.dart';

/// Simple Mode - Statistics Screen with pie chart
class SimpleStatisticsScreen extends StatefulWidget {
  const SimpleStatisticsScreen({super.key});

  @override
  State<SimpleStatisticsScreen> createState() => _SimpleStatisticsScreenState();
}

class _SimpleStatisticsScreenState extends State<SimpleStatisticsScreen>
    with SingleTickerProviderStateMixin {
  late TabController _tabController;
  DateTime _selectedMonth = DateTime.now();

  // Category colors
  static const Map<String, Color> _categoryColors = {
    'Yiyecek': Color(0xFF4CAF50),
    'Food': Color(0xFF4CAF50),
    'Ulaşım': Color(0xFF2196F3),
    'Transport': Color(0xFF2196F3),
    'Alışveriş': Color(0xFFE91E63),
    'Shopping': Color(0xFFE91E63),
    'Faturalar': Color(0xFFFF9800),
    'Bills': Color(0xFFFF9800),
    'Eğlence': Color(0xFF9C27B0),
    'Entertainment': Color(0xFF9C27B0),
    'Sağlık': Color(0xFF00BCD4),
    'Health': Color(0xFF00BCD4),
    'Eğitim': Color(0xFF795548),
    'Education': Color(0xFF795548),
    'Diğer': Color(0xFF607D8B),
    'Other': Color(0xFF607D8B),
  };

  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 2, vsync: this);
  }

  @override
  void dispose() {
    _tabController.dispose();
    super.dispose();
  }

  void _previousMonth() {
    HapticFeedback.selectionClick();
    setState(() {
      _selectedMonth = DateTime(_selectedMonth.year, _selectedMonth.month - 1);
    });
  }

  void _nextMonth() {
    HapticFeedback.selectionClick();
    final now = DateTime.now();
    final nextMonth = DateTime(_selectedMonth.year, _selectedMonth.month + 1);
    if (nextMonth.isBefore(DateTime(now.year, now.month + 1))) {
      setState(() {
        _selectedMonth = nextMonth;
      });
    }
  }

  List<Expense> _getMonthExpenses(List<Expense> allExpenses) {
    return allExpenses.where((e) {
      return e.date.year == _selectedMonth.year &&
          e.date.month == _selectedMonth.month &&
          e.decision == ExpenseDecision.yes;
    }).toList();
  }

  Map<String, double> _getCategoryTotals(List<Expense> expenses) {
    final totals = <String, double>{};
    for (final expense in expenses) {
      final category = expense.category;
      totals[category] = (totals[category] ?? 0) + expense.amount;
    }
    // Sort by amount descending
    final sorted = totals.entries.toList()
      ..sort((a, b) => b.value.compareTo(a.value));
    return Map.fromEntries(sorted);
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final financeProvider = context.watch<FinanceProvider>();
    final currencyProvider = context.watch<CurrencyProvider>();
    final expenses = financeProvider.realExpenses;
    final monthExpenses = _getMonthExpenses(expenses);
    final categoryTotals = _getCategoryTotals(monthExpenses);
    final totalExpense = categoryTotals.values.fold(0.0, (a, b) => a + b);
    final currencySymbol = currencyProvider.currency.symbol;

    return Scaffold(
      backgroundColor: context.appColors.background,
      body: SafeArea(
        child: Column(
          children: [
            // Header
            Padding(
              padding: const EdgeInsets.all(16),
              child: Text(
                l10n.simpleStatistics,
                style: TextStyle(
                  fontSize: 20,
                  fontWeight: FontWeight.w700,
                  color: context.appColors.textPrimary,
                ),
              ),
            ),

            // Month Selector
            _buildMonthSelector(l10n),

            // Tab Bar
            Container(
              margin: const EdgeInsets.symmetric(horizontal: 16),
              decoration: BoxDecoration(
                color: context.appColors.surfaceLight,
                borderRadius: BorderRadius.circular(16),
              ),
              child: TabBar(
                controller: _tabController,
                indicator: BoxDecoration(
                  color: context.appColors.primary,
                  borderRadius: BorderRadius.circular(8),
                ),
                indicatorSize: TabBarIndicatorSize.tab,
                labelColor: context.appColors.textPrimary,
                unselectedLabelColor: context.appColors.textSecondary,
                dividerColor: Colors.transparent,
                labelStyle: const TextStyle(
                  fontWeight: FontWeight.w600,
                  fontSize: 14,
                ),
                tabs: [
                  Tab(text: l10n.simpleExpenses),
                  Tab(text: l10n.simpleIncomeTab),
                ],
              ),
            ),

            const SizedBox(height: 16),

            // Tab Content
            Expanded(
              child: TabBarView(
                controller: _tabController,
                children: [
                  // Expenses Tab
                  _buildExpensesTab(
                    categoryTotals,
                    totalExpense,
                    currencySymbol,
                    l10n,
                  ),
                  // Income Tab (simplified)
                  _buildIncomeTab(financeProvider, currencySymbol, l10n),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildMonthSelector(AppLocalizations l10n) {
    final now = DateTime.now();
    final isCurrentMonth =
        _selectedMonth.year == now.year && _selectedMonth.month == now.month;

    final locale = Localizations.localeOf(context).languageCode;
    final monthFormat = DateFormat.yMMMM(locale);
    final monthName = monthFormat.format(_selectedMonth);

    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          IconButton(
            onPressed: _previousMonth,
            icon: Icon(
              CupertinoIcons.chevron_left,
              color: context.appColors.textPrimary,
              size: 20,
            ),
          ),
          Text(
            monthName,
            style: TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.w600,
              color: context.appColors.textPrimary,
            ),
          ),
          IconButton(
            onPressed: isCurrentMonth ? null : _nextMonth,
            icon: Icon(
              CupertinoIcons.chevron_right,
              color: isCurrentMonth
                  ? context.appColors.textTertiary
                  : context.appColors.textPrimary,
              size: 20,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildExpensesTab(
    Map<String, double> categoryTotals,
    double totalExpense,
    String currencySymbol,
    AppLocalizations l10n,
  ) {
    if (categoryTotals.isEmpty) {
      return Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              CupertinoIcons.chart_pie,
              size: 64,
              color: context.appColors.textTertiary,
            ),
            const SizedBox(height: 16),
            Text(
              l10n.simpleNoData,
              style: TextStyle(
                fontSize: 16,
                color: context.appColors.textSecondary,
              ),
            ),
          ],
        ),
      );
    }

    return SingleChildScrollView(
      padding: const EdgeInsets.symmetric(horizontal: 16),
      child: Column(
        children: [
          // Pie Chart
          SizedBox(
            height: 200,
            child: PieChart(
              PieChartData(
                sections: _buildPieSections(categoryTotals, totalExpense),
                centerSpaceRadius: 50,
                sectionsSpace: 2,
              ),
            ),
          ),

          const SizedBox(height: 24),

          // Total
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: context.appColors.surfaceLight,
              borderRadius: BorderRadius.circular(16),
            ),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text(
                  l10n.simpleTotal,
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.w600,
                    color: context.appColors.textPrimary,
                  ),
                ),
                Text(
                  '$currencySymbol${formatTurkishCurrency(totalExpense, decimalDigits: 0)}',
                  style: TextStyle(
                    fontSize: 18,
                    fontWeight: FontWeight.w700,
                    color: context.appColors.error,
                  ),
                ),
              ],
            ),
          ),

          const SizedBox(height: 16),

          // Category List
          ...categoryTotals.entries.map((entry) {
            final percentage = (entry.value / totalExpense * 100);
            final color =
                _categoryColors[entry.key] ?? context.appColors.textTertiary;

            return Container(
              margin: const EdgeInsets.only(bottom: 8),
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: context.appColors.surfaceLight,
                borderRadius: BorderRadius.circular(8),
              ),
              child: Row(
                children: [
                  Container(
                    width: 12,
                    height: 12,
                    decoration: BoxDecoration(
                      color: color,
                      shape: BoxShape.circle,
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Text(
                      entry.key,
                      style: TextStyle(
                        fontSize: 14,
                        color: context.appColors.textPrimary,
                      ),
                    ),
                  ),
                  Text(
                    '${percentage.toStringAsFixed(1)}%',
                    style: TextStyle(
                      fontSize: 13,
                      color: context.appColors.textSecondary,
                    ),
                  ),
                  const SizedBox(width: 16),
                  Text(
                    '$currencySymbol${formatTurkishCurrency(entry.value, decimalDigits: 0)}',
                    style: TextStyle(
                      fontSize: 14,
                      fontWeight: FontWeight.w600,
                      color: context.appColors.textPrimary,
                    ),
                  ),
                ],
              ),
            );
          }),

          const SizedBox(height: 24),
        ],
      ),
    );
  }

  List<PieChartSectionData> _buildPieSections(
    Map<String, double> categoryTotals,
    double total,
  ) {
    return categoryTotals.entries.map((entry) {
      final percentage = entry.value / total * 100;
      final color =
          _categoryColors[entry.key] ?? context.appColors.textTertiary;

      return PieChartSectionData(
        value: entry.value,
        color: color,
        radius: 35,
        title: percentage >= 5 ? '${percentage.toStringAsFixed(0)}%' : '',
        titleStyle: TextStyle(
          fontSize: 11,
          fontWeight: FontWeight.bold,
          color: context.appColors.textPrimary,
        ),
      );
    }).toList();
  }

  Widget _buildIncomeTab(
    FinanceProvider financeProvider,
    String currencySymbol,
    AppLocalizations l10n,
  ) {
    final profile = financeProvider.userProfile;
    final totalIncome = profile?.monthlyIncome ?? 0;
    final incomeSources = profile?.incomeSources ?? [];

    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        children: [
          // Total Income
          Container(
            padding: const EdgeInsets.all(20),
            decoration: BoxDecoration(
              color: context.appColors.success.withValues(alpha: 0.15),
              borderRadius: BorderRadius.circular(16),
              border: Border.all(
                color: context.appColors.success.withValues(alpha: 0.3),
              ),
            ),
            child: Column(
              children: [
                Text(
                  l10n.simpleTotalIncome,
                  style: TextStyle(
                    fontSize: 14,
                    color: context.appColors.textSecondary,
                  ),
                ),
                const SizedBox(height: 8),
                Text(
                  '$currencySymbol${formatTurkishCurrency(totalIncome, decimalDigits: 0)}',
                  style: TextStyle(
                    fontSize: 32,
                    fontWeight: FontWeight.w700,
                    color: context.appColors.success,
                  ),
                ),
              ],
            ),
          ),

          const SizedBox(height: 24),

          // Income Sources
          if (incomeSources.isNotEmpty) ...[
            Align(
              alignment: Alignment.centerLeft,
              child: Text(
                l10n.simpleIncomeSources,
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textPrimary,
                ),
              ),
            ),
            const SizedBox(height: 12),
            ...incomeSources.map((source) {
              return Container(
                margin: const EdgeInsets.only(bottom: 8),
                padding: const EdgeInsets.all(14),
                decoration: BoxDecoration(
                  color: context.appColors.surfaceLight,
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Row(
                  children: [
                    Icon(
                      source.category.icon,
                      color: source.category.color,
                      size: 20,
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Text(
                        source.title,
                        style: TextStyle(
                          fontSize: 14,
                          color: context.appColors.textPrimary,
                        ),
                      ),
                    ),
                    Text(
                      '$currencySymbol${formatTurkishCurrency(source.amount, decimalDigits: 0)}',
                      style: TextStyle(
                        fontSize: 14,
                        fontWeight: FontWeight.w600,
                        color: context.appColors.success,
                      ),
                    ),
                  ],
                ),
              );
            }),
          ],
        ],
      ),
    );
  }
}


--- FILE: lib/screens/simple/simple_main_screen.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../../theme/theme.dart';
import '../../widgets/add_expense_sheet.dart';
import '../../services/services.dart';
import '../../providers/providers.dart';
import '../lock_screen.dart';
import 'simple_transactions_screen.dart';
import 'simple_statistics_screen.dart';
import 'simple_settings_screen.dart';

/// Simple Mode - Main Screen with 3-tab navigation
class SimpleMainScreen extends StatefulWidget {
  const SimpleMainScreen({super.key});

  @override
  State<SimpleMainScreen> createState() => _SimpleMainScreenState();
}

class _SimpleMainScreenState extends State<SimpleMainScreen>
    with WidgetsBindingObserver {
  int _currentIndex = 0;

  // Lock state
  bool _isLocked = false;
  bool _checkingLock = true;
  bool _wasInBackground = false;

  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addObserver(this);
    _checkLockStatus();

    // Status bar style
    SystemChrome.setSystemUIOverlayStyle(
      const SystemUiOverlayStyle(
        statusBarColor: Colors.transparent,
        statusBarIconBrightness: Brightness.light,
        systemNavigationBarColor: Color(0xFF1A1A2E),
        systemNavigationBarIconBrightness: Brightness.light,
      ),
    );
  }

  @override
  void dispose() {
    WidgetsBinding.instance.removeObserver(this);
    super.dispose();
  }

  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    if (state == AppLifecycleState.paused) {
      _wasInBackground = true;
      // Clean up simulation expenses when app goes to background
      _cleanupSimulations();
    } else if (state == AppLifecycleState.resumed && _wasInBackground) {
      _wasInBackground = false;
      _checkLockOnResume();
      // Refresh theme for time-based automatic mode
      context.read<ThemeProvider>().refreshTheme();
    } else if (state == AppLifecycleState.detached) {
      // Clean up simulation expenses when app is closing
      _cleanupSimulations();
    }
  }

  /// Clean up simulation expenses - they shouldn't persist
  Future<void> _cleanupSimulations() async {
    try {
      await ExpenseHistoryService().clearSimulations();
      // Refresh provider to reflect changes
      if (mounted) {
        context.read<FinanceProvider>().refresh();
      }
    } catch (e) {
      debugPrint('[SimpleMode Cleanup] Error clearing simulations: $e');
    }
  }

  Future<void> _checkLockStatus() async {
    final lockEnabled = await LockService.isLockEnabled();
    final hasPinSet = await LockService.hasPinSet();

    if (mounted) {
      setState(() {
        _isLocked = lockEnabled && hasPinSet;
        _checkingLock = false;
      });
    }
  }

  Future<void> _checkLockOnResume() async {
    final lockEnabled = await LockService.isLockEnabled();
    final hasPinSet = await LockService.hasPinSet();

    if (lockEnabled && hasPinSet && mounted) {
      setState(() => _isLocked = true);
    }
  }

  void _onUnlocked() {
    setState(() => _isLocked = false);
  }

  void _onNavTap(int index) {
    HapticFeedback.selectionClick();
    setState(() => _currentIndex = index);
  }

  void _showAddExpenseSheet() {
    showAddExpenseSheet(
      context,
      onExpenseAdded: () {
        HapticFeedback.mediumImpact();
        // Navigate to transactions tab
        if (_currentIndex != 0) {
          setState(() => _currentIndex = 0);
        }
      },
    );
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    // Show loading while checking lock status
    if (_checkingLock) {
      return Scaffold(
        backgroundColor: context.appColors.background,
        body: const SizedBox.shrink(),
      );
    }

    // Show lock screen if locked
    if (_isLocked) {
      return LockScreen(onUnlocked: _onUnlocked);
    }

    return Scaffold(
      backgroundColor: context.appColors.background,
      body: IndexedStack(
        index: _currentIndex,
        children: const [
          SimpleTransactionsScreen(),
          SimpleStatisticsScreen(),
          SimpleSettingsScreen(),
        ],
      ),
      bottomNavigationBar: _buildBottomNavBar(l10n),
      floatingActionButton: _buildFab(),
      floatingActionButtonLocation: FloatingActionButtonLocation.centerDocked,
    );
  }

  Widget _buildBottomNavBar(AppLocalizations l10n) {
    return Container(
      decoration: BoxDecoration(
        color: context.appColors.surface,
        border: Border(
          top: BorderSide(color: context.appColors.cardBorder, width: 1),
        ),
      ),
      child: SafeArea(
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 8),
          child: Row(
            mainAxisAlignment: MainAxisAlignment.spaceAround,
            children: [
              // Transactions Tab
              _buildNavItem(
                icon: CupertinoIcons.list_bullet,
                iconOutline: CupertinoIcons.list_bullet,
                label: l10n.simpleTransactions,
                index: 0,
              ),

              // Spacer for FAB
              const SizedBox(width: 64),

              // Statistics Tab
              _buildNavItem(
                icon: CupertinoIcons.chart_pie_fill,
                iconOutline: CupertinoIcons.chart_pie,
                label: l10n.simpleStatistics,
                index: 1,
              ),

              // Settings Tab
              _buildNavItem(
                icon: CupertinoIcons.gear_solid,
                iconOutline: CupertinoIcons.gear,
                label: l10n.simpleSettings,
                index: 2,
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildNavItem({
    required IconData icon,
    required IconData iconOutline,
    required String label,
    required int index,
  }) {
    final isSelected = _currentIndex == index;

    return Expanded(
      child: InkWell(
        onTap: () => _onNavTap(index),
        borderRadius: BorderRadius.circular(16),
        child: Padding(
          padding: const EdgeInsets.symmetric(vertical: 8),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Icon(
                isSelected ? icon : iconOutline,
                size: 24,
                color: isSelected
                    ? context.appColors.primary
                    : context.appColors.textTertiary,
              ),
              const SizedBox(height: 4),
              Text(
                label,
                style: TextStyle(
                  fontSize: 11,
                  fontWeight: isSelected ? FontWeight.w600 : FontWeight.w400,
                  color: isSelected
                      ? context.appColors.primary
                      : context.appColors.textTertiary,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildFab() {
    return Container(
      width: 56,
      height: 56,
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [context.appColors.primary, context.appColors.secondary],
        ),
        shape: BoxShape.circle,
        boxShadow: [
          BoxShadow(
            color: context.appColors.primary.withValues(alpha: 0.4),
            blurRadius: 12,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Material(
        color: Colors.transparent,
        child: InkWell(
          onTap: _showAddExpenseSheet,
          borderRadius: BorderRadius.circular(28),
          child: Icon(
            CupertinoIcons.plus,
            size: 28,
            color: context.appColors.textPrimary,
          ),
        ),
      ),
    );
  }
}


--- FILE: lib/screens/credit_purchase_screen.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../theme/theme.dart';
import '../services/purchase_service.dart';

/// Credit pack definitions
enum CreditPack {
  small(id: 'credit_pack_50', credits: 50, price: 29.99),
  medium(id: 'credit_pack_150', credits: 150, price: 69.99),
  large(id: 'credit_pack_500', credits: 500, price: 149.99);

  final String id;
  final int credits;
  final double price;

  const CreditPack({
    required this.id,
    required this.credits,
    required this.price,
  });

  /// Price per credit for comparison
  double get pricePerCredit => price / credits;
}

/// Credit Purchase Screen for Lifetime users
class CreditPurchaseScreen extends StatefulWidget {
  const CreditPurchaseScreen({super.key});

  @override
  State<CreditPurchaseScreen> createState() => _CreditPurchaseScreenState();
}

class _CreditPurchaseScreenState extends State<CreditPurchaseScreen> {
  bool _isPurchasing = false;
  String? _purchasingPackId;
  int _currentCredits = 0;

  @override
  void initState() {
    super.initState();
    _loadCurrentCredits();
  }

  Future<void> _loadCurrentCredits() async {
    final credits = await PurchaseService().getExtraCredits();
    if (mounted) {
      setState(() => _currentCredits = credits);
    }
  }

  Future<void> _purchasePack(CreditPack pack) async {
    if (_isPurchasing) return;

    setState(() {
      _isPurchasing = true;
      _purchasingPackId = pack.id;
    });

    HapticFeedback.mediumImpact();

    try {
      final result = await PurchaseService().purchaseCreditPack(pack.id);

      if (mounted) {
        if (result.success) {
          // Credits added successfully
          await _loadCurrentCredits();

          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Row(
                children: [
                  Icon(
                    CupertinoIcons.checkmark_circle_fill,
                    color: context.appColors.textPrimary,
                    size: 20,
                  ),
                  const SizedBox(width: 10),
                  Expanded(
                    child: Text(
                      AppLocalizations.of(
                        context,
                      ).creditPurchaseSuccess(pack.credits),
                      style: const TextStyle(fontWeight: FontWeight.w500),
                    ),
                  ),
                ],
              ),
              behavior: SnackBarBehavior.floating,
              backgroundColor: context.appColors.success,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(16),
              ),
            ),
          );
        } else {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text(result.message),
              behavior: SnackBarBehavior.floating,
              backgroundColor: context.appColors.error,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(16),
              ),
            ),
          );
        }
      }
    } finally {
      if (mounted) {
        setState(() {
          _isPurchasing = false;
          _purchasingPackId = null;
        });
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return Scaffold(
      backgroundColor: context.appColors.background,
      appBar: AppBar(
        backgroundColor: Colors.transparent,
        elevation: 0,
        leading: IconButton(
          icon: Icon(
            CupertinoIcons.chevron_left,
            color: context.appColors.textPrimary,
          ),
          tooltip: l10n.goBack,
          onPressed: () => Navigator.pop(context),
        ),
        title: Text(
          l10n.creditPurchaseTitle,
          style: TextStyle(
            fontSize: 18,
            fontWeight: FontWeight.w600,
            color: context.appColors.textPrimary,
          ),
        ),
        centerTitle: true,
      ),
      body: SafeArea(
        child: SingleChildScrollView(
          padding: const EdgeInsets.all(20),
          child: Column(
            children: [
              // Current credits display
              _buildCurrentCreditsCard(l10n),

              const SizedBox(height: 32),

              // Header
              _buildHeader(l10n),

              const SizedBox(height: 24),

              // Credit packs
              _buildPackCard(pack: CreditPack.small, l10n: l10n),
              const SizedBox(height: 16),
              _buildPackCard(
                pack: CreditPack.medium,
                l10n: l10n,
                badge: l10n.creditPackPopular,
              ),
              const SizedBox(height: 16),
              _buildPackCard(
                pack: CreditPack.large,
                l10n: l10n,
                badge: l10n.creditPackBestValue,
              ),

              const SizedBox(height: 32),

              // Footer info
              _buildFooterInfo(l10n),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildCurrentCreditsCard(AppLocalizations l10n) {
    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            context.appColors.primary.withValues(alpha: 0.15),
            context.appColors.secondary.withValues(alpha: 0.15),
          ],
        ),
        borderRadius: BorderRadius.circular(24),
        border: Border.all(
          color: context.appColors.primary.withValues(alpha: 0.3),
        ),
      ),
      child: Row(
        children: [
          Container(
            width: 48,
            height: 48,
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [
                  context.appColors.primary,
                  context.appColors.secondary,
                ],
              ),
              borderRadius: BorderRadius.circular(16),
            ),
            child: Icon(
              CupertinoIcons.money_dollar_circle_fill,
              size: 24,
              color: context.appColors.textPrimary,
            ),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  l10n.creditCurrentBalance,
                  style: TextStyle(
                    fontSize: 13,
                    color: context.appColors.textSecondary,
                  ),
                ),
                const SizedBox(height: 4),
                Text(
                  l10n.creditAmount(_currentCredits),
                  style: TextStyle(
                    fontSize: 24,
                    fontWeight: FontWeight.w700,
                    color: context.appColors.textPrimary,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildHeader(AppLocalizations l10n) {
    return Column(
      children: [
        Container(
          width: 64,
          height: 64,
          decoration: BoxDecoration(
            gradient: LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: [
                context.appColors.primary.withValues(alpha: 0.2),
                context.appColors.secondary.withValues(alpha: 0.2),
              ],
            ),
            borderRadius: BorderRadius.circular(16),
          ),
          child: Icon(
            CupertinoIcons.bolt_fill,
            size: 32,
            color: context.appColors.primary,
          ),
        ),
        const SizedBox(height: 16),
        Text(
          l10n.creditPurchaseHeader,
          style: TextStyle(
            fontSize: 22,
            fontWeight: FontWeight.w700,
            color: context.appColors.textPrimary,
          ),
          textAlign: TextAlign.center,
        ),
        const SizedBox(height: 8),
        Text(
          l10n.creditPurchaseSubtitle,
          style: TextStyle(
            fontSize: 14,
            color: context.appColors.textSecondary,
            height: 1.5,
          ),
          textAlign: TextAlign.center,
        ),
      ],
    );
  }

  Widget _buildPackCard({
    required CreditPack pack,
    required AppLocalizations l10n,
    String? badge,
  }) {
    final isLoading = _isPurchasing && _purchasingPackId == pack.id;
    final isDisabled = _isPurchasing && _purchasingPackId != pack.id;

    return Opacity(
      opacity: isDisabled ? 0.5 : 1.0,
      child: Container(
        decoration: BoxDecoration(
          color: context.appColors.surface,
          borderRadius: BorderRadius.circular(24),
          border: Border.all(
            color: badge != null
                ? context.appColors.primary.withValues(alpha: 0.5)
                : context.appColors.cardBorder,
            width: badge != null ? 2 : 1,
          ),
          boxShadow: badge != null
              ? [
                  BoxShadow(
                    color: context.appColors.primary.withValues(alpha: 0.2),
                    blurRadius: 20,
                    offset: const Offset(0, 5),
                  ),
                ]
              : null,
        ),
        child: Material(
          color: Colors.transparent,
          child: InkWell(
            onTap: isDisabled ? null : () => _purchasePack(pack),
            borderRadius: BorderRadius.circular(24),
            child: Stack(
              children: [
                Padding(
                  padding: const EdgeInsets.all(20),
                  child: Row(
                    children: [
                      // Credits icon
                      Container(
                        width: 56,
                        height: 56,
                        decoration: BoxDecoration(
                          gradient: LinearGradient(
                            begin: Alignment.topLeft,
                            end: Alignment.bottomRight,
                            colors: [
                              context.appColors.primary.withValues(alpha: 0.15),
                              context.appColors.secondary.withValues(
                                alpha: 0.15,
                              ),
                            ],
                          ),
                          borderRadius: BorderRadius.circular(16),
                        ),
                        child: Center(
                          child: Text(
                            '${pack.credits}',
                            style: TextStyle(
                              fontSize: pack.credits >= 100 ? 18 : 22,
                              fontWeight: FontWeight.w800,
                              color: context.appColors.primary,
                            ),
                          ),
                        ),
                      ),
                      const SizedBox(width: 16),

                      // Info
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              l10n.creditPackTitle(pack.credits),
                              style: TextStyle(
                                fontSize: 17,
                                fontWeight: FontWeight.w600,
                                color: context.appColors.textPrimary,
                              ),
                            ),
                            const SizedBox(height: 4),
                            Text(
                              l10n.creditPackPricePerCredit(
                                pack.pricePerCredit.toStringAsFixed(2),
                              ),
                              style: TextStyle(
                                fontSize: 13,
                                color: context.appColors.textTertiary,
                              ),
                            ),
                          ],
                        ),
                      ),

                      // Price
                      Container(
                        padding: const EdgeInsets.symmetric(
                          horizontal: 16,
                          vertical: 10,
                        ),
                        decoration: BoxDecoration(
                          gradient: LinearGradient(
                            colors: [
                              context.appColors.primary,
                              context.appColors.secondary,
                            ],
                          ),
                          borderRadius: BorderRadius.circular(16),
                        ),
                        child: isLoading
                            ? SizedBox(
                                width: 20,
                                height: 20,
                                child: CircularProgressIndicator(
                                  strokeWidth: 2,
                                  color: context.appColors.textPrimary,
                                ),
                              )
                            : Text(
                                '₺${pack.price.toStringAsFixed(2)}',
                                style: TextStyle(
                                  fontSize: 15,
                                  fontWeight: FontWeight.w700,
                                  color: context.appColors.textPrimary,
                                ),
                              ),
                      ),
                    ],
                  ),
                ),

                // Badge
                if (badge != null)
                  Positioned(
                    top: 0,
                    right: 20,
                    child: Container(
                      padding: const EdgeInsets.symmetric(
                        horizontal: 10,
                        vertical: 4,
                      ),
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          colors: [
                            context.appColors.primary,
                            context.appColors.secondary,
                          ],
                        ),
                        borderRadius: const BorderRadius.only(
                          bottomLeft: Radius.circular(8),
                          bottomRight: Radius.circular(8),
                        ),
                      ),
                      child: Text(
                        badge,
                        style: TextStyle(
                          fontSize: 10,
                          fontWeight: FontWeight.w700,
                          color: context.appColors.textPrimary,
                          letterSpacing: 0.5,
                        ),
                      ),
                    ),
                  ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildFooterInfo(AppLocalizations l10n) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: context.appColors.surfaceLight,
        borderRadius: BorderRadius.circular(16),
      ),
      child: Row(
        children: [
          Icon(
            CupertinoIcons.infinite,
            size: 24,
            color: context.appColors.primary,
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Text(
              l10n.creditNeverExpire,
              style: TextStyle(
                fontSize: 13,
                color: context.appColors.textSecondary,
                height: 1.4,
              ),
            ),
          ),
        ],
      ),
    );
  }
}


--- FILE: lib/screens/user_profile_screen.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';
import '../services/services.dart';
import '../providers/providers.dart';
import '../widgets/widgets.dart';
import '../theme/theme.dart';
import 'income_wizard_screen.dart';
import 'onboarding_try_screen.dart';

class UserProfileScreen extends StatefulWidget {
  final UserProfile? existingProfile;

  const UserProfileScreen({super.key, this.existingProfile});

  @override
  State<UserProfileScreen> createState() => _UserProfileScreenState();
}

class _UserProfileScreenState extends State<UserProfileScreen> {
  final _incomeController = TextEditingController();
  final _dailyHoursController = TextEditingController();
  final _budgetController = TextEditingController();
  final _savingsGoalController = TextEditingController();
  final _referralCodeController = TextEditingController();
  final _profileService = ProfileService();
  final _authService = AuthService();
  final _referralService = ReferralService();
  int _workDaysPerWeek = 6;
  bool _isSaving = false;
  List<IncomeSource> _incomeSources = [];
  bool _hasPrefilledReferral = false;

  bool get _isEditMode => widget.existingProfile != null;
  bool get _hasIncomeSources => _incomeSources.isNotEmpty;
  double get _totalIncome =>
      _incomeSources.fold<double>(0, (sum, s) => sum + s.amount);

  void _showError(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: context.appColors.error,
      ),
    );
  }

  void _showSuccess(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: context.appColors.success,
      ),
    );
  }

  /// Google hesabını bağla
  Future<void> _linkWithGoogle() async {
    final l10n = AppLocalizations.of(context);

    try {
      final result = await _authService.signInWithGoogle();

      if (!mounted) return;

      if (result.success) {
        HapticFeedback.mediumImpact();
        _showSuccess(l10n.googleLinkedSuccess);

        // Refresh Pro status after Google Sign-In (links RevenueCat + checks promo)
        if (mounted) {
          await context.read<ProProvider>().onUserLogin();
        }

        setState(() {}); // UI'ı yenile
      } else {
        _showError(result.errorMessage ?? l10n.error);
      }
    } catch (e) {
      if (mounted) {
        _showError('${l10n.error}: $e');
      }
    }
  }

  @override
  void initState() {
    super.initState();
    if (widget.existingProfile != null) {
      _incomeSources = List.from(widget.existingProfile!.incomeSources);
      _dailyHoursController.text = widget.existingProfile!.dailyHours
          .toString();
      _workDaysPerWeek = widget.existingProfile!.workDaysPerWeek;

      // Eğer varolan gelirler varsa, toplam geliri göster
      if (_incomeSources.isNotEmpty) {
        _incomeController.text = formatTurkishCurrency(
          widget.existingProfile!.monthlyIncome,
          decimalDigits: 0,
          showDecimals: false,
        );
      }

      // Bütçe değerlerini doldur
      if (widget.existingProfile!.monthlyBudget != null) {
        _budgetController.text = formatTurkishCurrency(
          widget.existingProfile!.monthlyBudget!,
          decimalDigits: 0,
          showDecimals: false,
        );
      }
      if (widget.existingProfile!.monthlySavingsGoal != null) {
        _savingsGoalController.text = formatTurkishCurrency(
          widget.existingProfile!.monthlySavingsGoal!,
          decimalDigits: 0,
          showDecimals: false,
        );
      }
    } else {
      // New user - check for pending referral code from deep link
      _checkPendingReferralCode();
      // Set default currency based on locale
      WidgetsBinding.instance.addPostFrameCallback((_) {
        _setDefaultCurrencyFromLocale();
      });
    }
  }

  /// Set default currency based on device locale
  void _setDefaultCurrencyFromLocale() {
    final locale = Localizations.localeOf(context);
    final currencyProvider = context.read<CurrencyProvider>();

    // Map locale to currency code
    String currencyCode;
    switch (locale.countryCode?.toUpperCase() ??
        locale.languageCode.toUpperCase()) {
      case 'TR':
        currencyCode = 'TRY';
        break;
      case 'US':
        currencyCode = 'USD';
        break;
      case 'GB':
      case 'UK':
        currencyCode = 'GBP';
        break;
      case 'SA':
      case 'AE': // UAE also uses similar currency
        currencyCode = 'SAR';
        break;
      case 'DE':
      case 'FR':
      case 'IT':
      case 'ES':
      case 'NL':
      case 'BE':
      case 'AT':
      case 'PT':
      case 'GR':
      case 'IE':
      case 'FI':
        currencyCode = 'EUR';
        break;
      default:
        // Default to TRY for Turkish language, USD otherwise
        currencyCode = locale.languageCode == 'tr' ? 'TRY' : 'USD';
    }

    // Find the currency and set it
    final targetCurrency = supportedCurrencies.firstWhere(
      (c) => c.code == currencyCode,
      orElse: () => supportedCurrencies.first, // Fallback to TRY
    );

    // Only set if different from current
    if (currencyProvider.currency.code != targetCurrency.code) {
      currencyProvider.setCurrency(targetCurrency);
    }
  }

  Future<void> _checkPendingReferralCode() async {
    final pendingCode = await DeepLinkService.getPendingReferralCode();
    if (pendingCode != null && pendingCode.isNotEmpty && mounted) {
      setState(() {
        _referralCodeController.text = pendingCode;
        _hasPrefilledReferral = true;
      });
    }
  }

  @override
  void dispose() {
    _incomeController.dispose();
    _dailyHoursController.dispose();
    _budgetController.dispose();
    _savingsGoalController.dispose();
    _referralCodeController.dispose();
    super.dispose();
  }

  /// Gelir wizard'ını aç
  Future<void> _openIncomeWizard() async {
    await Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) =>
            IncomeWizardScreen(existingSources: _incomeSources),
      ),
    );

    // Wizard kapandıktan sonra Provider'dan güncel veriyi al
    if (mounted) {
      final provider = context.read<FinanceProvider>();
      final profile = provider.userProfile;
      if (profile != null) {
        setState(() {
          _incomeSources = profile.incomeSources;
          _incomeController.text = formatTurkishCurrency(
            _totalIncome,
            decimalDigits: 0,
            showDecimals: false,
          );
        });
        HapticFeedback.lightImpact();
      }
    }
  }

  Future<void> _saveProfile() async {
    final l10n = AppLocalizations.of(context);
    final dailyHours = double.tryParse(_dailyHoursController.text);

    // Gelir kontrolü
    if (_incomeSources.isEmpty) {
      // Eğer manuel gelir girilmişse onu kullan
      final manualIncome = parseAmount(_incomeController.text);
      if (manualIncome == null || manualIncome <= 0) {
        _showError(l10n.error);
        return;
      }
      // Manuel geliri primary income olarak ekle
      _incomeSources = [
        IncomeSource.salary(amount: manualIncome, title: l10n.mainSalary),
      ];
    }

    // Çalışma saati validasyonu
    if (dailyHours == null || dailyHours <= 0) {
      _showError(l10n.error);
      return;
    }

    if (dailyHours > 24) {
      _showError(l10n.error);
      return;
    }

    if (dailyHours > 16) {
      _showError(l10n.error);
      return;
    }

    // Yeni kullanıcı için Google bağlantı popup'ı göster
    if (!_isEditMode && !_authService.isLinkedWithGoogle) {
      final shouldLink = await _showGoogleLinkDialog(l10n);
      if (shouldLink == true) {
        await _linkWithGoogle();
      }
    }

    if (!mounted) return;

    setState(() => _isSaving = true);

    // Bütçe değerlerini parse et
    final budget = parseTurkishCurrency(_budgetController.text);
    final savingsGoal = parseTurkishCurrency(_savingsGoalController.text);

    final profile = UserProfile(
      incomeSources: _incomeSources,
      dailyHours: dailyHours,
      workDaysPerWeek: _workDaysPerWeek,
      monthlyBudget: budget,
      monthlySavingsGoal: savingsGoal,
    );

    await _profileService.saveProfile(profile);

    if (!mounted) return;

    // FinanceProvider'ı güncelle
    final financeProvider = context.read<FinanceProvider>();
    financeProvider.setUserProfile(profile);

    // Apply referral code if provided (new users only)
    if (!_isEditMode) {
      final referralCode = _referralCodeController.text.trim().toUpperCase();
      if (referralCode.isNotEmpty) {
        final result = await _referralService.applyReferralCode(referralCode);
        if (result.success && mounted) {
          // Clear the pending referral code
          await DeepLinkService.clearPendingReferralCode();
          // Show success message
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text(l10n.welcomeReferred),
              backgroundColor: context.appColors.success,
              behavior: SnackBarBehavior.floating,
            ),
          );
        }
      }
    }

    HapticFeedback.mediumImpact();

    if (_isEditMode) {
      Navigator.pop(context, profile);
    } else {
      // Go to "Aha Moment" try screen before main app
      Navigator.pushReplacement(
        context,
        MaterialPageRoute(builder: (context) => const OnboardingTryScreen()),
      );
    }
  }

  /// Google bağlantı dialog'unu göster
  Future<bool?> _showGoogleLinkDialog(AppLocalizations l10n) {
    return showDialog<bool>(
      context: context,
      barrierDismissible: false,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      builder: (context) => AlertDialog(
        backgroundColor: context.appColors.surface,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(24)),
        contentPadding: const EdgeInsets.fromLTRB(24, 24, 24, 16),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Container(
              width: 64,
              height: 64,
              decoration: BoxDecoration(
                color: context.appColors.primary.withValues(alpha: 0.1),
                borderRadius: BorderRadius.circular(16),
              ),
              child: Icon(
                CupertinoIcons.link,
                color: context.appColors.primary,
                size: 32,
              ),
            ),
            const SizedBox(height: 20),
            Text(
              l10n.linkWithGoogleTitle,
              style: TextStyle(
                fontSize: 20,
                fontWeight: FontWeight.w700,
                color: context.appColors.textPrimary,
              ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 12),
            Text(
              l10n.linkWithGoogleDescription,
              style: TextStyle(
                fontSize: 14,
                color: context.appColors.textSecondary,
                height: 1.4,
              ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 24),
            SizedBox(
              width: double.infinity,
              child: ElevatedButton.icon(
                onPressed: () => Navigator.pop(context, true),
                style: ElevatedButton.styleFrom(
                  backgroundColor: context.appColors.textPrimary,
                  foregroundColor: context.appColors.background,
                  padding: const EdgeInsets.symmetric(vertical: 14),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(16),
                    side: BorderSide(color: Colors.grey.shade300),
                  ),
                  elevation: 0,
                ),
                icon: Image.network(
                  'https://www.google.com/favicon.ico',
                  width: 20,
                  height: 20,
                  errorBuilder: (context, error, stackTrace) => Icon(
                    CupertinoIcons.globe,
                    size: 20,
                    color: Colors.blue,
                  ),
                ),
                label: Text(
                  l10n.linkWithGoogle,
                  style: const TextStyle(
                    fontSize: 14,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ),
            ),
            const SizedBox(height: 12),
            TextButton(
              onPressed: () => Navigator.pop(context, false),
              child: Text(
                l10n.skipForNow,
                style: TextStyle(
                  fontSize: 14,
                  color: context.appColors.textSecondary,
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return Scaffold(
      backgroundColor: context.appColors.background,
      appBar: _isEditMode
          ? AppBar(
              backgroundColor: context.appColors.background,
              leading: IconButton(
                icon: Icon(
                  CupertinoIcons.arrow_left,
                  color: context.appColors.textPrimary,
                ),
                onPressed: () => Navigator.pop(context),
              ),
              title: Text(
                l10n.editProfile,
                style: TextStyle(
                  fontSize: 20,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textPrimary,
                ),
              ),
            )
          : null,
      body: SafeArea(
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 24),
          child: SingleChildScrollView(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                if (!_isEditMode) ...[
                  const SizedBox(height: 48),
                  // Welcome header
                  Container(
                    width: 64,
                    height: 64,
                    decoration: BoxDecoration(
                      color: context.appColors.primary.withValues(alpha: 0.1),
                      borderRadius: BorderRadius.circular(16),
                    ),
                    child: Icon(
                      CupertinoIcons.person,
                      size: 32,
                      color: context.appColors.primary,
                    ),
                  ),
                  const SizedBox(height: 24),
                  Text(
                    l10n.welcome,
                    style: TextStyle(
                      fontSize: 32,
                      fontWeight: FontWeight.w700,
                      color: context.appColors.textPrimary,
                      letterSpacing: -0.5,
                    ),
                  ),
                  const SizedBox(height: 8),
                  Text(
                    l10n.welcomeSubtitle,
                    style: TextStyle(
                      fontSize: 16,
                      color: context.appColors.textSecondary,
                      height: 1.4,
                    ),
                  ),
                  const SizedBox(height: 32),

                  // Currency Selection Section (for new users)
                  _buildCurrencySection(l10n),
                  const SizedBox(height: 32),
                ] else ...[
                  const SizedBox(height: 24),
                ],

                // Gelir Bölümü
                _buildIncomeSection(l10n),
                const SizedBox(height: 32),

                // Çalışma Saati
                LabeledTextField(
                  controller: _dailyHoursController,
                  label: l10n.dailyWorkHours,
                  keyboardType: TextInputType.number,
                  hint: '8',
                  suffix: Padding(
                    padding: const EdgeInsets.only(right: 16),
                    child: Text(
                      l10n.hours,
                      style: TextStyle(
                        color: context.appColors.textSecondary,
                        fontWeight: FontWeight.w500,
                      ),
                    ),
                  ),
                ),
                const SizedBox(height: 24),

                // Çalışma Günü
                Text(
                  l10n.weeklyWorkDays,
                  style: TextStyle(
                    fontSize: 13,
                    fontWeight: FontWeight.w500,
                    color: context.appColors.textSecondary,
                  ),
                ),
                const SizedBox(height: 12),

                // Work days selector
                Container(
                  padding: const EdgeInsets.all(4),
                  decoration: BoxDecoration(
                    color: context.appColors.surface,
                    borderRadius: BorderRadius.circular(16),
                    border: Border.all(color: context.appColors.cardBorder),
                  ),
                  child: Row(
                    children: List.generate(7, (index) {
                      final day = index + 1;
                      final isSelected = _workDaysPerWeek == day;
                      return Expanded(
                        child: GestureDetector(
                          onTap: () => setState(() => _workDaysPerWeek = day),
                          child: Container(
                            padding: const EdgeInsets.symmetric(vertical: 14),
                            decoration: BoxDecoration(
                              color: isSelected
                                  ? context.appColors.primary
                                  : Colors.transparent,
                              borderRadius: BorderRadius.circular(8),
                            ),
                            child: Text(
                              '$day',
                              textAlign: TextAlign.center,
                              style: TextStyle(
                                fontSize: 15,
                                fontWeight: FontWeight.w600,
                                color: isSelected
                                    ? context.appColors.background
                                    : context.appColors.textSecondary,
                              ),
                            ),
                          ),
                        ),
                      );
                    }),
                  ),
                ),
                const SizedBox(height: 8),
                Text(
                  l10n.workingDaysPerWeek(_workDaysPerWeek),
                  style: TextStyle(
                    fontSize: 13,
                    color: context.appColors.textTertiary,
                  ),
                ),

                const SizedBox(height: 32),

                // Ek Gelir Bölümü
                _buildAdditionalIncomeSection(l10n),

                const SizedBox(height: 32),

                // Bütçe Ayarları Bölümü
                _buildBudgetSection(l10n),

                // Referral Code Section (only for new users)
                if (!_isEditMode) ...[
                  const SizedBox(height: 32),
                  _buildReferralCodeSection(l10n),
                ],

                const SizedBox(height: 32),

                // Save button
                SizedBox(
                  width: double.infinity,
                  child: ElevatedButton(
                    onPressed: _isSaving ? null : _saveProfile,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: context.appColors.primary,
                      foregroundColor: context.appColors.background,
                      disabledBackgroundColor: context.appColors.primary
                          .withValues(alpha: 0.5),
                      padding: const EdgeInsets.symmetric(vertical: 18),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(16),
                      ),
                    ),
                    child: _isSaving
                        ? SizedBox(
                            height: 22,
                            width: 22,
                            child: CircularProgressIndicator(
                              strokeWidth: 2,
                              valueColor: AlwaysStoppedAnimation<Color>(
                                context.appColors.background,
                              ),
                            ),
                          )
                        : Text(
                            _isEditMode ? l10n.save : l10n.getStarted,
                            style: const TextStyle(
                              fontSize: 16,
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                  ),
                ),

                const SizedBox(height: 32),
              ],
            ),
          ),
        ),
      ),
    );
  }

  /// Ek Gelir bölümü
  Widget _buildAdditionalIncomeSection(AppLocalizations l10n) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          l10n.additionalIncomeQuestion,
          style: TextStyle(
            fontSize: 13,
            fontWeight: FontWeight.w500,
            color: context.appColors.textSecondary,
          ),
        ),
        const SizedBox(height: 12),
        SizedBox(
          width: double.infinity,
          child: OutlinedButton.icon(
            onPressed: () async {
              // 1. Önce mevcut maaş değerini al
              final currentSalary = parseAmount(_incomeController.text);

              // 2. Eğer maaş girilmişse ve henüz _incomeSources'ta yoksa, ekle
              if (currentSalary != null && currentSalary > 0) {
                final hasPrimary = _incomeSources.any((s) => s.isPrimary);
                if (!hasPrimary) {
                  // Yeni maaş ekle
                  _incomeSources.insert(
                    0,
                    IncomeSource.salary(
                      amount: currentSalary,
                      title: l10n.mainSalary,
                    ),
                  );
                } else {
                  // Mevcut primary income'u güncelle
                  final primaryIndex = _incomeSources.indexWhere(
                    (s) => s.isPrimary,
                  );
                  if (primaryIndex >= 0) {
                    _incomeSources[primaryIndex] = _incomeSources[primaryIndex]
                        .copyWith(amount: currentSalary);
                  }
                }
              }

              // 3. Sonra IncomeWizardScreen'e git
              await Navigator.push(
                context,
                MaterialPageRoute(
                  builder: (context) => IncomeWizardScreen(
                    existingSources: _incomeSources,
                    skipToAdditional: true,
                  ),
                ),
              );

              // Wizard kapandıktan sonra Provider'dan güncel veriyi al
              if (mounted) {
                final provider = context.read<FinanceProvider>();
                final profile = provider.userProfile;
                if (profile != null) {
                  setState(() {
                    _incomeSources = profile.incomeSources;
                    _incomeController.text = formatTurkishCurrency(
                      _totalIncome,
                      decimalDigits: 0,
                      showDecimals: false,
                    );
                  });
                  HapticFeedback.lightImpact();
                }
              }
            },
            icon: Icon(CupertinoIcons.plus_circle, size: 20),
            label: Text(l10n.addAdditionalIncome),
            style: OutlinedButton.styleFrom(
              foregroundColor: context.appColors.primary,
              side: BorderSide(
                color: context.appColors.primary.withValues(alpha: 0.5),
              ),
              padding: const EdgeInsets.symmetric(vertical: 14),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(16),
              ),
            ),
          ),
        ),
      ],
    );
  }

  /// Bütçe Ayarları bölümü
  Widget _buildBudgetSection(AppLocalizations l10n) {
    final currencyProvider = context.watch<CurrencyProvider>();

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // Bölüm başlığı
        Row(
          children: [
            Icon(
              CupertinoIcons.chart_pie,
              color: context.appColors.secondary,
              size: 20,
            ),
            const SizedBox(width: 8),
            Text(
              l10n.budgetSettings,
              style: TextStyle(
                color: context.appColors.textPrimary,
                fontSize: 16,
                fontWeight: FontWeight.w600,
              ),
            ),
          ],
        ),
        const SizedBox(height: 8),
        Text(
          l10n.budgetSettingsHint,
          style: TextStyle(color: context.appColors.textTertiary, fontSize: 13),
        ),
        const SizedBox(height: 16),

        // Aylık bütçe
        Container(
          decoration: BoxDecoration(
            color: context.appColors.surface,
            borderRadius: BorderRadius.circular(16),
            border: Border.all(color: context.appColors.cardBorder),
          ),
          child: TextField(
            controller: _budgetController,
            keyboardType: const TextInputType.numberWithOptions(decimal: true),
            inputFormatters: [TurkishCurrencyInputFormatter()],
            style: TextStyle(
              fontSize: 16,
              color: context.appColors.textPrimary,
            ),
            decoration: InputDecoration(
              labelText: l10n.monthlySpendingLimit,
              labelStyle: TextStyle(color: context.appColors.textSecondary),
              hintText: '30.000',
              hintStyle: TextStyle(
                color: context.appColors.textTertiary.withValues(alpha: 0.5),
              ),
              prefixIcon: Container(
                margin: const EdgeInsets.only(left: 16, right: 12),
                child: Icon(
                  CupertinoIcons.creditcard,
                  color: context.appColors.secondary,
                  size: 22,
                ),
              ),
              prefixIconConstraints: const BoxConstraints(
                minWidth: 0,
                minHeight: 0,
              ),
              suffixText: currencyProvider.code,
              suffixStyle: TextStyle(
                fontSize: 14,
                fontWeight: FontWeight.w500,
                color: context.appColors.textSecondary,
              ),
              border: InputBorder.none,
              contentPadding: const EdgeInsets.symmetric(
                horizontal: 16,
                vertical: 16,
              ),
            ),
          ),
        ),
        const SizedBox(height: 6),
        Text(
          l10n.monthlySpendingLimitHint,
          style: TextStyle(color: context.appColors.textTertiary, fontSize: 12),
        ),

        const SizedBox(height: 16),

        // Tasarruf hedefi
        Container(
          decoration: BoxDecoration(
            color: context.appColors.surface,
            borderRadius: BorderRadius.circular(16),
            border: Border.all(color: context.appColors.cardBorder),
          ),
          child: TextField(
            controller: _savingsGoalController,
            keyboardType: const TextInputType.numberWithOptions(decimal: true),
            inputFormatters: [TurkishCurrencyInputFormatter()],
            style: TextStyle(
              fontSize: 16,
              color: context.appColors.textPrimary,
            ),
            decoration: InputDecoration(
              labelText: l10n.monthlySavingsGoal,
              labelStyle: TextStyle(color: context.appColors.textSecondary),
              hintText: '5.000',
              hintStyle: TextStyle(
                color: context.appColors.textTertiary.withValues(alpha: 0.5),
              ),
              prefixIcon: Container(
                margin: const EdgeInsets.only(left: 16, right: 12),
                child: Icon(
                  CupertinoIcons.money_dollar_circle,
                  color: context.appColors.success,
                  size: 22,
                ),
              ),
              prefixIconConstraints: const BoxConstraints(
                minWidth: 0,
                minHeight: 0,
              ),
              suffixText: currencyProvider.code,
              suffixStyle: TextStyle(
                fontSize: 14,
                fontWeight: FontWeight.w500,
                color: context.appColors.textSecondary,
              ),
              border: InputBorder.none,
              contentPadding: const EdgeInsets.symmetric(
                horizontal: 16,
                vertical: 16,
              ),
            ),
          ),
        ),
        const SizedBox(height: 6),
        Text(
          l10n.monthlySavingsGoalHint,
          style: TextStyle(color: context.appColors.textTertiary, fontSize: 12),
        ),

        // Bilgi kartı
        const SizedBox(height: 16),
        Container(
          padding: const EdgeInsets.all(12),
          decoration: BoxDecoration(
            color: context.appColors.info.withValues(alpha: 0.1),
            borderRadius: BorderRadius.circular(8),
            border: Border.all(
              color: context.appColors.info.withValues(alpha: 0.3),
            ),
          ),
          child: Row(
            children: [
              Icon(
                CupertinoIcons.lightbulb,
                color: context.appColors.info,
                size: 20,
              ),
              const SizedBox(width: 12),
              Expanded(
                child: Text(
                  l10n.budgetInfoMessage,
                  style: TextStyle(color: context.appColors.info, fontSize: 12),
                ),
              ),
            ],
          ),
        ),
      ],
    );
  }

  /// Referral code input section (for new users)
  Widget _buildReferralCodeSection(AppLocalizations l10n) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          l10n.haveReferralCode,
          style: TextStyle(
            fontSize: 13,
            fontWeight: FontWeight.w500,
            color: context.appColors.textSecondary,
          ),
        ),
        const SizedBox(height: 12),
        Container(
          decoration: BoxDecoration(
            color: context.appColors.surface,
            borderRadius: BorderRadius.circular(16),
            border: Border.all(
              color: _hasPrefilledReferral
                  ? context.appColors.success.withValues(alpha: 0.5)
                  : context.appColors.cardBorder,
            ),
          ),
          child: TextField(
            controller: _referralCodeController,
            textCapitalization: TextCapitalization.characters,
            style: TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.w600,
              letterSpacing: 1.2,
              color: context.appColors.textPrimary,
            ),
            decoration: InputDecoration(
              hintText: l10n.referralCodePlaceholder,
              hintStyle: TextStyle(
                color: context.appColors.textSecondary.withValues(alpha: 0.5),
                letterSpacing: 1.2,
              ),
              prefixIcon: Container(
                margin: const EdgeInsets.only(left: 16, right: 12),
                child: Icon(
                  CupertinoIcons.gift,
                  color: _hasPrefilledReferral
                      ? context.appColors.success
                      : context.appColors.secondary,
                  size: 22,
                ),
              ),
              prefixIconConstraints: const BoxConstraints(
                minWidth: 0,
                minHeight: 0,
              ),
              suffixIcon: _hasPrefilledReferral
                  ? Icon(
                      CupertinoIcons.checkmark_circle_fill,
                      color: context.appColors.success,
                      size: 20,
                    )
                  : null,
              border: InputBorder.none,
              contentPadding: const EdgeInsets.symmetric(
                horizontal: 16,
                vertical: 16,
              ),
            ),
          ),
        ),
        const SizedBox(height: 6),
        Text(
          l10n.referralCodeHint,
          style: TextStyle(color: context.appColors.textTertiary, fontSize: 12),
        ),
      ],
    );
  }

  /// Show onboarding currency selector (all currencies available, no restrictions)
  void _showOnboardingCurrencySelector() {
    final l10n = AppLocalizations.of(context);
    final currencyProvider = context.read<CurrencyProvider>();

    showModalBottomSheet(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      backgroundColor: context.appColors.surface,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      builder: (ctx) => SafeArea(
        child: Padding(
          padding: const EdgeInsets.symmetric(vertical: 16),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              // Handle
              Container(
                width: 40,
                height: 4,
                margin: const EdgeInsets.only(bottom: 16),
                decoration: BoxDecoration(
                  color: context.appColors.textTertiary,
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
              // Title
              Padding(
                padding: const EdgeInsets.only(bottom: 8),
                child: Text(
                  l10n.selectCurrency,
                  style: TextStyle(
                    fontSize: 18,
                    fontWeight: FontWeight.w600,
                    color: context.appColors.textPrimary,
                  ),
                ),
              ),
              // Note about currency lock
              Padding(
                padding: const EdgeInsets.fromLTRB(16, 0, 16, 12),
                child: Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 12,
                    vertical: 8,
                  ),
                  decoration: BoxDecoration(
                    color: context.appColors.info.withValues(alpha: 0.15),
                    borderRadius: BorderRadius.circular(8),
                    border: Border.all(
                      color: context.appColors.info.withValues(alpha: 0.3),
                    ),
                  ),
                  child: Row(
                    children: [
                      Icon(
                        CupertinoIcons.info_circle,
                        size: 16,
                        color: context.appColors.info,
                      ),
                      const SizedBox(width: 8),
                      Expanded(
                        child: Text(
                          l10n.currencyLockNote,
                          style: TextStyle(
                            fontSize: 12,
                            color: context.appColors.textSecondary,
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              ),
              // Currency options - ALL available during onboarding
              ...supportedCurrencies.map((currency) {
                final isSelected =
                    currencyProvider.currency.code == currency.code;

                return ListTile(
                  leading: Text(
                    currency.flag,
                    style: const TextStyle(fontSize: 24),
                  ),
                  title: Row(
                    children: [
                      Text(
                        currency.code,
                        style: TextStyle(
                          color: context.appColors.textPrimary,
                          fontWeight: isSelected
                              ? FontWeight.w600
                              : FontWeight.w500,
                          fontSize: 16,
                        ),
                      ),
                      const SizedBox(width: 8),
                      Text(
                        currency.symbol,
                        style: TextStyle(
                          color: context.appColors.textSecondary,
                          fontSize: 16,
                        ),
                      ),
                    ],
                  ),
                  subtitle: Text(
                    currency.name,
                    style: TextStyle(
                      color: context.appColors.textTertiary,
                      fontSize: 13,
                    ),
                  ),
                  trailing: isSelected
                      ? Icon(
                          CupertinoIcons.checkmark_circle,
                          color: context.appColors.primary,
                        )
                      : null,
                  onTap: () async {
                    Navigator.pop(ctx);
                    await currencyProvider.setCurrency(currency);
                    HapticFeedback.lightImpact();
                    setState(() {});
                  },
                );
              }),
            ],
          ),
        ),
      ),
    );
  }

  /// Currency selection section for new users
  Widget _buildCurrencySection(AppLocalizations l10n) {
    final currencyProvider = context.watch<CurrencyProvider>();
    final currentCurrency = currencyProvider.currency;

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          l10n.selectCurrency,
          style: TextStyle(
            fontSize: 13,
            fontWeight: FontWeight.w500,
            color: context.appColors.textSecondary,
          ),
        ),
        const SizedBox(height: 12),
        GestureDetector(
          onTap: _showOnboardingCurrencySelector,
          child: Container(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
            decoration: BoxDecoration(
              color: context.appColors.surface,
              borderRadius: BorderRadius.circular(16),
              border: Border.all(color: context.appColors.cardBorder),
            ),
            child: Row(
              children: [
                Text(
                  currentCurrency.flag,
                  style: const TextStyle(fontSize: 24),
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        children: [
                          Text(
                            currentCurrency.code,
                            style: TextStyle(
                              fontSize: 16,
                              fontWeight: FontWeight.w600,
                              color: context.appColors.textPrimary,
                            ),
                          ),
                          const SizedBox(width: 8),
                          Text(
                            currentCurrency.symbol,
                            style: TextStyle(
                              fontSize: 16,
                              color: context.appColors.textSecondary,
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 2),
                      Text(
                        currentCurrency.name,
                        style: TextStyle(
                          fontSize: 12,
                          color: context.appColors.textTertiary,
                        ),
                      ),
                    ],
                  ),
                ),
                Icon(
                  CupertinoIcons.chevron_down,
                  size: 20,
                  color: context.appColors.textSecondary,
                ),
              ],
            ),
          ),
        ),
        // Note about currency lock (shown during onboarding)
        const SizedBox(height: 8),
        Row(
          children: [
            Icon(
              CupertinoIcons.info_circle,
              size: 14,
              color: context.appColors.textTertiary,
            ),
            const SizedBox(width: 6),
            Expanded(
              child: Text(
                l10n.currencyLockNote,
                style: TextStyle(
                  fontSize: 11,
                  color: context.appColors.textTertiary,
                ),
              ),
            ),
          ],
        ),
      ],
    );
  }

  /// Gelir bölümü widget'ı
  Widget _buildIncomeSection(AppLocalizations l10n) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          l10n.incomeInfo,
          style: TextStyle(
            fontSize: 13,
            fontWeight: FontWeight.w500,
            color: context.appColors.textSecondary,
          ),
        ),
        const SizedBox(height: 12),

        // Eğer gelir kaynakları varsa, özet göster
        if (_hasIncomeSources) ...[
          _buildIncomeSourcesSummary(l10n),
        ] else ...[
          // Basit gelir girişi
          _buildSimpleIncomeInput(),
        ],
      ],
    );
  }

  /// Basit gelir girişi (wizard kullanılmadıysa)
  Widget _buildSimpleIncomeInput() {
    final currencyProvider = context.watch<CurrencyProvider>();
    return Container(
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: context.appColors.cardBorder),
      ),
      child: TextField(
        controller: _incomeController,
        keyboardType: const TextInputType.numberWithOptions(decimal: true),
        inputFormatters: [TurkishCurrencyInputFormatter()],
        style: TextStyle(
          fontSize: 20,
          fontWeight: FontWeight.w600,
          color: context.appColors.textPrimary,
        ),
        decoration: InputDecoration(
          hintText: '25.000',
          hintStyle: TextStyle(
            color: context.appColors.textSecondary.withValues(alpha: 0.5),
          ),
          prefixIcon: Container(
            margin: const EdgeInsets.only(left: 16, right: 12),
            child: Icon(
              CupertinoIcons.creditcard,
              color: context.appColors.primary,
              size: 24,
            ),
          ),
          prefixIconConstraints: const BoxConstraints(
            minWidth: 0,
            minHeight: 0,
          ),
          suffixText: currencyProvider.code,
          suffixStyle: TextStyle(
            fontSize: 16,
            fontWeight: FontWeight.w500,
            color: context.appColors.textSecondary,
          ),
          border: InputBorder.none,
          contentPadding: const EdgeInsets.symmetric(
            horizontal: 16,
            vertical: 18,
          ),
        ),
      ),
    );
  }

  /// Gelir kaynakları özeti
  Widget _buildIncomeSourcesSummary(AppLocalizations l10n) {
    return GestureDetector(
      onTap: _openIncomeWizard,
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: context.appColors.surface,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: context.appColors.primary.withValues(alpha: 0.3),
          ),
        ),
        child: Column(
          children: [
            // Toplam
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Row(
                  children: [
                    Container(
                      width: 40,
                      height: 40,
                      decoration: BoxDecoration(
                        color: context.appColors.primary.withValues(alpha: 0.1),
                        borderRadius: BorderRadius.circular(16),
                      ),
                      child: Icon(
                        CupertinoIcons.creditcard,
                        color: context.appColors.primary,
                        size: 20,
                      ),
                    ),
                    const SizedBox(width: 12),
                    Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          l10n.totalIncome,
                          style: TextStyle(
                            fontSize: 12,
                            color: context.appColors.textSecondary,
                          ),
                        ),
                        const SizedBox(height: 2),
                        Text(
                          '${formatTurkishCurrency(_totalIncome, decimalDigits: 0, showDecimals: false)} TL',
                          style: TextStyle(
                            fontSize: 20,
                            fontWeight: FontWeight.w700,
                            color: context.appColors.primary,
                          ),
                        ),
                      ],
                    ),
                  ],
                ),
                Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 10,
                    vertical: 4,
                  ),
                  decoration: BoxDecoration(
                    color: context.appColors.primary.withValues(alpha: 0.1),
                    borderRadius: BorderRadius.circular(24),
                  ),
                  child: Text(
                    l10n.incomeSources(_incomeSources.length),
                    style: TextStyle(
                      fontSize: 11,
                      fontWeight: FontWeight.w600,
                      color: context.appColors.primary,
                    ),
                  ),
                ),
              ],
            ),

            // Kaynak listesi (kısa özet)
            if (_incomeSources.length <= 3) ...[
              const SizedBox(height: 16),
              Divider(height: 1, color: context.appColors.cardBorder),
              const SizedBox(height: 12),
              ...(_incomeSources.map(
                (source) => Padding(
                  padding: const EdgeInsets.only(bottom: 8),
                  child: Row(
                    children: [
                      Icon(
                        source.category.icon,
                        size: 18,
                        color: source.category.color,
                      ),
                      const SizedBox(width: 8),
                      Expanded(
                        child: Text(
                          source.title,
                          style: TextStyle(
                            fontSize: 13,
                            color: context.appColors.textSecondary,
                          ),
                          overflow: TextOverflow.ellipsis,
                        ),
                      ),
                      Text(
                        '${formatTurkishCurrency(source.amount, decimalDigits: 0, showDecimals: false)} TL',
                        style: TextStyle(
                          fontSize: 13,
                          fontWeight: FontWeight.w500,
                          color: context.appColors.textPrimary,
                        ),
                      ),
                    ],
                  ),
                ),
              )),
            ],
          ],
        ),
      ),
    );
  }
}


--- FILE: lib/screens/subscription_screen.dart ---

import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';
import '../services/services.dart';
import '../theme/theme.dart';
import '../widgets/widgets.dart';

/// Subscription management screen
/// Allows switching between list and calendar views
class SubscriptionScreen extends StatefulWidget {
  const SubscriptionScreen({super.key});

  @override
  State<SubscriptionScreen> createState() => _SubscriptionScreenState();
}

class _SubscriptionScreenState extends State<SubscriptionScreen> {
  final _subscriptionService = SubscriptionService();
  final _subscriptionManager = SubscriptionManager();

  List<Subscription> _subscriptions = [];
  SubscriptionStats? _stats;
  bool _isLoading = true;
  bool _isCalendarView = false; // false = list, true = calendar

  @override
  void initState() {
    super.initState();
    _loadData();
  }

  Future<void> _loadData() async {
    setState(() => _isLoading = true);

    try {
      final subs = await _subscriptionService.getActiveSubscriptions();
      final stats = await _subscriptionManager.getStats();

      if (mounted) {
        setState(() {
          _subscriptions = subs
            ..sort((a, b) => a.renewalDay.compareTo(b.renewalDay));
          _stats = stats;
          _isLoading = false;
        });
      }
    } catch (e) {
      debugPrint('[SubscriptionScreen] Error loading subscriptions: $e');
      if (mounted) {
        setState(() => _isLoading = false);
        final l10n = AppLocalizations.of(context);
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(l10n.errorLoadingSubscriptions),
            backgroundColor: context.appColors.error,
            behavior: SnackBarBehavior.floating,
          ),
        );
      }
    }
  }

  void _toggleView() {
    HapticFeedback.selectionClick();
    setState(() => _isCalendarView = !_isCalendarView);
  }

  void _showAddSheet() {
    HapticFeedback.lightImpact();
    showModalBottomSheet(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => AddSubscriptionSheet(
        onAdd: (subscription) async {
          await _subscriptionService.addSubscription(subscription);
          _subscriptionManager.clearCache();
          _loadData();
        },
      ),
    );
  }

  void _showDetailSheet(Subscription subscription) {
    HapticFeedback.lightImpact();
    showModalBottomSheet(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => SubscriptionDetailSheet(
        subscription: subscription,
        onUpdate: (updated) async {
          await _subscriptionService.updateSubscription(
            subscription.id,
            updated,
          );
          _subscriptionManager.clearCache();
          _loadData();
        },
        onDelete: () async {
          await _subscriptionService.deleteSubscription(subscription.id);
          _subscriptionManager.clearCache();
          _loadData();
        },
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: context.appColors.background,
      body: CustomScrollView(
        slivers: [
          // App Bar
          SliverAppBar(
            backgroundColor: context.appColors.background,
            pinned: true,
            expandedHeight: 0,
            leading: IconButton(
              icon: Icon(CupertinoIcons.arrow_left),
              onPressed: () => Navigator.pop(context),
              tooltip: AppLocalizations.of(context).accessibilityBackButton,
            ),
            title: Text(
              AppLocalizations.of(context).subscriptions,
              style: const TextStyle(fontSize: 18, fontWeight: FontWeight.w600),
            ),
            actions: [
              // View toggle
              IconButton(
                icon: Icon(
                  _isCalendarView
                      ? CupertinoIcons.list_bullet
                      : CupertinoIcons.calendar,
                ),
                onPressed: _toggleView,
                tooltip: _isCalendarView
                    ? AppLocalizations.of(context).listView
                    : AppLocalizations.of(context).calendarView,
              ),
            ],
          ),

          // Stats card
          SliverToBoxAdapter(
            child: Padding(
              padding: const EdgeInsets.fromLTRB(20, 8, 20, 16),
              child: _buildStatsCard(),
            ),
          ),

          // Content
          if (_isLoading)
            SliverFillRemaining(
              child: Center(
                child: CircularProgressIndicator(
                  color: context.appColors.primary,
                ),
              ),
            )
          else if (_subscriptions.isEmpty)
            SliverFillRemaining(child: _buildEmptyState())
          else if (_isCalendarView)
            SliverToBoxAdapter(
              child: Padding(
                padding: const EdgeInsets.symmetric(horizontal: 20),
                child: SubscriptionCalendarView(
                  subscriptions: _subscriptions,
                  onDayTap: _showDaySubscriptions,
                ),
              ),
            )
          else
            SliverPadding(
              padding: const EdgeInsets.symmetric(horizontal: 20),
              sliver: SliverList(
                delegate: SliverChildBuilderDelegate((context, index) {
                  if (index == _subscriptions.length) {
                    return const SizedBox(height: 100); // Space for FAB
                  }
                  return Padding(
                    padding: const EdgeInsets.only(bottom: 12),
                    child: _buildSubscriptionCard(_subscriptions[index]),
                  );
                }, childCount: _subscriptions.length + 1),
              ),
            ),
        ],
      ),
      // Floating Action Button
      floatingActionButton: FloatingActionButton(
        onPressed: _showAddSheet,
        backgroundColor: context.appColors.primary,
        tooltip: AppLocalizations.of(context).addSubscription,
        child: Icon(
          CupertinoIcons.add,
          color: context.appColors.textPrimary,
        ),
      ),
    );
  }

  Widget _buildStatsCard() {
    if (_stats == null) {
      return const SizedBox.shrink();
    }

    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: context.appColors.surface.withValues(alpha: 0.8),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: context.appColors.textPrimary.withValues(alpha: 0.1),
          width: 0.5,
        ),
      ),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(16),
        child: BackdropFilter(
          filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
          child: Row(
            children: [
              // Monthly total
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      AppLocalizations.of(context).monthlyTotal,
                      style: TextStyle(
                        fontSize: 12,
                        color: context.appColors.textSecondary,
                      ),
                    ),
                    const SizedBox(height: 4),
                    Text(
                      '${formatTurkishCurrency(_stats!.totalMonthlyCost, decimalDigits: 0)} ₺',
                      style: TextStyle(
                        fontSize: 24,
                        fontWeight: FontWeight.w600,
                        color: context.appColors.textPrimary,
                      ),
                    ),
                  ],
                ),
              ),
              // Divider
              Container(
                width: 1,
                height: 50,
                color: context.appColors.textPrimary.withValues(alpha: 0.1),
              ),
              const SizedBox(width: 20),
              // Subscription count and work days
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        Icon(
                          _stats!.statusIcon,
                          size: 14,
                          color: _stats!.statusColor,
                        ),
                        const SizedBox(width: 6),
                        Text(
                          '${_stats!.totalCount} ${AppLocalizations.of(context).subscription}',
                          style: TextStyle(
                            fontSize: 13,
                            fontWeight: FontWeight.w500,
                            color: context.appColors.textPrimary,
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 8),
                    Text(
                      '${_stats!.totalWorkDays.toStringAsFixed(1)} ${AppLocalizations.of(context).workDaysPerMonth}',
                      style: TextStyle(
                        fontSize: 12,
                        color: context.appColors.textSecondary,
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildSubscriptionCard(Subscription subscription) {
    final l10n = AppLocalizations.of(context);
    return Semantics(
      button: true,
      label: l10n.accessibilitySubscriptionCard(
        subscription.name,
        formatTurkishCurrency(subscription.amount, decimalDigits: 0),
        l10n.monthly,
        subscription.renewalDay,
      ),
      child: GestureDetector(
        onTap: () => _showDetailSheet(subscription),
        child: Container(
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: context.appColors.surface.withValues(alpha: 0.6),
            borderRadius: BorderRadius.circular(16),
            border: Border.all(
              color: subscription.color.withValues(alpha: 0.3),
              width: 1,
            ),
          ),
          child: Row(
            children: [
              // Color dot
              Container(
                width: 12,
                height: 12,
                decoration: BoxDecoration(
                  color: subscription.color,
                  shape: BoxShape.circle,
                  boxShadow: [
                    BoxShadow(
                      color: subscription.color.withValues(alpha: 0.4),
                      blurRadius: 6,
                      spreadRadius: 1,
                    ),
                  ],
                ),
              ),
              const SizedBox(width: 14),
              // Name and category
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      subscription.name,
                      style: TextStyle(
                        fontSize: 15,
                        fontWeight: FontWeight.w600,
                        color: context.appColors.textPrimary,
                      ),
                    ),
                    const SizedBox(height: 2),
                    Text(
                      subscription.category,
                      style: TextStyle(
                        fontSize: 12,
                        color: context.appColors.textSecondary,
                      ),
                    ),
                  ],
                ),
              ),
              // Amount and renewal day
              Column(
                crossAxisAlignment: CrossAxisAlignment.end,
                children: [
                  Text(
                    '${formatTurkishCurrency(subscription.amount, decimalDigits: 0)} ₺',
                    style: TextStyle(
                      fontSize: 15,
                      fontWeight: FontWeight.w600,
                      color: context.appColors.textPrimary,
                    ),
                  ),
                  const SizedBox(height: 2),
                  Text(
                    AppLocalizations.of(
                      context,
                    ).everyMonthDay(subscription.renewalDay),
                    style: TextStyle(
                      fontSize: 11,
                      color: context.appColors.textTertiary,
                    ),
                  ),
                ],
              ),
              const SizedBox(width: 8),
              // Arrow
              Icon(
                CupertinoIcons.chevron_right,
                size: 20,
                color: context.appColors.textTertiary,
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildEmptyState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Container(
            width: 80,
            height: 80,
            decoration: BoxDecoration(
              color: context.appColors.surface.withValues(alpha: 0.5),
              borderRadius: BorderRadius.circular(24),
            ),
            child: Icon(
              CupertinoIcons.repeat,
              size: 40,
              color: context.appColors.textTertiary,
            ),
          ),
          const SizedBox(height: 20),
          Text(
            AppLocalizations.of(context).noSubscriptionsYet,
            style: TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.w500,
              color: context.appColors.textSecondary,
            ),
          ),
          const SizedBox(height: 8),
          Text(
            AppLocalizations.of(context).addSubscriptionHint,
            style: TextStyle(
              fontSize: 13,
              color: context.appColors.textTertiary,
            ),
          ),
        ],
      ),
    );
  }

  void _showDaySubscriptions(int day, List<Subscription> subs) {
    if (subs.isEmpty) return;

    HapticFeedback.lightImpact();
    showModalBottomSheet(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      backgroundColor: Colors.transparent,
      builder: (context) => Container(
        margin: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: context.appColors.gradientMid,
          borderRadius: BorderRadius.circular(24),
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            // Handle
            Container(
              width: 40,
              height: 4,
              margin: const EdgeInsets.only(top: 12),
              decoration: BoxDecoration(
                color: context.appColors.textPrimary.withValues(alpha: 0.2),
                borderRadius: BorderRadius.circular(2),
              ),
            ),
            Padding(
              padding: const EdgeInsets.all(20),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    AppLocalizations.of(context).everyMonthDay(day),
                    style: TextStyle(
                      fontSize: 16,
                      fontWeight: FontWeight.w600,
                      color: context.appColors.textPrimary,
                    ),
                  ),
                  const SizedBox(height: 16),
                  ...subs.map(
                    (sub) => Padding(
                      padding: const EdgeInsets.only(bottom: 12),
                      child: Semantics(
                        button: true,
                        label: AppLocalizations.of(context)
                            .accessibilitySubscriptionCard(
                              sub.name,
                              formatTurkishCurrency(
                                sub.amount,
                                decimalDigits: 0,
                              ),
                              AppLocalizations.of(context).monthly,
                              sub.renewalDay,
                            ),
                        child: GestureDetector(
                          onTap: () {
                            Navigator.pop(context);
                            _showDetailSheet(sub);
                          },
                          child: Row(
                            children: [
                              Container(
                                width: 10,
                                height: 10,
                                decoration: BoxDecoration(
                                  color: sub.color,
                                  shape: BoxShape.circle,
                                ),
                              ),
                              const SizedBox(width: 12),
                              Expanded(
                                child: Text(
                                  sub.name,
                                  style: TextStyle(
                                    fontSize: 14,
                                    color: context.appColors.textPrimary,
                                  ),
                                ),
                              ),
                              Text(
                                '${formatTurkishCurrency(sub.amount, decimalDigits: 0)} ₺',
                                style: TextStyle(
                                  fontSize: 14,
                                  fontWeight: FontWeight.w500,
                                  color: context.appColors.textSecondary,
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ),
                  ),
                  const SizedBox(height: 8),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }
}


--- FILE: lib/screens/import_statement_screen.dart ---

import 'dart:io';
import 'package:file_picker/file_picker.dart';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../providers/pro_provider.dart';
import '../providers/finance_provider.dart';
import '../services/statement_parse_service.dart';
import '../services/free_tier_service.dart';
import '../services/expense_history_service.dart';
import '../services/sound_service.dart';
import '../models/expense.dart';
import '../theme/theme.dart';
import 'paywall_screen.dart';

/// Screen for importing bank statements (PDF/CSV)
class ImportStatementScreen extends StatefulWidget {
  const ImportStatementScreen({super.key});

  @override
  State<ImportStatementScreen> createState() => _ImportStatementScreenState();
}

class _ImportStatementScreenState extends State<ImportStatementScreen> {
  bool _isProcessing = false;
  bool _isImporting = false;
  List<ParsedTransaction>? _transactions;
  Set<int> _selectedIndices = {};
  String? _error;
  int _remainingImports = 0;
  bool _limitChecked = false;

  @override
  void initState() {
    super.initState();
    _checkLimit();
  }

  Future<void> _checkLimit() async {
    final isPro = context.read<ProProvider>().isPro;
    final remaining = await FreeTierService().getRemainingStatementImports(
      isPro,
    );
    if (mounted) {
      setState(() {
        _remainingImports = remaining;
        _limitChecked = true;
      });
    }
  }

  Future<void> _pickFile() async {
    final l10n = AppLocalizations.of(context);
    final isPro = context.read<ProProvider>().isPro;

    // Check limit first
    final limitResult = await FreeTierService().canImportStatement(isPro);
    if (!limitResult.canUse) {
      _showLimitReachedDialog(l10n);
      return;
    }

    try {
      final result = await FilePicker.platform.pickFiles(
        type: FileType.custom,
        allowedExtensions: ['pdf', 'csv'],
      );

      if (result == null || result.files.isEmpty) return;

      final file = File(result.files.single.path!);
      await _processFile(file);
    } catch (e) {
      if (mounted) {
        setState(() {
          _error = l10n.importStatementError;
          _isProcessing = false;
        });
      }
    }
  }

  Future<void> _processFile(File file) async {
    final l10n = AppLocalizations.of(context);

    setState(() {
      _isProcessing = true;
      _error = null;
      _transactions = null;
    });

    try {
      final parseService = StatementParseService();
      final result = await parseService.parseFile(file);

      if (!mounted) return;

      if (result.hasError) {
        setState(() {
          _error = result.error;
          _isProcessing = false;
        });
        return;
      }

      if (result.isEmpty) {
        setState(() {
          _error = l10n.importStatementNoTransactions;
          _isProcessing = false;
        });
        return;
      }

      // All transactions selected by default
      setState(() {
        _transactions = result.transactions;
        _selectedIndices = Set<int>.from(
          List.generate(result.transactions.length, (i) => i),
        );
        _isProcessing = false;
      });
    } catch (e) {
      if (mounted) {
        setState(() {
          _error = l10n.importStatementError;
          _isProcessing = false;
        });
      }
    }
  }

  void _showLimitReachedDialog(AppLocalizations l10n) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: context.appColors.surface,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(24)),
        title: Row(
          children: [
            Icon(
              CupertinoIcons.exclamationmark_triangle_fill,
              color: context.appColors.warning,
            ),
            const SizedBox(width: 12),
            Text(
              l10n.importStatementLimitReached,
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.w600,
                color: context.appColors.textPrimary,
              ),
            ),
          ],
        ),
        content: Text(
          l10n.importStatementLimitReachedDesc,
          style: TextStyle(color: context.appColors.textSecondary),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text(
              l10n.cancel,
              style: TextStyle(color: context.appColors.textSecondary),
            ),
          ),
          ElevatedButton(
            onPressed: () {
              Navigator.pop(context);
              Navigator.push(
                context,
                MaterialPageRoute(builder: (_) => const PaywallScreen()),
              );
            },
            style: ElevatedButton.styleFrom(
              backgroundColor: context.appColors.primary,
              foregroundColor: Colors.white,
            ),
            child: Text(l10n.upgradeToPro),
          ),
        ],
      ),
    );
  }

  Future<void> _importSelected() async {
    if (_transactions == null || _selectedIndices.isEmpty) return;

    final l10n = AppLocalizations.of(context);

    setState(() => _isImporting = true);

    try {
      final expenseService = ExpenseHistoryService();
      int importedCount = 0;

      for (final index in _selectedIndices) {
        final transaction = _transactions![index];

        // Only import expenses
        if (transaction.isExpense) {
          final expense = Expense(
            amount: transaction.amount.abs(),
            category: transaction.category,
            date: transaction.date,
            hoursRequired: 0, // Not calculated for imported transactions
            daysRequired: 0, // Not calculated for imported transactions
            decision: ExpenseDecision.yes,
          );

          await expenseService.addExpense(expense);
          importedCount++;
        }
      }

      // Increment usage count after successful import
      await FreeTierService().incrementStatementImportCount();

      // Refresh finance provider
      if (mounted) {
        context.read<FinanceProvider>().refresh();
      }

      soundService.playSuccess();
      HapticFeedback.mediumImpact();

      if (mounted) {
        Navigator.pop(context);
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(l10n.importStatementSuccess(importedCount)),
            backgroundColor: context.appColors.success,
            behavior: SnackBarBehavior.floating,
          ),
        );
      }
    } catch (e) {
      if (mounted) {
        setState(() => _isImporting = false);
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(l10n.importStatementError),
            backgroundColor: context.appColors.error,
            behavior: SnackBarBehavior.floating,
          ),
        );
      }
    }
  }

  void _toggleSelection(int index) {
    HapticFeedback.selectionClick();
    setState(() {
      if (_selectedIndices.contains(index)) {
        _selectedIndices.remove(index);
      } else {
        _selectedIndices.add(index);
      }
    });
  }

  void _selectAll() {
    HapticFeedback.selectionClick();
    setState(() {
      _selectedIndices = Set<int>.from(
        List.generate(_transactions!.length, (i) => i),
      );
    });
  }

  void _deselectAll() {
    HapticFeedback.selectionClick();
    setState(() {
      _selectedIndices.clear();
    });
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return Scaffold(
      backgroundColor: context.appColors.background,
      appBar: AppBar(
        backgroundColor: context.appColors.background,
        elevation: 0,
        leading: IconButton(
          icon: Icon(
            CupertinoIcons.arrow_left,
            color: context.appColors.textPrimary,
          ),
          onPressed: () => Navigator.pop(context),
        ),
        title: Text(
          l10n.importStatementTitle,
          style: TextStyle(
            color: context.appColors.textPrimary,
            fontWeight: FontWeight.w600,
          ),
        ),
        actions: [
          if (_limitChecked)
            Padding(
              padding: const EdgeInsets.only(right: 16),
              child: Center(
                child: Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 10,
                    vertical: 4,
                  ),
                  decoration: BoxDecoration(
                    color: context.appColors.surfaceLight,
                    borderRadius: BorderRadius.circular(16),
                  ),
                  child: Text(
                    l10n.importStatementMonthlyLimit(_remainingImports),
                    style: TextStyle(
                      fontSize: 12,
                      color: context.appColors.textSecondary,
                    ),
                  ),
                ),
              ),
            ),
        ],
      ),
      body: _transactions == null
          ? _buildFilePickerView(l10n)
          : _buildReviewView(l10n),
    );
  }

  Widget _buildFilePickerView(AppLocalizations l10n) {
    return Padding(
      padding: const EdgeInsets.all(24),
      child: Column(
        children: [
          Expanded(
            child: Center(
              child: _isProcessing
                  ? _buildProcessingState(l10n)
                  : _buildPickerCard(l10n),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildProcessingState(AppLocalizations l10n) {
    return Column(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        SizedBox(
          width: 60,
          height: 60,
          child: CircularProgressIndicator(
            strokeWidth: 3,
            color: context.appColors.primary,
          ),
        ),
        const SizedBox(height: 24),
        Text(
          l10n.importStatementProcessing,
          style: TextStyle(
            fontSize: 16,
            color: context.appColors.textSecondary,
          ),
        ),
      ],
    );
  }

  Widget _buildPickerCard(AppLocalizations l10n) {
    return Column(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        GestureDetector(
          onTap: _pickFile,
          child: Container(
            width: double.infinity,
            padding: const EdgeInsets.symmetric(vertical: 60),
            decoration: BoxDecoration(
              color: context.appColors.surface,
              borderRadius: BorderRadius.circular(24),
              border: Border.all(
                color: context.appColors.primary.withValues(alpha: 0.3),
                width: 2,
                strokeAlign: BorderSide.strokeAlignInside,
              ),
            ),
            child: Column(
              children: [
                Container(
                  width: 80,
                  height: 80,
                  decoration: BoxDecoration(
                    color: context.appColors.primary.withValues(alpha: 0.15),
                    borderRadius: BorderRadius.circular(24),
                  ),
                  child: Icon(
                    CupertinoIcons.arrow_up_doc_fill,
                    size: 40,
                    color: context.appColors.primary,
                  ),
                ),
                const SizedBox(height: 24),
                Text(
                  l10n.importStatementDragDrop,
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.w500,
                    color: context.appColors.textPrimary,
                  ),
                  textAlign: TextAlign.center,
                ),
                const SizedBox(height: 8),
                Text(
                  l10n.importStatementSupportedFormats,
                  style: TextStyle(
                    fontSize: 14,
                    color: context.appColors.textSecondary,
                  ),
                ),
              ],
            ),
          ),
        ),
        if (_error != null) ...[
          const SizedBox(height: 20),
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: context.appColors.error.withValues(alpha: 0.1),
              borderRadius: BorderRadius.circular(16),
            ),
            child: Row(
              children: [
                Icon(
                  CupertinoIcons.exclamationmark_triangle_fill,
                  color: context.appColors.error,
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: Text(
                    _error!,
                    style: TextStyle(color: context.appColors.error),
                  ),
                ),
              ],
            ),
          ),
        ],
        const SizedBox(height: 32),
        SizedBox(
          width: double.infinity,
          child: ElevatedButton.icon(
            onPressed: _pickFile,
            icon: const Icon(CupertinoIcons.folder_open),
            label: Text(l10n.importStatementSelectFile),
            style: ElevatedButton.styleFrom(
              backgroundColor: context.appColors.primary,
              foregroundColor: Colors.white,
              padding: const EdgeInsets.symmetric(vertical: 16),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(16),
              ),
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildReviewView(AppLocalizations l10n) {
    return Column(
      children: [
        // Header
        Container(
          padding: const EdgeInsets.all(16),
          color: context.appColors.surface,
          child: Row(
            children: [
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      l10n.importStatementReviewTitle,
                      style: TextStyle(
                        fontSize: 18,
                        fontWeight: FontWeight.w600,
                        color: context.appColors.textPrimary,
                      ),
                    ),
                    const SizedBox(height: 4),
                    Text(
                      l10n.importStatementReviewDesc,
                      style: TextStyle(
                        fontSize: 14,
                        color: context.appColors.textSecondary,
                      ),
                    ),
                  ],
                ),
              ),
              TextButton(
                onPressed: _selectedIndices.length == _transactions!.length
                    ? _deselectAll
                    : _selectAll,
                child: Text(
                  _selectedIndices.length == _transactions!.length
                      ? l10n.importStatementDeselectAll
                      : l10n.importStatementSelectAll,
                ),
              ),
            ],
          ),
        ),

        // Transaction list
        Expanded(
          child: ListView.builder(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
            itemCount: _transactions!.length,
            itemBuilder: (context, index) {
              final transaction = _transactions![index];
              final isSelected = _selectedIndices.contains(index);

              // Skip non-expense transactions in UI (we only import expenses)
              if (!transaction.isExpense) {
                return const SizedBox.shrink();
              }

              return Container(
                margin: const EdgeInsets.only(bottom: 8),
                decoration: BoxDecoration(
                  color: context.appColors.surface,
                  borderRadius: BorderRadius.circular(16),
                  border: isSelected
                      ? Border.all(color: context.appColors.primary, width: 2)
                      : null,
                ),
                child: ListTile(
                  onTap: () => _toggleSelection(index),
                  leading: Checkbox(
                    value: isSelected,
                    onChanged: (_) => _toggleSelection(index),
                    activeColor: context.appColors.primary,
                  ),
                  title: Text(
                    transaction.description,
                    style: TextStyle(
                      fontWeight: FontWeight.w500,
                      color: context.appColors.textPrimary,
                    ),
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                  ),
                  subtitle: Row(
                    children: [
                      Text(
                        transaction.category,
                        style: TextStyle(
                          fontSize: 12,
                          color: context.appColors.textSecondary,
                        ),
                      ),
                      const SizedBox(width: 8),
                      Text(
                        '${transaction.date.day}/${transaction.date.month}/${transaction.date.year}',
                        style: TextStyle(
                          fontSize: 12,
                          color: context.appColors.textTertiary,
                        ),
                      ),
                    ],
                  ),
                  trailing: Text(
                    '-${transaction.amount.abs().toStringAsFixed(2)}',
                    style: TextStyle(
                      fontWeight: FontWeight.w600,
                      color: context.appColors.error,
                    ),
                  ),
                ),
              );
            },
          ),
        ),

        // Bottom button
        Container(
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: context.appColors.surface,
            boxShadow: [
              BoxShadow(
                color: Colors.black.withValues(alpha: 0.1),
                blurRadius: 10,
                offset: const Offset(0, -5),
              ),
            ],
          ),
          child: SafeArea(
            child: SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                onPressed: _selectedIndices.isEmpty || _isImporting
                    ? null
                    : _importSelected,
                style: ElevatedButton.styleFrom(
                  backgroundColor: context.appColors.primary,
                  foregroundColor: Colors.white,
                  disabledBackgroundColor: context.appColors.primary.withValues(
                    alpha: 0.3,
                  ),
                  padding: const EdgeInsets.symmetric(vertical: 16),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(16),
                  ),
                ),
                child: _isImporting
                    ? SizedBox(
                        width: 24,
                        height: 24,
                        child: CircularProgressIndicator(
                          strokeWidth: 2,
                          color: Colors.white.withValues(alpha: 0.7),
                        ),
                      )
                    : Text(
                        l10n.importStatementImportSelected(
                          _selectedIndices.length,
                        ),
                        style: const TextStyle(
                          fontSize: 16,
                          fontWeight: FontWeight.w600,
                        ),
                      ),
              ),
            ),
          ),
        ),
      ],
    );
  }
}


--- FILE: lib/screens/income_wizard_screen.dart ---

import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:vantag/l10n/app_localizations.dart';
import 'package:provider/provider.dart';
import '../models/models.dart';
import '../providers/providers.dart';
import '../theme/theme.dart';
import '../utils/currency_utils.dart';
import '../widgets/multi_currency_pro_sheet.dart';

/// Step-by-step income entry wizard
/// Premium UX with multiple income source support
class IncomeWizardScreen extends StatefulWidget {
  final UserProfile? existingProfile;
  final List<IncomeSource>? existingSources;
  final bool isEditing;

  /// If true, skips salary step and goes directly to additional income form
  final bool skipToAdditional;

  const IncomeWizardScreen({
    super.key,
    this.existingProfile,
    this.existingSources,
    this.isEditing = false,
    this.skipToAdditional = false,
  });

  @override
  State<IncomeWizardScreen> createState() => _IncomeWizardScreenState();
}

class _IncomeWizardScreenState extends State<IncomeWizardScreen>
    with TickerProviderStateMixin {
  // Controllers
  final _salaryController = TextEditingController();
  final _additionalAmountController = TextEditingController();
  final _additionalTitleController = TextEditingController();
  final _hoursController = TextEditingController();
  final _pageController = PageController();

  // State
  int _currentStep = 0;
  List<IncomeSource> _incomeSources = [];
  IncomeCategory? _selectedCategory;
  double _dailyHours = 8.0;
  int _workDaysPerWeek = 5;
  bool _isLoading = false;

  // Currency selection - primary and additional
  String _primaryCurrencyCode = 'TRY';
  String _additionalCurrencyCode = 'TRY';

  // Animation
  late AnimationController _fadeController;

  bool _isDataLoaded = false;

  @override
  void initState() {
    super.initState();
    _setupAnimations();
  }

  @override
  void didChangeDependencies() {
    super.didChangeDependencies();
    // Provider'a erişim için didChangeDependencies kullan (sadece 1 kez)
    if (!_isDataLoaded) {
      _isDataLoaded = true;
      _loadExistingData();

      // skipToAdditional true ise, direkt ek gelir adımına atla
      if (widget.skipToAdditional) {
        WidgetsBinding.instance.addPostFrameCallback((_) {
          if (mounted) {
            setState(() => _currentStep = 2);
            _pageController.jumpToPage(2);
          }
        });
      }
    }
  }

  void _setupAnimations() {
    _fadeController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 300),
    );
    _fadeController.forward();
  }

  void _loadExistingData() {
    // Auto-detect currency from device locale
    final systemLocale = PlatformDispatcher.instance.locale;
    final defaultCurrency = getDefaultCurrencyForLocale(
      systemLocale.languageCode,
    );
    _primaryCurrencyCode = defaultCurrency.code;
    _additionalCurrencyCode = defaultCurrency.code;

    // Provider'dan güncel veriyi al (en güvenilir kaynak)
    final provider = context.read<FinanceProvider>();
    final providerProfile = provider.userProfile;

    if (providerProfile != null && providerProfile.incomeSources.isNotEmpty) {
      // Provider'da veri var - onu kullan
      _incomeSources = List.from(providerProfile.incomeSources);
      _dailyHours = providerProfile.dailyHours;
      _workDaysPerWeek = providerProfile.workDaysPerWeek;
      _hoursController.text = _dailyHours.toStringAsFixed(0);

      // Ana maaşı bul
      final primary = providerProfile.primarySource;
      if (primary != null) {
        _salaryController.text = formatTurkishCurrency(
          primary.amount,
          decimalDigits: 0,
          showDecimals: false,
        );
        // Load existing currency from primary income
        _primaryCurrencyCode = primary.currencyCode;
        _additionalCurrencyCode = primary.currencyCode;
      }
    }
    // Fallback: widget parametrelerini kontrol et
    else if (widget.existingSources != null &&
        widget.existingSources!.isNotEmpty) {
      _incomeSources = List.from(widget.existingSources!);

      // Ana maaşı bul
      final primary = _incomeSources.where((s) => s.isPrimary).firstOrNull;
      if (primary != null) {
        _salaryController.text = formatTurkishCurrency(
          primary.amount,
          decimalDigits: 0,
          showDecimals: false,
        );
        _primaryCurrencyCode = primary.currencyCode;
        _additionalCurrencyCode = primary.currencyCode;
      }
    } else if (widget.existingProfile != null) {
      final profile = widget.existingProfile!;
      _incomeSources = List.from(profile.incomeSources);
      _dailyHours = profile.dailyHours;
      _workDaysPerWeek = profile.workDaysPerWeek;
      _hoursController.text = _dailyHours.toStringAsFixed(0);

      // Ana maaşı bul
      final primary = profile.primarySource;
      if (primary != null) {
        _salaryController.text = formatTurkishCurrency(
          primary.amount,
          decimalDigits: 0,
          showDecimals: false,
        );
        _primaryCurrencyCode = primary.currencyCode;
        _additionalCurrencyCode = primary.currencyCode;
      }
    } else {
      _hoursController.text = '8';
    }
  }

  @override
  void dispose() {
    _salaryController.dispose();
    _additionalAmountController.dispose();
    _additionalTitleController.dispose();
    _hoursController.dispose();
    _pageController.dispose();
    _fadeController.dispose();
    super.dispose();
  }

  void _nextStep() {
    if (_currentStep < 3) {
      setState(() => _currentStep++);
      _pageController.nextPage(
        duration: const Duration(milliseconds: 300),
        curve: Curves.easeOutCubic,
      );
    }
  }

  void _previousStep() {
    if (_currentStep > 0) {
      setState(() => _currentStep--);
      _pageController.previousPage(
        duration: const Duration(milliseconds: 300),
        curve: Curves.easeOutCubic,
      );
    }
  }

  Future<void> _saveSalary() async {
    final l10n = AppLocalizations.of(context);
    final amount = parseAmount(_salaryController.text);
    if (amount == null || amount <= 0) {
      _showError(l10n.pleaseEnterValidSalary);
      return;
    }

    // Mevcut primary income'u güncelle veya yeni oluştur
    final existingPrimaryIndex = _incomeSources.indexWhere((s) => s.isPrimary);

    if (existingPrimaryIndex >= 0) {
      _incomeSources[existingPrimaryIndex] =
          _incomeSources[existingPrimaryIndex].copyWith(
            amount: amount,
            currencyCode: _primaryCurrencyCode,
          );
    } else {
      _incomeSources.insert(
        0,
        IncomeSource.salary(
          amount: amount,
          title: l10n.mainSalary,
          currencyCode: _primaryCurrencyCode,
        ),
      );
    }

    // Set additional income default currency to primary currency
    _additionalCurrencyCode = _primaryCurrencyCode;

    HapticFeedback.lightImpact();
    _nextStep();
  }

  void _addAdditionalIncome() {
    final l10n = AppLocalizations.of(context);
    final amount = parseAmount(_additionalAmountController.text);
    final title = _additionalTitleController.text.trim();

    if (amount == null || amount <= 0) {
      _showError(l10n.pleaseEnterValidIncomeAmount);
      return;
    }

    if (_selectedCategory == null) {
      _showError(l10n.pleaseSelectCategory);
      return;
    }

    final source = IncomeSource.additional(
      title: title.isEmpty ? _selectedCategory!.getLocalizedLabel(l10n) : title,
      amount: amount,
      category: _selectedCategory!,
      currencyCode: _additionalCurrencyCode,
    );

    setState(() {
      _incomeSources.add(source);
      _additionalAmountController.clear();
      _additionalTitleController.clear();
      _selectedCategory = null;
      // Reset additional currency to primary for next entry
      _additionalCurrencyCode = _primaryCurrencyCode;
    });

    HapticFeedback.mediumImpact();
  }

  void _removeIncome(String id) {
    setState(() {
      _incomeSources.removeWhere((s) => s.id == id);
    });
    HapticFeedback.lightImpact();
  }

  Future<void> _complete() async {
    final l10n = AppLocalizations.of(context);
    // Double-tap protection
    if (_isLoading) return;

    // Get work hours
    final hours = double.tryParse(_hoursController.text) ?? 8.0;

    if (_incomeSources.isEmpty) {
      _showError(l10n.atLeastOneIncomeRequired);
      return;
    }

    setState(() => _isLoading = true);

    // Capture context before async operations
    final navigator = Navigator.of(context);
    final scaffoldMessenger = ScaffoldMessenger.of(context);
    final provider = context.read<FinanceProvider>();

    try {
      // Save income sources (auto persists)
      await provider.setIncomeSources(_incomeSources);

      // Save work hours (auto persists)
      await provider.updateWorkSchedule(
        dailyHours: hours,
        workDaysPerWeek: _workDaysPerWeek,
      );

      // Save base currency from primary income (for FREE user currency lock)
      final primarySource = _incomeSources
          .where((s) => s.isPrimary)
          .firstOrNull;
      if (primarySource != null && provider.userProfile?.baseCurrency == null) {
        await provider.setBaseCurrency(primarySource.currencyCode);
      }

      // Mounted check after async
      if (!mounted) return;

      HapticFeedback.heavyImpact();

      // Success message
      scaffoldMessenger.showSnackBar(
        SnackBar(
          content: Row(
            children: [
              Icon(
                CupertinoIcons.checkmark_alt_circle_fill,
                color: context.appColors.textPrimary,
              ),
              const SizedBox(width: 12),
              Text(widget.isEditing ? l10n.incomesUpdated : l10n.incomesSaved),
            ],
          ),
          backgroundColor: context.appColors.success,
          behavior: SnackBarBehavior.floating,
        ),
      );

      // Navigator - data already saved in Provider, just go back
      navigator.pop();
    } catch (e) {
      // Show error only if there's a real error
      if (mounted) {
        _showError(l10n.saveError);
      }
    } finally {
      if (mounted) {
        setState(() => _isLoading = false);
      }
    }
  }

  void _showError(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: context.appColors.error,
        behavior: SnackBarBehavior.floating,
      ),
    );
  }

  /// Currency selector widget - reusable for primary and additional income
  /// [isAdditionalIncome] - if true, FREE users see lock icon
  Widget _buildCurrencySelector({
    required String currencyCode,
    required Function(String) onChanged,
    bool isAdditionalIncome = false,
  }) {
    final currency = getCurrencyByCode(currencyCode);
    final l10n = AppLocalizations.of(context);
    final isPro = context.watch<ProProvider>().isPro;

    // FREE users can't change currency for additional income
    final isLocked = isAdditionalIncome && !isPro;

    return Semantics(
      button: true,
      label: l10n.selectCurrency,
      child: GestureDetector(
        onTap: () {
          if (isLocked) {
            MultiCurrencyProSheet.show(context);
          } else {
            _showCurrencyPicker(currencyCode, onChanged);
          }
        },
        child: Container(
          padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 14),
          decoration: BoxDecoration(
            color: context.appColors.surface,
            borderRadius: BorderRadius.circular(16),
            border: Border.all(
              color: isLocked
                  ? context.appColors.textTertiary.withValues(alpha: 0.3)
                  : context.appColors.cardBorder,
            ),
          ),
          child: Row(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Text(currency.flag, style: const TextStyle(fontSize: 24)),
              const SizedBox(width: 12),
              Text(
                '${currency.code} - ${currency.name}',
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.w600,
                  color: isLocked
                      ? context.appColors.textTertiary
                      : context.appColors.textPrimary,
                ),
              ),
              const Spacer(),
              if (isLocked) ...[
                Icon(
                  CupertinoIcons.lock,
                  size: 18,
                  color: context.appColors.textTertiary,
                ),
              ] else ...[
                Text(
                  l10n.change,
                  style: TextStyle(
                    fontSize: 14,
                    fontWeight: FontWeight.w500,
                    color: context.appColors.primary,
                  ),
                ),
                const SizedBox(width: 4),
                Icon(
                  CupertinoIcons.chevron_right,
                  size: 18,
                  color: context.appColors.primary,
                ),
              ],
            ],
          ),
        ),
      ),
    );
  }

  /// Show currency picker bottom sheet
  void _showCurrencyPicker(String currentCode, Function(String) onChanged) {
    final l10n = AppLocalizations.of(context);

    showModalBottomSheet(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      backgroundColor: context.appColors.surface,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
      ),
      builder: (context) => SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(24),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              // Handle
              Container(
                width: 40,
                height: 4,
                decoration: BoxDecoration(
                  color: context.appColors.textTertiary,
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
              const SizedBox(height: 24),

              // Title
              Text(
                l10n.selectCurrency,
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textPrimary,
                ),
              ),
              const SizedBox(height: 24),

              // Currency list
              ...supportedCurrencies.map((currency) {
                final isSelected = currency.code == currentCode;
                return Semantics(
                  button: true,
                  selected: isSelected,
                  label: '${currency.name} ${currency.code}',
                  child: GestureDetector(
                    onTap: () {
                      onChanged(currency.code);
                      Navigator.pop(context);
                      HapticFeedback.selectionClick();
                    },
                    child: Container(
                      margin: const EdgeInsets.only(bottom: 8),
                      padding: const EdgeInsets.symmetric(
                        horizontal: 16,
                        vertical: 14,
                      ),
                      decoration: BoxDecoration(
                        color: isSelected
                            ? context.appColors.primary.withValues(alpha: 0.1)
                            : context.appColors.surfaceLight,
                        borderRadius: BorderRadius.circular(16),
                        border: Border.all(
                          color: isSelected
                              ? context.appColors.primary
                              : context.appColors.cardBorder,
                          width: isSelected ? 2 : 1,
                        ),
                      ),
                      child: Row(
                        children: [
                          Text(
                            currency.flag,
                            style: const TextStyle(fontSize: 24),
                          ),
                          const SizedBox(width: 16),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  currency.code,
                                  style: TextStyle(
                                    fontSize: 16,
                                    fontWeight: FontWeight.w600,
                                    color: isSelected
                                        ? context.appColors.primary
                                        : context.appColors.textPrimary,
                                  ),
                                ),
                                Text(
                                  currency.name,
                                  style: TextStyle(
                                    fontSize: 13,
                                    color: context.appColors.textSecondary,
                                  ),
                                ),
                              ],
                            ),
                          ),
                          Text(
                            currency.symbol,
                            style: TextStyle(
                              fontSize: 18,
                              fontWeight: FontWeight.w600,
                              color: isSelected
                                  ? context.appColors.primary
                                  : context.appColors.textSecondary,
                            ),
                          ),
                          if (isSelected) ...[
                            const SizedBox(width: 8),
                            Icon(
                              CupertinoIcons.checkmark_alt_circle_fill,
                              size: 22,
                              color: context.appColors.primary,
                            ),
                          ],
                        ],
                      ),
                    ),
                  ),
                );
              }),

              const SizedBox(height: 12),
            ],
          ),
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    return Scaffold(
      backgroundColor: context.appColors.background,
      appBar: AppBar(
        backgroundColor: Colors.transparent,
        elevation: 0,
        leading: IconButton(
          icon: Icon(CupertinoIcons.xmark),
          tooltip: l10n.close,
          onPressed: () => Navigator.pop(context),
        ),
        title: Text(
          widget.isEditing ? l10n.editIncomes : l10n.addIncome,
          style: const TextStyle(fontSize: 18, fontWeight: FontWeight.w600),
        ),
        centerTitle: true,
      ),
      body: Column(
        children: [
          // Progress indicator
          _buildProgressIndicator(),

          // Page content
          Expanded(
            child: PageView(
              controller: _pageController,
              physics: const NeverScrollableScrollPhysics(),
              children: [
                _buildStep1_Salary(),
                _buildStep2_AskMore(),
                _buildStep3_AddMore(),
                _buildStep4_Summary(),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildProgressIndicator() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
      child: Row(
        children: List.generate(4, (index) {
          final isActive = index <= _currentStep;

          return Expanded(
            child: Row(
              children: [
                Expanded(
                  child: AnimatedContainer(
                    duration: const Duration(milliseconds: 300),
                    height: 4,
                    decoration: BoxDecoration(
                      color: isActive
                          ? context.appColors.primary
                          : context.appColors.surfaceLight,
                      borderRadius: BorderRadius.circular(2),
                    ),
                  ),
                ),
                if (index < 3) const SizedBox(width: 8),
              ],
            ),
          );
        }),
      ),
    );
  }

  // ============================================
  // STEP 1: Primary Salary
  // ============================================
  Widget _buildStep1_Salary() {
    final l10n = AppLocalizations.of(context);
    return SingleChildScrollView(
      padding: const EdgeInsets.all(24),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const SizedBox(height: 20),

          // Icon
          Center(
            child: Container(
              width: 80,
              height: 80,
              decoration: BoxDecoration(
                color: context.appColors.primary.withValues(alpha: 0.1),
                shape: BoxShape.circle,
              ),
              child: const Center(
                child: Text('💼', style: TextStyle(fontSize: 40)),
              ),
            ),
          ),

          const SizedBox(height: 24),

          // Title
          Center(
            child: Text(
              l10n.whatIsYourSalary,
              style: TextStyle(
                fontSize: 24,
                fontWeight: FontWeight.w700,
                color: context.appColors.textPrimary,
              ),
            ),
          ),

          const SizedBox(height: 8),

          Center(
            child: Text(
              l10n.enterNetAmount,
              style: TextStyle(
                fontSize: 14,
                color: context.appColors.textSecondary,
              ),
            ),
          ),

          const SizedBox(height: 40),

          // Amount input
          TextField(
            controller: _salaryController,
            keyboardType: const TextInputType.numberWithOptions(decimal: true),
            inputFormatters: [TurkishCurrencyInputFormatter()],
            style: TextStyle(
              fontSize: 32,
              fontWeight: FontWeight.w700,
              color: context.appColors.primary,
            ),
            textAlign: TextAlign.center,
            decoration: InputDecoration(
              hintText: '0',
              hintStyle: TextStyle(
                fontSize: 32,
                fontWeight: FontWeight.w700,
                color: context.appColors.textTertiary.withValues(alpha: 0.5),
              ),
              suffixText: getCurrencyByCode(_primaryCurrencyCode).code,
              suffixStyle: TextStyle(
                fontSize: 24,
                fontWeight: FontWeight.w600,
                color: context.appColors.textSecondary,
              ),
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(24),
                borderSide: BorderSide.none,
              ),
              filled: true,
              fillColor: context.appColors.surface,
              contentPadding: const EdgeInsets.symmetric(
                horizontal: 24,
                vertical: 20,
              ),
            ),
          ),

          const SizedBox(height: 16),

          // Currency selector
          _buildCurrencySelector(
            currencyCode: _primaryCurrencyCode,
            onChanged: (code) {
              setState(() => _primaryCurrencyCode = code);
            },
          ),

          const SizedBox(height: 24),

          // Work hours
          Container(
            padding: const EdgeInsets.all(20),
            decoration: BoxDecoration(
              color: context.appColors.surface,
              borderRadius: BorderRadius.circular(16),
              border: Border.all(color: context.appColors.cardBorder),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  l10n.dailyWork,
                  style: TextStyle(
                    fontSize: 14,
                    fontWeight: FontWeight.w600,
                    color: context.appColors.textPrimary,
                  ),
                ),
                const SizedBox(height: 12),
                Row(
                  children: [
                    Expanded(
                      child: TextField(
                        controller: _hoursController,
                        keyboardType: TextInputType.number,
                        inputFormatters: [
                          FilteringTextInputFormatter.digitsOnly,
                          LengthLimitingTextInputFormatter(2),
                        ],
                        decoration: InputDecoration(
                          hintText: '8',
                          suffixText: l10n.hours,
                          border: OutlineInputBorder(
                            borderRadius: BorderRadius.circular(16),
                          ),
                          contentPadding: const EdgeInsets.symmetric(
                            horizontal: 16,
                            vertical: 12,
                          ),
                        ),
                      ),
                    ),
                    const SizedBox(width: 16),
                    Expanded(
                      child: Container(
                        padding: const EdgeInsets.symmetric(
                          horizontal: 16,
                          vertical: 12,
                        ),
                        decoration: BoxDecoration(
                          border: Border.all(
                            color: context.appColors.cardBorder,
                          ),
                          borderRadius: BorderRadius.circular(16),
                        ),
                        child: DropdownButtonHideUnderline(
                          child: DropdownButton<int>(
                            value: _workDaysPerWeek,
                            isExpanded: true,
                            items: [5, 6, 7].map((days) {
                              return DropdownMenuItem(
                                value: days,
                                child: Text('$days ${l10n.daysPerWeek}'),
                              );
                            }).toList(),
                            onChanged: (value) {
                              setState(() => _workDaysPerWeek = value ?? 5);
                            },
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),

          const SizedBox(height: 40),

          // Continue button
          SizedBox(
            width: double.infinity,
            height: 56,
            child: ElevatedButton(
              onPressed: _saveSalary,
              style: ElevatedButton.styleFrom(
                backgroundColor: context.appColors.primary,
                foregroundColor: context.appColors.textPrimary,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(16),
                ),
                elevation: 0,
              ),
              child: Text(
                l10n.continueButton,
                style: const TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.w600,
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  // ============================================
  // STEP 2: Additional Income Question
  // ============================================
  Widget _buildStep2_AskMore() {
    final l10n = AppLocalizations.of(context);
    return SingleChildScrollView(
      padding: const EdgeInsets.all(24),
      child: Column(
        children: [
          const SizedBox(height: 40),

          // Icon
          Container(
            width: 100,
            height: 100,
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [
                  context.appColors.success.withValues(alpha: 0.2),
                  context.appColors.primary.withValues(alpha: 0.1),
                ],
              ),
              shape: BoxShape.circle,
            ),
            child: const Center(
              child: Text('💰', style: TextStyle(fontSize: 48)),
            ),
          ),

          const SizedBox(height: 32),

          Text(
            l10n.doYouHaveOtherIncome,
            textAlign: TextAlign.center,
            style: TextStyle(
              fontSize: 28,
              fontWeight: FontWeight.w700,
              color: context.appColors.textPrimary,
              height: 1.2,
            ),
          ),

          const SizedBox(height: 16),

          Text(
            l10n.otherIncomeDescription,
            textAlign: TextAlign.center,
            style: TextStyle(
              fontSize: 15,
              color: context.appColors.textSecondary,
              height: 1.4,
            ),
          ),

          const SizedBox(height: 48),

          // Yes button
          SizedBox(
            width: double.infinity,
            height: 60,
            child: ElevatedButton(
              onPressed: _nextStep,
              style: ElevatedButton.styleFrom(
                backgroundColor: context.appColors.primary,
                foregroundColor: context.appColors.textPrimary,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(16),
                ),
                elevation: 0,
              ),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(CupertinoIcons.add_circled, size: 24),
                  const SizedBox(width: 12),
                  Text(
                    l10n.yesAddIncome,
                    style: const TextStyle(
                      fontSize: 16,
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                ],
              ),
            ),
          ),

          const SizedBox(height: 16),

          // No button
          SizedBox(
            width: double.infinity,
            height: 60,
            child: OutlinedButton(
              onPressed: () {
                // Skip to summary
                setState(() => _currentStep = 3);
                _pageController.animateToPage(
                  3,
                  duration: const Duration(milliseconds: 300),
                  curve: Curves.easeOutCubic,
                );
              },
              style: OutlinedButton.styleFrom(
                side: BorderSide(color: context.appColors.cardBorder),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(16),
                ),
              ),
              child: Text(
                l10n.noOnlySalary,
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textSecondary,
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  // ============================================
  // STEP 3: Add Additional Income
  // ============================================
  Widget _buildStep3_AddMore() {
    final l10n = AppLocalizations.of(context);
    final additionalSources = _incomeSources
        .where((s) => !s.isPrimary)
        .toList();

    return SingleChildScrollView(
      padding: const EdgeInsets.all(24),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            l10n.addAdditionalIncome,
            style: TextStyle(
              fontSize: 24,
              fontWeight: FontWeight.w700,
              color: context.appColors.textPrimary,
            ),
          ),

          const SizedBox(height: 24),

          // Category selection
          Text(
            l10n.incomeType,
            style: TextStyle(
              fontSize: 14,
              fontWeight: FontWeight.w600,
              color: context.appColors.textSecondary,
            ),
          ),
          const SizedBox(height: 12),

          Wrap(
            spacing: 10,
            runSpacing: 10,
            children: IncomeCategory.values
                .where((c) => c != IncomeCategory.salary)
                .map((category) {
                  final isSelected = _selectedCategory == category;
                  return Semantics(
                    button: true,
                    selected: isSelected,
                    label: category.getLocalizedLabel(l10n),
                    child: GestureDetector(
                      onTap: () {
                        setState(() => _selectedCategory = category);
                        HapticFeedback.selectionClick();
                      },
                      child: AnimatedContainer(
                        duration: const Duration(milliseconds: 200),
                        padding: const EdgeInsets.symmetric(
                          horizontal: 16,
                          vertical: 12,
                        ),
                        decoration: BoxDecoration(
                          color: isSelected
                              ? context.appColors.primary.withValues(alpha: 0.1)
                              : context.appColors.surface,
                          borderRadius: BorderRadius.circular(16),
                          border: Border.all(
                            color: isSelected
                                ? context.appColors.primary
                                : context.appColors.cardBorder,
                            width: isSelected ? 2 : 1,
                          ),
                        ),
                        child: Row(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            Icon(
                              category.icon,
                              size: 22,
                              color: isSelected
                                  ? category.color
                                  : context.appColors.textSecondary,
                            ),
                            const SizedBox(width: 8),
                            Text(
                              category.getLocalizedLabel(l10n),
                              style: TextStyle(
                                fontSize: 14,
                                fontWeight: isSelected
                                    ? FontWeight.w600
                                    : FontWeight.w500,
                                color: isSelected
                                    ? context.appColors.primary
                                    : context.appColors.textPrimary,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ),
                  );
                })
                .toList(),
          ),

          const SizedBox(height: 24),

          // Title (optional)
          TextField(
            controller: _additionalTitleController,
            keyboardType: TextInputType.text,
            enableSuggestions: true,
            autocorrect: false,
            enableIMEPersonalizedLearning: true,
            textCapitalization: TextCapitalization.words,
            decoration: InputDecoration(
              labelText: l10n.descriptionOptional,
              hintText:
                  _selectedCategory?.getLocalizedLabel(l10n) ??
                  l10n.descriptionOptionalHint,
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(16),
              ),
              contentPadding: const EdgeInsets.symmetric(
                horizontal: 16,
                vertical: 14,
              ),
            ),
          ),

          const SizedBox(height: 16),

          // Amount
          TextField(
            controller: _additionalAmountController,
            keyboardType: const TextInputType.numberWithOptions(decimal: true),
            inputFormatters: [TurkishCurrencyInputFormatter()],
            decoration: InputDecoration(
              labelText: l10n.monthlyAmount,
              hintText: '0',
              suffixText: getCurrencyByCode(_additionalCurrencyCode).code,
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(16),
              ),
              contentPadding: const EdgeInsets.symmetric(
                horizontal: 16,
                vertical: 14,
              ),
            ),
          ),

          const SizedBox(height: 12),

          // Currency selector for additional income (locked for FREE users)
          _buildCurrencySelector(
            currencyCode: _additionalCurrencyCode,
            onChanged: (code) {
              setState(() => _additionalCurrencyCode = code);
            },
            isAdditionalIncome: true,
          ),

          const SizedBox(height: 16),

          // Add button
          SizedBox(
            width: double.infinity,
            child: ElevatedButton.icon(
              onPressed: _addAdditionalIncome,
              icon: Icon(CupertinoIcons.add),
              label: Text(l10n.addIncome),
              style: ElevatedButton.styleFrom(
                backgroundColor: context.appColors.success,
                foregroundColor: context.appColors.textPrimary,
                padding: const EdgeInsets.symmetric(vertical: 14),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(16),
                ),
              ),
            ),
          ),

          // Added incomes list
          if (additionalSources.isNotEmpty) ...[
            const SizedBox(height: 32),
            Text(
              l10n.addedIncomes,
              style: TextStyle(
                fontSize: 16,
                fontWeight: FontWeight.w600,
                color: context.appColors.textPrimary,
              ),
            ),
            const SizedBox(height: 12),
            ...additionalSources.map((source) {
              return Container(
                margin: const EdgeInsets.only(bottom: 12),
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: context.appColors.surface,
                  borderRadius: BorderRadius.circular(16),
                  border: Border.all(color: context.appColors.cardBorder),
                ),
                child: Row(
                  children: [
                    Icon(
                      source.category.icon,
                      size: 26,
                      color: source.category.color,
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            source.title,
                            style: TextStyle(
                              fontSize: 14,
                              fontWeight: FontWeight.w600,
                              color: context.appColors.textPrimary,
                            ),
                          ),
                          Text(
                            source.category.getLocalizedLabel(l10n),
                            style: TextStyle(
                              fontSize: 12,
                              color: context.appColors.textSecondary,
                            ),
                          ),
                        ],
                      ),
                    ),
                    Text(
                      '${formatTurkishCurrency(source.amount, decimalDigits: 0, showDecimals: false)} ${getCurrencyByCode(source.currencyCode).symbol}',
                      style: TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.w700,
                        color: context.appColors.success,
                      ),
                    ),
                    const SizedBox(width: 8),
                    IconButton(
                      icon: Icon(CupertinoIcons.xmark, size: 20),
                      tooltip: l10n.delete,
                      color: context.appColors.error,
                      onPressed: () => _removeIncome(source.id),
                    ),
                  ],
                ),
              );
            }),
          ],

          const SizedBox(height: 32),

          // Continue button - auto add if form has data
          SizedBox(
            width: double.infinity,
            height: 56,
            child: ElevatedButton(
              onPressed: () {
                // If form has filled data, add first
                final hasAmount =
                    parseAmount(_additionalAmountController.text) != null &&
                    parseAmount(_additionalAmountController.text)! > 0;
                final hasCategory = _selectedCategory != null;

                if (hasAmount && hasCategory) {
                  // Form filled, add first then continue
                  _addAdditionalIncome();
                }
                _nextStep();
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: context.appColors.primary,
                foregroundColor: context.appColors.textPrimary,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(16),
                ),
              ),
              child: Text(
                l10n.continueButton,
                style: const TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.w600,
                ),
              ),
            ),
          ),

          const SizedBox(height: 16),

          // Back button
          Center(
            child: TextButton(
              onPressed: _previousStep,
              child: Text(l10n.goBack),
            ),
          ),
        ],
      ),
    );
  }

  // ============================================
  // STEP 4: Summary
  // ============================================
  Widget _buildStep4_Summary() {
    final l10n = AppLocalizations.of(context);
    final total = _incomeSources.fold<double>(0, (sum, s) => sum + s.amount);

    return SingleChildScrollView(
      padding: const EdgeInsets.all(24),
      child: Column(
        children: [
          const SizedBox(height: 20),

          // Success icon
          Container(
            width: 80,
            height: 80,
            decoration: BoxDecoration(
              color: context.appColors.success.withValues(alpha: 0.1),
              shape: BoxShape.circle,
            ),
            child: Icon(
              CupertinoIcons.checkmark_alt_circle_fill,
              size: 48,
              color: context.appColors.success,
            ),
          ),

          const SizedBox(height: 24),

          Text(
            l10n.incomeSummary,
            style: TextStyle(
              fontSize: 24,
              fontWeight: FontWeight.w700,
              color: context.appColors.textPrimary,
            ),
          ),

          const SizedBox(height: 32),

          // Total card
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(24),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: [
                  context.appColors.primary,
                  context.appColors.primaryDark,
                ],
              ),
              borderRadius: BorderRadius.circular(24),
              boxShadow: [
                BoxShadow(
                  color: context.appColors.primary.withValues(alpha: 0.3),
                  blurRadius: 20,
                  offset: const Offset(0, 10),
                ),
              ],
            ),
            child: Column(
              children: [
                Text(
                  l10n.totalMonthlyIncome,
                  style: TextStyle(
                    fontSize: 14,
                    color: context.appColors.textPrimary.withValues(alpha: 0.7),
                  ),
                ),
                const SizedBox(height: 8),
                Text(
                  '${formatTurkishCurrency(total, decimalDigits: 0, showDecimals: false)} ${getCurrencyByCode(_primaryCurrencyCode).symbol}',
                  style: TextStyle(
                    fontSize: 36,
                    fontWeight: FontWeight.w800,
                    color: context.appColors.textPrimary,
                  ),
                ),
                const SizedBox(height: 8),
                Text(
                  l10n.incomeSourceCount(_incomeSources.length),
                  style: TextStyle(
                    fontSize: 14,
                    color: context.appColors.textPrimary.withValues(alpha: 0.7),
                  ),
                ),
              ],
            ),
          ),

          const SizedBox(height: 24),

          // Income breakdown
          ...List.generate(_incomeSources.length, (index) {
            final source = _incomeSources[index];
            final percentage = total > 0 ? (source.amount / total * 100) : 0;

            return Container(
              margin: const EdgeInsets.only(bottom: 12),
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: context.appColors.surface,
                borderRadius: BorderRadius.circular(16),
                border: Border.all(color: context.appColors.cardBorder),
              ),
              child: Row(
                children: [
                  Container(
                    width: 44,
                    height: 44,
                    decoration: BoxDecoration(
                      color: source.isPrimary
                          ? context.appColors.primary.withValues(alpha: 0.1)
                          : context.appColors.success.withValues(alpha: 0.1),
                      borderRadius: BorderRadius.circular(16),
                    ),
                    child: Center(
                      child: Icon(
                        source.category.icon,
                        size: 24,
                        color: source.category.color,
                      ),
                    ),
                  ),
                  const SizedBox(width: 14),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          source.title,
                          style: TextStyle(
                            fontSize: 15,
                            fontWeight: FontWeight.w600,
                            color: context.appColors.textPrimary,
                          ),
                        ),
                        Text(
                          source.category.getLocalizedLabel(l10n),
                          style: TextStyle(
                            fontSize: 12,
                            color: context.appColors.textSecondary,
                          ),
                        ),
                      ],
                    ),
                  ),
                  Column(
                    crossAxisAlignment: CrossAxisAlignment.end,
                    children: [
                      Text(
                        '${formatTurkishCurrency(source.amount, decimalDigits: 0, showDecimals: false)} ${getCurrencyByCode(source.currencyCode).symbol}',
                        style: TextStyle(
                          fontSize: 16,
                          fontWeight: FontWeight.w700,
                          color: context.appColors.textPrimary,
                        ),
                      ),
                      Text(
                        '%${percentage.toStringAsFixed(0)}',
                        style: TextStyle(
                          fontSize: 12,
                          color: context.appColors.textSecondary,
                        ),
                      ),
                    ],
                  ),
                ],
              ),
            );
          }),

          const SizedBox(height: 32),

          // Complete button
          SizedBox(
            width: double.infinity,
            height: 56,
            child: ElevatedButton(
              onPressed: _isLoading ? null : _complete,
              style: ElevatedButton.styleFrom(
                backgroundColor: context.appColors.success,
                foregroundColor: context.appColors.textPrimary,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(16),
                ),
                elevation: 0,
              ),
              child: _isLoading
                  ? SizedBox(
                      width: 24,
                      height: 24,
                      child: CircularProgressIndicator(
                        strokeWidth: 2,
                        color: context.appColors.textPrimary,
                      ),
                    )
                  : Text(
                      l10n.complete,
                      style: const TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.w600,
                      ),
                    ),
            ),
          ),

          const SizedBox(height: 16),

          // Edit button
          TextButton(
            onPressed: () {
              setState(() => _currentStep = 2);
              _pageController.animateToPage(
                2,
                duration: const Duration(milliseconds: 300),
                curve: Curves.easeOutCubic,
              );
            },
            child: Text(l10n.editMyIncomes),
          ),
        ],
      ),
    );
  }
}


--- FILE: lib/screens/pursuit_list_screen.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:share_plus/share_plus.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';
import '../providers/providers.dart';
import '../services/referral_service.dart';
import '../services/deep_link_service.dart';
import '../theme/theme.dart';
import '../widgets/widgets.dart';

/// Main screen for managing pursuits (savings goals)
/// Replaces the Achievements tab (tab index 2)
class PursuitListScreen extends StatefulWidget {
  const PursuitListScreen({super.key});

  @override
  State<PursuitListScreen> createState() => _PursuitListScreenState();
}

class _PursuitListScreenState extends State<PursuitListScreen>
    with SingleTickerProviderStateMixin {
  late TabController _tabController;
  bool _showCompleted = false;

  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 2, vsync: this);
    _tabController.addListener(() {
      setState(() {
        _showCompleted = _tabController.index == 1;
      });
    });

    // Initialize pursuits if not already done
    WidgetsBinding.instance.addPostFrameCallback((_) {
      final provider = context.read<PursuitProvider>();
      if (!provider.isInitialized) {
        provider.initialize();
      }
    });
  }

  @override
  void dispose() {
    _tabController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final pursuitProvider = context.watch<PursuitProvider>();
    final currencyProvider = context.watch<CurrencyProvider>();

    final pursuits = _showCompleted
        ? pursuitProvider.completedPursuits
        : pursuitProvider.activePursuits;

    return Scaffold(
      backgroundColor: context.appColors.background,
      body: CustomScrollView(
        slivers: [
          // App bar
          SliverAppBar(
            backgroundColor: context.appColors.background,
            surfaceTintColor: Colors.transparent,
            pinned: true,
            floating: false,
            expandedHeight: 120,
            flexibleSpace: FlexibleSpaceBar(
              titlePadding: const EdgeInsets.only(left: 20, bottom: 16),
              title: Text(
                l10n.myPursuits,
                style: TextStyle(
                  fontSize: 20,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textPrimary,
                ),
              ),
              background: Container(
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    begin: Alignment.topCenter,
                    end: Alignment.bottomCenter,
                    colors: [
                      context.appColors.background.withValues(alpha: 0.0),
                      context.appColors.background,
                    ],
                  ),
                ),
              ),
            ),
          ),

          // Tab bar
          SliverPersistentHeader(
            pinned: true,
            delegate: _TabBarDelegate(
              TabBar(
                controller: _tabController,
                indicatorColor: context.appColors.success,
                indicatorWeight: 2,
                labelColor: context.appColors.success,
                unselectedLabelColor: context.appColors.textTertiary,
                labelStyle: TextStyle(
                  fontSize: 14,
                  fontWeight: FontWeight.w600,
                ),
                unselectedLabelStyle: TextStyle(
                  fontSize: 14,
                  fontWeight: FontWeight.w400,
                ),
                tabs: [
                  Tab(
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(CupertinoIcons.scope, size: 18),
                        const SizedBox(width: 8),
                        Text(l10n.activePursuits),
                        if (pursuitProvider.activePursuitCount > 0) ...[
                          const SizedBox(width: 6),
                          _CountBadge(
                            count: pursuitProvider.activePursuitCount,
                          ),
                        ],
                      ],
                    ),
                  ),
                  Tab(
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(CupertinoIcons.check_mark, size: 18),
                        const SizedBox(width: 8),
                        Text(l10n.completedPursuits),
                        if (pursuitProvider.completedPursuitCount > 0) ...[
                          const SizedBox(width: 6),
                          _CountBadge(
                            count: pursuitProvider.completedPursuitCount,
                            color: QuietLuxury.gold,
                          ),
                        ],
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ),

          // Savings Pool Card - only show on active tab
          if (!_showCompleted)
            SliverToBoxAdapter(
              child: Padding(
                padding: const EdgeInsets.fromLTRB(16, 0, 16, 16),
                child: SavingsPoolCard(compact: true),
              ),
            ),

          // Content
          if (pursuitProvider.isLoading)
            SliverFillRemaining(
              child: Center(
                child: CircularProgressIndicator(
                  valueColor: AlwaysStoppedAnimation<Color>(
                    context.appColors.success,
                  ),
                ),
              ),
            )
          else if (pursuits.isEmpty)
            SliverFillRemaining(child: _buildEmptyState(l10n))
          else
            SliverPadding(
              padding: const EdgeInsets.all(16),
              sliver: SliverList(
                delegate: SliverChildBuilderDelegate((context, index) {
                  final pursuit = pursuits[index];
                  return Padding(
                    padding: const EdgeInsets.only(bottom: 12),
                    child: Dismissible(
                      key: Key(pursuit.id),
                      direction: DismissDirection.endToStart,
                      confirmDismiss: (_) => _confirmDelete(pursuit),
                      background: _buildDismissBackground(),
                      child: PursuitCard(
                        pursuit: pursuit,
                        formatAmount: (amount) => _formatAmount(
                          amount,
                          currencyProvider.currency.symbol,
                        ),
                        onTap: () => _showPursuitDetail(pursuit),
                        onAddSavings: pursuit.isCompleted
                            ? null
                            : () => _addSavings(pursuit),
                      ),
                    ),
                  );
                }, childCount: pursuits.length),
              ),
            ),

          // "Add New Dream" card at bottom (only for active pursuits)
          if (!_showCompleted && pursuits.isNotEmpty)
            SliverPadding(
              padding: const EdgeInsets.fromLTRB(16, 0, 16, 120),
              sliver: SliverToBoxAdapter(
                child: _buildAddNewPursuitCard(l10n),
              ),
            ),
        ],
      ),
    );
  }

  Widget _buildEmptyState(AppLocalizations l10n) {
    return Center(
      child: Padding(
        padding: const EdgeInsets.all(32),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Container(
              padding: const EdgeInsets.all(24),
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                color: context.appColors.surfaceLight,
                border: Border.all(
                  color: context.appColors.cardBorder,
                  width: 0.5,
                ),
              ),
              child: Icon(
                _showCompleted
                    ? CupertinoIcons.rosette
                    : CupertinoIcons.star_fill,
                size: 64,
                color: context.appColors.textTertiary,
              ),
            ),
            const SizedBox(height: 24),
            Text(
              _showCompleted ? l10n.completedPursuits : l10n.emptyPursuitsTitle,
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.w600,
                color: context.appColors.textPrimary,
              ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 8),
            Text(
              _showCompleted ? l10n.noTransactions : l10n.emptyPursuitsMessage,
              style: TextStyle(
                fontSize: 14,
                color: context.appColors.textSecondary,
              ),
              textAlign: TextAlign.center,
            ),
            if (!_showCompleted) ...[
              const SizedBox(height: 24),
              ElevatedButton.icon(
                onPressed: _createPursuit,
                style: ElevatedButton.styleFrom(
                  backgroundColor: context.appColors.success,
                  foregroundColor: context.appColors.textPrimary,
                  padding: const EdgeInsets.symmetric(
                    horizontal: 24,
                    vertical: 12,
                  ),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(16),
                  ),
                ),
                icon: Icon(CupertinoIcons.add, size: 18),
                label: Text(l10n.addFirstPursuit),
              ),
            ],
          ],
        ),
      ),
    );
  }

  Widget _buildAddNewPursuitCard(AppLocalizations l10n) {
    return GestureDetector(
      onTap: _createPursuit,
      child: Container(
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: [
              context.appColors.success.withValues(alpha: 0.15),
              context.appColors.success.withValues(alpha: 0.05),
            ],
          ),
          borderRadius: BorderRadius.circular(24),
          border: Border.all(
            color: context.appColors.success.withValues(alpha: 0.3),
            width: 1.5,
            strokeAlign: BorderSide.strokeAlignOutside,
          ),
        ),
        child: Row(
          children: [
            Container(
              width: 52,
              height: 52,
              decoration: BoxDecoration(
                color: context.appColors.success.withValues(alpha: 0.2),
                borderRadius: BorderRadius.circular(16),
              ),
              child: Icon(
                CupertinoIcons.add,
                color: context.appColors.success,
                size: 28,
              ),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    l10n.createPursuit,
                    style: TextStyle(
                      fontSize: 16,
                      fontWeight: FontWeight.w600,
                      color: context.appColors.textPrimary,
                    ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    l10n.emptyPursuitsMessage,
                    style: TextStyle(
                      fontSize: 12,
                      color: context.appColors.textSecondary,
                    ),
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                  ),
                ],
              ),
            ),
            Icon(
              CupertinoIcons.chevron_right,
              color: context.appColors.success,
              size: 24,
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildDismissBackground() {
    return Container(
      alignment: Alignment.centerRight,
      padding: const EdgeInsets.only(right: 20),
      decoration: BoxDecoration(
        color: context.appColors.error.withValues(alpha: 0.2),
        borderRadius: BorderRadius.circular(16),
      ),
      child: Icon(CupertinoIcons.trash_fill, color: context.appColors.error),
    );
  }

  String _formatAmount(double amount, String symbol) {
    if (amount >= 1000000) {
      return '$symbol${(amount / 1000000).toStringAsFixed(1)}M';
    } else if (amount >= 1000) {
      return '$symbol${(amount / 1000).toStringAsFixed(1)}K';
    }
    return '$symbol${amount.toStringAsFixed(0)}';
  }

  Future<void> _createPursuit() async {
    HapticFeedback.selectionClick();

    // Check pursuit limit for free users
    final proProvider = context.read<ProProvider>();
    final pursuitProvider = context.read<PursuitProvider>();
    final isPremium = proProvider.isPro;

    final canCreate = await pursuitProvider.canCreatePursuit(isPremium);
    if (!canCreate && mounted) {
      final l10n = AppLocalizations.of(context);
      UpgradeDialog.show(context, l10n.pursuitLimitReachedFree);
      return;
    }

    final result = await showCreatePursuitSheet(context);
    if (result == true && mounted) {
      // Refresh
    }
  }

  Future<void> _addSavings(Pursuit pursuit) async {
    HapticFeedback.selectionClick();
    final reachedTarget = await showAddSavingsSheet(context, pursuit: pursuit);

    if (reachedTarget == true && mounted) {
      // Show completion celebration
      final updatedPursuit = context.read<PursuitProvider>().getPursuitById(
        pursuit.id,
      );
      if (updatedPursuit != null) {
        await context.read<PursuitProvider>().completePursuit(pursuit.id);
        if (mounted) {
          showPursuitCelebration(
            context,
            updatedPursuit,
            onShare: () => _sharePursuitCompletion(updatedPursuit),
            onNewGoal: () => _openCreatePursuit(),
          );
        }
      }
    }
  }

  void _showPursuitDetail(Pursuit pursuit) {
    HapticFeedback.selectionClick();
    showModalBottomSheet(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      backgroundColor: Colors.transparent,
      isScrollControlled: true,
      builder: (_) => _PursuitDetailSheet(
        pursuit: pursuit,
        formatAmount: (amount) => _formatAmount(
          amount,
          context.read<CurrencyProvider>().currency.symbol,
        ),
        onEdit: () async {
          Navigator.of(context).pop();
          await showCreatePursuitSheet(context, pursuit: pursuit);
        },
        onDelete: () async {
          Navigator.of(context).pop();
          final confirmed = await _confirmDelete(pursuit);
          if (confirmed == true) {
            await context.read<PursuitProvider>().deletePursuit(pursuit.id);
          }
        },
        onAddSavings: pursuit.isCompleted
            ? null
            : () async {
                Navigator.of(context).pop();
                await _addSavings(pursuit);
              },
      ),
    );
  }

  Future<bool?> _confirmDelete(Pursuit pursuit) async {
    final l10n = AppLocalizations.of(context);
    final colors = context.appColors;
    return showDialog<bool>(
      context: context,
      builder: (dialogContext) => AlertDialog(
        backgroundColor: colors.surface,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
        title: Text(
          l10n.deletePursuit,
          style: TextStyle(
            fontSize: 20,
            fontWeight: FontWeight.w600,
            color: colors.textPrimary,
          ),
        ),
        content: Text(
          l10n.deletePursuitConfirm,
          style: TextStyle(fontSize: 14, color: colors.textSecondary),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(dialogContext).pop(false),
            child: Text(
              l10n.cancel,
              style: TextStyle(color: colors.textSecondary),
            ),
          ),
          TextButton(
            onPressed: () => Navigator.of(dialogContext).pop(true),
            child: Text(l10n.delete, style: TextStyle(color: colors.error)),
          ),
        ],
      ),
    );
  }

  /// Share pursuit completion achievement
  Future<void> _sharePursuitCompletion(Pursuit pursuit) async {
    final l10n = AppLocalizations.of(context);
    final currencyProvider = context.read<CurrencyProvider>();
    final symbol = currencyProvider.currency.symbol;

    // Get referral link for sharing
    String shareLink = 'vantag.app';
    try {
      final referralCode = await ReferralService().getOrCreateReferralCode();
      if (referralCode != null) {
        final referralLink = DeepLinkService.generateReferralLink(referralCode);
        shareLink = referralLink.toString();
      }
    } catch (e) {
      // Use default link if referral fails (graceful fallback)
      debugPrint('[PursuitListScreen] Referral link error, using default: $e');
    }

    final shareText =
        '🎉 ${l10n.pursuitCompleted}: ${pursuit.name}!\n'
        '💰 $symbol${pursuit.targetAmount.toStringAsFixed(0)} ${l10n.saved}\n\n'
        '${l10n.shareDefaultMessage(shareLink)}';

    await Share.share(shareText);
  }

  /// Open create pursuit sheet for new goal
  void _openCreatePursuit() {
    showCreatePursuitSheet(context);
  }
}

class _CountBadge extends StatelessWidget {
  final int count;
  final Color? color;

  const _CountBadge({required this.count, this.color});

  @override
  Widget build(BuildContext context) {
    final effectiveColor = color ?? context.appColors.success;
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
      decoration: BoxDecoration(
        color: effectiveColor.withValues(alpha: 0.2),
        borderRadius: BorderRadius.circular(8),
      ),
      child: Text(
        count.toString(),
        style: TextStyle(
          color: effectiveColor,
          fontWeight: FontWeight.w600,
          fontSize: 10,
        ),
      ),
    );
  }
}

class _TabBarDelegate extends SliverPersistentHeaderDelegate {
  final TabBar tabBar;

  _TabBarDelegate(this.tabBar);

  @override
  Widget build(
    BuildContext context,
    double shrinkOffset,
    bool overlapsContent,
  ) {
    return Container(color: context.appColors.background, child: tabBar);
  }

  @override
  double get maxExtent => tabBar.preferredSize.height;

  @override
  double get minExtent => tabBar.preferredSize.height;

  @override
  bool shouldRebuild(covariant _TabBarDelegate oldDelegate) {
    return tabBar != oldDelegate.tabBar;
  }
}

class _PursuitDetailSheet extends StatelessWidget {
  final Pursuit pursuit;
  final String Function(double amount) formatAmount;
  final VoidCallback? onEdit;
  final VoidCallback? onDelete;
  final VoidCallback? onAddSavings;

  const _PursuitDetailSheet({
    required this.pursuit,
    required this.formatAmount,
    this.onEdit,
    this.onDelete,
    this.onAddSavings,
  });

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final colors = context.appColors;
    final goldColor = AppColors.medalGold;

    return Container(
      decoration: BoxDecoration(
        color: colors.surface,
        borderRadius: const BorderRadius.vertical(top: Radius.circular(20)),
      ),
      child: SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(20),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              // Handle bar
              Center(
                child: Container(
                  width: 40,
                  height: 4,
                  decoration: BoxDecoration(
                    color: colors.cardBorder,
                    borderRadius: BorderRadius.circular(2),
                  ),
                ),
              ),
              const SizedBox(height: 24),

              // Progress visual
              PursuitProgressVisual(
                progress: pursuit.progressPercent,
                emoji: pursuit.emoji,
                imageUrl: pursuit.imageUrl,
                size: 80,
                fillColor: pursuit.isCompleted ? goldColor : colors.success,
              ),
              const SizedBox(height: 16),

              // Name
              Text(
                pursuit.name,
                style: TextStyle(
                  fontSize: 20,
                  fontWeight: FontWeight.w600,
                  color: colors.textPrimary,
                ),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 8),

              // Progress text
              Text(
                '${formatAmount(pursuit.savedAmount)} / ${formatAmount(pursuit.targetAmount)}',
                style: TextStyle(fontSize: 16, color: colors.textSecondary),
              ),
              const SizedBox(height: 4),

              // Progress percentage
              Text(
                l10n.pursuitProgress(pursuit.progressPercentDisplay),
                style: TextStyle(
                  fontSize: 12,
                  color: pursuit.isCompleted ? goldColor : colors.success,
                ),
              ),
              const SizedBox(height: 24),

              // Progress bar
              PursuitLinearProgress(
                progress: pursuit.progressPercent,
                height: 8,
                progressColor: pursuit.isCompleted ? goldColor : colors.success,
              ),
              const SizedBox(height: 24),

              // Action buttons
              Row(
                children: [
                  if (onAddSavings != null) ...[
                    Expanded(
                      child: ElevatedButton.icon(
                        onPressed: onAddSavings,
                        style: ElevatedButton.styleFrom(
                          backgroundColor: colors.success,
                          foregroundColor: context.appColors.textPrimary,
                          padding: const EdgeInsets.symmetric(vertical: 12),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(16),
                          ),
                        ),
                        icon: Icon(CupertinoIcons.add, size: 18),
                        label: Text(l10n.addSavings),
                      ),
                    ),
                    const SizedBox(width: 12),
                  ],
                  // Edit button
                  IconButton(
                    onPressed: onEdit,
                    tooltip: l10n.edit,
                    style: IconButton.styleFrom(
                      backgroundColor: colors.surfaceLight,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(16),
                        side: BorderSide(color: colors.cardBorder),
                      ),
                    ),
                    icon: Icon(
                      CupertinoIcons.pencil,
                      color: colors.textSecondary,
                    ),
                  ),
                  const SizedBox(width: 8),
                  // Delete button
                  IconButton(
                    onPressed: onDelete,
                    tooltip: l10n.delete,
                    style: IconButton.styleFrom(
                      backgroundColor: colors.error.withValues(alpha: 0.1),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(16),
                        side: BorderSide(
                          color: colors.error.withValues(alpha: 0.3),
                        ),
                      ),
                    ),
                    icon: Icon(CupertinoIcons.trash, color: colors.error),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }
}


--- FILE: lib/screens/onboarding_v2_screen.dart ---

import 'dart:ui';
import 'package:confetti/confetti.dart';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';
import '../providers/providers.dart';
import '../services/services.dart';
import '../theme/theme.dart';
import '../utils/currency_utils.dart';
import 'screens.dart';

/// New 3-step onboarding flow
/// Step 1: Value Demo (show value before signup)
/// Step 2: Setup (income + hours + days in single screen)
/// Step 3: First Action (first expense with Aha Moment)
class OnboardingV2Screen extends StatefulWidget {
  const OnboardingV2Screen({super.key});

  @override
  State<OnboardingV2Screen> createState() => _OnboardingV2ScreenState();
}

class _OnboardingV2ScreenState extends State<OnboardingV2Screen>
    with TickerProviderStateMixin {
  final PageController _pageController = PageController();
  int _currentStep = 0;

  // Step 2: Setup data
  final _incomeController = TextEditingController();
  double _dailyHours = 8;
  int _workDaysPerWeek = 5;

  // Step 3: First expense data
  final _expenseAmountController = TextEditingController();
  final _expenseDescController = TextEditingController();
  bool _showResult = false;
  double _hoursRequired = 0;
  int _minutesRequired = 0;

  // Animations
  late AnimationController _pulseController;
  late Animation<double> _pulseAnimation;
  late ConfettiController _confettiController;

  // Demo animation for step 1
  late AnimationController _demoAnimController;
  late Animation<double> _demoCountAnimation;

  // Analytics tracking
  final DateTime _startTime = DateTime.now();
  DateTime? _stepStartTime;
  static const _stepNames = ['value_demo', 'setup', 'first_action'];

  @override
  void initState() {
    super.initState();
    _initAnimations();
    _trackOnboardingStarted();
  }

  void _trackOnboardingStarted() {
    _stepStartTime = DateTime.now();
    AnalyticsService().logOnboardingV2Started();
    AnalyticsService().logOnboardingV2StepViewed(step: 0, stepName: _stepNames[0]);
  }

  void _initAnimations() {
    // Pulse animation for result
    _pulseController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 1000),
    );
    _pulseAnimation = Tween<double>(begin: 1.0, end: 1.05).animate(
      CurvedAnimation(parent: _pulseController, curve: Curves.easeInOut),
    );

    // Confetti
    _confettiController = ConfettiController(
      duration: const Duration(seconds: 2),
    );

    // Demo counter animation
    _demoAnimController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 2000),
    );
    _demoCountAnimation = Tween<double>(begin: 0, end: 20).animate(
      CurvedAnimation(parent: _demoAnimController, curve: Curves.easeOutCubic),
    );

    // Start demo animation after delay
    Future.delayed(const Duration(milliseconds: 500), () {
      if (mounted) _demoAnimController.forward();
    });
  }

  @override
  void dispose() {
    _pageController.dispose();
    _incomeController.dispose();
    _expenseAmountController.dispose();
    _expenseDescController.dispose();
    _pulseController.dispose();
    _confettiController.dispose();
    _demoAnimController.dispose();
    super.dispose();
  }

  void _nextStep() {
    if (_currentStep < 2) {
      HapticFeedback.lightImpact();
      _pageController.nextPage(
        duration: const Duration(milliseconds: 400),
        curve: Curves.easeOutCubic,
      );
    }
  }

  void _onPageChanged(int page) {
    // Track previous step completion
    if (_stepStartTime != null && _currentStep < _stepNames.length) {
      final timeSpent = DateTime.now().difference(_stepStartTime!).inSeconds;
      AnalyticsService().logOnboardingV2StepCompleted(
        step: _currentStep,
        stepName: _stepNames[_currentStep],
        timeSpentSeconds: timeSpent,
      );
    }

    setState(() {
      _currentStep = page;
    });

    // Track new step viewed
    _stepStartTime = DateTime.now();
    if (page < _stepNames.length) {
      AnalyticsService().logOnboardingV2StepViewed(step: page, stepName: _stepNames[page]);
    }
  }

  Future<void> _completeSetup() async {
    // Validate income
    final income = parseTurkishCurrency(_incomeController.text);
    if (income == null || income <= 0) {
      _showError('Lütfen gelirinizi girin');
      return;
    }

    HapticFeedback.mediumImpact();

    // Create profile with income source
    final profile = UserProfile(
      dailyHours: _dailyHours,
      workDaysPerWeek: _workDaysPerWeek,
      incomeSources: [
        IncomeSource.salary(
          amount: income,
          title: 'Ana Gelir',
        ),
      ],
    );

    // Save profile
    final financeProvider = context.read<FinanceProvider>();
    financeProvider.setUserProfile(profile);
    await ProfileService().saveProfile(profile);

    // Track profile setup
    AnalyticsService().logOnboardingProfileSetup(
      monthlyIncome: income,
      workingHours: _dailyHours.toInt(),
      workingDays: _workDaysPerWeek,
    );

    // Go to step 3
    _nextStep();
  }

  void _calculateFirstExpense() {
    final amount = parseTurkishCurrency(_expenseAmountController.text);
    if (amount == null || amount <= 0) return;

    HapticFeedback.mediumImpact();

    final financeProvider = context.read<FinanceProvider>();
    final profile = financeProvider.userProfile;

    if (profile == null) return;

    final calculationService = CalculationService();
    final now = DateTime.now();
    final result = calculationService.calculateExpense(
      userProfile: profile,
      expenseAmount: amount,
      month: now.month,
      year: now.year,
    );

    setState(() {
      _hoursRequired = result.hoursRequired;
      _minutesRequired = ((result.hoursRequired % 1) * 60).round();
      _showResult = true;
    });

    // Track Aha Moment
    AnalyticsService().logOnboardingAhaMoment(
      amount: amount,
      hoursRequired: result.hoursRequired,
    );

    _pulseController.repeat(reverse: true);
  }

  Future<void> _saveFirstExpenseAndComplete() async {
    HapticFeedback.heavyImpact();
    _confettiController.play();

    final amount = parseTurkishCurrency(_expenseAmountController.text);
    if (amount == null || amount <= 0) return;

    // Save expense with calculated hours
    final financeProvider = context.read<FinanceProvider>();
    final expense = Expense(
      amount: amount,
      category: _expenseDescController.text.isEmpty
          ? 'Diğer'
          : _expenseDescController.text,
      date: DateTime.now(),
      hoursRequired: _hoursRequired,
      daysRequired: _hoursRequired / (_dailyHours > 0 ? _dailyHours : 8),
      decision: ExpenseDecision.yes,
    );

    await financeProvider.addExpense(expense);

    // Mark onboarding completed
    await ProfileService().setOnboardingCompleted();

    // Track analytics
    final totalTime = DateTime.now().difference(_startTime).inSeconds;
    AnalyticsService().logExpenseAdded(category: 'onboarding', method: 'manual');
    AnalyticsService().logOnboardingV2Completed(
      totalTimeSeconds: totalTime,
      addedFirstExpense: true,
    );
    AnalyticsService().logFirstExpense();
    AnalyticsService().logActivationEvent(eventType: 'first_expense', daysSinceInstall: 0);

    // Wait for confetti, then navigate
    await Future.delayed(const Duration(milliseconds: 1500));

    if (!mounted) return;

    Navigator.pushReplacement(
      context,
      PageRouteBuilder(
        pageBuilder: (context, animation, secondaryAnimation) =>
            const MainScreen(),
        transitionsBuilder: (context, animation, secondaryAnimation, child) {
          return FadeTransition(opacity: animation, child: child);
        },
        transitionDuration: const Duration(milliseconds: 400),
      ),
    );
  }

  void _skipToMain() async {
    HapticFeedback.lightImpact();

    // If on step 2 or later, still need to create a default profile
    if (_currentStep >= 1) {
      final profile = UserProfile(
        dailyHours: 8,
        workDaysPerWeek: 5,
        incomeSources: [
          IncomeSource.salary(
            amount: 30000, // Default
            title: 'Ana Gelir',
          ),
        ],
      );
      final financeProvider = context.read<FinanceProvider>();
      financeProvider.setUserProfile(profile);
      await ProfileService().saveProfile(profile);
    }

    await ProfileService().setOnboardingCompleted();

    // Track skip event
    AnalyticsService().logOnboardingV2Skipped(
      lastStepViewed: _currentStep,
      skipReason: 'skip_button',
    );

    if (!mounted) return;

    Navigator.pushReplacement(
      context,
      PageRouteBuilder(
        pageBuilder: (context, animation, secondaryAnimation) =>
            const MainScreen(),
        transitionsBuilder: (context, animation, secondaryAnimation, child) {
          return FadeTransition(opacity: animation, child: child);
        },
        transitionDuration: const Duration(milliseconds: 400),
      ),
    );
  }

  void _showError(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: context.appColors.error,
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return Scaffold(
      backgroundColor: context.appColors.background,
      body: Stack(
        children: [
          SafeArea(
            child: Column(
              children: [
                // Progress indicator
                _buildProgressIndicator(),

                // Skip button (not on step 1)
                if (_currentStep > 0)
                  Align(
                    alignment: Alignment.centerRight,
                    child: Padding(
                      padding: const EdgeInsets.only(right: 16),
                      child: TextButton(
                        onPressed: _skipToMain,
                        child: Text(
                          l10n.onboardingV2SkipSetup,
                          style: TextStyle(
                            color: context.appColors.textTertiary,
                            fontSize: 14,
                          ),
                        ),
                      ),
                    ),
                  ),

                // Page content
                Expanded(
                  child: PageView(
                    controller: _pageController,
                    onPageChanged: _onPageChanged,
                    physics: const NeverScrollableScrollPhysics(),
                    children: [
                      _buildStep1ValueDemo(l10n),
                      _buildStep2Setup(l10n),
                      _buildStep3FirstAction(l10n),
                    ],
                  ),
                ),
              ],
            ),
          ),

          // Confetti overlay
          Align(
            alignment: Alignment.topCenter,
            child: ConfettiWidget(
              confettiController: _confettiController,
              blastDirectionality: BlastDirectionality.explosive,
              particleDrag: 0.05,
              emissionFrequency: 0.05,
              numberOfParticles: 30,
              gravity: 0.1,
              colors: [
                context.appColors.primary,
                context.appColors.accent,
                context.appColors.success,
                context.appColors.warning,
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildProgressIndicator() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
      child: Row(
        children: List.generate(3, (index) {
          final isActive = index <= _currentStep;
          final isCurrent = index == _currentStep;
          return Expanded(
            child: Container(
              margin: EdgeInsets.only(right: index < 2 ? 8 : 0),
              height: 4,
              decoration: BoxDecoration(
                color: isActive
                    ? context.appColors.primary
                    : context.appColors.surfaceLight,
                borderRadius: BorderRadius.circular(2),
                boxShadow: isCurrent
                    ? [
                        BoxShadow(
                          color: context.appColors.primary.withValues(alpha: 0.5),
                          blurRadius: 8,
                        ),
                      ]
                    : null,
              ),
            ),
          );
        }),
      ),
    );
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // STEP 1: VALUE DEMO
  // ═══════════════════════════════════════════════════════════════════════════

  Widget _buildStep1ValueDemo(AppLocalizations l10n) {
    final currencyProvider = context.watch<CurrencyProvider>();

    return Padding(
      padding: const EdgeInsets.all(24),
      child: Column(
        children: [
          const Spacer(flex: 2),

          // Animated demo card
          AnimatedBuilder(
            animation: _demoCountAnimation,
            builder: (context, child) {
              final hours = _demoCountAnimation.value.toInt();
              return _buildDemoCard(currencyProvider, hours, l10n);
            },
          ),

          const SizedBox(height: 48),

          // Title (max 5 words)
          Text(
            l10n.onboardingV2Step1Title,
            textAlign: TextAlign.center,
            style: TextStyle(
              fontSize: 28,
              fontWeight: FontWeight.w700,
              color: context.appColors.textPrimary,
              letterSpacing: -0.5,
            ),
          ),
          const SizedBox(height: 12),

          // Subtitle (1 line)
          Text(
            l10n.onboardingV2Step1Subtitle,
            textAlign: TextAlign.center,
            style: TextStyle(
              fontSize: 16,
              color: context.appColors.textSecondary,
            ),
          ),

          const Spacer(flex: 3),

          // CTA Button (2 words max)
          SizedBox(
            width: double.infinity,
            height: 56,
            child: ElevatedButton(
              onPressed: _nextStep,
              style: ElevatedButton.styleFrom(
                backgroundColor: context.appColors.primary,
                foregroundColor: context.appColors.background,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(16),
                ),
                elevation: 0,
              ),
              child: Text(
                l10n.onboardingV2Step1Cta,
                style: const TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.w600,
                ),
              ),
            ),
          ),

          const SizedBox(height: 32),
        ],
      ),
    );
  }

  Widget _buildDemoCard(
    CurrencyProvider currencyProvider,
    int hours,
    AppLocalizations l10n,
  ) {
    return ClipRRect(
      borderRadius: BorderRadius.circular(24),
      child: BackdropFilter(
        filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
        child: Container(
          padding: const EdgeInsets.all(32),
          decoration: BoxDecoration(
            gradient: LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: [
                context.appColors.primary.withValues(alpha: 0.15),
                context.appColors.accent.withValues(alpha: 0.1),
              ],
            ),
            borderRadius: BorderRadius.circular(24),
            border: Border.all(
              color: context.appColors.primary.withValues(alpha: 0.3),
              width: 1.5,
            ),
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              // Phone icon
              Container(
                width: 64,
                height: 64,
                decoration: BoxDecoration(
                  color: context.appColors.surface,
                  borderRadius: BorderRadius.circular(16),
                ),
                child: Icon(
                  CupertinoIcons.device_phone_portrait,
                  size: 32,
                  color: context.appColors.primary,
                ),
              ),
              const SizedBox(height: 20),

              // Amount
              Text(
                currencyProvider.format(5000),
                style: TextStyle(
                  fontSize: 36,
                  fontWeight: FontWeight.w700,
                  color: context.appColors.textPrimary,
                ),
              ),
              const SizedBox(height: 8),

              // Equals sign
              Text(
                '=',
                style: TextStyle(
                  fontSize: 24,
                  color: context.appColors.textTertiary,
                ),
              ),
              const SizedBox(height: 8),

              // Hours with animation
              Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(
                    CupertinoIcons.clock,
                    size: 28,
                    color: context.appColors.warning,
                  ),
                  const SizedBox(width: 8),
                  Text(
                    '$hours ${l10n.hourAbbreviation}',
                    style: TextStyle(
                      fontSize: 32,
                      fontWeight: FontWeight.w700,
                      color: context.appColors.warning,
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 4),
              Text(
                'çalışman',
                style: TextStyle(
                  fontSize: 14,
                  color: context.appColors.textSecondary,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // STEP 2: SETUP
  // ═══════════════════════════════════════════════════════════════════════════

  Widget _buildStep2Setup(AppLocalizations l10n) {
    final currencyProvider = context.watch<CurrencyProvider>();

    return SingleChildScrollView(
      padding: const EdgeInsets.all(24),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.stretch,
        children: [
          const SizedBox(height: 24),

          // Title
          Text(
            l10n.onboardingV2Step2Title,
            textAlign: TextAlign.center,
            style: TextStyle(
              fontSize: 28,
              fontWeight: FontWeight.w700,
              color: context.appColors.textPrimary,
            ),
          ),

          const SizedBox(height: 48),

          // Input 1: Monthly income
          _buildInputCard(
            label: l10n.onboardingV2Step2Income,
            child: TextField(
              controller: _incomeController,
              keyboardType: const TextInputType.numberWithOptions(decimal: true),
              style: TextStyle(
                fontSize: 28,
                fontWeight: FontWeight.w600,
                color: context.appColors.textPrimary,
              ),
              decoration: InputDecoration(
                hintText: '25.000',
                hintStyle: TextStyle(
                  fontSize: 28,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textTertiary,
                ),
                prefixText: '${currencyProvider.symbol} ',
                prefixStyle: TextStyle(
                  fontSize: 28,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textPrimary,
                ),
                border: InputBorder.none,
              ),
              inputFormatters: [
                FilteringTextInputFormatter.allow(RegExp(r'[\d.,]')),
              ],
            ),
          ),

          const SizedBox(height: 20),

          // Input 2: Daily hours (Slider)
          _buildInputCard(
            label: l10n.onboardingV2Step2Hours,
            child: Column(
              children: [
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Text(
                      '${_dailyHours.toInt()} saat',
                      style: TextStyle(
                        fontSize: 28,
                        fontWeight: FontWeight.w600,
                        color: context.appColors.textPrimary,
                      ),
                    ),
                    Text(
                      '1-12',
                      style: TextStyle(
                        fontSize: 14,
                        color: context.appColors.textTertiary,
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 8),
                SliderTheme(
                  data: SliderTheme.of(context).copyWith(
                    activeTrackColor: context.appColors.primary,
                    inactiveTrackColor: context.appColors.surfaceLight,
                    thumbColor: context.appColors.primary,
                    overlayColor: context.appColors.primary.withValues(alpha: 0.2),
                    trackHeight: 6,
                  ),
                  child: Slider(
                    value: _dailyHours,
                    min: 1,
                    max: 12,
                    divisions: 11,
                    onChanged: (value) {
                      HapticFeedback.selectionClick();
                      setState(() {
                        _dailyHours = value;
                      });
                    },
                  ),
                ),
              ],
            ),
          ),

          const SizedBox(height: 20),

          // Input 3: Work days per week (SegmentedControl)
          _buildInputCard(
            label: l10n.onboardingV2Step2Days,
            child: Row(
              children: [5, 6, 7].map((days) {
                final isSelected = _workDaysPerWeek == days;
                return Expanded(
                  child: GestureDetector(
                    onTap: () {
                      HapticFeedback.selectionClick();
                      setState(() {
                        _workDaysPerWeek = days;
                      });
                    },
                    child: AnimatedContainer(
                      duration: const Duration(milliseconds: 200),
                      margin: EdgeInsets.only(right: days < 7 ? 8 : 0),
                      padding: const EdgeInsets.symmetric(vertical: 16),
                      decoration: BoxDecoration(
                        color: isSelected
                            ? context.appColors.primary
                            : context.appColors.surfaceLight,
                        borderRadius: BorderRadius.circular(16),
                        border: Border.all(
                          color: isSelected
                              ? context.appColors.primary
                              : context.appColors.cardBorder,
                        ),
                      ),
                      child: Text(
                        '$days',
                        textAlign: TextAlign.center,
                        style: TextStyle(
                          fontSize: 20,
                          fontWeight: FontWeight.w600,
                          color: isSelected
                              ? context.appColors.background
                              : context.appColors.textPrimary,
                        ),
                      ),
                    ),
                  ),
                );
              }).toList(),
            ),
          ),

          const SizedBox(height: 48),

          // CTA Button
          SizedBox(
            width: double.infinity,
            height: 56,
            child: ElevatedButton(
              onPressed: _completeSetup,
              style: ElevatedButton.styleFrom(
                backgroundColor: context.appColors.primary,
                foregroundColor: context.appColors.background,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(16),
                ),
                elevation: 0,
              ),
              child: Text(
                l10n.onboardingV2Step2Cta,
                style: const TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.w600,
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildInputCard({required String label, required Widget child}) {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: context.appColors.cardBorder),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            label,
            style: TextStyle(
              fontSize: 14,
              fontWeight: FontWeight.w600,
              color: context.appColors.textSecondary,
            ),
          ),
          const SizedBox(height: 12),
          child,
        ],
      ),
    );
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // STEP 3: FIRST ACTION (Aha Moment)
  // ═══════════════════════════════════════════════════════════════════════════

  Widget _buildStep3FirstAction(AppLocalizations l10n) {
    final currencyProvider = context.watch<CurrencyProvider>();

    return AnimatedSwitcher(
      duration: const Duration(milliseconds: 400),
      child: _showResult
          ? _buildStep3Result(l10n, currencyProvider)
          : _buildStep3Input(l10n, currencyProvider),
    );
  }

  Widget _buildStep3Input(AppLocalizations l10n, CurrencyProvider currencyProvider) {
    return SingleChildScrollView(
      key: const ValueKey('input'),
      padding: const EdgeInsets.all(24),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.stretch,
        children: [
          const SizedBox(height: 24),

          // Icon
          Container(
            width: 80,
            height: 80,
            margin: const EdgeInsets.only(bottom: 24),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [
                  context.appColors.primary,
                  context.appColors.accent,
                ],
              ),
              shape: BoxShape.circle,
            ),
            child: Icon(
              CupertinoIcons.doc_text,
              size: 40,
              color: context.appColors.textPrimary,
            ),
          ),

          // Title
          Text(
            l10n.onboardingV2Step3Title,
            textAlign: TextAlign.center,
            style: TextStyle(
              fontSize: 28,
              fontWeight: FontWeight.w700,
              color: context.appColors.textPrimary,
            ),
          ),
          const SizedBox(height: 8),

          // Subtitle
          Text(
            l10n.onboardingV2Step3Subtitle,
            textAlign: TextAlign.center,
            style: TextStyle(
              fontSize: 16,
              color: context.appColors.textSecondary,
            ),
          ),

          const SizedBox(height: 48),

          // Amount input
          _buildInputCard(
            label: l10n.amount,
            child: TextField(
              controller: _expenseAmountController,
              keyboardType: const TextInputType.numberWithOptions(decimal: true),
              autofocus: true,
              style: TextStyle(
                fontSize: 32,
                fontWeight: FontWeight.w600,
                color: context.appColors.textPrimary,
              ),
              decoration: InputDecoration(
                hintText: '150',
                hintStyle: TextStyle(
                  fontSize: 32,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textTertiary,
                ),
                prefixText: '${currencyProvider.symbol} ',
                prefixStyle: TextStyle(
                  fontSize: 32,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textPrimary,
                ),
                border: InputBorder.none,
              ),
              inputFormatters: [
                FilteringTextInputFormatter.allow(RegExp(r'[\d.,]')),
              ],
              onSubmitted: (_) => _calculateFirstExpense(),
            ),
          ),

          const SizedBox(height: 16),

          // Description input (optional)
          _buildInputCard(
            label: l10n.description,
            child: TextField(
              controller: _expenseDescController,
              style: TextStyle(
                fontSize: 18,
                color: context.appColors.textPrimary,
              ),
              decoration: InputDecoration(
                hintText: 'Kahve, yemek, market...',
                hintStyle: TextStyle(
                  fontSize: 18,
                  color: context.appColors.textTertiary,
                ),
                border: InputBorder.none,
              ),
            ),
          ),

          const SizedBox(height: 48),

          // Calculate button
          SizedBox(
            width: double.infinity,
            height: 56,
            child: ElevatedButton(
              onPressed: _calculateFirstExpense,
              style: ElevatedButton.styleFrom(
                backgroundColor: context.appColors.primary,
                foregroundColor: context.appColors.background,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(16),
                ),
                elevation: 0,
              ),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  const Icon(CupertinoIcons.plus_slash_minus, size: 24),
                  const SizedBox(width: 8),
                  Text(
                    l10n.onboardingV2Step1Cta,
                    style: const TextStyle(
                      fontSize: 18,
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildStep3Result(AppLocalizations l10n, CurrencyProvider currencyProvider) {
    final amount = parseTurkishCurrency(_expenseAmountController.text) ?? 0;

    return Padding(
      key: const ValueKey('result'),
      padding: const EdgeInsets.all(24),
      child: Column(
        children: [
          const Spacer(),

          // Result card with pulse animation
          AnimatedBuilder(
            animation: _pulseAnimation,
            builder: (context, child) {
              return Transform.scale(
                scale: _pulseAnimation.value,
                child: child,
              );
            },
            child: ClipRRect(
              borderRadius: BorderRadius.circular(24),
              child: BackdropFilter(
                filter: ImageFilter.blur(sigmaX: 15, sigmaY: 15),
                child: Container(
                  padding: const EdgeInsets.all(32),
                  decoration: BoxDecoration(
                    gradient: LinearGradient(
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                      colors: [
                        context.appColors.success.withValues(alpha: 0.2),
                        context.appColors.primary.withValues(alpha: 0.1),
                      ],
                    ),
                    borderRadius: BorderRadius.circular(24),
                    border: Border.all(
                      color: context.appColors.success.withValues(alpha: 0.4),
                      width: 2,
                    ),
                  ),
                  child: Column(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      // Amount entered
                      Text(
                        currencyProvider.format(amount),
                        style: TextStyle(
                          fontSize: 32,
                          fontWeight: FontWeight.w700,
                          color: context.appColors.textPrimary,
                        ),
                      ),
                      const SizedBox(height: 16),

                      // Result
                      Container(
                        padding: const EdgeInsets.symmetric(
                          horizontal: 20,
                          vertical: 12,
                        ),
                        decoration: BoxDecoration(
                          color: context.appColors.warning.withValues(alpha: 0.2),
                          borderRadius: BorderRadius.circular(16),
                        ),
                        child: Row(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            Icon(
                              CupertinoIcons.clock,
                              size: 28,
                              color: context.appColors.warning,
                            ),
                            const SizedBox(width: 8),
                            Text(
                              l10n.onboardingV2Step3Result(
                                _hoursRequired.toInt(),
                                _minutesRequired,
                              ),
                              style: TextStyle(
                                fontSize: 24,
                                fontWeight: FontWeight.w700,
                                color: context.appColors.warning,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ),
          ),

          const SizedBox(height: 32),

          // Success message
          Container(
            padding: const EdgeInsets.all(20),
            decoration: BoxDecoration(
              color: context.appColors.surface,
              borderRadius: BorderRadius.circular(16),
              border: Border.all(color: context.appColors.cardBorder),
            ),
            child: Row(
              children: [
                Container(
                  width: 48,
                  height: 48,
                  decoration: BoxDecoration(
                    color: context.appColors.success.withValues(alpha: 0.15),
                    borderRadius: BorderRadius.circular(16),
                  ),
                  child: Icon(
                    CupertinoIcons.checkmark_circle,
                    size: 24,
                    color: context.appColors.success,
                  ),
                ),
                const SizedBox(width: 16),
                Expanded(
                  child: Text(
                    l10n.onboardingV2Step3Success,
                    style: TextStyle(
                      fontSize: 15,
                      fontWeight: FontWeight.w500,
                      color: context.appColors.textPrimary,
                      height: 1.4,
                    ),
                  ),
                ),
              ],
            ),
          ),

          const Spacer(),

          // CTA Button
          SizedBox(
            width: double.infinity,
            height: 56,
            child: ElevatedButton(
              onPressed: _saveFirstExpenseAndComplete,
              style: ElevatedButton.styleFrom(
                backgroundColor: context.appColors.success,
                foregroundColor: Colors.white,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(16),
                ),
                elevation: 0,
              ),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Text(
                    l10n.onboardingV2Step3Cta,
                    style: const TextStyle(
                      fontSize: 18,
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                  const SizedBox(width: 8),
                  const Icon(CupertinoIcons.arrow_right, size: 24),
                ],
              ),
            ),
          ),

          const SizedBox(height: 32),
        ],
      ),
    );
  }
}


--- FILE: lib/screens/achievements_screen.dart ---

import 'dart:math';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:vantag/l10n/app_localizations.dart';
import 'package:provider/provider.dart';
import '../models/models.dart';
import '../theme/theme.dart' hide GlassCard;
import '../providers/providers.dart';
import '../utils/achievement_utils.dart';
import '../core/theme/premium_effects.dart';

class AchievementsScreen extends StatefulWidget {
  const AchievementsScreen({super.key});

  @override
  State<AchievementsScreen> createState() => _AchievementsScreenState();
}

class _AchievementsScreenState extends State<AchievementsScreen>
    with TickerProviderStateMixin {
  final Set<String> _celebratedIds = {};

  // Animation controllers
  final Map<String, AnimationController> _pulseControllers = {};

  // Confetti controller
  AnimationController? _confettiController;
  List<_ConfettiParticle> _confettiParticles = [];

  @override
  void initState() {
    super.initState();
    // Check for new achievements after initial load
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _checkNewAchievements();
    });
  }

  @override
  void dispose() {
    for (final controller in _pulseControllers.values) {
      controller.dispose();
    }
    _confettiController?.dispose();
    super.dispose();
  }

  Future<void> _checkNewAchievements() async {
    final financeProvider = context.read<FinanceProvider>();
    await financeProvider.refreshAchievements(context);
    if (!mounted) return;
    final achievements = financeProvider.achievements;

    // Start animation for newly unlocked achievements
    final newlyUnlocked = achievements
        .where((a) => a.isNewlyUnlocked && !_celebratedIds.contains(a.id))
        .toList();

    if (newlyUnlocked.isNotEmpty) {
      _startConfettiAnimation();
      for (final achievement in newlyUnlocked) {
        _startCelebrationAnimation(achievement.id);
        _celebratedIds.add(achievement.id);
      }
    }
  }

  void _startConfettiAnimation() {
    _confettiController?.dispose();
    _confettiController = AnimationController(
      duration: const Duration(milliseconds: 2500),
      vsync: this,
    );

    // Create confetti particles
    final random = Random();
    _confettiParticles = List.generate(50, (index) {
      return _ConfettiParticle(
        x: random.nextDouble(),
        y: -random.nextDouble() * 0.3,
        color: [
          Colors.red,
          Colors.blue,
          Colors.green,
          Colors.yellow,
          Colors.purple,
          Colors.orange,
          Colors.pink,
        ][random.nextInt(7)],
        size: 8 + random.nextDouble() * 8,
        rotation: random.nextDouble() * 360,
        velocityX: (random.nextDouble() - 0.5) * 2,
        velocityY: 2 + random.nextDouble() * 3,
      );
    });

    _confettiController!.forward().then((_) {
      if (mounted) {
        setState(() {
          _confettiParticles = [];
        });
        _confettiController?.dispose();
        _confettiController = null;
      }
    });

    _confettiController!.addListener(() {
      if (mounted) setState(() {});
    });
  }

  void _startCelebrationAnimation(String achievementId) {
    final controller = AnimationController(
      duration: const Duration(milliseconds: 1500),
      vsync: this,
    );

    _pulseControllers[achievementId] = controller;

    controller.forward().then((_) {
      if (mounted) {
        controller.dispose();
        _pulseControllers.remove(achievementId);
        setState(() {});
      }
    });
  }

  @override
  Widget build(BuildContext context) {
    // Get data reactively from Provider
    final financeProvider = context.watch<FinanceProvider>();
    final achievements = financeProvider.achievements;
    final isLoading = financeProvider.isLoading;

    if (isLoading) {
      return Scaffold(
        backgroundColor: context.appColors.background,
        body: Center(
          child: CircularProgressIndicator(color: context.appColors.primary),
        ),
      );
    }

    // Group by category (excluding hidden)
    final visibleAchievements = achievements.where((a) => !a.isHidden).toList();
    final hiddenAchievements = achievements.where((a) => a.isHidden).toList();

    final unlockedCount = achievements.where((a) => a.isUnlocked).length;
    final totalCount = achievements.length;
    final overallProgress = totalCount > 0 ? unlockedCount / totalCount : 0.0;

    final groupedAchievements = <AchievementCategory, List<Achievement>>{};
    for (final achievement in visibleAchievements) {
      groupedAchievements.putIfAbsent(achievement.category, () => []);
      groupedAchievements[achievement.category]!.add(achievement);
    }

    // Sort each category by tier
    for (final category in groupedAchievements.keys) {
      groupedAchievements[category]!.sort(
        (a, b) => a.sortKey.compareTo(b.sortKey),
      );
    }

    return Scaffold(
      backgroundColor: context.appColors.background,
      body: Stack(
        children: [
          SafeArea(
            child: CustomScrollView(
              slivers: [
                // Header
                SliverToBoxAdapter(
                  child: Padding(
                    padding: const EdgeInsets.fromLTRB(20, 16, 20, 0),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          AppLocalizations.of(context).badges,
                          style: TextStyle(
                            fontSize: 28,
                            fontWeight: FontWeight.w700,
                            color: context.appColors.textPrimary,
                          ),
                        ),
                        const SizedBox(height: 20),
                        _buildSummaryCard(
                          unlockedCount,
                          totalCount,
                          overallProgress,
                        ),
                      ],
                    ),
                  ),
                ),

                const SliverToBoxAdapter(child: SizedBox(height: 24)),

                // Categories and badges
                for (final category in [
                  AchievementCategory.streak,
                  AchievementCategory.savings,
                  AchievementCategory.decision,
                  AchievementCategory.record,
                ]) ...[
                  if (groupedAchievements.containsKey(category)) ...[
                    SliverToBoxAdapter(
                      child: Padding(
                        padding: const EdgeInsets.fromLTRB(20, 0, 20, 12),
                        child: Row(
                          children: [
                            Icon(
                              category.icon,
                              size: 22,
                              color: category.iconColor,
                            ),
                            const SizedBox(width: 8),
                            Text(
                              AchievementUtils.getCategoryLabel(
                                context,
                                category,
                              ),
                              style: TextStyle(
                                fontSize: 18,
                                fontWeight: FontWeight.w600,
                                color: context.appColors.textPrimary,
                              ),
                            ),
                            const Spacer(),
                            Text(
                              '${groupedAchievements[category]!.where((a) => a.isUnlocked).length}/${groupedAchievements[category]!.length}',
                              style: TextStyle(
                                fontSize: 14,
                                color: context.appColors.textSecondary,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ),
                    SliverToBoxAdapter(
                      child: SizedBox(
                        height: 190,
                        child: ListView.builder(
                          scrollDirection: Axis.horizontal,
                          padding: const EdgeInsets.symmetric(horizontal: 16),
                          itemCount: groupedAchievements[category]!.length,
                          itemBuilder: (context, index) {
                            final achievement =
                                groupedAchievements[category]![index];
                            return Padding(
                              padding: const EdgeInsets.symmetric(
                                horizontal: 4,
                              ),
                              child: ScaleFadeIn(
                                index: index,
                                duration: const Duration(milliseconds: 400),
                                staggerDelay: const Duration(milliseconds: 80),
                                child: achievement.isUnlocked
                                    ? PulseGlow(
                                        glowColor: _getTierColor(
                                          achievement.tier,
                                        ),
                                        animate: achievement.isNewlyUnlocked,
                                        child: _buildAchievementCard(
                                          achievement,
                                        ),
                                      )
                                    : _buildAchievementCard(achievement),
                              ),
                            );
                          },
                        ),
                      ),
                    ),
                    const SliverToBoxAdapter(child: SizedBox(height: 20)),
                  ],
                ],

                // Hidden Badges
                if (hiddenAchievements.isNotEmpty) ...[
                  SliverToBoxAdapter(
                    child: Padding(
                      padding: const EdgeInsets.fromLTRB(20, 0, 20, 12),
                      child: Row(
                        children: [
                          Icon(
                            AchievementCategory.hidden.icon,
                            size: 22,
                            color: AchievementCategory.hidden.iconColor,
                          ),
                          const SizedBox(width: 8),
                          Text(
                            AppLocalizations.of(context).hiddenBadges,
                            style: TextStyle(
                              fontSize: 18,
                              fontWeight: FontWeight.w600,
                              color: context.appColors.textPrimary,
                            ),
                          ),
                          const Spacer(),
                          Text(
                            '${hiddenAchievements.where((a) => a.isUnlocked).length}/${hiddenAchievements.length}',
                            style: TextStyle(
                              fontSize: 14,
                              color: context.appColors.textSecondary,
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                  SliverToBoxAdapter(
                    child: SizedBox(
                      height: 190,
                      child: ListView.builder(
                        scrollDirection: Axis.horizontal,
                        padding: const EdgeInsets.symmetric(horizontal: 16),
                        itemCount: hiddenAchievements.length,
                        itemBuilder: (context, index) {
                          final achievement = hiddenAchievements[index];
                          return Padding(
                            padding: const EdgeInsets.symmetric(horizontal: 4),
                            child: ScaleFadeIn(
                              index: index,
                              duration: const Duration(milliseconds: 400),
                              staggerDelay: const Duration(milliseconds: 80),
                              child: achievement.isUnlocked
                                  ? PulseGlow(
                                      glowColor: context.appColors.gold,
                                      animate: achievement.isNewlyUnlocked,
                                      child: _buildHiddenAchievementCard(
                                        achievement,
                                      ),
                                    )
                                  : _buildHiddenAchievementCard(achievement),
                            ),
                          );
                        },
                      ),
                    ),
                  ),
                ],

                const SliverToBoxAdapter(child: SizedBox(height: 80)),
              ],
            ),
          ),

          // Confetti overlay
          if (_confettiController != null && _confettiParticles.isNotEmpty)
            Positioned.fill(
              child: IgnorePointer(
                child: CustomPaint(
                  painter: _ConfettiPainter(
                    particles: _confettiParticles,
                    progress: _confettiController!.value,
                  ),
                ),
              ),
            ),
        ],
      ),
    );
  }

  Widget _buildSummaryCard(int unlockedCount, int totalCount, double progress) {
    // Calculate XP and Level
    final totalXP = unlockedCount * 100; // Each badge = 100 XP
    final level = _calculateLevel(totalXP);
    final levelInfo = _getLevelInfo(level);
    final currentLevelXP = totalXP - _getXPForLevel(level);
    final nextLevelXP = _getXPForLevel(level + 1) - _getXPForLevel(level);
    final levelProgress = nextLevelXP > 0 ? currentLevelXP / nextLevelXP : 1.0;

    // Get streak from provider
    final financeProvider = context.read<FinanceProvider>();
    final streak = financeProvider.streakData.currentStreak;

    return Column(
      children: [
        // Stats Grid (3 cards)
        Row(
          children: [
            Expanded(
              child: _buildStatCard(
                icon: CupertinoIcons.star_fill,
                iconColor: AppColors.achievementYellow,
                value: '$totalXP',
                label: 'Total XP',
              ),
            ),
            const SizedBox(width: 10),
            Expanded(
              child: _buildStatCard(
                icon: CupertinoIcons.rosette,
                iconColor: PremiumColors.purple,
                value: '$unlockedCount/$totalCount',
                label: 'Rozetler',
              ),
            ),
            const SizedBox(width: 10),
            Expanded(
              child: _buildStatCard(
                icon: CupertinoIcons.flame_fill,
                iconColor: AppColors.achievementOrange,
                value: '$streak',
                label: 'Gün Seri',
              ),
            ),
          ],
        ),
        const SizedBox(height: 16),

        // Level Progress Card
        BreatheGlow(
          glowColor: PremiumColors.purple,
          blurRadius: 20,
          minOpacity: 0.2,
          maxOpacity: 0.4,
          child: GradientBorder(
            borderRadius: 20,
            borderWidth: 1.5,
            child: Container(
              padding: const EdgeInsets.all(20),
              decoration: BoxDecoration(
                color: PremiumColors.cardBackground,
                borderRadius: BorderRadius.circular(18.5),
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    children: [
                      // Level badge
                      Container(
                        width: 48,
                        height: 48,
                        decoration: BoxDecoration(
                          gradient: const LinearGradient(
                            colors: [
                              PremiumColors.purple,
                              PremiumColors.gradientEnd,
                            ],
                          ),
                          borderRadius: BorderRadius.circular(16),
                          boxShadow: PremiumShadows.glowPurpleSoft,
                        ),
                        child: Center(
                          child: Text(
                            '$level',
                            style: TextStyle(
                              fontSize: 20,
                              fontWeight: FontWeight.w700,
                              color: context.appColors.textPrimary,
                            ),
                          ),
                        ),
                      ),
                      const SizedBox(width: 14),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              'Level $level',
                              style: TextStyle(
                                fontSize: 18,
                                fontWeight: FontWeight.w700,
                                color: context.appColors.textPrimary,
                              ),
                            ),
                            Text(
                              levelInfo['title']!,
                              style: TextStyle(
                                fontSize: 13,
                                color: PremiumColors.purple,
                                fontWeight: FontWeight.w500,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 16),
                  // XP Progress
                  Text(
                    '$currentLevelXP / $nextLevelXP XP',
                    style: TextStyle(
                      fontSize: 12,
                      color: context.appColors.textSecondary,
                    ),
                  ),
                  const SizedBox(height: 8),
                  LevelProgressBar(
                    progress: levelProgress.clamp(0.0, 1.0),
                    height: 10,
                  ),
                  const SizedBox(height: 8),
                  Text(
                    'Level ${level + 1} için ${nextLevelXP - currentLevelXP} XP daha',
                    style: TextStyle(
                      fontSize: 11,
                      color: context.appColors.textTertiary,
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildStatCard({
    required IconData icon,
    required Color iconColor,
    required String value,
    required String label,
  }) {
    return GlassCard(
      borderRadius: 16,
      padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 12),
      boxShadow: PremiumShadows.coloredGlow(iconColor, intensity: 0.3),
      child: Column(
        children: [
          Icon(
            icon,
            size: 24,
            color: iconColor,
            shadows: PremiumShadows.iconHalo(iconColor),
          ),
          const SizedBox(height: 8),
          Text(
            value,
            style: TextStyle(
              fontSize: 18,
              fontWeight: FontWeight.w700,
              color: context.appColors.textPrimary,
            ),
          ),
          const SizedBox(height: 2),
          Text(
            label,
            style: TextStyle(
              fontSize: 11,
              color: context.appColors.textSecondary,
            ),
          ),
        ],
      ),
    );
  }

  int _calculateLevel(int xp) {
    // Level thresholds: 0, 200, 500, 1000, 2000, 3500, 5000...
    if (xp < 200) return 1;
    if (xp < 500) return 2;
    if (xp < 1000) return 3;
    if (xp < 2000) return 4;
    if (xp < 3500) return 5;
    if (xp < 5000) return 6;
    if (xp < 7000) return 7;
    if (xp < 10000) return 8;
    if (xp < 15000) return 9;
    return 10;
  }

  int _getXPForLevel(int level) {
    const thresholds = [
      0,
      0,
      200,
      500,
      1000,
      2000,
      3500,
      5000,
      7000,
      10000,
      15000,
    ];
    if (level < thresholds.length) return thresholds[level];
    return 15000;
  }

  Map<String, String> _getLevelInfo(int level) {
    const levels = {
      1: {'title': 'Novice Saver', 'emoji': '🌱'},
      2: {'title': 'Budget Beginner', 'emoji': '📊'},
      3: {'title': 'Money Tracker', 'emoji': '💰'},
      4: {'title': 'Savings Star', 'emoji': '⭐'},
      5: {'title': 'Finance Fighter', 'emoji': '🥊'},
      6: {'title': 'Budget Master', 'emoji': '🎯'},
      7: {'title': 'Wealth Builder', 'emoji': '🏗️'},
      8: {'title': 'Money Guru', 'emoji': '🧘'},
      9: {'title': 'Finance Legend', 'emoji': '🏆'},
      10: {'title': 'Ultimate Saver', 'emoji': '👑'},
    };
    return levels[level] ?? {'title': 'Unknown', 'emoji': '❓'};
  }

  Color _getTierColor(AchievementTier tier) {
    switch (tier) {
      case AchievementTier.bronze:
        return AppColors.medalBronze;
      case AchievementTier.silver:
        return AppColors.medalSilver;
      case AchievementTier.gold:
        return AppColors.medalGold;
      case AchievementTier.platinum:
        return AppColors.medalPlatinum;
    }
  }

  List<Color> _getPlatinumGradient() {
    return const [
      AppColors.medalPlatinum,
      AppColors.achievementSkyBlue,
      AppColors.achievementLavender,
      AppColors.medalPlatinum,
    ];
  }

  Widget _buildAchievementCard(Achievement achievement) {
    final isUnlocked = achievement.isUnlocked;
    final hasCelebration = _pulseControllers.containsKey(achievement.id);
    final tierColor = _getTierColor(achievement.tier);
    final isPlatinum = achievement.tier == AchievementTier.platinum;

    Widget card = Container(
      width: 145,
      padding: const EdgeInsets.all(14),
      decoration: BoxDecoration(
        color: isUnlocked
            ? context.appColors.surface
            : context.appColors.surface.withValues(alpha: 0.5),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: isUnlocked
              ? (isPlatinum
                    ? Colors.transparent
                    : tierColor.withValues(alpha: 0.5))
              : context.appColors.cardBorder,
          width: isUnlocked ? 2 : 1,
        ),
        gradient: isUnlocked && isPlatinum
            ? LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: _getPlatinumGradient()
                    .map((c) => c.withValues(alpha: 0.3))
                    .toList(),
              )
            : null,
        boxShadow: isUnlocked
            ? [
                BoxShadow(
                  color: tierColor.withValues(alpha: 0.2),
                  blurRadius: 12,
                  offset: const Offset(0, 4),
                ),
              ]
            : null,
      ),
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          // Badge icon
          Stack(
            alignment: Alignment.center,
            children: [
              Container(
                width: 56,
                height: 56,
                decoration: BoxDecoration(
                  color: isUnlocked
                      ? tierColor.withValues(alpha: 0.2)
                      : context.appColors.surfaceLight,
                  shape: BoxShape.circle,
                  border: Border.all(
                    color: isUnlocked
                        ? tierColor
                        : context.appColors.cardBorder,
                    width: 2,
                  ),
                  gradient: isUnlocked && isPlatinum
                      ? SweepGradient(colors: _getPlatinumGradient())
                      : null,
                ),
                child: Center(
                  child: isUnlocked
                      ? Icon(
                          achievement.category.icon,
                          size: 26,
                          color: achievement.category.iconColor,
                        )
                      : Icon(
                          CupertinoIcons.lock_fill,
                          size: 24,
                          color: context.appColors.textTertiary,
                        ),
                ),
              ),
              // Tier badge
              Positioned(
                bottom: 0,
                right: 0,
                child: Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 6,
                    vertical: 2,
                  ),
                  decoration: BoxDecoration(
                    color: isUnlocked
                        ? tierColor
                        : context.appColors.textTertiary,
                    borderRadius: BorderRadius.circular(8),
                    gradient: isUnlocked && isPlatinum
                        ? LinearGradient(colors: _getPlatinumGradient())
                        : null,
                  ),
                  child: Text(
                    AchievementUtils.getFullTierLabel(
                      context,
                      achievement.tier,
                      achievement.subTier,
                    ),
                    style: TextStyle(
                      fontSize: 9,
                      fontWeight: FontWeight.bold,
                      color: isUnlocked
                          ? context.appColors.background
                          : context.appColors.surface,
                    ),
                  ),
                ),
              ),
            ],
          ),
          const SizedBox(height: 10),
          // Title - improved contrast for dark mode
          Text(
            AchievementUtils.getTitle(context, achievement.id),
            textAlign: TextAlign.center,
            style: TextStyle(
              fontSize: 13,
              fontWeight: FontWeight.w600,
              color: isUnlocked
                  ? context.appColors.textPrimary
                  : Colors.white70, // Better contrast in dark mode
            ),
            maxLines: 1,
            overflow: TextOverflow.ellipsis,
          ),
          const SizedBox(height: 2),
          // Description - improved contrast for dark mode
          Text(
            AchievementUtils.getDescription(context, achievement.id),
            textAlign: TextAlign.center,
            style: TextStyle(
              fontSize: 10,
              color: isUnlocked
                  ? context.appColors.textPrimary.withValues(alpha: 0.8)
                  : Colors.white54, // Better contrast in dark mode
            ),
            maxLines: 2,
            overflow: TextOverflow.ellipsis,
          ),
          const SizedBox(height: 6),
          // Progress or date
          if (!isUnlocked) ...[
            ClipRRect(
              borderRadius: BorderRadius.circular(4),
              child: LinearProgressIndicator(
                value: achievement.progress,
                minHeight: 4,
                backgroundColor: context.appColors.surfaceLight,
                valueColor: AlwaysStoppedAnimation<Color>(tierColor),
              ),
            ),
            const SizedBox(height: 4),
            Text(
              _formatProgress(achievement),
              style: TextStyle(
                fontSize: 10,
                color: context.appColors.textTertiary,
              ),
            ),
          ] else ...[
            Text(
              _formatDate(context, achievement.unlockedAt!),
              style: TextStyle(
                fontSize: 10,
                color: tierColor,
                fontWeight: FontWeight.w500,
              ),
            ),
          ],
        ],
      ),
    );

    // Celebration animation
    if (hasCelebration) {
      final controller = _pulseControllers[achievement.id]!;
      return AnimatedBuilder(
        animation: controller,
        builder: (context, child) {
          final scale = 1.0 + (0.1 * (1 - controller.value));
          final glow = (1 - controller.value) * 0.5;
          return Transform.scale(
            scale: scale,
            child: Container(
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(16),
                boxShadow: [
                  BoxShadow(
                    color: tierColor.withValues(alpha: glow),
                    blurRadius: 20,
                    spreadRadius: 4,
                  ),
                ],
              ),
              child: card,
            ),
          );
        },
      );
    }

    return card;
  }

  Widget _buildHiddenAchievementCard(Achievement achievement) {
    final isUnlocked = achievement.isUnlocked;
    final hasCelebration = _pulseControllers.containsKey(achievement.id);
    final isPlatinum = achievement.tier == AchievementTier.platinum;

    // Difficulty color
    final l10n = AppLocalizations.of(context);
    Color difficultyColor;
    String difficultyLabel;
    switch (achievement.hiddenDifficulty) {
      case HiddenDifficulty.easy:
        difficultyColor = Colors.green;
        difficultyLabel = l10n.difficultyEasy;
        break;
      case HiddenDifficulty.medium:
        difficultyColor = Colors.orange;
        difficultyLabel = l10n.difficultyMedium;
        break;
      case HiddenDifficulty.hard:
        difficultyColor = Colors.red;
        difficultyLabel = l10n.difficultyHard;
        break;
      case HiddenDifficulty.legendary:
        difficultyColor = Colors.purple;
        difficultyLabel = l10n.difficultyLegendary;
        break;
      case null:
        difficultyColor = context.appColors.textTertiary;
        difficultyLabel = '';
    }

    Widget card = Container(
      width: 145,
      padding: const EdgeInsets.all(14),
      decoration: BoxDecoration(
        color: isUnlocked
            ? context.appColors.surface
            : context.appColors.surface.withValues(alpha: 0.3),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: isUnlocked
              ? difficultyColor.withValues(alpha: 0.5)
              : context.appColors.cardBorder.withValues(alpha: 0.5),
          width: isUnlocked ? 2 : 1,
        ),
        gradient: isUnlocked && isPlatinum
            ? LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: _getPlatinumGradient()
                    .map((c) => c.withValues(alpha: 0.3))
                    .toList(),
              )
            : null,
        boxShadow: isUnlocked
            ? [
                BoxShadow(
                  color: difficultyColor.withValues(alpha: 0.2),
                  blurRadius: 12,
                  offset: const Offset(0, 4),
                ),
              ]
            : null,
      ),
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          // Badge icon
          Stack(
            alignment: Alignment.center,
            children: [
              Container(
                width: 56,
                height: 56,
                decoration: BoxDecoration(
                  color: isUnlocked
                      ? difficultyColor.withValues(alpha: 0.2)
                      : context.appColors.surfaceLight.withValues(alpha: 0.5),
                  shape: BoxShape.circle,
                  border: Border.all(
                    color: isUnlocked
                        ? difficultyColor
                        : context.appColors.cardBorder,
                    width: 2,
                  ),
                ),
                child: Center(
                  child: isUnlocked
                      ? Icon(
                          CupertinoIcons.sparkles,
                          size: 26,
                          color: difficultyColor,
                        )
                      : Icon(
                          CupertinoIcons.question,
                          size: 24,
                          color: context.appColors.textTertiary,
                        ),
                ),
              ),
              // Difficulty badge
              Positioned(
                bottom: 0,
                right: 0,
                child: Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 6,
                    vertical: 2,
                  ),
                  decoration: BoxDecoration(
                    color: isUnlocked
                        ? difficultyColor
                        : context.appColors.textTertiary,
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Text(
                    difficultyLabel[0],
                    style: TextStyle(
                      fontSize: 9,
                      fontWeight: FontWeight.bold,
                      color: isUnlocked
                          ? context.appColors.textPrimary
                          : context.appColors.surface,
                    ),
                  ),
                ),
              ),
            ],
          ),
          const SizedBox(height: 10),
          // Title
          Text(
            isUnlocked
                ? AchievementUtils.getTitle(context, achievement.id)
                : l10n.hiddenBadge,
            textAlign: TextAlign.center,
            style: TextStyle(
              fontSize: 13,
              fontWeight: FontWeight.w600,
              color: isUnlocked
                  ? context.appColors.textPrimary
                  : Colors.white70, // Better contrast in dark mode
            ),
            maxLines: 1,
            overflow: TextOverflow.ellipsis,
          ),
          const SizedBox(height: 2),
          // Description
          Text(
            isUnlocked
                ? AchievementUtils.getDescription(context, achievement.id)
                : l10n.discoverHowToUnlock,
            textAlign: TextAlign.center,
            style: TextStyle(
              fontSize: 10,
              fontStyle: isUnlocked ? FontStyle.normal : FontStyle.italic,
              color: isUnlocked
                  ? context.appColors.textSecondary
                  : Colors.white54, // Better contrast in dark mode
            ),
            maxLines: 2,
            overflow: TextOverflow.ellipsis,
          ),
          const SizedBox(height: 6),
          // Difficulty label
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 2),
            decoration: BoxDecoration(
              color:
                  (isUnlocked
                          ? difficultyColor
                          : context.appColors.textTertiary)
                      .withValues(alpha: 0.2),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Text(
              difficultyLabel,
              style: TextStyle(
                fontSize: 10,
                fontWeight: FontWeight.w500,
                color: isUnlocked
                    ? difficultyColor
                    : Colors.white60, // Better contrast in dark mode
              ),
            ),
          ),
        ],
      ),
    );

    // Celebration animation
    if (hasCelebration) {
      final controller = _pulseControllers[achievement.id]!;
      return AnimatedBuilder(
        animation: controller,
        builder: (context, child) {
          final scale = 1.0 + (0.1 * (1 - controller.value));
          final glow = (1 - controller.value) * 0.5;
          return Transform.scale(
            scale: scale,
            child: Container(
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(16),
                boxShadow: [
                  BoxShadow(
                    color: difficultyColor.withValues(alpha: glow),
                    blurRadius: 20,
                    spreadRadius: 4,
                  ),
                ],
              ),
              child: card,
            ),
          );
        },
      );
    }

    return card;
  }

  String _formatProgress(Achievement achievement) {
    // Abbreviation for large numbers
    if (achievement.targetValue >= 1000000) {
      final current = (achievement.currentValue / 1000000).toStringAsFixed(1);
      final target = (achievement.targetValue / 1000000).toStringAsFixed(0);
      return '${current}M / ${target}M';
    } else if (achievement.targetValue >= 1000) {
      final current = (achievement.currentValue / 1000).toStringAsFixed(1);
      final target = (achievement.targetValue / 1000).toStringAsFixed(0);
      return '${current}K / ${target}K';
    }
    return '${achievement.currentValue}/${achievement.targetValue}';
  }

  String _formatDate(BuildContext context, DateTime date) {
    final l10n = AppLocalizations.of(context);
    final now = DateTime.now();
    final today = DateTime(now.year, now.month, now.day);
    final dateOnly = DateTime(date.year, date.month, date.day);

    if (dateOnly == today) {
      return l10n.earnedToday;
    }

    final difference = today.difference(dateOnly).inDays;
    if (difference == 1) {
      return l10n.earnedYesterday;
    } else if (difference < 7) {
      return l10n.daysAgoEarned(difference);
    } else if (difference < 30) {
      return l10n.weeksAgoEarned((difference / 7).floor());
    } else {
      return '${date.day}/${date.month}/${date.year}';
    }
  }
}

// ========== CONFETTI ANIMATION ==========

class _ConfettiParticle {
  double x;
  double y;
  final Color color;
  final double size;
  double rotation;
  final double velocityX;
  final double velocityY;

  _ConfettiParticle({
    required this.x,
    required this.y,
    required this.color,
    required this.size,
    required this.rotation,
    required this.velocityX,
    required this.velocityY,
  });
}

class _ConfettiPainter extends CustomPainter {
  final List<_ConfettiParticle> particles;
  final double progress;

  _ConfettiPainter({required this.particles, required this.progress});

  @override
  void paint(Canvas canvas, Size size) {
    for (final particle in particles) {
      final paint = Paint()
        ..color = particle.color.withValues(alpha: 1.0 - progress)
        ..style = PaintingStyle.fill;

      final x = (particle.x + particle.velocityX * progress) * size.width;
      final y = (particle.y + particle.velocityY * progress) * size.height;

      canvas.save();
      canvas.translate(x, y);
      canvas.rotate((particle.rotation + progress * 360) * 3.14159 / 180);

      final rect = Rect.fromCenter(
        center: Offset.zero,
        width: particle.size,
        height: particle.size * 0.6,
      );
      canvas.drawRect(rect, paint);

      canvas.restore();
    }
  }

  @override
  bool shouldRepaint(covariant _ConfettiPainter oldDelegate) {
    return oldDelegate.progress != progress;
  }
}


--- FILE: lib/screens/main_screen.dart ---

import 'dart:async';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:showcaseview/showcaseview.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';
import '../services/services.dart';
import '../theme/theme.dart';
import '../providers/providers.dart';
import '../widgets/widgets.dart';
import 'expense_screen.dart';
import 'report_screen.dart';
import 'pursuit_list_screen.dart';
import 'settings_screen.dart';
import 'onboarding_pursuit_screen.dart';
import 'voice_input_screen.dart';
import 'lock_screen.dart';
import 'simple/simple_main_screen.dart';

class MainScreen extends StatefulWidget {
  final UserProfile? userProfile;
  final bool startTour;

  const MainScreen({super.key, this.userProfile, this.startTour = false});

  @override
  State<MainScreen> createState() => _MainScreenState();
}

class _MainScreenState extends State<MainScreen> with WidgetsBindingObserver {
  int _currentIndex = 0;
  // _userProfile kaldırıldı - artık Provider'dan okunuyor

  final _connectivityService = ConnectivityService();
  final _currencyService = CurrencyService();
  final _simpleModeService = SimpleModeService();
  final _deviceService = DeviceService();

  // ExpenseScreen'e erişim için GlobalKey
  final GlobalKey<State<ExpenseScreen>> _expenseScreenKey = GlobalKey();

  bool _isConnected = true;
  ExchangeRates? _exchangeRates;
  bool _isLoadingRates = true;
  bool _hasRateError = false;
  bool _isSimpleMode = false;
  StreamSubscription<bool>? _connectivitySubscription;
  StreamSubscription<bool>? _deviceChangeSubscription;

  // Tour
  bool _shouldStartTour = false;

  // Lock state
  bool _isLocked = false;
  bool _checkingLock = true;
  bool _wasInBackground = false;

  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addObserver(this);
    // Profile artık Provider'dan okunuyor
    _initializeServices();
    _checkTour();
    _checkLockStatus();

    // Status bar stilini ayarla
    SystemChrome.setSystemUIOverlayStyle(
      const SystemUiOverlayStyle(
        statusBarColor: Colors.transparent,
        statusBarIconBrightness: Brightness.light,
        systemNavigationBarColor: Color(
          0xFF1A1A2E,
        ), // AppColors.background hardcoded for initState
        systemNavigationBarIconBrightness: Brightness.light,
      ),
    );
  }

  Future<void> _checkTour() async {
    // Widget'tan gelen parametre ile kontrol et
    if (widget.startTour) {
      setState(() => _shouldStartTour = true);
      return;
    }

    // İlk kez açılış kontrolü
    final hasSeenTour = await TourService.hasSeenTour();
    if (!hasSeenTour && mounted) {
      setState(() => _shouldStartTour = true);
    }
  }

  void _startTour(BuildContext context) {
    // Önce ana sayfaya yönlendir (index 0)
    if (_currentIndex != 0) {
      setState(() => _currentIndex = 0);
    }

    // Mark tour as complete IMMEDIATELY when starting
    // This prevents the tour from showing again even if dismissed early
    TourService.markTourComplete();

    // Kısa bir gecikme ile turu başlat (sayfa geçişi için)
    Future.delayed(const Duration(milliseconds: 300), () {
      if (mounted) {
        ShowCaseWidget.of(context).startShowCase([
          TourKeys.financialSnapshot,
          TourKeys.currencyRates,
          TourKeys.streakWidget,
          TourKeys.subscriptionButton,
          TourKeys.dateChips,
          TourKeys.amountField,
          TourKeys.descriptionField,
          TourKeys.categoryField,
          TourKeys.navBarReport,
          TourKeys.navBarAchievements,
          TourKeys.navBarProfile,
          TourKeys.navBarAddButton,
        ]);
      }
    });
  }

  void _onTourComplete() async {
    await TourService.markTourComplete();
    if (mounted) {
      setState(() => _shouldStartTour = false);
    }
  }

  /// ShowCase hedef widget'ına scroll et
  void _scrollToShowcaseTarget(GlobalKey key) {
    // Küçük bir gecikme ile pozisyon hesapla
    WidgetsBinding.instance.addPostFrameCallback((_) {
      final targetContext = key.currentContext;
      if (targetContext == null) return;

      // Hedef widget'ın pozisyonunu bul
      final renderBox = targetContext.findRenderObject() as RenderBox?;
      if (renderBox == null) return;

      // Ekrana göre pozisyon
      final position = renderBox.localToGlobal(Offset.zero);
      final widgetHeight = renderBox.size.height;
      final screenHeight = MediaQuery.of(context).size.height;
      final safeAreaTop = MediaQuery.of(context).padding.top;

      // Nav bar öğeleri için scroll yapma (ekranın altında)
      if (position.dy > screenHeight - 150) {
        return;
      }

      // ExpenseScreen'in ScrollController'ını al
      final expenseState = _expenseScreenKey.currentState;
      ScrollController? scrollController;

      if (expenseState != null) {
        try {
          scrollController =
              (expenseState as dynamic).scrollController as ScrollController?;
        } catch (_) {
          // ScrollController bulunamazsa Scrollable.maybeOf kullan
        }
      }

      // Alternatif: Scrollable.maybeOf kullan
      if (scrollController == null || !scrollController.hasClients) {
        final scrollable = Scrollable.maybeOf(targetContext);
        if (scrollable != null) {
          final scrollPosition = scrollable.position;
          _animateScrollToTarget(
            scrollPosition,
            position.dy,
            widgetHeight,
            screenHeight,
            safeAreaTop,
          );
        }
        return;
      }

      // ScrollController ile scroll yap
      _animateScrollToTarget(
        scrollController.position,
        position.dy,
        widgetHeight,
        screenHeight,
        safeAreaTop,
      );
    });
  }

  /// Hedef widget'a animasyonlu scroll
  void _animateScrollToTarget(
    ScrollPosition scrollPosition,
    double targetY,
    double widgetHeight,
    double screenHeight,
    double safeAreaTop,
  ) {
    // Hedef pozisyonu hesapla - widget ekranın üst 1/3'ünde olsun
    final targetPosition = screenHeight * 0.25;
    final scrollOffset = targetY - targetPosition;

    // Widget zaten görünür alanda mı?
    final visibleTop = safeAreaTop + 50; // Header için boşluk
    final visibleBottom = screenHeight - 200; // Nav bar + tooltip için boşluk

    if (targetY >= visibleTop && (targetY + widgetHeight) <= visibleBottom) {
      // Widget zaten görünür - scroll gerekmez
      return;
    }

    // Hedef scroll pozisyonunu hesapla
    final newScrollPosition = scrollPosition.pixels + scrollOffset;

    // Scroll animasyonu
    scrollPosition.animateTo(
      newScrollPosition.clamp(0.0, scrollPosition.maxScrollExtent),
      duration: const Duration(milliseconds: 400),
      curve: Curves.easeOutCubic,
    );
  }

  // _activeProfile kaldırıldı - build() içinde Provider'dan direkt okunuyor

  Future<void> _initializeServices() async {
    // Check single device policy first
    await _checkDeviceStatus();

    // Connectivity service başlat
    await _connectivityService.initialize();
    _isConnected = _connectivityService.isConnected;

    // Simple mode service başlat
    await _simpleModeService.initialize();
    _isSimpleMode = _simpleModeService.isEnabled;

    // Listen to simple mode changes
    _simpleModeService.addListener(_onSimpleModeChanged);

    // Listen to device changes in real-time (for single device policy)
    _startDeviceWatcher();

    // Connectivity değişikliklerini dinle
    _connectivitySubscription = _connectivityService.onConnectivityChanged
        .listen((isConnected) {
          setState(() => _isConnected = isConnected);

          // İnternet geldiğinde kurları güncelle
          if (isConnected) {
            _fetchExchangeRates();
          }
        });

    // Setup deep link callbacks with actual hourly rate from provider
    DeepLinkService().setCallbacks(
      getHourlyRate: () {
        final financeProvider = context.read<FinanceProvider>();
        return financeProvider.hourlyRate;
      },
      onAddExpense: (expense) async {
        final financeProvider = context.read<FinanceProvider>();
        await financeProvider.addExpense(expense);
      },
      onDeleteExpense: (index) async {
        final financeProvider = context.read<FinanceProvider>();
        await financeProvider.deleteExpense(index);
      },
    );

    // Kurları çek
    await _fetchExchangeRates();

    // Bildirimleri planla
    await _scheduleNotifications();

    // Handle pending pursuit from onboarding
    await _handlePendingPursuit();

    // Sync home screen widget data
    await _syncWidgetData();

    // Otomatik abonelik kayıtlarını işle
    await _processAutoRecordSubscriptions();

    if (mounted) setState(() {});
  }

  /// Otomatik abonelik harcamalarını oluştur
  Future<void> _processAutoRecordSubscriptions() async {
    try {
      final subscriptionService = SubscriptionService();
      final count = await subscriptionService.processAutoRecordSubscriptions();

      if (count > 0 && mounted) {
        // Refresh expenses in provider
        final financeProvider = context.read<FinanceProvider>();
        await financeProvider.initialize();

        // Show notification
        final l10n = AppLocalizations.of(context);
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(l10n.autoRecordedExpenses(count)),
            backgroundColor: context.appColors.success,
            behavior: SnackBarBehavior.floating,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(8),
            ),
          ),
        );
      }
    } catch (e) {
      debugPrint('[MainScreen] Error processing auto-records: $e');
    }
  }

  /// Handle pending pursuit creation from onboarding
  Future<void> _handlePendingPursuit() async {
    final prefs = await SharedPreferences.getInstance();
    final hasPending = prefs.getBool(PendingPursuitKeys.hasPending) ?? false;

    if (!hasPending) return;

    final goalId = prefs.getString(PendingPursuitKeys.goalId);
    final isCustom = prefs.getBool(PendingPursuitKeys.isCustom) ?? false;
    final goalName = prefs.getString(PendingPursuitKeys.goalName) ?? '';
    final goalAmount = prefs.getDouble(PendingPursuitKeys.goalAmount) ?? 0;
    final goalEmoji = prefs.getString(PendingPursuitKeys.goalEmoji) ?? '🎯';

    // Clear pending pursuit data
    await prefs.remove(PendingPursuitKeys.hasPending);
    await prefs.remove(PendingPursuitKeys.goalId);
    await prefs.remove(PendingPursuitKeys.goalName);
    await prefs.remove(PendingPursuitKeys.goalAmount);
    await prefs.remove(PendingPursuitKeys.goalEmoji);
    await prefs.remove(PendingPursuitKeys.isCustom);

    if (!mounted) return;

    if (isCustom) {
      // For custom goal, navigate to pursuit list and open create sheet
      // Delay to ensure screen is fully built
      Future.delayed(const Duration(milliseconds: 500), () {
        if (mounted) {
          // Navigate to Pursuits tab (index 2)
          setState(() => _currentIndex = 2);
          // Show create pursuit sheet
          _showCreatePursuitSheet();
        }
      });
    } else if (goalId != null && goalAmount > 0) {
      // Create the preset pursuit
      final pursuitProvider = context.read<PursuitProvider>();
      final proProvider = context.read<ProProvider>();
      final currencyProvider = context.read<CurrencyProvider>();

      // Initialize pursuit provider if needed
      if (!pursuitProvider.isInitialized) {
        await pursuitProvider.initialize();
      }

      // Determine category based on goal ID
      PursuitCategory category;
      switch (goalId) {
        case 'airpods':
        case 'iphone':
          category = PursuitCategory.tech;
          break;
        case 'vacation':
          category = PursuitCategory.travel;
          break;
        default:
          category = PursuitCategory.other;
      }

      final pursuit = Pursuit.create(
        name: goalName,
        targetAmount: goalAmount,
        currency: currencyProvider.currency.code,
        category: category,
        emoji: goalEmoji,
      );

      await pursuitProvider.createPursuit(
        pursuit,
        isPremium: proProvider.isPro,
      );
      debugPrint('[MainScreen] Created onboarding pursuit: $goalName');
    }
  }

  /// Show create pursuit bottom sheet
  void _showCreatePursuitSheet() {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      backgroundColor: Colors.transparent,
      builder: (context) => const CreatePursuitSheet(),
    );
  }

  Future<void> _scheduleNotifications() async {
    final notificationService = NotificationService();

    // Streak verilerini Provider'dan al
    final financeProvider = context.read<FinanceProvider>();
    final streakData = financeProvider.streakData;

    // Streak hatırlatması planla
    await notificationService.scheduleStreakReminder(
      currentStreak: streakData.currentStreak,
      lastEntryDate: streakData.lastEntryDate,
    );

    // Haftalık içgörü planla
    await notificationService.scheduleWeeklyInsight(
      streakDays: streakData.currentStreak,
    );
  }

  /// Sync data to home screen widgets (iOS + Android)
  Future<void> _syncWidgetData() async {
    if (!widgetService.isSupported) return;

    final financeProvider = context.read<FinanceProvider>();
    final currencyProvider = context.read<CurrencyProvider>();
    final localeProvider = context.read<LocaleProvider>();
    final pursuitProvider = context.read<PursuitProvider>();

    // Get active pursuit for widget display
    final activePursuits = pursuitProvider.activePursuits;
    String? pursuitName;
    double? pursuitProgress;
    double? pursuitTarget;

    if (activePursuits.isNotEmpty) {
      final pursuit = activePursuits.first;
      pursuitName = pursuit.name;
      pursuitProgress = pursuit.savedAmount;
      pursuitTarget = pursuit.targetAmount;
    }

    // Cache widget params for auto-sync after expense changes
    financeProvider.setWidgetParams(
      currencySymbol: currencyProvider.currency.symbol,
      locale: localeProvider.locale?.languageCode ?? 'en',
      pursuitName: pursuitName,
      pursuitProgress: pursuitProgress,
      pursuitTarget: pursuitTarget,
    );

    await financeProvider.syncWidgetData(
      currencySymbol: currencyProvider.currency.symbol,
      locale: localeProvider.locale?.languageCode ?? 'en',
      pursuitName: pursuitName,
      pursuitProgress: pursuitProgress,
      pursuitTarget: pursuitTarget,
    );
  }

  Future<void> _fetchExchangeRates() async {
    setState(() {
      _isLoadingRates = true;
      _hasRateError = false;
    });

    try {
      final rates = await _currencyService.getRates();
      if (mounted) {
        setState(() {
          _exchangeRates = rates;
          _isLoadingRates = false;
          _hasRateError = rates == null;
        });
      }
    } catch (e) {
      debugPrint('[MainScreen] Error loading rates: $e');
      if (mounted) {
        setState(() {
          _isLoadingRates = false;
          _hasRateError = true;
        });
        final l10n = AppLocalizations.of(context);
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(l10n.errorLoadingRates),
            backgroundColor: context.appColors.error,
            behavior: SnackBarBehavior.floating,
          ),
        );
      }
    }
  }

  void _onSimpleModeChanged() {
    if (mounted) {
      setState(() {
        _isSimpleMode = _simpleModeService.isEnabled;
      });
    }
  }

  /// Check if this device is still the active device (single device policy)
  Future<void> _checkDeviceStatus() async {
    final result = await _deviceService.checkDeviceStatus();
    if (result == DeviceCheckResult.anotherDeviceLoggedIn && mounted) {
      _handleDeviceMismatch();
    }
  }

  /// Start watching for device changes in real-time
  void _startDeviceWatcher() {
    _deviceChangeSubscription = _deviceService.watchDeviceChanges().listen((
      anotherDeviceLoggedIn,
    ) {
      if (anotherDeviceLoggedIn && mounted) {
        _handleDeviceMismatch();
      }
    });
  }

  /// Handle device mismatch - show dialog and sign out
  Future<void> _handleDeviceMismatch() async {
    // Cancel device watcher to prevent multiple triggers
    _deviceChangeSubscription?.cancel();
    _deviceChangeSubscription = null;

    if (!mounted) return;

    final l10n = AppLocalizations.of(context);

    // Show dialog
    await showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => AlertDialog(
        backgroundColor: context.appColors.surface,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
        title: Row(
          children: [
            Icon(
              CupertinoIcons.exclamationmark_triangle_fill,
              color: context.appColors.warning,
              size: 28,
            ),
            const SizedBox(width: 12),
            Expanded(
              child: Text(
                l10n.loggedOutFromAnotherDevice,
                style: TextStyle(
                  color: context.appColors.textPrimary,
                  fontSize: 18,
                  fontWeight: FontWeight.w600,
                ),
              ),
            ),
          ],
        ),
        content: Text(
          l10n.loggedOutFromAnotherDeviceMessage,
          style: TextStyle(
            color: context.appColors.textSecondary,
            fontSize: 14,
          ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(),
            child: Text(
              l10n.understood,
              style: TextStyle(
                color: context.appColors.accent,
                fontWeight: FontWeight.w600,
              ),
            ),
          ),
        ],
      ),
    );

    // Sign out without clearing device token (since we're being kicked out)
    await AuthService().signOut(clearDevice: false);
  }

  @override
  void dispose() {
    WidgetsBinding.instance.removeObserver(this);
    _connectivitySubscription?.cancel();
    _deviceChangeSubscription?.cancel();
    _connectivityService.dispose();
    _simpleModeService.removeListener(_onSimpleModeChanged);
    super.dispose();
  }

  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    if (state == AppLifecycleState.paused) {
      _wasInBackground = true;
      // Clean up simulation expenses when app goes to background
      _cleanupSimulations();
    } else if (state == AppLifecycleState.resumed && _wasInBackground) {
      _wasInBackground = false;
      _checkLockOnResume();
      // Refresh theme for time-based automatic mode
      context.read<ThemeProvider>().refreshTheme();
    } else if (state == AppLifecycleState.detached) {
      // Clean up simulation expenses when app is closing
      _cleanupSimulations();
    }
  }

  /// Clean up simulation expenses - they shouldn't persist
  Future<void> _cleanupSimulations() async {
    try {
      await ExpenseHistoryService().clearSimulations();
      // Refresh provider to reflect changes
      if (mounted) {
        context.read<FinanceProvider>().refresh();
      }
    } catch (e) {
      debugPrint('[Cleanup] Error clearing simulations: $e');
    }
  }

  Future<void> _checkLockStatus() async {
    final lockEnabled = await LockService.isLockEnabled();
    final hasPinSet = await LockService.hasPinSet();

    if (mounted) {
      setState(() {
        _isLocked = lockEnabled && hasPinSet;
        _checkingLock = false;
      });
    }
  }

  Future<void> _checkLockOnResume() async {
    final lockEnabled = await LockService.isLockEnabled();
    final hasPinSet = await LockService.hasPinSet();

    if (lockEnabled && hasPinSet && mounted) {
      setState(() => _isLocked = true);
    }
  }

  void _onUnlocked() {
    setState(() => _isLocked = false);
  }

  void _onNavTap(int index) {
    HapticFeedback.selectionClick();
    setState(() => _currentIndex = index);
  }

  void _showAddExpenseSheet() {
    showAddExpenseSheet(
      context,
      exchangeRates: _exchangeRates,
      onExpenseAdded: () {
        // Refresh streak if needed
        HapticFeedback.mediumImpact();
        // Navigate to home tab to show the new expense
        if (_currentIndex != 0) {
          setState(() => _currentIndex = 0);
        }
      },
    );
  }

  void _openVoiceInput() {
    HapticFeedback.heavyImpact();
    Navigator.push(
      context,
      MaterialPageRoute(builder: (_) => const VoiceInputScreen()),
    );
  }

  void _showAIChat() {
    HapticFeedback.mediumImpact();
    AnimatedBottomSheet.show(
      context: context,
      maxHeight: MediaQuery.of(context).size.height * 0.85,
      showDragHandle: false,
      child: const AIChatSheet(),
    );
  }

  @override
  Widget build(BuildContext context) {
    // Show loading while checking lock status
    if (_checkingLock) {
      return Scaffold(
        backgroundColor: context.appColors.background,
        body: const SizedBox.shrink(),
      );
    }

    // Show lock screen if locked
    if (_isLocked) {
      return LockScreen(onUnlocked: _onUnlocked);
    }

    // Show Simple Mode screen if enabled
    if (_isSimpleMode) {
      return const SimpleMainScreen();
    }

    // Provider'ı WATCH et - gelir değiştiğinde tüm ekran yenilensin
    final financeProvider = context.watch<FinanceProvider>();
    final currentProfile =
        financeProvider.userProfile ??
        UserProfile(incomeSources: [], dailyHours: 8, workDaysPerWeek: 5);

    return ShowCaseWidget(
      // Otomatik scroll (ShowCaseWidget'ın kendi mekanizması)
      enableAutoScroll: true,
      scrollDuration: const Duration(milliseconds: 400),
      onComplete: (index, key) {
        // Son adım tamamlandığında
        if (index == 11) {
          _onTourComplete();
        }
      },
      onStart: (index, key) {
        // Hedef widget'a scroll et (yedek mekanizma)
        _scrollToShowcaseTarget(key);
      },
      builder: (context) => Builder(
        builder: (context) {
          // Tur başlatılmalı mı kontrol et
          if (_shouldStartTour) {
            WidgetsBinding.instance.addPostFrameCallback((_) {
              if (_shouldStartTour) {
                _shouldStartTour = false;
                _startTour(context);
              }
            });
          }

          return Scaffold(
            backgroundColor: context.appColors.background,
            extendBody: true, // Nav bar arkasında içerik görünsün
            body: Stack(
              children: [
                // Ana içerik
                Column(
                  children: [
                    // İnternet bağlantısı banner'ı
                    _OfflineBanner(isVisible: !_isConnected),

                    // Ekranlar
                    Expanded(
                      child: IndexedStack(
                        index: _currentIndex,
                        children: [
                          ExpenseScreen(
                            key: _expenseScreenKey,
                            userProfile: currentProfile,
                            exchangeRates: _exchangeRates,
                            isLoadingRates: _isLoadingRates,
                            hasRateError: _hasRateError,
                            onRetryRates: _fetchExchangeRates,
                          ),
                          ReportScreen(userProfile: currentProfile),
                          const PursuitListScreen(),
                          const SettingsScreen(),
                        ],
                      ),
                    ),
                  ],
                ),
              ],
            ),
            // Premium floating nav bar with Showcase
            bottomNavigationBar: PremiumNavBarWithShowcase(
              currentIndex: _currentIndex,
              onTap: _onNavTap,
              onAddTap: _showAddExpenseSheet,
              onAddLongPress: _openVoiceInput,
            ),
            // AI Chat FAB (hidden in Simple Mode)
            floatingActionButton: _isSimpleMode
                ? null
                : AIFloatingButton(onTap: _showAIChat),
            floatingActionButtonLocation: FloatingActionButtonLocation.endFloat,
          );
        },
      ),
    );
  }
}

/// Offline banner - minimal ve şık
class _OfflineBanner extends StatelessWidget {
  final bool isVisible;

  const _OfflineBanner({required this.isVisible});

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return AnimatedContainer(
      duration: const Duration(milliseconds: 300),
      height: isVisible ? null : 0,
      child: AnimatedOpacity(
        duration: const Duration(milliseconds: 300),
        opacity: isVisible ? 1.0 : 0.0,
        child: Container(
          width: double.infinity,
          color: context.appColors.warning.withValues(alpha: 0.95),
          child: SafeArea(
            bottom: false,
            child: Padding(
              padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 12),
              child: Row(
                children: [
                  Container(
                    width: 28,
                    height: 28,
                    decoration: BoxDecoration(
                      color: context.appColors.textPrimary.withValues(
                        alpha: 0.2,
                      ),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Icon(
                      CupertinoIcons.wifi_slash,
                      size: 16,
                      color: context.appColors.background,
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Text(
                      l10n.offlineMode,
                      style: TextStyle(
                        fontSize: 13,
                        fontWeight: FontWeight.w500,
                        color: context.appColors.background,
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}


--- FILE: lib/screens/lock_screen.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../services/lock_service.dart';
import '../services/haptic_service.dart';
import '../theme/theme.dart';

/// Lock screen with PIN input and biometric option
class LockScreen extends StatefulWidget {
  final VoidCallback onUnlocked;

  const LockScreen({super.key, required this.onUnlocked});

  @override
  State<LockScreen> createState() => _LockScreenState();
}

class _LockScreenState extends State<LockScreen>
    with SingleTickerProviderStateMixin {
  String _enteredPin = '';
  bool _isLoading = false;
  String? _error;
  bool _biometricAvailable = false;

  late AnimationController _shakeController;
  late Animation<double> _shakeAnimation;

  @override
  void initState() {
    super.initState();
    _shakeController = AnimationController(
      duration: const Duration(milliseconds: 500),
      vsync: this,
    );
    _shakeAnimation = Tween<double>(
      begin: 0,
      end: 24,
    ).chain(CurveTween(curve: Curves.elasticIn)).animate(_shakeController);

    _checkBiometric();
  }

  @override
  void dispose() {
    _shakeController.dispose();
    super.dispose();
  }

  Future<void> _checkBiometric() async {
    final canUse = await LockService.canUseBiometrics();
    final isEnabled = await LockService.isBiometricEnabled();
    setState(() => _biometricAvailable = canUse && isEnabled);

    // Auto-trigger biometric on launch
    if (_biometricAvailable) {
      _tryBiometric();
    }
  }

  Future<void> _tryBiometric() async {
    if (!_biometricAvailable) return;

    final l10n = AppLocalizations.of(context);
    final success = await LockService.authenticateWithBiometrics(
      l10n.unlockWithBiometric,
    );

    if (success && mounted) {
      haptics.success();
      widget.onUnlocked();
    }
  }

  void _onNumberPressed(String number) {
    if (_enteredPin.length < 4) {
      haptics.light();
      setState(() {
        _enteredPin += number;
        _error = null;
      });

      if (_enteredPin.length == 4) {
        _verifyPin();
      }
    }
  }

  void _onDeletePressed() {
    if (_enteredPin.isNotEmpty) {
      haptics.light();
      setState(() {
        _enteredPin = _enteredPin.substring(0, _enteredPin.length - 1);
        _error = null;
      });
    }
  }

  Future<void> _verifyPin() async {
    setState(() => _isLoading = true);

    final success = await LockService.verifyPin(_enteredPin);

    if (success) {
      haptics.success();
      widget.onUnlocked();
    } else {
      haptics.error();
      _shakeController.forward().then((_) => _shakeController.reset());
      setState(() {
        _error = AppLocalizations.of(context).wrongPin;
        _enteredPin = '';
        _isLoading = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return Scaffold(
      backgroundColor: context.appColors.background,
      body: SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(24),
          child: Column(
            children: [
              const Spacer(flex: 2),

              // Logo
              Container(
                width: 80,
                height: 80,
                decoration: BoxDecoration(
                  color: context.appColors.primary.withValues(alpha: 0.15),
                  borderRadius: BorderRadius.circular(24),
                ),
                child: Icon(
                  CupertinoIcons.lock_fill,
                  size: 40,
                  color: context.appColors.primary,
                ),
              ),
              const SizedBox(height: 24),

              // Title
              Text(
                l10n.enterPin,
                style: TextStyle(
                  fontSize: 24,
                  fontWeight: FontWeight.bold,
                  color: context.appColors.textPrimary,
                ),
              ),
              const SizedBox(height: 8),
              Text(
                'Vantag',
                style: TextStyle(
                  fontSize: 14,
                  color: context.appColors.textSecondary,
                ),
              ),
              const SizedBox(height: 32),

              // PIN dots with shake animation
              AnimatedBuilder(
                animation: _shakeAnimation,
                builder: (context, child) {
                  return Transform.translate(
                    offset: Offset(
                      _shakeAnimation.value *
                          ((_shakeController.value * 10).toInt().isEven
                              ? 1
                              : -1),
                      0,
                    ),
                    child: child,
                  );
                },
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: List.generate(4, (index) {
                    final isFilled = index < _enteredPin.length;
                    return AnimatedContainer(
                      duration: const Duration(milliseconds: 150),
                      width: 20,
                      height: 20,
                      margin: const EdgeInsets.symmetric(horizontal: 10),
                      decoration: BoxDecoration(
                        shape: BoxShape.circle,
                        color: isFilled
                            ? context.appColors.primary
                            : Colors.transparent,
                        border: Border.all(
                          color: _error != null
                              ? context.appColors.error
                              : context.appColors.primary,
                          width: 2,
                        ),
                      ),
                    );
                  }),
                ),
              ),

              // Error message
              const SizedBox(height: 20),
              SizedBox(
                height: 20,
                child: _error != null
                    ? Text(
                        _error!,
                        style: TextStyle(
                          color: context.appColors.error,
                          fontSize: 14,
                          fontWeight: FontWeight.w500,
                        ),
                      )
                    : null,
              ),

              const Spacer(),

              // Number pad
              _buildNumberPad(),

              const SizedBox(height: 24),

              // Biometric button
              if (_biometricAvailable)
                TextButton.icon(
                  onPressed: _tryBiometric,
                  icon: FutureBuilder<bool>(
                    future: LockService.hasFaceId(),
                    builder: (context, snapshot) {
                      return Icon(
                        snapshot.data == true
                            ? CupertinoIcons.viewfinder
                            : CupertinoIcons.hand_raised,
                        color: context.appColors.primary,
                      );
                    },
                  ),
                  label: Text(
                    l10n.useBiometric,
                    style: TextStyle(
                      color: context.appColors.primary,
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                )
              else
                const SizedBox(height: 48),

              const Spacer(),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildNumberPad() {
    return Column(
      children: [
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceEvenly,
          children: ['1', '2', '3'].map(_buildNumberButton).toList(),
        ),
        const SizedBox(height: 16),
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceEvenly,
          children: ['4', '5', '6'].map(_buildNumberButton).toList(),
        ),
        const SizedBox(height: 16),
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceEvenly,
          children: ['7', '8', '9'].map(_buildNumberButton).toList(),
        ),
        const SizedBox(height: 16),
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceEvenly,
          children: [
            const SizedBox(width: 72), // Empty space
            _buildNumberButton('0'),
            _buildDeleteButton(),
          ],
        ),
      ],
    );
  }

  Widget _buildNumberButton(String number) {
    return GestureDetector(
      onTap: _isLoading ? null : () => _onNumberPressed(number),
      child: Container(
        width: 72,
        height: 72,
        decoration: BoxDecoration(
          shape: BoxShape.circle,
          color: context.appColors.surface,
          border: Border.all(color: context.appColors.cardBorder, width: 1),
        ),
        child: Center(
          child: Text(
            number,
            style: TextStyle(
              fontSize: 28,
              fontWeight: FontWeight.w600,
              color: context.appColors.textPrimary,
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildDeleteButton() {
    return GestureDetector(
      onTap: _isLoading ? null : _onDeletePressed,
      child: SizedBox(
        width: 72,
        height: 72,
        child: Center(
          child: Icon(
            CupertinoIcons.delete_left,
            size: 28,
            color: context.appColors.textSecondary,
          ),
        ),
      ),
    );
  }
}


--- FILE: lib/screens/onboarding_salary_day_screen.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../providers/finance_provider.dart';
import '../services/notification_service.dart';
import '../theme/theme.dart';

/// Onboarding screen for selecting salary day
/// Shown during onboarding flow after income wizard
class OnboardingSalaryDayScreen extends StatefulWidget {
  final VoidCallback onComplete;
  final VoidCallback? onSkip;

  const OnboardingSalaryDayScreen({
    super.key,
    required this.onComplete,
    this.onSkip,
  });

  @override
  State<OnboardingSalaryDayScreen> createState() =>
      _OnboardingSalaryDayScreenState();
}

class _OnboardingSalaryDayScreenState extends State<OnboardingSalaryDayScreen>
    with SingleTickerProviderStateMixin {
  int? _selectedDay;
  late FixedExtentScrollController _dayController;
  late AnimationController _buttonAnimationController;
  late Animation<double> _buttonScaleAnimation;

  @override
  void initState() {
    super.initState();
    _dayController = FixedExtentScrollController(initialItem: 0);
    _buttonAnimationController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 150),
    );
    _buttonScaleAnimation = Tween<double>(begin: 1.0, end: 0.95).animate(
      CurvedAnimation(
        parent: _buttonAnimationController,
        curve: Curves.easeInOut,
      ),
    );
  }

  @override
  void dispose() {
    _dayController.dispose();
    _buttonAnimationController.dispose();
    super.dispose();
  }

  Future<void> _saveSalaryDay() async {
    if (_selectedDay == null) return;

    HapticFeedback.mediumImpact();

    final financeProvider = context.read<FinanceProvider>();
    final profile = financeProvider.userProfile;

    if (profile != null) {
      final updatedProfile = profile.copyWith(salaryDay: _selectedDay);
      financeProvider.setUserProfile(updatedProfile);

      // Schedule payday notification
      await NotificationService().schedulePaydayNotification(
        salaryDay: _selectedDay!,
      );
    }

    widget.onComplete();
  }

  void _skip() {
    HapticFeedback.lightImpact();
    if (widget.onSkip != null) {
      widget.onSkip!();
    } else {
      widget.onComplete();
    }
  }

  void _onDaySelected(int index) {
    HapticFeedback.selectionClick();
    setState(() {
      _selectedDay = index + 1;
    });
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return Scaffold(
      backgroundColor: context.appColors.background,
      body: SafeArea(
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 24),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.stretch,
            children: [
              const Spacer(flex: 1),

              // Icon
              Container(
                width: 80,
                height: 80,
                margin: const EdgeInsets.only(bottom: 24),
                decoration: BoxDecoration(
                  color: context.appColors.primary.withValues(alpha: 0.15),
                  borderRadius: BorderRadius.circular(24),
                ),
                child: Icon(
                  CupertinoIcons.calendar_badge_plus,
                  size: 40,
                  color: context.appColors.primary,
                ),
              ),

              // Title
              Text(
                l10n.onboardingSalaryDayTitle,
                textAlign: TextAlign.center,
                style: TextStyle(
                  fontSize: 28,
                  fontWeight: FontWeight.w700,
                  color: context.appColors.textPrimary,
                  letterSpacing: -0.5,
                ),
              ),
              const SizedBox(height: 12),

              // Subtitle
              Text(
                l10n.onboardingSalaryDayDesc,
                textAlign: TextAlign.center,
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.w400,
                  color: context.appColors.textSecondary,
                ),
              ),

              const Spacer(flex: 1),

              // Day Picker
              SizedBox(
                height: 200,
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    // Day selector
                    SizedBox(
                      width: 100,
                      child: ListWheelScrollView.useDelegate(
                        controller: _dayController,
                        itemExtent: 60,
                        perspective: 0.005,
                        diameterRatio: 1.5,
                        physics: const FixedExtentScrollPhysics(),
                        onSelectedItemChanged: _onDaySelected,
                        childDelegate: ListWheelChildBuilderDelegate(
                          childCount: 31,
                          builder: (context, index) {
                            final day = index + 1;
                            final isSelected = _selectedDay == day;
                            return Center(
                              child: AnimatedDefaultTextStyle(
                                duration: const Duration(milliseconds: 200),
                                style: TextStyle(
                                  fontSize: isSelected ? 36 : 24,
                                  fontWeight: isSelected
                                      ? FontWeight.w700
                                      : FontWeight.w400,
                                  color: isSelected
                                      ? context.appColors.primary
                                      : context.appColors.textTertiary,
                                ),
                                child: Text('$day'),
                              ),
                            );
                          },
                        ),
                      ),
                    ),
                  ],
                ),
              ),

              // Selected day indicator
              if (_selectedDay != null)
                Container(
                  margin: const EdgeInsets.only(top: 16),
                  padding: const EdgeInsets.symmetric(
                    horizontal: 20,
                    vertical: 12,
                  ),
                  decoration: BoxDecoration(
                    color: context.appColors.surface,
                    borderRadius: BorderRadius.circular(16),
                    border: Border.all(color: context.appColors.cardBorder),
                  ),
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Icon(
                        CupertinoIcons.calendar_badge_plus,
                        size: 20,
                        color: context.appColors.primary,
                      ),
                      const SizedBox(width: 8),
                      Text(
                        l10n.dayOfMonth(_selectedDay!),
                        style: TextStyle(
                          fontSize: 16,
                          fontWeight: FontWeight.w600,
                          color: context.appColors.textPrimary,
                        ),
                      ),
                    ],
                  ),
                ),

              const Spacer(flex: 2),

              // CTA Button
              RepaintBoundary(
                child: GestureDetector(
                  onTapDown: _selectedDay != null
                      ? (_) => _buttonAnimationController.forward()
                      : null,
                  onTapUp: _selectedDay != null
                      ? (_) {
                          _buttonAnimationController.reverse();
                          _saveSalaryDay();
                        }
                      : null,
                  onTapCancel: _selectedDay != null
                      ? () => _buttonAnimationController.reverse()
                      : null,
                  child: ScaleTransition(
                    scale: _buttonScaleAnimation,
                    child: AnimatedContainer(
                      duration: const Duration(milliseconds: 200),
                      width: double.infinity,
                      padding: const EdgeInsets.symmetric(vertical: 18),
                      decoration: BoxDecoration(
                        color: _selectedDay != null
                            ? context.appColors.primary
                            : context.appColors.surfaceLight,
                        borderRadius: BorderRadius.circular(16),
                        boxShadow: _selectedDay != null
                            ? [
                                BoxShadow(
                                  color: context.appColors.primary.withValues(
                                    alpha: 0.3,
                                  ),
                                  blurRadius: 20,
                                  offset: const Offset(0, 8),
                                ),
                              ]
                            : null,
                      ),
                      child: Text(
                        l10n.save,
                        textAlign: TextAlign.center,
                        style: TextStyle(
                          fontSize: 18,
                          fontWeight: FontWeight.w600,
                          color: _selectedDay != null
                              ? context.appColors.background
                              : context.appColors.textTertiary,
                        ),
                      ),
                    ),
                  ),
                ),
              ),

              const SizedBox(height: 16),

              // Skip link
              TextButton(
                onPressed: _skip,
                child: Text(
                  l10n.salaryDaySkip,
                  style: TextStyle(
                    fontSize: 14,
                    fontWeight: FontWeight.w500,
                    color: context.appColors.textTertiary,
                  ),
                ),
              ),

              const SizedBox(height: 24),
            ],
          ),
        ),
      ),
    );
  }
}


--- FILE: lib/screens/onboarding_pursuit_screen.dart ---

import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../theme/theme.dart';
import 'main_screen.dart';

/// Preset goal data for onboarding
class _PresetGoal {
  final String id;
  final String Function(AppLocalizations) getName;
  final IconData icon;
  final int estimatedHours;
  final double targetAmount;
  final String emoji;

  const _PresetGoal({
    required this.id,
    required this.getName,
    required this.icon,
    required this.estimatedHours,
    required this.targetAmount,
    required this.emoji,
  });
}

/// Preset goals for onboarding
final List<_PresetGoal> _presetGoals = [
  _PresetGoal(
    id: 'airpods',
    getName: (l10n) => l10n.pursuitOnboardingAirpods,
    icon: CupertinoIcons.headphones,
    estimatedHours: 50,
    targetAmount: 8000,
    emoji: '🎧',
  ),
  _PresetGoal(
    id: 'iphone',
    getName: (l10n) => l10n.pursuitOnboardingIphone,
    icon: CupertinoIcons.device_phone_portrait,
    estimatedHours: 400,
    targetAmount: 65000,
    emoji: '📱',
  ),
  _PresetGoal(
    id: 'vacation',
    getName: (l10n) => l10n.pursuitOnboardingVacation,
    icon: CupertinoIcons.airplane,
    estimatedHours: 200,
    targetAmount: 30000,
    emoji: '✈️',
  ),
  _PresetGoal(
    id: 'custom',
    getName: (l10n) => l10n.pursuitOnboardingCustom,
    icon: CupertinoIcons.add,
    estimatedHours: 0,
    targetAmount: 0,
    emoji: '✨',
  ),
];

/// Keys for storing pending pursuit in SharedPreferences
class PendingPursuitKeys {
  static const String hasPending = 'pending_pursuit_has';
  static const String goalId = 'pending_pursuit_goal_id';
  static const String goalName = 'pending_pursuit_name';
  static const String goalAmount = 'pending_pursuit_amount';
  static const String goalEmoji = 'pending_pursuit_emoji';
  static const String isCustom = 'pending_pursuit_is_custom';
}

/// Onboarding screen for selecting a savings goal
/// Shown after OnboardingTryScreen, before MainScreen
class OnboardingPursuitScreen extends StatefulWidget {
  const OnboardingPursuitScreen({super.key});

  @override
  State<OnboardingPursuitScreen> createState() =>
      _OnboardingPursuitScreenState();
}

class _OnboardingPursuitScreenState extends State<OnboardingPursuitScreen>
    with SingleTickerProviderStateMixin {
  String? _selectedGoalId;

  late AnimationController _buttonAnimationController;
  late Animation<double> _buttonScaleAnimation;

  @override
  void initState() {
    super.initState();
    _buttonAnimationController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 150),
    );
    _buttonScaleAnimation = Tween<double>(begin: 1.0, end: 0.95).animate(
      CurvedAnimation(
        parent: _buttonAnimationController,
        curve: Curves.easeInOut,
      ),
    );
  }

  @override
  void dispose() {
    _buttonAnimationController.dispose();
    super.dispose();
  }

  Future<void> _savePendingPursuit(
    _PresetGoal goal,
    AppLocalizations l10n,
  ) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(PendingPursuitKeys.hasPending, true);
    await prefs.setString(PendingPursuitKeys.goalId, goal.id);
    await prefs.setString(PendingPursuitKeys.goalName, goal.getName(l10n));
    await prefs.setDouble(PendingPursuitKeys.goalAmount, goal.targetAmount);
    await prefs.setString(PendingPursuitKeys.goalEmoji, goal.emoji);
    await prefs.setBool(PendingPursuitKeys.isCustom, goal.id == 'custom');
  }

  void _onGoalSelected(String goalId) {
    HapticFeedback.selectionClick();
    setState(() {
      _selectedGoalId = goalId;
    });
  }

  Future<void> _continueWithGoal() async {
    if (_selectedGoalId == null) return;

    HapticFeedback.mediumImpact();

    final l10n = AppLocalizations.of(context);
    final selectedGoal = _presetGoals.firstWhere(
      (g) => g.id == _selectedGoalId,
    );

    // Save pending pursuit for MainScreen to create
    await _savePendingPursuit(selectedGoal, l10n);

    if (!mounted) return;

    Navigator.pushReplacement(
      context,
      PageRouteBuilder(
        pageBuilder: (context, animation, secondaryAnimation) =>
            const MainScreen(),
        transitionsBuilder: (context, animation, secondaryAnimation, child) {
          return FadeTransition(opacity: animation, child: child);
        },
        transitionDuration: const Duration(milliseconds: 400),
      ),
    );
  }

  void _skip() {
    HapticFeedback.lightImpact();
    Navigator.pushReplacement(
      context,
      PageRouteBuilder(
        pageBuilder: (context, animation, secondaryAnimation) =>
            const MainScreen(),
        transitionsBuilder: (context, animation, secondaryAnimation, child) {
          return FadeTransition(opacity: animation, child: child);
        },
        transitionDuration: const Duration(milliseconds: 400),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return Scaffold(
      backgroundColor: context.appColors.background,
      body: SafeArea(
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 24),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.stretch,
            children: [
              const Spacer(flex: 1),

              // Header
              Text(
                l10n.pursuitOnboardingTitle,
                textAlign: TextAlign.center,
                style: TextStyle(
                  fontSize: 32,
                  fontWeight: FontWeight.w700,
                  color: context.appColors.textPrimary,
                  letterSpacing: -0.5,
                ),
              ),
              const SizedBox(height: 12),
              Text(
                l10n.pursuitOnboardingSubtitle,
                textAlign: TextAlign.center,
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.w400,
                  color: context.appColors.textSecondary,
                ),
              ),

              const Spacer(flex: 1),

              // Goal grid (2x2)
              GridView.count(
                crossAxisCount: 2,
                shrinkWrap: true,
                physics: const NeverScrollableScrollPhysics(),
                mainAxisSpacing: 16,
                crossAxisSpacing: 16,
                childAspectRatio: 1.0,
                children: _presetGoals.map((goal) {
                  final isSelected = _selectedGoalId == goal.id;
                  return _GoalCard(
                    goal: goal,
                    isSelected: isSelected,
                    onTap: () => _onGoalSelected(goal.id),
                    l10n: l10n,
                  );
                }).toList(),
              ),

              const Spacer(flex: 2),

              // CTA Button
              RepaintBoundary(
                child: GestureDetector(
                  onTapDown: _selectedGoalId != null
                      ? (_) => _buttonAnimationController.forward()
                      : null,
                  onTapUp: _selectedGoalId != null
                      ? (_) {
                          _buttonAnimationController.reverse();
                          _continueWithGoal();
                        }
                      : null,
                  onTapCancel: _selectedGoalId != null
                      ? () => _buttonAnimationController.reverse()
                      : null,
                  child: ScaleTransition(
                    scale: _buttonScaleAnimation,
                    child: AnimatedContainer(
                      duration: const Duration(milliseconds: 200),
                      width: double.infinity,
                      padding: const EdgeInsets.symmetric(vertical: 18),
                      decoration: BoxDecoration(
                        color: _selectedGoalId != null
                            ? context.appColors.primary
                            : context.appColors.surfaceLight,
                        borderRadius: BorderRadius.circular(16),
                        boxShadow: _selectedGoalId != null
                            ? [
                                BoxShadow(
                                  color: context.appColors.primary.withValues(
                                    alpha: 0.3,
                                  ),
                                  blurRadius: 20,
                                  offset: const Offset(0, 8),
                                ),
                              ]
                            : null,
                      ),
                      child: Text(
                        l10n.pursuitOnboardingCta,
                        textAlign: TextAlign.center,
                        style: TextStyle(
                          fontSize: 18,
                          fontWeight: FontWeight.w600,
                          color: _selectedGoalId != null
                              ? context.appColors.background
                              : context.appColors.textTertiary,
                        ),
                      ),
                    ),
                  ),
                ),
              ),

              const SizedBox(height: 16),

              // Skip link
              TextButton(
                onPressed: _skip,
                child: Text(
                  l10n.pursuitOnboardingSkip,
                  style: TextStyle(
                    fontSize: 14,
                    fontWeight: FontWeight.w500,
                    color: context.appColors.textTertiary,
                  ),
                ),
              ),

              const SizedBox(height: 24),
            ],
          ),
        ),
      ),
    );
  }
}

/// Individual goal card widget
class _GoalCard extends StatelessWidget {
  final _PresetGoal goal;
  final bool isSelected;
  final VoidCallback onTap;
  final AppLocalizations l10n;

  const _GoalCard({
    required this.goal,
    required this.isSelected,
    required this.onTap,
    required this.l10n,
  });

  @override
  Widget build(BuildContext context) {
    final isCustom = goal.id == 'custom';

    return GestureDetector(
      onTap: onTap,
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        curve: Curves.easeOutCubic,
        decoration: BoxDecoration(
          color: context.appColors.surface,
          borderRadius: BorderRadius.circular(24),
          border: Border.all(
            color: isSelected
                ? context.appColors.primary
                : context.appColors.cardBorder,
            width: isSelected ? 2 : 1,
          ),
          boxShadow: isSelected
              ? [
                  BoxShadow(
                    color: context.appColors.primary.withValues(alpha: 0.2),
                    blurRadius: 16,
                    offset: const Offset(0, 4),
                  ),
                ]
              : null,
        ),
        child: ClipRRect(
          borderRadius: BorderRadius.circular(24),
          child: BackdropFilter(
            filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
            child: Stack(
              children: [
                // Content
                Padding(
                  padding: const EdgeInsets.all(16),
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      // Icon container
                      Container(
                        width: 56,
                        height: 56,
                        decoration: BoxDecoration(
                          color: isSelected
                              ? context.appColors.primary.withValues(
                                  alpha: 0.15,
                                )
                              : context.appColors.surfaceLight,
                          borderRadius: BorderRadius.circular(16),
                        ),
                        child: Icon(
                          goal.icon,
                          size: 28,
                          color: isSelected
                              ? context.appColors.primary
                              : context.appColors.textSecondary,
                        ),
                      ),
                      const SizedBox(height: 12),

                      // Name
                      Text(
                        goal.getName(l10n),
                        textAlign: TextAlign.center,
                        style: TextStyle(
                          fontSize: 15,
                          fontWeight: FontWeight.w600,
                          color: context.appColors.textPrimary,
                        ),
                      ),
                      const SizedBox(height: 4),

                      // Hours estimate (not for custom)
                      if (!isCustom)
                        Text(
                          '~${l10n.pursuitOnboardingHours(goal.estimatedHours)}',
                          style: TextStyle(
                            fontSize: 12,
                            fontWeight: FontWeight.w500,
                            color: context.appColors.textTertiary,
                          ),
                        ),
                    ],
                  ),
                ),

                // Selected checkmark
                if (isSelected)
                  Positioned(
                    top: 12,
                    right: 12,
                    child: Container(
                      width: 24,
                      height: 24,
                      decoration: BoxDecoration(
                        color: context.appColors.primary,
                        shape: BoxShape.circle,
                      ),
                      child: Icon(
                        CupertinoIcons.checkmark,
                        size: 14,
                        color: context.appColors.background,
                      ),
                    ),
                  ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}


--- FILE: lib/screens/splash_screen.dart ---

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:video_player/video_player.dart';
import 'package:vantag/theme/app_theme.dart';
import '../models/models.dart';
import '../services/services.dart';
import '../providers/providers.dart';
import 'screens.dart';

/// Vantag Video Splash Screen
/// Video plays full screen, fades out, then navigates to main screen
class VantagSplashScreen extends StatefulWidget {
  const VantagSplashScreen({super.key});

  @override
  State<VantagSplashScreen> createState() => _VantagSplashScreenState();
}

class _VantagSplashScreenState extends State<VantagSplashScreen>
    with SingleTickerProviderStateMixin {
  // Background color
  static const _bgColor = AppColors.cardBackground;

  // Video player
  VideoPlayerController? _videoController;
  bool _videoInitialized = false;
  bool _videoEnded = false;

  // Fade animation for video
  late AnimationController _fadeController;
  late Animation<double> _fadeAnimation;

  // App initialization
  UserProfile? _profile;
  bool _onboardingCompleted = false;
  bool _initComplete = false;

  @override
  void initState() {
    super.initState();
    _setSystemUI();
    _initFadeAnimation();
    _initVideo();
    _initializeApp();
  }

  void _setSystemUI() {
    SystemChrome.setSystemUIOverlayStyle(
      const SystemUiOverlayStyle(
        statusBarColor: Colors.transparent,
        statusBarIconBrightness: Brightness.light,
      ),
    );
  }

  void _initFadeAnimation() {
    _fadeController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 400),
    );
    _fadeAnimation = Tween<double>(
      begin: 1.0,
      end: 0.0,
    ).animate(CurvedAnimation(parent: _fadeController, curve: Curves.easeOut));
  }

  void _initVideo() {
    debugPrint('[Splash] Video init starting...');
    try {
      _videoController =
          VideoPlayerController.asset('lib/assets/videos/splash_video.mp4')
            ..setVolume(0) // Muted
            ..setLooping(false);

      _videoController!
          .initialize()
          .then((_) {
            debugPrint('[Splash] Video initialized!');
            if (mounted) {
              setState(() {
                _videoInitialized = true;
              });
              _videoController!.play();
              _startVideoEndListener();
            }
          })
          .catchError((error) {
            debugPrint('[Splash] Video init error: $error');
            // Video couldn't load, navigate directly
            if (mounted) {
              _onVideoEnded();
            }
          });
    } catch (e) {
      debugPrint('[Splash] Video catch error: $e');
      // Video couldn't create, navigate directly
      if (mounted) {
        _onVideoEnded();
      }
    }
  }

  void _startVideoEndListener() {
    final controller = _videoController;
    if (controller == null) return;

    controller.addListener(() {
      if (controller.value.isInitialized &&
          !_videoEnded &&
          controller.value.position >= controller.value.duration) {
        _onVideoEnded();
      }
    });

    // Fallback: After 4 seconds consider video ended
    Future.delayed(const Duration(seconds: 4), () {
      if (mounted && !_videoEnded) {
        _onVideoEnded();
      }
    });
  }

  void _onVideoEnded() {
    if (_videoEnded) return;
    _videoEnded = true;

    // Start fade out animation
    _fadeController.forward().then((_) async {
      // Wait for app init if not complete
      while (!_initComplete) {
        await Future.delayed(const Duration(milliseconds: 50));
      }

      // Navigate to next screen
      _navigateToNextScreen();
    });
  }

  Future<void> _initializeApp() async {
    final profileService = ProfileService();
    final notificationService = NotificationService();
    final subscriptionService = SubscriptionService();

    // Initialize FinanceProvider
    final financeProvider = context.read<FinanceProvider>();

    // ÖNCE onboarding durumunu kontrol et (en kritik)
    _onboardingCompleted = await profileService.isOnboardingCompleted();
    debugPrint('[Splash] Onboarding completed: $_onboardingCompleted');

    // Sonra profile kontrol et
    _profile = await profileService.getProfile();
    debugPrint('[Splash] Profile exists: ${_profile != null}');

    // Diğer servisleri başlat (paralel olabilir)
    await Future.wait([
      notificationService.initialize(),
      financeProvider.initialize(),
    ]);

    await notificationService.initializeDefaultSettings();
    await notificationService.requestPermission();

    // Schedule subscription renewal notifications
    _scheduleSubscriptionNotifications(
      subscriptionService,
      notificationService,
    );

    debugPrint('[Splash] ✓ App initialization complete');
    _initComplete = true;
  }

  Future<void> _scheduleSubscriptionNotifications(
    SubscriptionService subscriptionService,
    NotificationService notificationService,
  ) async {
    final tomorrow = await subscriptionService
        .getSubscriptionsRenewingTomorrow();

    if (tomorrow.isNotEmpty) {
      final subscriptionData = tomorrow
          .map((s) => (id: s.id, name: s.name, amount: s.amount))
          .toList();

      await notificationService.scheduleSubscriptionReminders(subscriptionData);
    }
  }

  void _navigateToNextScreen() {
    if (!mounted) return;

    Widget nextScreen;

    if (!_onboardingCompleted) {
      // Use new 3-step onboarding flow
      debugPrint('[Splash] → OnboardingV2Screen (new 3-step flow)');
      nextScreen = const OnboardingV2Screen();
    } else if (_profile != null) {
      debugPrint('[Splash] → MainScreen (profile exists)');
      nextScreen = MainScreen(userProfile: _profile!);
    } else {
      debugPrint('[Splash] → UserProfileScreen (no profile yet)');
      nextScreen = const UserProfileScreen();
    }

    Navigator.pushReplacement(
      context,
      PageRouteBuilder(
        pageBuilder: (context, animation, secondaryAnimation) => nextScreen,
        transitionsBuilder: (context, animation, secondaryAnimation, child) {
          return FadeTransition(opacity: animation, child: child);
        },
        transitionDuration: const Duration(milliseconds: 400),
      ),
    );
  }

  @override
  void dispose() {
    _videoController?.dispose();
    _fadeController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: _bgColor,
      body: AnimatedBuilder(
        animation: _fadeController,
        builder: (context, child) {
          return Opacity(opacity: _fadeAnimation.value, child: child);
        },
        child: _videoInitialized && _videoController != null
            ? SizedBox.expand(
                child: FittedBox(
                  fit: BoxFit.cover,
                  child: SizedBox(
                    width: _videoController!.value.size.width,
                    height: _videoController!.value.size.height,
                    child: VideoPlayer(_videoController!),
                  ),
                ),
              )
            : const SizedBox.expand(), // Empty while loading
      ),
    );
  }
}


--- FILE: lib/main.dart ---

import 'dart:async';
import 'dart:io';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_crashlytics/firebase_crashlytics.dart';
import 'package:firebase_analytics/firebase_analytics.dart';
import 'package:flutter_localizations/flutter_localizations.dart';
import 'package:flutter_dotenv/flutter_dotenv.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:vantag/l10n/app_localizations.dart';
import 'package:fvp/fvp.dart' as fvp;
import 'firebase_options.dart';

import 'screens/screens.dart';
import 'theme/theme.dart';
import 'providers/providers.dart';
import 'services/analytics_service.dart';
import 'services/auth_service.dart';
import 'services/expense_history_service.dart';
import 'services/ai_service.dart';
import 'services/referral_service.dart';
import 'services/deep_link_service.dart';
import 'services/siri_service.dart';
import 'services/budget_service.dart';
import 'services/purchase_service.dart';
import 'services/haptic_service.dart';
import 'services/widget_service.dart';
import 'services/sound_service.dart';
import 'services/notification_service.dart';

/// Global navigator key for deep link dialogs
final GlobalKey<NavigatorState> navigatorKey = GlobalKey<NavigatorState>();

/// Global Firebase Analytics instance
late final FirebaseAnalytics analytics;

void main() async {
  await runZonedGuarded(
    () async {
      WidgetsFlutterBinding.ensureInitialized();

      // Register fvp for Windows/Linux video support
      fvp.registerWith();

      // Load environment variables
      bool envLoaded = false;
      try {
        await dotenv.load(fileName: ".env");
        envLoaded = true;
        debugPrint("✅ .env dosyası yüklendi");
      } catch (e) {
        debugPrint("⚠️ .env dosyası yüklenemedi, AI özellikleri devre dışı: $e");
        envLoaded = false;
      }

      // Initialize AI Service (Memory + Models) - only if env loaded
      if (envLoaded) {
        try {
          await AIService().initialize();
          debugPrint("✅ AI Service başlatıldı");
        } catch (e) {
          debugPrint("⚠️ AI Service başlatılamadı: $e");
        }
      } else {
        debugPrint("ℹ️ AI Service atlandı (.env yüklenemedi)");
      }

      // Initialize RevenueCat for in-app purchases
      try {
        await PurchaseService.init();
        debugPrint("✅ RevenueCat başlatıldı");
      } catch (e) {
        debugPrint("❌ RevenueCat hatası: $e");
      }

      // Initialize Haptic Service
      try {
        await haptics.init();
        debugPrint("✅ Haptic Service başlatıldı");
      } catch (e) {
        debugPrint("❌ Haptic Service hatası: $e");
      }

      // Initialize Sound Service
      try {
        await soundService.init();
        debugPrint("✅ Sound Service başlatıldı");
      } catch (e) {
        debugPrint("❌ Sound Service hatası: $e");
      }

      debugPrint("🚀 ADIM 1: Flutter Hazır");

      // LocaleProvider başlat
      final localeProvider = LocaleProvider();
      await localeProvider.initialize();
      debugPrint("✅ ADIM 1.5: Locale Provider Hazır");

      // CurrencyProvider başlat
      final currencyProvider = CurrencyProvider();
      await currencyProvider.loadCurrency();
      debugPrint("✅ ADIM 1.6: Currency Provider Hazır");

      // Firebase başlat (ProProvider'dan ÖNCE başlatılmalı!)
      try {
        await Firebase.initializeApp(
          options: DefaultFirebaseOptions.currentPlatform,
        );
        debugPrint("✅ ADIM 2: Firebase Core Başarılı");

        // Initialize Firebase Crashlytics
        FlutterError.onError =
            FirebaseCrashlytics.instance.recordFlutterFatalError;
        debugPrint("✅ ADIM 2.1: Crashlytics Başarılı");

        // Initialize Firebase Analytics
        analytics = FirebaseAnalytics.instance;
        await analytics.setAnalyticsCollectionEnabled(true);
        debugPrint("✅ ADIM 2.2: Analytics Başarılı");

        // Set first open date for cohort analysis (only on first launch)
        final prefs = await SharedPreferences.getInstance();
        final hasSetFirstOpen = prefs.getBool('has_set_first_open') ?? false;
        if (!hasSetFirstOpen) {
          await AnalyticsService().setUserFirstOpenDate();
          await prefs.setBool('has_set_first_open', true);
          debugPrint("✅ ADIM 2.3: First Open Date Set");
        }
      } catch (e) {
        debugPrint("❌ HATA: Firebase Core Bağlanamadı: $e");
      }

      // AuthService ile anonim giriş yap (ProProvider'dan ÖNCE Auth olmalı!)
      final authService = AuthService();
      final result = await authService.signInAnonymously();

      if (result.success) {
        debugPrint("✅ ADIM 3: Auth Başarılı - UID: ${result.user?.uid}");
        authService.debugAuthStatus();

        // Set user ID for Crashlytics
        await FirebaseCrashlytics.instance.setUserIdentifier(
          result.user?.uid ?? 'anonymous',
        );

        // Register user IP for referral abuse prevention (background)
        ReferralService().registerUserIP();

        // Cloud'dan mevcut expense verilerini çek (multi-device sync)
        final expenseService = ExpenseHistoryService();
        await expenseService.syncFromFirestore();
        debugPrint("✅ ADIM 4: Cloud veriler senkronize edildi");
      } else {
        debugPrint("❌ HATA: Auth Başarısız: ${result.errorMessage}");
      }

      // ProProvider başlat (Firebase + Auth başlatıldıktan sonra!)
      final proProvider = ProProvider();
      await proProvider.initialize();
      debugPrint("✅ ADIM 5: Pro Provider Hazır");

      // SavingsPoolProvider başlat (Auth gerekiyor)
      final savingsPoolProvider = SavingsPoolProvider();
      await savingsPoolProvider.initialize();
      debugPrint("✅ ADIM 6: Savings Pool Provider Hazır");

      // ThemeProvider başlat
      final themeProvider = ThemeProvider();
      await themeProvider.initialize();
      debugPrint("✅ ADIM 7: Theme Provider Hazır");

      SystemChrome.setSystemUIOverlayStyle(
        const SystemUiOverlayStyle(
          statusBarColor: Colors.transparent,
          statusBarIconBrightness: Brightness.light,
          systemNavigationBarColor: Color(
            0xFF1A1A2E,
          ), // AppColors.background hardcoded - no context before runApp
          systemNavigationBarIconBrightness: Brightness.light,
        ),
      );

      runApp(
        VantagApp(
          localeProvider: localeProvider,
          currencyProvider: currencyProvider,
          proProvider: proProvider,
          savingsPoolProvider: savingsPoolProvider,
          themeProvider: themeProvider,
        ),
      );
    },
    (error, stack) {
      // Record async errors to Crashlytics
      FirebaseCrashlytics.instance.recordError(error, stack, fatal: true);
    },
  );
}

class VantagApp extends StatefulWidget {
  final LocaleProvider localeProvider;
  final CurrencyProvider currencyProvider;
  final ProProvider proProvider;
  final SavingsPoolProvider savingsPoolProvider;
  final ThemeProvider themeProvider;

  const VantagApp({
    super.key,
    required this.localeProvider,
    required this.currencyProvider,
    required this.proProvider,
    required this.savingsPoolProvider,
    required this.themeProvider,
  });

  @override
  State<VantagApp> createState() => _VantagAppState();
}

class _VantagAppState extends State<VantagApp> {
  @override
  void initState() {
    super.initState();
    _initializeServices();
  }

  Future<void> _initializeServices() async {
    // Initialize Deep Link Service
    DeepLinkService().init(navigatorKey);

    // Initialize Siri shortcuts (iOS only)
    if (Platform.isIOS) {
      SiriService().setupShortcuts();
    }

    // Initialize Home Screen Widget Service (iOS + Android)
    if (Platform.isIOS || Platform.isAndroid) {
      await widgetService.initialize();
      debugPrint('Widget Service initialized');
    }

    // Initialize Notification Service
    try {
      await NotificationService().initialize();
      await NotificationService().initializeDefaultSettings();
      debugPrint('Notification Service initialized');
    } catch (e) {
      debugPrint('Notification Service error: $e');
    }
  }

  @override
  Widget build(BuildContext context) {
    return MultiProvider(
      providers: [
        ChangeNotifierProvider(create: (_) => FinanceProvider()),
        ChangeNotifierProxyProvider<FinanceProvider, BudgetService>(
          create: (context) => BudgetService(context.read<FinanceProvider>()),
          update: (context, financeProvider, previous) =>
              previous ?? BudgetService(financeProvider),
        ),
        ChangeNotifierProvider.value(value: widget.localeProvider),
        ChangeNotifierProvider.value(value: widget.currencyProvider),
        ChangeNotifierProvider.value(value: widget.proProvider),
        ChangeNotifierProvider.value(value: widget.savingsPoolProvider),
        ChangeNotifierProvider.value(value: widget.themeProvider),
        ChangeNotifierProvider(create: (_) => PursuitProvider()),
        ChangeNotifierProvider(create: (_) => CategoryBudgetProvider()),
      ],
      child: Consumer2<LocaleProvider, ThemeProvider>(
        builder: (context, localeProvider, themeProvider, child) {
          return MaterialApp(
            title: 'Vantag',
            navigatorKey: navigatorKey,
            debugShowCheckedModeBanner: false,
            navigatorObservers: [
              FirebaseAnalyticsObserver(analytics: analytics),
            ],
            theme: AppTheme.lightTheme,
            darkTheme: AppTheme.darkTheme,
            themeMode: themeProvider.materialThemeMode,

            // Localization ayarları
            locale: localeProvider.locale,
            supportedLocales: LocaleProvider.supportedLocales,
            localizationsDelegates: const [
              AppLocalizations.delegate,
              GlobalMaterialLocalizations.delegate,
              GlobalWidgetsLocalizations.delegate,
              GlobalCupertinoLocalizations.delegate,
            ],

            // Sistem dili desteklenmiyorsa Türkçe kullan
            localeResolutionCallback: (locale, supportedLocales) {
              // Kullanıcı tercih ettiyse onu kullan
              if (localeProvider.locale != null) {
                return localeProvider.locale;
              }

              // Sistem dilini kontrol et
              for (final supportedLocale in supportedLocales) {
                if (supportedLocale.languageCode == locale?.languageCode) {
                  return supportedLocale;
                }
              }

              // Varsayılan Türkçe
              return const Locale('tr');
            },

            home: const VantagSplashScreen(),
          );
        },
      ),
    );
  }
}


--- FILE: lib/theme/accessible_text.dart ---

import 'package:flutter/material.dart';

/// Helper class for accessible text that respects system text scaling
/// while preventing layout breakage at extreme scales
class AccessibleText {
  /// Returns a font size that respects system text scaling
  /// but with a maximum scale to prevent layout breaking
  static double scaledFontSize(
    BuildContext context,
    double baseSize, {
    double maxScale = 1.5,
    double minScale = 1.0,
  }) {
    final mediaQuery = MediaQuery.of(context);
    final scale = mediaQuery.textScaler.scale(1.0).clamp(minScale, maxScale);
    return baseSize * scale;
  }

  /// Text style that scales with system settings
  static TextStyle scaled(
    BuildContext context, {
    required double fontSize,
    FontWeight? fontWeight,
    Color? color,
    double? height,
    double? letterSpacing,
    TextDecoration? decoration,
    double maxScale = 1.5,
    double minScale = 1.0,
  }) {
    return TextStyle(
      fontSize: scaledFontSize(
        context,
        fontSize,
        maxScale: maxScale,
        minScale: minScale,
      ),
      fontWeight: fontWeight,
      color: color,
      height: height,
      letterSpacing: letterSpacing,
      decoration: decoration,
    );
  }

  /// Large display text (for dashboard numbers, etc.)
  /// Uses lower maxScale to prevent overflow
  static TextStyle largeDisplay(
    BuildContext context, {
    Color? color,
    FontWeight fontWeight = FontWeight.bold,
  }) {
    return scaled(
      context,
      fontSize: 32,
      fontWeight: fontWeight,
      color: color,
      maxScale: 1.3, // Lower scale for large numbers
    );
  }

  /// Medium display text (for card amounts, time displays)
  static TextStyle mediumDisplay(
    BuildContext context, {
    Color? color,
    FontWeight fontWeight = FontWeight.w600,
  }) {
    return scaled(
      context,
      fontSize: 24,
      fontWeight: fontWeight,
      color: color,
      maxScale: 1.4,
    );
  }

  /// Title text (section headers)
  static TextStyle title(
    BuildContext context, {
    Color? color,
    FontWeight fontWeight = FontWeight.w600,
  }) {
    return scaled(
      context,
      fontSize: 18,
      fontWeight: fontWeight,
      color: color,
      maxScale: 1.5,
    );
  }

  /// Body text (descriptions, labels)
  static TextStyle body(
    BuildContext context, {
    Color? color,
    FontWeight? fontWeight,
  }) {
    return scaled(
      context,
      fontSize: 16,
      fontWeight: fontWeight,
      color: color,
      maxScale: 1.5,
    );
  }

  /// Caption text (small labels, hints)
  static TextStyle caption(
    BuildContext context, {
    Color? color,
    FontWeight? fontWeight,
  }) {
    return scaled(
      context,
      fontSize: 12,
      fontWeight: fontWeight,
      color: color,
      maxScale: 1.4,
    );
  }

  /// Button text
  static TextStyle button(
    BuildContext context, {
    Color? color,
    FontWeight fontWeight = FontWeight.w600,
  }) {
    return scaled(
      context,
      fontSize: 16,
      fontWeight: fontWeight,
      color: color,
      maxScale: 1.3,
    );
  }
}

/// Extension for easy access to scaled fonts
extension AccessibleTextExtension on BuildContext {
  /// Get scaled font size with optional max scale
  double scaledFont(double size, {double maxScale = 1.5}) {
    return AccessibleText.scaledFontSize(this, size, maxScale: maxScale);
  }

  /// Check if user has accessibility text scaling enabled
  bool get hasLargeText {
    final scale = MediaQuery.of(this).textScaler.scale(1.0);
    return scale > 1.2;
  }

  /// Get the current text scale factor
  double get textScale {
    return MediaQuery.of(this).textScaler.scale(1.0);
  }
}

/// Widget that wraps text with FittedBox for overflow protection
class ScalableText extends StatelessWidget {
  final String text;
  final TextStyle? style;
  final TextAlign? textAlign;
  final int? maxLines;
  final double maxScale;

  const ScalableText(
    this.text, {
    super.key,
    this.style,
    this.textAlign,
    this.maxLines,
    this.maxScale = 1.5,
  });

  @override
  Widget build(BuildContext context) {
    return FittedBox(
      fit: BoxFit.scaleDown,
      alignment: textAlign == TextAlign.center
          ? Alignment.center
          : textAlign == TextAlign.right
          ? Alignment.centerRight
          : Alignment.centerLeft,
      child: Text(text, style: style, textAlign: textAlign, maxLines: maxLines),
    );
  }
}

/// Minimum touch target size for accessibility (44x44 per WCAG)
class AccessibleTouchTarget extends StatelessWidget {
  final Widget child;
  final VoidCallback? onTap;
  final double minSize;

  const AccessibleTouchTarget({
    super.key,
    required this.child,
    this.onTap,
    this.minSize = 44.0,
  });

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      behavior: HitTestBehavior.opaque,
      child: ConstrainedBox(
        constraints: BoxConstraints(minWidth: minSize, minHeight: minSize),
        child: Center(child: child),
      ),
    );
  }
}


--- FILE: lib/theme/ai_finance_theme.dart ---

import 'dart:ui';
import 'package:flutter/material.dart';
import 'app_theme.dart';

/// Premium UI Components - Wealth Coach
/// 1000 kişilik ekip arkasında varmış gibi premium görünüm

class PremiumCard extends StatelessWidget {
  final Widget child;
  final EdgeInsets? padding;
  final EdgeInsets? margin;
  final VoidCallback? onTap;
  final double borderRadius;
  final Color? borderColor;
  final bool enableBlur;

  const PremiumCard({
    super.key,
    required this.child,
    this.padding,
    this.margin,
    this.onTap,
    this.borderRadius = 20,
    this.borderColor,
    this.enableBlur = true,
  });

  @override
  Widget build(BuildContext context) {
    final cardContent = Container(
      margin: margin,
      decoration: BoxDecoration(
        color: Colors.white.withValues(alpha: 0.03),
        borderRadius: BorderRadius.circular(borderRadius),
        border: Border.all(
          color: borderColor ?? Colors.white.withValues(alpha: 0.08),
          width: 1,
        ),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withValues(alpha: 0.3),
            blurRadius: 30,
            offset: const Offset(0, 10),
          ),
        ],
      ),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(borderRadius),
        child: enableBlur
            ? BackdropFilter(
                filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
                child: Padding(
                  padding: padding ?? const EdgeInsets.all(24),
                  child: child,
                ),
              )
            : Padding(
                padding: padding ?? const EdgeInsets.all(24),
                child: child,
              ),
      ),
    );

    if (onTap != null) {
      return GestureDetector(onTap: onTap, child: cardContent);
    }
    return cardContent;
  }
}

/// Premium Gradient Button
class PremiumButton extends StatefulWidget {
  final String text;
  final VoidCallback? onPressed;
  final IconData? icon;
  final bool isLoading;
  final double? width;

  const PremiumButton({
    super.key,
    required this.text,
    this.onPressed,
    this.icon,
    this.isLoading = false,
    this.width,
  });

  @override
  State<PremiumButton> createState() => _PremiumButtonState();
}

class _PremiumButtonState extends State<PremiumButton> {
  bool _isPressed = false;

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTapDown: (_) => setState(() => _isPressed = true),
      onTapUp: (_) => setState(() => _isPressed = false),
      onTapCancel: () => setState(() => _isPressed = false),
      onTap: widget.isLoading ? null : widget.onPressed,
      child: AnimatedScale(
        scale: _isPressed ? 0.98 : 1.0,
        duration: const Duration(milliseconds: 100),
        child: Container(
          width: widget.width ?? double.infinity,
          padding: const EdgeInsets.symmetric(vertical: 16),
          decoration: BoxDecoration(
            gradient: AppGradients.primaryButton,
            borderRadius: BorderRadius.circular(16),
            boxShadow: [
              BoxShadow(
                color: context.appColors.primary.withValues(alpha: 0.4),
                blurRadius: 20,
                offset: Offset(0, 8),
              ),
            ],
          ),
          child: widget.isLoading
              ? const Center(
                  child: SizedBox(
                    width: 24,
                    height: 24,
                    child: CircularProgressIndicator(
                      strokeWidth: 2,
                      valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                    ),
                  ),
                )
              : Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    if (widget.icon != null) ...[
                      Icon(widget.icon, color: Colors.white, size: 20),
                      const SizedBox(width: 8),
                    ],
                    Text(
                      widget.text,
                      style: const TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.w600,
                        color: Colors.white,
                        letterSpacing: 0.5,
                      ),
                    ),
                  ],
                ),
        ),
      ),
    );
  }
}

/// Premium Progress Bar
class PremiumProgressBar extends StatelessWidget {
  final double progress; // 0.0 - 1.0
  final double height;
  final Color? backgroundColor;

  const PremiumProgressBar({
    super.key,
    required this.progress,
    this.height = 8,
    this.backgroundColor,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      height: height,
      decoration: BoxDecoration(
        color: backgroundColor ?? Colors.white.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(height / 2),
      ),
      child: LayoutBuilder(
        builder: (context, constraints) {
          return Stack(
            children: [
              AnimatedContainer(
                duration: const Duration(milliseconds: 800),
                curve: Curves.easeOutCubic,
                width: constraints.maxWidth * progress.clamp(0.0, 1.0),
                height: height,
                decoration: BoxDecoration(
                  gradient: AppGradients.progress,
                  borderRadius: BorderRadius.circular(height / 2),
                  boxShadow: [
                    BoxShadow(
                      color: context.appColors.secondary.withValues(alpha: 0.4),
                      blurRadius: 8,
                      offset: Offset(0, 2),
                    ),
                  ],
                ),
              ),
            ],
          );
        },
      ),
    );
  }
}

/// Premium Chip (Date, Category selection)
class PremiumChip extends StatelessWidget {
  final String? label;
  final IconData? icon;
  final bool isSelected;
  final VoidCallback onTap;

  const PremiumChip({
    super.key,
    this.label,
    this.icon,
    required this.isSelected,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        padding: EdgeInsets.symmetric(
          horizontal: label != null ? 16 : 12,
          vertical: 10,
        ),
        decoration: BoxDecoration(
          gradient: isSelected ? AppGradients.primaryButton : null,
          color: isSelected ? null : Colors.white.withValues(alpha: 0.05),
          borderRadius: BorderRadius.circular(12),
          border: Border.all(
            color: isSelected
                ? Colors.transparent
                : Colors.white.withValues(alpha: 0.1),
            width: 1,
          ),
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            if (icon != null)
              Icon(
                icon,
                size: 16,
                color: isSelected
                    ? Colors.white
                    : context.appColors.textSecondary,
              ),
            if (icon != null && label != null) const SizedBox(width: 6),
            if (label != null)
              Text(
                label!,
                style: TextStyle(
                  fontSize: 13,
                  fontWeight: isSelected ? FontWeight.w600 : FontWeight.w500,
                  color: isSelected
                      ? Colors.white
                      : context.appColors.textSecondary,
                ),
              ),
          ],
        ),
      ),
    );
  }
}

/// Premium Icon Badge (for stats)
class PremiumIconBadge extends StatelessWidget {
  final IconData icon;
  final Color color;
  final double size;

  const PremiumIconBadge({
    super.key,
    required this.icon,
    required this.color,
    this.size = 32,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      width: size,
      height: size,
      decoration: BoxDecoration(
        color: color.withValues(alpha: 0.15),
        borderRadius: BorderRadius.circular(size / 3),
      ),
      child: Icon(icon, size: size * 0.5, color: color),
    );
  }
}

/// Premium Badge (like "1 kaynak", "100%")
class PremiumBadge extends StatelessWidget {
  final String text;
  final Color? color;
  final IconData? icon;
  final bool isGold;

  const PremiumBadge({
    super.key,
    required this.text,
    this.color,
    this.icon,
    this.isGold = false,
  });

  @override
  Widget build(BuildContext context) {
    final badgeColor = isGold
        ? context.appColors.gold
        : (color ?? context.appColors.primary);

    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
      decoration: BoxDecoration(
        color: badgeColor.withValues(alpha: 0.15),
        borderRadius: BorderRadius.circular(20),
        border: Border.all(color: badgeColor.withValues(alpha: 0.3), width: 1),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          if (icon != null) ...[
            Icon(icon, size: 12, color: badgeColor),
            const SizedBox(width: 4),
          ],
          Text(
            text,
            style: TextStyle(
              fontSize: 11,
              fontWeight: FontWeight.w600,
              color: badgeColor,
            ),
          ),
        ],
      ),
    );
  }
}

/// Premium Gradient Background
class PremiumBackground extends StatelessWidget {
  final Widget child;

  const PremiumBackground({super.key, required this.child});

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: const BoxDecoration(gradient: AppGradients.background),
      child: child,
    );
  }
}

/// Premium Section Title
class PremiumSectionTitle extends StatelessWidget {
  final String title;
  final Widget? trailing;
  final bool useGradientAccent;

  const PremiumSectionTitle({
    super.key,
    required this.title,
    this.trailing,
    this.useGradientAccent = true,
  });

  @override
  Widget build(BuildContext context) {
    return Row(
      children: [
        if (useGradientAccent)
          Container(
            width: 4,
            height: 20,
            decoration: BoxDecoration(
              gradient: AppGradients.primaryButton,
              borderRadius: BorderRadius.circular(2),
            ),
          ),
        if (useGradientAccent) const SizedBox(width: 12),
        Text(
          title,
          style: TextStyle(
            fontSize: 18,
            fontWeight: FontWeight.w600,
            color: context.appColors.textPrimary,
          ),
        ),
        if (trailing != null) ...[const Spacer(), trailing!],
      ],
    );
  }
}

/// Premium Stats Label
class PremiumLabel extends StatelessWidget {
  final String text;
  final bool uppercase;

  const PremiumLabel({super.key, required this.text, this.uppercase = true});

  @override
  Widget build(BuildContext context) {
    return Text(
      uppercase ? text.toUpperCase() : text,
      style: TextStyle(
        fontSize: 11,
        fontWeight: FontWeight.w500,
        color: context.appColors.textSecondary,
        letterSpacing: uppercase ? 1.5 : 0,
      ),
    );
  }
}

/// Premium Big Number Display
class PremiumBigNumber extends StatelessWidget {
  final String value;
  final String? suffix;
  final Color? color;
  final bool light;

  const PremiumBigNumber({
    super.key,
    required this.value,
    this.suffix,
    this.color,
    this.light = true,
  });

  @override
  Widget build(BuildContext context) {
    return Row(
      crossAxisAlignment: CrossAxisAlignment.end,
      mainAxisSize: MainAxisSize.min,
      children: [
        Text(
          value,
          style: TextStyle(
            fontSize: 56,
            fontWeight: light ? FontWeight.w300 : FontWeight.w700,
            color: color ?? context.appColors.textPrimary,
            letterSpacing: -2,
            height: 1,
          ),
        ),
        if (suffix != null)
          Padding(
            padding: const EdgeInsets.only(left: 8, bottom: 8),
            child: Text(
              suffix!,
              style: TextStyle(
                fontSize: 20,
                fontWeight: FontWeight.w300,
                color: context.appColors.textSecondary,
              ),
            ),
          ),
      ],
    );
  }
}

/// Pulsing Dot Indicator
class PulsingDot extends StatefulWidget {
  final Color color;
  final double size;

  const PulsingDot({super.key, required this.color, this.size = 8});

  @override
  State<PulsingDot> createState() => _PulsingDotState();
}

class _PulsingDotState extends State<PulsingDot>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _animation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      duration: const Duration(milliseconds: 1500),
      vsync: this,
    )..repeat(reverse: true);
    _animation = Tween<double>(
      begin: 0.4,
      end: 0.8,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeInOut));
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: _animation,
      builder: (context, child) {
        return Container(
          width: widget.size,
          height: widget.size,
          decoration: BoxDecoration(
            color: widget.color,
            shape: BoxShape.circle,
            boxShadow: [
              BoxShadow(
                color: widget.color.withValues(alpha: _animation.value),
                blurRadius: 8,
                spreadRadius: 2,
              ),
            ],
          ),
        );
      },
    );
  }
}

// Legacy compatibility - AIFinanceTheme alias
class AIFinanceTheme {
  AIFinanceTheme._();

  // Colors mapped to AppColors
  static const Color gradientStart = AppColors.gradientStart;
  static const Color gradientEnd = AppColors.gradientEnd;
  static const Color cardBackground = AppColors.cardBackground;
  static const Color cardBorder = AppColors.cardBorder;
  static const Color textPrimary = AppColors.textPrimary;
  static const Color textSecondary = AppColors.textSecondary;
  static const Color textTertiary = AppColors.textTertiary;
  static const Color iconColor = AppColors.textSecondary;
  static const Color positive = AppColors.success;
  static const Color negative = AppColors.error;
  static const Color warning = AppColors.warning;
  static const Color accent = AppColors.primary;
  static const Color progressPurple = AppColors.primary;
  static const Color progressBlue = Color(0xFF5A8DEE);
  static const Color progressTeal = AppColors.secondary;
  static const Color buttonGradientStart = AppColors.primary;
  static const Color buttonGradientEnd = AppColors.secondary;

  // Gradients
  static const LinearGradient backgroundGradient = AppGradients.background;
  static const LinearGradient buttonGradient = AppGradients.primaryButton;
  static const LinearGradient progressGradient = AppGradients.progress;

  // Spacing
  static const double pagePadding = 24;
  static const double cardSpacing = 20;
  static const double cardPadding = 24;

  // Radius
  static const double cardRadius = 20;
  static const double buttonRadius = 16;

  // Typography
  static const TextStyle displayLarge = TextStyle(
    fontSize: 56,
    fontWeight: FontWeight.w300,
    color: AppColors.textPrimary,
    letterSpacing: -2,
  );

  static const TextStyle heading = TextStyle(
    fontSize: 28,
    fontWeight: FontWeight.w700,
    color: AppColors.textPrimary,
    letterSpacing: -0.5,
  );

  static const TextStyle subtitle = TextStyle(
    fontSize: 14,
    fontWeight: FontWeight.w400,
    color: AppColors.textSecondary,
  );

  static const TextStyle body = TextStyle(
    fontSize: 16,
    fontWeight: FontWeight.w400,
    color: AppColors.textPrimary,
  );

  static const TextStyle label = TextStyle(
    fontSize: 11,
    fontWeight: FontWeight.w500,
    color: AppColors.textSecondary,
    letterSpacing: 1.5,
  );

  static BoxDecoration get cardDecoration => BoxDecoration(
    color: Colors.white.withValues(alpha: 0.03),
    borderRadius: BorderRadius.circular(20),
    border: Border.all(color: Colors.white.withValues(alpha: 0.08), width: 1),
    boxShadow: [
      BoxShadow(
        color: Colors.black.withValues(alpha: 0.3),
        blurRadius: 30,
        offset: const Offset(0, 10),
      ),
    ],
  );

  static BoxDecoration get gradientButtonDecoration => BoxDecoration(
    gradient: AppGradients.primaryButton,
    borderRadius: BorderRadius.circular(16),
    boxShadow: [
      BoxShadow(
        color: AppColors.primary.withValues(alpha: 0.4),
        blurRadius: 20,
        offset: const Offset(0, 8),
      ),
    ],
  );
}

// Legacy AIGradientButton - use PremiumButton instead
// Now with pulse glow animation for premium feel
class AIGradientButton extends StatefulWidget {
  final String text;
  final VoidCallback? onPressed;
  final IconData? icon;
  final bool isLoading;
  final bool enablePulse;

  const AIGradientButton({
    super.key,
    required this.text,
    this.onPressed,
    this.icon,
    this.isLoading = false,
    this.enablePulse = true,
  });

  @override
  State<AIGradientButton> createState() => _AIGradientButtonState();
}

class _AIGradientButtonState extends State<AIGradientButton>
    with SingleTickerProviderStateMixin {
  bool _isPressed = false;
  late AnimationController _pulseController;
  late Animation<double> _pulseAnimation;

  @override
  void initState() {
    super.initState();
    _pulseController = AnimationController(
      duration: const Duration(milliseconds: 2000),
      vsync: this,
    );
    _pulseAnimation = Tween<double>(begin: 0.3, end: 0.6).animate(
      CurvedAnimation(parent: _pulseController, curve: Curves.easeInOut),
    );

    if (widget.enablePulse) {
      _pulseController.repeat(reverse: true);
    }
  }

  @override
  void dispose() {
    _pulseController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTapDown: (_) => setState(() => _isPressed = true),
      onTapUp: (_) => setState(() => _isPressed = false),
      onTapCancel: () => setState(() => _isPressed = false),
      onTap: widget.isLoading ? null : widget.onPressed,
      child: AnimatedBuilder(
        animation: _pulseAnimation,
        builder: (context, child) {
          return AnimatedScale(
            scale: _isPressed ? 0.98 : 1.0,
            duration: const Duration(milliseconds: 100),
            child: Container(
              width: double.infinity,
              padding: const EdgeInsets.symmetric(vertical: 16),
              decoration: BoxDecoration(
                gradient: AppGradients.primaryButton,
                borderRadius: BorderRadius.circular(16),
                boxShadow: [
                  // Primary glow - pulsing
                  BoxShadow(
                    color: context.appColors.primary.withValues(
                      alpha: widget.enablePulse ? _pulseAnimation.value : 0.4,
                    ),
                    blurRadius: 20,
                    offset: Offset(0, 8),
                  ),
                  // Secondary glow for depth
                  BoxShadow(
                    color: context.appColors.secondary.withValues(
                      alpha: widget.enablePulse
                          ? _pulseAnimation.value * 0.5
                          : 0.2,
                    ),
                    blurRadius: 30,
                    spreadRadius: -5,
                    offset: Offset(0, 12),
                  ),
                ],
              ),
              child: widget.isLoading
                  ? const Center(
                      child: SizedBox(
                        width: 24,
                        height: 24,
                        child: CircularProgressIndicator(
                          strokeWidth: 2,
                          valueColor: AlwaysStoppedAnimation<Color>(
                            Colors.white,
                          ),
                        ),
                      ),
                    )
                  : Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        if (widget.icon != null) ...[
                          Icon(widget.icon, color: Colors.white, size: 20),
                          const SizedBox(width: 8),
                        ],
                        Text(
                          widget.text,
                          style: const TextStyle(
                            fontSize: 16,
                            fontWeight: FontWeight.w600,
                            color: Colors.white,
                            letterSpacing: 0.5,
                          ),
                        ),
                      ],
                    ),
            ),
          );
        },
      ),
    );
  }
}

// Legacy AIGlassCard - use PremiumCard instead
class AIGlassCard extends StatelessWidget {
  final Widget child;
  final EdgeInsets? padding;
  final EdgeInsets? margin;
  final VoidCallback? onTap;

  const AIGlassCard({
    super.key,
    required this.child,
    this.padding,
    this.margin,
    this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    return PremiumCard(
      padding: padding,
      margin: margin,
      onTap: onTap,
      child: child,
    );
  }
}


--- FILE: lib/theme/quiet_luxury.dart ---

import 'dart:ui';
import 'package:flutter/material.dart';
import 'app_theme.dart';

/// Wealth Coach: Quiet Luxury Design System
/// JPMorgan & Goldman Sachs özel bankacılık şıklığı
///
/// IMPORTANT: Colors now delegate to AppColors for consistency.
/// Use AppColors directly in new code.

class QuietLuxury {
  QuietLuxury._();

  // ═══════════════════════════════════════════════════════
  // RENK PALETİ - Delegated to AppColors
  // ═══════════════════════════════════════════════════════

  /// Ana arka plan - Midnight Blue
  static Color get background => AppColors.background;

  /// İkincil metin - Slate Grey
  static Color get textSecondary => AppColors.textSecondary;

  /// Ana metin - Off-White
  static Color get textPrimary => AppColors.textPrimary;

  /// Üçüncül metin - daha soluk
  static Color get textTertiary => AppColors.textTertiary;

  /// Pozitif durumlar
  static Color get positive => AppColors.success;

  /// Negatif durumlar
  static Color get negative => AppColors.error;

  /// Uyarı
  static Color get warning => AppColors.warning;

  /// Altın - SADECE özel anlar için (Victory, Achievement, Milestone)
  static Color get gold => AppColors.gold;

  /// Kart arka planı
  static Color get cardBackground => AppColors.cardBackground;

  /// Kart border
  static Color get cardBorder => AppColors.cardBorder;

  /// Gölge rengi
  static const Color shadowColor = Color(0x33000000); // 0.2 opacity

  /// Premium mor gölge
  static const Color premiumShadow = Color(0x4D8B5CF6); // 0.3 opacity purple

  // ═══════════════════════════════════════════════════════
  // TİPOGRAFİ
  // ═══════════════════════════════════════════════════════

  /// Büyük sayılar - nefes alan premium his
  static TextStyle get displayLarge => TextStyle(
    fontSize: 32,
    fontWeight: FontWeight.w300,
    letterSpacing: 1.5,
    color: textPrimary,
  );

  /// Başlıklar
  static TextStyle get heading => TextStyle(
    fontSize: 20,
    fontWeight: FontWeight.w600,
    letterSpacing: 0.5,
    color: textPrimary,
  );

  /// Alt başlıklar
  static TextStyle get subheading => TextStyle(
    fontSize: 16,
    fontWeight: FontWeight.w400,
    color: textSecondary,
  );

  /// Body text
  static TextStyle get body => TextStyle(
    fontSize: 14,
    fontWeight: FontWeight.w400,
    color: textSecondary,
  );

  /// Küçük etiketler
  static TextStyle get label => TextStyle(
    fontSize: 12,
    fontWeight: FontWeight.w400,
    color: textTertiary,
  );

  /// Vurgulu sayılar (tutarlar)
  static TextStyle get amount => TextStyle(
    fontSize: 18,
    fontWeight: FontWeight.w600,
    letterSpacing: 0.5,
    color: textPrimary,
  );

  // ═══════════════════════════════════════════════════════
  // ANİMASYON SABİTLERİ
  // ═══════════════════════════════════════════════════════

  /// Sayfa geçişleri
  static const Duration pageTransition = Duration(milliseconds: 350);
  static const Curve pageTransitionCurve = Curves.easeInOutCubic;

  /// Modal açılışları
  static const Duration modalTransition = Duration(milliseconds: 300);
  static const Curve modalTransitionCurve = Curves.easeOutCubic;

  /// Sayı değişimleri
  static const Duration numberTransition = Duration(milliseconds: 200);

  /// Buton press scale (Premium: 0.95 for tactile feel)
  static const double buttonPressScale = 0.95;

  // ═══════════════════════════════════════════════════════
  // BOŞLUK SABİTLERİ
  // ═══════════════════════════════════════════════════════

  /// Sayfa padding
  static const EdgeInsets pagePadding = EdgeInsets.all(20);

  /// Kart içi padding
  static const EdgeInsets cardPadding = EdgeInsets.all(20);

  /// Kartlar arası boşluk
  static const double cardSpacing = 16;

  /// Elemanlar arası boşluk
  static const double elementSpacing = 12;

  // ═══════════════════════════════════════════════════════
  // KART DEKORASYONLARI
  // ═══════════════════════════════════════════════════════

  /// Glassmorphism kart dekorasyonu (Revolut style)
  static BoxDecoration get cardDecoration => BoxDecoration(
    color: AppColors.surface,
    borderRadius: BorderRadius.circular(AppDesign.radiusXLarge),
    border: Border.all(
      color: Colors.white.withValues(alpha: 0.06),
      width: 1,
    ),
    boxShadow: AppDesign.shadowMedium,
  );

  /// Premium kart dekorasyonu (Revolut style)
  static BoxDecoration get premiumCardDecoration => BoxDecoration(
    color: AppColors.surface,
    borderRadius: BorderRadius.circular(AppDesign.radiusXLarge),
    border: Border.all(
      color: Colors.white.withValues(alpha: 0.06),
      width: 1,
    ),
    boxShadow: AppDesign.cardShadow,
  );

  /// Subtle kart dekorasyonu (gölgesiz)
  static BoxDecoration get subtleCardDecoration => BoxDecoration(
    color: AppColors.surface,
    borderRadius: BorderRadius.circular(AppDesign.radiusXLarge),
    border: Border.all(
      color: Colors.white.withValues(alpha: 0.06),
      width: 1,
    ),
  );

  /// Vurgulu kart dekorasyonu (pozitif)
  static BoxDecoration positiveCardDecoration({double glowOpacity = 0.1}) =>
      BoxDecoration(
        color: cardBackground,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: positive.withValues(alpha: 0.3), width: 0.5),
        boxShadow: [
          BoxShadow(
            color: positive.withValues(alpha: glowOpacity),
            blurRadius: 20,
            offset: const Offset(0, 4),
          ),
        ],
      );

  /// Border radius
  static BorderRadius get cardRadius => BorderRadius.circular(AppDesign.radiusLarge);
  static BorderRadius get buttonRadius => BorderRadius.circular(AppDesign.radiusSmall);
}

/// Glassmorphism Card Widget (Revolut Style)
class GlassCard extends StatelessWidget {
  final Widget child;
  final EdgeInsets? padding;
  final BoxDecoration? decoration;
  final bool premium;

  const GlassCard({
    super.key,
    required this.child,
    this.padding,
    this.decoration,
    this.premium = false,
  });

  @override
  Widget build(BuildContext context) {
    final effectiveDecoration = decoration ??
        (premium ? QuietLuxury.premiumCardDecoration : QuietLuxury.cardDecoration);

    return ClipRRect(
      borderRadius: BorderRadius.circular(AppDesign.radiusXLarge),
      child: BackdropFilter(
        filter: ImageFilter.blur(sigmaX: 20, sigmaY: 20),
        child: Container(
          padding: padding ?? AppDesign.cardPaddingLarge,
          decoration: effectiveDecoration.copyWith(
            color: Colors.white.withValues(alpha: 0.05),
          ),
          child: child,
        ),
      ),
    );
  }
}

/// Animated Number Widget - Sayı değişimlerinde fade geçiş
class AnimatedNumber extends StatelessWidget {
  final String value;
  final TextStyle? style;

  const AnimatedNumber({super.key, required this.value, this.style});

  @override
  Widget build(BuildContext context) {
    return AnimatedSwitcher(
      duration: QuietLuxury.numberTransition,
      transitionBuilder: (child, animation) =>
          FadeTransition(opacity: animation, child: child),
      child: Text(
        value,
        key: ValueKey(value),
        style: style ?? QuietLuxury.displayLarge,
      ),
    );
  }
}

/// Pressable Widget - Hafif scale efekti
class Pressable extends StatefulWidget {
  final Widget child;
  final VoidCallback? onTap;

  const Pressable({super.key, required this.child, this.onTap});

  @override
  State<Pressable> createState() => _PressableState();
}

class _PressableState extends State<Pressable> {
  bool _isPressed = false;

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTapDown: (_) => setState(() => _isPressed = true),
      onTapUp: (_) => setState(() => _isPressed = false),
      onTapCancel: () => setState(() => _isPressed = false),
      onTap: widget.onTap,
      child: AnimatedScale(
        scale: _isPressed ? QuietLuxury.buttonPressScale : 1.0,
        duration: const Duration(milliseconds: 100),
        child: widget.child,
      ),
    );
  }
}

/// Subtle Divider - Çizgi yerine boşluk ve opacity farkı
class SubtleDivider extends StatelessWidget {
  final double height;

  const SubtleDivider({super.key, this.height = 16});

  @override
  Widget build(BuildContext context) {
    return SizedBox(height: height);
  }
}


--- FILE: lib/theme/app_theme.dart ---

import 'dart:io' show Platform;
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';

/// Premium Color Palette - iOS 26 Liquid Glass
/// 2026 Fintech Standard - Revolut Ultra, N26 Metal seviyesi
class AppColors {
  AppColors._();

  // ═══════════════════════════════════════════════════════
  // ARKA PLAN - Psychology-Based OLED Black
  // ═══════════════════════════════════════════════════════

  /// Ana arka plan - Ultra deep OLED black
  static const Color background = Color(0xFF050508);

  /// Kart arka planı
  static const Color cardBackground = Color(0xFF12101A);

  /// Yükseltilmiş yüzey
  static const Color surfaceElevated = Color(0xFF1A1725);

  /// Surface overlay - Modals, sheets
  static const Color surfaceOverlay = Color(0xFF231F2E);

  /// Gradient başlangıç
  static const Color gradientStart = Color(0xFF0A0A0F);

  /// Gradient orta
  static const Color gradientMid = Color(0xFF12101A);

  /// Gradient bitiş
  static const Color gradientEnd = Color(0xFF1A1725);

  // Surface colors (iOS 26 Liquid Glass style)
  static const Color surface = Color(0xFF12101A);
  static const Color surfaceLight = Color(0xFF1A1725);
  static const Color surfaceLighter = Color(0xFF231F2E);

  // ═══════════════════════════════════════════════════════
  // ANA RENKLER (iOS 26 Vibrant Purple)
  // ═══════════════════════════════════════════════════════

  /// Primary - Vibrant Purple (iOS 26 style)
  static const Color primary = Color(0xFF8B5CF6);
  static const Color primaryDark = Color(0xFF7C3AED);
  static const Color primaryLight = Color(0xFFA78BFA);

  /// Secondary - Cyan (Liquid Glass signature)
  static const Color secondary = Color(0xFF06B6D4);
  static const Color secondaryDark = Color(0xFF0891B2);
  static const Color secondaryLight = Color(0xFF22D3EE);

  /// Accent - Gold
  static const Color accent = Color(0xFFF59E0B);
  static const Color gold = Color(0xFFF59E0B);

  // ═══════════════════════════════════════════════════════
  // METİN RENKLERİ (iOS 26 Style)
  // ═══════════════════════════════════════════════════════

  /// Primary text
  static const Color textPrimary = Color(0xFFFAFAFA);

  /// Secondary text
  static const Color textSecondary = Color(0xFFA1A1AA);

  /// Tertiary text
  static const Color textTertiary = Color(0xFF71717A);

  /// Muted text
  static const Color textMuted = Color(0xFF52525B);

  // ═══════════════════════════════════════════════════════
  // DURUM RENKLERİ (2026 Fintech Standard)
  // ═══════════════════════════════════════════════════════

  /// Success - Emerald
  static const Color success = Color(0xFF10B981);

  /// Warning - Amber
  static const Color warning = Color(0xFFF59E0B);

  /// Error - Rose
  static const Color error = Color(0xFFEF4444);

  /// Info - Blue
  static const Color info = Color(0xFF3B82F6);

  // ═══════════════════════════════════════════════════════
  // KARAR RENKLERİ (Vantag Decision)
  // ═══════════════════════════════════════════════════════

  /// Aldım/Harcandı - Soft red
  static const Color decisionYes = Color(0xFFF87171);

  /// Düşünüyorum - Amber
  static const Color decisionThinking = Color(0xFFFBBF24);

  /// Vazgeçtim/Kurtarılan - Cyan (pozitif!)
  static const Color decisionNo = Color(0xFF06B6D4);

  // ═══════════════════════════════════════════════════════
  // GLASS EFFECTS (Liquid Glass)
  // ═══════════════════════════════════════════════════════

  /// Glass background - 8% white
  static const Color glassWhite = Color(0x15FFFFFF);

  /// Glass border - 12% white
  static const Color glassBorder = Color(0x20FFFFFF);

  /// Glass highlight - 19% white
  static const Color glassHighlight = Color(0x30FFFFFF);

  /// Kart arka plan (glass effect)
  static const Color cardBackgroundGlass = Color(0x0AFFFFFF);

  /// Kart border
  static const Color cardBorder = Color(0x15FFFFFF);

  /// Kart gölge
  static const Color cardShadow = Color(0x40000000);

  // ═══════════════════════════════════════════════════════════════
  // CHART PALETTE - 8 colors for pie/bar charts
  // ═══════════════════════════════════════════════════════════════
  static const List<Color> chartPalette = [
    Color(0xFF6C63FF), // Purple (primary)
    Color(0xFF4ECDC4), // Teal (secondary)
    Color(0xFFFF6B6B), // Coral
    Color(0xFFFFD93D), // Yellow
    Color(0xFF95E1D3), // Mint
    Color(0xFFF38181), // Salmon
    Color(0xFFAA96DA), // Lavender
    Color(0xFF3D5A80), // Navy
  ];

  // ═══════════════════════════════════════════════════════════════
  // CATEGORY COLORS - For expense categories
  // ═══════════════════════════════════════════════════════════════
  static const Color categoryFood = Color(0xFFFF6B6B);
  static const Color categoryTransport = Color(0xFF4ECDC4);
  static const Color categoryShopping = Color(0xFF9B59B6);
  static const Color categoryEntertainment = Color(0xFF3498DB);
  static const Color categoryBills = Color(0xFFE74C3C);
  static const Color categoryHealth = Color(0xFF2ECC71);
  static const Color categoryEducation = Color(0xFFF39C12);
  static const Color categoryOther = Color(0xFF95A5A6);
  static const Color categoryDefault = Color(0xFF78909C);

  // ═══════════════════════════════════════════════════════════════
  // ACHIEVEMENT COLORS
  // ═══════════════════════════════════════════════════════════════
  static const Color achievementStreak = Color(0xFFFF6B35); // Orange flame
  static const Color achievementSavings = Color(0xFF2ECC71); // Green money
  static const Color achievementGoals = Color(0xFF9B59B6); // Purple target
  static const Color achievementTracker = Color(0xFF3498DB); // Blue notepad
  static const Color achievementMystery = Color(0xFFE91E63); // Pink mystery

  // ═══════════════════════════════════════════════════════════════
  // INCOME TYPE COLORS
  // ═══════════════════════════════════════════════════════════════
  static const Color incomeSalary = Color(0xFF6C63FF);
  static const Color incomeBonus = Color(0xFFFFD700);
  static const Color incomeFreelance = Color(0xFFE91E63);
  static const Color incomePassive = Color(0xFF4CAF50);
  static const Color incomeRental = Color(0xFF4ECDC4);
  static const Color incomeSideJob = Color(0xFFF39C12);
  static const Color incomeOther = Color(0xFF2ECC71);
  static const Color incomeDefault = Color(0xFF95A5A6);

  // ═══════════════════════════════════════════════════════════════
  // SOCIAL BRAND COLORS
  // ═══════════════════════════════════════════════════════════════
  static const Color instagram = Color(0xFFE4405F);
  static const Color facebook = Color(0xFF1877F2);
  static const Color twitter = Color(0xFF1DA1F2);
  static const Color whatsapp = Color(0xFF25D366);
  static const Color tiktok = Color(0xFF000000);
  static const Color snapchat = Color(0xFFFFFC00);
  static const Color youtube = Color(0xFFFF0000);

  // ═══════════════════════════════════════════════════════════════
  // MEDAL COLORS
  // ═══════════════════════════════════════════════════════════════
  static const Color medalBronze = Color(0xFFCD7F32);
  static const Color medalSilver = Color(0xFFC0C0C0);
  static const Color medalGold = Color(0xFFFFD700);
  static const Color medalPlatinum = Color(0xFFE5E4E2);

  // ═══════════════════════════════════════════════════════════════
  // SUBSCRIPTION COLORS - 8 predefined colors
  // ═══════════════════════════════════════════════════════════════
  static const List<Color> subscriptionColors = [
    Color(0xFFFF6B6B), // 0: Red
    Color(0xFF4ECDC4), // 1: Turquoise
    Color(0xFF6C63FF), // 2: Purple
    Color(0xFFFFD93D), // 3: Yellow
    Color(0xFFFF8C42), // 4: Orange
    Color(0xFF95E1D3), // 5: Mint
    Color(0xFFF38181), // 6: Pink
    Color(0xFF3D5A80), // 7: Navy
  ];

  // ═══════════════════════════════════════════════════════════════
  // CURRENCY & FINANCIAL COLORS
  // ═══════════════════════════════════════════════════════════════
  static const Color currencyPositive = Color(0xFF4CAF50);
  static const Color currencyNegative = Color(0xFFE74C3C);
  static const Color currencyNeutral = Color(0xFF2196F3);
  static const Color currencyGold = Color(0xFFFFB800);

  // ═══════════════════════════════════════════════════════════════
  // HEATMAP COLORS
  // ═══════════════════════════════════════════════════════════════
  static const Color heatmapNone = Color(0xFF1E1E2E);
  static const Color heatmapLow = Color(0xFF2D5016);
  static const Color heatmapMedium = Color(0xFF3D7017);
  static const Color heatmapHigh = Color(0xFF4CAF50);

  // ═══════════════════════════════════════════════════════════════
  // PREMIUM THEME COLORS (for paywall, etc.)
  // ═══════════════════════════════════════════════════════════════
  static const Color premiumPurple = Color(0xFF8B5CF6);
  static const Color premiumPurpleLight = Color(0xFFA78BFA);
  static const Color premiumPurpleDark = Color(0xFF6D28D9);
  static const Color premiumCyan = Color(0xFF06B6D4);
  static const Color premiumGreen = Color(0xFF00C853);

  // ═══════════════════════════════════════════════════════════════
  // MISC UI COLORS
  // ═══════════════════════════════════════════════════════════════
  static const Color divider = Color(0xFF2D2440);
  static const Color shimmer = Color(0xFF2D2440);
  static const Color overlay = Color(0x80000000);

  // ═══════════════════════════════════════════════════════════════
  // ADDITIONAL UI COLORS
  // ═══════════════════════════════════════════════════════════════
  static const Color urgentOrange = Color(0xFFFF8C42);
  static const Color dangerRed = Color(0xFFB71C1C);
  static const Color dangerRedDark = Color(0xFFC0392B);
  static const Color dangerGradientStart = Color(0xFF4A1C1C);
  static const Color dangerGradientEnd = Color(0xFF2D1010);
  static const Color orange = Color(0xFFFFA500);
  static const Color coffeeColor = Color(0xFF8B4513);
  static const Color smokingGray = Color(0xFF607D8B);

  // ═══════════════════════════════════════════════════════════════
  // ADDITIONAL CATEGORY COLORS
  // ═══════════════════════════════════════════════════════════════
  static const Color categorySportsGreen = Color(0xFF8BC34A);
  static const Color categoryDigitalCyan = Color(0xFF00BCD4);
  static const Color categoryShoppingPink = Color(0xFFE91E63);
  static const Color categoryCommGray = Color(0xFF607D8B);

  // ═══════════════════════════════════════════════════════════════
  // ACHIEVEMENT ICON COLORS
  // ═══════════════════════════════════════════════════════════════
  static const Color achievementYellow = Color(0xFFFBBF24);
  static const Color achievementOrange = Color(0xFFF97316);
  static const Color achievementSkyBlue = Color(0xFF8ED1FC);
  static const Color achievementLavender = Color(0xFFB4A7D6);
}

/// Premium Gradients
class AppGradients {
  AppGradients._();

  /// Sayfa arka plan gradienti
  static const LinearGradient background = LinearGradient(
    begin: Alignment.topLeft,
    end: Alignment.bottomRight,
    colors: [
      AppColors.gradientStart,
      AppColors.gradientMid,
      AppColors.gradientEnd,
    ],
  );

  /// Primary buton gradienti (mor → turkuaz)
  static const LinearGradient primaryButton = LinearGradient(
    begin: Alignment.centerLeft,
    end: Alignment.centerRight,
    colors: [AppColors.primary, AppColors.secondary],
  );

  /// Progress bar gradienti
  static const LinearGradient progress = LinearGradient(
    colors: [AppColors.primary, AppColors.secondary],
  );

  /// Success gradienti
  static const LinearGradient success = LinearGradient(
    colors: [AppColors.secondary, Color(0xFF3DBDB5)],
  );

  /// Premium Card Gradient (mor → mavi)
  static const LinearGradient premiumCard = LinearGradient(
    begin: Alignment.topLeft,
    end: Alignment.bottomRight,
    colors: [
      Color(0xFF2A2545), // Koyu mor
      Color(0xFF1E293B), // Koyu mavi
    ],
  );

  /// Premium Card Gradient Light variant
  static const LinearGradient premiumCardLight = LinearGradient(
    begin: Alignment.topLeft,
    end: Alignment.bottomRight,
    colors: [
      Color(0xFF3D3560), // Orta mor
      Color(0xFF2D3A50), // Orta mavi
    ],
  );

  /// Subtle card overlay gradient
  static const LinearGradient cardOverlay = LinearGradient(
    begin: Alignment.topCenter,
    end: Alignment.bottomCenter,
    colors: [
      Color(0x10FFFFFF), // %6 beyaz
      Color(0x00FFFFFF), // Şeffaf
    ],
  );

  /// Expense card gradient
  static const LinearGradient expenseCard = LinearGradient(
    begin: Alignment.topLeft,
    end: Alignment.bottomRight,
    colors: [
      Color(0xFF252540), // Mor-gri
      Color(0xFF1A1A2E), // Koyu
    ],
  );

  /// Primary gradient alias (same as primaryButton)
  static const LinearGradient primary = primaryButton;

  /// Error gradient
  static const LinearGradient error = LinearGradient(
    begin: Alignment.topLeft,
    end: Alignment.bottomRight,
    colors: [AppColors.error, Color(0xFFFF6B81)],
  );

  /// Warning gradient
  static const LinearGradient warning = LinearGradient(
    begin: Alignment.topLeft,
    end: Alignment.bottomRight,
    colors: [AppColors.warning, Color(0xFFFF9500)],
  );

  /// Card gradient (glassmorphism)
  static const LinearGradient card = LinearGradient(
    begin: Alignment.topLeft,
    end: Alignment.bottomRight,
    colors: [Color(0x0DFFFFFF), Color(0x05FFFFFF)],
  );
}

/// Premium Design Tokens (Revolut Style)
class AppDesign {
  AppDesign._();

  // Border Radius (8pt Grid)
  static const double radiusSmall = 8.0; // Küçük butonlar, chips
  static const double radiusMedium = 12.0; // Input fields, küçük kartlar
  static const double radiusLarge = 16.0; // Normal kartlar
  static const double radiusXLarge = 20.0; // Büyük kartlar
  static const double radiusXXLarge = 24.0; // Modal, bottom sheet
  static const double radiusFull = 999.0; // Pill shape

  // Spacing (8pt Grid System)
  static const double spacing4 = 4.0; // Micro
  static const double spacingXs = 8.0; // Small
  static const double spacingSm = 12.0; // Medium-small
  static const double spacingMd = 16.0; // Medium (default card padding)
  static const double spacingLg = 20.0; // Medium-large
  static const double spacingXl = 24.0; // Large
  static const double spacingXxl = 32.0; // XL
  static const double spacing48 = 48.0; // XXL

  // Screen & Card Padding
  static const EdgeInsets screenPadding = EdgeInsets.symmetric(horizontal: 20);
  static const EdgeInsets cardPadding = EdgeInsets.all(16);
  static const EdgeInsets cardPaddingLarge = EdgeInsets.all(20);

  // Transaction Item Dimensions
  static const double iconContainerSize = 44.0;
  static const double iconContainerRadius = 14.0;
  static const double iconSize = 22.0;

  // Subtle Shadow (kartlar için - Revolut style)
  static List<BoxShadow> get shadowSubtle => [
        BoxShadow(
          color: Colors.black.withValues(alpha: 0.12),
          blurRadius: 20,
          offset: const Offset(0, 4),
        ),
      ];

  // Medium Shadow (elevated cards - soft)
  static List<BoxShadow> get shadowMedium => [
        BoxShadow(
          color: Colors.black.withValues(alpha: 0.2),
          blurRadius: 20,
          offset: const Offset(0, 8),
        ),
      ];

  // Card Shadow (premium cards)
  static List<BoxShadow> get cardShadow => [
        BoxShadow(
          color: Colors.black.withValues(alpha: 0.2),
          blurRadius: 20,
          offset: const Offset(0, 10),
        ),
      ];

  // Premium Card Shadow (with purple glow)
  static List<BoxShadow> get premiumCardShadow => [
        BoxShadow(
          color: Colors.black.withValues(alpha: 0.2),
          blurRadius: 20,
          offset: const Offset(0, 10),
        ),
      ];

  // ========== CARD DECORATIONS ==========

  /// Standard card border
  static Border get cardBorder => Border.all(
        color: Colors.white.withValues(alpha: 0.06),
        width: 1,
      );

  /// Small card decoration (borderRadius: 16)
  static BoxDecoration cardDecorationSmall(Color surfaceColor) => BoxDecoration(
        color: surfaceColor,
        borderRadius: BorderRadius.circular(16),
        border: cardBorder,
        boxShadow: shadowMedium,
      );

  /// Large card decoration (borderRadius: 20)
  static BoxDecoration cardDecorationLarge(Color surfaceColor) => BoxDecoration(
        color: surfaceColor,
        borderRadius: BorderRadius.circular(20),
        border: cardBorder,
        boxShadow: shadowMedium,
      );

  // Primary Glow Effect
  static List<BoxShadow> primaryGlow(Color primary) => [
        BoxShadow(
          color: primary.withValues(alpha: 0.25),
          blurRadius: 20,
          spreadRadius: -5,
        ),
      ];

  // Primary Button Shadow (for elevated buttons)
  static List<BoxShadow> primaryButtonShadow(Color primary) => [
        BoxShadow(
          color: primary.withValues(alpha: 0.35),
          blurRadius: 16,
          offset: const Offset(0, 8),
        ),
      ];

  // Typography (Revolut Style)
  static const double fontSizeCaption = 12.0;
  static const double fontSizeBody = 15.0;
  static const double fontSizeSectionTitle = 13.0;
  static const double fontSizeTitle = 16.0;
  static const double fontSizeHeadline = 24.0;
  static const double fontSizeLargeNumber = 48.0;

  // Legacy support
  static const double fontSizeXs = 10.0;
  static const double fontSizeSm = 12.0;
  static const double fontSizeMd = 14.0;
  static const double fontSizeLg = 16.0;
  static const double fontSizeXl = 20.0;
  static const double fontSizeXxl = 28.0;
  static const double fontSizeDisplay = 32.0;

  // Animation Durations
  static const Duration animationFast = Duration(milliseconds: 150);
  static const Duration animationNormal = Duration(milliseconds: 250);
  static const Duration animationSlow = Duration(milliseconds: 400);

  // Standard Curve
  static const Curve animationCurve = Curves.easeOutCubic;

  // ========== MODAL/SHEET STYLING ==========

  /// Sheet border radius
  static const double sheetBorderRadius = 24.0;

  /// Sheet handle bar dimensions
  static const double handleBarWidth = 40.0;
  static const double handleBarHeight = 4.0;
  static const double handleBarRadius = 2.0;

  /// Standard sheet decoration
  static BoxDecoration sheetDecoration(Color surfaceColor) => BoxDecoration(
        color: surfaceColor.withValues(alpha: 0.95),
        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
      );

  /// Standard handle bar decoration
  static BoxDecoration handleBarDecoration(Color textTertiaryColor) =>
      BoxDecoration(
        color: textTertiaryColor.withValues(alpha: 0.3),
        borderRadius: BorderRadius.circular(2),
      );
}

/// Premium Font Families - iOS HIG Compliant
/// Uses system fonts (SF Pro on iOS, Roboto on Android)
class AppFonts {
  AppFonts._();

  /// System font for headings (SF Pro Display on iOS)
  static String? get heading => null; // Uses system default

  /// System font for body text (SF Pro Text on iOS)
  static String? get body => null; // Uses system default

  /// System monospace font (Menlo on iOS, Roboto Mono on Android)
  static String get mono => Platform.isIOS ? 'Menlo' : 'Roboto Mono';

  /// Font fallback list for Turkish character support
  /// These system fonts are used when characters (ı, ğ, ü, ş, ö, ç, İ) are missing
  static const List<String> fontFallback = [
    'SF Pro Display', // iOS
    'Roboto', // Android
    'Segoe UI', // Windows
    'Apple Color Emoji', // Emoji support
    'Noto Sans', // Universal fallback
  ];

  /// Create TextStyle with Turkish character fallback
  static TextStyle withFallback(TextStyle style) {
    return style.copyWith(fontFamilyFallback: fontFallback);
  }

  /// Apply font fallback to entire TextTheme
  static TextTheme applyFallbackToTextTheme(TextTheme textTheme) {
    return TextTheme(
      displayLarge: textTheme.displayLarge?.copyWith(
        fontFamilyFallback: fontFallback,
      ),
      displayMedium: textTheme.displayMedium?.copyWith(
        fontFamilyFallback: fontFallback,
      ),
      displaySmall: textTheme.displaySmall?.copyWith(
        fontFamilyFallback: fontFallback,
      ),
      headlineLarge: textTheme.headlineLarge?.copyWith(
        fontFamilyFallback: fontFallback,
      ),
      headlineMedium: textTheme.headlineMedium?.copyWith(
        fontFamilyFallback: fontFallback,
      ),
      headlineSmall: textTheme.headlineSmall?.copyWith(
        fontFamilyFallback: fontFallback,
      ),
      titleLarge: textTheme.titleLarge?.copyWith(
        fontFamilyFallback: fontFallback,
      ),
      titleMedium: textTheme.titleMedium?.copyWith(
        fontFamilyFallback: fontFallback,
      ),
      titleSmall: textTheme.titleSmall?.copyWith(
        fontFamilyFallback: fontFallback,
      ),
      bodyLarge: textTheme.bodyLarge?.copyWith(
        fontFamilyFallback: fontFallback,
      ),
      bodyMedium: textTheme.bodyMedium?.copyWith(
        fontFamilyFallback: fontFallback,
      ),
      bodySmall: textTheme.bodySmall?.copyWith(
        fontFamilyFallback: fontFallback,
      ),
      labelLarge: textTheme.labelLarge?.copyWith(
        fontFamilyFallback: fontFallback,
      ),
      labelMedium: textTheme.labelMedium?.copyWith(
        fontFamilyFallback: fontFallback,
      ),
      labelSmall: textTheme.labelSmall?.copyWith(
        fontFamilyFallback: fontFallback,
      ),
    );
  }
}

class AppTheme {
  /// Light theme for the app
  static ThemeData get lightTheme {
    final headingFont = AppFonts.heading;
    final bodyFont = AppFonts.body;

    return ThemeData(
      useMaterial3: true,
      brightness: Brightness.light,
      fontFamily: bodyFont,
      scaffoldBackgroundColor: AppColorsLight.background,
      colorScheme: const ColorScheme.light(
        surface: AppColorsLight.background,
        primary: AppColorsLight.primary,
        secondary: AppColorsLight.secondary,
        error: AppColorsLight.error,
      ),
      appBarTheme: const AppBarTheme(
        backgroundColor: Colors.transparent,
        elevation: 0,
        scrolledUnderElevation: 0,
        centerTitle: false,
        titleTextStyle: TextStyle(
          color: AppColorsLight.textPrimary,
          fontSize: 28,
          fontWeight: FontWeight.w700,
          letterSpacing: -0.5,
        ),
        iconTheme: IconThemeData(color: AppColorsLight.textPrimary, size: 24),
        systemOverlayStyle: SystemUiOverlayStyle(
          statusBarColor: Colors.transparent,
          statusBarIconBrightness: Brightness.dark,
          systemNavigationBarColor: AppColorsLight.background,
          systemNavigationBarIconBrightness: Brightness.dark,
        ),
      ),
      cardTheme: CardThemeData(
        color: AppColorsLight.cardBackground,
        elevation: 2,
        shadowColor: AppColorsLight.cardShadow,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(20),
          side: const BorderSide(color: AppColorsLight.cardBorder, width: 1),
        ),
        margin: EdgeInsets.zero,
      ),
      elevatedButtonTheme: ElevatedButtonThemeData(
        style: ElevatedButton.styleFrom(
          backgroundColor: AppColorsLight.primary,
          foregroundColor: Colors.white,
          elevation: 0,
          padding: const EdgeInsets.symmetric(horizontal: 32, vertical: 16),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(16),
          ),
          textStyle: const TextStyle(
            fontSize: 16,
            fontWeight: FontWeight.w600,
            letterSpacing: 0.5,
          ),
        ),
      ),
      textButtonTheme: TextButtonThemeData(
        style: TextButton.styleFrom(
          foregroundColor: AppColorsLight.textSecondary,
          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
          textStyle: const TextStyle(fontSize: 14, fontWeight: FontWeight.w500),
        ),
      ),
      inputDecorationTheme: InputDecorationTheme(
        filled: true,
        fillColor: AppColorsLight.surfaceLight,
        contentPadding: const EdgeInsets.symmetric(
          horizontal: 20,
          vertical: 18,
        ),
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(16),
          borderSide: const BorderSide(color: AppColorsLight.cardBorder),
        ),
        enabledBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(16),
          borderSide: const BorderSide(color: AppColorsLight.cardBorder),
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(16),
          borderSide: const BorderSide(color: AppColorsLight.primary, width: 2),
        ),
        errorBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(16),
          borderSide: const BorderSide(color: AppColorsLight.error),
        ),
        labelStyle: const TextStyle(
          color: AppColorsLight.textSecondary,
          fontSize: 14,
          fontWeight: FontWeight.w500,
        ),
        hintStyle: const TextStyle(
          color: AppColorsLight.textTertiary,
          fontSize: 16,
        ),
      ),
      bottomSheetTheme: const BottomSheetThemeData(
        backgroundColor: AppColorsLight.cardBackground,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
        ),
      ),
      snackBarTheme: SnackBarThemeData(
        backgroundColor: AppColorsLight.textPrimary,
        contentTextStyle: const TextStyle(color: Colors.white, fontSize: 14),
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
        behavior: SnackBarBehavior.floating,
      ),
      dividerTheme: const DividerThemeData(
        color: AppColorsLight.cardBorder,
        thickness: 1,
      ),
      textTheme: TextTheme(
        displayLarge: TextStyle(
          fontFamily: headingFont,
          fontSize: 56,
          fontWeight: FontWeight.w700,
          color: AppColorsLight.textPrimary,
          letterSpacing: -2,
        ),
        displayMedium: TextStyle(
          fontFamily: headingFont,
          fontSize: 48,
          fontWeight: FontWeight.w700,
          color: AppColorsLight.textPrimary,
          letterSpacing: -1,
        ),
        displaySmall: TextStyle(
          fontFamily: headingFont,
          fontSize: 32,
          fontWeight: FontWeight.w600,
          color: AppColorsLight.textPrimary,
          letterSpacing: -0.5,
        ),
        headlineLarge: TextStyle(
          fontFamily: headingFont,
          fontSize: 32,
          fontWeight: FontWeight.w700,
          color: AppColorsLight.textPrimary,
          letterSpacing: -1,
        ),
        headlineMedium: TextStyle(
          fontFamily: headingFont,
          fontSize: 28,
          fontWeight: FontWeight.w700,
          color: AppColorsLight.textPrimary,
          letterSpacing: -0.5,
        ),
        headlineSmall: TextStyle(
          fontFamily: headingFont,
          fontSize: 24,
          fontWeight: FontWeight.w600,
          color: AppColorsLight.textPrimary,
        ),
        titleLarge: TextStyle(
          fontFamily: headingFont,
          fontSize: 18,
          fontWeight: FontWeight.w600,
          color: AppColorsLight.textPrimary,
        ),
        titleMedium: TextStyle(
          fontFamily: headingFont,
          fontSize: 16,
          fontWeight: FontWeight.w600,
          color: AppColorsLight.textPrimary,
        ),
        titleSmall: TextStyle(
          fontFamily: headingFont,
          fontSize: 14,
          fontWeight: FontWeight.w500,
          color: AppColorsLight.textSecondary,
        ),
        bodyLarge: TextStyle(
          fontFamily: bodyFont,
          fontSize: 16,
          fontWeight: FontWeight.w400,
          color: AppColorsLight.textPrimary,
        ),
        bodyMedium: TextStyle(
          fontFamily: bodyFont,
          fontSize: 14,
          fontWeight: FontWeight.w400,
          color: AppColorsLight.textSecondary,
        ),
        bodySmall: TextStyle(
          fontFamily: bodyFont,
          fontSize: 13,
          fontWeight: FontWeight.w400,
          color: AppColorsLight.textSecondary,
        ),
        labelLarge: TextStyle(
          fontFamily: bodyFont,
          fontSize: 14,
          fontWeight: FontWeight.w600,
          color: AppColorsLight.textPrimary,
        ),
        labelMedium: TextStyle(
          fontFamily: bodyFont,
          fontSize: 12,
          fontWeight: FontWeight.w500,
          color: AppColorsLight.textSecondary,
          letterSpacing: 1.5,
        ),
        labelSmall: TextStyle(
          fontFamily: bodyFont,
          fontSize: 11,
          fontWeight: FontWeight.w500,
          color: AppColorsLight.textSecondary,
          letterSpacing: 2,
        ),
      ),
      pageTransitionsTheme: const PageTransitionsTheme(
        builders: {
          TargetPlatform.android: _PremiumPageTransitionsBuilder(),
          TargetPlatform.iOS: _PremiumPageTransitionsBuilder(),
          TargetPlatform.windows: _PremiumPageTransitionsBuilder(),
          TargetPlatform.macOS: _PremiumPageTransitionsBuilder(),
          TargetPlatform.linux: _PremiumPageTransitionsBuilder(),
        },
      ),
    );
  }

  static ThemeData get darkTheme {
    final headingFont = AppFonts.heading;
    final bodyFont = AppFonts.body;

    return ThemeData(
      useMaterial3: true,
      brightness: Brightness.dark,
      fontFamily: bodyFont, // DM Sans as default
      scaffoldBackgroundColor: AppColors.background,
      colorScheme: const ColorScheme.dark(
        surface: AppColors.background,
        primary: AppColors.primary,
        secondary: AppColors.secondary,
        error: AppColors.error,
      ),
      appBarTheme: const AppBarTheme(
        backgroundColor: Colors.transparent,
        elevation: 0,
        scrolledUnderElevation: 0,
        centerTitle: false,
        titleTextStyle: TextStyle(
          color: AppColors.textPrimary,
          fontSize: 28,
          fontWeight: FontWeight.w700,
          letterSpacing: -0.5,
        ),
        iconTheme: IconThemeData(color: AppColors.textPrimary, size: 24),
        systemOverlayStyle: SystemUiOverlayStyle(
          statusBarColor: Colors.transparent,
          statusBarIconBrightness: Brightness.light,
          systemNavigationBarColor: AppColors.background,
        ),
      ),
      cardTheme: CardThemeData(
        color: AppColors.cardBackground,
        elevation: 0,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(20),
          side: const BorderSide(color: AppColors.cardBorder, width: 1),
        ),
        margin: EdgeInsets.zero,
      ),
      elevatedButtonTheme: ElevatedButtonThemeData(
        style: ElevatedButton.styleFrom(
          backgroundColor: AppColors.primary,
          foregroundColor: Colors.white,
          elevation: 0,
          minimumSize: const Size(double.infinity, 56),
          padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(14),
          ),
          textStyle: const TextStyle(
            fontSize: 16,
            fontWeight: FontWeight.w600,
            letterSpacing: -0.2,
          ),
        ),
      ),
      textButtonTheme: TextButtonThemeData(
        style: TextButton.styleFrom(
          foregroundColor: AppColors.textSecondary,
          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
          textStyle: const TextStyle(fontSize: 14, fontWeight: FontWeight.w500),
        ),
      ),
      outlinedButtonTheme: OutlinedButtonThemeData(
        style: OutlinedButton.styleFrom(
          foregroundColor: AppColors.textPrimary,
          backgroundColor: Colors.transparent,
          elevation: 0,
          minimumSize: const Size(double.infinity, 56),
          padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(14),
          ),
          side: BorderSide(
            color: Colors.white.withValues(alpha: 0.12),
            width: 1.5,
          ),
          textStyle: const TextStyle(
            fontSize: 16,
            fontWeight: FontWeight.w600,
            letterSpacing: -0.2,
          ),
        ),
      ),
      inputDecorationTheme: InputDecorationTheme(
        filled: true,
        fillColor: AppColors.surfaceLight,
        contentPadding: const EdgeInsets.symmetric(
          horizontal: 16,
          vertical: 16,
        ),
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: BorderSide.none,
        ),
        enabledBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: BorderSide(
            color: Colors.white.withValues(alpha: 0.06),
            width: 1,
          ),
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: BorderSide(
            color: AppColors.primary.withValues(alpha: 0.5),
            width: 1.5,
          ),
        ),
        errorBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: const BorderSide(color: AppColors.error),
        ),
        labelStyle: const TextStyle(
          color: AppColors.textSecondary,
          fontSize: 14,
          fontWeight: FontWeight.w500,
        ),
        hintStyle: const TextStyle(color: AppColors.textTertiary, fontSize: 15),
      ),
      bottomSheetTheme: const BottomSheetThemeData(
        backgroundColor: AppColors.gradientMid,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
        ),
      ),
      snackBarTheme: SnackBarThemeData(
        backgroundColor: AppColors.surfaceLighter,
        contentTextStyle: const TextStyle(
          color: AppColors.textPrimary,
          fontSize: 14,
        ),
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
        behavior: SnackBarBehavior.floating,
      ),
      dividerTheme: const DividerThemeData(
        color: AppColors.cardBorder,
        thickness: 1,
      ),
      // Premium TextTheme with Space Grotesk for numbers/headings, DM Sans for body
      textTheme: TextTheme(
        // Display styles - Space Grotesk (for large numbers)
        displayLarge: TextStyle(
          fontFamily: headingFont,
          fontSize: 56,
          fontWeight: FontWeight.w700,
          color: AppColors.textPrimary,
          letterSpacing: -2,
        ),
        displayMedium: TextStyle(
          fontFamily: headingFont,
          fontSize: 48,
          fontWeight: FontWeight.w700,
          color: AppColors.textPrimary,
          letterSpacing: -1,
        ),
        displaySmall: TextStyle(
          fontFamily: headingFont,
          fontSize: 32,
          fontWeight: FontWeight.w600,
          color: AppColors.textPrimary,
          letterSpacing: -0.5,
        ),
        // Headline styles - Space Grotesk
        headlineLarge: TextStyle(
          fontFamily: headingFont,
          fontSize: 32,
          fontWeight: FontWeight.w700,
          color: AppColors.textPrimary,
          letterSpacing: -1,
        ),
        headlineMedium: TextStyle(
          fontFamily: headingFont,
          fontSize: 28,
          fontWeight: FontWeight.w700,
          color: AppColors.textPrimary,
          letterSpacing: -0.5,
        ),
        headlineSmall: TextStyle(
          fontFamily: headingFont,
          fontSize: 24,
          fontWeight: FontWeight.w600,
          color: AppColors.textPrimary,
        ),
        // Title styles - Space Grotesk (for section headers)
        titleLarge: TextStyle(
          fontFamily: headingFont,
          fontSize: 18,
          fontWeight: FontWeight.w600,
          color: AppColors.textPrimary,
        ),
        titleMedium: TextStyle(
          fontFamily: headingFont,
          fontSize: 16,
          fontWeight: FontWeight.w600,
          color: AppColors.textPrimary,
        ),
        titleSmall: TextStyle(
          fontFamily: headingFont,
          fontSize: 14,
          fontWeight: FontWeight.w500,
          color: AppColors.textSecondary,
        ),
        // Body styles - DM Sans (for readable text)
        bodyLarge: TextStyle(
          fontFamily: bodyFont,
          fontSize: 16,
          fontWeight: FontWeight.w400,
          color: AppColors.textPrimary,
        ),
        bodyMedium: TextStyle(
          fontFamily: bodyFont,
          fontSize: 14,
          fontWeight: FontWeight.w400,
          color: AppColors.textSecondary,
        ),
        bodySmall: TextStyle(
          fontFamily: bodyFont,
          fontSize: 13,
          fontWeight: FontWeight.w400,
          color: AppColors.textSecondary,
        ),
        // Label styles - DM Sans
        labelLarge: TextStyle(
          fontFamily: bodyFont,
          fontSize: 14,
          fontWeight: FontWeight.w600,
          color: AppColors.textPrimary,
        ),
        labelMedium: TextStyle(
          fontFamily: bodyFont,
          fontSize: 12,
          fontWeight: FontWeight.w500,
          color: AppColors.textSecondary,
          letterSpacing: 1.5,
        ),
        labelSmall: TextStyle(
          fontFamily: bodyFont,
          fontSize: 11,
          fontWeight: FontWeight.w500,
          color: AppColors.textSecondary,
          letterSpacing: 2,
        ),
      ),
      // Premium page transitions - 350ms easeInOutCubic
      pageTransitionsTheme: const PageTransitionsTheme(
        builders: {
          TargetPlatform.android: _PremiumPageTransitionsBuilder(),
          TargetPlatform.iOS: _PremiumPageTransitionsBuilder(),
          TargetPlatform.windows: _PremiumPageTransitionsBuilder(),
          TargetPlatform.macOS: _PremiumPageTransitionsBuilder(),
          TargetPlatform.linux: _PremiumPageTransitionsBuilder(),
        },
      ),
    );
  }
}

/// Premium Page Transition Builder
/// 350ms easeInOutCubic slide + fade transition
class _PremiumPageTransitionsBuilder extends PageTransitionsBuilder {
  const _PremiumPageTransitionsBuilder();

  @override
  Widget buildTransitions<T>(
    PageRoute<T> route,
    BuildContext context,
    Animation<double> animation,
    Animation<double> secondaryAnimation,
    Widget child,
  ) {
    return _PremiumPageTransition(
      animation: animation,
      secondaryAnimation: secondaryAnimation,
      child: child,
    );
  }
}

class _PremiumPageTransition extends StatelessWidget {
  final Animation<double> animation;
  final Animation<double> secondaryAnimation;
  final Widget child;

  const _PremiumPageTransition({
    required this.animation,
    required this.secondaryAnimation,
    required this.child,
  });

  @override
  Widget build(BuildContext context) {
    // Fade + Slide transition
    final fadeAnimation = CurvedAnimation(
      parent: animation,
      curve: Curves.easeInOutCubic,
    );

    final slideAnimation = Tween<Offset>(
      begin: const Offset(0.15, 0),
      end: Offset.zero,
    ).animate(CurvedAnimation(parent: animation, curve: Curves.easeInOutCubic));

    // Secondary animation for existing page (slight fade)
    final secondaryFade = Tween<double>(begin: 1.0, end: 0.95).animate(
      CurvedAnimation(parent: secondaryAnimation, curve: Curves.easeInOutCubic),
    );

    return FadeTransition(
      opacity: fadeAnimation,
      child: SlideTransition(
        position: slideAnimation,
        child: FadeTransition(opacity: secondaryFade, child: child),
      ),
    );
  }
}

/// Premium modal route for bottom sheets and dialogs
/// 300ms easeOutCubic shared axis transition
class PremiumModalRoute<T> extends PageRouteBuilder<T> {
  final Widget page;

  PremiumModalRoute({required this.page})
    : super(
        pageBuilder: (context, animation, secondaryAnimation) => page,
        transitionDuration: const Duration(milliseconds: 300),
        reverseTransitionDuration: const Duration(milliseconds: 250),
        transitionsBuilder: (context, animation, secondaryAnimation, child) {
          final curvedAnimation = CurvedAnimation(
            parent: animation,
            curve: Curves.easeOutCubic,
            reverseCurve: Curves.easeInCubic,
          );

          return FadeTransition(
            opacity: curvedAnimation,
            child: SlideTransition(
              position: Tween<Offset>(
                begin: const Offset(0, 0.1),
                end: Offset.zero,
              ).animate(curvedAnimation),
              child: child,
            ),
          );
        },
      );
}

// ═══════════════════════════════════════════════════════════════════════════
// LIGHT MODE COLORS
// ═══════════════════════════════════════════════════════════════════════════

// ═══════════════════════════════════════════════════════════════════════════
// THEME-AWARE COLOR HELPER
// ═══════════════════════════════════════════════════════════════════════════

/// Extension to get theme-aware colors from BuildContext
/// Usage: context.appColors.background, context.appColors.textPrimary, etc.
extension AppColorsExtension on BuildContext {
  /// Get colors based on current theme (dark/light)
  _ThemeColors get appColors {
    final isDark = Theme.of(this).brightness == Brightness.dark;
    return _ThemeColors(isDark);
  }

  /// Check if current theme is dark
  bool get isDarkMode => Theme.of(this).brightness == Brightness.dark;
}

/// Theme-aware color container
class _ThemeColors {
  final bool _isDark;
  const _ThemeColors(this._isDark);

  // Backgrounds
  Color get background =>
      _isDark ? AppColors.background : AppColorsLight.background;
  Color get cardBackground =>
      _isDark ? AppColors.cardBackground : AppColorsLight.cardBackground;
  Color get surfaceElevated =>
      _isDark ? AppColors.surfaceElevated : AppColorsLight.surfaceElevated;
  Color get surface => _isDark ? AppColors.surface : AppColorsLight.surface;
  Color get surfaceLight =>
      _isDark ? AppColors.surfaceLight : AppColorsLight.surfaceLight;
  Color get surfaceLighter =>
      _isDark ? AppColors.surfaceLighter : AppColorsLight.surfaceLighter;

  // Gradient colors
  Color get gradientStart =>
      _isDark ? AppColors.gradientStart : AppColorsLight.gradientStart;
  Color get gradientMid =>
      _isDark ? AppColors.gradientMid : AppColorsLight.gradientMid;
  Color get gradientEnd =>
      _isDark ? AppColors.gradientEnd : AppColorsLight.gradientEnd;

  // Primary colors (same in both themes)
  Color get primary => AppColors.primary;
  Color get primaryDark => AppColors.primaryDark;
  Color get primaryLight => AppColors.primaryLight;
  Color get secondary => AppColors.secondary;
  Color get accent => AppColors.accent;
  Color get gold => AppColors.gold;

  // Text colors
  Color get textPrimary =>
      _isDark ? AppColors.textPrimary : AppColorsLight.textPrimary;
  Color get textSecondary =>
      _isDark ? AppColors.textSecondary : AppColorsLight.textSecondary;
  Color get textTertiary =>
      _isDark ? AppColors.textTertiary : AppColorsLight.textTertiary;

  // Status colors
  Color get success => _isDark ? AppColors.success : AppColorsLight.success;
  Color get warning => _isDark ? AppColors.warning : AppColorsLight.warning;
  Color get error => _isDark ? AppColors.error : AppColorsLight.error;
  Color get info => _isDark ? AppColors.info : AppColorsLight.info;

  // Decision colors
  Color get decisionYes =>
      _isDark ? AppColors.decisionYes : AppColorsLight.decisionYes;
  Color get decisionThinking =>
      _isDark ? AppColors.decisionThinking : AppColorsLight.decisionThinking;
  Color get decisionNo =>
      _isDark ? AppColors.decisionNo : AppColorsLight.decisionNo;

  // Card colors
  Color get cardBackgroundGlass => _isDark
      ? AppColors.cardBackgroundGlass
      : AppColorsLight.cardBackgroundGlass;
  Color get cardBorder =>
      _isDark ? AppColors.cardBorder : AppColorsLight.cardBorder;
  Color get cardShadow =>
      _isDark ? AppColors.cardShadow : AppColorsLight.cardShadow;

  // Background gradient
  LinearGradient get backgroundGradient => LinearGradient(
    begin: Alignment.topLeft,
    end: Alignment.bottomRight,
    colors: [gradientStart, gradientMid, gradientEnd],
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// LIGHT MODE COLORS
// ═══════════════════════════════════════════════════════════════════════════

/// Light Mode Color Palette - iOS 26 Liquid Glass Premium White
class AppColorsLight {
  AppColorsLight._();

  // ─────────────────────────────────────────────────────────────────
  // BACKGROUNDS (Premium White)
  // ─────────────────────────────────────────────────────────────────

  /// Main background
  static const Color background = Color(0xFFF8FAFC);

  /// Card background - Pure white
  static const Color cardBackground = Color(0xFFFFFFFF);

  /// Elevated surface
  static const Color surfaceElevated = Color(0xFFF1F5F9);

  /// Gradient colors
  static const Color gradientStart = Color(0xFFF8FAFC);
  static const Color gradientMid = Color(0xFFFFFFFF);
  static const Color gradientEnd = Color(0xFFF1F5F9);

  // Surface colors
  static const Color surface = Color(0xFFFFFFFF);
  static const Color surfaceLight = Color(0xFFF1F5F9);
  static const Color surfaceLighter = Color(0xFFE2E8F0);

  // ─────────────────────────────────────────────────────────────────
  // PRIMARY COLORS (Same purple for consistency)
  // ─────────────────────────────────────────────────────────────────

  static const Color primary = Color(0xFF8B5CF6);
  static const Color primaryDark = Color(0xFF7C3AED);
  static const Color primaryLight = Color(0xFFC4B5FD);

  /// Secondary - Cyan
  static const Color secondary = Color(0xFF06B6D4);
  static const Color secondaryDark = Color(0xFF0891B2);
  static const Color secondaryLight = Color(0xFF22D3EE);

  /// Accent - Gold
  static const Color accent = Color(0xFFF59E0B);
  static const Color gold = Color(0xFFF59E0B);

  // ─────────────────────────────────────────────────────────────────
  // TEXT COLORS
  // ─────────────────────────────────────────────────────────────────

  static const Color textPrimary = Color(0xFF0F172A);
  static const Color textSecondary = Color(0xFF475569);
  static const Color textTertiary = Color(0xFF94A3B8);

  // ─────────────────────────────────────────────────────────────────
  // STATUS COLORS
  // ─────────────────────────────────────────────────────────────────

  static const Color success = Color(0xFF10B981);
  static const Color warning = Color(0xFFF59E0B);
  static const Color error = Color(0xFFEF4444);
  static const Color info = Color(0xFF3B82F6);

  // ─────────────────────────────────────────────────────────────────
  // DECISION COLORS
  // ─────────────────────────────────────────────────────────────────

  static const Color decisionYes = Color(0xFFF87171);
  static const Color decisionThinking = Color(0xFFFBBF24);
  static const Color decisionNo = Color(0xFF06B6D4);

  // ─────────────────────────────────────────────────────────────────
  // GLASS EFFECTS (for light mode)
  // ─────────────────────────────────────────────────────────────────

  static const Color glassBlack = Color(0x08000000);
  static const Color glassBorder = Color(0x15000000);
  static const Color cardBackgroundGlass = Color(0xFFFFFFFF);
  static const Color cardBorder = Color(0xFFE2E8F0);
  static const Color cardShadow = Color(0x15000000);
}


--- FILE: lib/theme/app_spacing.dart ---

import 'package:flutter/material.dart';

/// Spacing System - 8px Grid
/// All spacing values should be multiples of 8px
/// Inspired by Material Design & Tailwind CSS spacing scale
class Spacing {
  Spacing._();

  // ═══════════════════════════════════════════════════════
  // BASE SPACING VALUES (8px grid)
  // ═══════════════════════════════════════════════════════

  /// 4px - Extra small (half step)
  static const double xs = 4;

  /// 8px - Small
  static const double sm = 8;

  /// 12px - Medium small (1.5 step)
  static const double md = 12;

  /// 16px - Medium (2 steps)
  static const double lg = 16;

  /// 20px - Medium large (2.5 steps)
  static const double xl = 20;

  /// 24px - Large (3 steps)
  static const double xxl = 24;

  /// 32px - Extra large (4 steps)
  static const double xxxl = 32;

  /// 40px - 2XL (5 steps)
  static const double x4l = 40;

  /// 48px - 3XL (6 steps)
  static const double x5l = 48;

  // ═══════════════════════════════════════════════════════
  // SEMANTIC SPACING
  // ═══════════════════════════════════════════════════════

  /// Screen horizontal padding
  static const double screenHorizontal = 24;

  /// Screen vertical padding
  static const double screenVertical = 16;

  /// Card internal padding
  static const double cardPadding = 20;

  /// Section spacing (between major sections)
  static const double sectionGap = 32;

  /// Item spacing (between list items)
  static const double itemGap = 12;

  /// Element spacing (between elements in a row)
  static const double elementGap = 8;

  /// Button padding horizontal
  static const double buttonPaddingH = 24;

  /// Button padding vertical
  static const double buttonPaddingV = 16;

  // ═══════════════════════════════════════════════════════
  // BORDER RADIUS
  // ═══════════════════════════════════════════════════════

  /// Small radius (chips, badges)
  static const double radiusXs = 6;

  /// Medium radius (buttons, inputs)
  static const double radiusSm = 8;

  /// Default radius (inputs, small cards)
  static const double radiusMd = 12;

  /// Large radius (cards)
  static const double radiusLg = 16;

  /// Extra large radius (main cards)
  static const double radiusXl = 20;

  /// Full round (nav bars, pills)
  static const double radiusFull = 28;

  // ═══════════════════════════════════════════════════════
  // ICON SIZES
  // ═══════════════════════════════════════════════════════

  /// Small icon
  static const double iconSm = 16;

  /// Default icon
  static const double iconMd = 20;

  /// Large icon
  static const double iconLg = 24;

  /// Extra large icon
  static const double iconXl = 32;

  /// Hero icon
  static const double iconHero = 48;

  // ═══════════════════════════════════════════════════════
  // EDGE INSETS HELPERS
  // ═══════════════════════════════════════════════════════

  /// No padding
  static const EdgeInsets zero = EdgeInsets.zero;

  /// All sides xs (4px)
  static const EdgeInsets allXs = EdgeInsets.all(xs);

  /// All sides sm (8px)
  static const EdgeInsets allSm = EdgeInsets.all(sm);

  /// All sides md (12px)
  static const EdgeInsets allMd = EdgeInsets.all(md);

  /// All sides lg (16px)
  static const EdgeInsets allLg = EdgeInsets.all(lg);

  /// All sides xl (20px)
  static const EdgeInsets allXl = EdgeInsets.all(xl);

  /// All sides xxl (24px)
  static const EdgeInsets allXxl = EdgeInsets.all(xxl);

  /// Screen padding (horizontal 24, vertical 16)
  static const EdgeInsets screen = EdgeInsets.symmetric(
    horizontal: screenHorizontal,
    vertical: screenVertical,
  );

  /// Horizontal padding for screen content
  static const EdgeInsets screenH = EdgeInsets.symmetric(
    horizontal: screenHorizontal,
  );

  /// Card padding (20px all sides)
  static const EdgeInsets card = EdgeInsets.all(cardPadding);

  /// Button padding
  static const EdgeInsets button = EdgeInsets.symmetric(
    horizontal: buttonPaddingH,
    vertical: buttonPaddingV,
  );

  /// List item padding
  static const EdgeInsets listItem = EdgeInsets.symmetric(
    horizontal: lg,
    vertical: md,
  );
}

/// Typography Spacing - Line Heights & Letter Spacing
class TypographySpacing {
  TypographySpacing._();

  // Letter spacing
  static const double tightLetterSpacing = -2.0;
  static const double normalLetterSpacing = -0.5;
  static const double wideLetterSpacing = 1.2;
  static const double extraWideLetterSpacing = 2.0;

  // Line heights
  static const double tightLineHeight = 1.0;
  static const double normalLineHeight = 1.2;
  static const double relaxedLineHeight = 1.5;
}

/// Animation Durations
class AnimationDurations {
  AnimationDurations._();

  /// Fast animations (hover states, micro-interactions)
  static const Duration fast = Duration(milliseconds: 150);

  /// Normal animations (most transitions)
  static const Duration normal = Duration(milliseconds: 250);

  /// Slow animations (page transitions, complex animations)
  static const Duration slow = Duration(milliseconds: 400);

  /// Counting/number animations
  static const Duration counting = Duration(milliseconds: 800);

  /// Stagger delay (for list animations)
  static const Duration stagger = Duration(milliseconds: 50);
}

/// Animation Curves
class AnimationCurves {
  AnimationCurves._();

  /// Default curve for most animations
  static const Curve defaultCurve = Curves.easeOutCubic;

  /// Entrance animations
  static const Curve entrance = Curves.easeOutCubic;

  /// Exit animations
  static const Curve exit = Curves.easeInCubic;

  /// Page transitions
  static const Curve page = Curves.easeInOutCubic;

  /// Bounce effect (for celebratory animations)
  static const Curve bounce = Curves.elasticOut;

  /// Sharp curve (for quick responses)
  static const Curve sharp = Curves.easeOutQuart;
}


--- FILE: lib/theme/premium_theme.dart ---

import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import '../providers/currency_provider.dart';

import 'app_theme.dart';

/// Premium Fintech Design System
/// Inspired by Revolut, N26, Nubank
///
/// IMPORTANT: Colors now delegate to AppColors for consistency.
/// Use AppColors directly in new code.
@Deprecated('Use AppColors directly for colors. PremiumTheme widgets still available.')
class PremiumTheme {
  PremiumTheme._();

  // ============================================
  // COLORS - Delegated to AppColors for consistency
  // ============================================
  static Color get background => AppColors.background;
  static Color get surface => AppColors.surface;
  static Color get surfaceLight => AppColors.surfaceLight;
  static Color get cardBorder => AppColors.cardBorder;

  static Color get primary => AppColors.primary;
  static Color get primaryLight => AppColors.primaryLight;
  static Color get secondary => AppColors.secondary;

  static Color get success => AppColors.success;
  static Color get successGlow => AppColors.success.withValues(alpha: 0.25);
  static Color get warning => AppColors.warning;
  static Color get warningGlow => AppColors.warning.withValues(alpha: 0.25);
  static Color get error => AppColors.error;
  static Color get errorGlow => AppColors.error.withValues(alpha: 0.25);

  static Color get textPrimary => AppColors.textPrimary;
  static Color get textSecondary => AppColors.textSecondary;
  static Color get textTertiary => AppColors.textTertiary;

  // ============================================
  // GRADIENTS - Delegated to AppGradients
  // ============================================
  static LinearGradient get primaryGradient => AppGradients.primary;
  static LinearGradient get successGradient => AppGradients.success;
  static LinearGradient get errorGradient => AppGradients.error;
  static LinearGradient get warningGradient => AppGradients.warning;
  static LinearGradient get cardGradient => AppGradients.card;

  // ============================================
  // GLASSMORPHISM VALUES
  // ============================================
  static const double glassBlur = 10.0;
  static const double glassBorderWidth = 0.5;
  static const Color glassBorderColor = Color(0x20FFFFFF);
  static const Color glassBackground = Color(0x08FFFFFF);

  // ============================================
  // ANIMATION DURATIONS
  // ============================================
  static const Duration fast = Duration(milliseconds: 150);
  static const Duration normal = Duration(milliseconds: 250);
  static const Duration slow = Duration(milliseconds: 400);
  static const Duration counting = Duration(milliseconds: 800);

  // ============================================
  // ANIMATION CURVES
  // ============================================
  static const Curve defaultCurve = Curves.easeOutCubic;
  static const Curve bounceCurve = Curves.elasticOut;
  static const Curve smoothCurve = Curves.easeInOutCubic;
}

/// Glassmorphic Card Widget
class PremiumGlassCard extends StatelessWidget {
  final Widget child;
  final EdgeInsetsGeometry? padding;
  final EdgeInsetsGeometry? margin;
  final double borderRadius;
  final Color? glowColor;
  final double glowIntensity;
  final VoidCallback? onTap;

  const PremiumGlassCard({
    super.key,
    required this.child,
    this.padding,
    this.margin,
    this.borderRadius = 20,
    this.glowColor,
    this.glowIntensity = 0.3,
    this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      margin: margin,
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(borderRadius),
        boxShadow: glowColor != null
            ? [
                BoxShadow(
                  color: glowColor!.withValues(alpha: glowIntensity),
                  blurRadius: 20,
                  spreadRadius: -5,
                ),
              ]
            : null,
      ),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(borderRadius),
        child: BackdropFilter(
          filter: ImageFilter.blur(
            sigmaX: PremiumTheme.glassBlur,
            sigmaY: PremiumTheme.glassBlur,
          ),
          child: GestureDetector(
            onTap: onTap,
            child: Container(
              padding: padding ?? const EdgeInsets.all(20),
              decoration: BoxDecoration(
                gradient: PremiumTheme.cardGradient,
                borderRadius: BorderRadius.circular(borderRadius),
                border: Border.all(
                  color: PremiumTheme.glassBorderColor,
                  width: PremiumTheme.glassBorderWidth,
                ),
              ),
              child: child,
            ),
          ),
        ),
      ),
    );
  }
}

/// Animated Counting Number Widget
class CountingNumber extends StatefulWidget {
  final double value;
  final TextStyle? style;
  final String prefix;
  final String suffix;
  final int decimals;
  final Duration duration;
  final bool useGrouping;

  const CountingNumber({
    super.key,
    required this.value,
    this.style,
    this.prefix = '',
    this.suffix = '',
    this.decimals = 0,
    this.duration = const Duration(milliseconds: 800),
    this.useGrouping = true,
  });

  @override
  State<CountingNumber> createState() => _CountingNumberState();
}

class _CountingNumberState extends State<CountingNumber>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _animation;
  double _previousValue = 0;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(duration: widget.duration, vsync: this);
    _setupAnimation();
    _controller.forward();
  }

  void _setupAnimation() {
    _animation = Tween<double>(
      begin: _previousValue,
      end: widget.value,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeOutCubic));
  }

  @override
  void didUpdateWidget(CountingNumber oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (oldWidget.value != widget.value) {
      _previousValue = oldWidget.value;
      _setupAnimation();
      _controller.forward(from: 0);
    }
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  String _formatNumber(double value) {
    if (widget.useGrouping) {
      final parts = value.toStringAsFixed(widget.decimals).split('.');
      final intPart = parts[0].replaceAllMapped(
        RegExp(r'(\d{1,3})(?=(\d{3})+(?!\d))'),
        (match) => '${match[1]}.',
      );
      if (parts.length > 1 && widget.decimals > 0) {
        return '$intPart,${parts[1]}';
      }
      return intPart;
    }
    return value.toStringAsFixed(widget.decimals);
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: _animation,
      builder: (context, child) {
        return Text(
          '${widget.prefix}${_formatNumber(_animation.value)}${widget.suffix}',
          style: widget.style,
        );
      },
    );
  }
}

/// Premium Gradient Button
class GradientButton extends StatefulWidget {
  final String text;
  final VoidCallback? onPressed;
  final Gradient? gradient;
  final double height;
  final double borderRadius;
  final bool isLoading;
  final IconData? icon;

  const GradientButton({
    super.key,
    required this.text,
    this.onPressed,
    this.gradient,
    this.height = 56,
    this.borderRadius = 16,
    this.isLoading = false,
    this.icon,
  });

  @override
  State<GradientButton> createState() => _GradientButtonState();
}

class _GradientButtonState extends State<GradientButton>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _scaleAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      duration: const Duration(milliseconds: 100),
      vsync: this,
    );
    _scaleAnimation = Tween<double>(
      begin: 1.0,
      end: 0.97,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeInOut));
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  void _onTapDown(TapDownDetails details) {
    _controller.forward();
    HapticFeedback.lightImpact();
  }

  void _onTapUp(TapUpDetails details) {
    _controller.reverse();
  }

  void _onTapCancel() {
    _controller.reverse();
  }

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTapDown: widget.onPressed != null ? _onTapDown : null,
      onTapUp: widget.onPressed != null ? _onTapUp : null,
      onTapCancel: widget.onPressed != null ? _onTapCancel : null,
      onTap: widget.onPressed,
      child: AnimatedBuilder(
        animation: _scaleAnimation,
        builder: (context, child) {
          return Transform.scale(
            scale: _scaleAnimation.value,
            child: Container(
              height: widget.height,
              decoration: BoxDecoration(
                gradient: widget.gradient ?? PremiumTheme.primaryGradient,
                borderRadius: BorderRadius.circular(widget.borderRadius),
                boxShadow: [
                  BoxShadow(
                    color: PremiumTheme.primary.withValues(alpha: 0.4),
                    blurRadius: 20,
                    offset: const Offset(0, 8),
                  ),
                ],
              ),
              child: Center(
                child: widget.isLoading
                    ? const SizedBox(
                        width: 24,
                        height: 24,
                        child: CircularProgressIndicator(
                          strokeWidth: 2,
                          color: Colors.white,
                        ),
                      )
                    : Row(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          if (widget.icon != null) ...[
                            Icon(
                              widget.icon!,
                              color: Colors.white,
                              size: 22,
                            ),
                            const SizedBox(width: 10),
                          ],
                          Text(
                            widget.text,
                            style: const TextStyle(
                              fontSize: 16,
                              fontWeight: FontWeight.w600,
                              color: Colors.white,
                              letterSpacing: 0.5,
                            ),
                          ),
                        ],
                      ),
              ),
            ),
          );
        },
      ),
    );
  }
}

/// Premium Icon Container with Glow
class GlowingIcon extends StatelessWidget {
  final IconData icon;
  final Color color;
  final double size;
  final double containerSize;

  const GlowingIcon({
    super.key,
    required this.icon,
    required this.color,
    this.size = 24,
    this.containerSize = 48,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      width: containerSize,
      height: containerSize,
      decoration: BoxDecoration(
        color: color.withValues(alpha: 0.15),
        borderRadius: BorderRadius.circular(14),
        boxShadow: [
          BoxShadow(
            color: color.withValues(alpha: 0.3),
            blurRadius: 12,
            spreadRadius: -2,
          ),
        ],
      ),
      child: Center(
        child: Icon(icon, color: color, size: size),
      ),
    );
  }
}

/// Pressable Widget with Scale Animation
class PremiumPressable extends StatefulWidget {
  final Widget child;
  final VoidCallback? onTap;
  final double scaleFactor;

  const PremiumPressable({
    super.key,
    required this.child,
    this.onTap,
    this.scaleFactor = 0.97,
  });

  @override
  State<PremiumPressable> createState() => _PremiumPressableState();
}

class _PremiumPressableState extends State<PremiumPressable>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _animation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      duration: const Duration(milliseconds: 100),
      vsync: this,
    );
    _animation = Tween<double>(
      begin: 1.0,
      end: widget.scaleFactor,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeInOut));
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTapDown: (_) {
        _controller.forward();
        HapticFeedback.lightImpact();
      },
      onTapUp: (_) => _controller.reverse(),
      onTapCancel: () => _controller.reverse(),
      onTap: widget.onTap,
      child: AnimatedBuilder(
        animation: _animation,
        builder: (context, child) {
          return Transform.scale(scale: _animation.value, child: widget.child);
        },
      ),
    );
  }
}

/// Shimmer Loading Effect
class PremiumShimmer extends StatelessWidget {
  final double width;
  final double height;
  final double borderRadius;

  const PremiumShimmer({
    super.key,
    required this.width,
    required this.height,
    this.borderRadius = 8,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      width: width,
      height: height,
      decoration: BoxDecoration(
        color: PremiumTheme.surfaceLight,
        borderRadius: BorderRadius.circular(borderRadius),
      ),
    );
  }
}

/// Premium Stat Card (for income/expense display)
class PremiumStatCard extends StatelessWidget {
  final String label;
  final double value;
  final IconData icon;
  final Color color;
  final String? subtitle;
  final bool isPositive;

  const PremiumStatCard({
    super.key,
    required this.label,
    required this.value,
    required this.icon,
    required this.color,
    this.subtitle,
    this.isPositive = true,
  });

  @override
  Widget build(BuildContext context) {
    final currencyProvider = context.watch<CurrencyProvider>();
    return PremiumGlassCard(
      glowColor: color,
      glowIntensity: 0.2,
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              GlowingIcon(
                icon: icon,
                color: color,
                size: 20,
                containerSize: 40,
              ),
              const SizedBox(width: 12),
              Text(
                label,
                style: TextStyle(
                  fontSize: 13,
                  fontWeight: FontWeight.w500,
                  color: PremiumTheme.textSecondary,
                  letterSpacing: 1.2,
                ),
              ),
            ],
          ),
          const SizedBox(height: 16),
          Row(
            crossAxisAlignment: CrossAxisAlignment.end,
            children: [
              CountingNumber(
                value: value,
                style: TextStyle(
                  fontSize: 28,
                  fontWeight: FontWeight.w300,
                  color: PremiumTheme.textPrimary,
                  letterSpacing: -0.5,
                ),
                useGrouping: true,
              ),
              const SizedBox(width: 6),
              Padding(
                padding: const EdgeInsets.only(bottom: 4),
                child: Text(
                  currencyProvider.code,
                  style: TextStyle(
                    fontSize: 14,
                    fontWeight: FontWeight.w400,
                    color: PremiumTheme.textTertiary,
                    letterSpacing: 1.0,
                  ),
                ),
              ),
            ],
          ),
          if (subtitle != null) ...[
            const SizedBox(height: 8),
            Text(
              subtitle!,
              style: TextStyle(
                fontSize: 12,
                color: color,
                fontWeight: FontWeight.w500,
              ),
            ),
          ],
        ],
      ),
    );
  }
}

/// Cupertino Icons Mapping
class PremiumIcons {
  PremiumIcons._();

  // Navigation
  static IconData get home => CupertinoIcons.house_fill;
  static IconData get chart => CupertinoIcons.chart_bar_fill;
  static IconData get trophy => CupertinoIcons.rosette;
  static IconData get user => CupertinoIcons.person_fill;
  static IconData get plus => CupertinoIcons.plus;
  static IconData get plusCircle => CupertinoIcons.plus_circle_fill;

  // Finance
  static IconData get wallet => CupertinoIcons.creditcard_fill;
  static IconData get money => CupertinoIcons.money_dollar;
  static IconData get creditCard => CupertinoIcons.creditcard_fill;
  static IconData get bank => CupertinoIcons.building_2_fill;
  static IconData get piggyBank => CupertinoIcons.money_dollar_circle_fill;
  static IconData get coins => CupertinoIcons.bitcoin_circle_fill;
  static IconData get currencyDollar => CupertinoIcons.money_dollar;
  static IconData get trendUp => CupertinoIcons.arrow_up_right;
  static IconData get trendDown => CupertinoIcons.arrow_down_right;
  static IconData get receipt => CupertinoIcons.doc_text_fill;

  // Actions
  static IconData get check => CupertinoIcons.checkmark;
  static IconData get checkCircle => CupertinoIcons.checkmark_circle_fill;
  static IconData get x => CupertinoIcons.xmark;
  static IconData get xCircle => CupertinoIcons.xmark_circle_fill;
  static IconData get edit => CupertinoIcons.pencil;
  static IconData get delete => CupertinoIcons.trash_fill;
  static IconData get settings => CupertinoIcons.gear_alt_fill;
  static IconData get share => CupertinoIcons.share;
  static IconData get download => CupertinoIcons.arrow_down_circle_fill;
  static IconData get refresh => CupertinoIcons.arrow_clockwise;

  // Time & Calendar
  static IconData get calendar => CupertinoIcons.calendar;
  static IconData get calendarCheck => CupertinoIcons.calendar_badge_plus;
  static IconData get clock => CupertinoIcons.clock_fill;
  static IconData get timer => CupertinoIcons.timer;
  static IconData get hourglass => CupertinoIcons.hourglass;

  // Categories
  static IconData get food => CupertinoIcons.cart_fill;
  static IconData get shopping => CupertinoIcons.bag_fill;
  static IconData get transport => CupertinoIcons.car_fill;
  static IconData get entertainment => CupertinoIcons.gamecontroller_fill;
  static IconData get health => CupertinoIcons.heart_fill;
  static IconData get education => CupertinoIcons.book_fill;
  static IconData get home_ => CupertinoIcons.house_fill;
  static IconData get utilities => CupertinoIcons.bolt_fill;
  static IconData get subscription => CupertinoIcons.repeat;
  static IconData get gift => CupertinoIcons.gift_fill;
  static IconData get travel => CupertinoIcons.airplane;
  static IconData get coffee => CupertinoIcons.cart_fill;

  // Misc
  static IconData get fire => CupertinoIcons.flame_fill;
  static IconData get lightning => CupertinoIcons.bolt_fill;
  static IconData get star => CupertinoIcons.star_fill;
  static IconData get heart => CupertinoIcons.heart_fill;
  static IconData get bell => CupertinoIcons.bell_fill;
  static IconData get info => CupertinoIcons.info_circle_fill;
  static IconData get warning => CupertinoIcons.exclamationmark_triangle_fill;
  static IconData get question => CupertinoIcons.question_circle_fill;
  static IconData get link => CupertinoIcons.link;
  static IconData get lock => CupertinoIcons.lock_fill;
  static IconData get unlock => CupertinoIcons.lock_open_fill;
  static IconData get eye => CupertinoIcons.eye_fill;
  static IconData get eyeOff => CupertinoIcons.eye_slash_fill;
  static IconData get camera => CupertinoIcons.camera_fill;
  static IconData get image => CupertinoIcons.photo_fill;
  static IconData get sparkle => CupertinoIcons.sparkles;
  static IconData get confetti => CupertinoIcons.sparkles;
  static IconData get target => CupertinoIcons.scope;
  static IconData get rocket => CupertinoIcons.rocket_fill;
  static IconData get crown => CupertinoIcons.star_circle_fill;
  static IconData get shield => CupertinoIcons.shield_fill;
  static IconData get arrowLeft => CupertinoIcons.arrow_left;
  static IconData get arrowRight => CupertinoIcons.arrow_right;
  static IconData get chevronDown => CupertinoIcons.chevron_down;
  static IconData get chevronUp => CupertinoIcons.chevron_up;
  static IconData get chevronLeft => CupertinoIcons.chevron_left;
  static IconData get chevronRight => CupertinoIcons.chevron_right;
  static IconData get menu => CupertinoIcons.line_horizontal_3;
  static IconData get more => CupertinoIcons.ellipsis;
  static IconData get search => CupertinoIcons.search;
  static IconData get filter => CupertinoIcons.slider_horizontal_3;
  static IconData get sort => CupertinoIcons.sort_down;
  static IconData get google => CupertinoIcons.globe;
  static IconData get globe => CupertinoIcons.globe;
  static IconData get language => CupertinoIcons.textformat;
  static IconData get moon => CupertinoIcons.moon_fill;
  static IconData get sun => CupertinoIcons.sun_max_fill;
  static IconData get chatBubble => CupertinoIcons.chat_bubble_fill;
  static IconData get help => CupertinoIcons.question_circle_fill;
  static IconData get signOut => CupertinoIcons.square_arrow_right;
  static IconData get briefcase => CupertinoIcons.briefcase_fill;
  static IconData get building => CupertinoIcons.building_2_fill;
  static IconData get handCoins => CupertinoIcons.hand_raised_fill;
  static IconData get chartLine => CupertinoIcons.graph_square_fill;
  static IconData get medal => CupertinoIcons.rosette;
  static IconData get partyPopper => CupertinoIcons.sparkles;
}


--- FILE: lib/theme/app_animations.dart ---

import 'package:flutter/material.dart';

/// Global animasyon sabitleri
/// Tüm uygulama genelinde tutarlı animasyon dili için kullanılır
class AppAnimations {
  AppAnimations._();

  // ========== CURVES ==========
  /// Standart animasyon curve'ü - tüm animasyonlar için varsayılan
  static const Curve standardCurve = Curves.easeOutCubic;

  /// Giriş animasyonları için
  static const Curve enterCurve = Curves.easeOutCubic;

  /// Çıkış animasyonları için
  static const Curve exitCurve = Curves.easeInCubic;

  /// Bounce efektli animasyonlar için
  static const Curve bounceCurve = Curves.elasticOut;

  /// Yumuşak yavaşlama için
  static const Curve decelerateCurve = Curves.decelerate;

  // ========== DURATIONS ==========
  /// Mikro animasyonlar (buton press, icon change)
  static const Duration micro = Duration(milliseconds: 160);

  /// Kısa animasyonlar (renk değişimi, opacity)
  static const Duration short = Duration(milliseconds: 200);

  /// Orta animasyonlar (kart geçişleri)
  static const Duration medium = Duration(milliseconds: 300);

  /// Sayfa geçişleri
  static const Duration pageTransition = Duration(milliseconds: 300);

  /// Counter animasyonları
  static const Duration counter = Duration(milliseconds: 600);

  /// Uzun animasyonlar (achievement celebration)
  static const Duration long = Duration(milliseconds: 500);

  /// Çok uzun animasyonlar (confetti)
  static const Duration extraLong = Duration(milliseconds: 2500);

  // ========== DELAYS ==========
  /// Staggered animasyonlarda kartlar arası gecikme
  static const Duration staggerDelay = Duration(milliseconds: 50);

  /// Sayfa açılınca ilk animasyon öncesi bekleme
  static const Duration initialDelay = Duration(milliseconds: 150);

  /// Karar sonrası counter animasyonu öncesi bekleme
  static const Duration decisionDelay = Duration(milliseconds: 80);

  // ========== SCALES ==========
  /// Buton press scale (Premium: 0.95 for tactile feel)
  static const double buttonPressScale = 0.95;

  /// Header scroll scale (min)
  static const double headerMinScale = 0.92;

  /// Achievement pulse scale
  static const double achievementPulseScale = 1.03;

  /// Card hover/focus scale
  static const double cardFocusScale = 1.02;

  // ========== OPACITIES ==========
  /// Header scroll opacity (min)
  static const double headerMinOpacity = 0.8;

  /// Kilitli rozet opacity
  static const double lockedOpacity = 0.6;

  /// Disabled element opacity
  static const double disabledOpacity = 0.5;

  /// Overlay backdrop opacity
  static const double backdropOpacity = 0.7;

  // ========== OFFSETS ==========
  /// Kart slide-up animasyonu başlangıç offset'i
  static const Offset cardSlideOffset = Offset(0, 30);

  /// Bottom sheet slide offset
  static const Offset sheetSlideOffset = Offset(0, 50);

  // ========== BLUR ==========
  /// Backdrop blur değeri (premium glassmorphism)
  static const double backdropBlur = 20.0;

  /// Kilitli rozet blur değeri
  static const double lockedBlur = 2.0;

  // ========== HELPER METHODS ==========

  /// Staggered animasyon için gecikme hesapla
  static Duration staggeredDelay(int index) {
    return Duration(milliseconds: staggerDelay.inMilliseconds * index);
  }

  /// Sayfa açılış animasyonu için toplam gecikme
  static Duration pageEntryDelay(int index) {
    return Duration(
      milliseconds:
          initialDelay.inMilliseconds + staggerDelay.inMilliseconds * index,
    );
  }
}

/// Animasyon yardımcı extension'ları
extension AnimationExtensions on Duration {
  /// Duration'ı Curve ile birleştir
  ({Duration duration, Curve curve}) withCurve([Curve? curve]) {
    return (duration: this, curve: curve ?? AppAnimations.standardCurve);
  }
}

/// Widget animasyon mixin'i
mixin AnimatedStateMixin<T extends StatefulWidget> on State<T> {
  /// Güvenli setState - mounted kontrolü ile
  void safeSetState(VoidCallback fn) {
    if (mounted) setState(fn);
  }

  /// Gecikmeli işlem çalıştır
  Future<void> delayed(Duration duration, VoidCallback callback) async {
    await Future.delayed(duration);
    if (mounted) callback();
  }
}


--- FILE: lib/theme/theme.dart ---

export 'app_theme.dart';
export 'app_animations.dart';
export 'app_spacing.dart';
export 'quiet_luxury.dart';
export 'ai_finance_theme.dart';
export 'premium_theme.dart';
export 'accessible_text.dart';


--- FILE: lib/data/store_categories.dart ---

/// Mağaza ve hizmet isimlerinden kategori tahmini için sözlük.
///
/// 200+ yaygın mağaza ve hizmet içerir.
/// Kategoriler: Yiyecek, Ulaşım, Giyim, Elektronik, Eğlence, Sağlık, Eğitim, Faturalar, Diğer.
/// Öncelik: Kullanıcının öğrettiği > Built-in sözlük.
class StoreCategories {
  StoreCategories._();

  /// Ana kategori sözlüğü - küçük harfle saklanır
  static final Map<String, String> _storeMap = {
    // ═══════════════════════════════════════════════════════════════
    // MARKET / SÜPERMARKET → Yiyecek
    // ═══════════════════════════════════════════════════════════════
    'migros': 'Yiyecek',
    'a101': 'Yiyecek',
    'bim': 'Yiyecek',
    'şok': 'Yiyecek',
    'sok': 'Yiyecek',
    'carrefour': 'Yiyecek',
    'carrefoursa': 'Yiyecek',
    'macro center': 'Yiyecek',
    'macrocenter': 'Yiyecek',
    'file': 'Yiyecek',
    'happy center': 'Yiyecek',
    'hakmar': 'Yiyecek',
    'tarım kredi': 'Yiyecek',
    'bizim': 'Yiyecek',
    'bizim toptan': 'Yiyecek',
    'gratis': 'Yiyecek',
    'rossmann': 'Yiyecek',
    'watsons': 'Yiyecek',
    'eve': 'Yiyecek',
    'marketpaketi': 'Yiyecek',
    'istegelsin': 'Yiyecek',
    'getir': 'Yiyecek',
    'banabi': 'Yiyecek',
    'trendyol market': 'Yiyecek',
    'hepsiburada market': 'Yiyecek',
    'yupass': 'Yiyecek',
    'onur market': 'Yiyecek',
    'kiler': 'Yiyecek',
    'özdilek': 'Yiyecek',
    'real': 'Yiyecek',
    'tesco': 'Yiyecek',
    'walmart': 'Yiyecek',
    'aldi': 'Yiyecek',
    'lidl': 'Yiyecek',
    'costco': 'Yiyecek',
    'target': 'Yiyecek',
    'whole foods': 'Yiyecek',
    'trader joe': 'Yiyecek',
    'kroger': 'Yiyecek',
    'safeway': 'Yiyecek',
    'publix': 'Yiyecek',
    'asda': 'Yiyecek',
    'sainsbury': 'Yiyecek',
    'morrisons': 'Yiyecek',
    'auchan': 'Yiyecek',
    'leclerc': 'Yiyecek',
    'edeka': 'Yiyecek',
    'rewe': 'Yiyecek',
    'penny': 'Yiyecek',
    'netto': 'Yiyecek',
    'albert heijn': 'Yiyecek',
    'coop': 'Yiyecek',
    'spar': 'Yiyecek',

    // ═══════════════════════════════════════════════════════════════
    // YEMEK / RESTORAN / CAFE → Yiyecek
    // ═══════════════════════════════════════════════════════════════
    'yemeksepeti': 'Yiyecek',
    'getir yemek': 'Yiyecek',
    'trendyol yemek': 'Yiyecek',
    'glovo': 'Yiyecek',
    'uber eats': 'Yiyecek',
    'doordash': 'Yiyecek',
    'deliveroo': 'Yiyecek',
    'just eat': 'Yiyecek',
    'grubhub': 'Yiyecek',
    'mcdonald': 'Yiyecek',
    'mcdonalds': 'Yiyecek',
    'burger king': 'Yiyecek',
    'bk': 'Yiyecek',
    'kfc': 'Yiyecek',
    'kentucky': 'Yiyecek',
    'popeyes': 'Yiyecek',
    'sbarro': 'Yiyecek',
    'dominos': 'Yiyecek',
    'pizza hut': 'Yiyecek',
    'little caesars': 'Yiyecek',
    'papa johns': 'Yiyecek',
    'subway': 'Yiyecek',
    'starbucks': 'Yiyecek',
    'gloria jeans': 'Yiyecek',
    'kahve dünyası': 'Yiyecek',
    'kahve dunyasi': 'Yiyecek',
    'espresso lab': 'Yiyecek',
    'petra': 'Yiyecek',
    'coffee': 'Yiyecek',
    'kahve': 'Yiyecek',
    'kafe': 'Yiyecek',
    'cafe': 'Yiyecek',
    'restoran': 'Yiyecek',
    'restaurant': 'Yiyecek',
    'lokanta': 'Yiyecek',
    'kebap': 'Yiyecek',
    'kebab': 'Yiyecek',
    'döner': 'Yiyecek',
    'doner': 'Yiyecek',
    'pide': 'Yiyecek',
    'lahmacun': 'Yiyecek',
    'köfte': 'Yiyecek',
    'tavuk': 'Yiyecek',
    'chicken': 'Yiyecek',
    'burger': 'Yiyecek',
    'pizza': 'Yiyecek',
    'sushi': 'Yiyecek',
    'noodle': 'Yiyecek',
    'taco bell': 'Yiyecek',
    'chipotle': 'Yiyecek',
    'wendys': 'Yiyecek',
    'five guys': 'Yiyecek',
    'shake shack': 'Yiyecek',
    'dunkin': 'Yiyecek',
    'krispy kreme': 'Yiyecek',
    'costa coffee': 'Yiyecek',
    'big chefs': 'Yiyecek',
    'midpoint': 'Yiyecek',
    'happy moon': 'Yiyecek',
    'nusret': 'Yiyecek',
    'günaydın': 'Yiyecek',
    'gunaydin': 'Yiyecek',
    'dönerci': 'Yiyecek',
    'pideci': 'Yiyecek',
    'kebapçı': 'Yiyecek',
    'köfteci': 'Yiyecek',
    'tantuni': 'Yiyecek',
    'çiğ köfte': 'Yiyecek',
    'simit sarayı': 'Yiyecek',

    // ═══════════════════════════════════════════════════════════════
    // AKARYAKIT / ULAŞIM → Ulaşım
    // ═══════════════════════════════════════════════════════════════
    'shell': 'Ulaşım',
    'opet': 'Ulaşım',
    'bp': 'Ulaşım',
    'petrol ofisi': 'Ulaşım',
    'po': 'Ulaşım',
    'total': 'Ulaşım',
    'turkuaz': 'Ulaşım',
    'aytemiz': 'Ulaşım',
    'kadoil': 'Ulaşım',
    'moil': 'Ulaşım',
    'alpet': 'Ulaşım',
    'go petrol': 'Ulaşım',
    'lukoil': 'Ulaşım',
    'exxon': 'Ulaşım',
    'mobil': 'Ulaşım',
    'chevron': 'Ulaşım',
    'texaco': 'Ulaşım',
    'esso': 'Ulaşım',
    'aral': 'Ulaşım',
    'gulf': 'Ulaşım',
    'benzin': 'Ulaşım',
    'mazot': 'Ulaşım',
    'yakıt': 'Ulaşım',
    'akaryakıt': 'Ulaşım',
    'lpg': 'Ulaşım',
    'uber': 'Ulaşım',
    'bolt': 'Ulaşım',
    'bitaksi': 'Ulaşım',
    'taksi': 'Ulaşım',
    'taxi': 'Ulaşım',
    'istanbulkart': 'Ulaşım',
    'akbil': 'Ulaşım',
    'metro': 'Ulaşım',
    'metrobüs': 'Ulaşım',
    'otobüs': 'Ulaşım',
    'tramvay': 'Ulaşım',
    'marmaray': 'Ulaşım',
    'vapur': 'Ulaşım',
    'ido': 'Ulaşım',
    'budo': 'Ulaşım',
    'thy': 'Ulaşım',
    'türk hava yolları': 'Ulaşım',
    'pegasus': 'Ulaşım',
    'sunexpress': 'Ulaşım',
    'anadolujet': 'Ulaşım',
    'kamil koç': 'Ulaşım',
    'metro turizm': 'Ulaşım',
    'pamukkale': 'Ulaşım',
    'ulusoy': 'Ulaşım',
    'varan': 'Ulaşım',
    'flixbus': 'Ulaşım',
    'obilet': 'Ulaşım',
    'biletall': 'Ulaşım',
    'enuygun': 'Ulaşım',
    'lyft': 'Ulaşım',
    'grab': 'Ulaşım',
    'martı': 'Ulaşım',
    'marti': 'Ulaşım',
    'hertz': 'Ulaşım',
    'avis': 'Ulaşım',
    'budget': 'Ulaşım',
    'enterprise': 'Ulaşım',
    'sixt': 'Ulaşım',
    'europcar': 'Ulaşım',
    'araç kiralama': 'Ulaşım',
    'rent a car': 'Ulaşım',
    'otopark': 'Ulaşım',
    'parking': 'Ulaşım',

    // ═══════════════════════════════════════════════════════════════
    // GİYİM / MODA → Giyim
    // ═══════════════════════════════════════════════════════════════
    'zara': 'Giyim',
    'h&m': 'Giyim',
    'hm': 'Giyim',
    'mango': 'Giyim',
    'pull&bear': 'Giyim',
    'bershka': 'Giyim',
    'massimo dutti': 'Giyim',
    'stradivarius': 'Giyim',
    'lcw': 'Giyim',
    'lc waikiki': 'Giyim',
    'koton': 'Giyim',
    'defacto': 'Giyim',
    'colins': 'Giyim',
    'mavi': 'Giyim',
    'mavi jeans': 'Giyim',
    'ipekyol': 'Giyim',
    'machka': 'Giyim',
    'twist': 'Giyim',
    'network': 'Giyim',
    'damat': 'Giyim',
    'beymen': 'Giyim',
    'vakko': 'Giyim',
    'derimod': 'Giyim',
    'hotiç': 'Giyim',
    'hotic': 'Giyim',
    'flo': 'Giyim',
    'ayakkabı dünyası': 'Giyim',
    'nike': 'Giyim',
    'adidas': 'Giyim',
    'puma': 'Giyim',
    'new balance': 'Giyim',
    'reebok': 'Giyim',
    'under armour': 'Giyim',
    'skechers': 'Giyim',
    'converse': 'Giyim',
    'vans': 'Giyim',
    'timberland': 'Giyim',
    'levis': 'Giyim',
    'tommy hilfiger': 'Giyim',
    'calvin klein': 'Giyim',
    'lacoste': 'Giyim',
    'polo': 'Giyim',
    'ralph lauren': 'Giyim',
    'hugo boss': 'Giyim',
    'armani': 'Giyim',
    'gucci': 'Giyim',
    'louis vuitton': 'Giyim',
    'prada': 'Giyim',
    'burberry': 'Giyim',
    'versace': 'Giyim',
    'michael kors': 'Giyim',
    'coach': 'Giyim',
    'uniqlo': 'Giyim',
    'gap': 'Giyim',
    'old navy': 'Giyim',
    'forever 21': 'Giyim',
    'primark': 'Giyim',
    'asos': 'Giyim',
    'shein': 'Giyim',
    'trendyol': 'Giyim',
    'morhipo': 'Giyim',
    'modanisa': 'Giyim',
    'boyner': 'Giyim',
    'yargıcı': 'Giyim',
    'fabrika': 'Giyim',
    'marks spencer': 'Giyim',
    'oxxo': 'Giyim',
    'penti': 'Giyim',
    'suwen': 'Giyim',

    // ═══════════════════════════════════════════════════════════════
    // ELEKTRONİK / TEKNOLOJİ → Elektronik
    // ═══════════════════════════════════════════════════════════════
    'apple': 'Elektronik',
    'apple store': 'Elektronik',
    'samsung': 'Elektronik',
    'xiaomi': 'Elektronik',
    'huawei': 'Elektronik',
    'oppo': 'Elektronik',
    'vivo': 'Elektronik',
    'realme': 'Elektronik',
    'oneplus': 'Elektronik',
    'google': 'Elektronik',
    'sony': 'Elektronik',
    'lg': 'Elektronik',
    'philips': 'Elektronik',
    'bosch': 'Elektronik',
    'siemens': 'Elektronik',
    'arçelik': 'Elektronik',
    'arcelik': 'Elektronik',
    'beko': 'Elektronik',
    'vestel': 'Elektronik',
    'altus': 'Elektronik',
    'grundig': 'Elektronik',
    'media markt': 'Elektronik',
    'mediamarkt': 'Elektronik',
    'teknosa': 'Elektronik',
    'vatan': 'Elektronik',
    'vatan bilgisayar': 'Elektronik',
    'hepsiburada': 'Elektronik',
    'amazon': 'Elektronik',
    'n11': 'Elektronik',
    'gittigidiyor': 'Elektronik',
    'dell': 'Elektronik',
    'hp': 'Elektronik',
    'lenovo': 'Elektronik',
    'asus': 'Elektronik',
    'acer': 'Elektronik',
    'msi': 'Elektronik',
    'razer': 'Elektronik',
    'logitech': 'Elektronik',
    'microsoft': 'Elektronik',
    'playstation': 'Elektronik',
    'xbox': 'Elektronik',
    'nintendo': 'Elektronik',
    'dyson': 'Elektronik',
    'tefal': 'Elektronik',
    'electrolux': 'Elektronik',
    'miele': 'Elektronik',
    'karcher': 'Elektronik',
    'ikea': 'Elektronik',
    'koçtaş': 'Elektronik',
    'koctas': 'Elektronik',
    'bauhaus': 'Elektronik',

    // ═══════════════════════════════════════════════════════════════
    // EĞLENCE / HOBİ → Eğlence
    // ═══════════════════════════════════════════════════════════════
    'sinema': 'Eğlence',
    'cinema': 'Eğlence',
    'movie': 'Eğlence',
    'film': 'Eğlence',
    'cinemaximum': 'Eğlence',
    'mars cinema': 'Eğlence',
    'tiyatro': 'Eğlence',
    'theatre': 'Eğlence',
    'theater': 'Eğlence',
    'konser': 'Eğlence',
    'concert': 'Eğlence',
    'festival': 'Eğlence',
    'biletix': 'Eğlence',
    'biletino': 'Eğlence',
    'passo': 'Eğlence',
    'müze': 'Eğlence',
    'muze': 'Eğlence',
    'museum': 'Eğlence',
    'sergi': 'Eğlence',
    'lunapark': 'Eğlence',
    'disneyland': 'Eğlence',
    'aquarium': 'Eğlence',
    'akvaryum': 'Eğlence',
    'zoo': 'Eğlence',
    'hayvanat': 'Eğlence',
    'bowling': 'Eğlence',
    'bilardo': 'Eğlence',
    'playstation cafe': 'Eğlence',
    'internet cafe': 'Eğlence',
    'escape room': 'Eğlence',
    'paintball': 'Eğlence',
    'go kart': 'Eğlence',
    'karting': 'Eğlence',
    'spor': 'Eğlence',
    'gym': 'Eğlence',
    'fitness': 'Eğlence',
    'pilates': 'Eğlence',
    'yoga': 'Eğlence',
    'crossfit': 'Eğlence',
    'mac fit': 'Eğlence',
    'macfit': 'Eğlence',
    'decathlon': 'Eğlence',
    'intersport': 'Eğlence',
    'yüzme': 'Eğlence',
    'havuz': 'Eğlence',
    'tenis': 'Eğlence',
    'golf': 'Eğlence',
    'halı saha': 'Eğlence',
    'futbol': 'Eğlence',
    'basketbol': 'Eğlence',
    'otel': 'Eğlence',
    'hotel': 'Eğlence',
    'airbnb': 'Eğlence',
    'booking': 'Eğlence',
    'trivago': 'Eğlence',
    'expedia': 'Eğlence',
    'tatilbudur': 'Eğlence',
    'tatil': 'Eğlence',
    'seyahat': 'Eğlence',
    'hilton': 'Eğlence',
    'marriott': 'Eğlence',
    'sheraton': 'Eğlence',
    'radisson': 'Eğlence',
    'rixos': 'Eğlence',

    // ═══════════════════════════════════════════════════════════════
    // SAĞLIK / ECZANE / KİŞİSEL BAKIM → Sağlık
    // ═══════════════════════════════════════════════════════════════
    'eczane': 'Sağlık',
    'pharmacy': 'Sağlık',
    'cvs': 'Sağlık',
    'walgreens': 'Sağlık',
    'boots': 'Sağlık',
    'ilaç': 'Sağlık',
    'ilac': 'Sağlık',
    'hastane': 'Sağlık',
    'hospital': 'Sağlık',
    'klinik': 'Sağlık',
    'clinic': 'Sağlık',
    'doktor': 'Sağlık',
    'doctor': 'Sağlık',
    'diş': 'Sağlık',
    'dis': 'Sağlık',
    'dişçi': 'Sağlık',
    'disci': 'Sağlık',
    'dentist': 'Sağlık',
    'göz': 'Sağlık',
    'optik': 'Sağlık',
    'optic': 'Sağlık',
    'lens': 'Sağlık',
    'gözlük': 'Sağlık',
    'laboratuvar': 'Sağlık',
    'lab': 'Sağlık',
    'tahlil': 'Sağlık',
    'röntgen': 'Sağlık',
    'mr': 'Sağlık',
    'ultrason': 'Sağlık',
    'acıbadem': 'Sağlık',
    'memorial': 'Sağlık',
    'medicana': 'Sağlık',
    'medipol': 'Sağlık',
    'berber': 'Sağlık',
    'barber': 'Sağlık',
    'kuaför': 'Sağlık',
    'kuafor': 'Sağlık',
    'saç': 'Sağlık',
    'hair': 'Sağlık',
    'salon': 'Sağlık',
    'güzellik': 'Sağlık',
    'beauty': 'Sağlık',
    'spa': 'Sağlık',
    'masaj': 'Sağlık',
    'massage': 'Sağlık',
    'hamam': 'Sağlık',
    'sauna': 'Sağlık',
    'manikür': 'Sağlık',
    'pedikür': 'Sağlık',
    'tırnak': 'Sağlık',
    'nail': 'Sağlık',
    'epilasyon': 'Sağlık',
    'lazer': 'Sağlık',
    'sephora': 'Sağlık',
    'mac cosmetics': 'Sağlık',
    'flormar': 'Sağlık',
    'golden rose': 'Sağlık',
    'inglot': 'Sağlık',
    'loreal': 'Sağlık',
    'maybelline': 'Sağlık',
    'nivea': 'Sağlık',

    // ═══════════════════════════════════════════════════════════════
    // EĞİTİM → Eğitim
    // ═══════════════════════════════════════════════════════════════
    'okul': 'Eğitim',
    'school': 'Eğitim',
    'üniversite': 'Eğitim',
    'universite': 'Eğitim',
    'university': 'Eğitim',
    'kolej': 'Eğitim',
    'college': 'Eğitim',
    'dershane': 'Eğitim',
    'kurs': 'Eğitim',
    'course': 'Eğitim',
    'eğitim': 'Eğitim',
    'egitim': 'Eğitim',
    'harç': 'Eğitim',
    'öğrenim': 'Eğitim',
    'tuition': 'Eğitim',
    'kitap': 'Eğitim',
    'book': 'Eğitim',
    'kırtasiye': 'Eğitim',
    'd&r': 'Eğitim',
    'dr': 'Eğitim',
    'idefix': 'Eğitim',
    'kitapyurdu': 'Eğitim',
    'bkmkitap': 'Eğitim',
    'udemy': 'Eğitim',
    'coursera': 'Eğitim',
    'duolingo': 'Eğitim',
    'cambly': 'Eğitim',
    'masterclass': 'Eğitim',
    'skillshare': 'Eğitim',
    'kreş': 'Eğitim',
    'anaokulu': 'Eğitim',

    // ═══════════════════════════════════════════════════════════════
    // FATURALAR / ABONELİKLER → Faturalar
    // ═══════════════════════════════════════════════════════════════
    'netflix': 'Faturalar',
    'spotify': 'Faturalar',
    'youtube': 'Faturalar',
    'youtube premium': 'Faturalar',
    'apple music': 'Faturalar',
    'apple tv': 'Faturalar',
    'apple one': 'Faturalar',
    'icloud': 'Faturalar',
    'amazon prime': 'Faturalar',
    'prime video': 'Faturalar',
    'disney+': 'Faturalar',
    'disney plus': 'Faturalar',
    'hbo max': 'Faturalar',
    'hbo': 'Faturalar',
    'hulu': 'Faturalar',
    'exxen': 'Faturalar',
    'gain': 'Faturalar',
    'blutv': 'Faturalar',
    'puhutv': 'Faturalar',
    'mubi': 'Faturalar',
    'digiturk': 'Faturalar',
    'd-smart': 'Faturalar',
    'dsmart': 'Faturalar',
    'tivibu': 'Faturalar',
    'bein': 'Faturalar',
    'bein connect': 'Faturalar',
    'twitch': 'Faturalar',
    'patreon': 'Faturalar',
    'chatgpt': 'Faturalar',
    'openai': 'Faturalar',
    'claude': 'Faturalar',
    'midjourney': 'Faturalar',
    'canva': 'Faturalar',
    'adobe': 'Faturalar',
    'photoshop': 'Faturalar',
    'microsoft 365': 'Faturalar',
    'office 365': 'Faturalar',
    'google one': 'Faturalar',
    'dropbox': 'Faturalar',
    'notion': 'Faturalar',
    'slack': 'Faturalar',
    'zoom': 'Faturalar',
    'linkedin premium': 'Faturalar',
    'xbox game pass': 'Faturalar',
    'playstation plus': 'Faturalar',
    'ps plus': 'Faturalar',
    'nintendo online': 'Faturalar',
    'steam': 'Faturalar',
    'epic games': 'Faturalar',
    'turkcell': 'Faturalar',
    'vodafone': 'Faturalar',
    'türk telekom': 'Faturalar',
    'turk telekom': 'Faturalar',
    'superonline': 'Faturalar',
    'ttnet': 'Faturalar',
    'turknet': 'Faturalar',
    'millenicom': 'Faturalar',
    'elektrik': 'Faturalar',
    'enerjisa': 'Faturalar',
    'başkent elektrik': 'Faturalar',
    'gediz elektrik': 'Faturalar',
    'ayedaş': 'Faturalar',
    'bedaş': 'Faturalar',
    'doğalgaz': 'Faturalar',
    'dogalgaz': 'Faturalar',
    'igdaş': 'Faturalar',
    'igdas': 'Faturalar',
    'esgaz': 'Faturalar',
    'başkentgaz': 'Faturalar',
    'izmirgaz': 'Faturalar',
    'su faturası': 'Faturalar',
    'iski': 'Faturalar',
    'aski': 'Faturalar',
    'izsu': 'Faturalar',
    'aidat': 'Faturalar',
    'apartman': 'Faturalar',
    'site': 'Faturalar',
    'yönetim': 'Faturalar',
    'kira': 'Faturalar',
    'rent': 'Faturalar',
    'sigorta': 'Faturalar',
    'insurance': 'Faturalar',
    'kasko': 'Faturalar',
    'trafik sigortası': 'Faturalar',
    'sağlık sigortası': 'Faturalar',
    'dask': 'Faturalar',
    'allianz': 'Faturalar',
    'axa': 'Faturalar',
    'anadolu sigorta': 'Faturalar',
    'aksigorta': 'Faturalar',
    'mapfre': 'Faturalar',

    // ═══════════════════════════════════════════════════════════════
    // DİĞER → Diğer
    // ═══════════════════════════════════════════════════════════════
    'hediye': 'Diğer',
    'gift': 'Diğer',
    'çiçek': 'Diğer',
    'cicek': 'Diğer',
    'çiçeksepeti': 'Diğer',
    'ciceksepeti': 'Diğer',
    'kuyumcu': 'Diğer',
    'jewelry': 'Diğer',
    'altın': 'Diğer',
    'altin': 'Diğer',
    'gold': 'Diğer',
    'gümüş': 'Diğer',
    'gumus': 'Diğer',
    'yüzük': 'Diğer',
    'kolye': 'Diğer',
    'bilezik': 'Diğer',
    'mobilya': 'Diğer',
    'furniture': 'Diğer',
    'istikbal': 'Diğer',
    'bellona': 'Diğer',
    'mondi': 'Diğer',
    'çilek': 'Diğer',
    'doğtaş': 'Diğer',
    'kelebek': 'Diğer',
    'enza home': 'Diğer',
    'yataş': 'Diğer',
    'english home': 'Diğer',
    'madame coco': 'Diğer',
    'karaca': 'Diğer',
    'petshop': 'Diğer',
    'pet shop': 'Diğer',
    'köpek': 'Diğer',
    'kedi': 'Diğer',
    'veteriner': 'Diğer',
    'bebek': 'Diğer',
    'baby': 'Diğer',
    'çocuk': 'Diğer',
    'oyuncak': 'Diğer',
    'toy': 'Diğer',
    'toyzz shop': 'Diğer',
    'lego': 'Diğer',
    'mothercare': 'Diğer',
    'ebebek': 'Diğer',
    'banka': 'Diğer',
    'bank': 'Diğer',
    'kredi': 'Diğer',
    'credit': 'Diğer',
    'faiz': 'Diğer',
    'taksit': 'Diğer',
    'atm': 'Diğer',
  };

  /// Verilen metinden kategori tahmini yap
  /// Case-insensitive ve partial match destekler
  static String? findCategory(String text) {
    if (text.isEmpty) return null;

    final searchText = text.toLowerCase().trim();

    // Tam eşleşme kontrolü
    if (_storeMap.containsKey(searchText)) {
      return _storeMap[searchText];
    }

    // Partial match - metin içinde anahtar var mı?
    for (final entry in _storeMap.entries) {
      if (searchText.contains(entry.key) || entry.key.contains(searchText)) {
        return entry.value;
      }
    }

    // Kelime bazlı arama
    final words = searchText.split(RegExp(r'\s+'));
    for (final word in words) {
      if (word.length < 2) continue;
      if (_storeMap.containsKey(word)) {
        return _storeMap[word];
      }
      // Partial match for words
      for (final entry in _storeMap.entries) {
        if (entry.key.startsWith(word) || word.startsWith(entry.key)) {
          return entry.value;
        }
      }
    }

    return null;
  }

  /// Debug: Toplam mağaza sayısını döndür
  static int get storeCount => _storeMap.length;

  /// Tüm kategorilerin listesi
  static List<String> get allCategories {
    return _storeMap.values.toSet().toList()..sort();
  }
}


--- FILE: lib/services/merchant_learning_service.dart ---

import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:fuzzywuzzy/fuzzywuzzy.dart';
import '../utils/global_merchants.dart';

/// Source of the merchant match
enum MatchSource {
  /// Matched from global merchant database
  global,

  /// Matched from user's learned merchants
  userLearned,

  /// Matched using fuzzy string matching
  fuzzyMatch,

  /// Matched from crowdsourced data (future)
  crowdsourced,
}

/// Represents a matched merchant result
class MerchantMatch {
  final String pattern;
  final String category;
  final String displayName;
  final double confidence;
  final MatchSource source;

  MerchantMatch({
    required this.pattern,
    required this.category,
    required this.displayName,
    required this.confidence,
    required this.source,
  });

  /// True if confidence is high enough for automatic matching
  bool get isAutoMatch => confidence >= 0.85;

  /// True if match is a suggestion (medium confidence)
  bool get isSuggestion => confidence >= 0.70 && confidence < 0.85;

  @override
  String toString() =>
      'MerchantMatch(pattern: $pattern, category: $category, confidence: $confidence, source: $source)';
}

/// A merchant learned from user input
class LearnedMerchant {
  final String pattern;
  final String category;
  final String displayName;
  final DateTime createdAt;
  int usageCount;

  LearnedMerchant({
    required this.pattern,
    required this.category,
    required this.displayName,
    required this.createdAt,
    this.usageCount = 1,
  });

  factory LearnedMerchant.fromMap(Map<String, dynamic> map) {
    return LearnedMerchant(
      pattern: map['pattern'] as String,
      category: map['category'] as String,
      displayName: map['displayName'] as String,
      createdAt: (map['createdAt'] as Timestamp).toDate(),
      usageCount: map['usageCount'] as int? ?? 1,
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'pattern': pattern,
      'category': category,
      'displayName': displayName,
      'createdAt': Timestamp.fromDate(createdAt),
      'usageCount': usageCount,
    };
  }
}

/// Service for learning and matching merchants from transaction descriptions
class MerchantLearningService {
  static final MerchantLearningService _instance = MerchantLearningService._();
  factory MerchantLearningService() => _instance;
  MerchantLearningService._();

  /// Local cache of learned merchants - avoid Firestore on every lookup
  final Map<String, LearnedMerchant> _localCache = {};
  bool _cacheLoaded = false;
  String? _loadedUserId;

  /// Load merchant cache from Firestore at app startup
  Future<void> loadCache(String userId) async {
    // Skip if already loaded for this user
    if (_cacheLoaded && _loadedUserId == userId) return;

    try {
      final snapshot = await FirebaseFirestore.instance
          .collection('users')
          .doc(userId)
          .collection('learned_merchants')
          .get();

      _localCache.clear();
      for (final doc in snapshot.docs) {
        final merchant = LearnedMerchant.fromMap(doc.data());
        _localCache[merchant.pattern] = merchant;
      }

      _cacheLoaded = true;
      _loadedUserId = userId;
    } catch (e) {
      // Continue with empty cache on error
      _cacheLoaded = true;
      _loadedUserId = userId;
    }
  }

  /// Clear cache (on logout)
  void clearCache() {
    _localCache.clear();
    _cacheLoaded = false;
    _loadedUserId = null;
  }

  /// Normalize text for matching - clean bank noise from descriptions
  String normalize(String text) {
    return text
        .toUpperCase()
        // Turkish characters to ASCII for matching
        .replaceAll('İ', 'I')
        .replaceAll('Ş', 'S')
        .replaceAll('Ğ', 'G')
        .replaceAll('Ü', 'U')
        .replaceAll('Ö', 'O')
        .replaceAll('Ç', 'C')
        .replaceAll('I', 'I') // Turkish dotless I
        // Clean bank terminology
        .replaceAll(RegExp(r'POS\s*'), '')
        .replaceAll(RegExp(r'SATIS\s*'), '')
        .replaceAll(RegExp(r'KK\s*'), '')
        .replaceAll(RegExp(r'KREDI KARTI\s*'), '')
        .replaceAll(RegExp(r'HARCAMA\s*'), '')
        .replaceAll(RegExp(r'ISLEM\s*'), '')
        .replaceAll(RegExp(r'ODEME\s*'), '')
        .replaceAll(RegExp(r'INTERNET\s*'), '')
        .replaceAll(RegExp(r'MOBIL\s*'), '')
        .replaceAll(RegExp(r'ONLINE\s*'), '')
        .replaceAll(RegExp(r'FATURA\s*'), '')
        .replaceAll(RegExp(r'OTOMATIK\s*'), '')
        // Clean dates, times, receipt numbers
        .replaceAll(RegExp(r'\d{2}[/.-]\d{2}[/.-]\d{2,4}'), '')
        .replaceAll(RegExp(r'\d{2}:\d{2}'), '')
        .replaceAll(RegExp(r'#\d+'), '')
        .replaceAll(RegExp(r'REF[:\s]*\w+'), '')
        .replaceAll(RegExp(r'FIS[:\s]*\d+'), '')
        // Clean special characters
        .replaceAll(RegExp(r'[^A-Z0-9\s&]'), '')
        // Multiple spaces to single
        .replaceAll(RegExp(r'\s+'), ' ')
        .trim();
  }

  /// Main search function - find merchant from raw description
  Future<MerchantMatch?> findMerchant(String rawDescription) async {
    final normalized = normalize(rawDescription);

    if (normalized.isEmpty) return null;

    // 1. First check EXACT MATCH in local cache (user learned)
    for (final entry in _localCache.entries) {
      if (normalized.contains(entry.key) || entry.key.contains(normalized)) {
        return MerchantMatch(
          pattern: entry.key,
          category: entry.value.category,
          displayName: entry.value.displayName,
          confidence: 1.0,
          source: MatchSource.userLearned,
        );
      }
    }

    // 2. Check global merchants database
    final globalCategory = GlobalMerchants.getCategory(normalized);
    if (globalCategory != null) {
      final merchantName = GlobalMerchants.getMerchantName(normalized)!;
      return MerchantMatch(
        pattern: merchantName,
        category: globalCategory,
        displayName: GlobalMerchants.getDisplayName(merchantName),
        confidence: 1.0,
        source: MatchSource.global,
      );
    }

    // 3. FUZZY MATCH - find similar in local cache
    MerchantMatch? bestFuzzyMatch;
    int bestScore = 0;

    for (final entry in _localCache.entries) {
      // Use fuzzywuzzy ratio for similarity
      final score = ratio(entry.key, normalized);
      if (score > bestScore && score >= 70) {
        bestScore = score;
        bestFuzzyMatch = MerchantMatch(
          pattern: entry.key,
          category: entry.value.category,
          displayName: entry.value.displayName,
          confidence: score / 100.0,
          source: MatchSource.fuzzyMatch,
        );
      }
    }

    // Return fuzzy match if found
    // 0.85+ = auto match, 0.70-0.85 = suggestion
    if (bestFuzzyMatch != null) {
      return bestFuzzyMatch;
    }

    // 4. No match found
    return null;
  }

  /// Learn a new merchant from user input
  Future<void> learnMerchant({
    required String userId,
    required String rawDescription,
    required String category,
    required String displayName,
  }) async {
    final pattern = normalize(rawDescription);

    // Don't save very short patterns (false positive prevention)
    if (pattern.length < 4) return;

    final learned = LearnedMerchant(
      pattern: pattern,
      category: category,
      displayName: displayName,
      createdAt: DateTime.now(),
      usageCount: 1,
    );

    try {
      // Save to Firestore
      await FirebaseFirestore.instance
          .collection('users')
          .doc(userId)
          .collection('learned_merchants')
          .doc(pattern.hashCode.abs().toString())
          .set(learned.toMap(), SetOptions(merge: true));

      // Update local cache
      _localCache[pattern] = learned;
    } catch (e) {
      // Still update local cache even if Firestore fails
      _localCache[pattern] = learned;
    }
  }

  /// Increment usage count for a pattern (for confidence scoring)
  Future<void> incrementUsage(String userId, String pattern) async {
    if (!_localCache.containsKey(pattern)) return;

    _localCache[pattern]!.usageCount++;

    try {
      await FirebaseFirestore.instance
          .collection('users')
          .doc(userId)
          .collection('learned_merchants')
          .doc(pattern.hashCode.abs().toString())
          .update({'usageCount': FieldValue.increment(1)});
    } catch (e) {
      // Ignore Firestore errors for usage increment
    }
  }

  /// Delete a learned merchant
  Future<void> deleteMerchant(String userId, String pattern) async {
    _localCache.remove(pattern);

    try {
      await FirebaseFirestore.instance
          .collection('users')
          .doc(userId)
          .collection('learned_merchants')
          .doc(pattern.hashCode.abs().toString())
          .delete();
    } catch (e) {
      // Ignore errors
    }
  }

  /// Get all learned merchants for display
  List<LearnedMerchant> getAllLearnedMerchants() {
    return _localCache.values.toList()
      ..sort((a, b) => b.usageCount.compareTo(a.usageCount));
  }

  /// Check if cache is loaded
  bool get isCacheLoaded => _cacheLoaded;

  /// Get count of learned merchants
  int get learnedMerchantCount => _localCache.length;
}


--- FILE: lib/services/pursuit_service.dart ---

import 'dart:async';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import '../models/models.dart';

/// Service for managing pursuits (savings goals)
/// Follows the same lock mechanism pattern as ExpenseHistoryService
class PursuitService {
  static const _keyPursuits = 'pursuits_v1';
  static const _keyTransactions = 'pursuit_transactions_v1';

  // Firestore references
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final FirebaseAuth _auth = FirebaseAuth.instance;

  // Future chain pattern - ensures FIFO execution without race conditions
  static Future<void> _chain = Future.value();

  /// Get current user's UID
  String? get _userId => _auth.currentUser?.uid;

  /// Firestore pursuits collection reference
  CollectionReference<Map<String, dynamic>>? get _pursuitsCollection {
    final uid = _userId;
    if (uid == null) return null;
    return _firestore.collection('users').doc(uid).collection('pursuits');
  }

  /// Firestore transactions collection reference
  CollectionReference<Map<String, dynamic>>? get _transactionsCollection {
    final uid = _userId;
    if (uid == null) return null;
    return _firestore
        .collection('users')
        .doc(uid)
        .collection('pursuit_transactions');
  }

  /// Lock mechanism - operations run in FIFO order
  Future<T> _withLock<T>(Future<T> Function() operation) async {
    final previous = _chain;
    final completer = Completer<void>();
    _chain = completer.future;

    await previous;

    try {
      return await operation();
    } finally {
      completer.complete();
    }
  }

  // ============================================
  // PURSUIT CRUD OPERATIONS
  // ============================================

  /// Get all pursuits (both active and completed)
  Future<List<Pursuit>> getAllPursuits() async {
    final prefs = await SharedPreferences.getInstance();
    final json = prefs.getString(_keyPursuits);

    if (json == null || json.isEmpty) {
      return [];
    }

    try {
      return Pursuit.decodeList(json);
    } catch (e) {
      return [];
    }
  }

  /// Get active (not archived, not completed) pursuits
  Future<List<Pursuit>> getActivePursuits() async {
    final all = await getAllPursuits();
    return all.where((p) => !p.isArchived && !p.isCompleted).toList()
      ..sort((a, b) => a.sortOrder.compareTo(b.sortOrder));
  }

  /// Get completed pursuits
  Future<List<Pursuit>> getCompletedPursuits() async {
    final all = await getAllPursuits();
    return all.where((p) => p.isCompleted).toList()..sort(
      (a, b) => (b.completedAt ?? b.updatedAt).compareTo(
        a.completedAt ?? a.updatedAt,
      ),
    );
  }

  /// Get a single pursuit by ID
  Future<Pursuit?> getPursuitById(String id) async {
    final all = await getAllPursuits();
    try {
      return all.firstWhere((p) => p.id == id);
    } catch (e) {
      return null;
    }
  }

  /// Create a new pursuit
  Future<void> createPursuit(Pursuit pursuit) async {
    await _withLock(() async {
      final pursuits = await getAllPursuits();
      pursuits.insert(0, pursuit);
      await _savePursuits(pursuits);

      // Sync to Firestore
      await _syncPursuitToFirestore(pursuit);
    });
  }

  /// Update an existing pursuit
  Future<void> updatePursuit(Pursuit pursuit) async {
    await _withLock(() async {
      final pursuits = await getAllPursuits();
      final index = pursuits.indexWhere((p) => p.id == pursuit.id);

      if (index != -1) {
        final updated = pursuit.copyWith(updatedAt: DateTime.now());
        pursuits[index] = updated;
        await _savePursuits(pursuits);

        // Sync to Firestore
        await _syncPursuitToFirestore(updated);
      }
    });
  }

  /// Add savings to a pursuit
  Future<void> addSavings(
    String pursuitId,
    double amount,
    TransactionSource source, {
    String? note,
    String? currency,
  }) async {
    await _withLock(() async {
      final pursuits = await getAllPursuits();
      final index = pursuits.indexWhere((p) => p.id == pursuitId);

      if (index != -1) {
        final pursuit = pursuits[index];
        final newSavedAmount = pursuit.savedAmount + amount;
        final updated = pursuit.copyWith(
          savedAmount: newSavedAmount,
          updatedAt: DateTime.now(),
        );
        pursuits[index] = updated;
        await _savePursuits(pursuits);

        // Create transaction record
        final transaction = PursuitTransaction.create(
          pursuitId: pursuitId,
          amount: amount,
          currency: currency ?? pursuit.currency,
          source: source,
          note: note,
        );
        await _addTransaction(transaction);

        // Sync to Firestore
        await _syncPursuitToFirestore(updated);
        await _syncTransactionToFirestore(transaction);
      }
    });
  }

  /// Mark a pursuit as completed
  Future<void> completePursuit(String pursuitId) async {
    await _withLock(() async {
      final pursuits = await getAllPursuits();
      final index = pursuits.indexWhere((p) => p.id == pursuitId);

      if (index != -1) {
        final updated = pursuits[index].copyWith(
          completedAt: DateTime.now(),
          updatedAt: DateTime.now(),
        );
        pursuits[index] = updated;
        await _savePursuits(pursuits);

        // Sync to Firestore
        await _syncPursuitToFirestore(updated);
      }
    });
  }

  /// Archive a pursuit (soft delete)
  Future<void> archivePursuit(String pursuitId) async {
    await _withLock(() async {
      final pursuits = await getAllPursuits();
      final index = pursuits.indexWhere((p) => p.id == pursuitId);

      if (index != -1) {
        final updated = pursuits[index].copyWith(
          isArchived: true,
          updatedAt: DateTime.now(),
        );
        pursuits[index] = updated;
        await _savePursuits(pursuits);

        // Sync to Firestore
        await _syncPursuitToFirestore(updated);
      }
    });
  }

  /// Delete a pursuit permanently
  Future<void> deletePursuit(String pursuitId) async {
    await _withLock(() async {
      final pursuits = await getAllPursuits();
      pursuits.removeWhere((p) => p.id == pursuitId);
      await _savePursuits(pursuits);

      // Delete from Firestore
      await _deletePursuitFromFirestore(pursuitId);

      // Delete associated transactions
      await _deleteTransactionsForPursuit(pursuitId);
    });
  }

  // ============================================
  // TRANSACTION OPERATIONS
  // ============================================

  /// Get all transactions for a pursuit
  Future<List<PursuitTransaction>> getTransactions(String pursuitId) async {
    final prefs = await SharedPreferences.getInstance();
    final json = prefs.getString(_keyTransactions);

    if (json == null || json.isEmpty) {
      return [];
    }

    try {
      final all = PursuitTransaction.decodeList(json);
      return all.where((t) => t.pursuitId == pursuitId).toList()
        ..sort((a, b) => b.createdAt.compareTo(a.createdAt));
    } catch (e) {
      return [];
    }
  }

  /// Add a transaction record
  Future<void> _addTransaction(PursuitTransaction transaction) async {
    final prefs = await SharedPreferences.getInstance();
    final json = prefs.getString(_keyTransactions);

    List<PursuitTransaction> transactions = [];
    if (json != null && json.isNotEmpty) {
      try {
        transactions = PursuitTransaction.decodeList(json);
      } catch (e) {
        // Start fresh if corrupted
      }
    }

    transactions.insert(0, transaction);
    await prefs.setString(
      _keyTransactions,
      PursuitTransaction.encodeList(transactions),
    );
  }

  /// Delete all transactions for a pursuit
  Future<void> _deleteTransactionsForPursuit(String pursuitId) async {
    final prefs = await SharedPreferences.getInstance();
    final json = prefs.getString(_keyTransactions);

    if (json == null || json.isEmpty) return;

    try {
      final transactions = PursuitTransaction.decodeList(json);
      transactions.removeWhere((t) => t.pursuitId == pursuitId);
      await prefs.setString(
        _keyTransactions,
        PursuitTransaction.encodeList(transactions),
      );
    } catch (e) {
      // Ignore errors
    }
  }

  // ============================================
  // FREE TIER LIMIT
  // ============================================

  /// Check if user can create a new pursuit (Free: 1 max)
  Future<bool> canCreatePursuit(bool isPremium) async {
    if (isPremium) return true;

    final pursuits = await getActivePursuits();
    return pursuits.isEmpty;
  }

  /// Get the active pursuit count
  Future<int> getActivePursuitCount() async {
    final pursuits = await getActivePursuits();
    return pursuits.length;
  }

  // ============================================
  // LOCAL STORAGE
  // ============================================

  Future<void> _savePursuits(List<Pursuit> pursuits) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(_keyPursuits, Pursuit.encodeList(pursuits));
  }

  /// Clear all local data (for testing)
  Future<void> clearAll() async {
    await _withLock(() async {
      final prefs = await SharedPreferences.getInstance();
      await prefs.remove(_keyPursuits);
      await prefs.remove(_keyTransactions);
    });
  }

  // ============================================
  // FIRESTORE SYNC
  // ============================================

  Future<void> _syncPursuitToFirestore(Pursuit pursuit) async {
    final collection = _pursuitsCollection;
    if (collection == null) return;

    try {
      await collection.doc(pursuit.id).set({
        ...pursuit.toJson(),
        'updatedAt': FieldValue.serverTimestamp(),
      });
    } catch (e) {
      // Silent fail - local storage is primary
    }
  }

  Future<void> _syncTransactionToFirestore(
    PursuitTransaction transaction,
  ) async {
    final collection = _transactionsCollection;
    if (collection == null) return;

    try {
      await collection.doc(transaction.id).set({
        ...transaction.toJson(),
        'createdAt': FieldValue.serverTimestamp(),
      });
    } catch (e) {
      // Silent fail - local storage is primary
    }
  }

  Future<void> _deletePursuitFromFirestore(String pursuitId) async {
    final collection = _pursuitsCollection;
    if (collection == null) return;

    try {
      await collection.doc(pursuitId).delete();
    } catch (e) {
      // Silent fail
    }
  }

  /// Sync all local pursuits to Firestore
  Future<void> syncAllToFirestore() async {
    final collection = _pursuitsCollection;
    if (collection == null) return;

    try {
      final pursuits = await getAllPursuits();
      if (pursuits.isEmpty) return;

      final batch = _firestore.batch();
      for (final pursuit in pursuits) {
        batch.set(collection.doc(pursuit.id), {
          ...pursuit.toJson(),
          'updatedAt': FieldValue.serverTimestamp(),
        });
      }
      await batch.commit();
    } catch (e) {
      // Silent fail
    }
  }

  /// Restore pursuits from Firestore
  Future<void> syncFromFirestore() async {
    final collection = _pursuitsCollection;
    if (collection == null) return;

    try {
      final snapshots = await collection
          .orderBy('createdAt', descending: true)
          .get();

      if (snapshots.docs.isEmpty) return;

      final pursuits = snapshots.docs
          .map((doc) => Pursuit.fromJson(doc.data()))
          .toList();

      await _savePursuits(pursuits);
    } catch (e) {
      // Silent fail
    }
  }
}


--- FILE: lib/services/sub_category_service.dart ---

import 'dart:convert';
import 'package:shared_preferences/shared_preferences.dart';
import '../utils/security_utils.dart';

/// Alt kategori öneri ve geçmiş yönetimi servisi
class SubCategoryService {
  static const _keyPrefix = 'recent_subcategories_';
  static const _maxRecentCount = 5;

  /// Ana kategoriye göre sabit öneriler
  static const Map<String, List<String>> fixedSuggestions = {
    'Yiyecek': ['Market', 'Kafe', 'Restoran'],
    'Giyim': ['Ayakkabı', 'Bot', 'Kaban'],
    'Ulaşım': ['Benzin', 'Taksi', 'Akbil'],
    'Elektronik': ['Telefon', 'Bilgisayar', 'Aksesuar'],
    'Eğlence': ['Sinema', 'Oyun', 'Konser'],
    'Sağlık': ['İlaç', 'Muayene', 'Vitamin'],
    'Eğitim': ['Kitap', 'Kurs', 'Yazılım'],
    'Faturalar': ['Elektrik', 'Su', 'İnternet'],
    'Diğer': ['Hediye', 'Abonelik', 'Bakım'],
  };

  /// Alt kategori metnini normalize ve sanitize et
  /// - Sanitize (control karakterleri kaldır)
  /// - trim
  /// - Max length limit
  /// - İlk harf büyük, geri kalan küçük
  /// - Türkçe karakterleri koru
  static String normalize(String text) {
    // First sanitize to remove control characters
    final sanitized = SecurityUtils.sanitizeAndTrim(
      text,
      maxLength: SecurityUtils.maxDescriptionLength,
    );
    if (sanitized.isEmpty) return '';

    // İlk harfi büyük, gerisini küçük yap (Türkçe uyumlu)
    return _toTitleCase(sanitized);
  }

  /// Türkçe uyumlu title case
  static String _toTitleCase(String text) {
    if (text.isEmpty) return text;

    // Türkçe karakter haritası
    const lowerToUpper = {
      'a': 'A',
      'b': 'B',
      'c': 'C',
      'ç': 'Ç',
      'd': 'D',
      'e': 'E',
      'f': 'F',
      'g': 'G',
      'ğ': 'Ğ',
      'h': 'H',
      'ı': 'I',
      'i': 'İ',
      'j': 'J',
      'k': 'K',
      'l': 'L',
      'm': 'M',
      'n': 'N',
      'o': 'O',
      'ö': 'Ö',
      'p': 'P',
      'r': 'R',
      's': 'S',
      'ş': 'Ş',
      't': 'T',
      'u': 'U',
      'ü': 'Ü',
      'v': 'V',
      'y': 'Y',
      'z': 'Z',
    };

    const upperToLower = {
      'A': 'a',
      'B': 'b',
      'C': 'c',
      'Ç': 'ç',
      'D': 'd',
      'E': 'e',
      'F': 'f',
      'G': 'g',
      'Ğ': 'ğ',
      'H': 'h',
      'I': 'ı',
      'İ': 'i',
      'J': 'j',
      'K': 'k',
      'L': 'l',
      'M': 'm',
      'N': 'n',
      'O': 'o',
      'Ö': 'ö',
      'P': 'p',
      'R': 'r',
      'S': 's',
      'Ş': 'ş',
      'T': 't',
      'U': 'u',
      'Ü': 'ü',
      'V': 'v',
      'Y': 'y',
      'Z': 'z',
    };

    final buffer = StringBuffer();
    bool isFirst = true;

    for (final char in text.split('')) {
      if (isFirst) {
        // İlk harfi büyük yap
        buffer.write(lowerToUpper[char] ?? char.toUpperCase());
        isFirst = false;
      } else {
        // Diğer harfleri küçük yap
        buffer.write(upperToLower[char] ?? char.toLowerCase());
      }
    }

    return buffer.toString();
  }

  /// İki alt kategori aynı mı kontrol et (case-insensitive, normalize edilmiş)
  static bool isSame(String a, String b) {
    return normalize(a).toLowerCase() == normalize(b).toLowerCase();
  }

  /// Ana kategori için son kullanılan alt kategorileri getir
  Future<List<String>> getRecentSubCategories(String mainCategory) async {
    final prefs = await SharedPreferences.getInstance();
    final key = '$_keyPrefix${_sanitizeKey(mainCategory)}';
    final json = prefs.getString(key);

    if (json == null) return [];

    try {
      final list = jsonDecode(json) as List;
      return list.cast<String>();
    } catch (e) {
      return [];
    }
  }

  /// Ana kategori için yeni alt kategori ekle (en son kullanılana taşı)
  Future<void> addRecentSubCategory(
    String mainCategory,
    String subCategory,
  ) async {
    final normalized = normalize(subCategory);
    if (normalized.isEmpty) return;

    final prefs = await SharedPreferences.getInstance();
    final key = '$_keyPrefix${_sanitizeKey(mainCategory)}';

    // Mevcut listeyi al
    final current = await getRecentSubCategories(mainCategory);

    // Aynı olanı çıkar (case-insensitive)
    current.removeWhere((s) => isSame(s, normalized));

    // Başa ekle
    current.insert(0, normalized);

    // Maksimum 5 tut
    final trimmed = current.take(_maxRecentCount).toList();

    // Kaydet
    await prefs.setString(key, jsonEncode(trimmed));
  }

  /// Ana kategori için tüm önerileri getir (son kullanılanlar + sabit)
  Future<SubCategorySuggestions> getSuggestions(String mainCategory) async {
    final recent = await getRecentSubCategories(mainCategory);
    final fixed = fixedSuggestions[mainCategory] ?? [];

    // Sabit önerilerden son kullanılanlarda olmayanları filtrele
    final filteredFixed = fixed
        .where((f) => !recent.any((r) => isSame(r, f)))
        .toList();

    return SubCategorySuggestions(recent: recent, fixed: filteredFixed);
  }

  /// Key'i sanitize et (SharedPreferences için güvenli)
  String _sanitizeKey(String category) {
    return category
        .replaceAll(' ', '_')
        .replaceAll('ı', 'i')
        .replaceAll('ğ', 'g')
        .replaceAll('ü', 'u')
        .replaceAll('ş', 's')
        .replaceAll('ö', 'o')
        .replaceAll('ç', 'c')
        .replaceAll('İ', 'I')
        .replaceAll('Ğ', 'G')
        .replaceAll('Ü', 'U')
        .replaceAll('Ş', 'S')
        .replaceAll('Ö', 'O')
        .replaceAll('Ç', 'C')
        .toLowerCase();
  }
}

/// Alt kategori önerileri
class SubCategorySuggestions {
  final List<String> recent; // Son kullanılanlar (outline stil)
  final List<String> fixed; // Sabit öneriler (normal stil)

  const SubCategorySuggestions({required this.recent, required this.fixed});

  bool get isEmpty => recent.isEmpty && fixed.isEmpty;
  bool get hasRecent => recent.isNotEmpty;
  bool get hasFixed => fixed.isNotEmpty;
}


--- FILE: lib/services/calculation_service.dart ---

import '../models/models.dart';

class CalculationService {
  int workDaysInMonth(int year, int month, int workDaysPerWeek) {
    final totalDays = DateTime(year, month + 1, 0).day;
    int count = 0;

    for (int i = 1; i <= totalDays; i++) {
      final day = DateTime(year, month, i);
      final weekday = day.weekday; // 1=Mon ... 7=Sun

      if (workDaysPerWeek == 7) {
        count++;
      } else if (workDaysPerWeek == 6 && weekday != 7) {
        count++;
      } else if (workDaysPerWeek == 5 && weekday <= 5) {
        count++;
      } else if (workDaysPerWeek < 5 && weekday <= workDaysPerWeek) {
        count++;
      }
    }

    return count;
  }

  ExpenseResult calculateExpense({
    required UserProfile userProfile,
    required double expenseAmount,
    required int month,
    required int year,
  }) {
    final totalWorkDays = workDaysInMonth(
      year,
      month,
      userProfile.workDaysPerWeek,
    );

    final totalWorkHours = totalWorkDays * userProfile.dailyHours;
    final hoursRequired = userProfile.monthlyIncome > 0
        ? (expenseAmount / userProfile.monthlyIncome) * totalWorkHours
        : 0.0;
    final daysRequired = userProfile.dailyHours > 0
        ? hoursRequired / userProfile.dailyHours
        : 0.0;

    return ExpenseResult(
      expenseAmount: expenseAmount,
      hoursRequired: hoursRequired,
      daysRequired: daysRequired,
    );
  }
}


--- FILE: lib/services/app_security_service.dart ---

import 'dart:convert';
import 'dart:io';
import 'package:crypto/crypto.dart';
import 'package:flutter/foundation.dart';
import 'package:flutter/services.dart';

/// App Security Service
/// Provides reverse engineering protection and security checks
/// Tasks: Anti-tampering, Anti-debug, String encryption
class AppSecurityService {
  static final AppSecurityService _instance = AppSecurityService._internal();
  factory AppSecurityService() => _instance;
  AppSecurityService._internal();

  static const _channel = MethodChannel('com.vantag.app/security');

  // XOR key for string obfuscation (runtime decryption)
  static const _obfuscationKey = 0x5A;

  /// Perform comprehensive security check
  Future<SecurityCheckResult> performSecurityCheck() async {
    if (Platform.isAndroid) {
      return _performAndroidSecurityCheck();
    } else if (Platform.isIOS) {
      return _performIOSSecurityCheck();
    }
    return SecurityCheckResult(isSecure: true, issues: []);
  }

  Future<SecurityCheckResult> _performAndroidSecurityCheck() async {
    try {
      final result = await _channel.invokeMethod<Map>('checkSecurity');
      if (result == null) {
        return SecurityCheckResult(isSecure: true, issues: []);
      }

      return SecurityCheckResult(
        isSecure: result['isSecure'] as bool? ?? true,
        issues: (result['issues'] as List?)?.cast<String>() ?? [],
      );
    } on PlatformException catch (e) {
      debugPrint('[Security] Platform exception: ${e.message}');
      return SecurityCheckResult(isSecure: true, issues: []);
    }
  }

  Future<SecurityCheckResult> _performIOSSecurityCheck() async {
    // iOS security checks (basic)
    final issues = <String>[];

    // Check for jailbreak
    if (await _isIOSJailbroken()) {
      issues.add('DEVICE_JAILBROKEN');
    }

    return SecurityCheckResult(
      isSecure: issues.isEmpty,
      issues: issues,
    );
  }

  Future<bool> _isIOSJailbroken() async {
    if (!Platform.isIOS) return false;

    // Check for common jailbreak paths
    final jailbreakPaths = [
      '/Applications/Cydia.app',
      '/Library/MobileSubstrate/MobileSubstrate.dylib',
      '/bin/bash',
      '/usr/sbin/sshd',
      '/etc/apt',
      '/private/var/lib/apt/',
    ];

    for (final path in jailbreakPaths) {
      if (File(path).existsSync()) {
        return true;
      }
    }

    return false;
  }

  /// Check if device is rooted/jailbroken
  Future<bool> isDeviceCompromised() async {
    if (Platform.isAndroid) {
      try {
        final result = await _channel.invokeMethod<bool>('isRooted');
        return result ?? false;
      } catch (e) {
        return false;
      }
    } else if (Platform.isIOS) {
      return _isIOSJailbroken();
    }
    return false;
  }

  /// Check if debugger is attached
  Future<bool> isDebuggerAttached() async {
    if (kDebugMode) return false; // Skip in debug builds

    if (Platform.isAndroid) {
      try {
        final result = await _channel.invokeMethod<bool>('isDebuggerAttached');
        return result ?? false;
      } catch (e) {
        return false;
      }
    }
    return false;
  }

  /// Check if running in emulator
  Future<bool> isEmulator() async {
    if (Platform.isAndroid) {
      try {
        final result = await _channel.invokeMethod<bool>('isEmulator');
        return result ?? false;
      } catch (e) {
        return false;
      }
    }
    return false;
  }

  // ============================================
  // STRING ENCRYPTION/OBFUSCATION
  // ============================================

  /// Obfuscate a sensitive string for storage
  /// Uses XOR encryption - simple but effective for hiding strings from static analysis
  static String obfuscateString(String input) {
    final bytes = utf8.encode(input);
    final obfuscated = bytes.map((b) => b ^ _obfuscationKey).toList();
    return base64Encode(obfuscated);
  }

  /// Deobfuscate a string at runtime
  static String deobfuscateString(String obfuscated) {
    final bytes = base64Decode(obfuscated);
    final deobfuscated = bytes.map((b) => b ^ _obfuscationKey).toList();
    return utf8.decode(deobfuscated);
  }

  /// Hash a string (for integrity checking)
  static String hashString(String input) {
    final bytes = utf8.encode(input);
    final digest = sha256.convert(bytes);
    return digest.toString();
  }

  // ============================================
  // SECURE STRING STORAGE
  // Pre-obfuscated sensitive strings
  // ============================================

  /// Securely get API base URL
  /// Obfuscated at compile time, deobfuscated at runtime
  static String getSecureApiUrl() {
    // Obfuscated: "https://api.openai.com/v1"
    const obfuscated = "Mzo6OzsvLzM1KTsrLjU3JDMkNSEpLjA2JQ==";
    return deobfuscateString(obfuscated);
  }

  /// Securely get Firebase function URL
  static String getSecureFirebaseFunctionUrl() {
    // Obfuscated: "https://europe-west1-flutter-ai-playground"
    const obfuscated = "Mzo6OzsvLzU6ODs1NTMpNjU2Oz0tKycrPzozMzU2Kzk1Oy05Lyc6MDExPzs5JA==";
    return deobfuscateString(obfuscated);
  }
}

/// Security check result
class SecurityCheckResult {
  final bool isSecure;
  final List<String> issues;

  const SecurityCheckResult({
    required this.isSecure,
    required this.issues,
  });

  bool get isRooted => issues.contains('DEVICE_ROOTED');
  bool get isJailbroken => issues.contains('DEVICE_JAILBROKEN');
  bool get hasDebugger => issues.contains('DEBUGGER_ATTACHED');
  bool get hasHookingFramework => issues.contains('HOOKING_FRAMEWORK');
  bool get hasSignatureMismatch => issues.contains('SIGNATURE_MISMATCH');
  bool get isEmulator => issues.contains('EMULATOR_DETECTED');

  @override
  String toString() => 'SecurityCheckResult(isSecure: $isSecure, issues: $issues)';
}

/// Global instance
final appSecurityService = AppSecurityService();


--- FILE: lib/services/push_notification_service.dart ---

import 'dart:async';
import 'dart:convert';
import 'dart:io';
import 'package:flutter/foundation.dart';
import 'package:shared_preferences/shared_preferences.dart';

/// Push notification service for Firebase Cloud Messaging
/// Only active on iOS and Android platforms
/// On desktop platforms (Windows, macOS, Linux), this service is a no-op
class PushNotificationService {
  static final PushNotificationService _instance =
      PushNotificationService._internal();
  factory PushNotificationService() => _instance;
  PushNotificationService._internal();

  String? _fcmToken;
  String? get fcmToken => _fcmToken;

  // Pref keys
  static const _keyPushEnabled = 'push_enabled';
  static const _keyFcmToken = 'fcm_token';
  static const _keyTopics = 'push_topics';
  static const _keyQuietHoursStart = 'push_quiet_start';
  static const _keyQuietHoursEnd = 'push_quiet_end';
  static const _keyPreferredTime = 'push_preferred_time';
  static const _keyLastActivityHour = 'push_last_activity_hour';
  static const _keyActivityHours = 'push_activity_hours';
  static const _keyLastPushSent = 'push_last_sent';
  static const _keyPushHistory = 'push_history';

  /// Check if push notifications are supported on this platform
  bool get isSupported => !kIsWeb && (Platform.isIOS || Platform.isAndroid);

  /// Initialize push notifications
  /// No-op on unsupported platforms
  Future<void> initialize() async {
    if (!isSupported) {
      debugPrint('[Push] Not supported on this platform');
      return;
    }

    // Firebase Messaging initialization would happen here on iOS/Android
    // For now, this is a stub that will be implemented when building for mobile
    debugPrint('[Push] Service initialized (mobile implementation required)');
  }

  /// Save FCM token (will be used when Firebase Messaging is integrated)
  Future<void> saveToken(String? token) async {
    if (token == null) return;
    _fcmToken = token;
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(_keyFcmToken, token);
  }

  /// Subscribe to topic
  Future<void> subscribeToTopic(String topic) async {
    if (!isSupported) return;

    try {
      await _saveTopicSubscription(topic, true);
      debugPrint('[Push] Subscribed to topic: $topic');
    } catch (e) {
      debugPrint('[Push] Error subscribing to topic: $e');
    }
  }

  /// Unsubscribe from topic
  Future<void> unsubscribeFromTopic(String topic) async {
    if (!isSupported) return;

    try {
      await _saveTopicSubscription(topic, false);
      debugPrint('[Push] Unsubscribed from topic: $topic');
    } catch (e) {
      debugPrint('[Push] Error unsubscribing from topic: $e');
    }
  }

  /// Save topic subscription status
  Future<void> _saveTopicSubscription(String topic, bool subscribed) async {
    final prefs = await SharedPreferences.getInstance();
    final topicsJson = prefs.getString(_keyTopics) ?? '{}';
    final topics = Map<String, bool>.from(json.decode(topicsJson));
    topics[topic] = subscribed;
    await prefs.setString(_keyTopics, json.encode(topics));
  }

  /// Get subscribed topics
  Future<Map<String, bool>> getSubscribedTopics() async {
    final prefs = await SharedPreferences.getInstance();
    final topicsJson = prefs.getString(_keyTopics) ?? '{}';
    return Map<String, bool>.from(json.decode(topicsJson));
  }

  /// Check if push notifications are enabled
  Future<bool> isEnabled() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getBool(_keyPushEnabled) ?? true;
  }

  /// Enable/disable push notifications
  Future<void> setEnabled(bool enabled) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_keyPushEnabled, enabled);

    if (!enabled) {
      final topics = await getSubscribedTopics();
      for (final topic in topics.keys) {
        await unsubscribeFromTopic(topic);
      }
    }
  }

  /// Request permission (if not already granted)
  Future<bool> requestPermission() async {
    if (!isSupported) return false;
    // Would call FirebaseMessaging.requestPermission() on mobile
    return true;
  }

  /// Dispose resources
  void dispose() {
    // Cleanup subscriptions on mobile
  }

  // ===========================================
  // NOTIFICATION TIMING OPTIMIZATION
  // ===========================================

  /// Default quiet hours (22:00 - 08:00)
  static const int _defaultQuietStart = 22;
  static const int _defaultQuietEnd = 8;

  /// Record user activity to learn optimal notification time
  Future<void> recordUserActivity() async {
    final prefs = await SharedPreferences.getInstance();
    final now = DateTime.now();
    final hour = now.hour;

    // Store last activity hour
    await prefs.setInt(_keyLastActivityHour, hour);

    // Update activity hours histogram
    final histogramJson = prefs.getString(_keyActivityHours) ?? '{}';
    final histogram = Map<String, int>.from(json.decode(histogramJson));
    final hourKey = hour.toString();
    histogram[hourKey] = (histogram[hourKey] ?? 0) + 1;
    await prefs.setString(_keyActivityHours, json.encode(histogram));

    debugPrint('[Push] Recorded activity at hour: $hour');
  }

  /// Get optimal notification time based on user activity patterns
  Future<NotificationTime> getOptimalNotificationTime({
    PushNotificationType type = PushNotificationType.general,
  }) async {
    final prefs = await SharedPreferences.getInstance();

    // Check for user-preferred time
    final preferredHour = prefs.getInt(_keyPreferredTime);
    if (preferredHour != null) {
      return NotificationTime(
        hour: preferredHour,
        minute: 0,
        source: NotificationTimeSource.userPreferred,
      );
    }

    // Analyze activity histogram
    final histogramJson = prefs.getString(_keyActivityHours) ?? '{}';
    final histogram = Map<String, int>.from(json.decode(histogramJson));

    if (histogram.isNotEmpty) {
      // Find peak activity hour (excluding quiet hours)
      final quietStart = prefs.getInt(_keyQuietHoursStart) ?? _defaultQuietStart;
      final quietEnd = prefs.getInt(_keyQuietHoursEnd) ?? _defaultQuietEnd;

      int peakHour = 9; // Default
      int maxCount = 0;

      for (final entry in histogram.entries) {
        final hour = int.parse(entry.key);
        if (!_isQuietHour(hour, quietStart, quietEnd) && entry.value > maxCount) {
          maxCount = entry.value;
          peakHour = hour;
        }
      }

      // Adjust based on notification type
      final adjustedHour = _adjustTimeForType(peakHour, type);

      return NotificationTime(
        hour: adjustedHour,
        minute: 0,
        source: NotificationTimeSource.learned,
      );
    }

    // Fall back to type-specific defaults
    return _getDefaultTimeForType(type);
  }

  /// Adjust notification time based on type
  int _adjustTimeForType(int baseHour, PushNotificationType type) {
    switch (type) {
      case PushNotificationType.streakReminder:
        // Send in evening (before bed) to remind about daily tracking
        return baseHour < 18 ? 20 : baseHour;
      case PushNotificationType.morningMotivation:
        // Send in morning
        return baseHour > 10 ? 9 : baseHour;
      case PushNotificationType.weeklyInsight:
        // Send on Sunday morning
        return 10;
      case PushNotificationType.reengagement:
        // Send during peak activity
        return baseHour;
      case PushNotificationType.achievement:
        // Send immediately (no adjustment)
        return baseHour;
      case PushNotificationType.general:
        return baseHour;
    }
  }

  /// Get default time for notification type
  NotificationTime _getDefaultTimeForType(PushNotificationType type) {
    switch (type) {
      case PushNotificationType.streakReminder:
        return const NotificationTime(
          hour: 20,
          minute: 0,
          source: NotificationTimeSource.defaultTime,
        );
      case PushNotificationType.morningMotivation:
        return const NotificationTime(
          hour: 9,
          minute: 0,
          source: NotificationTimeSource.defaultTime,
        );
      case PushNotificationType.weeklyInsight:
        return const NotificationTime(
          hour: 10,
          minute: 0,
          source: NotificationTimeSource.defaultTime,
        );
      case PushNotificationType.reengagement:
        return const NotificationTime(
          hour: 12,
          minute: 0,
          source: NotificationTimeSource.defaultTime,
        );
      case PushNotificationType.achievement:
      case PushNotificationType.general:
        return const NotificationTime(
          hour: 12,
          minute: 0,
          source: NotificationTimeSource.defaultTime,
        );
    }
  }

  /// Check if hour is within quiet hours
  bool _isQuietHour(int hour, int quietStart, int quietEnd) {
    if (quietStart < quietEnd) {
      // e.g., 1:00 - 6:00
      return hour >= quietStart && hour < quietEnd;
    } else {
      // e.g., 22:00 - 8:00 (spans midnight)
      return hour >= quietStart || hour < quietEnd;
    }
  }

  /// Set user-preferred notification time
  Future<void> setPreferredNotificationTime(int hour) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setInt(_keyPreferredTime, hour);
    debugPrint('[Push] Set preferred time: $hour:00');
  }

  /// Set quiet hours
  Future<void> setQuietHours({required int startHour, required int endHour}) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setInt(_keyQuietHoursStart, startHour);
    await prefs.setInt(_keyQuietHoursEnd, endHour);
    debugPrint('[Push] Set quiet hours: $startHour:00 - $endHour:00');
  }

  /// Get quiet hours settings
  Future<QuietHours> getQuietHours() async {
    final prefs = await SharedPreferences.getInstance();
    return QuietHours(
      startHour: prefs.getInt(_keyQuietHoursStart) ?? _defaultQuietStart,
      endHour: prefs.getInt(_keyQuietHoursEnd) ?? _defaultQuietEnd,
    );
  }

  /// Check if now is within quiet hours
  Future<bool> isCurrentlyQuietHours() async {
    final quietHours = await getQuietHours();
    final currentHour = DateTime.now().hour;
    return _isQuietHour(currentHour, quietHours.startHour, quietHours.endHour);
  }

  /// Calculate next allowed notification time (respects quiet hours)
  Future<DateTime> getNextAllowedNotificationTime({
    PushNotificationType type = PushNotificationType.general,
  }) async {
    final optimalTime = await getOptimalNotificationTime(type: type);
    final quietHours = await getQuietHours();
    final now = DateTime.now();

    // Create target datetime for today
    var target = DateTime(now.year, now.month, now.day, optimalTime.hour, optimalTime.minute);

    // If target is in the past or during quiet hours, adjust
    if (target.isBefore(now)) {
      target = target.add(const Duration(days: 1));
    }

    // Ensure not during quiet hours
    while (_isQuietHour(target.hour, quietHours.startHour, quietHours.endHour)) {
      target = target.add(const Duration(hours: 1));
    }

    return target;
  }

  /// Record that a push was sent (for rate limiting)
  Future<void> recordPushSent(PushNotificationType type) async {
    final prefs = await SharedPreferences.getInstance();
    final now = DateTime.now().toIso8601String();
    await prefs.setString(_keyLastPushSent, now);

    // Update push history
    final historyJson = prefs.getString(_keyPushHistory) ?? '[]';
    final history = List<Map<String, dynamic>>.from(json.decode(historyJson));
    history.add({
      'type': type.name,
      'timestamp': now,
    });
    // Keep last 50 entries
    if (history.length > 50) {
      history.removeRange(0, history.length - 50);
    }
    await prefs.setString(_keyPushHistory, json.encode(history));
  }

  /// Check if we should send a push (rate limiting)
  Future<bool> shouldSendPush({
    required PushNotificationType type,
    Duration minimumInterval = const Duration(hours: 4),
  }) async {
    // Check quiet hours first
    if (await isCurrentlyQuietHours()) {
      debugPrint('[Push] Currently in quiet hours, skipping');
      return false;
    }

    final prefs = await SharedPreferences.getInstance();
    final lastSentStr = prefs.getString(_keyLastPushSent);

    if (lastSentStr != null) {
      final lastSent = DateTime.tryParse(lastSentStr);
      if (lastSent != null) {
        final timeSince = DateTime.now().difference(lastSent);
        if (timeSince < minimumInterval) {
          debugPrint('[Push] Rate limited: ${timeSince.inMinutes}m since last push');
          return false;
        }
      }
    }

    return true;
  }

  // ===========================================
  // SCHEDULED NOTIFICATION SEQUENCES
  // ===========================================

  /// Schedule onboarding notification sequence (Day 1, 3, 7)
  Future<void> scheduleOnboardingSequence() async {
    if (!isSupported) return;

    debugPrint('[Push] Scheduling onboarding sequence');

    // Day 1: Evening reminder to add expense
    await _scheduleNotification(
      id: 'onboarding_day1',
      title: 'İlk harcamanı ekle!',
      body: 'Bir kahve veya yemek - küçük başla, farkı gör.',
      delay: const Duration(hours: 8),
      type: PushNotificationType.general,
    );

    // Day 3: Value reminder
    await _scheduleNotification(
      id: 'onboarding_day3',
      title: 'Kaç saat çalıştığını biliyor musun?',
      body: 'Harcamalarını saat olarak görmeye devam et.',
      delay: const Duration(days: 3),
      type: PushNotificationType.morningMotivation,
    );

    // Day 7: Streak motivation
    await _scheduleNotification(
      id: 'onboarding_day7',
      title: '7 gün oldu! 🎉',
      body: 'Streak başlatmak için her gün bir harcama ekle.',
      delay: const Duration(days: 7),
      type: PushNotificationType.streakReminder,
    );
  }

  /// Schedule weekly insight notification (Sunday morning)
  Future<void> scheduleWeeklyInsightNotification() async {
    if (!isSupported) return;

    final now = DateTime.now();
    final daysUntilSunday = (DateTime.sunday - now.weekday) % 7;
    final nextSunday = now.add(Duration(days: daysUntilSunday == 0 ? 7 : daysUntilSunday));
    final scheduledTime = DateTime(nextSunday.year, nextSunday.month, nextSunday.day, 10, 0);

    await _scheduleNotification(
      id: 'weekly_insight',
      title: 'Haftalık Özet Hazır 📊',
      body: 'Bu hafta ne kadar tasarruf ettin? Hemen kontrol et.',
      scheduledTime: scheduledTime,
      type: PushNotificationType.weeklyInsight,
    );

    debugPrint('[Push] Weekly insight scheduled for: $scheduledTime');
  }

  /// Schedule daily streak reminder (evening)
  Future<void> scheduleDailyStreakReminder({required int currentStreak}) async {
    if (!isSupported) return;

    final optimalTime = await getOptimalNotificationTime(type: PushNotificationType.streakReminder);
    final now = DateTime.now();
    var scheduledTime = DateTime(now.year, now.month, now.day, optimalTime.hour, 0);

    // If time has passed, schedule for tomorrow
    if (scheduledTime.isBefore(now)) {
      scheduledTime = scheduledTime.add(const Duration(days: 1));
    }

    String title;
    String body;

    if (currentStreak == 0) {
      title = 'Yeni bir seri başlat!';
      body = 'Bugün ilk harcamanı ekle ve yolculuğa başla.';
    } else if (currentStreak < 7) {
      title = '$currentStreak günlük serin var!';
      body = 'Bugün de ekle, serini koru.';
    } else if (currentStreak < 30) {
      title = '🔥 $currentStreak gün! Harika gidiyorsun!';
      body = 'Seriyi bozmamak için bugün de ekle.';
    } else {
      title = '🏆 $currentStreak günlük seri!';
      body = 'İnanılmaz bir başarı! Devam et.';
    }

    await _scheduleNotification(
      id: 'streak_reminder',
      title: title,
      body: body,
      scheduledTime: scheduledTime,
      type: PushNotificationType.streakReminder,
    );

    debugPrint('[Push] Streak reminder scheduled for: $scheduledTime');
  }

  /// Schedule morning motivation (9 AM)
  Future<void> scheduleMorningMotivation({
    required double savedThisMonth,
    required String currencySymbol,
  }) async {
    if (!isSupported) return;

    final now = DateTime.now();
    var scheduledTime = DateTime(now.year, now.month, now.day, 9, 0);

    if (scheduledTime.isBefore(now)) {
      scheduledTime = scheduledTime.add(const Duration(days: 1));
    }

    String title;
    String body;

    if (savedThisMonth > 0) {
      title = 'Günaydın! ☀️';
      body = 'Bu ay $currencySymbol${savedThisMonth.toStringAsFixed(0)} tasarruf ettin. Devam!';
    } else {
      title = 'Günaydın! ☀️';
      body = 'Bugün bir harcama ekleyerek finansal farkındalığını artır.';
    }

    await _scheduleNotification(
      id: 'morning_motivation',
      title: title,
      body: body,
      scheduledTime: scheduledTime,
      type: PushNotificationType.morningMotivation,
    );
  }

  /// Internal method to schedule a notification
  Future<void> _scheduleNotification({
    required String id,
    required String title,
    required String body,
    Duration? delay,
    DateTime? scheduledTime,
    required PushNotificationType type,
  }) async {
    if (!isSupported) return;

    final targetTime = scheduledTime ?? DateTime.now().add(delay ?? Duration.zero);

    // Check quiet hours
    final quietHours = await getQuietHours();
    if (_isQuietHour(targetTime.hour, quietHours.startHour, quietHours.endHour)) {
      debugPrint('[Push] Notification $id would be during quiet hours, adjusting');
      // Adjust to next morning
      final adjusted = DateTime(
        targetTime.year,
        targetTime.month,
        targetTime.day,
        quietHours.endHour,
        0,
      );
      debugPrint('[Push] Adjusted time: $adjusted');
    }

    // Note: Actual scheduling would use flutter_local_notifications or FCM
    debugPrint('[Push] Schedule: $id at $targetTime - $title');
  }

  // ===========================================
  // RE-ENGAGEMENT NOTIFICATIONS
  // ============================================

  /// Schedule re-engagement notification for stalled users
  Future<void> scheduleReengagementNotification({
    required int daysSinceActive,
  }) async {
    if (!isSupported) return;

    // Push message varies based on inactivity period
    String title;
    String body;

    if (daysSinceActive <= 3) {
      title = 'Harcamalarını takip etmeyi unutma!';
      body = 'Bugün ne kadar tasarruf ettin? Hemen gir ve gör.';
    } else if (daysSinceActive <= 5) {
      title = 'Seni özledik! 👋';
      body = 'Finansal hedeflerine ulaşmak için devam et.';
    } else {
      title = 'Geri dön, serinin bozulmasın!';
      body = 'Streak\'ini kaybetme, hemen bir harcama ekle.';
    }

    // Note: Actual scheduling would use FirebaseMessaging on mobile
    // This logs the intent for now
    debugPrint('[Push] Schedule re-engagement: $title - $body (days: $daysSinceActive)');
  }

  /// Schedule urgent re-engagement for critical users (7+ days inactive)
  Future<void> scheduleUrgentReengagementNotification({
    required int daysSinceActive,
  }) async {
    if (!isSupported) return;

    String title;
    String body;

    if (daysSinceActive <= 10) {
      title = 'Finansal kontrolün elden kaçmasın!';
      body = 'Bir hafta oldu, harcamalarını güncelle.';
    } else if (daysSinceActive <= 14) {
      title = 'Hedeflerine ulaşmak hâlâ mümkün!';
      body = 'Geri dön ve nereden kaldığına bak.';
    } else {
      title = 'Vantag seni bekliyor!';
      body = 'Tek bir harcama ekleyerek yeniden başla.';
    }

    debugPrint('[Push] Schedule urgent re-engagement: $title - $body (days: $daysSinceActive)');
  }

  /// Schedule streak reminder (evening)
  Future<void> scheduleStreakReminder({
    required int currentStreak,
  }) async {
    if (!isSupported) return;

    final title = '$currentStreak günlük serin var!';
    const body = 'Bugünkü harcamanı ekleyerek serini koru.';

    debugPrint('[Push] Schedule streak reminder: $title - $body');
  }

  /// Schedule milestone celebration push
  Future<void> scheduleMilestoneCelebration({
    required String milestoneName,
    required String message,
  }) async {
    if (!isSupported) return;

    debugPrint('[Push] Schedule milestone: $milestoneName - $message');
  }
}

/// Global instance
final pushNotifications = PushNotificationService();

/// Available push notification topics
class PushTopics {
  static const String general = 'general';
  static const String tips = 'tips';
  static const String promos = 'promos';
  static const String achievements = 'achievements';
  static const String weeklyInsights = 'weekly_insights';
  static const String streakReminders = 'streak_reminders';
  static const String morningMotivation = 'morning_motivation';
  static const String reengagement = 'reengagement';
}

/// Notification types for timing optimization
enum PushNotificationType {
  general,
  streakReminder,
  morningMotivation,
  weeklyInsight,
  reengagement,
  achievement,
}

/// Source of notification time calculation
enum NotificationTimeSource {
  userPreferred,
  learned,
  defaultTime,
}

/// Notification time model
class NotificationTime {
  final int hour;
  final int minute;
  final NotificationTimeSource source;

  const NotificationTime({
    required this.hour,
    required this.minute,
    required this.source,
  });

  @override
  String toString() => '${hour.toString().padLeft(2, '0')}:${minute.toString().padLeft(2, '0')} ($source)';
}

/// Quiet hours model
class QuietHours {
  final int startHour;
  final int endHour;

  const QuietHours({
    required this.startHour,
    required this.endHour,
  });

  @override
  String toString() => '${startHour.toString().padLeft(2, '0')}:00 - ${endHour.toString().padLeft(2, '0')}:00';
}

/// Push notification schedule item
class ScheduledNotification {
  final String id;
  final String title;
  final String body;
  final DateTime scheduledTime;
  final PushNotificationType type;
  final bool sent;

  const ScheduledNotification({
    required this.id,
    required this.title,
    required this.body,
    required this.scheduledTime,
    required this.type,
    this.sent = false,
  });

  Map<String, dynamic> toJson() => {
    'id': id,
    'title': title,
    'body': body,
    'scheduledTime': scheduledTime.toIso8601String(),
    'type': type.name,
    'sent': sent,
  };

  factory ScheduledNotification.fromJson(Map<String, dynamic> json) {
    return ScheduledNotification(
      id: json['id'] as String,
      title: json['title'] as String,
      body: json['body'] as String,
      scheduledTime: DateTime.parse(json['scheduledTime'] as String),
      type: PushNotificationType.values.firstWhere(
        (e) => e.name == json['type'],
        orElse: () => PushNotificationType.general,
      ),
      sent: json['sent'] as bool? ?? false,
    );
  }
}


--- FILE: lib/services/messages_service.dart ---

import 'dart:math';
import 'package:flutter/material.dart';
import 'package:vantag/l10n/app_localizations.dart';

enum DurationCategory {
  short, // 1-8 hours
  medium, // 1-7 days
  long, // 7+ days
  simulation, // 100.000 TL+ (Special category)
}

enum DecisionType {
  yes, // Bought
  no, // Passed
  thinking, // Thinking
}

class MessagesService {
  final _random = Random();
  final List<int> _recentMessageIndices = [];
  static const _maxRecentMessages = 5;

  // Per-category tracking for no-repeat in last 3
  static final Map<String, List<int>> _recentByCategory = {};
  static const int _noRepeatCount = 3;

  // ============================================
  // MESSAGE SELECTION LOGIC
  // ============================================

  /// Determine category based on duration AND amount
  DurationCategory _getDurationCategory(double hours, double amount) {
    if (amount >= 100000) {
      return DurationCategory.simulation;
    }
    if (hours <= 8) {
      return DurationCategory.short;
    } else if (hours <= 7 * 8) {
      return DurationCategory.medium;
    } else {
      return DurationCategory.long;
    }
  }

  /// Get messages list for duration category
  List<String> _getMessagesForDuration(
    BuildContext context,
    DurationCategory category,
  ) {
    final l10n = AppLocalizations.of(context);
    return switch (category) {
      DurationCategory.short => [
        l10n.msgShort1,
        l10n.msgShort2,
        l10n.msgShort3,
        l10n.msgShort4,
        l10n.msgShort5,
        l10n.msgShort6,
        l10n.msgShort7,
        l10n.msgShort8,
      ],
      DurationCategory.medium => [
        l10n.msgMedium1,
        l10n.msgMedium2,
        l10n.msgMedium3,
        l10n.msgMedium4,
        l10n.msgMedium5,
        l10n.msgMedium6,
        l10n.msgMedium7,
        l10n.msgMedium8,
      ],
      DurationCategory.long => [
        l10n.msgLong1,
        l10n.msgLong2,
        l10n.msgLong3,
        l10n.msgLong4,
        l10n.msgLong5,
        l10n.msgLong6,
        l10n.msgLong7,
        l10n.msgLong8,
      ],
      DurationCategory.simulation => [
        l10n.msgSim1,
        l10n.msgSim2,
        l10n.msgSim3,
        l10n.msgSim4,
        l10n.msgSim5,
        l10n.msgSim6,
        l10n.msgSim7,
        l10n.msgSim8,
      ],
    };
  }

  List<String> _getMessagesForDecision(
    BuildContext context,
    DecisionType decision,
  ) {
    final l10n = AppLocalizations.of(context);
    return switch (decision) {
      DecisionType.yes => [
        l10n.msgYes1,
        l10n.msgYes2,
        l10n.msgYes3,
        l10n.msgYes4,
        l10n.msgYes5,
        l10n.msgYes6,
        l10n.msgYes7,
        l10n.msgYes8,
      ],
      DecisionType.no => [
        l10n.msgNo1,
        l10n.msgNo2,
        l10n.msgNo3,
        l10n.msgNo4,
        l10n.msgNo5,
        l10n.msgNo6,
        l10n.msgNo7,
        l10n.msgNo8,
      ],
      DecisionType.thinking => [
        l10n.msgThink1,
        l10n.msgThink2,
        l10n.msgThink3,
        l10n.msgThink4,
        l10n.msgThink5,
        l10n.msgThink6,
        l10n.msgThink7,
        l10n.msgThink8,
      ],
    };
  }

  String _selectRandomMessage(List<String> messages) {
    // Create available indices (0-7) excluding recent ones
    final availableIndices = List.generate(
      messages.length,
      (i) => i,
    ).where((i) => !_recentMessageIndices.contains(i)).toList();

    final sourceIndices = availableIndices.isEmpty
        ? List.generate(messages.length, (i) => i)
        : availableIndices;

    final selectedIndex = sourceIndices[_random.nextInt(sourceIndices.length)];

    _recentMessageIndices.add(selectedIndex);
    if (_recentMessageIndices.length > _maxRecentMessages) {
      _recentMessageIndices.removeAt(0);
    }

    return messages[selectedIndex];
  }

  /// Return message based on hours and amount when showing calculation result
  String getCalculationMessage(
    BuildContext context,
    double hours,
    double amount,
  ) {
    final category = _getDurationCategory(hours, amount);
    final messages = _getMessagesForDuration(context, category);
    return _selectRandomMessage(messages);
  }

  String getMessageForDecision(BuildContext context, DecisionType decision) {
    final messages = _getMessagesForDecision(context, decision);
    return _selectRandomMessage(messages);
  }

  void clearRecentMessages() {
    _recentMessageIndices.clear();
  }

  // ============================================
  // NEW: SAVINGS & SPENDING MESSAGES (No-repeat for last 3)
  // ============================================

  /// Get motivational message for savings (when user passes on a purchase)
  /// 15 messages, won't repeat same message in last 3 shows
  String getMessageForSavings(AppLocalizations l10n) {
    final messages = [
      l10n.savingMsg1,
      l10n.savingMsg2,
      l10n.savingMsg3,
      l10n.savingMsg4,
      l10n.savingMsg5,
      l10n.savingMsg6,
      l10n.savingMsg7,
      l10n.savingMsg8,
      l10n.savingMsg9,
      l10n.savingMsg10,
      l10n.savingMsg11,
      l10n.savingMsg12,
      l10n.savingMsg13,
      l10n.savingMsg14,
      l10n.savingMsg15,
    ];
    return _getUniqueMessage(messages, 'saving');
  }

  /// Get message for spending (when user records a purchase)
  /// 10 messages, won't repeat same message in last 3 shows
  String getMessageForSpending(AppLocalizations l10n) {
    final messages = [
      l10n.spendingMsg1,
      l10n.spendingMsg2,
      l10n.spendingMsg3,
      l10n.spendingMsg4,
      l10n.spendingMsg5,
      l10n.spendingMsg6,
      l10n.spendingMsg7,
      l10n.spendingMsg8,
      l10n.spendingMsg9,
      l10n.spendingMsg10,
    ];
    return _getUniqueMessage(messages, 'spending');
  }

  /// Select unique message that hasn't been shown in last 3 for this category
  String _getUniqueMessage(List<String> messages, String category) {
    _recentByCategory[category] ??= [];
    final recent = _recentByCategory[category]!;

    // Get available indices (not in last 3)
    final available = <int>[];
    for (int i = 0; i < messages.length; i++) {
      if (!recent.contains(i)) {
        available.add(i);
      }
    }

    // If all blocked, reset
    if (available.isEmpty) {
      recent.clear();
      available.addAll(List.generate(messages.length, (i) => i));
    }

    // Pick random from available
    final index = available[_random.nextInt(available.length)];

    // Track this index
    recent.add(index);
    if (recent.length > _noRepeatCount) {
      recent.removeAt(0);
    }

    return messages[index];
  }
}


--- FILE: lib/services/analytics_service.dart ---

import 'package:firebase_analytics/firebase_analytics.dart';
import '../main.dart' show analytics;

/// Analytics Service for tracking user events
/// Provides easy-to-use methods for common tracking scenarios
class AnalyticsService {
  static final AnalyticsService _instance = AnalyticsService._internal();
  factory AnalyticsService() => _instance;
  AnalyticsService._internal();

  FirebaseAnalytics get _analytics => analytics;

  // ─────────────────────────────────────────────────────────────────
  // FEATURE ADOPTION EVENTS
  // ─────────────────────────────────────────────────────────────────

  /// Generic feature usage tracking
  Future<void> logFeatureUsed(String featureName) async {
    await _analytics.logEvent(
      name: 'feature_used',
      parameters: {'feature_name': featureName},
    );
  }

  /// Track AI Chat opened/used
  Future<void> logAIChatUsed() async => logFeatureUsed('ai_chat');

  /// Track receipt/OCR scanner used
  Future<void> logReceiptScanned() async => logFeatureUsed('receipt_scanner');

  /// Track Pro feature tapped (conversion funnel)
  Future<void> logProFeatureTapped(String featureName) async {
    await _analytics.logEvent(
      name: 'pro_feature_tapped',
      parameters: {'feature_name': featureName},
    );
  }

  /// Track subscription started (after purchase)
  Future<void> logSubscriptionStarted(String plan) async {
    await _analytics.logEvent(
      name: 'subscription_started',
      parameters: {'plan': plan}, // 'monthly', 'yearly', 'lifetime'
    );
  }

  // ─────────────────────────────────────────────────────────────────
  // EXPENSE EVENTS
  // ─────────────────────────────────────────────────────────────────

  /// Track when user adds an expense with method info
  Future<void> logExpenseAdded({
    required String method, // 'manual', 'voice', 'ocr'
    double? amount,
    String? category,
    String? decision,
  }) async {
    await _analytics.logEvent(
      name: 'expense_added',
      parameters: {
        'method': method,
        if (amount != null) 'amount': amount,
        if (category != null) 'category': category,
        if (decision != null) 'decision': decision,
      },
    );
  }

  /// Track expense decision (bought/thinking/skipped)
  Future<void> logExpenseDecision({
    required String decision,
    required double amount,
    required String category,
  }) async {
    await _analytics.logEvent(
      name: 'expense_decision',
      parameters: {
        'decision': decision,
        'amount': amount,
        'category': category,
      },
    );
  }

  // ─────────────────────────────────────────────────────────────────
  // SUBSCRIPTION EVENTS
  // ─────────────────────────────────────────────────────────────────

  /// Track subscription added
  Future<void> logSubscriptionAdded({
    required String name,
    required double amount,
  }) async {
    await _analytics.logEvent(
      name: 'subscription_added',
      parameters: {'name': name, 'amount': amount},
    );
  }

  // ─────────────────────────────────────────────────────────────────
  // PURSUIT (SAVINGS GOAL) EVENTS
  // ─────────────────────────────────────────────────────────────────

  /// Track pursuit created (simple)
  Future<void> logPursuitCreatedSimple() async => logFeatureUsed('pursuit_created');

  /// Track pursuit created with details
  Future<void> logPursuitCreated({
    required String category,
    required double targetAmount,
  }) async {
    await _analytics.logEvent(
      name: 'pursuit_created',
      parameters: {'category': category, 'target_amount': targetAmount},
    );
  }

  /// Track savings added to pursuit
  Future<void> logSavingsAdded({
    required double amount,
    required String source,
  }) async {
    await _analytics.logEvent(
      name: 'savings_added',
      parameters: {'amount': amount, 'source': source},
    );
  }

  /// Track pursuit completed
  Future<void> logPursuitCompleted({
    required String pursuitId,
    required double targetAmount,
  }) async {
    await _analytics.logEvent(
      name: 'pursuit_completed',
      parameters: {'pursuit_id': pursuitId, 'target_amount': targetAmount},
    );
  }

  // ─────────────────────────────────────────────────────────────────
  // AI CHAT EVENTS
  // ─────────────────────────────────────────────────────────────────

  /// Track AI chat message sent
  Future<void> logAIChatMessage({required bool isPremium}) async {
    await _analytics.logEvent(
      name: 'ai_chat_message',
      parameters: {'is_premium': isPremium ? 1 : 0},
    );
  }

  // ─────────────────────────────────────────────────────────────────
  // PREMIUM EVENTS
  // ─────────────────────────────────────────────────────────────────

  /// Track premium purchase started
  Future<void> logPurchaseStarted({required String productId}) async {
    await _analytics.logEvent(
      name: 'purchase_started',
      parameters: {'product_id': productId},
    );
  }

  /// Track premium purchase completed
  Future<void> logPurchaseCompleted({
    required String productId,
    required double price,
  }) async {
    await _analytics.logPurchase(
      currency: 'TRY',
      value: price,
      items: [
        AnalyticsEventItem(
          itemId: productId,
          itemName: productId,
          price: price,
        ),
      ],
    );
  }

  /// Track paywall viewed
  Future<void> logPaywallViewed({String? source}) async {
    await _analytics.logEvent(
      name: 'paywall_viewed',
      parameters: {'source': source ?? 'unknown'},
    );
  }

  // ─────────────────────────────────────────────────────────────────
  // NAVIGATION EVENTS
  // ─────────────────────────────────────────────────────────────────

  /// Track screen view
  Future<void> logScreenView({required String screenName}) async {
    await _analytics.logScreenView(screenName: screenName);
  }

  // ─────────────────────────────────────────────────────────────────
  // ONBOARDING EVENTS (Legacy)
  // ─────────────────────────────────────────────────────────────────

  /// Track onboarding step completed
  Future<void> logOnboardingStep({required int step}) async {
    await _analytics.logEvent(
      name: 'onboarding_step',
      parameters: {'step': step},
    );
  }

  /// Track onboarding completed
  Future<void> logOnboardingCompleted() async {
    await _analytics.logEvent(name: 'onboarding_completed');
  }

  // ─────────────────────────────────────────────────────────────────
  // ONBOARDING V2 FUNNEL EVENTS (3-Step Value-First Flow)
  // ─────────────────────────────────────────────────────────────────

  /// Track onboarding V2 started
  Future<void> logOnboardingV2Started() async {
    await _analytics.logEvent(name: 'onboarding_v2_started');
  }

  /// Track onboarding V2 step viewed
  Future<void> logOnboardingV2StepViewed({
    required int step,
    required String stepName,
  }) async {
    await _analytics.logEvent(
      name: 'onboarding_v2_step_viewed',
      parameters: {
        'step': step,
        'step_name': stepName, // 'value_demo', 'setup', 'first_action'
      },
    );
  }

  /// Track onboarding V2 step completed
  Future<void> logOnboardingV2StepCompleted({
    required int step,
    required String stepName,
    int? timeSpentSeconds,
  }) async {
    await _analytics.logEvent(
      name: 'onboarding_v2_step_completed',
      parameters: {
        'step': step,
        'step_name': stepName,
        if (timeSpentSeconds != null) 'time_spent_seconds': timeSpentSeconds,
      },
    );
  }

  /// Track onboarding V2 "Aha Moment" - when user sees their first time conversion
  Future<void> logOnboardingAhaMoment({
    required double amount,
    required double hoursRequired,
  }) async {
    await _analytics.logEvent(
      name: 'onboarding_aha_moment',
      parameters: {
        'amount': amount,
        'hours_required': hoursRequired,
      },
    );
  }

  /// Track onboarding V2 completed with funnel data
  Future<void> logOnboardingV2Completed({
    required int totalTimeSeconds,
    required bool addedFirstExpense,
  }) async {
    await _analytics.logEvent(
      name: 'onboarding_v2_completed',
      parameters: {
        'total_time_seconds': totalTimeSeconds,
        'added_first_expense': addedFirstExpense ? 1 : 0,
      },
    );
  }

  /// Track onboarding V2 skipped (user exits early)
  Future<void> logOnboardingV2Skipped({
    required int lastStepViewed,
    required String skipReason,
  }) async {
    await _analytics.logEvent(
      name: 'onboarding_v2_skipped',
      parameters: {
        'last_step_viewed': lastStepViewed,
        'skip_reason': skipReason, // 'back_button', 'skip_button', 'app_closed'
      },
    );
  }

  /// Track profile setup during onboarding
  Future<void> logOnboardingProfileSetup({
    required double monthlyIncome,
    required int workingHours,
    required int workingDays,
  }) async {
    await _analytics.logEvent(
      name: 'onboarding_profile_setup',
      parameters: {
        'monthly_income': monthlyIncome,
        'working_hours': workingHours,
        'working_days': workingDays,
      },
    );
  }

  // ─────────────────────────────────────────────────────────────────
  // ONBOARDING CHECKLIST EVENTS (Main Screen Quick Wins)
  // ─────────────────────────────────────────────────────────────────

  /// Track checklist item viewed
  Future<void> logChecklistViewed({required int completedCount}) async {
    await _analytics.logEvent(
      name: 'checklist_viewed',
      parameters: {'completed_count': completedCount},
    );
  }

  /// Track checklist item completed
  Future<void> logChecklistItemCompleted({
    required String itemName,
    required int itemIndex,
    required int totalCompleted,
  }) async {
    await _analytics.logEvent(
      name: 'checklist_item_completed',
      parameters: {
        'item_name': itemName, // 'add_expense', 'view_report', 'create_pursuit', 'enable_notifications'
        'item_index': itemIndex,
        'total_completed': totalCompleted,
      },
    );
  }

  /// Track checklist completed (all items done)
  Future<void> logChecklistCompleted({required int totalTimeMinutes}) async {
    await _analytics.logEvent(
      name: 'checklist_completed',
      parameters: {'total_time_minutes': totalTimeMinutes},
    );
  }

  /// Track checklist dismissed early
  Future<void> logChecklistDismissed({required int completedCount}) async {
    await _analytics.logEvent(
      name: 'checklist_dismissed',
      parameters: {'completed_count': completedCount},
    );
  }

  // ─────────────────────────────────────────────────────────────────
  // ENGAGEMENT & MILESTONE EVENTS
  // ─────────────────────────────────────────────────────────────────

  /// Track milestone achieved
  Future<void> logMilestoneAchieved({
    required String milestoneName,
    required String milestoneType,
    Map<String, dynamic>? extraData,
  }) async {
    await _analytics.logEvent(
      name: 'milestone_achieved',
      parameters: {
        'milestone_name': milestoneName,
        'milestone_type': milestoneType, // 'streak', 'savings', 'expense_count', 'pursuit', 'feature'
        ...?extraData,
      },
    );
  }

  /// Track celebration shown
  Future<void> logCelebrationShown({
    required String celebrationType,
    required String milestoneName,
  }) async {
    await _analytics.logEvent(
      name: 'celebration_shown',
      parameters: {
        'celebration_type': celebrationType, // 'confetti', 'modal', 'toast'
        'milestone_name': milestoneName,
      },
    );
  }

  /// Track user activity for engagement
  Future<void> logDailyActivity({
    required int currentStreak,
    required int expenseCount,
    required int pursuitCount,
  }) async {
    await _analytics.logEvent(
      name: 'daily_activity',
      parameters: {
        'current_streak': currentStreak,
        'expense_count': expenseCount,
        'pursuit_count': pursuitCount,
      },
    );
  }

  // ─────────────────────────────────────────────────────────────────
  // RE-ENGAGEMENT & STALLED USER EVENTS
  // ─────────────────────────────────────────────────────────────────

  /// Track user inactivity detected
  Future<void> logUserInactive({
    required int daysInactive,
    required String activityState,
  }) async {
    await _analytics.logEvent(
      name: 'user_inactive',
      parameters: {
        'days_inactive': daysInactive,
        'activity_state': activityState, // 'warning', 'stalled', 'critical', 'dormant', 'churning'
      },
    );
  }

  /// Track re-engagement push sent
  Future<void> logReengagementPushSent({
    required int daysInactive,
    required String pushType,
  }) async {
    await _analytics.logEvent(
      name: 'reengagement_push_sent',
      parameters: {
        'days_inactive': daysInactive,
        'push_type': pushType, // 'gentle', 'urgent', 'win_back'
      },
    );
  }

  /// Track welcome back shown
  Future<void> logWelcomeBackShown({
    required int daysInactive,
    required int recoveryPercent,
  }) async {
    await _analytics.logEvent(
      name: 'welcome_back_shown',
      parameters: {
        'days_inactive': daysInactive,
        'recovery_percent': recoveryPercent,
      },
    );
  }

  /// Track user returned after inactivity
  Future<void> logUserReturned({
    required int daysInactive,
    required String returnSource,
  }) async {
    await _analytics.logEvent(
      name: 'user_returned',
      parameters: {
        'days_inactive': daysInactive,
        'return_source': returnSource, // 'organic', 'push', 'email'
      },
    );
  }

  /// Track streak recovered
  Future<void> logStreakRecovered({
    required int previousStreak,
    required int recoveredStreak,
    required int recoveryPercent,
  }) async {
    await _analytics.logEvent(
      name: 'streak_recovered',
      parameters: {
        'previous_streak': previousStreak,
        'recovered_streak': recoveredStreak,
        'recovery_percent': recoveryPercent,
      },
    );
  }

  // ─────────────────────────────────────────────────────────────────
  // EMPTY STATE & CTA EVENTS
  // ─────────────────────────────────────────────────────────────────

  /// Track empty state viewed
  Future<void> logEmptyStateViewed({
    required String screenName,
    required String emptyStateType,
  }) async {
    await _analytics.logEvent(
      name: 'empty_state_viewed',
      parameters: {
        'screen_name': screenName,
        'empty_state_type': emptyStateType, // 'expenses', 'pursuits', 'reports', etc.
      },
    );
  }

  /// Track empty state CTA tapped
  Future<void> logEmptyStateCtaTapped({
    required String screenName,
    required String ctaAction,
  }) async {
    await _analytics.logEvent(
      name: 'empty_state_cta_tapped',
      parameters: {
        'screen_name': screenName,
        'cta_action': ctaAction, // 'add_expense', 'create_pursuit', etc.
      },
    );
  }

  // ─────────────────────────────────────────────────────────────────
  // CONVERSION FUNNEL EVENTS
  // ─────────────────────────────────────────────────────────────────

  /// Track activation event (user completed key action)
  Future<void> logActivationEvent({
    required String eventType,
    required int daysSinceInstall,
  }) async {
    await _analytics.logEvent(
      name: 'activation_event',
      parameters: {
        'event_type': eventType, // 'first_expense', 'profile_setup', 'first_pursuit'
        'days_since_install': daysSinceInstall,
      },
    );
  }

  /// Track retention milestone
  Future<void> logRetentionMilestone({
    required int dayNumber,
    required int expenseCount,
    required int pursuitCount,
  }) async {
    await _analytics.logEvent(
      name: 'retention_milestone',
      parameters: {
        'day_number': dayNumber, // 1, 3, 7, 14, 30
        'expense_count': expenseCount,
        'pursuit_count': pursuitCount,
      },
    );
  }

  /// Generic event logging method
  Future<void> logEvent(
    String eventName, {
    Map<String, dynamic>? parameters,
  }) async {
    await _analytics.logEvent(
      name: eventName,
      parameters: parameters?.map((key, value) {
        // Firebase only accepts String, int, double for parameters
        if (value is String || value is int || value is double) {
          return MapEntry(key, value);
        }
        return MapEntry(key, value.toString());
      }),
    );
  }

  // ─────────────────────────────────────────────────────────────────
  // ACHIEVEMENT EVENTS
  // ─────────────────────────────────────────────────────────────────

  /// Track achievement unlocked
  Future<void> logAchievementUnlocked({required String achievementId}) async {
    await _analytics.logUnlockAchievement(id: achievementId);
  }

  // ─────────────────────────────────────────────────────────────────
  // STREAK EVENTS
  // ─────────────────────────────────────────────────────────────────

  /// Track streak milestone
  Future<void> logStreakMilestone({required int days}) async {
    await _analytics.logEvent(
      name: 'streak_milestone',
      parameters: {'days': days},
    );
  }

  // ─────────────────────────────────────────────────────────────────
  // USER PROPERTIES (Retention & Cohort Analysis)
  // ─────────────────────────────────────────────────────────────────

  /// Set first open date for cohort analysis
  Future<void> setUserFirstOpenDate() async {
    final now = DateTime.now();
    await _analytics.setUserProperty(
      name: 'first_open_date',
      value:
          '${now.year}-${now.month.toString().padLeft(2, '0')}-${now.day.toString().padLeft(2, '0')}',
    );
  }

  /// Set user type (pro/free)
  Future<void> setUserType(bool isPro) async {
    await _analytics.setUserProperty(
      name: 'user_type',
      value: isPro ? 'pro' : 'free',
    );
  }

  /// Set user premium status (legacy - kept for compatibility)
  Future<void> setUserPremiumStatus(bool isPremium) async {
    await _analytics.setUserProperty(
      name: 'is_premium',
      value: isPremium.toString(),
    );
    // Also update user_type for consistency
    await setUserType(isPremium);
  }

  /// Set user preferred currency
  Future<void> setUserCurrency(String currency) async {
    await _analytics.setUserProperty(name: 'currency', value: currency);
  }

  /// Set user preferred language
  Future<void> setUserLanguage(String language) async {
    await _analytics.setUserProperty(name: 'app_language', value: language);
  }

  /// Set app version
  Future<void> setAppVersion(String version) async {
    await _analytics.setUserProperty(name: 'app_version', value: version);
  }

  // ─────────────────────────────────────────────────────────────────
  // FUNNEL EVENTS
  // ─────────────────────────────────────────────────────────────────

  /// Track first expense added (milestone)
  Future<void> logFirstExpense() async {
    await _analytics.logEvent(name: 'first_expense');
  }

  /// Track first pursuit created (milestone)
  Future<void> logFirstPursuit() async {
    await _analytics.logEvent(name: 'first_pursuit');
  }

  /// Track upgrade button clicked
  Future<void> logUpgradeClicked({String? source}) async {
    await _analytics.logEvent(
      name: 'upgrade_clicked',
      parameters: {'source': source ?? 'unknown'},
    );
  }

  /// Track AI chat used
  Future<void> logAiChatUsed({required bool isPremium}) async {
    await _analytics.logEvent(
      name: 'ai_chat_used',
      parameters: {'is_premium': isPremium ? 1 : 0},
    );
  }

  /// Track voice input used
  Future<void> logVoiceInputUsed() async {
    await _analytics.logEvent(name: 'voice_input_used');
  }

  /// Track backup created
  Future<void> logBackupCreated() async {
    await _analytics.logEvent(name: 'backup_created');
  }

  /// Track backup restored
  Future<void> logBackupRestored() async {
    await _analytics.logEvent(name: 'backup_restored');
  }

  /// Get analytics observer for navigation
  FirebaseAnalyticsObserver get observer =>
      FirebaseAnalyticsObserver(analytics: _analytics);

  // ─────────────────────────────────────────────────────────────────
  // PERFORMANCE MONITORING (Tasks 75-78)
  // ─────────────────────────────────────────────────────────────────

  /// Track app startup time
  Future<void> logStartupTime({required int milliseconds}) async {
    await _analytics.logEvent(
      name: 'app_startup_time',
      parameters: {'duration_ms': milliseconds},
    );
  }

  /// Track screen load time
  Future<void> logScreenLoadTime({
    required String screenName,
    required int milliseconds,
  }) async {
    await _analytics.logEvent(
      name: 'screen_load_time',
      parameters: {
        'screen_name': screenName,
        'duration_ms': milliseconds,
      },
    );
  }

  /// Track API response time
  Future<void> logApiResponseTime({
    required String endpoint,
    required int milliseconds,
    required bool success,
  }) async {
    await _analytics.logEvent(
      name: 'api_response_time',
      parameters: {
        'endpoint': endpoint,
        'duration_ms': milliseconds,
        'success': success ? 1 : 0,
      },
    );
  }

  /// Track memory usage (high memory warning)
  Future<void> logHighMemoryUsage({required int megabytes}) async {
    await _analytics.logEvent(
      name: 'high_memory_usage',
      parameters: {'memory_mb': megabytes},
    );
  }

  /// Track battery optimization mode
  Future<void> logBatteryOptimization({required bool enabled}) async {
    await _analytics.logEvent(
      name: 'battery_optimization',
      parameters: {'enabled': enabled ? 1 : 0},
    );
  }

  /// Track crash/ANR event
  Future<void> logPerformanceIssue({
    required String issueType, // 'anr', 'slow_render', 'frozen_frame'
    String? details,
  }) async {
    await _analytics.logEvent(
      name: 'performance_issue',
      parameters: {
        'issue_type': issueType,
        'details': details ?? '',
      },
    );
  }

  // ─────────────────────────────────────────────────────────────────
  // SOCIAL & SHARING EVENTS (Tasks 60-61)
  // ─────────────────────────────────────────────────────────────────

  /// Track pursuit shared
  Future<void> logPursuitShared({required double progress}) async {
    await _analytics.logEvent(
      name: 'pursuit_shared',
      parameters: {'progress_percent': (progress * 100).toInt()},
    );
  }

  /// Track achievement shared
  Future<void> logAchievementShared({required String achievementId}) async {
    await _analytics.logEvent(
      name: 'achievement_shared',
      parameters: {'achievement_id': achievementId},
    );
  }

  /// Track streak shared
  Future<void> logStreakShared({required int days}) async {
    await _analytics.logEvent(
      name: 'streak_shared',
      parameters: {'streak_days': days},
    );
  }
}


--- FILE: lib/services/victory_manager.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:confetti/confetti.dart';
import '../theme/theme.dart';

/// Wealth Coach: Victory Manager
/// İrade Zaferi kutlama animasyonlarını yöneten singleton
/// Confetti + Overlay mesajı + Haptic feedback
class VictoryManager {
  static final VictoryManager _instance = VictoryManager._internal();
  factory VictoryManager() => _instance;
  VictoryManager._internal();

  OverlayEntry? _currentOverlay;
  ConfettiController? _confettiController;

  /// İrade Zaferi animasyonunu göster
  void showVictoryAnimation(
    BuildContext context, {
    required double amount,
    required double hours,
  }) {
    // Önceki overlay varsa kaldır
    _currentOverlay?.remove();
    _currentOverlay = null;
    _confettiController?.dispose();

    // Confetti controller oluştur
    _confettiController = ConfettiController(
      duration: const Duration(seconds: 2),
    );

    // Heavy haptic feedback
    HapticFeedback.heavyImpact();

    // Overlay oluştur
    final overlay = Overlay.of(context);
    final controller = _confettiController!;

    _currentOverlay = OverlayEntry(
      builder: (context) => _VictoryCelebration(
        amount: amount,
        hours: hours,
        confettiController: controller,
        onComplete: () {
          // Önce confetti'yi durdur, sonra overlay'i kaldır
          controller.stop();
          _currentOverlay?.remove();
          _currentOverlay = null;
          // Dispose'u biraz beklet - widget tree güncellensin
          Future.delayed(const Duration(milliseconds: 100), () {
            if (_confettiController == controller) {
              _confettiController?.dispose();
              _confettiController = null;
            }
          });
        },
      ),
    );

    overlay.insert(_currentOverlay!);

    // Confetti'yi başlat
    controller.play();
  }

  /// Overlay'i manuel kaldır
  void dismiss() {
    _confettiController?.stop();
    _currentOverlay?.remove();
    _currentOverlay = null;
    Future.delayed(const Duration(milliseconds: 100), () {
      _confettiController?.dispose();
      _confettiController = null;
    });
  }
}

/// Victory Celebration with Confetti
class _VictoryCelebration extends StatefulWidget {
  final double amount;
  final double hours;
  final ConfettiController confettiController;
  final VoidCallback onComplete;

  const _VictoryCelebration({
    required this.amount,
    required this.hours,
    required this.confettiController,
    required this.onComplete,
  });

  @override
  State<_VictoryCelebration> createState() => _VictoryCelebrationState();
}

class _VictoryCelebrationState extends State<_VictoryCelebration>
    with TickerProviderStateMixin {
  late AnimationController _scaleController;
  late AnimationController _fadeController;
  late Animation<double> _scaleAnimation;
  late Animation<double> _fadeAnimation;

  @override
  void initState() {
    super.initState();

    // Scale animation (bounce effect: 0 → 1.1 → 1)
    _scaleController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 400),
    );
    _scaleAnimation = TweenSequence<double>([
      TweenSequenceItem(
        tween: Tween(
          begin: 0.0,
          end: 1.15,
        ).chain(CurveTween(curve: Curves.easeOut)),
        weight: 60,
      ),
      TweenSequenceItem(
        tween: Tween(
          begin: 1.15,
          end: 1.0,
        ).chain(CurveTween(curve: Curves.easeInOut)),
        weight: 40,
      ),
    ]).animate(_scaleController);

    // Fade animation for dismiss
    _fadeController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 300),
    );
    _fadeAnimation = Tween<double>(
      begin: 1.0,
      end: 0.0,
    ).animate(CurvedAnimation(parent: _fadeController, curve: Curves.easeOut));

    _startAnimation();
  }

  Future<void> _startAnimation() async {
    // Scale in with bounce
    await _scaleController.forward();

    // Wait 2 seconds
    await Future.delayed(const Duration(milliseconds: 1800));

    // Fade out
    await _fadeController.forward();

    // Complete
    widget.onComplete();
  }

  @override
  void dispose() {
    _scaleController.dispose();
    _fadeController.dispose();
    super.dispose();
  }

  String _formatHours(double hours) {
    if (hours >= 24) {
      final days = (hours / 24).floor();
      final remainingHours = (hours % 24).round();
      if (remainingHours > 0) {
        return '$days Gün $remainingHours Saat';
      }
      return '$days Gün';
    } else if (hours >= 1) {
      final h = hours.floor();
      final minutes = ((hours - h) * 60).round();
      if (minutes > 0) {
        return '$h Saat $minutes Dk';
      }
      return '$h Saat';
    } else {
      return '${(hours * 60).round()} Dakika';
    }
  }

  @override
  Widget build(BuildContext context) {
    return Material(
      color: Colors.transparent,
      child: FadeTransition(
        opacity: _fadeAnimation,
        child: Stack(
          children: [
            // Tıklama ile kapatma
            GestureDetector(
              onTap: () async {
                await _fadeController.forward();
                widget.onComplete();
              },
              child: Container(color: Colors.black.withValues(alpha: 0.3)),
            ),

            // Confetti - Ekranın üstünden
            Align(
              alignment: Alignment.topCenter,
              child: ConfettiWidget(
                confettiController: widget.confettiController,
                blastDirectionality: BlastDirectionality.explosive,
                emissionFrequency: 0.05,
                numberOfParticles: 25,
                maxBlastForce: 30,
                minBlastForce: 10,
                gravity: 0.2,
                particleDrag: 0.05,
                colors: const [
                  AppColors.medalGold, // Altın
                  AppColors.primary, // Mor
                  AppColors.secondary, // Turkuaz
                  AppColors.error, // Kırmızı
                  Colors.white,
                ],
              ),
            ),

            // Kutlama mesajı - Ortada
            Center(
              child: ScaleTransition(
                scale: _scaleAnimation,
                child: Container(
                  margin: const EdgeInsets.symmetric(horizontal: 40),
                  padding: const EdgeInsets.symmetric(
                    horizontal: 32,
                    vertical: 28,
                  ),
                  decoration: BoxDecoration(
                    gradient: const LinearGradient(
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                      colors: [
                        AppColors.primary, // Primary mor
                        AppColors.secondary, // Turkuaz
                      ],
                    ),
                    borderRadius: BorderRadius.circular(28),
                    boxShadow: [
                      BoxShadow(
                        color: context.appColors.primary.withValues(alpha: 0.4),
                        blurRadius: 30,
                        spreadRadius: 5,
                        offset: const Offset(0, 10),
                      ),
                    ],
                  ),
                  child: Column(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      // Trophy icon
                      Container(
                        width: 80,
                        height: 80,
                        decoration: BoxDecoration(
                          color: Colors.white.withValues(alpha: 0.2),
                          shape: BoxShape.circle,
                        ),
                        child: const Icon(
                          CupertinoIcons.rosette,
                          size: 48,
                          color: AppColors.medalGold,
                        ),
                      ),
                      const SizedBox(height: 12),
                      // Özgürlük süresi
                      Text(
                        '+${_formatHours(widget.hours)}',
                        style: const TextStyle(
                          fontSize: 32,
                          fontWeight: FontWeight.w800,
                          color: Colors.white,
                          letterSpacing: -1,
                          shadows: [
                            Shadow(
                              color: Colors.black26,
                              offset: Offset(0, 2),
                              blurRadius: 4,
                            ),
                          ],
                        ),
                        textAlign: TextAlign.center,
                      ),
                      const SizedBox(height: 6),
                      const Text(
                        'Özgürlük!',
                        style: TextStyle(
                          fontSize: 18,
                          fontWeight: FontWeight.w600,
                          color: Colors.white70,
                          letterSpacing: 1,
                        ),
                      ),
                      const SizedBox(height: 16),
                      // Alt mesaj
                      Container(
                        padding: const EdgeInsets.symmetric(
                          horizontal: 16,
                          vertical: 8,
                        ),
                        decoration: BoxDecoration(
                          color: Colors.white.withValues(alpha: 0.2),
                          borderRadius: BorderRadius.circular(20),
                        ),
                        child: Row(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            const Text(
                              'Para cebinde kaldı!',
                              style: TextStyle(
                                fontSize: 14,
                                fontWeight: FontWeight.w600,
                                color: Colors.white,
                              ),
                            ),
                            const SizedBox(width: 6),
                            const Icon(
                              CupertinoIcons.hand_raised_fill,
                              size: 16,
                              color: Colors.white,
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

/// Global erişim için kısayol
final victoryManager = VictoryManager();


--- FILE: lib/services/ai_memory_service.dart ---

import 'package:flutter/foundation.dart';
import 'package:flutter_dotenv/flutter_dotenv.dart';
import 'package:google_generative_ai/google_generative_ai.dart';
import 'package:hive_flutter/hive_flutter.dart';

class AIMemoryService {
  static final AIMemoryService _instance = AIMemoryService._internal();
  factory AIMemoryService() => _instance;
  AIMemoryService._internal();

  static const String _factsBoxName = 'user_facts';
  static const String _messagesBoxName = 'chat_messages';
  static const int _extractionInterval = 5; // Her 5 mesajda bir extraction

  late Box<String> _factsBox;
  late Box<Map> _messagesBox;
  late GenerativeModel _extractorModel;

  int _messagesSinceLastExtraction = 0;
  List<String> _userFacts = [];

  Future<void> initialize() async {
    await Hive.initFlutter();
    _factsBox = await Hive.openBox<String>(_factsBoxName);
    _messagesBox = await Hive.openBox<Map>(_messagesBoxName);

    // Fact extraction için Flash model (ucuz)
    final apiKey = dotenv.env['GEMINI_API_KEY'] ?? '';
    _extractorModel = GenerativeModel(
      model: 'gemini-2.0-flash',
      apiKey: apiKey,
    );

    // Mevcut fact'leri yükle
    _userFacts = _factsBox.values.toList();
  }

  // Mesaj kaydet
  Future<void> saveMessage(String role, String content) async {
    await _messagesBox.add({
      'role': role,
      'content': content,
      'timestamp': DateTime.now().toIso8601String(),
    });

    _messagesSinceLastExtraction++;

    // Her 5 mesajda bir fact extraction
    if (_messagesSinceLastExtraction >= _extractionInterval) {
      await _extractFacts();
      _messagesSinceLastExtraction = 0;
    }
  }

  // AI ile akıllı fact extraction
  Future<void> _extractFacts() async {
    try {
      // Son 10 mesajı al
      final recentMessages = _messagesBox.values
          .toList()
          .reversed
          .take(10)
          .map((m) => '${m['role']}: ${m['content']}')
          .join('\n');

      if (recentMessages.isEmpty) return;

      final prompt =
          '''
Aşağıdaki konuşmadan kullanıcı hakkında önemli ve kalıcı bilgileri çıkar.

KURALLAR:
- Sadece uzun vadeli geçerli bilgiler (alışkanlıklar, tercihler, aile durumu, iş)
- Anlık durumları YAZMA ("bugün yorgun" gibi)
- Her bilgi tek satır, kısa ve öz
- Maksimum 5 bilgi
- Daha önce bilinen bilgileri tekrar yazma
- Yeni bir şey yoksa BOŞ döndür

MEVCUT BİLİNENLER:
${_userFacts.isEmpty ? 'Henüz bilgi yok' : _userFacts.join('\n')}

KONUŞMA:
$recentMessages

YENİ BİLGİLER (her satıra bir bilgi, yoksa BOŞ yaz):
''';

      final response = await _extractorModel.generateContent([
        Content.text(prompt),
      ]);
      final text = response.text?.trim() ?? '';

      if (text.isNotEmpty && text.toUpperCase() != 'BOŞ') {
        final newFacts = text
            .split('\n')
            .map((f) => f.trim())
            .where((f) => f.isNotEmpty && !f.toUpperCase().contains('BOŞ'))
            .where((f) => !_userFacts.contains(f)) // Duplicate'leri atla
            .toList();

        for (final fact in newFacts) {
          if (_userFacts.length >= 30) {
            // En eski fact'i sil
            final oldest = _userFacts.removeAt(0);
            await _factsBox.delete(oldest);
          }
          _userFacts.add(fact);
          await _factsBox.add(fact);
        }
      }
    } catch (e) {
      // Extraction başarısız olursa sessizce devam et
    }
  }

  // Memory özeti (API'ye gönderilecek)
  String getMemorySummary() {
    if (_userFacts.isEmpty) return '';
    return '''
KULLANICI HAKKINDA BİLİNENLER:
${_userFacts.map((f) => '- $f').join('\n')}
''';
  }

  // Son N mesajı al (kronolojik sırada)
  List<Map<String, String>> getRecentMessages(int count) {
    try {
      final allMessages = _messagesBox.values.toList();
      if (allMessages.isEmpty) return [];

      return allMessages.reversed
          .take(count)
          .toList()
          .reversed // Kronolojik sıraya çevir
          .map(
            (m) => {
              'role': (m['role'] as String?) ?? '',
              'content': (m['content'] as String?) ?? '',
            },
          )
          .where((m) => m['content']!.isNotEmpty)
          .toList();
    } catch (e) {
      debugPrint('❌ [AIMemory] Error: $e');
      return [];
    }
  }

  // Tüm geçmişi sil
  Future<void> clearAll() async {
    await _factsBox.clear();
    await _messagesBox.clear();
    _userFacts.clear();
    _messagesSinceLastExtraction = 0;
  }

  // Fact'leri manuel düzenle
  List<String> get facts => List.unmodifiable(_userFacts);

  Future<void> removeFact(String fact) async {
    _userFacts.remove(fact);
    final key = _factsBox.keys.firstWhere(
      (k) => _factsBox.get(k) == fact,
      orElse: () => null,
    );
    if (key != null) await _factsBox.delete(key);
  }
}


--- FILE: lib/services/engagement_service.dart ---

import 'package:flutter/foundation.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'analytics_service.dart';
import 'notification_service.dart';

/// Engagement milestones for celebrations
enum EngagementMilestone {
  // Streak milestones
  streak3Days,
  streak7Days,
  streak14Days,
  streak30Days,
  streak60Days,
  streak100Days,

  // Savings milestones
  firstSaved,
  saved100,
  saved500,
  saved1000,
  saved5000,
  saved10000,

  // Usage milestones
  firstExpense,
  tenExpenses,
  fiftyExpenses,
  hundredExpenses,

  // Pursuit milestones
  firstPursuit,
  firstPursuitCompleted,
  threePursuitsCompleted,

  // Feature discovery
  usedAiChat,
  usedVoiceInput,
  usedReceiptScanner,
  sharedCard,
}

/// Celebration data for showing to user
class CelebrationData {
  final EngagementMilestone milestone;
  final String titleKey;
  final String messageKey;
  final String emoji;
  final int? rewardDays; // Pro days reward (if any)

  const CelebrationData({
    required this.milestone,
    required this.titleKey,
    required this.messageKey,
    required this.emoji,
    this.rewardDays,
  });
}

/// Engagement service for tracking user progress and triggering celebrations
/// Handles streaks, milestones, and re-engagement logic
class EngagementService {
  static final EngagementService _instance = EngagementService._internal();
  factory EngagementService() => _instance;
  EngagementService._internal();

  // Keys for SharedPreferences
  static const String _keyLastActiveDate = 'engagement_last_active';
  static const String _keyCurrentStreak = 'engagement_current_streak';
  static const String _keyLongestStreak = 'engagement_longest_streak';
  static const String _keyCompletedMilestones = 'engagement_completed_milestones';
  static const String _keyPendingCelebration = 'engagement_pending_celebration';

  // Milestone configurations
  static const Map<EngagementMilestone, CelebrationData> _milestoneData = {
    // Streak milestones
    EngagementMilestone.streak3Days: CelebrationData(
      milestone: EngagementMilestone.streak3Days,
      titleKey: 'milestone3DayStreakTitle',
      messageKey: 'milestone3DayStreakMessage',
      emoji: '🔥',
    ),
    EngagementMilestone.streak7Days: CelebrationData(
      milestone: EngagementMilestone.streak7Days,
      titleKey: 'milestone7DayStreakTitle',
      messageKey: 'milestone7DayStreakMessage',
      emoji: '🌟',
      rewardDays: 1,
    ),
    EngagementMilestone.streak14Days: CelebrationData(
      milestone: EngagementMilestone.streak14Days,
      titleKey: 'milestone14DayStreakTitle',
      messageKey: 'milestone14DayStreakMessage',
      emoji: '💪',
      rewardDays: 2,
    ),
    EngagementMilestone.streak30Days: CelebrationData(
      milestone: EngagementMilestone.streak30Days,
      titleKey: 'milestone30DayStreakTitle',
      messageKey: 'milestone30DayStreakMessage',
      emoji: '🏆',
      rewardDays: 7,
    ),
    EngagementMilestone.streak60Days: CelebrationData(
      milestone: EngagementMilestone.streak60Days,
      titleKey: 'milestone60DayStreakTitle',
      messageKey: 'milestone60DayStreakMessage',
      emoji: '👑',
      rewardDays: 14,
    ),
    EngagementMilestone.streak100Days: CelebrationData(
      milestone: EngagementMilestone.streak100Days,
      titleKey: 'milestone100DayStreakTitle',
      messageKey: 'milestone100DayStreakMessage',
      emoji: '🎖️',
      rewardDays: 30,
    ),

    // Savings milestones
    EngagementMilestone.firstSaved: CelebrationData(
      milestone: EngagementMilestone.firstSaved,
      titleKey: 'milestoneFirstSavedTitle',
      messageKey: 'milestoneFirstSavedMessage',
      emoji: '💰',
    ),
    EngagementMilestone.saved100: CelebrationData(
      milestone: EngagementMilestone.saved100,
      titleKey: 'milestoneSaved100Title',
      messageKey: 'milestoneSaved100Message',
      emoji: '💵',
    ),
    EngagementMilestone.saved1000: CelebrationData(
      milestone: EngagementMilestone.saved1000,
      titleKey: 'milestoneSaved1000Title',
      messageKey: 'milestoneSaved1000Message',
      emoji: '🤑',
    ),
    EngagementMilestone.saved5000: CelebrationData(
      milestone: EngagementMilestone.saved5000,
      titleKey: 'milestoneSaved5000Title',
      messageKey: 'milestoneSaved5000Message',
      emoji: '💎',
    ),

    // Usage milestones
    EngagementMilestone.firstExpense: CelebrationData(
      milestone: EngagementMilestone.firstExpense,
      titleKey: 'milestoneFirstExpenseTitle',
      messageKey: 'milestoneFirstExpenseMessage',
      emoji: '🎉',
    ),
    EngagementMilestone.tenExpenses: CelebrationData(
      milestone: EngagementMilestone.tenExpenses,
      titleKey: 'milestone10ExpensesTitle',
      messageKey: 'milestone10ExpensesMessage',
      emoji: '📊',
    ),
    EngagementMilestone.fiftyExpenses: CelebrationData(
      milestone: EngagementMilestone.fiftyExpenses,
      titleKey: 'milestone50ExpensesTitle',
      messageKey: 'milestone50ExpensesMessage',
      emoji: '🚀',
    ),

    // Pursuit milestones
    EngagementMilestone.firstPursuit: CelebrationData(
      milestone: EngagementMilestone.firstPursuit,
      titleKey: 'milestoneFirstPursuitTitle',
      messageKey: 'milestoneFirstPursuitMessage',
      emoji: '🎯',
    ),
    EngagementMilestone.firstPursuitCompleted: CelebrationData(
      milestone: EngagementMilestone.firstPursuitCompleted,
      titleKey: 'milestoneFirstPursuitCompletedTitle',
      messageKey: 'milestoneFirstPursuitCompletedMessage',
      emoji: '🏅',
    ),

    // Feature discovery
    EngagementMilestone.usedAiChat: CelebrationData(
      milestone: EngagementMilestone.usedAiChat,
      titleKey: 'milestoneUsedAiChatTitle',
      messageKey: 'milestoneUsedAiChatMessage',
      emoji: '🤖',
    ),
  };

  // ═══════════════════════════════════════════════════════════════════════════
  // STREAK TRACKING
  // ═══════════════════════════════════════════════════════════════════════════

  /// Record user activity for today (call when user adds expense)
  Future<StreakResult> recordActivity() async {
    final prefs = await SharedPreferences.getInstance();
    final now = DateTime.now();
    final today = DateTime(now.year, now.month, now.day);

    final lastActiveStr = prefs.getString(_keyLastActiveDate);
    final currentStreak = prefs.getInt(_keyCurrentStreak) ?? 0;
    final longestStreak = prefs.getInt(_keyLongestStreak) ?? 0;

    int newStreak = currentStreak;
    bool streakIncreased = false;
    EngagementMilestone? newMilestone;

    if (lastActiveStr == null) {
      // First activity ever
      newStreak = 1;
      streakIncreased = true;
    } else {
      final lastActive = DateTime.parse(lastActiveStr);
      final lastActiveDay = DateTime(lastActive.year, lastActive.month, lastActive.day);
      final difference = today.difference(lastActiveDay).inDays;

      if (difference == 0) {
        // Already active today, no change
        streakIncreased = false;
      } else if (difference == 1) {
        // Consecutive day, increase streak
        newStreak = currentStreak + 1;
        streakIncreased = true;
      } else {
        // Streak broken, reset to 1
        newStreak = 1;
        streakIncreased = true;
      }
    }

    // Update storage
    await prefs.setString(_keyLastActiveDate, today.toIso8601String());
    await prefs.setInt(_keyCurrentStreak, newStreak);

    // Update longest streak if needed
    if (newStreak > longestStreak) {
      await prefs.setInt(_keyLongestStreak, newStreak);
    }

    // Check for streak milestones
    if (streakIncreased) {
      newMilestone = await _checkStreakMilestones(newStreak);
    }

    debugPrint('[Engagement] Streak: $newStreak days (increased: $streakIncreased)');

    return StreakResult(
      currentStreak: newStreak,
      longestStreak: newStreak > longestStreak ? newStreak : longestStreak,
      streakIncreased: streakIncreased,
      newMilestone: newMilestone,
    );
  }

  /// Get current streak info
  Future<StreakInfo> getStreakInfo() async {
    final prefs = await SharedPreferences.getInstance();
    final now = DateTime.now();
    final today = DateTime(now.year, now.month, now.day);

    final lastActiveStr = prefs.getString(_keyLastActiveDate);
    var currentStreak = prefs.getInt(_keyCurrentStreak) ?? 0;
    final longestStreak = prefs.getInt(_keyLongestStreak) ?? 0;

    bool isActiveToday = false;
    bool streakAtRisk = false;

    if (lastActiveStr != null) {
      final lastActive = DateTime.parse(lastActiveStr);
      final lastActiveDay = DateTime(lastActive.year, lastActive.month, lastActive.day);
      final difference = today.difference(lastActiveDay).inDays;

      isActiveToday = difference == 0;

      if (difference == 1) {
        // User hasn't been active today but was yesterday
        streakAtRisk = true;
      } else if (difference > 1) {
        // Streak already broken
        currentStreak = 0;
      }
    }

    return StreakInfo(
      currentStreak: currentStreak,
      longestStreak: longestStreak,
      isActiveToday: isActiveToday,
      streakAtRisk: streakAtRisk,
    );
  }

  Future<EngagementMilestone?> _checkStreakMilestones(int streak) async {
    EngagementMilestone? milestone;

    switch (streak) {
      case 3:
        milestone = EngagementMilestone.streak3Days;
        break;
      case 7:
        milestone = EngagementMilestone.streak7Days;
        break;
      case 14:
        milestone = EngagementMilestone.streak14Days;
        break;
      case 30:
        milestone = EngagementMilestone.streak30Days;
        break;
      case 60:
        milestone = EngagementMilestone.streak60Days;
        break;
      case 100:
        milestone = EngagementMilestone.streak100Days;
        break;
    }

    if (milestone != null) {
      await _triggerMilestone(milestone);
    }

    return milestone;
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // MILESTONE DETECTION
  // ═══════════════════════════════════════════════════════════════════════════

  /// Check all milestones based on current stats
  Future<List<EngagementMilestone>> checkMilestones({
    required int totalExpenses,
    required double totalSaved,
    required int totalPursuits,
    required int completedPursuits,
    required bool hasUsedAiChat,
    required bool hasUsedVoiceInput,
    required bool hasSharedCard,
  }) async {
    final newMilestones = <EngagementMilestone>[];

    // Expense milestones
    if (totalExpenses >= 1) {
      if (await _triggerMilestone(EngagementMilestone.firstExpense)) {
        newMilestones.add(EngagementMilestone.firstExpense);
      }
    }
    if (totalExpenses >= 10) {
      if (await _triggerMilestone(EngagementMilestone.tenExpenses)) {
        newMilestones.add(EngagementMilestone.tenExpenses);
      }
    }
    if (totalExpenses >= 50) {
      if (await _triggerMilestone(EngagementMilestone.fiftyExpenses)) {
        newMilestones.add(EngagementMilestone.fiftyExpenses);
      }
    }
    if (totalExpenses >= 100) {
      if (await _triggerMilestone(EngagementMilestone.hundredExpenses)) {
        newMilestones.add(EngagementMilestone.hundredExpenses);
      }
    }

    // Savings milestones
    if (totalSaved > 0) {
      if (await _triggerMilestone(EngagementMilestone.firstSaved)) {
        newMilestones.add(EngagementMilestone.firstSaved);
      }
    }
    if (totalSaved >= 100) {
      if (await _triggerMilestone(EngagementMilestone.saved100)) {
        newMilestones.add(EngagementMilestone.saved100);
      }
    }
    if (totalSaved >= 500) {
      if (await _triggerMilestone(EngagementMilestone.saved500)) {
        newMilestones.add(EngagementMilestone.saved500);
      }
    }
    if (totalSaved >= 1000) {
      if (await _triggerMilestone(EngagementMilestone.saved1000)) {
        newMilestones.add(EngagementMilestone.saved1000);
      }
    }
    if (totalSaved >= 5000) {
      if (await _triggerMilestone(EngagementMilestone.saved5000)) {
        newMilestones.add(EngagementMilestone.saved5000);
      }
    }

    // Pursuit milestones
    if (totalPursuits >= 1) {
      if (await _triggerMilestone(EngagementMilestone.firstPursuit)) {
        newMilestones.add(EngagementMilestone.firstPursuit);
      }
    }
    if (completedPursuits >= 1) {
      if (await _triggerMilestone(EngagementMilestone.firstPursuitCompleted)) {
        newMilestones.add(EngagementMilestone.firstPursuitCompleted);
      }
    }
    if (completedPursuits >= 3) {
      if (await _triggerMilestone(EngagementMilestone.threePursuitsCompleted)) {
        newMilestones.add(EngagementMilestone.threePursuitsCompleted);
      }
    }

    // Feature discovery milestones
    if (hasUsedAiChat) {
      if (await _triggerMilestone(EngagementMilestone.usedAiChat)) {
        newMilestones.add(EngagementMilestone.usedAiChat);
      }
    }
    if (hasUsedVoiceInput) {
      if (await _triggerMilestone(EngagementMilestone.usedVoiceInput)) {
        newMilestones.add(EngagementMilestone.usedVoiceInput);
      }
    }
    if (hasSharedCard) {
      if (await _triggerMilestone(EngagementMilestone.sharedCard)) {
        newMilestones.add(EngagementMilestone.sharedCard);
      }
    }

    return newMilestones;
  }

  /// Trigger a specific milestone (returns true if new, false if already completed)
  Future<bool> _triggerMilestone(EngagementMilestone milestone) async {
    final prefs = await SharedPreferences.getInstance();
    final completedList = prefs.getStringList(_keyCompletedMilestones) ?? [];

    if (completedList.contains(milestone.name)) {
      return false; // Already completed
    }

    // Mark as completed
    completedList.add(milestone.name);
    await prefs.setStringList(_keyCompletedMilestones, completedList);

    // Store as pending celebration
    await prefs.setString(_keyPendingCelebration, milestone.name);

    // Track analytics
    AnalyticsService().logFeatureUsed('milestone_${milestone.name}');

    debugPrint('[Engagement] New milestone: ${milestone.name}');

    return true;
  }

  /// Get celebration data for a milestone
  CelebrationData? getCelebrationData(EngagementMilestone milestone) {
    return _milestoneData[milestone];
  }

  /// Get pending celebration (if any)
  Future<CelebrationData?> getPendingCelebration() async {
    final prefs = await SharedPreferences.getInstance();
    final pendingName = prefs.getString(_keyPendingCelebration);

    if (pendingName == null) return null;

    try {
      final milestone = EngagementMilestone.values.firstWhere(
        (m) => m.name == pendingName,
      );
      return _milestoneData[milestone];
    } catch (e) {
      return null;
    }
  }

  /// Clear pending celebration after showing
  Future<void> clearPendingCelebration() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.remove(_keyPendingCelebration);
  }

  /// Check if a milestone has been completed
  Future<bool> isMilestoneCompleted(EngagementMilestone milestone) async {
    final prefs = await SharedPreferences.getInstance();
    final completedList = prefs.getStringList(_keyCompletedMilestones) ?? [];
    return completedList.contains(milestone.name);
  }

  /// Get all completed milestones
  Future<List<EngagementMilestone>> getCompletedMilestones() async {
    final prefs = await SharedPreferences.getInstance();
    final completedList = prefs.getStringList(_keyCompletedMilestones) ?? [];

    return completedList.map((name) {
      try {
        return EngagementMilestone.values.firstWhere((m) => m.name == name);
      } catch (e) {
        return null;
      }
    }).whereType<EngagementMilestone>().toList();
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // RE-ENGAGEMENT LOGIC
  // ═══════════════════════════════════════════════════════════════════════════

  /// Schedule streak risk notification
  Future<void> scheduleStreakRiskAlert() async {
    final streakInfo = await getStreakInfo();

    if (streakInfo.streakAtRisk && streakInfo.currentStreak >= 3) {
      await NotificationService().scheduleStreakRiskAlert(
        currentStreak: streakInfo.currentStreak,
      );
    }
  }

  /// Get days since last activity
  Future<int> getDaysSinceLastActivity() async {
    final prefs = await SharedPreferences.getInstance();
    final lastActiveStr = prefs.getString(_keyLastActiveDate);

    if (lastActiveStr == null) return -1;

    final lastActive = DateTime.parse(lastActiveStr);
    final now = DateTime.now();
    return now.difference(lastActive).inDays;
  }

  /// Check if user is considered "stalled"
  Future<bool> isUserStalled({int threshold = 3}) async {
    final daysSince = await getDaysSinceLastActivity();
    return daysSince >= threshold;
  }
}

/// Result of recording activity
class StreakResult {
  final int currentStreak;
  final int longestStreak;
  final bool streakIncreased;
  final EngagementMilestone? newMilestone;

  const StreakResult({
    required this.currentStreak,
    required this.longestStreak,
    required this.streakIncreased,
    this.newMilestone,
  });
}

/// Current streak information
class StreakInfo {
  final int currentStreak;
  final int longestStreak;
  final bool isActiveToday;
  final bool streakAtRisk;

  const StreakInfo({
    required this.currentStreak,
    required this.longestStreak,
    required this.isActiveToday,
    required this.streakAtRisk,
  });
}


--- FILE: lib/services/streak_manager.dart ---

import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:vantag/theme/app_theme.dart';

/// Wealth Coach: Frugal Streak Manager
/// İrade Zaferi serisini takip eden sınıf
class StreakManager {
  static final StreakManager _instance = StreakManager._internal();
  factory StreakManager() => _instance;
  StreakManager._internal();

  // Mevcut durum
  int _currentStreak = 0;
  int _longestStreak = 0;
  DateTime? _lastVictoryDate;

  // Birikimler
  double _totalSavedAmount = 0;
  double _totalSavedHours = 0;

  // SharedPreferences keys
  static const _keyCurrentStreak = 'frugal_current_streak';
  static const _keyLongestStreak = 'frugal_longest_streak';
  static const _keyLastVictoryDate = 'frugal_last_victory_date';
  static const _keyTotalSavedAmount = 'frugal_total_saved_amount';
  static const _keyTotalSavedHours = 'frugal_total_saved_hours';

  // Getters
  int get currentStreak => _currentStreak;
  int get longestStreak => _longestStreak;
  DateTime? get lastVictoryDate => _lastVictoryDate;
  double get totalSavedAmount => _totalSavedAmount;
  double get totalSavedHours => _totalSavedHours;

  /// Streak seviyesi (aura rengi için)
  StreakLevel get streakLevel {
    if (_currentStreak >= 10) return StreakLevel.gold;
    if (_currentStreak >= 5) return StreakLevel.purple;
    if (_currentStreak >= 3) return StreakLevel.blue;
    return StreakLevel.none;
  }

  /// Verileri yükle
  Future<void> load() async {
    final prefs = await SharedPreferences.getInstance();

    _currentStreak = prefs.getInt(_keyCurrentStreak) ?? 0;
    _longestStreak = prefs.getInt(_keyLongestStreak) ?? 0;
    _totalSavedAmount = prefs.getDouble(_keyTotalSavedAmount) ?? 0;
    _totalSavedHours = prefs.getDouble(_keyTotalSavedHours) ?? 0;

    final lastVictoryStr = prefs.getString(_keyLastVictoryDate);
    if (lastVictoryStr != null) {
      _lastVictoryDate = DateTime.parse(lastVictoryStr);
    }

    // Streak aktif mi kontrol et
    checkAndResetStreak();
  }

  /// Verileri kaydet
  Future<void> _save() async {
    final prefs = await SharedPreferences.getInstance();

    await prefs.setInt(_keyCurrentStreak, _currentStreak);
    await prefs.setInt(_keyLongestStreak, _longestStreak);
    await prefs.setDouble(_keyTotalSavedAmount, _totalSavedAmount);
    await prefs.setDouble(_keyTotalSavedHours, _totalSavedHours);

    if (_lastVictoryDate != null) {
      await prefs.setString(
        _keyLastVictoryDate,
        _lastVictoryDate!.toIso8601String(),
      );
    }
  }

  /// Yeni İrade Zaferi kaydet
  Future<void> recordVictory({
    required double amount,
    required double hours,
  }) async {
    final now = DateTime.now();

    // Aynı gün içinde tekrar zafer varsa streak artmaz, sadece birikim
    if (_lastVictoryDate != null && _isSameDay(_lastVictoryDate!, now)) {
      _totalSavedAmount += amount;
      _totalSavedHours += hours;
      await _save();
      return;
    }

    // Streak kontrolü
    if (isStreakActive()) {
      // Streak devam ediyor
      _currentStreak++;
    } else {
      // Yeni streak başlat
      _currentStreak = 1;
    }

    // En uzun streak güncelle
    if (_currentStreak > _longestStreak) {
      _longestStreak = _currentStreak;
    }

    // Birikimler
    _totalSavedAmount += amount;
    _totalSavedHours += hours;

    // Tarih güncelle
    _lastVictoryDate = now;

    await _save();
  }

  /// Streak aktif mi? (Son 48 saat içinde zafer var mı?)
  bool isStreakActive() {
    if (_lastVictoryDate == null) return false;

    final now = DateTime.now();
    final difference = now.difference(_lastVictoryDate!);

    // 48 saat içindeyse aktif (1 gün atlama hakkı)
    return difference.inHours < 48;
  }

  /// Streak sıfırlama kontrolü
  void checkAndResetStreak() {
    if (!isStreakActive() && _currentStreak > 0) {
      _currentStreak = 0;
      _save();
    }
  }

  /// Aynı gün mü?
  bool _isSameDay(DateTime a, DateTime b) {
    return a.year == b.year && a.month == b.month && a.day == b.day;
  }

  /// Toplam özgürleşilen süreyi formatla
  String get formattedTotalTime {
    final hours = _totalSavedHours;

    if (hours >= 24) {
      final days = (hours / 24).floor();
      final remainingHours = (hours % 24).round();
      if (remainingHours > 0) {
        return '$days Gün $remainingHours Saat';
      }
      return '$days Gün';
    } else if (hours >= 1) {
      return '${hours.round()} Saat';
    } else {
      return '${(hours * 60).round()} Dakika';
    }
  }

  /// Toplam tasarrufu formatla
  String get formattedTotalAmount {
    if (_totalSavedAmount >= 1000000) {
      return '${(_totalSavedAmount / 1000000).toStringAsFixed(1)}M ₺';
    } else if (_totalSavedAmount >= 1000) {
      return '${(_totalSavedAmount / 1000).toStringAsFixed(1)}K ₺';
    }
    return '${_totalSavedAmount.toStringAsFixed(0)} ₺';
  }

  /// Streak'i sıfırla (test için)
  Future<void> reset() async {
    _currentStreak = 0;
    _longestStreak = 0;
    _lastVictoryDate = null;
    _totalSavedAmount = 0;
    _totalSavedHours = 0;
    await _save();
  }
}

/// Streak seviyesi (aura rengi için)
enum StreakLevel {
  none, // 0-2 streak
  blue, // 3-4 streak
  purple, // 5-9 streak
  gold; // 10+ streak

  Color get auraColor {
    switch (this) {
      case StreakLevel.none:
        return const Color(0x00000000); // Transparent
      case StreakLevel.blue:
        return AppColors.categoryEntertainment; // Blue
      case StreakLevel.purple:
        return AppColors.categoryShopping; // Purple
      case StreakLevel.gold:
        return AppColors.medalGold; // Gold
    }
  }

  double get auraOpacity {
    switch (this) {
      case StreakLevel.none:
        return 0.0;
      case StreakLevel.blue:
        return 0.25;
      case StreakLevel.purple:
        return 0.3;
      case StreakLevel.gold:
        return 0.4;
    }
  }
}

/// Global erişim için kısayol
final streakManager = StreakManager();


--- FILE: lib/services/push_notification_mobile.dart ---

import 'dart:async';
import 'dart:io';
import 'package:firebase_messaging/firebase_messaging.dart';

typedef MessageCallback = Future<void> Function(Map<String, dynamic> message);
typedef TokenCallback = void Function(String token);

/// Mobile platform implementation using Firebase Messaging
class PushNotificationPlatform {
  FirebaseMessaging? _messaging;
  StreamSubscription<RemoteMessage>? _foregroundSubscription;
  StreamSubscription<String>? _tokenSubscription;

  FirebaseMessaging get messaging {
    _messaging ??= FirebaseMessaging.instance;
    return _messaging!;
  }

  Future<bool> requestPermission() async {
    if (!Platform.isIOS && !Platform.isAndroid) return false;

    final settings = await messaging.requestPermission(
      alert: true,
      badge: true,
      sound: true,
      provisional: false,
      announcement: false,
      carPlay: false,
      criticalAlert: false,
    );

    return settings.authorizationStatus == AuthorizationStatus.authorized ||
        settings.authorizationStatus == AuthorizationStatus.provisional;
  }

  Future<String?> getToken() async {
    return await messaging.getToken();
  }

  void onTokenRefresh(TokenCallback callback) {
    _tokenSubscription = messaging.onTokenRefresh.listen(callback);
  }

  void onMessage(MessageCallback callback) {
    _foregroundSubscription = FirebaseMessaging.onMessage.listen((message) {
      callback(_remoteMessageToMap(message));
    });
  }

  void onMessageOpenedApp(Function(Map<String, dynamic>) callback) {
    FirebaseMessaging.onMessageOpenedApp.listen((message) {
      callback(_remoteMessageToMap(message));
    });
  }

  Future<Map<String, dynamic>?> getInitialMessage() async {
    final message = await messaging.getInitialMessage();
    if (message != null) {
      return _remoteMessageToMap(message);
    }
    return null;
  }

  Future<void> subscribeToTopic(String topic) async {
    await messaging.subscribeToTopic(topic);
  }

  Future<void> unsubscribeFromTopic(String topic) async {
    await messaging.unsubscribeFromTopic(topic);
  }

  void dispose() {
    _foregroundSubscription?.cancel();
    _tokenSubscription?.cancel();
  }

  Map<String, dynamic> _remoteMessageToMap(RemoteMessage message) {
    return {
      'messageId': message.messageId,
      'notification': message.notification != null
          ? {
              'title': message.notification!.title,
              'body': message.notification!.body,
            }
          : null,
      'data': message.data,
    };
  }
}

/// Background message handler (must be top-level function)
@pragma('vm:entry-point')
Future<void> firebaseMessagingBackgroundHandler(RemoteMessage message) async {
  // Handle background message
  // Note: This runs in a separate isolate, so you can't access stateful services
}


--- FILE: lib/services/accessibility_service.dart ---

import 'package:flutter/material.dart';
import 'package:flutter/semantics.dart';
import 'package:shared_preferences/shared_preferences.dart';

/// Accessibility preferences and utilities
class AccessibilityService {
  static final AccessibilityService _instance =
      AccessibilityService._internal();
  factory AccessibilityService() => _instance;
  AccessibilityService._internal();

  static const _keyHighContrast = 'a11y_high_contrast';
  static const _keyLargeText = 'a11y_large_text';
  static const _keyReduceMotion = 'a11y_reduce_motion';
  static const _keyReduceTransparency = 'a11y_reduce_transparency';

  bool _highContrastEnabled = false;
  bool _largeTextEnabled = false;
  bool _reduceMotionEnabled = false;
  bool _reduceTransparencyEnabled = false;

  bool get highContrastEnabled => _highContrastEnabled;
  bool get largeTextEnabled => _largeTextEnabled;
  bool get reduceMotionEnabled => _reduceMotionEnabled;
  bool get reduceTransparencyEnabled => _reduceTransparencyEnabled;

  /// Initialize service and load preferences
  Future<void> init() async {
    final prefs = await SharedPreferences.getInstance();
    _highContrastEnabled = prefs.getBool(_keyHighContrast) ?? false;
    _largeTextEnabled = prefs.getBool(_keyLargeText) ?? false;
    _reduceMotionEnabled = prefs.getBool(_keyReduceMotion) ?? false;
    _reduceTransparencyEnabled = prefs.getBool(_keyReduceTransparency) ?? false;
  }

  Future<void> setHighContrast(bool value) async {
    _highContrastEnabled = value;
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_keyHighContrast, value);
  }

  Future<void> setLargeText(bool value) async {
    _largeTextEnabled = value;
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_keyLargeText, value);
  }

  Future<void> setReduceMotion(bool value) async {
    _reduceMotionEnabled = value;
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_keyReduceMotion, value);
  }

  Future<void> setReduceTransparency(bool value) async {
    _reduceTransparencyEnabled = value;
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_keyReduceTransparency, value);
  }

  // ==================== SEMANTIC HELPERS ====================

  /// Get animation duration based on reduce motion setting
  Duration getAnimationDuration(Duration normal) {
    if (_reduceMotionEnabled) {
      return Duration.zero;
    }
    return normal;
  }

  /// Get blur amount based on reduce transparency setting
  double getBlurAmount(double normal) {
    if (_reduceTransparencyEnabled) {
      return 0;
    }
    return normal;
  }

  /// Get opacity based on reduce transparency setting
  double getOpacity(double normal) {
    if (_reduceTransparencyEnabled) {
      return 1.0;
    }
    return normal;
  }

  /// Get text scale factor
  double getTextScaleFactor() {
    if (_largeTextEnabled) {
      return 1.2;
    }
    return 1.0;
  }

  /// Get contrasted color
  Color getContrastedColor(Color color, {Color? highContrastColor}) {
    if (_highContrastEnabled) {
      return highContrastColor ?? _increaseContrast(color);
    }
    return color;
  }

  Color _increaseContrast(Color color) {
    final hsl = HSLColor.fromColor(color);
    if (hsl.lightness > 0.5) {
      return hsl.withLightness((hsl.lightness + 0.2).clamp(0.0, 1.0)).toColor();
    } else {
      return hsl.withLightness((hsl.lightness - 0.1).clamp(0.0, 1.0)).toColor();
    }
  }
}

/// Global instance
final a11y = AccessibilityService();

// ==================== SEMANTIC WRAPPER WIDGETS ====================

/// Wrapper for semantic labeling
class SemanticLabel extends StatelessWidget {
  final Widget child;
  final String label;
  final String? hint;
  final bool button;
  final bool header;
  final bool link;
  final VoidCallback? onTap;

  const SemanticLabel({
    super.key,
    required this.child,
    required this.label,
    this.hint,
    this.button = false,
    this.header = false,
    this.link = false,
    this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    return Semantics(
      label: label,
      hint: hint,
      button: button,
      header: header,
      link: link,
      onTap: onTap,
      child: child,
    );
  }
}

/// Wrapper for buttons with semantic labels
class SemanticButton extends StatelessWidget {
  final Widget child;
  final String label;
  final VoidCallback? onTap;
  final bool enabled;

  const SemanticButton({
    super.key,
    required this.child,
    required this.label,
    this.onTap,
    this.enabled = true,
  });

  @override
  Widget build(BuildContext context) {
    return Semantics(
      label: label,
      button: true,
      enabled: enabled,
      onTap: enabled ? onTap : null,
      child: child,
    );
  }
}

/// Wrapper for value displays (currency, numbers)
class SemanticValue extends StatelessWidget {
  final Widget child;
  final String value;
  final String? label;
  final bool increasedValue;
  final bool decreasedValue;

  const SemanticValue({
    super.key,
    required this.child,
    required this.value,
    this.label,
    this.increasedValue = false,
    this.decreasedValue = false,
  });

  @override
  Widget build(BuildContext context) {
    return Semantics(
      value: value,
      label: label,
      increasedValue: increasedValue ? value : null,
      decreasedValue: decreasedValue ? value : null,
      child: ExcludeSemantics(child: child),
    );
  }
}

/// Wrapper for progress indicators
class SemanticProgress extends StatelessWidget {
  final Widget child;
  final double value; // 0.0 - 1.0
  final String? label;

  const SemanticProgress({
    super.key,
    required this.child,
    required this.value,
    this.label,
  });

  @override
  Widget build(BuildContext context) {
    final percent = (value * 100).round();
    return Semantics(
      label: label ?? 'Progress',
      value: '$percent%',
      child: ExcludeSemantics(child: child),
    );
  }
}

/// Wrapper for images with descriptions
class SemanticImage extends StatelessWidget {
  final Widget child;
  final String description;
  final bool decorative;

  const SemanticImage({
    super.key,
    required this.child,
    required this.description,
    this.decorative = false,
  });

  @override
  Widget build(BuildContext context) {
    if (decorative) {
      return ExcludeSemantics(child: child);
    }
    return Semantics(image: true, label: description, child: child);
  }
}

/// Wrapper for list items
class SemanticListItem extends StatelessWidget {
  final Widget child;
  final int index;
  final int total;
  final String? label;

  const SemanticListItem({
    super.key,
    required this.child,
    required this.index,
    required this.total,
    this.label,
  });

  @override
  Widget build(BuildContext context) {
    return Semantics(
      label: label != null
          ? '$label, ${index + 1} of $total'
          : '${index + 1} of $total',
      child: child,
    );
  }
}

/// Wrapper for toggleable controls
class SemanticToggle extends StatelessWidget {
  final Widget child;
  final String label;
  final bool toggled;
  final VoidCallback? onTap;

  const SemanticToggle({
    super.key,
    required this.child,
    required this.label,
    required this.toggled,
    this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    return Semantics(
      label: label,
      toggled: toggled,
      onTap: onTap,
      child: child,
    );
  }
}

/// Live region for announcements
class SemanticAnnouncement extends StatelessWidget {
  final Widget child;
  final String? announcement;
  final bool liveRegion;

  const SemanticAnnouncement({
    super.key,
    required this.child,
    this.announcement,
    this.liveRegion = true,
  });

  @override
  Widget build(BuildContext context) {
    return Semantics(liveRegion: liveRegion, label: announcement, child: child);
  }
}

// ==================== HELPER FUNCTIONS ====================

/// Announce a message to screen readers
void announceToScreenReader(BuildContext context, String message) {
  // Use the new sendAnnouncement API (announce is deprecated after v3.35.0)
  // ignore: deprecated_member_use
  SemanticsService.announce(message, TextDirection.ltr);
}

/// Check if screen reader is enabled
bool isScreenReaderEnabled(BuildContext context) {
  return MediaQuery.of(context).accessibleNavigation;
}

/// Check if reduce motion is enabled in system
bool isReduceMotionEnabled(BuildContext context) {
  return MediaQuery.of(context).disableAnimations;
}

/// Check if high contrast is enabled in system
bool isHighContrastEnabled(BuildContext context) {
  return MediaQuery.of(context).highContrast;
}

/// Check if bold text is enabled in system
bool isBoldTextEnabled(BuildContext context) {
  return MediaQuery.of(context).boldText;
}


--- FILE: lib/services/currency_preference_service.dart ---

import 'dart:io' show Platform;
import 'package:flutter/foundation.dart';
import 'package:shared_preferences/shared_preferences.dart';
import '../models/currency.dart';

/// Service for managing currency preferences
class CurrencyPreferenceService {
  static const String _key = 'selected_currency';
  static const String _firstLaunchKey = 'currency_first_launch_done';

  /// Save selected currency code
  static Future<void> setCurrency(String code) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(_key, code);
  }

  /// Get saved currency code
  /// On first launch: Turkish phone → TRY, otherwise → USD
  static Future<String> getCurrencyCode() async {
    final prefs = await SharedPreferences.getInstance();
    final savedCode = prefs.getString(_key);
    final firstLaunchDone = prefs.getBool(_firstLaunchKey) ?? false;

    if (savedCode != null) {
      // User has a saved preference
      return savedCode;
    }

    if (!firstLaunchDone) {
      // First launch - set based on phone language
      final defaultCurrency = _isPhoneTurkish() ? 'TRY' : 'USD';
      await prefs.setString(_key, defaultCurrency);
      await prefs.setBool(_firstLaunchKey, true);
      debugPrint(
        '[CurrencyPreference] First launch - default currency: $defaultCurrency',
      );
      return defaultCurrency;
    }

    // Fallback (shouldn't happen normally)
    return 'USD';
  }

  /// Check if phone language is Turkish
  static bool _isPhoneTurkish() {
    try {
      final localeName = Platform.localeName; // e.g., "tr_TR", "en_US"
      return localeName.toLowerCase().startsWith('tr');
    } catch (e) {
      debugPrint('[CurrencyPreference] Error detecting phone locale: $e');
      return false;
    }
  }

  /// Get Currency object
  static Future<Currency> getCurrency() async {
    final code = await getCurrencyCode();
    return getCurrencyByCode(code);
  }

  /// Format amount with currency
  /// Supports both integer format and decimal format
  static String format(
    Currency currency,
    double amount, {
    int decimalDigits = 0,
  }) {
    final isNegative = amount < 0;
    final absAmount = amount.abs();

    String formatted;
    if (decimalDigits > 0) {
      // With decimals
      final parts = absAmount.toStringAsFixed(decimalDigits).split('.');
      final intPart = _addThousandSeparators(
        parts[0],
        currency.thousandSeparator,
      );
      final decPart = parts.length > 1 ? parts[1] : '0' * decimalDigits;
      formatted = '$intPart${currency.decimalSeparator}$decPart';
    } else {
      // Integer only
      formatted = _addThousandSeparators(
        absAmount.truncate().toString(),
        currency.thousandSeparator,
      );
    }

    // Add negative sign if needed
    if (isNegative) {
      formatted = '-$formatted';
    }

    // Add symbol
    if (currency.symbolBefore) {
      return '${currency.symbol}$formatted';
    } else {
      return '$formatted ${currency.symbol}';
    }
  }

  /// Format amount without symbol
  static String formatWithoutSymbol(
    Currency currency,
    double amount, {
    int decimalDigits = 0,
  }) {
    final isNegative = amount < 0;
    final absAmount = amount.abs();

    String formatted;
    if (decimalDigits > 0) {
      final parts = absAmount.toStringAsFixed(decimalDigits).split('.');
      final intPart = _addThousandSeparators(
        parts[0],
        currency.thousandSeparator,
      );
      final decPart = parts.length > 1 ? parts[1] : '0' * decimalDigits;
      formatted = '$intPart${currency.decimalSeparator}$decPart';
    } else {
      formatted = _addThousandSeparators(
        absAmount.truncate().toString(),
        currency.thousandSeparator,
      );
    }

    return isNegative ? '-$formatted' : formatted;
  }

  /// Add thousand separators to a number string
  static String _addThousandSeparators(String number, String separator) {
    if (number.length <= 3) return number;

    final buffer = StringBuffer();
    final length = number.length;

    for (int i = 0; i < length; i++) {
      if (i > 0 && (length - i) % 3 == 0) {
        buffer.write(separator);
      }
      buffer.write(number[i]);
    }

    return buffer.toString();
  }
}


--- FILE: lib/services/free_tier_service.dart ---

import 'dart:math';
import 'package:flutter/foundation.dart';
import 'package:shared_preferences/shared_preferences.dart';
import '../constants/app_limits.dart';

/// Service to manage free tier limitations
/// Centralizes all free tier logic for consistent enforcement
class FreeTierService {
  // ═══════════════════════════════════════════════════════════════════════════
  // CONSTANTS (use AppLimits as single source of truth)
  // ═══════════════════════════════════════════════════════════════════════════

  /// Maximum AI chat messages per day for free users
  static int get maxFreeAiChats => AppLimits.freeAiChatsPerDay;

  /// Maximum active pursuits for free users
  static int get maxFreePursuits => AppLimits.freePursuits;

  /// Free users can only use TRY currency
  static String get freeCurrency => AppLimits.freeCurrency;

  // SharedPreferences keys
  static const String _keyAiChatLastDate = 'free_ai_chat_last_date';
  static const String _keyAiChatCount = 'free_ai_chat_count';
  static const String _keyVoiceInputLastDate = 'voice_input_last_date';
  static const String _keyVoiceInputCount = 'voice_input_count';

  // Singleton
  static final FreeTierService _instance = FreeTierService._internal();
  factory FreeTierService() => _instance;
  FreeTierService._internal();

  // ═══════════════════════════════════════════════════════════════════════════
  // AI CHAT LIMITS (4/day for free users)
  // ═══════════════════════════════════════════════════════════════════════════

  /// Get today's AI chat count for free users
  Future<int> getTodayAiChatCount() async {
    final prefs = await SharedPreferences.getInstance();
    final today = DateTime.now().toIso8601String().substring(0, 10);
    final lastDate = prefs.getString(_keyAiChatLastDate) ?? '';

    // Reset counter if new day
    if (lastDate != today) {
      await prefs.setString(_keyAiChatLastDate, today);
      await prefs.setInt(_keyAiChatCount, 0);
      return 0;
    }

    return prefs.getInt(_keyAiChatCount) ?? 0;
  }

  /// Check if free user can use AI chat
  Future<bool> canUseAiChat(bool isPremium) async {
    if (isPremium) return true;
    final count = await getTodayAiChatCount();
    return count < maxFreeAiChats;
  }

  /// Get remaining AI chats for today
  /// Returns -1 for premium users (unlimited)
  Future<int> getRemainingAiChats(bool isPremium) async {
    if (isPremium) return -1; // Unlimited
    final count = await getTodayAiChatCount();
    return max(0, maxFreeAiChats - count);
  }

  /// Increment AI chat count after successful message
  Future<void> incrementAiChatCount() async {
    final prefs = await SharedPreferences.getInstance();
    final count = await getTodayAiChatCount();
    await prefs.setInt(_keyAiChatCount, count + 1);
  }

  /// Get reset time for AI chat limit (midnight)
  DateTime getAiChatResetTime() {
    final now = DateTime.now();
    return DateTime(now.year, now.month, now.day + 1);
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // VOICE INPUT LIMITS (1/day free, 10/day pro)
  // ═══════════════════════════════════════════════════════════════════════════

  /// Maximum voice inputs per day for free users
  static int get maxFreeVoiceInputs => AppLimits.freeVoiceInputPerDay;

  /// Maximum voice inputs per day for pro users
  static int get maxProVoiceInputs => AppLimits.proVoiceInputPerDay;

  /// Get today's voice input count
  Future<int> getTodayVoiceInputCount() async {
    final prefs = await SharedPreferences.getInstance();
    final today = DateTime.now().toIso8601String().substring(0, 10);
    final lastDate = prefs.getString(_keyVoiceInputLastDate) ?? '';

    // Reset counter if new day
    if (lastDate != today) {
      await prefs.setString(_keyVoiceInputLastDate, today);
      await prefs.setInt(_keyVoiceInputCount, 0);
      return 0;
    }

    return prefs.getInt(_keyVoiceInputCount) ?? 0;
  }

  /// Check if user can use voice input
  /// Returns a result with canUse flag and appropriate message type
  Future<VoiceInputLimitResult> canUseVoiceInput(bool isPremium) async {
    final count = await getTodayVoiceInputCount();

    if (isPremium) {
      // Pro user: 10/day limit (shown as unlimited)
      if (count >= maxProVoiceInputs) {
        return VoiceInputLimitResult(
          canUse: false,
          limitType: VoiceInputLimitType.proServerBusy,
        );
      }
      return VoiceInputLimitResult(canUse: true);
    } else {
      // Free user: 1/day limit
      if (count >= maxFreeVoiceInputs) {
        return VoiceInputLimitResult(
          canUse: false,
          limitType: VoiceInputLimitType.freeLimitReached,
        );
      }
      return VoiceInputLimitResult(canUse: true);
    }
  }

  /// Increment voice input count after successful use
  Future<void> incrementVoiceInputCount() async {
    final prefs = await SharedPreferences.getInstance();
    final count = await getTodayVoiceInputCount();
    await prefs.setInt(_keyVoiceInputCount, count + 1);
  }

  /// Reset voice input count (for testing)
  Future<void> resetVoiceInputCount() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.remove(_keyVoiceInputLastDate);
    await prefs.remove(_keyVoiceInputCount);
    debugPrint('[FreeTierService] Voice input count reset');
  }

  /// Get remaining voice inputs for today
  /// Returns (used, total) tuple
  Future<(int used, int total)> getVoiceInputUsage(bool isPremium) async {
    final count = await getTodayVoiceInputCount();
    final maxLimit = isPremium ? maxProVoiceInputs : maxFreeVoiceInputs;
    return (count, maxLimit);
  }

  /// Get remaining AI chats for today (free users)
  /// Returns (used, total) tuple
  Future<(int used, int total)> getAiChatUsage() async {
    final count = await getTodayAiChatCount();
    return (count, maxFreeAiChats);
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // STATEMENT IMPORT LIMITS (1/month free, 10/month pro)
  // ═══════════════════════════════════════════════════════════════════════════

  static const String _keyStatementImportMonth = 'statement_import_month';
  static const String _keyStatementImportCount = 'statement_import_count';

  /// Maximum statement imports per month for free users
  static const int maxFreeStatementImports = 1;

  /// Maximum statement imports per month for pro users
  static const int maxProStatementImports = 10;

  /// Get current month's statement import count
  Future<int> getMonthlyStatementImportCount() async {
    final prefs = await SharedPreferences.getInstance();
    final currentMonth = _getCurrentMonth();
    final savedMonth = prefs.getString(_keyStatementImportMonth) ?? '';

    // Reset counter if new month
    if (savedMonth != currentMonth) {
      await prefs.setString(_keyStatementImportMonth, currentMonth);
      await prefs.setInt(_keyStatementImportCount, 0);
      return 0;
    }

    return prefs.getInt(_keyStatementImportCount) ?? 0;
  }

  /// Get current month string (YYYY-MM)
  String _getCurrentMonth() {
    final now = DateTime.now();
    return '${now.year}-${now.month.toString().padLeft(2, '0')}';
  }

  /// Check if user can import a statement
  Future<StatementImportLimitResult> canImportStatement(bool isPremium) async {
    final count = await getMonthlyStatementImportCount();
    final maxLimit = isPremium
        ? maxProStatementImports
        : maxFreeStatementImports;

    if (count >= maxLimit) {
      return StatementImportLimitResult(
        canUse: false,
        currentCount: count,
        maxCount: maxLimit,
        isPremium: isPremium,
      );
    }

    return StatementImportLimitResult(
      canUse: true,
      currentCount: count,
      maxCount: maxLimit,
      isPremium: isPremium,
    );
  }

  /// Increment statement import count after successful import
  Future<void> incrementStatementImportCount() async {
    final prefs = await SharedPreferences.getInstance();
    final count = await getMonthlyStatementImportCount();
    await prefs.setInt(_keyStatementImportCount, count + 1);
    debugPrint('[FreeTierService] Statement import count: ${count + 1}');
  }

  /// Get remaining statement imports for this month
  Future<int> getRemainingStatementImports(bool isPremium) async {
    final count = await getMonthlyStatementImportCount();
    final maxLimit = isPremium
        ? maxProStatementImports
        : maxFreeStatementImports;
    return max(0, maxLimit - count);
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // PURSUIT LIMITS (1 active for free users)
  // ═══════════════════════════════════════════════════════════════════════════

  /// Check if free user can create a new pursuit
  bool canCreatePursuit(bool isPremium, int activePursuitCount) {
    if (isPremium) return true;
    return activePursuitCount < maxFreePursuits;
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // CURRENCY LIMITS (TRY only for free users)
  // ═══════════════════════════════════════════════════════════════════════════

  /// Check if currency is available for user
  bool isCurrencyAvailable(bool isPremium, String currencyCode) {
    if (isPremium) return true;
    return currencyCode == freeCurrency;
  }

  /// Get list of available currencies for user
  List<String> getAvailableCurrencies(bool isPremium) {
    if (isPremium) {
      return ['TRY', 'USD', 'EUR', 'GBP', 'SAR'];
    }
    return [freeCurrency];
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // REPORT LIMITS (Weekly only for free users)
  // ═══════════════════════════════════════════════════════════════════════════

  /// Check if report period is available for user
  /// Free users can only access weekly reports
  bool isReportPeriodAvailable(bool isPremium, String period) {
    if (isPremium) return true;
    // Only 'week' is available for free users
    return period == 'week';
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // EXPORT LIMITS (Premium only)
  // ═══════════════════════════════════════════════════════════════════════════

  /// Check if export is available for user
  bool canExport(bool isPremium) {
    return isPremium;
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // SHARE CARD (Watermark for free users)
  // ═══════════════════════════════════════════════════════════════════════════

  /// Check if share card should show watermark
  bool shouldShowWatermark(bool isPremium) {
    return !isPremium;
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // DEBUG / TESTING
  // ═══════════════════════════════════════════════════════════════════════════

  /// Reset AI chat count (for testing)
  Future<void> resetAiChatCount() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.remove(_keyAiChatLastDate);
    await prefs.remove(_keyAiChatCount);
    debugPrint('[FreeTierService] AI chat count reset');
  }
}

/// Type of voice input limit reached
enum VoiceInputLimitType {
  /// Free user reached daily limit
  freeLimitReached,

  /// Pro user reached hidden limit (show as server busy)
  proServerBusy,
}

/// Result of voice input limit check
class VoiceInputLimitResult {
  final bool canUse;
  final VoiceInputLimitType? limitType;

  const VoiceInputLimitResult({required this.canUse, this.limitType});
}

/// Result of statement import limit check
class StatementImportLimitResult {
  final bool canUse;
  final int currentCount;
  final int maxCount;
  final bool isPremium;

  const StatementImportLimitResult({
    required this.canUse,
    required this.currentCount,
    required this.maxCount,
    required this.isPremium,
  });

  /// Remaining imports this month
  int get remaining => maxCount - currentCount;
}


--- FILE: lib/services/purchase_service.dart ---

import 'dart:async';
import 'dart:io';
import 'package:flutter/foundation.dart';
import 'package:flutter_dotenv/flutter_dotenv.dart';
import 'package:purchases_flutter/purchases_flutter.dart';
import 'package:shared_preferences/shared_preferences.dart';
import '../constants/app_limits.dart';
import 'analytics_service.dart';
import 'notification_service.dart';

/// RevenueCat-based purchase service for Vantag Pro subscriptions
/// Supports: Monthly, Yearly (subscriptions) and Lifetime (one-time purchase)
class PurchaseService {
  static String get _apiKey {
    final key = dotenv.env['REVENUECAT_API_KEY'];
    if (key == null || key.isEmpty) {
      debugPrint('WARNING: REVENUECAT_API_KEY not found in .env file');
      return '';
    }
    return key;
  }

  static const String _entitlementId = 'pro';

  // Product identifiers
  static const String productMonthly = 'vantag_pro_monthly';
  static const String productYearly = 'vantag_pro_yearly';
  static const String productLifetime = 'vantag-pro-lifetime';

  // Usage limits for free tier (use AppLimits as single source of truth)
  static int get freeAiChatLimit => AppLimits.freeAiChatsPerDay;
  static int get freeHistoryDays => AppLimits.freeHistoryDays;

  // Pro credit limits (monthly reset)
  static const int proSubscriptionMonthlyLimit =
      500; // Monthly/Yearly subscribers
  static const int proLifetimeMonthlyLimit = 200; // Lifetime users

  // Credit pack product identifiers
  static const String creditPack50 = 'credit_pack_50';
  static const String creditPack150 = 'credit_pack_150';
  static const String creditPack500 = 'credit_pack_500';

  // Credit amounts for each pack
  static const Map<String, int> _creditPackAmounts = {
    creditPack50: 50,
    creditPack150: 150,
    creditPack500: 500,
  };

  // SharedPreferences keys
  static const String _keyDailyAiUsage = 'daily_ai_usage';
  static const String _keyLastAiUsageDate = 'last_ai_usage_date';
  static const String _keyMonthlyAiUsage = 'monthly_ai_usage';
  static const String _keyLastMonthlyReset = 'last_monthly_reset';
  static const String _keyIsLifetime = 'is_lifetime_user';
  static const String _keyExtraCredits = 'extra_ai_credits';

  static final PurchaseService _instance = PurchaseService._internal();
  factory PurchaseService() => _instance;
  PurchaseService._internal();

  bool _isInitialized = false;
  final _proStatusController = StreamController<bool>.broadcast();

  /// Stream to listen for Pro status changes
  Stream<bool> get proStatusStream => _proStatusController.stream;

  /// Initialize RevenueCat SDK
  static Future<void> init() async {
    final instance = PurchaseService();
    if (instance._isInitialized) return;

    try {
      // Check if API key is available
      final apiKey = _apiKey;
      if (apiKey.isEmpty) {
        debugPrint('RevenueCat: API key not configured, using mock mode');
        instance._isInitialized = true;
        return;
      }

      // Configure RevenueCat
      await Purchases.setLogLevel(LogLevel.debug);

      PurchasesConfiguration configuration;
      if (Platform.isAndroid) {
        configuration = PurchasesConfiguration(apiKey);
      } else if (Platform.isIOS) {
        configuration = PurchasesConfiguration(apiKey);
      } else {
        // Windows/Web - use mock mode
        debugPrint('RevenueCat: Platform not supported, using mock mode');
        instance._isInitialized = true;
        return;
      }

      await Purchases.configure(configuration);

      // Listen to customer info updates
      Purchases.addCustomerInfoUpdateListener((customerInfo) {
        final isPro = instance._checkEntitlement(customerInfo);
        instance._proStatusController.add(isPro);
      });

      instance._isInitialized = true;
      debugPrint('RevenueCat initialized successfully');
    } catch (e) {
      debugPrint('RevenueCat initialization error: $e');
    }
  }

  /// Get available subscription offerings
  Future<Offerings?> getOfferings() async {
    if (!_isInitialized) return null;

    try {
      final offerings = await Purchases.getOfferings();
      return offerings;
    } catch (e) {
      debugPrint('Error fetching offerings: $e');
      return null;
    }
  }

  /// Purchase a subscription package
  Future<PurchaseResult> purchasePackage(Package package) async {
    if (!_isInitialized) {
      return PurchaseResult(success: false, message: 'Service not initialized');
    }

    try {
      final purchaseResult = await Purchases.purchasePackage(package);
      final customerInfo = purchaseResult.customerInfo;
      final isPro = _checkEntitlement(customerInfo);
      _proStatusController.add(isPro);

      // Check if it's a lifetime purchase and save locally
      if (package.identifier.toLowerCase().contains('lifetime')) {
        final prefs = await SharedPreferences.getInstance();
        await prefs.setBool(_keyIsLifetime, true);
      }

      // Cancel trial notifications since user converted to paid
      if (isPro) {
        try {
          await NotificationService().cancelTrialNotifications();
          debugPrint('[PurchaseService] Trial notifications cancelled');
        } catch (e) {
          debugPrint(
            '[PurchaseService] Error cancelling trial notifications: $e',
          );
        }

        // Track subscription started
        final planType = package.identifier.toLowerCase().contains('lifetime')
            ? 'lifetime'
            : package.identifier.toLowerCase().contains('yearly') ||
                    package.identifier.toLowerCase().contains('annual')
                ? 'yearly'
                : 'monthly';
        AnalyticsService().logSubscriptionStarted(planType);
      }

      return PurchaseResult(
        success: isPro,
        message: isPro
            ? 'Purchase successful!'
            : 'Purchase completed but entitlement not found',
      );
    } on PurchasesErrorCode catch (e) {
      String message;
      switch (e) {
        case PurchasesErrorCode.purchaseCancelledError:
          message = 'Purchase cancelled';
          break;
        case PurchasesErrorCode.purchaseNotAllowedError:
          message = 'Purchase not allowed';
          break;
        case PurchasesErrorCode.purchaseInvalidError:
          message = 'Invalid purchase';
          break;
        case PurchasesErrorCode.productNotAvailableForPurchaseError:
          message = 'Product not available';
          break;
        case PurchasesErrorCode.productAlreadyPurchasedError:
          message = 'Already purchased';
          break;
        default:
          message = 'Purchase failed: $e';
      }
      return PurchaseResult(success: false, message: message);
    } catch (e) {
      return PurchaseResult(success: false, message: 'Purchase error: $e');
    }
  }

  /// Restore previous purchases
  Future<PurchaseResult> restorePurchases() async {
    if (!_isInitialized) {
      return PurchaseResult(success: false, message: 'Service not initialized');
    }

    try {
      final customerInfo = await Purchases.restorePurchases();
      final isPro = _checkEntitlement(customerInfo);
      _proStatusController.add(isPro);

      // Cancel trial notifications if user has active subscription
      if (isPro) {
        try {
          await NotificationService().cancelTrialNotifications();
          debugPrint(
            '[PurchaseService] Trial notifications cancelled after restore',
          );
        } catch (e) {
          debugPrint(
            '[PurchaseService] Error cancelling trial notifications: $e',
          );
        }
      }

      return PurchaseResult(
        success: true,
        message: isPro
            ? 'Pro subscription restored!'
            : 'No active subscription found',
        isPro: isPro,
      );
    } catch (e) {
      return PurchaseResult(success: false, message: 'Restore failed: $e');
    }
  }

  /// Check if user has Pro entitlement
  Future<bool> checkProStatus() async {
    if (!_isInitialized) {
      // Check on unsupported platforms via SharedPreferences
      if (!Platform.isAndroid && !Platform.isIOS) {
        final prefs = await SharedPreferences.getInstance();
        return prefs.getBool('is_pro_user') ?? false;
      }
      return false;
    }

    try {
      final customerInfo = await Purchases.getCustomerInfo();
      return _checkEntitlement(customerInfo);
    } catch (e) {
      debugPrint('Error checking Pro status: $e');
      return false;
    }
  }

  /// Check entitlement from CustomerInfo
  bool _checkEntitlement(CustomerInfo customerInfo) {
    return customerInfo.entitlements.all[_entitlementId]?.isActive ?? false;
  }

  /// Check if user has Lifetime (not subscription)
  Future<bool> isLifetimeUser() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getBool(_keyIsLifetime) ?? false;
  }

  /// Get current customer info
  Future<CustomerInfo?> getCustomerInfo() async {
    if (!_isInitialized) return null;

    try {
      return await Purchases.getCustomerInfo();
    } catch (e) {
      debugPrint('Error getting customer info: $e');
      return null;
    }
  }

  /// Login user (for account linking)
  Future<void> login(String userId) async {
    if (!_isInitialized) return;

    try {
      await Purchases.logIn(userId);
    } catch (e) {
      debugPrint('Error logging in: $e');
    }
  }

  /// Logout user
  Future<void> logout() async {
    if (!_isInitialized) return;

    try {
      await Purchases.logOut();
    } catch (e) {
      debugPrint('Error logging out: $e');
    }
  }

  // ══════════════════════════════════════════════════════════════════════════
  // USAGE LIMITS (Free Tier - Daily)
  // ══════════════════════════════════════════════════════════════════════════

  /// Check if user can use AI chat (free: 4/day limit)
  Future<bool> canUseAiChat(bool isPro) async {
    if (isPro) return true;

    final prefs = await SharedPreferences.getInstance();
    final today = DateTime.now().toIso8601String().substring(0, 10);
    final lastDate = prefs.getString(_keyLastAiUsageDate) ?? '';

    // Reset counter if new day
    if (lastDate != today) {
      await prefs.setInt(_keyDailyAiUsage, 0);
      await prefs.setString(_keyLastAiUsageDate, today);
      return true;
    }

    final usage = prefs.getInt(_keyDailyAiUsage) ?? 0;
    return usage < freeAiChatLimit;
  }

  /// Increment AI chat usage counter (for free users - daily)
  Future<int> incrementAiUsage() async {
    final prefs = await SharedPreferences.getInstance();
    final today = DateTime.now().toIso8601String().substring(0, 10);
    final lastDate = prefs.getString(_keyLastAiUsageDate) ?? '';

    int usage;
    if (lastDate != today) {
      usage = 1;
      await prefs.setString(_keyLastAiUsageDate, today);
    } else {
      usage = (prefs.getInt(_keyDailyAiUsage) ?? 0) + 1;
    }

    await prefs.setInt(_keyDailyAiUsage, usage);
    return usage;
  }

  /// Get remaining AI chat uses for today (free users)
  Future<int> getRemainingAiUses(bool isPro) async {
    if (isPro) return -1; // Check monthly credits instead

    final prefs = await SharedPreferences.getInstance();
    final today = DateTime.now().toIso8601String().substring(0, 10);
    final lastDate = prefs.getString(_keyLastAiUsageDate) ?? '';

    if (lastDate != today) return freeAiChatLimit;

    final usage = prefs.getInt(_keyDailyAiUsage) ?? 0;
    return (freeAiChatLimit - usage).clamp(0, freeAiChatLimit);
  }

  // ══════════════════════════════════════════════════════════════════════════
  // USAGE LIMITS (Pro Tier - Monthly)
  // ══════════════════════════════════════════════════════════════════════════

  /// Get remaining monthly AI credits for Pro users
  Future<int> getRemainingMonthlyCredits(bool isPro, bool isLifetime) async {
    if (!isPro) return 0;

    final prefs = await SharedPreferences.getInstance();
    final now = DateTime.now();
    final lastResetStr = prefs.getString(_keyLastMonthlyReset);

    // Reset on 1st of each month
    if (lastResetStr == null ||
        !_isSameMonth(DateTime.parse(lastResetStr), now)) {
      await prefs.setInt(_keyMonthlyAiUsage, 0);
      await prefs.setString(_keyLastMonthlyReset, now.toIso8601String());
      return isLifetime ? proLifetimeMonthlyLimit : proSubscriptionMonthlyLimit;
    }

    final usage = prefs.getInt(_keyMonthlyAiUsage) ?? 0;
    final limit = isLifetime
        ? proLifetimeMonthlyLimit
        : proSubscriptionMonthlyLimit;
    return (limit - usage).clamp(0, limit);
  }

  /// Check if same month
  bool _isSameMonth(DateTime a, DateTime b) {
    return a.year == b.year && a.month == b.month;
  }

  /// Increment monthly usage for Pro users
  Future<void> incrementMonthlyUsage() async {
    final prefs = await SharedPreferences.getInstance();
    final usage = (prefs.getInt(_keyMonthlyAiUsage) ?? 0) + 1;
    await prefs.setInt(_keyMonthlyAiUsage, usage);
  }

  /// Check if Pro user can use AI (checks monthly credits)
  Future<bool> canProUserUseAi(bool isLifetime) async {
    final remaining = await getRemainingMonthlyCredits(true, isLifetime);
    return remaining > 0;
  }

  /// Get monthly limit based on subscription type
  int getMonthlyLimit(bool isLifetime) {
    return isLifetime ? proLifetimeMonthlyLimit : proSubscriptionMonthlyLimit;
  }

  // ══════════════════════════════════════════════════════════════════════════
  // HISTORY LIMITS
  // ══════════════════════════════════════════════════════════════════════════

  /// Get history date limit for free users
  DateTime getHistoryLimit(bool isPro) {
    if (isPro) {
      return DateTime(2000); // effectively unlimited
    }
    return DateTime.now().subtract(Duration(days: freeHistoryDays));
  }

  // ══════════════════════════════════════════════════════════════════════════
  // CREDIT PACKS (For Lifetime Users)
  // ══════════════════════════════════════════════════════════════════════════

  /// Purchase a credit pack (consumable product)
  Future<PurchaseResult> purchaseCreditPack(String packId) async {
    if (!_isInitialized) {
      // For development/testing - simulate purchase
      if (!Platform.isAndroid && !Platform.isIOS) {
        final credits = _creditPackAmounts[packId] ?? 0;
        if (credits > 0) {
          await addCredits(credits);
          return PurchaseResult(
            success: true,
            message: 'Credits added (test mode)',
          );
        }
      }
      return PurchaseResult(success: false, message: 'Service not initialized');
    }

    try {
      // Get the product from offerings
      final offerings = await Purchases.getOfferings();
      if (offerings.current == null) {
        return PurchaseResult(
          success: false,
          message: 'No offerings available',
        );
      }

      // Find the credit pack product
      Package? package;
      for (final pkg in offerings.current!.availablePackages) {
        if (pkg.storeProduct.identifier == packId) {
          package = pkg;
          break;
        }
      }

      if (package == null) {
        return PurchaseResult(success: false, message: 'Credit pack not found');
      }

      // Purchase the consumable
      await Purchases.purchasePackage(package);

      // Add credits to local storage
      final credits = _creditPackAmounts[packId] ?? 0;
      await addCredits(credits);

      return PurchaseResult(
        success: true,
        message: 'Successfully purchased $credits credits',
      );
    } on PurchasesErrorCode catch (e) {
      String message;
      switch (e) {
        case PurchasesErrorCode.purchaseCancelledError:
          message = 'Purchase cancelled';
          break;
        case PurchasesErrorCode.purchaseNotAllowedError:
          message = 'Purchase not allowed';
          break;
        default:
          message = 'Purchase failed: $e';
      }
      return PurchaseResult(success: false, message: message);
    } catch (e) {
      return PurchaseResult(success: false, message: 'Purchase error: $e');
    }
  }

  /// Add credits to user's extra credit balance
  Future<void> addCredits(int amount) async {
    final prefs = await SharedPreferences.getInstance();
    final current = prefs.getInt(_keyExtraCredits) ?? 0;
    await prefs.setInt(_keyExtraCredits, current + amount);
  }

  /// Get user's extra credits (purchased credits that never expire)
  Future<int> getExtraCredits() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getInt(_keyExtraCredits) ?? 0;
  }

  /// Use one extra credit (returns true if successful)
  Future<bool> useExtraCredit() async {
    final prefs = await SharedPreferences.getInstance();
    final current = prefs.getInt(_keyExtraCredits) ?? 0;
    if (current <= 0) return false;
    await prefs.setInt(_keyExtraCredits, current - 1);
    return true;
  }

  // ══════════════════════════════════════════════════════════════════════════
  // UNIFIED AI USAGE (Combines Monthly + Extra Credits for Lifetime)
  // ══════════════════════════════════════════════════════════════════════════

  /// Check if Lifetime user can use AI (monthly + extra credits)
  Future<bool> canLifetimeUserUseAi() async {
    // First check monthly credits
    final monthlyRemaining = await getRemainingMonthlyCredits(true, true);
    if (monthlyRemaining > 0) return true;

    // Then check extra credits
    final extraCredits = await getExtraCredits();
    return extraCredits > 0;
  }

  /// Use AI credit for Lifetime user (uses monthly first, then extra)
  /// Returns: 'monthly' if used monthly, 'extra' if used extra, null if none available
  Future<String?> useLifetimeAiCredit() async {
    // First try monthly credits
    final monthlyRemaining = await getRemainingMonthlyCredits(true, true);
    if (monthlyRemaining > 0) {
      await incrementMonthlyUsage();
      return 'monthly';
    }

    // Then try extra credits
    final success = await useExtraCredit();
    if (success) return 'extra';

    return null;
  }

  /// Get total available AI credits for Lifetime user (monthly + extra)
  Future<int> getTotalLifetimeCredits() async {
    final monthly = await getRemainingMonthlyCredits(true, true);
    final extra = await getExtraCredits();
    return monthly + extra;
  }

  /// Get next monthly reset date
  DateTime getNextMonthlyResetDate() {
    final now = DateTime.now();
    // Next month, 1st day
    if (now.month == 12) {
      return DateTime(now.year + 1, 1, 1);
    }
    return DateTime(now.year, now.month + 1, 1);
  }

  /// Get days until monthly reset
  int getDaysUntilMonthlyReset() {
    final resetDate = getNextMonthlyResetDate();
    return resetDate.difference(DateTime.now()).inDays;
  }

  /// Dispose resources
  void dispose() {
    _proStatusController.close();
  }
}

/// Result of a purchase operation
class PurchaseResult {
  final bool success;
  final String message;
  final bool? isPro;

  PurchaseResult({required this.success, required this.message, this.isPro});
}


--- FILE: lib/services/category_budget_service.dart ---

import 'dart:convert';
import 'package:flutter/foundation.dart';
import 'package:shared_preferences/shared_preferences.dart';
import '../models/category_budget.dart';
import '../models/expense.dart';

/// Service for managing per-category budget limits
class CategoryBudgetService {
  static const String _storageKey = 'category_budgets_v1';

  /// Get all category budgets
  Future<List<CategoryBudget>> getBudgets() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      final jsonString = prefs.getString(_storageKey);

      if (jsonString == null || jsonString.isEmpty) {
        return [];
      }

      final List<dynamic> jsonList = json.decode(jsonString) as List<dynamic>;
      return jsonList
          .map((e) => CategoryBudget.fromJson(e as Map<String, dynamic>))
          .where((b) => b.isActive)
          .toList();
    } catch (e) {
      debugPrint('Error loading category budgets: $e');
      return [];
    }
  }

  /// Get all budgets including inactive
  Future<List<CategoryBudget>> getAllBudgets() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      final jsonString = prefs.getString(_storageKey);

      if (jsonString == null || jsonString.isEmpty) {
        return [];
      }

      final List<dynamic> jsonList = json.decode(jsonString) as List<dynamic>;
      return jsonList
          .map((e) => CategoryBudget.fromJson(e as Map<String, dynamic>))
          .toList();
    } catch (e) {
      debugPrint('Error loading all category budgets: $e');
      return [];
    }
  }

  /// Save a new budget
  Future<void> saveBudget(CategoryBudget budget) async {
    final budgets = await getAllBudgets();

    // Check if budget already exists for this category
    final existingIndex = budgets.indexWhere(
      (b) => b.category == budget.category,
    );

    if (existingIndex >= 0) {
      // Update existing
      budgets[existingIndex] = budget.copyWith(updatedAt: DateTime.now());
    } else {
      // Add new
      budgets.add(budget);
    }

    await _saveBudgets(budgets);
  }

  /// Update an existing budget
  Future<void> updateBudget(CategoryBudget budget) async {
    final budgets = await getAllBudgets();
    final index = budgets.indexWhere((b) => b.id == budget.id);

    if (index >= 0) {
      budgets[index] = budget.copyWith(updatedAt: DateTime.now());
      await _saveBudgets(budgets);
    }
  }

  /// Delete a budget (soft delete - sets isActive to false)
  Future<void> deleteBudget(String id) async {
    final budgets = await getAllBudgets();
    final index = budgets.indexWhere((b) => b.id == id);

    if (index >= 0) {
      budgets[index] = budgets[index].copyWith(
        isActive: false,
        updatedAt: DateTime.now(),
      );
      await _saveBudgets(budgets);
    }
  }

  /// Hard delete a budget
  Future<void> permanentlyDeleteBudget(String id) async {
    final budgets = await getAllBudgets();
    budgets.removeWhere((b) => b.id == id);
    await _saveBudgets(budgets);
  }

  /// Get budget for a specific category
  Future<CategoryBudget?> getBudgetForCategory(String category) async {
    final budgets = await getBudgets();
    try {
      return budgets.firstWhere((b) => b.category == category);
    } catch (_) {
      return null;
    }
  }

  /// Calculate spent amount for a category in a specific month
  double calculateSpentAmount(
    List<Expense> expenses,
    String category,
    int month,
    int year,
  ) {
    return expenses
        .where(
          (e) =>
              e.category == category &&
              e.date.month == month &&
              e.date.year == year &&
              e.decision == ExpenseDecision.yes,
        )
        .fold(0.0, (sum, e) => sum + e.amount);
  }

  /// Get all budgets with calculated spent amounts
  Future<List<CategoryBudgetWithSpent>> getBudgetsWithSpent(
    List<Expense> expenses,
    int month,
    int year,
  ) async {
    final budgets = await getBudgets();

    return budgets.map((budget) {
      final spent = calculateSpentAmount(
        expenses,
        budget.category,
        month,
        year,
      );
      return CategoryBudgetWithSpent(
        budget: budget,
        spent: spent,
        month: month,
        year: year,
      );
    }).toList();
  }

  /// Get budgets that are over limit
  Future<List<CategoryBudgetWithSpent>> getOverBudgetCategories(
    List<Expense> expenses,
    int month,
    int year,
  ) async {
    final budgetsWithSpent = await getBudgetsWithSpent(expenses, month, year);
    return budgetsWithSpent.where((b) => b.isOverBudget).toList();
  }

  /// Get budgets near limit (80%+)
  Future<List<CategoryBudgetWithSpent>> getNearLimitCategories(
    List<Expense> expenses,
    int month,
    int year,
  ) async {
    final budgetsWithSpent = await getBudgetsWithSpent(expenses, month, year);
    return budgetsWithSpent.where((b) => b.isNearLimit).toList();
  }

  /// Get budgets that need attention (80%+)
  Future<List<CategoryBudgetWithSpent>> getWarningBudgets(
    List<Expense> expenses,
    int month,
    int year,
  ) async {
    final budgetsWithSpent = await getBudgetsWithSpent(expenses, month, year);
    return budgetsWithSpent.where((b) => b.percentUsed >= 80).toList()
      ..sort((a, b) => b.percentUsed.compareTo(a.percentUsed));
  }

  /// Check if adding an expense would exceed budget
  Future<BudgetCheckResult> checkBudgetOnExpense(
    List<Expense> expenses,
    String category,
    double amount,
    int month,
    int year,
  ) async {
    final budget = await getBudgetForCategory(category);
    if (budget == null) {
      return BudgetCheckResult(
        hasBudget: false,
        budget: null,
        currentSpent: 0,
        newSpent: amount,
        wouldExceed: false,
        wouldBeNearLimit: false,
      );
    }

    final currentSpent = calculateSpentAmount(expenses, category, month, year);
    final newSpent = currentSpent + amount;
    final newPercent = newSpent / budget.monthlyLimit * 100;

    return BudgetCheckResult(
      hasBudget: true,
      budget: budget,
      currentSpent: currentSpent,
      newSpent: newSpent,
      wouldExceed: newSpent > budget.monthlyLimit,
      wouldBeNearLimit: newPercent >= 80 && newSpent <= budget.monthlyLimit,
    );
  }

  /// Get summary stats
  Future<BudgetSummary> getSummary(
    List<Expense> expenses,
    int month,
    int year,
  ) async {
    final budgetsWithSpent = await getBudgetsWithSpent(expenses, month, year);

    if (budgetsWithSpent.isEmpty) {
      return BudgetSummary(
        totalBudget: 0,
        totalSpent: 0,
        categoriesOnTrack: 0,
        categoriesNearLimit: 0,
        categoriesOverBudget: 0,
        totalCategories: 0,
      );
    }

    return BudgetSummary(
      totalBudget: budgetsWithSpent.fold(
        0.0,
        (sum, b) => sum + b.budget.monthlyLimit,
      ),
      totalSpent: budgetsWithSpent.fold(0.0, (sum, b) => sum + b.spent),
      categoriesOnTrack: budgetsWithSpent.where((b) => b.isOnTrack).length,
      categoriesNearLimit: budgetsWithSpent.where((b) => b.isNearLimit).length,
      categoriesOverBudget: budgetsWithSpent
          .where((b) => b.isOverBudget)
          .length,
      totalCategories: budgetsWithSpent.length,
    );
  }

  // Private helper to save budgets
  Future<void> _saveBudgets(List<CategoryBudget> budgets) async {
    final prefs = await SharedPreferences.getInstance();
    final jsonString = json.encode(budgets.map((b) => b.toJson()).toList());
    await prefs.setString(_storageKey, jsonString);
  }
}

/// Result of checking if expense would affect budget
class BudgetCheckResult {
  final bool hasBudget;
  final CategoryBudget? budget;
  final double currentSpent;
  final double newSpent;
  final bool wouldExceed;
  final bool wouldBeNearLimit;

  BudgetCheckResult({
    required this.hasBudget,
    required this.budget,
    required this.currentSpent,
    required this.newSpent,
    required this.wouldExceed,
    required this.wouldBeNearLimit,
  });

  double get percentAfter =>
      budget != null ? (newSpent / budget!.monthlyLimit * 100) : 0;

  double get amountOver =>
      wouldExceed && budget != null ? newSpent - budget!.monthlyLimit : 0;
}

/// Budget summary statistics
class BudgetSummary {
  final double totalBudget;
  final double totalSpent;
  final int categoriesOnTrack;
  final int categoriesNearLimit;
  final int categoriesOverBudget;
  final int totalCategories;

  BudgetSummary({
    required this.totalBudget,
    required this.totalSpent,
    required this.categoriesOnTrack,
    required this.categoriesNearLimit,
    required this.categoriesOverBudget,
    required this.totalCategories,
  });

  double get totalRemaining => totalBudget - totalSpent;
  double get overallPercentUsed =>
      totalBudget > 0 ? (totalSpent / totalBudget * 100) : 0;
  bool get hasWarnings => categoriesNearLimit > 0 || categoriesOverBudget > 0;
}


--- FILE: lib/services/insight_service.dart ---

import 'package:flutter/material.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';

class InsightService {
  String getExpenseInsight(BuildContext context, ExpenseResult result) {
    final l10n = AppLocalizations.of(context);
    final hours = result.hoursRequired;
    final days = result.daysRequired;

    if (hours < 1) {
      final minutes = (hours * 60).round();
      return l10n.insightMinutes(minutes);
    } else if (hours < 8) {
      return l10n.insightHours(hours.toStringAsFixed(1));
    } else if (days < 1) {
      return l10n.insightAlmostDay;
    } else if (days < 5) {
      return l10n.insightDays(days.toStringAsFixed(1));
    } else if (days < 20) {
      return l10n.insightDaysWorked(days.toStringAsFixed(0));
    } else {
      return l10n.insightAlmostMonth;
    }
  }

  String? getCategoryInsight(
    BuildContext context,
    List<Expense> expenses,
    String category,
    int month,
    int year,
  ) {
    final l10n = AppLocalizations.of(context);
    final categoryExpenses = expenses
        .where(
          (e) =>
              e.category == category &&
              e.date.month == month &&
              e.date.year == year,
        )
        .toList();

    if (categoryExpenses.length < 2) return null;

    final totalHours = categoryExpenses.fold<double>(
      0,
      (sum, e) => sum + e.hoursRequired,
    );
    final totalDays = categoryExpenses.fold<double>(
      0,
      (sum, e) => sum + e.daysRequired,
    );

    if (totalDays >= 1) {
      return l10n.insightCategoryDays(category, totalDays.toStringAsFixed(1));
    } else {
      return l10n.insightCategoryHours(category, totalHours.toStringAsFixed(1));
    }
  }

  String? getMonthlyInsight(
    BuildContext context,
    List<Expense> expenses,
    int month,
    int year,
  ) {
    final l10n = AppLocalizations.of(context);
    final monthExpenses = expenses
        .where((e) => e.date.month == month && e.date.year == year)
        .toList();

    if (monthExpenses.isEmpty) return null;

    final totalDays = monthExpenses.fold<double>(
      0,
      (sum, e) => sum + e.daysRequired,
    );

    if (totalDays >= 20) {
      return l10n.insightMonthlyAlmost;
    } else if (totalDays >= 10) {
      return l10n.insightMonthlyDays(totalDays.toStringAsFixed(0));
    }

    return null;
  }
}


--- FILE: lib/services/siri_service.dart ---

import 'dart:io';
import 'package:flutter/foundation.dart';
import 'package:flutter/services.dart';

/// Service for iOS Siri Shortcuts integration
/// Handles shortcut donations and Spotlight indexing
class SiriService {
  static final SiriService _instance = SiriService._();
  factory SiriService() => _instance;
  SiriService._();

  /// Method channel for native iOS communication
  static const _channel = MethodChannel('com.vantag.app/siri');

  /// Check if Siri is available (iOS only)
  bool get isAvailable => Platform.isIOS;

  /// Setup Siri shortcuts on app launch
  Future<void> setupShortcuts() async {
    if (!isAvailable) return;

    try {
      await _channel.invokeMethod('setupShortcuts');
    } on PlatformException catch (e) {
      // Siri not available or not configured
      debugPrint('[Siri] Setup failed: ${e.message}');
    }
  }

  /// Donate an "Add Expense" shortcut to Siri
  /// This teaches Siri about user patterns
  Future<void> donateAddExpense({
    required double amount,
    required String category,
    required String description,
  }) async {
    if (!isAvailable) return;

    try {
      await _channel.invokeMethod('donateAddExpense', {
        'amount': amount,
        'category': category,
        'description': description,
        'timestamp': DateTime.now().toIso8601String(),
      });
    } on PlatformException catch (e) {
      debugPrint('[Siri] Donation failed: ${e.message}');
    }
  }

  /// Donate a "View Summary" shortcut
  Future<void> donateViewSummary() async {
    if (!isAvailable) return;

    try {
      await _channel.invokeMethod('donateViewSummary');
    } on PlatformException catch (e) {
      debugPrint('[Siri] Donation failed: ${e.message}');
    }
  }

  /// Index content for Spotlight search
  Future<void> indexForSpotlight({
    required String title,
    required String description,
    String? category,
  }) async {
    if (!isAvailable) return;

    try {
      await _channel.invokeMethod('indexSpotlight', {
        'title': title,
        'description': description,
        'category': category,
      });
    } on PlatformException catch (e) {
      debugPrint('[Siri] Spotlight indexing failed: ${e.message}');
    }
  }

  /// Remove all donated shortcuts
  Future<void> clearDonations() async {
    if (!isAvailable) return;

    try {
      await _channel.invokeMethod('clearDonations');
    } on PlatformException catch (e) {
      debugPrint('[Siri] Clear donations failed: ${e.message}');
    }
  }

  /// Present the "Add to Siri" button for a specific action
  Future<void> presentAddToSiri({
    required String actionType,
    required String title,
    required String suggestedPhrase,
  }) async {
    if (!isAvailable) return;

    try {
      await _channel.invokeMethod('presentAddToSiri', {
        'actionType': actionType,
        'title': title,
        'suggestedPhrase': suggestedPhrase,
      });
    } on PlatformException catch (e) {
      debugPrint('[Siri] Present Add to Siri failed: ${e.message}');
    }
  }
}

/// iOS Native Code Reference (Swift)
/// Add to ios/Runner/AppDelegate.swift:
///
/// ```swift
/// import UIKit
/// import Flutter
/// import Intents
/// import CoreSpotlight
///
/// @UIApplicationMain
/// @objc class AppDelegate: FlutterAppDelegate {
///   override func application(
///     _ application: UIApplication,
///     didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?
///   ) -> Bool {
///     let controller = window?.rootViewController as! FlutterViewController
///     let siriChannel = FlutterMethodChannel(name: "com.vantag.app/siri",
///                                            binaryMessenger: controller.binaryMessenger)
///
///     siriChannel.setMethodCallHandler { [weak self] (call, result) in
///       switch call.method {
///       case "setupShortcuts":
///         self?.setupShortcuts()
///         result(nil)
///
///       case "donateAddExpense":
///         if let args = call.arguments as? [String: Any] {
///           self?.donateAddExpense(args: args)
///         }
///         result(nil)
///
///       case "donateViewSummary":
///         self?.donateViewSummary()
///         result(nil)
///
///       case "clearDonations":
///         INInteraction.deleteAll { _ in }
///         result(nil)
///
///       default:
///         result(FlutterMethodNotImplemented)
///       }
///     }
///
///     GeneratedPluginRegistrant.register(with: self)
///     return super.application(application, didFinishLaunchingWithOptions: launchOptions)
///   }
///
///   func setupShortcuts() {
///     // Setup default shortcuts
///   }
///
///   func donateAddExpense(args: [String: Any]) {
///     let activity = NSUserActivity(activityType: "com.vantag.app.addExpense")
///     activity.title = "Vantag'a Harcama Ekle"
///     activity.isEligibleForSearch = true
///     activity.isEligibleForPrediction = true
///     activity.suggestedInvocationPhrase = "Vantag harcama ekle"
///     activity.userInfo = args
///
///     if let amount = args["amount"] as? Double,
///        let category = args["category"] as? String {
///       activity.title = "\(Int(amount))₺ \(category) ekle"
///     }
///
///     activity.becomeCurrent()
///   }
///
///   func donateViewSummary() {
///     let activity = NSUserActivity(activityType: "com.vantag.app.viewSummary")
///     activity.title = "Vantag Özetini Gör"
///     activity.isEligibleForSearch = true
///     activity.isEligibleForPrediction = true
///     activity.suggestedInvocationPhrase = "Vantag özeti"
///     activity.becomeCurrent()
///   }
/// }
/// ```


--- FILE: lib/services/subscription_manager.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:vantag/theme/app_theme.dart';
import '../models/models.dart';
import 'subscription_service.dart';
import 'profile_service.dart';

/// Abonelik yönetim singleton'ı
/// İstatistik hesaplama, iş günü karşılığı, takvim desteği
class SubscriptionManager {
  static final SubscriptionManager _instance = SubscriptionManager._internal();
  factory SubscriptionManager() => _instance;
  SubscriptionManager._internal();

  final _subscriptionService = SubscriptionService();
  final _profileService = ProfileService();

  // Cache
  UserProfile? _cachedProfile;
  List<Subscription>? _cachedSubscriptions;
  DateTime? _lastCacheTime;
  static const _cacheValidityMinutes = 5;

  /// Cache'i temizle
  void clearCache() {
    _cachedProfile = null;
    _cachedSubscriptions = null;
    _lastCacheTime = null;
  }

  /// Cache geçerli mi?
  bool get _isCacheValid {
    if (_lastCacheTime == null) return false;
    return DateTime.now().difference(_lastCacheTime!).inMinutes <
        _cacheValidityMinutes;
  }

  /// Profil ve abonelikleri yükle (cache'li)
  Future<void> _ensureLoaded() async {
    if (_isCacheValid &&
        _cachedProfile != null &&
        _cachedSubscriptions != null) {
      return;
    }

    _cachedProfile = await _profileService.getProfile();
    _cachedSubscriptions = await _subscriptionService.getSubscriptions();
    _lastCacheTime = DateTime.now();
  }

  /// Tüm aktif abonelikleri getir
  Future<List<Subscription>> getActiveSubscriptions() async {
    await _ensureLoaded();
    return _cachedSubscriptions?.where((s) => s.isActive).toList() ?? [];
  }

  /// Aktif abonelik sayısı
  Future<int> getActiveCount() async {
    final active = await getActiveSubscriptions();
    return active.length;
  }

  /// Toplam aylık abonelik tutarı
  Future<double> getTotalMonthlyCost() async {
    final active = await getActiveSubscriptions();
    return active.fold<double>(0, (sum, s) => sum + s.amount);
  }

  /// Önümüzdeki X gün içinde yenilenecek abonelikleri getir
  Future<List<Subscription>> getUpcomingRenewals(int days) async {
    final active = await getActiveSubscriptions();
    return active.where((s) => s.daysUntilRenewal <= days).toList()
      ..sort((a, b) => a.daysUntilRenewal.compareTo(b.daysUntilRenewal));
  }

  /// Bugün yenilenecek abonelikleri getir
  Future<List<Subscription>> getTodayRenewals() async {
    final active = await getActiveSubscriptions();
    return active.where((s) => s.isRenewalToday).toList();
  }

  /// Yarın yenilenecek abonelikleri getir
  Future<List<Subscription>> getTomorrowRenewals() async {
    final active = await getActiveSubscriptions();
    return active.where((s) => s.isRenewalTomorrow).toList();
  }

  /// Belirli bir ay için abonelikleri gün bazında grupla (takvim görünümü için)
  /// Key: Ayın günü (1-31), Value: O gün yenilenen abonelikler
  Future<Map<int, List<Subscription>>> getSubscriptionsByDay(
    int year,
    int month,
  ) async {
    final active = await getActiveSubscriptions();
    final Map<int, List<Subscription>> result = {};

    for (final sub in active) {
      final renewalDay = sub.getRenewalDayForMonth(year, month);
      result.putIfAbsent(renewalDay, () => []).add(sub);
    }

    return result;
  }

  /// Bir abonelik için gereken iş günü sayısını hesapla
  Future<double> calculateWorkDays(double amount) async {
    await _ensureLoaded();
    if (_cachedProfile == null || _cachedProfile!.monthlyIncome <= 0) {
      return 0;
    }

    final profile = _cachedProfile!;

    // Aylık çalışma saati: workDaysPerWeek * 4.33 * dailyHours
    final monthlyWorkHours =
        profile.workDaysPerWeek * 4.33 * profile.dailyHours;
    if (monthlyWorkHours <= 0) return 0;

    // Saatlik ücret
    final hourlyRate = profile.monthlyIncome / monthlyWorkHours;
    if (hourlyRate <= 0) return 0;

    // Abonelik için gereken saat
    final hoursNeeded = amount / hourlyRate;

    // İş günü = saat / günlük çalışma saati
    return hoursNeeded / profile.dailyHours;
  }

  /// Bir abonelik için gereken iş saati
  Future<double> calculateWorkHours(double amount) async {
    await _ensureLoaded();
    if (_cachedProfile == null || _cachedProfile!.monthlyIncome <= 0) {
      return 0;
    }

    final profile = _cachedProfile!;

    final monthlyWorkHours =
        profile.workDaysPerWeek * 4.33 * profile.dailyHours;
    if (monthlyWorkHours <= 0) return 0;

    final hourlyRate = profile.monthlyIncome / monthlyWorkHours;
    if (hourlyRate <= 0) return 0;

    return amount / hourlyRate;
  }

  /// Toplam abonelikler için gereken aylık iş günü
  Future<double> calculateTotalMonthlyWorkDays() async {
    final total = await getTotalMonthlyCost();
    return calculateWorkDays(total);
  }

  /// Abonelik istatistikleri
  Future<SubscriptionStats> getStats() async {
    final active = await getActiveSubscriptions();
    final totalCost = await getTotalMonthlyCost();
    final workDays = await calculateTotalMonthlyWorkDays();
    final todayRenewals = await getTodayRenewals();
    final tomorrowRenewals = await getTomorrowRenewals();

    return SubscriptionStats(
      totalCount: active.length,
      totalMonthlyCost: totalCost,
      totalWorkDays: workDays,
      renewingTodayCount: todayRenewals.length,
      renewingTomorrowCount: tomorrowRenewals.length,
    );
  }

  /// Sonraki kullanılabilir renk indeksini döndür (round-robin)
  Future<int> getNextColorIndex() async {
    final active = await getActiveSubscriptions();
    if (active.isEmpty) return 0;

    // Mevcut renkleri say
    final colorCounts = <int, int>{};
    for (final sub in active) {
      colorCounts[sub.colorIndex] = (colorCounts[sub.colorIndex] ?? 0) + 1;
    }

    // En az kullanılan rengi bul
    int minCount = 999;
    int minIndex = 0;
    for (int i = 0; i < SubscriptionColors.count; i++) {
      final count = colorCounts[i] ?? 0;
      if (count < minCount) {
        minCount = count;
        minIndex = i;
      }
    }

    return minIndex;
  }
}

/// Abonelik istatistikleri
class SubscriptionStats {
  final int totalCount;
  final double totalMonthlyCost;
  final double totalWorkDays;
  final int renewingTodayCount;
  final int renewingTomorrowCount;

  const SubscriptionStats({
    required this.totalCount,
    required this.totalMonthlyCost,
    required this.totalWorkDays,
    required this.renewingTodayCount,
    required this.renewingTomorrowCount,
  });

  /// Durum metni
  String get statusText {
    if (renewingTodayCount > 0) {
      return 'Bugün $renewingTodayCount abonelik yenileniyor';
    }
    if (renewingTomorrowCount > 0) {
      return 'Yarın $renewingTomorrowCount abonelik yenileniyor';
    }
    if (totalCount > 0) {
      return '$totalCount aktif abonelik';
    }
    return 'Henüz abonelik yok';
  }

  /// Durum rengi
  Color get statusColor {
    if (renewingTodayCount > 0) {
      return AppColors.subscriptionColors[4]; // Orange
    }
    if (renewingTomorrowCount > 0) return AppColors.warning; // Yellow
    return AppColors.secondary; // Turquoise
  }

  /// Durum ikonu
  IconData get statusIcon {
    if (renewingTodayCount > 0) return CupertinoIcons.bell_fill;
    if (renewingTomorrowCount > 0) return CupertinoIcons.clock_fill;
    return CupertinoIcons.checkmark_circle_fill;
  }
}

/// Global erişim için kısayol
final subscriptionManager = SubscriptionManager();


--- FILE: lib/services/import_service.dart ---

import 'dart:io';
import 'package:csv/csv.dart';
import 'package:intl/intl.dart';
import 'merchant_learning_service.dart';

/// A parsed expense from import
class ParsedExpense {
  final DateTime date;
  final String rawDescription;
  final double amount;
  final MerchantMatch? match;
  String? selectedCategory;
  String? displayName;
  bool rememberMerchant;

  ParsedExpense({
    required this.date,
    required this.rawDescription,
    required this.amount,
    this.match,
    this.selectedCategory,
    this.displayName,
    this.rememberMerchant = true,
  });

  /// True if auto-matched with high confidence
  bool get isAutoMatched => match != null && match!.isAutoMatch;

  /// True if has a suggestion
  bool get hasSuggestion => match != null && match!.isSuggestion;

  /// True if pending review (no match or low confidence)
  bool get isPending => match == null || (!isAutoMatched && !hasSuggestion);

  /// Get the effective category (selected or from match)
  String? get effectiveCategory => selectedCategory ?? match?.category;

  /// Get the effective display name
  String? get effectiveDisplayName => displayName ?? match?.displayName;
}

/// Result of an import operation
class ImportResult {
  /// Expenses that were auto-matched (high confidence)
  final List<ParsedExpense> recognized;

  /// Expenses with suggestions (medium confidence)
  final List<ParsedExpense> suggestions;

  /// Expenses that need manual categorization
  final List<ParsedExpense> pending;

  /// Parsing errors
  final List<String> errors;

  ImportResult({
    required this.recognized,
    required this.suggestions,
    required this.pending,
    this.errors = const [],
  });

  /// Total expenses parsed
  int get totalCount => recognized.length + suggestions.length + pending.length;

  /// Count of items needing review
  int get needsReviewCount => suggestions.length + pending.length;

  /// True if all expenses were auto-matched
  bool get allRecognized => suggestions.isEmpty && pending.isEmpty;
}

/// Service for importing expenses from CSV/bank statements
class ImportService {
  final _merchantService = MerchantLearningService();

  /// Date formats to try when parsing
  static final List<DateFormat> _dateFormats = [
    DateFormat('dd/MM/yyyy'),
    DateFormat('dd.MM.yyyy'),
    DateFormat('yyyy-MM-dd'),
    DateFormat('MM/dd/yyyy'),
    DateFormat('dd-MM-yyyy'),
    DateFormat('d/M/yyyy'),
    DateFormat('d.M.yyyy'),
  ];

  /// Import expenses from a CSV file
  Future<ImportResult> importCSV(File file, String userId) async {
    // Ensure merchant cache is loaded
    await _merchantService.loadCache(userId);

    final List<ParsedExpense> recognized = [];
    final List<ParsedExpense> suggestions = [];
    final List<ParsedExpense> pending = [];
    final List<String> errors = [];

    try {
      // Read and parse CSV
      final csvString = await file.readAsString();
      final rows = const CsvToListConverter(
        eol: '\n',
        shouldParseNumbers: false,
      ).convert(csvString);

      if (rows.isEmpty) {
        errors.add('CSV file is empty');
        return ImportResult(
          recognized: recognized,
          suggestions: suggestions,
          pending: pending,
          errors: errors,
        );
      }

      // Detect column indices from header
      final header = rows.first.map((e) => e.toString().toLowerCase()).toList();
      final columnIndices = _detectColumns(header);

      if (columnIndices == null) {
        errors.add(
          'Could not detect required columns (date, description, amount)',
        );
        return ImportResult(
          recognized: recognized,
          suggestions: suggestions,
          pending: pending,
          errors: errors,
        );
      }

      // Parse data rows (skip header)
      for (var i = 1; i < rows.length; i++) {
        final row = rows[i];

        try {
          // Skip empty rows
          if (row.isEmpty ||
              row.every((cell) => cell.toString().trim().isEmpty)) {
            continue;
          }

          final date = _parseDate(row[columnIndices.dateIndex].toString());
          final description = row[columnIndices.descriptionIndex]
              .toString()
              .trim();
          final amount = _parseAmount(
            row[columnIndices.amountIndex].toString(),
          );

          if (date == null ||
              amount == null ||
              amount <= 0 ||
              description.isEmpty) {
            errors.add('Row ${i + 1}: Invalid data');
            continue;
          }

          // Find merchant match
          final match = await _merchantService.findMerchant(description);

          final expense = ParsedExpense(
            date: date,
            rawDescription: description,
            amount: amount,
            match: match,
          );

          // Categorize by match confidence
          if (match == null) {
            pending.add(expense);
          } else if (match.isAutoMatch) {
            recognized.add(expense);
          } else if (match.isSuggestion) {
            suggestions.add(expense);
          } else {
            pending.add(expense);
          }
        } catch (e) {
          errors.add('Row ${i + 1}: Parse error - $e');
        }
      }
    } catch (e) {
      errors.add('Failed to read file: $e');
    }

    return ImportResult(
      recognized: recognized,
      suggestions: suggestions,
      pending: pending,
      errors: errors,
    );
  }

  /// Detect column indices from header row
  _ColumnIndices? _detectColumns(List<String> header) {
    int? dateIndex;
    int? descriptionIndex;
    int? amountIndex;

    for (var i = 0; i < header.length; i++) {
      final col = header[i].trim();

      // Date column detection
      if (dateIndex == null &&
          (col.contains('tarih') ||
              col.contains('date') ||
              col.contains('islem tarihi') ||
              col == 'gun')) {
        dateIndex = i;
      }

      // Description column detection
      if (descriptionIndex == null &&
          (col.contains('aciklama') ||
              col.contains('description') ||
              col.contains('islem') ||
              col.contains('merchant') ||
              col.contains('detay'))) {
        descriptionIndex = i;
      }

      // Amount column detection
      if (amountIndex == null &&
          (col.contains('tutar') ||
              col.contains('amount') ||
              col.contains('miktar') ||
              col.contains('borc') ||
              col.contains('harcama'))) {
        amountIndex = i;
      }
    }

    // If not detected, use common positions
    dateIndex ??= 0;
    descriptionIndex ??= 1;
    amountIndex ??= 2;

    // Ensure all within bounds
    if (dateIndex >= header.length ||
        descriptionIndex >= header.length ||
        amountIndex >= header.length) {
      return null;
    }

    return _ColumnIndices(
      dateIndex: dateIndex,
      descriptionIndex: descriptionIndex,
      amountIndex: amountIndex,
    );
  }

  /// Parse date from various formats
  DateTime? _parseDate(String value) {
    final cleaned = value.trim();
    if (cleaned.isEmpty) return null;

    for (final format in _dateFormats) {
      try {
        return format.parseStrict(cleaned);
      } catch (_) {
        continue;
      }
    }

    // Try parsing as timestamp
    final timestamp = int.tryParse(cleaned);
    if (timestamp != null) {
      return DateTime.fromMillisecondsSinceEpoch(timestamp);
    }

    return null;
  }

  /// Parse amount from string
  double? _parseAmount(String value) {
    // Clean the string
    String cleaned = value
        .trim()
        .replaceAll(RegExp(r'[^\d.,\-]'), '') // Remove non-numeric except . , -
        .replaceAll(' ', '');

    if (cleaned.isEmpty) return null;

    // Handle Turkish format (1.234,56) vs US format (1,234.56)
    if (cleaned.contains(',')) {
      // If both . and , exist, determine format
      if (cleaned.contains('.')) {
        // Check which is the decimal separator
        final lastComma = cleaned.lastIndexOf(',');
        final lastDot = cleaned.lastIndexOf('.');

        if (lastComma > lastDot) {
          // Turkish format: 1.234,56
          cleaned = cleaned.replaceAll('.', '').replaceAll(',', '.');
        } else {
          // US format: 1,234.56
          cleaned = cleaned.replaceAll(',', '');
        }
      } else {
        // Only comma: assume decimal separator (Turkish)
        cleaned = cleaned.replaceAll(',', '.');
      }
    }

    final amount = double.tryParse(cleaned);

    // Return absolute value (expenses are positive)
    return amount?.abs();
  }

  /// Import from plain text (manual paste)
  Future<ImportResult> importText(String text, String userId) async {
    await _merchantService.loadCache(userId);

    final List<ParsedExpense> recognized = [];
    final List<ParsedExpense> suggestions = [];
    final List<ParsedExpense> pending = [];
    final List<String> errors = [];

    final lines = text.split('\n').where((l) => l.trim().isNotEmpty);

    for (final line in lines) {
      // Try to extract amount from line
      final amountMatch = RegExp(r'[\d.,]+').allMatches(line);
      if (amountMatch.isEmpty) continue;

      // Take the largest number as amount
      double? amount;
      for (final m in amountMatch) {
        final parsed = _parseAmount(m.group(0) ?? '');
        if (parsed != null && (amount == null || parsed > amount)) {
          amount = parsed;
        }
      }

      if (amount == null || amount <= 0) continue;

      // Remove amount from description
      final description = line.replaceAll(RegExp(r'[\d.,]+'), '').trim();
      if (description.isEmpty) continue;

      final match = await _merchantService.findMerchant(description);

      final expense = ParsedExpense(
        date: DateTime.now(),
        rawDescription: description,
        amount: amount,
        match: match,
      );

      if (match == null) {
        pending.add(expense);
      } else if (match.isAutoMatch) {
        recognized.add(expense);
      } else if (match.isSuggestion) {
        suggestions.add(expense);
      } else {
        pending.add(expense);
      }
    }

    return ImportResult(
      recognized: recognized,
      suggestions: suggestions,
      pending: pending,
      errors: errors,
    );
  }
}

class _ColumnIndices {
  final int dateIndex;
  final int descriptionIndex;
  final int amountIndex;

  _ColumnIndices({
    required this.dateIndex,
    required this.descriptionIndex,
    required this.amountIndex,
  });
}


--- FILE: lib/services/expense_history_service.dart ---

import 'dart:async';
import 'package:flutter/foundation.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import '../models/models.dart';

class ExpenseHistoryService {
  static const _keyExpenses = 'expense_history';
  static const int maxLocalExpenses = 100;

  // Firestore referansı
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final FirebaseAuth _auth = FirebaseAuth.instance;

  // Future chain pattern - race condition olmadan sıralı çalışma
  static Future<void> _chain = Future.value();

  /// Kullanıcının UID'sini al (anonymous auth)
  String? get _userId => _auth.currentUser?.uid;

  /// Firestore expenses collection referansı
  CollectionReference<Map<String, dynamic>>? get _expensesCollection {
    final uid = _userId;
    if (uid == null) {
      debugPrint("⚠️ [Firestore] Kullanıcı UID null - Auth yapılmamış!");
      return null;
    }
    return _firestore.collection('users').doc(uid).collection('expenses');
  }

  /// Expense için unique ID oluştur (Firestore document ID)
  String _generateExpenseId(Expense expense) {
    return '${expense.date.millisecondsSinceEpoch}_${expense.amount.hashCode.abs()}';
  }

  /// Lock mekanizması - işlemler FIFO sırasıyla çalışır
  Future<T> _withLock<T>(Future<T> Function() operation) async {
    // Atomik: önceki zinciri al + yeni zincir oluştur (await yok = kesinti yok)
    final previous = _chain;
    final completer = Completer<void>();
    _chain = completer.future;

    // Önceki işlem bitene kadar bekle
    await previous;

    try {
      return await operation();
    } finally {
      completer.complete();
    }
  }

  /// Tüm harcamaları getir (geçmiş listesi için)
  Future<List<Expense>> getAllExpenses() async {
    final prefs = await SharedPreferences.getInstance();
    final json = prefs.getString(_keyExpenses);

    if (json == null || json.isEmpty) {
      return [];
    }

    try {
      return Expense.decodeList(json);
    } catch (e) {
      // Corrupted data durumunda boş liste döndür
      return [];
    }
  }

  /// Sadece gerçek kayıtları getir (istatistikler için)
  Future<List<Expense>> getRealExpenses() async {
    final all = await getAllExpenses();
    return all.where((e) => e.isReal).toList();
  }

  /// Sadece simülasyonları getir
  Future<List<Expense>> getSimulationExpenses() async {
    final all = await getAllExpenses();
    return all.where((e) => e.isSimulation).toList();
  }

  /// Eski API uyumluluğu için (tüm harcamalar)
  Future<List<Expense>> getExpenses() async {
    return getAllExpenses();
  }

  /// Harcama ekle - hem local hem Firestore'a kaydeder
  /// Local'de max 100 tutulur, Firestore'da hepsi saklanır (Pro için)
  Future<void> addExpense(Expense expense) async {
    await _withLock(() async {
      // 1. Local'e kaydet (max 100 limit)
      final expenses = await getExpenses();
      expenses.insert(0, expense);

      // Local cache limit - en eski kayıtları sil
      if (expenses.length > maxLocalExpenses) {
        expenses.removeRange(maxLocalExpenses, expenses.length);
      }

      await _saveExpenses(expenses);

      // 2. Firestore'a kaydet (hepsi saklanır - Pro için archive)
      await _syncToFirestore(expense);
    });
  }

  /// Firestore'a tek bir expense kaydet
  Future<void> _syncToFirestore(Expense expense) async {
    final uid = _userId;
    debugPrint("🔄 [Firestore] Yazma başlıyor... UID: $uid");

    if (uid == null) {
      debugPrint(
        "❌ [Firestore] HATA: Kullanıcı giriş yapmamış! Auth kontrolü yapın.",
      );
      return;
    }

    final collection = _expensesCollection;
    if (collection == null) {
      debugPrint("❌ [Firestore] HATA: Collection referansı alınamadı!");
      return;
    }

    final docId = _generateExpenseId(expense);
    debugPrint("📝 [Firestore] Document ID: $docId");
    debugPrint("📝 [Firestore] Path: users/$uid/expenses/$docId");

    try {
      await collection.doc(docId).set({
        ...expense.toJson(),
        'createdAt': FieldValue.serverTimestamp(),
        'updatedAt': FieldValue.serverTimestamp(),
      });
      debugPrint(
        "✅ [Firestore] Yazma Başarılı! ${expense.amount} TL - ${expense.category}",
      );
    } on FirebaseException catch (e) {
      debugPrint("❌ [Firestore] Firebase Hatası!");
      debugPrint("   Code: ${e.code}");
      debugPrint("   Message: ${e.message}");
      if (e.code == 'permission-denied') {
        debugPrint(
          "   💡 ÇÖZÜM: Firebase Console > Firestore > Rules kısmını kontrol edin.",
        );
        debugPrint("   💡 Test için şu kuralları kullanın:");
        debugPrint("   rules_version = '2';");
        debugPrint("   service cloud.firestore {");
        debugPrint("     match /databases/{database}/documents {");
        debugPrint("       match /{document=**} {");
        debugPrint("         allow read, write: if true;");
        debugPrint("       }");
        debugPrint("     }");
        debugPrint("   }");
      }
    } catch (e) {
      debugPrint("❌ [Firestore] Beklenmeyen Hata: $e");
      debugPrint("   Type: ${e.runtimeType}");
    }
  }

  /// Firestore'dan bir expense sil
  Future<void> _deleteFromFirestore(Expense expense) async {
    final uid = _userId;
    if (uid == null) {
      debugPrint("⚠️ [Firestore] Silme atlandı - kullanıcı giriş yapmamış");
      return;
    }

    final collection = _expensesCollection;
    if (collection == null) return;

    final docId = _generateExpenseId(expense);
    debugPrint(
      "🗑️ [Firestore] Silme başlıyor... Path: users/$uid/expenses/$docId",
    );

    try {
      await collection.doc(docId).delete();
      debugPrint("✅ [Firestore] Silme Başarılı!");
    } on FirebaseException catch (e) {
      debugPrint("❌ [Firestore] Silme Hatası: ${e.code} - ${e.message}");
    } catch (e) {
      debugPrint("❌ [Firestore] Beklenmeyen Silme Hatası: $e");
    }
  }

  /// Firestore'da bir expense güncelle
  Future<void> _updateInFirestore(
    Expense oldExpense,
    Expense newExpense,
  ) async {
    final uid = _userId;
    if (uid == null) {
      debugPrint(
        "⚠️ [Firestore] Güncelleme atlandı - kullanıcı giriş yapmamış",
      );
      return;
    }

    final collection = _expensesCollection;
    if (collection == null) return;

    debugPrint("🔄 [Firestore] Güncelleme başlıyor...");

    try {
      // Eski document'ı sil (ID değişmiş olabilir)
      final oldDocId = _generateExpenseId(oldExpense);
      await collection.doc(oldDocId).delete();
      debugPrint("✅ [Firestore] Eski document silindi: $oldDocId");

      // Yeni document oluştur
      final newDocId = _generateExpenseId(newExpense);
      await collection.doc(newDocId).set({
        ...newExpense.toJson(),
        'createdAt': FieldValue.serverTimestamp(),
        'updatedAt': FieldValue.serverTimestamp(),
      });
      debugPrint("✅ [Firestore] Yeni document oluşturuldu: $newDocId");
    } on FirebaseException catch (e) {
      debugPrint("❌ [Firestore] Güncelleme Hatası: ${e.code} - ${e.message}");
    } catch (e) {
      debugPrint("❌ [Firestore] Beklenmeyen Güncelleme Hatası: $e");
    }
  }

  Future<void> updateExpense(int index, Expense expense) async {
    await _withLock(() async {
      final expenses = await getExpenses();
      if (index >= 0 && index < expenses.length) {
        final oldExpense = expenses[index];
        expenses[index] = expense;
        await _saveExpenses(expenses);
        debugPrint("✅ [Local] Harcama güncellendi: index=$index");

        // Firestore'da güncelle
        await _updateInFirestore(oldExpense, expense);
      }
    });
  }

  Future<void> deleteExpense(int index) async {
    await _withLock(() async {
      final expenses = await getExpenses();
      if (index >= 0 && index < expenses.length) {
        final expenseToDelete = expenses[index];
        expenses.removeAt(index);
        await _saveExpenses(expenses);
        debugPrint("✅ [Local] Harcama silindi: index=$index");

        // Firestore'dan sil
        await _deleteFromFirestore(expenseToDelete);
      }
    });
  }

  /// İstatistikleri getir (SADECE gerçek kayıtlar)
  Future<DecisionStats> getStats() async {
    final expenses = await getRealExpenses();
    return DecisionStats.fromExpenses(expenses);
  }

  Future<void> _saveExpenses(List<Expense> expenses) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(_keyExpenses, Expense.encodeList(expenses));
  }

  /// Simülasyon harcamalarını temizle (app kapatılırken çağrılır)
  Future<void> clearSimulations() async {
    await _withLock(() async {
      final expenses = await getAllExpenses();
      final simulations = expenses.where((e) => e.isSimulation).toList();

      if (simulations.isEmpty) {
        debugPrint("ℹ️ [Cleanup] Silinecek simülasyon yok");
        return;
      }

      // Local'den simülasyonları filtrele
      final realExpenses = expenses.where((e) => e.isReal).toList();
      await _saveExpenses(realExpenses);
      debugPrint("✅ [Local] ${simulations.length} simülasyon silindi");

      // Firestore'dan simülasyonları sil
      for (final sim in simulations) {
        await _deleteFromFirestore(sim);
      }
      debugPrint("✅ [Firestore] Simülasyonlar temizlendi");
    });
  }

  /// Tüm geçmişi temizle (test için)
  Future<void> clearAll() async {
    await _withLock(() async {
      final prefs = await SharedPreferences.getInstance();
      await prefs.remove(_keyExpenses);
      debugPrint("✅ [Local] Tüm veriler temizlendi");

      // Firestore'dan da temizle
      await _clearFirestore();
    });
  }

  /// Firestore'daki tüm expense'leri sil
  Future<void> _clearFirestore() async {
    final uid = _userId;
    if (uid == null) {
      debugPrint("⚠️ [Firestore] Temizleme atlandı - kullanıcı giriş yapmamış");
      return;
    }

    final collection = _expensesCollection;
    if (collection == null) return;

    debugPrint("🗑️ [Firestore] Toplu silme başlıyor...");

    try {
      final snapshots = await collection.get();
      if (snapshots.docs.isEmpty) {
        debugPrint("ℹ️ [Firestore] Silinecek document yok");
        return;
      }

      final batch = _firestore.batch();
      for (final doc in snapshots.docs) {
        batch.delete(doc.reference);
      }
      await batch.commit();
      debugPrint("✅ [Firestore] ${snapshots.docs.length} document silindi");
    } on FirebaseException catch (e) {
      debugPrint("❌ [Firestore] Toplu Silme Hatası: ${e.code} - ${e.message}");
    } catch (e) {
      debugPrint("❌ [Firestore] Beklenmeyen Toplu Silme Hatası: $e");
    }
  }

  /// Local verileri Firestore'a toplu senkronize et
  /// İlk kurulum veya migration için kullanılabilir
  Future<void> syncAllToFirestore() async {
    final uid = _userId;
    if (uid == null) {
      debugPrint("❌ [Sync] Kullanıcı giriş yapmamış - sync yapılamaz!");
      return;
    }

    final collection = _expensesCollection;
    if (collection == null) return;

    debugPrint("🔄 [Sync] Local → Firestore senkronizasyonu başlıyor...");

    try {
      final expenses = await getAllExpenses();
      if (expenses.isEmpty) {
        debugPrint("ℹ️ [Sync] Senkronize edilecek veri yok");
        return;
      }

      final batch = _firestore.batch();

      for (final expense in expenses) {
        final docId = _generateExpenseId(expense);
        batch.set(collection.doc(docId), {
          ...expense.toJson(),
          'createdAt': FieldValue.serverTimestamp(),
          'updatedAt': FieldValue.serverTimestamp(),
        });
      }

      await batch.commit();
      debugPrint("✅ [Sync] ${expenses.length} harcama Firestore'a yüklendi!");
    } on FirebaseException catch (e) {
      debugPrint("❌ [Sync] Hata: ${e.code} - ${e.message}");
    } catch (e) {
      debugPrint("❌ [Sync] Beklenmeyen Hata: $e");
    }
  }

  /// Firestore'dan local'e verileri çek (restore için)
  Future<void> syncFromFirestore() async {
    final uid = _userId;
    if (uid == null) {
      debugPrint("❌ [Sync] Kullanıcı giriş yapmamış - restore yapılamaz!");
      return;
    }

    final collection = _expensesCollection;
    if (collection == null) return;

    debugPrint("🔄 [Sync] Firestore → Local senkronizasyonu başlıyor...");

    try {
      final snapshots = await collection
          .orderBy('date', descending: true)
          .get();

      if (snapshots.docs.isEmpty) {
        debugPrint("ℹ️ [Sync] Firestore'da veri yok");
        return;
      }

      final expenses = snapshots.docs
          .map((doc) => Expense.fromJson(doc.data()))
          .toList();

      await _saveExpenses(expenses);
      debugPrint("✅ [Sync] ${expenses.length} harcama local'e indirildi!");
    } on FirebaseException catch (e) {
      debugPrint("❌ [Sync] Hata: ${e.code} - ${e.message}");
    } catch (e) {
      debugPrint("❌ [Sync] Beklenmeyen Hata: $e");
    }
  }

  /// Debug: Auth durumunu kontrol et
  void debugAuthStatus() {
    final user = _auth.currentUser;
    debugPrint("═══════════════════════════════════════");
    debugPrint("🔍 [DEBUG] Firebase Auth Durumu:");
    debugPrint("   User: ${user != null ? 'VAR' : 'YOK'}");
    debugPrint("   UID: ${user?.uid ?? 'null'}");
    debugPrint("   Anonymous: ${user?.isAnonymous ?? 'N/A'}");
    debugPrint("═══════════════════════════════════════");
  }

  /// Debug: Firestore bağlantısını test et
  Future<void> debugFirestoreConnection() async {
    debugPrint("═══════════════════════════════════════");
    debugPrint("🔍 [DEBUG] Firestore Bağlantı Testi:");

    final uid = _userId;
    if (uid == null) {
      debugPrint("   ❌ Auth yapılmamış - test edilemiyor");
      debugPrint("═══════════════════════════════════════");
      return;
    }

    debugPrint("   UID: $uid");
    debugPrint("   Path: users/$uid/expenses");

    try {
      // Basit bir test yazması yap
      final testDoc = _firestore
          .collection('users')
          .doc(uid)
          .collection('_test')
          .doc('connection');
      await testDoc.set({
        'test': true,
        'timestamp': FieldValue.serverTimestamp(),
      });
      debugPrint("   ✅ Yazma testi başarılı!");

      // Test verisini sil
      await testDoc.delete();
      debugPrint("   ✅ Silme testi başarılı!");
      debugPrint("   🎉 Firestore bağlantısı çalışıyor!");
    } on FirebaseException catch (e) {
      debugPrint("   ❌ Firestore Hatası: ${e.code}");
      debugPrint("   Message: ${e.message}");
    } catch (e) {
      debugPrint("   ❌ Beklenmeyen Hata: $e");
    }
    debugPrint("═══════════════════════════════════════");
  }

  // ============================================
  // PRO USERS: ARŞİVLENMİŞ VERİLERE ERİŞİM
  // ============================================

  /// Firestore'dan tüm expense sayısını getir
  Future<int> getTotalExpenseCount() async {
    final collection = _expensesCollection;
    if (collection == null) return 0;

    try {
      final snapshot = await collection.count().get();
      return snapshot.count ?? 0;
    } catch (e) {
      return 0;
    }
  }

  /// Firestore'dan arşivlenmiş expense'leri getir (Pro kullanıcılar için)
  /// [offset]: Atlanacak kayıt sayısı (pagination için)
  /// [limit]: Getirilecek kayıt sayısı
  Future<List<Expense>> fetchArchivedExpenses({
    int offset = 0,
    int limit = 50,
  }) async {
    final collection = _expensesCollection;
    if (collection == null) {
      return [];
    }

    try {
      Query<Map<String, dynamic>> query = collection.orderBy(
        'date',
        descending: true,
      );

      // Offset için: önce offset kadar kayıt atla
      if (offset > 0) {
        final skipDocs = await query.limit(offset).get();
        if (skipDocs.docs.isNotEmpty) {
          final lastDoc = skipDocs.docs.last;
          query = query.startAfterDocument(lastDoc);
        }
      }

      final snapshots = await query.limit(limit).get();

      return snapshots.docs.map((doc) => Expense.fromJson(doc.data())).toList();
    } on FirebaseException catch (e) {
      debugPrint(
        "❌ [Firestore] Archive Fetch Hatası: ${e.code} - ${e.message}",
      );
      return [];
    } catch (e) {
      debugPrint("❌ [Firestore] Beklenmeyen Archive Fetch Hatası: $e");
      return [];
    }
  }

  /// Firestore'dan TÜM expense'leri getir (Pro export için)
  Future<List<Expense>> fetchAllExpensesFromFirestore() async {
    final collection = _expensesCollection;
    if (collection == null) {
      return [];
    }

    try {
      final snapshots = await collection
          .orderBy('date', descending: true)
          .get();

      return snapshots.docs.map((doc) => Expense.fromJson(doc.data())).toList();
    } catch (e) {
      return [];
    }
  }
}


--- FILE: lib/services/live_activity_service.dart ---

import 'dart:io';
import 'package:flutter/services.dart';

/// Service to manage iOS Live Activities and Dynamic Island
class LiveActivityService {
  static const _channel = MethodChannel('com.vantag.app/live_activity');

  static LiveActivityService? _instance;
  static LiveActivityService get instance => _instance ??= LiveActivityService._();

  LiveActivityService._();

  bool _isActivityRunning = false;
  String? _currentActivityId;

  bool get isActivityRunning => _isActivityRunning;

  /// Start a new Live Activity
  Future<bool> startActivity({
    required int streakDays,
    required double todaySpent,
    required double dailyBudget,
    required String currencySymbol,
    required String formattedTime,
    required String spendingLevel,
  }) async {
    if (!Platform.isIOS) return false;

    try {
      final result = await _channel.invokeMethod<Map>('startActivity', {
        'streakDays': streakDays,
        'todaySpent': todaySpent,
        'dailyBudget': dailyBudget,
        'currencySymbol': currencySymbol,
        'formattedTime': formattedTime,
        'spendingLevel': spendingLevel,
      });

      if (result != null && result['success'] == true) {
        _isActivityRunning = true;
        _currentActivityId = result['activityId'] as String?;
        return true;
      }
      return false;
    } on PlatformException catch (e) {
      print('[LiveActivity] Start error: ${e.message}');
      return false;
    } on MissingPluginException {
      print('[LiveActivity] Not available on this device');
      return false;
    }
  }

  /// Update the current Live Activity
  Future<bool> updateActivity({
    required int streakDays,
    required double todaySpent,
    required double dailyBudget,
    required String currencySymbol,
    required String formattedTime,
    required String spendingLevel,
  }) async {
    if (!Platform.isIOS || !_isActivityRunning) return false;

    try {
      final result = await _channel.invokeMethod<bool>('updateActivity', {
        'activityId': _currentActivityId,
        'streakDays': streakDays,
        'todaySpent': todaySpent,
        'dailyBudget': dailyBudget,
        'currencySymbol': currencySymbol,
        'formattedTime': formattedTime,
        'spendingLevel': spendingLevel,
      });

      return result ?? false;
    } on PlatformException catch (e) {
      print('[LiveActivity] Update error: ${e.message}');
      return false;
    }
  }

  /// End the current Live Activity
  Future<bool> endActivity() async {
    if (!Platform.isIOS || !_isActivityRunning) return false;

    try {
      final result = await _channel.invokeMethod<bool>('endActivity', {
        'activityId': _currentActivityId,
      });

      if (result == true) {
        _isActivityRunning = false;
        _currentActivityId = null;
      }
      return result ?? false;
    } on PlatformException catch (e) {
      print('[LiveActivity] End error: ${e.message}');
      return false;
    }
  }

  /// Check if Live Activities are supported
  Future<bool> areActivitiesSupported() async {
    if (!Platform.isIOS) return false;

    try {
      final result = await _channel.invokeMethod<bool>('areActivitiesSupported');
      return result ?? false;
    } on PlatformException {
      return false;
    } on MissingPluginException {
      return false;
    }
  }

  /// Get spending level based on percentage of daily budget used
  static String getSpendingLevel(double todaySpent, double dailyBudget) {
    if (dailyBudget <= 0) return 'low';

    final percentage = todaySpent / dailyBudget;
    if (percentage >= 0.8) return 'high';
    if (percentage >= 0.5) return 'medium';
    return 'low';
  }
}


--- FILE: lib/services/reengagement_service.dart ---

import 'dart:async';
import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:vantag/l10n/app_localizations.dart';
import 'package:vantag/services/analytics_service.dart';
import 'package:vantag/services/push_notification_service.dart';

/// Re-engagement service for stalled users
/// Detects inactive users and triggers recovery mechanisms
class ReengagementService {
  static final ReengagementService _instance = ReengagementService._internal();
  factory ReengagementService() => _instance;
  ReengagementService._internal();

  // Storage keys
  static const String _keyLastActiveDate = 'reengagement_last_active';
  static const String _keyLastReengagementShown = 'reengagement_last_shown';
  static const String _keyReengagementCount = 'reengagement_count';
  static const String _keyWelcomeBackShown = 'reengagement_welcome_back_shown';
  static const String _keyLastPushScheduled = 'reengagement_last_push';

  // Thresholds (in days)
  static const int stalledThresholdDays = 3;
  static const int warningThresholdDays = 2;
  static const int criticalThresholdDays = 7;
  static const int dormantThresholdDays = 14;
  static const int churningThresholdDays = 30;

  /// User activity state
  UserActivityState _cachedState = UserActivityState.active;

  /// Record user activity (call on app open, expense add, etc.)
  Future<void> recordActivity() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(_keyLastActiveDate, DateTime.now().toIso8601String());
    await prefs.setBool(_keyWelcomeBackShown, false);
    _cachedState = UserActivityState.active;
  }

  /// Get last active date
  Future<DateTime?> getLastActiveDate() async {
    final prefs = await SharedPreferences.getInstance();
    final dateStr = prefs.getString(_keyLastActiveDate);
    if (dateStr == null) return null;
    return DateTime.tryParse(dateStr);
  }

  /// Get days since last activity
  Future<int> getDaysSinceLastActivity() async {
    final lastActive = await getLastActiveDate();
    if (lastActive == null) return 0;
    return DateTime.now().difference(lastActive).inDays;
  }

  /// Check if user is stalled
  Future<bool> isUserStalled({int? customThreshold}) async {
    final days = await getDaysSinceLastActivity();
    return days >= (customThreshold ?? stalledThresholdDays);
  }

  /// Get user activity state
  Future<UserActivityState> getUserActivityState() async {
    final days = await getDaysSinceLastActivity();

    if (days == 0) {
      _cachedState = UserActivityState.active;
    } else if (days < warningThresholdDays) {
      _cachedState = UserActivityState.active;
    } else if (days < stalledThresholdDays) {
      _cachedState = UserActivityState.warning;
    } else if (days < criticalThresholdDays) {
      _cachedState = UserActivityState.stalled;
    } else if (days < dormantThresholdDays) {
      _cachedState = UserActivityState.critical;
    } else if (days < churningThresholdDays) {
      _cachedState = UserActivityState.dormant;
    } else {
      _cachedState = UserActivityState.churning;
    }

    return _cachedState;
  }

  /// Check if stalled and trigger appropriate actions
  Future<ReengagementResult> checkAndTriggerReengagement() async {
    final days = await getDaysSinceLastActivity();
    final state = await getUserActivityState();

    if (state == UserActivityState.active) {
      return ReengagementResult(
        state: state,
        daysSinceActive: days,
        actionTaken: ReengagementAction.none,
      );
    }

    // Log analytics
    await AnalyticsService().logEvent(
      'user_inactive',
      parameters: {
        'days_inactive': days,
        'state': state.name,
      },
    );

    // Determine action based on state
    ReengagementAction action = ReengagementAction.none;

    switch (state) {
      case UserActivityState.warning:
        // Just track, no action yet
        action = ReengagementAction.tracked;
        break;

      case UserActivityState.stalled:
        // Schedule re-engagement push
        await _scheduleReengagementPush(days);
        action = ReengagementAction.pushScheduled;
        break;

      case UserActivityState.critical:
        // More urgent push + email trigger
        await _scheduleUrgentPush(days);
        await _triggerEmailReengagement(days);
        action = ReengagementAction.urgentOutreach;
        break;

      case UserActivityState.dormant:
        // Win-back campaign
        await _triggerWinBackCampaign(days);
        action = ReengagementAction.winBackCampaign;
        break;

      case UserActivityState.churning:
        // Final attempt
        await _triggerFinalAttempt(days);
        action = ReengagementAction.finalAttempt;
        break;

      case UserActivityState.active:
        break;
    }

    return ReengagementResult(
      state: state,
      daysSinceActive: days,
      actionTaken: action,
    );
  }

  /// Schedule re-engagement push notification
  Future<void> _scheduleReengagementPush(int daysSinceActive) async {
    final prefs = await SharedPreferences.getInstance();

    // Check if we already scheduled recently
    final lastPush = prefs.getString(_keyLastPushScheduled);
    if (lastPush != null) {
      final lastPushDate = DateTime.tryParse(lastPush);
      if (lastPushDate != null) {
        final hoursSincePush = DateTime.now().difference(lastPushDate).inHours;
        if (hoursSincePush < 24) return; // Don't spam
      }
    }

    // Schedule push notification
    await PushNotificationService().scheduleReengagementNotification(
      daysSinceActive: daysSinceActive,
    );

    await prefs.setString(_keyLastPushScheduled, DateTime.now().toIso8601String());

    await AnalyticsService().logEvent(
      'reengagement_push_scheduled',
      parameters: {'days_inactive': daysSinceActive},
    );
  }

  /// Schedule urgent push for critical users
  Future<void> _scheduleUrgentPush(int daysSinceActive) async {
    await PushNotificationService().scheduleUrgentReengagementNotification(
      daysSinceActive: daysSinceActive,
    );

    await AnalyticsService().logEvent(
      'urgent_reengagement_push',
      parameters: {'days_inactive': daysSinceActive},
    );
  }

  /// Trigger email re-engagement (logs event for backend to handle)
  Future<void> _triggerEmailReengagement(int daysSinceActive) async {
    await AnalyticsService().logEvent(
      'trigger_reengagement_email',
      parameters: {
        'days_inactive': daysSinceActive,
        'email_type': 'miss_you',
      },
    );
  }

  /// Trigger win-back campaign
  Future<void> _triggerWinBackCampaign(int daysSinceActive) async {
    await AnalyticsService().logEvent(
      'trigger_win_back_campaign',
      parameters: {
        'days_inactive': daysSinceActive,
        'campaign_type': 'dormant_user',
      },
    );
  }

  /// Final attempt for churning users
  Future<void> _triggerFinalAttempt(int daysSinceActive) async {
    await AnalyticsService().logEvent(
      'trigger_final_attempt',
      parameters: {
        'days_inactive': daysSinceActive,
        'campaign_type': 'churn_prevention',
      },
    );
  }

  /// Check if welcome back should be shown
  Future<bool> shouldShowWelcomeBack() async {
    final prefs = await SharedPreferences.getInstance();
    final alreadyShown = prefs.getBool(_keyWelcomeBackShown) ?? false;
    if (alreadyShown) return false;

    final days = await getDaysSinceLastActivity();
    return days >= stalledThresholdDays;
  }

  /// Mark welcome back as shown
  Future<void> markWelcomeBackShown() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_keyWelcomeBackShown, true);

    final count = prefs.getInt(_keyReengagementCount) ?? 0;
    await prefs.setInt(_keyReengagementCount, count + 1);

    await AnalyticsService().logEvent(
      'welcome_back_shown',
      parameters: {'reengagement_count': count + 1},
    );
  }

  /// Get welcome back message based on days inactive
  WelcomeBackMessage getWelcomeBackMessage(BuildContext context, int daysSinceActive) {
    final l10n = AppLocalizations.of(context);

    if (daysSinceActive < 7) {
      return WelcomeBackMessage(
        title: l10n.welcomeBackTitle3Days,
        subtitle: l10n.welcomeBackSubtitle3Days,
        ctaText: l10n.welcomeBackCta3Days,
        icon: Icons.wb_sunny_rounded,
        color: const Color(0xFFF59E0B),
      );
    } else if (daysSinceActive < 14) {
      return WelcomeBackMessage(
        title: l10n.welcomeBackTitle7Days,
        subtitle: l10n.welcomeBackSubtitle7Days,
        ctaText: l10n.welcomeBackCta7Days,
        icon: Icons.favorite_rounded,
        color: const Color(0xFFEF4444),
      );
    } else if (daysSinceActive < 30) {
      return WelcomeBackMessage(
        title: l10n.welcomeBackTitle14Days,
        subtitle: l10n.welcomeBackSubtitle14Days,
        ctaText: l10n.welcomeBackCta14Days,
        icon: Icons.rocket_launch_rounded,
        color: const Color(0xFF6C63FF),
      );
    } else {
      return WelcomeBackMessage(
        title: l10n.welcomeBackTitle30Days,
        subtitle: l10n.welcomeBackSubtitle30Days,
        ctaText: l10n.welcomeBackCta30Days,
        icon: Icons.celebration_rounded,
        color: const Color(0xFF10B981),
      );
    }
  }

  /// Get streak recovery bonus (for gamification)
  int getStreakRecoveryBonus(int daysSinceActive) {
    // Shorter absence = higher bonus percentage retained
    if (daysSinceActive <= 3) return 75; // Keep 75% of streak
    if (daysSinceActive <= 7) return 50; // Keep 50%
    if (daysSinceActive <= 14) return 25; // Keep 25%
    return 0; // Streak reset
  }

  /// Clear all re-engagement data (for testing)
  Future<void> clearData() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.remove(_keyLastActiveDate);
    await prefs.remove(_keyLastReengagementShown);
    await prefs.remove(_keyReengagementCount);
    await prefs.remove(_keyWelcomeBackShown);
    await prefs.remove(_keyLastPushScheduled);
  }
}

/// User activity state enum
enum UserActivityState {
  active,    // 0-1 days
  warning,   // 2 days
  stalled,   // 3-6 days
  critical,  // 7-13 days
  dormant,   // 14-29 days
  churning,  // 30+ days
}

/// Re-engagement action taken
enum ReengagementAction {
  none,
  tracked,
  pushScheduled,
  urgentOutreach,
  winBackCampaign,
  finalAttempt,
}

/// Result of re-engagement check
class ReengagementResult {
  final UserActivityState state;
  final int daysSinceActive;
  final ReengagementAction actionTaken;

  const ReengagementResult({
    required this.state,
    required this.daysSinceActive,
    required this.actionTaken,
  });
}

/// Welcome back message model
class WelcomeBackMessage {
  final String title;
  final String subtitle;
  final String ctaText;
  final IconData icon;
  final Color color;

  const WelcomeBackMessage({
    required this.title,
    required this.subtitle,
    required this.ctaText,
    required this.icon,
    required this.color,
  });
}


--- FILE: lib/services/push_notification_stub.dart ---

// Stub implementation for platforms that don't support Firebase Messaging
// (Windows, macOS, Linux, Web)

typedef MessageCallback = Future<void> Function(Map<String, dynamic> message);
typedef TokenCallback = void Function(String token);

/// Stub platform implementation - does nothing
class PushNotificationPlatform {
  Future<bool> requestPermission() async => false;

  Future<String?> getToken() async => null;

  void onTokenRefresh(TokenCallback callback) {}

  void onMessage(MessageCallback callback) {}

  void onMessageOpenedApp(Function(Map<String, dynamic>) callback) {}

  Future<Map<String, dynamic>?> getInitialMessage() async => null;

  Future<void> subscribeToTopic(String topic) async {}

  Future<void> unsubscribeFromTopic(String topic) async {}

  void dispose() {}
}


--- FILE: lib/services/share_service.dart ---

import 'dart:io';
import 'dart:typed_data';
import 'dart:ui' as ui;
import 'package:flutter/material.dart';
import 'package:flutter/rendering.dart';
import 'package:path_provider/path_provider.dart';
import 'package:share_plus/share_plus.dart';
import 'referral_service.dart';
import 'deep_link_service.dart';

/// Paylaşım servisi - Widget'ları screenshot alıp paylaşır
class ShareService {
  /// Get share text with referral link if available
  static Future<String> getShareTextWithReferral({
    String? customText,
    String defaultText = 'Sen kaç gün çalışıyorsun? 👀',
  }) async {
    String shareLink = 'vantag.app';
    try {
      final referralCode = await ReferralService().getOrCreateReferralCode();
      if (referralCode != null) {
        final referralLink = DeepLinkService.generateReferralLink(referralCode);
        shareLink = referralLink.toString();
      }
    } catch (_) {
      // Use default link if referral fails
    }
    return '${customText ?? defaultText} $shareLink';
  }

  /// Widget'ı image'a çevirip paylaş
  /// [key] - RepaintBoundary'nin GlobalKey'i
  /// [shareText] - Paylaşım metni (opsiyonel, referral link otomatik eklenir)
  static Future<bool> shareWidget(GlobalKey key, {String? shareText}) async {
    try {
      // Widget'ı image'a çevir
      final boundary =
          key.currentContext?.findRenderObject() as RenderRepaintBoundary?;
      if (boundary == null) {
        return false;
      }

      // 3x scale ile yüksek kaliteli görüntü
      final ui.Image image = await boundary.toImage(pixelRatio: 3.0);

      // PNG'ye çevir
      final ByteData? byteData = await image.toByteData(
        format: ui.ImageByteFormat.png,
      );
      if (byteData == null) {
        return false;
      }

      final Uint8List pngBytes = byteData.buffer.asUint8List();

      // Temp dosyaya kaydet
      final directory = await getTemporaryDirectory();
      final timestamp = DateTime.now().millisecondsSinceEpoch;
      final filePath = '${directory.path}/vantag_share_$timestamp.png';
      final file = File(filePath);
      await file.writeAsBytes(pngBytes);

      // Get share text with referral link
      final finalShareText = shareText ?? await getShareTextWithReferral();

      // Paylaş
      await Share.shareXFiles([XFile(filePath)], text: finalShareText);

      // Temp dosyayı 5 dakika sonra sil
      Future.delayed(const Duration(minutes: 5), () {
        if (file.existsSync()) {
          try {
            file.deleteSync();
          } catch (_) {
            // Silme hatası görmezden gelinir
          }
        }
      });

      return true;
    } catch (_) {
      return false;
    }
  }

  /// Sadece metin paylaş
  static Future<void> shareText(String text) async {
    await Share.share(text);
  }

  // ============================================
  // Task 60: PURSUIT SHARING
  // ============================================

  /// Share pursuit progress
  static Future<void> sharePursuit({
    required String pursuitName,
    required double progress,
    required double savedAmount,
    required double targetAmount,
    required String currency,
  }) async {
    final progressPercent = (progress * 100).toStringAsFixed(0);
    final saved = savedAmount.toStringAsFixed(0);
    final target = targetAmount.toStringAsFixed(0);

    final text = await getShareTextWithReferral(
      customText: '$pursuitName hedefim için %$progressPercent tamamladım! '
          '($saved / $target $currency)',
    );
    await Share.share(text);
  }

  /// Share completed pursuit
  static Future<void> sharePursuitCompletion({
    required String pursuitName,
    required double targetAmount,
    required String currency,
    required int daysToComplete,
  }) async {
    final text = await getShareTextWithReferral(
      customText: '$pursuitName hedefime ulaştım! '
          '${targetAmount.toStringAsFixed(0)} $currency biriktirdim. '
          '($daysToComplete günde başardım!)',
    );
    await Share.share(text);
  }

  // ============================================
  // Task 61: ACHIEVEMENT SHARING
  // ============================================

  /// Share unlocked achievement
  static Future<void> shareAchievement({
    required String achievementTitle,
    required String achievementDescription,
    String? tier, // bronze, silver, gold, platinum
  }) async {
    final tierEmoji = switch (tier?.toLowerCase()) {
      'bronze' => '🥉',
      'silver' => '🥈',
      'gold' => '🥇',
      'platinum' => '💎',
      _ => '🏆',
    };

    final text = await getShareTextWithReferral(
      customText: '$tierEmoji $achievementTitle başarısını kazandım! '
          '$achievementDescription',
    );
    await Share.share(text);
  }

  /// Share streak milestone
  static Future<void> shareStreakMilestone({
    required int streakDays,
  }) async {
    final emoji = streakDays >= 100 ? '🔥🔥🔥' : (streakDays >= 30 ? '🔥🔥' : '🔥');

    final text = await getShareTextWithReferral(
      customText: '$emoji $streakDays gün kesintisiz finansal takip! '
          'Disiplin = Özgürlük',
    );
    await Share.share(text);
  }

  /// Share savings milestone
  static Future<void> shareSavingsMilestone({
    required double totalSaved,
    required String currency,
  }) async {
    final formatted = totalSaved >= 1000000
        ? '${(totalSaved / 1000000).toStringAsFixed(1)}M'
        : totalSaved >= 1000
            ? '${(totalSaved / 1000).toStringAsFixed(0)}K'
            : totalSaved.toStringAsFixed(0);

    final text = await getShareTextWithReferral(
      customText: '💰 Toplamda $formatted $currency biriktirdim! '
          'Küçük kararlar, büyük sonuçlar.',
    );
    await Share.share(text);
  }
}


--- FILE: lib/services/deep_link_service.dart ---

import 'dart:async';
import 'package:app_links/app_links.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:vantag/theme/app_theme.dart';
import '../models/models.dart';
import 'voice_parser_service.dart';

/// Callback for when an expense should be added
typedef OnAddExpense = Future<void> Function(Expense expense);

/// Callback for when an expense should be deleted (by index)
typedef OnDeleteExpense = Future<void> Function(int index);

/// Callback for navigation
typedef OnNavigate = void Function(String route);

/// Callback to get the current hourly rate
typedef GetHourlyRate = double Function();

/// Service for handling deep links (vantag:// scheme)
/// Supports Siri Shortcuts, Google Assistant, and direct links
class DeepLinkService {
  static final DeepLinkService _instance = DeepLinkService._();
  factory DeepLinkService() => _instance;
  DeepLinkService._();

  final _appLinks = AppLinks();
  StreamSubscription<Uri>? _linkSubscription;

  OnAddExpense? _onAddExpense;
  OnDeleteExpense? _onDeleteExpense;
  OnNavigate? _onNavigate;
  GetHourlyRate? _getHourlyRate;
  GlobalKey<NavigatorState>? _navigatorKey;

  /// Flag to auto-start voice input when app opens from deep link
  bool _shouldAutoStartVoice = false;
  bool get shouldAutoStartVoice => _shouldAutoStartVoice;
  void consumeAutoStartFlag() => _shouldAutoStartVoice = false;

  /// Pending referral code from deep link
  String? _pendingReferralCode;
  String? get pendingReferralCode => _pendingReferralCode;
  void consumePendingReferralCode() => _pendingReferralCode = null;

  /// SharedPreferences key for pending referral code
  static const String _pendingReferralKey = 'pendingReferralCode';

  /// Simple initialization with navigator key (from main.dart)
  void init(GlobalKey<NavigatorState> navigatorKey) {
    _navigatorKey = navigatorKey;
    _initLinks();
  }

  /// Set callbacks after initialization (can be called from a widget with provider access)
  void setCallbacks({
    OnAddExpense? onAddExpense,
    OnDeleteExpense? onDeleteExpense,
    OnNavigate? onNavigate,
    GetHourlyRate? getHourlyRate,
  }) {
    if (onAddExpense != null) _onAddExpense = onAddExpense;
    if (onDeleteExpense != null) _onDeleteExpense = onDeleteExpense;
    if (onNavigate != null) _onNavigate = onNavigate;
    if (getHourlyRate != null) _getHourlyRate = getHourlyRate;
  }

  /// Full initialization with callbacks
  Future<void> initWithCallbacks({
    required GlobalKey<NavigatorState> navigatorKey,
    required OnAddExpense onAddExpense,
    OnDeleteExpense? onDeleteExpense,
    OnNavigate? onNavigate,
    GetHourlyRate? getHourlyRate,
  }) async {
    _navigatorKey = navigatorKey;
    _onAddExpense = onAddExpense;
    _onDeleteExpense = onDeleteExpense;
    _onNavigate = onNavigate;
    _getHourlyRate = getHourlyRate;
    await _initLinks();
  }

  /// Initialize link listening
  Future<void> _initLinks() async {
    // Handle initial link (app opened via link)
    try {
      final initialLink = await _appLinks.getInitialLink();
      if (initialLink != null) {
        _handleDeepLink(initialLink);
      }
    } catch (e) {
      debugPrint('[DeepLink] Error getting initial link: $e');
    }

    // Listen for links while app is running
    _linkSubscription = _appLinks.uriLinkStream.listen(
      _handleDeepLink,
      onError: (e) => debugPrint('[DeepLink] Stream error: $e'),
    );
  }

  /// Dispose of resources
  void dispose() {
    _linkSubscription?.cancel();
    _linkSubscription = null;
  }

  /// Handle incoming deep link
  void _handleDeepLink(Uri uri) {
    debugPrint('[DeepLink] Received: $uri');

    // Handle HTTPS referral links (https://vantag.app/r/CODE)
    if ((uri.scheme == 'https' || uri.scheme == 'http') &&
        uri.host == 'vantag.app') {
      _handleWebDeepLink(uri);
      return;
    }

    // Validate scheme for app-specific deep links
    if (uri.scheme != 'vantag') {
      debugPrint('[DeepLink] Invalid scheme: ${uri.scheme}');
      return;
    }

    // Route based on host/path
    switch (uri.host) {
      case 'referral':
      case 'r':
        final code = uri.queryParameters['code'] ?? uri.pathSegments.lastOrNull;
        if (code != null && code.isNotEmpty) {
          _handleReferralCode(code);
        }
        break;
      case 'add-expense':
      case 'add':
      case 'expense':
        _handleAddExpense(uri);
        break;

      case 'quick-add':
        _handleQuickAdd(uri);
        break;

      case 'summary':
      case 'report':
        _handleNavigate('report');
        break;

      case 'subscriptions':
        _handleNavigate('subscriptions');
        break;

      case 'profile':
        _handleNavigate('profile');
        break;

      case 'pursuits':
      case 'pursuit':
      case 'dreams':
        _handleNavigate('pursuits');
        break;

      case 'settings':
        _handleNavigate('settings');
        break;

      case 'achievements':
      case 'badges':
        _handleNavigate('achievements');
        break;

      case 'paywall':
      case 'premium':
      case 'pro':
        _handleNavigate('paywall');
        break;

      case 'habit-calculator':
      case 'calculator':
        _handleNavigate('habit-calculator');
        break;

      case 'share':
        _handleShare(uri);
        break;

      default:
        debugPrint('[DeepLink] Unknown route: ${uri.host}');
    }
  }

  /// Handle add-expense deep link
  /// URL format: vantag://add-expense?amount=50&category=food&description=kahve
  void _handleAddExpense(Uri uri) async {
    final params = uri.queryParameters;

    // Parse amount
    final amountStr = params['amount'];
    double? amount;
    if (amountStr != null) {
      amount = double.tryParse(amountStr.replaceAll(',', '.'));
    }

    // Parse category
    final category = params['category'] ?? params['cat'];
    final mappedCategory = VoiceParserService.mapToAppCategory(category);

    // Get description
    final description =
        params['description'] ?? params['desc'] ?? params['note'] ?? '';

    // If we have enough data, add directly
    if (amount != null && amount > 0) {
      await _addExpenseDirectly(
        amount: amount,
        category: mappedCategory,
        description: description,
      );
    } else {
      // Not enough data, navigate to expense screen
      _handleNavigate('expense');
    }
  }

  /// Handle quick-add with voice text or open voice screen
  /// URL format: vantag://quick-add?text=50 lira kahve
  /// OR vantag://quick-add (opens voice screen with auto-start)
  void _handleQuickAdd(Uri uri) async {
    final text = uri.queryParameters['text'] ?? uri.queryParameters['q'];

    if (text == null || text.isEmpty) {
      // No text provided - set flag and open voice input screen
      _shouldAutoStartVoice = true;
      _navigateToVoiceInput();
      return;
    }

    // Parse voice text
    final parser = VoiceParserService();
    final result = await parser.parse(text);

    if (result.canAutoSave && result.amount != null) {
      await _addExpenseDirectly(
        amount: result.amount!,
        category: VoiceParserService.mapToAppCategory(result.category),
        description: result.description,
      );
    } else {
      // Show confirmation needed
      _showConfirmationDialog(result);
    }
  }

  /// Navigate to voice input screen
  void _navigateToVoiceInput() {
    final context = _navigatorKey?.currentContext;
    if (context == null) return;

    Navigator.of(context).pushNamed('/voice-input');
  }

  /// Add expense directly and show feedback
  Future<void> _addExpenseDirectly({
    required double amount,
    required String category,
    required String? description,
  }) async {
    // Haptic feedback
    HapticFeedback.mediumImpact();

    // Calculate work time using actual hourly rate from user profile
    final hourlyRate =
        _getHourlyRate?.call() ?? 50.0; // Fallback to 50 TL/hr if not set
    final hoursRequired = hourlyRate > 0 ? amount / hourlyRate : 0.0;
    final daysRequired = hoursRequired / 8.0;

    final expense = Expense(
      amount: amount,
      category: category,
      subCategory: description?.isNotEmpty == true ? description : null,
      date: DateTime.now(),
      hoursRequired: hoursRequired,
      daysRequired: daysRequired,
      decision: ExpenseDecision.yes,
    );

    if (_onAddExpense != null) {
      await _onAddExpense!(expense);

      // Show success feedback
      _showSuccessNotification(expense);
    }
  }

  /// Show success notification
  void _showSuccessNotification(Expense expense) {
    final context = _navigatorKey?.currentContext;
    if (context == null || !context.mounted) return;

    // Haptic success
    HapticFeedback.lightImpact();

    final displayText = expense.subCategory ?? expense.category;

    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Row(
          children: [
            const Icon(Icons.check_circle, color: Colors.white),
            const SizedBox(width: 12),
            Expanded(
              child: Text(
                '${expense.amount.toStringAsFixed(0)}₺ $displayText eklendi',
                style: const TextStyle(fontWeight: FontWeight.w500),
              ),
            ),
          ],
        ),
        backgroundColor: AppColors.categoryHealth,
        behavior: SnackBarBehavior.floating,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
        duration: const Duration(seconds: 4),
        action: SnackBarAction(
          label: 'Geri Al',
          textColor: Colors.white,
          onPressed: () async {
            // Undo by deleting the most recently added expense (index 0)
            if (_onDeleteExpense != null) {
              await _onDeleteExpense!(0);
              HapticFeedback.lightImpact();
            }
          },
        ),
      ),
    );
  }

  /// Show confirmation dialog for low-confidence results
  void _showConfirmationDialog(VoiceParseResult result) {
    final context = _navigatorKey?.currentContext;
    if (context == null || !context.mounted) return;

    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: AppColors.cardBackground,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
        title: const Text(
          'Harcamayı Onayla',
          style: TextStyle(color: Colors.white),
        ),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              '"${result.originalText}"',
              style: TextStyle(
                color: Colors.white.withValues(alpha: 0.7),
                fontStyle: FontStyle.italic,
              ),
            ),
            const SizedBox(height: 16),
            if (result.amount != null)
              _buildDetailRow('Tutar', '${result.amount!.toStringAsFixed(0)}₺'),
            _buildDetailRow(
              'Kategori',
              VoiceParserService.getCategoryDisplayName(result.category),
            ),
            _buildDetailRow('Açıklama', result.description),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text(
              'İptal',
              style: TextStyle(color: Colors.white.withValues(alpha: 0.7)),
            ),
          ),
          ElevatedButton(
            onPressed: () {
              Navigator.pop(context);
              if (result.amount != null) {
                _addExpenseDirectly(
                  amount: result.amount!,
                  category: VoiceParserService.mapToAppCategory(
                    result.category,
                  ),
                  description: result.description,
                );
              }
            },
            style: ElevatedButton.styleFrom(backgroundColor: AppColors.primary),
            child: const Text('Ekle'),
          ),
        ],
      ),
    );
  }

  Widget _buildDetailRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 4),
      child: Row(
        children: [
          Text(
            '$label: ',
            style: TextStyle(
              color: Colors.white.withValues(alpha: 0.5),
              fontSize: 14,
            ),
          ),
          Text(
            value,
            style: const TextStyle(
              color: Colors.white,
              fontSize: 14,
              fontWeight: FontWeight.w500,
            ),
          ),
        ],
      ),
    );
  }

  /// Handle navigation to a screen
  void _handleNavigate(String route) {
    if (_onNavigate != null) {
      _onNavigate!(route);
    }
  }

  /// Generate deep link URL
  static Uri generateAddExpenseLink({
    double? amount,
    String? category,
    String? description,
  }) {
    final params = <String, String>{};
    if (amount != null) params['amount'] = amount.toString();
    if (category != null) params['category'] = category;
    if (description != null) params['description'] = description;

    return Uri(
      scheme: 'vantag',
      host: 'add-expense',
      queryParameters: params.isEmpty ? null : params,
    );
  }

  /// Generate quick-add link with voice text
  static Uri generateQuickAddLink(String text) {
    return Uri(
      scheme: 'vantag',
      host: 'quick-add',
      queryParameters: {'text': text},
    );
  }

  /// Generate pursuit deep link
  static Uri generatePursuitLink(String pursuitId) {
    return Uri(
      scheme: 'vantag',
      host: 'pursuits',
      queryParameters: {'id': pursuitId},
    );
  }

  /// Generate share link for achievements
  static Uri generateShareAchievementLink(String achievementId) {
    return Uri(
      scheme: 'vantag',
      host: 'share',
      queryParameters: {'type': 'achievement', 'id': achievementId},
    );
  }

  /// Generate share link for savings milestone
  static Uri generateShareSavingsLink(double amount) {
    return Uri(
      scheme: 'vantag',
      host: 'share',
      queryParameters: {'type': 'savings', 'amount': amount.toString()},
    );
  }

  /// Handle share deep link (from shared content)
  void _handleShare(Uri uri) {
    final type = uri.queryParameters['type'];
    final id = uri.queryParameters['id'];

    debugPrint('[DeepLink] Share: type=$type, id=$id');

    // Navigate to appropriate screen based on share type
    switch (type) {
      case 'achievement':
        _handleNavigate('achievements');
        break;
      case 'savings':
      case 'progress':
        _handleNavigate('pursuits');
        break;
      default:
        _handleNavigate('home');
    }
  }

  /// Handle web deep links (https://vantag.app/...)
  void _handleWebDeepLink(Uri uri) {
    final pathSegments = uri.pathSegments;
    debugPrint('[DeepLink] Web link path segments: $pathSegments');

    if (pathSegments.isEmpty) return;

    // Check for referral link: /r/CODE
    if (pathSegments.first == 'r' && pathSegments.length >= 2) {
      final code = pathSegments[1];
      _handleReferralCode(code);
      return;
    }

    // Handle other web paths as needed
    switch (pathSegments.first) {
      case 'invite':
      case 'referral':
        if (pathSegments.length >= 2) {
          _handleReferralCode(pathSegments[1]);
        }
        break;
      case 'share':
        _handleNavigate('home');
        break;
      default:
        debugPrint('[DeepLink] Unknown web path: ${pathSegments.first}');
    }
  }

  /// Handle referral code from deep link
  Future<void> _handleReferralCode(String code) async {
    debugPrint('[DeepLink] Referral code received: $code');

    // Store pending referral code for after signup/login
    _pendingReferralCode = code;

    try {
      final prefs = await SharedPreferences.getInstance();
      await prefs.setString(_pendingReferralKey, code);
      debugPrint('[DeepLink] Stored pending referral code: $code');
    } catch (e) {
      debugPrint('[DeepLink] Error storing referral code: $e');
    }

    // Show welcome message
    _showReferralWelcome(code);
  }

  /// Show welcome message for referral
  void _showReferralWelcome(String code) {
    final context = _navigatorKey?.currentContext;
    if (context == null || !context.mounted) return;

    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Row(
          children: [
            const Icon(Icons.card_giftcard, color: Colors.white),
            const SizedBox(width: 12),
            Expanded(
              child: Text(
                'Davet kodu uygulandı: $code',
                style: const TextStyle(fontWeight: FontWeight.w500),
              ),
            ),
          ],
        ),
        backgroundColor: AppColors.primary,
        behavior: SnackBarBehavior.floating,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
        duration: const Duration(seconds: 3),
      ),
    );
  }

  /// Get stored pending referral code (called during signup)
  static Future<String?> getPendingReferralCode() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      return prefs.getString(_pendingReferralKey);
    } catch (e) {
      debugPrint('[DeepLink] Error getting pending referral code: $e');
      return null;
    }
  }

  /// Clear pending referral code after it's been applied
  static Future<void> clearPendingReferralCode() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      await prefs.remove(_pendingReferralKey);
    } catch (e) {
      debugPrint('[DeepLink] Error clearing pending referral code: $e');
    }
  }

  /// Generate referral link for sharing
  static Uri generateReferralLink(String referralCode) {
    return Uri.parse('https://vantag.app/r/$referralCode');
  }

  /// Get all supported URL schemes for documentation
  static Map<String, String> getSupportedSchemes() {
    return {
      'vantag://add-expense?amount=50&category=food&description=kahve':
          'Add expense with details',
      'vantag://quick-add?text=50 lira kahve': 'Quick add with voice text',
      'vantag://quick-add': 'Open voice input screen',
      'vantag://summary': 'Open reports/summary screen',
      'vantag://subscriptions': 'Open subscriptions screen',
      'vantag://pursuits': 'Open dreams/pursuits screen',
      'vantag://achievements': 'Open achievements screen',
      'vantag://settings': 'Open settings screen',
      'vantag://profile': 'Open profile screen',
      'vantag://paywall': 'Open premium paywall',
      'vantag://habit-calculator': 'Open habit calculator',
    };
  }
}


--- FILE: lib/services/profile_service.dart ---

import 'dart:io';
import 'package:flutter/foundation.dart';
import 'package:path_provider/path_provider.dart';
import 'package:shared_preferences/shared_preferences.dart';
import '../models/models.dart';

class ProfileService {
  // Legacy keys (eski format)
  static const _keyMonthlyIncome = 'monthly_income';
  static const _keyDailyHours = 'daily_hours';
  static const _keyWorkDaysPerWeek = 'work_days_per_week';
  static const _keyProfilePhotoPath = 'profile_photo_path';
  static const _keyOnboardingCompleted = 'onboarding_completed';

  // Yeni format keys
  static const _keyIncomeSources = 'income_sources';

  // Bütçe ayarları
  static const _keyMonthlyBudget = 'monthly_budget';
  static const _keySavingsGoal = 'savings_goal';

  // Salary & Balance Management
  static const _keySalaryDay = 'salary_day';
  static const _keyCurrentBalance = 'current_balance';
  static const _keyLastSalaryConfirmedDate = 'last_salary_confirmed_date';

  // One-time incomes
  static const _keyIncomes = 'incomes_v1';

  // Base currency (locked for FREE users)
  static const _keyBaseCurrency = 'base_currency';

  Future<UserProfile?> getProfile() async {
    final prefs = await SharedPreferences.getInstance();

    final hours = prefs.getDouble(_keyDailyHours);
    final days = prefs.getInt(_keyWorkDaysPerWeek);

    if (hours == null || days == null) {
      return null;
    }

    // Bütçe ayarlarını oku
    final monthlyBudget = prefs.getDouble(_keyMonthlyBudget);
    final savingsGoal = prefs.getDouble(_keySavingsGoal);

    // Salary & Balance Management
    final salaryDay = prefs.getInt(_keySalaryDay);
    final currentBalance = prefs.getDouble(_keyCurrentBalance);
    final lastSalaryConfirmedDateStr = prefs.getString(
      _keyLastSalaryConfirmedDate,
    );
    final lastSalaryConfirmedDate = lastSalaryConfirmedDateStr != null
        ? DateTime.tryParse(lastSalaryConfirmedDateStr)
        : null;

    // Base currency
    final baseCurrency = prefs.getString(_keyBaseCurrency);

    // Önce yeni format'ı kontrol et
    final incomeSourcesJson = prefs.getString(_keyIncomeSources);
    if (incomeSourcesJson != null && incomeSourcesJson.isNotEmpty) {
      try {
        final incomeSources = IncomeSource.decodeList(incomeSourcesJson);
        return UserProfile(
          incomeSources: incomeSources,
          dailyHours: hours,
          workDaysPerWeek: days,
          monthlyBudget: monthlyBudget,
          monthlySavingsGoal: savingsGoal,
          salaryDay: salaryDay,
          currentBalance: currentBalance,
          lastSalaryConfirmedDate: lastSalaryConfirmedDate,
          baseCurrency: baseCurrency,
        );
      } catch (e) {
        // Decode hatası - eski formattan devam et
      }
    }

    // Eski format'tan migration
    final legacyIncome = prefs.getDouble(_keyMonthlyIncome);
    if (legacyIncome != null && legacyIncome > 0) {
      // Eski format'ı yeni format'a dönüştür
      final salarySource = IncomeSource.salary(
        amount: legacyIncome,
        title: 'Main Salary',
      );
      final profile = UserProfile(
        incomeSources: [salarySource],
        dailyHours: hours,
        workDaysPerWeek: days,
        monthlyBudget: monthlyBudget,
        monthlySavingsGoal: savingsGoal,
        salaryDay: salaryDay,
        currentBalance: currentBalance,
        lastSalaryConfirmedDate: lastSalaryConfirmedDate,
      );

      // Yeni format'ta kaydet
      await saveProfile(profile);
      return profile;
    }

    // Hiç gelir verisi yoksa boş profil döndür
    return UserProfile(
      incomeSources: [],
      dailyHours: hours,
      workDaysPerWeek: days,
      monthlyBudget: monthlyBudget,
      monthlySavingsGoal: savingsGoal,
      salaryDay: salaryDay,
      currentBalance: currentBalance,
      lastSalaryConfirmedDate: lastSalaryConfirmedDate,
      baseCurrency: baseCurrency,
    );
  }

  Future<void> saveProfile(UserProfile profile) async {
    final prefs = await SharedPreferences.getInstance();

    // Income sources'ı JSON olarak kaydet
    if (profile.incomeSources.isNotEmpty) {
      await prefs.setString(
        _keyIncomeSources,
        IncomeSource.encodeList(profile.incomeSources),
      );
    }

    // Legacy field'ı da güncelle (geriye uyumluluk)
    await prefs.setDouble(_keyMonthlyIncome, profile.monthlyIncome);
    await prefs.setDouble(_keyDailyHours, profile.dailyHours);
    await prefs.setInt(_keyWorkDaysPerWeek, profile.workDaysPerWeek);

    // Bütçe ayarları
    if (profile.monthlyBudget != null) {
      await prefs.setDouble(_keyMonthlyBudget, profile.monthlyBudget!);
    } else {
      await prefs.remove(_keyMonthlyBudget);
    }

    if (profile.monthlySavingsGoal != null) {
      await prefs.setDouble(_keySavingsGoal, profile.monthlySavingsGoal!);
    } else {
      await prefs.remove(_keySavingsGoal);
    }

    // Salary & Balance Management
    if (profile.salaryDay != null) {
      await prefs.setInt(_keySalaryDay, profile.salaryDay!);
    } else {
      await prefs.remove(_keySalaryDay);
    }

    if (profile.currentBalance != null) {
      await prefs.setDouble(_keyCurrentBalance, profile.currentBalance!);
    } else {
      await prefs.remove(_keyCurrentBalance);
    }

    if (profile.lastSalaryConfirmedDate != null) {
      await prefs.setString(
        _keyLastSalaryConfirmedDate,
        profile.lastSalaryConfirmedDate!.toIso8601String(),
      );
    } else {
      await prefs.remove(_keyLastSalaryConfirmedDate);
    }

    // Base currency
    if (profile.baseCurrency != null) {
      await prefs.setString(_keyBaseCurrency, profile.baseCurrency!);
    }
  }

  /// Gelir kaynağı ekle
  Future<UserProfile?> addIncomeSource(IncomeSource source) async {
    final profile = await getProfile();
    if (profile == null) return null;

    final updatedProfile = profile.addIncomeSource(source);
    await saveProfile(updatedProfile);
    return updatedProfile;
  }

  /// Gelir kaynağı güncelle
  Future<UserProfile?> updateIncomeSource(
    String id,
    IncomeSource source,
  ) async {
    final profile = await getProfile();
    if (profile == null) return null;

    final updatedProfile = profile.updateIncomeSource(id, source);
    await saveProfile(updatedProfile);
    return updatedProfile;
  }

  /// Gelir kaynağı sil
  Future<UserProfile?> removeIncomeSource(String id) async {
    final profile = await getProfile();
    if (profile == null) return null;

    final updatedProfile = profile.removeIncomeSource(id);
    await saveProfile(updatedProfile);
    return updatedProfile;
  }

  /// Tüm gelir kaynaklarını getir
  Future<List<IncomeSource>> getIncomeSources() async {
    final profile = await getProfile();
    return profile?.incomeSources ?? [];
  }

  Future<bool> hasProfile() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.containsKey(_keyDailyHours) &&
        prefs.containsKey(_keyWorkDaysPerWeek);
  }

  /// TÜM uygulama verilerini sıfırla
  Future<void> resetAllData() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.clear();
  }

  /// Profil fotoğrafını kaydeder
  Future<String?> saveProfilePhoto(File imageFile) async {
    try {
      final directory = await getApplicationDocumentsDirectory();
      final fileName =
          'profile_photo_${DateTime.now().millisecondsSinceEpoch}.jpg';
      final savedPath = '${directory.path}/$fileName';

      // Eski fotoğrafı sil
      final oldPath = await getProfilePhotoPath();
      if (oldPath != null) {
        final oldFile = File(oldPath);
        if (await oldFile.exists()) {
          await oldFile.delete();
        }
      }

      // Yeni fotoğrafı kopyala
      await imageFile.copy(savedPath);

      // Path'i kaydet
      final prefs = await SharedPreferences.getInstance();
      await prefs.setString(_keyProfilePhotoPath, savedPath);
      return savedPath;
    } catch (e) {
      return null;
    }
  }

  /// Profil fotoğrafı path'ini getirir
  Future<String?> getProfilePhotoPath() async {
    final prefs = await SharedPreferences.getInstance();
    final path = prefs.getString(_keyProfilePhotoPath);

    // Dosyanın hala var olup olmadığını kontrol et
    if (path != null) {
      final file = File(path);
      if (await file.exists()) {
        return path;
      }
      // Dosya yoksa path'i temizle
      await prefs.remove(_keyProfilePhotoPath);
    }
    return null;
  }

  /// Profil fotoğrafını siler
  Future<void> deleteProfilePhoto() async {
    try {
      final path = await getProfilePhotoPath();
      if (path != null) {
        final file = File(path);
        if (await file.exists()) {
          await file.delete();
        }
      }
      final prefs = await SharedPreferences.getInstance();
      await prefs.remove(_keyProfilePhotoPath);
    } catch (e) {
      // Silme hatası sessizce geçilir
    }
  }

  /// Onboarding tamamlandı mı kontrol eder
  Future<bool> isOnboardingCompleted() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      final completed = prefs.getBool(_keyOnboardingCompleted) ?? false;
      debugPrint('[ProfileService] isOnboardingCompleted: $completed');
      return completed;
    } catch (e) {
      debugPrint('[ProfileService] isOnboardingCompleted error: $e');
      return false;
    }
  }

  /// Onboarding'i tamamlandı olarak işaretler
  Future<bool> setOnboardingCompleted() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      final success = await prefs.setBool(_keyOnboardingCompleted, true);
      debugPrint('[ProfileService] setOnboardingCompleted: $success');

      if (!success) {
        // Retry once if first attempt fails
        debugPrint('[ProfileService] setOnboardingCompleted: retrying...');
        final retrySuccess = await prefs.setBool(_keyOnboardingCompleted, true);
        debugPrint(
          '[ProfileService] setOnboardingCompleted retry: $retrySuccess',
        );
        return retrySuccess;
      }

      return success;
    } catch (e) {
      debugPrint('[ProfileService] setOnboardingCompleted error: $e');
      return false;
    }
  }

  // ============================================
  // SALARY DAY & BALANCE MANAGEMENT
  // ============================================

  /// Maaş gününü güncelle
  Future<UserProfile?> updateSalaryDay(int? day) async {
    final profile = await getProfile();
    if (profile == null) return null;

    final updatedProfile = profile.copyWith(salaryDay: day);
    await saveProfile(updatedProfile);
    return updatedProfile;
  }

  /// Güncel bakiyeyi güncelle
  Future<UserProfile?> updateCurrentBalance(double? balance) async {
    final profile = await getProfile();
    if (profile == null) return null;

    final updatedProfile = profile.copyWith(currentBalance: balance);
    await saveProfile(updatedProfile);
    return updatedProfile;
  }

  /// Maaş onayını kaydet
  Future<UserProfile?> confirmSalaryReceived({double? newBalance}) async {
    final profile = await getProfile();
    if (profile == null) return null;

    final updatedProfile = profile.copyWith(
      lastSalaryConfirmedDate: DateTime.now(),
      currentBalance: newBalance ?? profile.currentBalance,
    );
    await saveProfile(updatedProfile);
    return updatedProfile;
  }

  /// Bakiyeden harcama düş
  Future<UserProfile?> deductFromBalance(double amount) async {
    final profile = await getProfile();
    if (profile == null) return null;

    final currentBalance = profile.currentBalance ?? 0;
    final newBalance = currentBalance - amount;

    final updatedProfile = profile.copyWith(currentBalance: newBalance);
    await saveProfile(updatedProfile);
    return updatedProfile;
  }

  /// Bakiyeye gelir ekle
  Future<UserProfile?> addToBalance(double amount) async {
    final profile = await getProfile();
    if (profile == null) return null;

    final currentBalance = profile.currentBalance ?? 0;
    final newBalance = currentBalance + amount;

    final updatedProfile = profile.copyWith(currentBalance: newBalance);
    await saveProfile(updatedProfile);
    return updatedProfile;
  }

  // ============================================
  // ONE-TIME INCOME MANAGEMENT
  // ============================================

  /// Tek seferlik gelirleri getir
  Future<List<Income>> getIncomes() async {
    final prefs = await SharedPreferences.getInstance();
    final json = prefs.getString(_keyIncomes);
    if (json == null || json.isEmpty) return [];

    try {
      return Income.decodeList(json);
    } catch (e) {
      return [];
    }
  }

  /// Tek seferlik gelir ekle
  Future<void> addIncome(Income income) async {
    final incomes = await getIncomes();
    incomes.insert(0, income); // En yenisi başta

    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(_keyIncomes, Income.encodeList(incomes));
  }

  /// Bu ayki gelirleri getir
  Future<List<Income>> getCurrentMonthIncomes() async {
    final incomes = await getIncomes();
    final now = DateTime.now();
    return incomes
        .where((i) => i.date.year == now.year && i.date.month == now.month)
        .toList();
  }

  /// Bu ayki toplam geliri hesapla
  Future<double> getCurrentMonthTotalIncome() async {
    final incomes = await getCurrentMonthIncomes();
    return incomes.fold<double>(0.0, (sum, i) => sum + i.amount);
  }
}


--- FILE: lib/services/lock_service.dart ---

import 'dart:convert';
import 'dart:math';
import 'package:crypto/crypto.dart';
import 'package:flutter/foundation.dart';
import 'package:local_auth/local_auth.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'secure_storage_service.dart';

/// App lock service with PIN and biometric authentication
class LockService {
  static final LocalAuthentication _auth = LocalAuthentication();
  static const String _lockEnabledKey = 'lock_enabled';
  static const String _biometricEnabledKey = 'biometric_enabled';
  static const String _pinSaltKey = 'pin_salt';

  // ============================================================
  // BIOMETRIC METHODS
  // ============================================================

  /// Check if device supports biometrics
  static Future<bool> canUseBiometrics() async {
    try {
      final canCheck = await _auth.canCheckBiometrics;
      final isSupported = await _auth.isDeviceSupported();
      return canCheck && isSupported;
    } catch (e) {
      debugPrint('[LockService] Error checking biometrics: $e');
      return false;
    }
  }

  /// Get available biometric types
  static Future<List<BiometricType>> getAvailableBiometrics() async {
    try {
      return await _auth.getAvailableBiometrics();
    } catch (e) {
      debugPrint('[LockService] Error getting biometrics: $e');
      return [];
    }
  }

  /// Check if Face ID is available (iOS)
  static Future<bool> hasFaceId() async {
    final biometrics = await getAvailableBiometrics();
    return biometrics.contains(BiometricType.face);
  }

  /// Check if fingerprint is available
  static Future<bool> hasFingerprint() async {
    final biometrics = await getAvailableBiometrics();
    return biometrics.contains(BiometricType.fingerprint) ||
        biometrics.contains(BiometricType.strong) ||
        biometrics.contains(BiometricType.weak);
  }

  /// Authenticate with biometrics
  static Future<bool> authenticateWithBiometrics(String reason) async {
    try {
      return await _auth.authenticate(
        localizedReason: reason,
        biometricOnly: true,
        persistAcrossBackgrounding: true,
      );
    } catch (e) {
      debugPrint('[LockService] Biometric auth error: $e');
      return false;
    }
  }

  // ============================================================
  // LOCK SETTINGS
  // ============================================================

  /// Check if lock is enabled
  static Future<bool> isLockEnabled() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getBool(_lockEnabledKey) ?? false;
  }

  /// Enable/disable lock
  static Future<void> setLockEnabled(bool enabled) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_lockEnabledKey, enabled);
  }

  /// Check if biometric is enabled
  static Future<bool> isBiometricEnabled() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getBool(_biometricEnabledKey) ?? false;
  }

  /// Enable/disable biometric
  static Future<void> setBiometricEnabled(bool enabled) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_biometricEnabledKey, enabled);
  }

  // ============================================================
  // PIN METHODS (Using Secure Storage)
  // ============================================================

  /// Generate random salt for PIN hashing
  static String _generateSalt() {
    final random = Random.secure();
    final bytes = List<int>.generate(32, (_) => random.nextInt(256));
    return base64Encode(bytes);
  }

  /// Hash PIN with salt using PBKDF2-like approach
  static String _hashPin(String pin, String salt) {
    // Multiple rounds for brute-force resistance
    List<int> hash = utf8.encode('$pin$salt');
    for (var i = 0; i < 10000; i++) {
      hash = sha256.convert(hash).bytes;
    }
    return base64Encode(hash);
  }

  /// Save PIN (hashed with random salt, stored in secure storage)
  static Future<void> setPin(String pin) async {
    final prefs = await SharedPreferences.getInstance();
    final salt = _generateSalt();
    final hashedPin = _hashPin(pin, salt);

    // Store salt in SharedPreferences (not sensitive)
    await prefs.setString(_pinSaltKey, salt);
    // Store hash in secure storage
    await secureStorage.savePinHash(hashedPin);
  }

  /// Verify PIN
  static Future<bool> verifyPin(String pin) async {
    final prefs = await SharedPreferences.getInstance();
    final salt = prefs.getString(_pinSaltKey);
    if (salt == null) return false;

    final savedHash = await secureStorage.getPinHash();
    if (savedHash == null) return false;

    final inputHash = _hashPin(pin, salt);

    // Constant-time comparison to prevent timing attacks
    if (savedHash.length != inputHash.length) return false;
    var result = 0;
    for (var i = 0; i < savedHash.length; i++) {
      result |= savedHash.codeUnitAt(i) ^ inputHash.codeUnitAt(i);
    }
    return result == 0;
  }

  /// Check if PIN is set
  static Future<bool> hasPinSet() async {
    return await secureStorage.hasPinSet();
  }

  /// Remove PIN and disable lock
  static Future<void> removePin() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.remove(_pinSaltKey);
    await secureStorage.deletePinHash();
    await prefs.setBool(_lockEnabledKey, false);
    await prefs.setBool(_biometricEnabledKey, false);
  }

  /// Change PIN
  static Future<bool> changePin(String oldPin, String newPin) async {
    final isValid = await verifyPin(oldPin);
    if (!isValid) return false;

    await setPin(newPin);
    return true;
  }
}


--- FILE: lib/services/auth_service.dart ---

import 'dart:io';
import 'dart:convert';
import 'dart:math';
import 'package:flutter/foundation.dart';
import 'package:flutter/services.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:firebase_storage/firebase_storage.dart';
import 'package:google_sign_in/google_sign_in.dart';
import 'package:sign_in_with_apple/sign_in_with_apple.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:crypto/crypto.dart';
import 'device_service.dart';

/// Firebase kullanıcı profil modeli (Auth bilgileri için)
/// NOT: Bu sınıf models/user_profile.dart'taki UserProfile'dan farklıdır.
/// O model gelir/çalışma saatleri için, bu model Firebase Auth bilgileri için.
class FirebaseUserProfile {
  final String uid;
  final String? displayName;
  final String? email;
  final String? photoUrl;
  final bool isAnonymous;
  final DateTime createdAt;
  final DateTime lastLoginAt;

  const FirebaseUserProfile({
    required this.uid,
    this.displayName,
    this.email,
    this.photoUrl,
    required this.isAnonymous,
    required this.createdAt,
    required this.lastLoginAt,
  });

  Map<String, dynamic> toJson() => {
    'uid': uid,
    'displayName': displayName,
    'email': email,
    'photoUrl': photoUrl,
    'isAnonymous': isAnonymous,
    'createdAt': createdAt.toIso8601String(),
    'lastLoginAt': lastLoginAt.toIso8601String(),
  };

  factory FirebaseUserProfile.fromJson(Map<String, dynamic> json) =>
      FirebaseUserProfile(
        uid: json['uid'] as String,
        displayName: json['displayName'] as String?,
        email: json['email'] as String?,
        photoUrl: json['photoUrl'] as String?,
        isAnonymous: json['isAnonymous'] as bool? ?? true,
        createdAt: DateTime.parse(json['createdAt'] as String),
        lastLoginAt: DateTime.parse(json['lastLoginAt'] as String),
      );

  factory FirebaseUserProfile.fromFirebaseUser(User user) =>
      FirebaseUserProfile(
        uid: user.uid,
        displayName: user.displayName,
        email: user.email,
        photoUrl: user.photoURL,
        isAnonymous: user.isAnonymous,
        createdAt: user.metadata.creationTime ?? DateTime.now(),
        lastLoginAt: user.metadata.lastSignInTime ?? DateTime.now(),
      );
}

/// Auth sonuç wrapper'ı
class AuthResult {
  final bool success;
  final String? errorMessage;
  final User? user;
  final bool wasLinked;

  const AuthResult({
    required this.success,
    this.errorMessage,
    this.user,
    this.wasLinked = false,
  });

  factory AuthResult.success(User user, {bool wasLinked = false}) =>
      AuthResult(success: true, user: user, wasLinked: wasLinked);

  factory AuthResult.failure(String message) =>
      AuthResult(success: false, errorMessage: message);
}

/// Authentication Service
/// Anonim giriş, Google Sign-In ve hesap birleştirme işlemlerini yönetir
class AuthService {
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;

  // GoogleSignIn v6 API
  final GoogleSignIn _googleSignIn = GoogleSignIn(
    scopes: ['email', 'profile'],
  );

  // Singleton pattern
  static final AuthService _instance = AuthService._internal();
  factory AuthService() => _instance;
  AuthService._internal();

  /// Mevcut kullanıcı
  User? get currentUser => _auth.currentUser;

  /// Kullanıcı oturum açmış mı?
  bool get isSignedIn => currentUser != null;

  /// Kullanıcı anonim mi?
  bool get isAnonymous => currentUser?.isAnonymous ?? true;

  /// Kullanıcı Google ile bağlı mı?
  bool get isLinkedWithGoogle {
    final user = currentUser;
    if (user == null) return false;
    return user.providerData.any((info) => info.providerId == 'google.com');
  }

  /// Kullanıcı Apple ile bağlı mı?
  bool get isLinkedWithApple {
    final user = currentUser;
    if (user == null) return false;
    return user.providerData.any((info) => info.providerId == 'apple.com');
  }

  /// Auth state stream
  Stream<User?> get authStateChanges => _auth.authStateChanges();

  // ═══════════════════════════════════════════════════════════════════════════
  // ANONİM GİRİŞ
  // ═══════════════════════════════════════════════════════════════════════════

  /// Anonim giriş yap (ilk açılışta)
  Future<AuthResult> signInAnonymously() async {
    debugPrint("🔐 [Auth] Anonim giriş başlıyor...");

    try {
      // Zaten giriş yapılmışsa mevcut kullanıcıyı döndür
      if (currentUser != null) {
        debugPrint("ℹ️ [Auth] Zaten giriş yapılmış - UID: ${currentUser!.uid}");
        return AuthResult.success(currentUser!);
      }

      final credential = await _auth.signInAnonymously();
      final user = credential.user;

      if (user != null) {
        debugPrint("✅ [Auth] Anonim giriş başarılı - UID: ${user.uid}");
        await _saveUserProfile(user);
        return AuthResult.success(user);
      } else {
        debugPrint("❌ [Auth] Anonim giriş başarısız - user null");
        return AuthResult.failure("Anonim giriş başarısız");
      }
    } on FirebaseAuthException catch (e) {
      debugPrint("❌ [Auth] Firebase Auth Hatası: ${e.code} - ${e.message}");
      return AuthResult.failure(_getAuthErrorMessage(e.code));
    } catch (e) {
      debugPrint("❌ [Auth] Beklenmeyen Hata: $e");
      return AuthResult.failure("Giriş sırasında bir hata oluştu");
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // GOOGLE SIGN-IN
  // ═══════════════════════════════════════════════════════════════════════════

  /// Google ile giriş yap
  /// Eğer anonim kullanıcı varsa, hesapları birleştirir (linkWithCredential)
  Future<AuthResult> signInWithGoogle() async {
    debugPrint("🔐 [Auth] Google Sign-In başlıyor...");

    try {
      // 1. Sign out first for clean start
      await _googleSignIn.signOut();

      // 2. Sign in with Google (v6 API)
      final GoogleSignInAccount? googleUser = await _googleSignIn.signIn();

      if (googleUser == null) {
        debugPrint("ℹ️ [Auth] Kullanıcı Google Sign-In'i iptal etti");
        return AuthResult.failure("Giriş iptal edildi");
      }

      debugPrint("📧 [Auth] Google hesabı seçildi: ${googleUser.email}");

      // 3. Get authentication tokens
      final GoogleSignInAuthentication googleAuth =
          await googleUser.authentication;

      if (googleAuth.idToken == null) {
        return AuthResult.failure("Google token alınamadı");
      }

      final OAuthCredential credential = GoogleAuthProvider.credential(
        accessToken: googleAuth.accessToken,
        idToken: googleAuth.idToken,
      );

      // 4. Mevcut anonim kullanıcı var mı kontrol et
      final existingUser = currentUser;
      final wasAnonymous = existingUser?.isAnonymous ?? false;

      User? user;
      bool wasLinked = false;

      if (wasAnonymous && existingUser != null) {
        // Anonim hesabı Google ile birleştir
        debugPrint("🔗 [Auth] Anonim hesap Google ile birleştiriliyor...");
        try {
          final linkedCredential = await existingUser.linkWithCredential(
            credential,
          );
          user = linkedCredential.user;
          wasLinked = true;
          debugPrint(
            "✅ [Auth] Hesaplar birleştirildi! UID korundu: ${user?.uid}",
          );
        } on FirebaseAuthException catch (e) {
          if (e.code == 'credential-already-in-use') {
            // Bu Google hesabı başka bir hesaba bağlı
            debugPrint(
              "⚠️ [Auth] Google hesabı zaten kullanımda, yeni hesapla giriş yapılıyor...",
            );
            await existingUser.delete();
            final signInResult = await _auth.signInWithCredential(credential);
            user = signInResult.user;
            wasLinked = false;
          } else {
            rethrow;
          }
        }
      } else {
        // Direkt Google ile giriş yap
        debugPrint("🔐 [Auth] Google ile direkt giriş yapılıyor...");
        final signInResult = await _auth.signInWithCredential(credential);
        user = signInResult.user;
      }

      if (user != null) {
        debugPrint("✅ [Auth] Google Sign-In başarılı!");
        debugPrint("   UID: ${user.uid}");
        debugPrint("   Email: ${user.email}");
        debugPrint("   İsim: ${user.displayName}");
        debugPrint("   Birleştirildi mi: $wasLinked");

        await _saveUserProfile(user);

        // Register this device as the active device (single device policy)
        await DeviceService().registerDevice();

        return AuthResult.success(user, wasLinked: wasLinked);
      } else {
        return AuthResult.failure("Google ile giriş başarısız");
      }
    } on PlatformException catch (e) {
      debugPrint("❌ [Auth] Google Sign In Platform Error: ${e.code} - ${e.message}");
      return AuthResult.failure(
        "Google ile giriş yapılamadı. Lütfen tekrar deneyin.",
      );
    } on FirebaseAuthException catch (e) {
      debugPrint("❌ [Auth] Firebase Auth Hatası: ${e.code} - ${e.message}");
      return AuthResult.failure(_getAuthErrorMessage(e.code));
    } catch (e) {
      debugPrint("❌ [Auth] Beklenmeyen Hata: $e");
      return AuthResult.failure(
        "Google ile giriş sırasında bir hata oluştu: $e",
      );
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // APPLE SIGN-IN
  // ═══════════════════════════════════════════════════════════════════════════

  /// Generate a random nonce for Apple Sign-In
  String _generateNonce([int length = 32]) {
    const charset =
        '0123456789ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvwxyz-._';
    final random = Random.secure();
    return List.generate(length, (_) => charset[random.nextInt(charset.length)])
        .join();
  }

  /// SHA256 hash of the nonce
  String _sha256ofString(String input) {
    final bytes = utf8.encode(input);
    final digest = sha256.convert(bytes);
    return digest.toString();
  }

  /// Apple ile giriş yap
  /// Eğer anonim kullanıcı varsa, hesapları birleştirir (linkWithCredential)
  Future<AuthResult> signInWithApple() async {
    debugPrint("🔐 [Auth] Apple Sign-In başlıyor...");

    try {
      // Check if Apple Sign-In is available on this device
      final isAvailable = await SignInWithApple.isAvailable();
      if (!isAvailable) {
        debugPrint("❌ [Auth] Apple Sign-In bu cihazda kullanılamıyor");
        return AuthResult.failure("Apple ile giriş bu cihazda kullanılamıyor");
      }

      // Generate nonce for security
      final rawNonce = _generateNonce();
      final nonce = _sha256ofString(rawNonce);

      // Request Apple Sign-In
      final appleCredential = await SignInWithApple.getAppleIDCredential(
        scopes: [
          AppleIDAuthorizationScopes.email,
          AppleIDAuthorizationScopes.fullName,
        ],
        nonce: nonce,
      );

      debugPrint("📧 [Auth] Apple hesabı seçildi: ${appleCredential.email ?? 'email gizli'}");

      // Create Firebase credential
      final oauthCredential = OAuthProvider('apple.com').credential(
        idToken: appleCredential.identityToken,
        rawNonce: rawNonce,
      );

      // Check if there's an existing anonymous user
      final existingUser = currentUser;
      final wasAnonymous = existingUser?.isAnonymous ?? false;

      User? user;
      bool wasLinked = false;

      if (wasAnonymous && existingUser != null) {
        // Link anonymous account with Apple
        debugPrint("🔗 [Auth] Anonim hesap Apple ile birleştiriliyor...");
        try {
          final linkedCredential = await existingUser.linkWithCredential(
            oauthCredential,
          );
          user = linkedCredential.user;
          wasLinked = true;
          debugPrint(
            "✅ [Auth] Hesaplar birleştirildi! UID korundu: ${user?.uid}",
          );
        } on FirebaseAuthException catch (e) {
          if (e.code == 'credential-already-in-use') {
            // This Apple account is linked to another account
            debugPrint(
              "⚠️ [Auth] Apple hesabı zaten kullanımda, yeni hesapla giriş yapılıyor...",
            );
            await existingUser.delete();
            final signInResult = await _auth.signInWithCredential(oauthCredential);
            user = signInResult.user;
            wasLinked = false;
          } else {
            rethrow;
          }
        }
      } else {
        // Direct Apple sign-in
        debugPrint("🔐 [Auth] Apple ile direkt giriş yapılıyor...");
        final signInResult = await _auth.signInWithCredential(oauthCredential);
        user = signInResult.user;
      }

      if (user != null) {
        // Update display name if provided by Apple (only on first sign-in)
        if (appleCredential.givenName != null || appleCredential.familyName != null) {
          final displayName = [
            appleCredential.givenName,
            appleCredential.familyName,
          ].where((s) => s != null && s.isNotEmpty).join(' ');

          if (displayName.isNotEmpty && (user.displayName == null || user.displayName!.isEmpty)) {
            await user.updateDisplayName(displayName);
            // Reload user to get updated info
            await user.reload();
            user = _auth.currentUser;
          }
        }

        debugPrint("✅ [Auth] Apple Sign-In başarılı!");
        debugPrint("   UID: ${user?.uid}");
        debugPrint("   Email: ${user?.email ?? 'gizli'}");
        debugPrint("   İsim: ${user?.displayName ?? 'Yok'}");
        debugPrint("   Birleştirildi mi: $wasLinked");

        if (user != null) {
          await _saveUserProfile(user);

          // Register this device as the active device (single device policy)
          await DeviceService().registerDevice();

          return AuthResult.success(user, wasLinked: wasLinked);
        }
      }

      return AuthResult.failure("Apple ile giriş başarısız");
    } on SignInWithAppleAuthorizationException catch (e) {
      if (e.code == AuthorizationErrorCode.canceled) {
        debugPrint("ℹ️ [Auth] Kullanıcı Apple Sign-In'i iptal etti");
        return AuthResult.failure("Giriş iptal edildi");
      }
      debugPrint("❌ [Auth] Apple Auth Hatası: ${e.code} - ${e.message}");
      return AuthResult.failure("Apple ile giriş başarısız: ${e.message}");
    } on PlatformException catch (e) {
      debugPrint("❌ [Auth] Apple Sign In Platform Error: ${e.code} - ${e.message}");
      return AuthResult.failure(
        "Apple ile giriş yapılamadı. Lütfen tekrar deneyin.",
      );
    } on FirebaseAuthException catch (e) {
      debugPrint("❌ [Auth] Firebase Auth Hatası: ${e.code} - ${e.message}");
      return AuthResult.failure(_getAuthErrorMessage(e.code));
    } catch (e) {
      debugPrint("❌ [Auth] Beklenmeyen Hata: $e");
      return AuthResult.failure(
        "Apple ile giriş sırasında bir hata oluştu: $e",
      );
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // ÇIKIŞ
  // ═══════════════════════════════════════════════════════════════════════════

  /// Çıkış yap
  /// [clearDevice] - true if signing out voluntarily (clears device token)
  ///                 false if being kicked out by another device
  Future<void> signOut({bool clearDevice = true}) async {
    debugPrint("🚪 [Auth] Çıkış yapılıyor...");

    try {
      // Clear device token from Firestore (only if voluntary sign out)
      if (clearDevice) {
        await DeviceService().clearDeviceOnSignOut();
      }

      // Google Sign-Out
      try {
        await _googleSignIn.signOut();
        debugPrint("✅ [Auth] Google Sign-Out başarılı");
      } catch (e) {
        debugPrint("⚠️ [Auth] Google Sign-Out hatası: $e");
      }

      // Firebase Sign-Out
      await _auth.signOut();
      debugPrint("✅ [Auth] Firebase Sign-Out başarılı");
    } catch (e) {
      debugPrint("❌ [Auth] Çıkış hatası: $e");
    }
  }

  /// Hesabı sil (dikkatli kullan!)
  Future<AuthResult> deleteAccount() async {
    debugPrint("🗑️ [Auth] Hesap siliniyor...");

    try {
      final user = currentUser;
      if (user == null) {
        return AuthResult.failure("Silinecek hesap yok");
      }

      // Firestore verilerini sil
      await _deleteUserData(user.uid);

      // Hesabı sil
      await user.delete();

      debugPrint("✅ [Auth] Hesap silindi");
      return AuthResult.success(user);
    } on FirebaseAuthException catch (e) {
      if (e.code == 'requires-recent-login') {
        return AuthResult.failure(
          "Bu işlem için yeniden giriş yapmanız gerekiyor",
        );
      }
      return AuthResult.failure(_getAuthErrorMessage(e.code));
    } catch (e) {
      return AuthResult.failure("Hesap silinirken hata oluştu");
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // FIRESTORE PROFİL İŞLEMLERİ
  // ═══════════════════════════════════════════════════════════════════════════

  /// Kullanıcı profilini Firestore'a kaydet
  Future<void> _saveUserProfile(User user) async {
    debugPrint("💾 [Auth] Profil Firestore'a kaydediliyor...");

    try {
      final profileDoc = _firestore.collection('users').doc(user.uid);

      // Ana profil dökümanı
      await profileDoc.set({
        'uid': user.uid,
        'displayName': user.displayName,
        'email': user.email,
        'photoUrl': user.photoURL,
        'isAnonymous': user.isAnonymous,
        'createdAt': FieldValue.serverTimestamp(),
        'lastLoginAt': FieldValue.serverTimestamp(),
        'providers': user.providerData.map((p) => p.providerId).toList(),
      }, SetOptions(merge: true));

      debugPrint("✅ [Auth] Profil kaydedildi!");
      debugPrint("   Path: users/${user.uid}");
      debugPrint("   Email: ${user.email ?? 'Anonim'}");
      debugPrint("   İsim: ${user.displayName ?? 'Anonim Kullanıcı'}");
    } on FirebaseException catch (e) {
      debugPrint("❌ [Auth] Profil kaydetme hatası: ${e.code} - ${e.message}");
    } catch (e) {
      debugPrint("❌ [Auth] Beklenmeyen profil hatası: $e");
    }
  }

  /// Kullanıcı profilini Firestore'dan getir
  Future<FirebaseUserProfile?> getFirebaseUserProfile() async {
    try {
      final user = currentUser;
      if (user == null) return null;

      final doc = await _firestore.collection('users').doc(user.uid).get();

      if (doc.exists && doc.data() != null) {
        return FirebaseUserProfile.fromJson(doc.data()!);
      }

      // Firestore'da yoksa Firebase User'dan oluştur
      return FirebaseUserProfile.fromFirebaseUser(user);
    } catch (e) {
      debugPrint("❌ [Auth] Profil getirme hatası: $e");
      return null;
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // PROFİL FOTOĞRAFI
  // ═══════════════════════════════════════════════════════════════════════════

  /// Firebase Storage'a profil fotoğrafı yükle ve kullanıcı profilini güncelle
  /// Returns the download URL if successful, null otherwise
  Future<String?> updateProfilePhoto(File imageFile) async {
    debugPrint("📷 [Auth] Profil fotoğrafı yükleniyor...");

    final user = currentUser;
    if (user == null) {
      debugPrint("❌ [Auth] Kullanıcı oturumu yok");
      return null;
    }

    try {
      final storage = FirebaseStorage.instance;
      final fileName =
          'profile_${user.uid}_${DateTime.now().millisecondsSinceEpoch}.jpg';
      final ref = storage.ref().child('profile_photos/$fileName');

      // Dosyayı yükle
      final uploadTask = ref.putFile(
        imageFile,
        SettableMetadata(contentType: 'image/jpeg'),
      );

      // Yükleme tamamlanmasını bekle
      final snapshot = await uploadTask;
      final downloadUrl = await snapshot.ref.getDownloadURL();

      debugPrint("✅ [Auth] Fotoğraf yüklendi: $downloadUrl");

      // Firebase Auth profil fotoğrafını güncelle
      await user.updatePhotoURL(downloadUrl);

      // Firestore'da da güncelle
      await _firestore.collection('users').doc(user.uid).update({
        'photoUrl': downloadUrl,
        'updatedAt': FieldValue.serverTimestamp(),
      });

      debugPrint("✅ [Auth] Profil fotoğrafı güncellendi");
      return downloadUrl;
    } on FirebaseException catch (e) {
      debugPrint("❌ [Auth] Firebase Storage Hatası: ${e.code} - ${e.message}");
      return null;
    } catch (e) {
      debugPrint("❌ [Auth] Beklenmeyen fotoğraf yükleme hatası: $e");
      return null;
    }
  }

  /// Kullanıcı verilerini sil
  Future<void> _deleteUserData(String uid) async {
    try {
      debugPrint("🗑️ [Auth] Kullanıcı verileri siliniyor...");

      // Expenses subcollection
      final expenses = await _firestore
          .collection('users')
          .doc(uid)
          .collection('expenses')
          .get();

      final batch = _firestore.batch();

      for (final doc in expenses.docs) {
        batch.delete(doc.reference);
      }

      // Ana profil dökümanı
      batch.delete(_firestore.collection('users').doc(uid));

      await batch.commit();
      debugPrint("✅ [Auth] Kullanıcı verileri silindi");
    } catch (e) {
      debugPrint("❌ [Auth] Veri silme hatası: $e");
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // YARDIMCI METODLAR
  // ═══════════════════════════════════════════════════════════════════════════

  /// Firebase Auth hata mesajlarını Türkçe'ye çevir
  String _getAuthErrorMessage(String code) {
    switch (code) {
      case 'user-not-found':
        return 'Kullanıcı bulunamadı';
      case 'wrong-password':
        return 'Yanlış şifre';
      case 'email-already-in-use':
        return 'Bu e-posta zaten kullanımda';
      case 'invalid-email':
        return 'Geçersiz e-posta adresi';
      case 'weak-password':
        return 'Şifre çok zayıf';
      case 'operation-not-allowed':
        return 'Bu giriş yöntemi etkin değil';
      case 'account-exists-with-different-credential':
        return 'Bu e-posta farklı bir giriş yöntemiyle kayıtlı';
      case 'credential-already-in-use':
        return 'Bu hesap başka bir kullanıcıya bağlı';
      case 'requires-recent-login':
        return 'Bu işlem için yeniden giriş yapın';
      case 'network-request-failed':
        return 'İnternet bağlantısı yok';
      case 'too-many-requests':
        return 'Çok fazla deneme. Lütfen bekleyin';
      case 'user-disabled':
        return 'Bu hesap devre dışı bırakılmış';
      default:
        return 'Bir hata oluştu ($code)';
    }
  }

  /// Debug: Auth durumunu yazdır
  void debugAuthStatus() {
    final user = currentUser;
    debugPrint("═══════════════════════════════════════════════════════════");
    debugPrint("🔍 [DEBUG] Auth Durumu:");
    debugPrint("   Giriş yapılmış: ${isSignedIn ? 'Evet' : 'Hayır'}");
    debugPrint("   UID: ${user?.uid ?? 'null'}");
    debugPrint("   Anonim: ${isAnonymous ? 'Evet' : 'Hayır'}");
    debugPrint("   Google bağlı: ${isLinkedWithGoogle ? 'Evet' : 'Hayır'}");
    debugPrint("   Email: ${user?.email ?? 'Yok'}");
    debugPrint("   İsim: ${user?.displayName ?? 'Yok'}");
    debugPrint(
      "   Providers: ${user?.providerData.map((p) => p.providerId).join(', ') ?? 'Yok'}",
    );
    debugPrint("═══════════════════════════════════════════════════════════");
  }
}


--- FILE: lib/services/ai_tools.dart ---

/// Vantag AI'nın kullanabileceği tüm tool tanımları (OpenAI Function Calling formatı)
class AITools {
  /// Tüm tool'ları OpenAI formatında döndür
  static List<Map<String, dynamic>> getAllTools() {
    return [
      // OKUMA TOOL'LARI
      _getExpensesSummary,
      _getCategoryBreakdown,
      _getSubscriptions,
      _getBudgetStatus,
      _getThinkingItems,
      _getSavedItems,

      // YAZMA TOOL'LARI
      _addExpense,
      _updateExpenseDecision,

      // HESAPLAMA TOOL'LARI
      _calculateSavingsPlan,
      _calculateHourlyEquivalent,
      _compareWithAlternative,
    ];
  }

  // ==========================================
  // OKUMA TOOL'LARI
  // ==========================================

  static final Map<String, dynamic> _getExpensesSummary = {
    'type': 'function',
    'function': {
      'name': 'get_expenses_summary',
      'description':
          'Bu ayki harcamaların özetini getirir: toplam harcama, kategori dağılımı, geçen ayla karşılaştırma',
      'parameters': {'type': 'object', 'properties': {}, 'required': []},
    },
  };

  static final Map<String, dynamic> _getCategoryBreakdown = {
    'type': 'function',
    'function': {
      'name': 'get_category_breakdown',
      'description': 'Belirli bir kategorideki harcamaların detayını getirir',
      'parameters': {
        'type': 'object',
        'properties': {
          'category': {
            'type': 'string',
            'description':
                'Kategori adı: Yiyecek, Ulaşım, Giyim, Elektronik, Eğlence, Sağlık, Eğitim, Faturalar, Abonelik, Diğer',
          },
        },
        'required': ['category'],
      },
    },
  };

  static final Map<String, dynamic> _getSubscriptions = {
    'type': 'function',
    'function': {
      'name': 'get_subscriptions',
      'description':
          'Tüm aktif abonelikleri listeler: isim, tutar, yenileme günü',
      'parameters': {'type': 'object', 'properties': {}, 'required': []},
    },
  };

  static final Map<String, dynamic> _getBudgetStatus = {
    'type': 'function',
    'function': {
      'name': 'get_budget_status',
      'description': 'Bütçe durumunu getirir: gelir, harcama, kalan, yüzde',
      'parameters': {'type': 'object', 'properties': {}, 'required': []},
    },
  };

  static final Map<String, dynamic> _getThinkingItems = {
    'type': 'function',
    'function': {
      'name': 'get_thinking_items',
      'description': 'Düşünüyorum listesindeki bekleyen harcamaları getirir',
      'parameters': {'type': 'object', 'properties': {}, 'required': []},
    },
  };

  static final Map<String, dynamic> _getSavedItems = {
    'type': 'function',
    'function': {
      'name': 'get_saved_items',
      'description':
          'Vazgeçilen harcamaları (irade zaferleri) ve Smart Choice tasarruflarını getirir',
      'parameters': {'type': 'object', 'properties': {}, 'required': []},
    },
  };

  // ==========================================
  // YAZMA TOOL'LARI
  // ==========================================

  static final Map<String, dynamic> _addExpense = {
    'type': 'function',
    'function': {
      'name': 'add_expense',
      'description':
          'Yeni harcama kaydı ekler. Kullanıcı bir harcama yaptığını söylediğinde bu tool kullanılır. Eğer duplicate_found: true dönerse, kullanıcıya sor ve onaylarsa force: true ile tekrar çağır.',
      'parameters': {
        'type': 'object',
        'properties': {
          'amount': {'type': 'number', 'description': 'Harcama tutarı'},
          'category': {
            'type': 'string',
            'description':
                'Kategori: Yiyecek, Ulaşım, Giyim, Elektronik, Eğlence, Sağlık, Eğitim, Faturalar, Abonelik, Diğer',
          },
          'description': {
            'type': 'string',
            'description': 'Harcama açıklaması (opsiyonel)',
          },
          'decision': {
            'type': 'string',
            'description':
                'Karar: yes (aldım), thinking (düşünüyorum), no (vazgeçtim)',
          },
          'currency': {
            'type': 'string',
            'description':
                'Para birimi kodu: TRY, USD, EUR, GBP. Belirtilmezse varsayılan kullanıcı para birimi kullanılır.',
          },
          'force': {
            'type': 'boolean',
            'description':
                'Duplicate uyarısını görmezden gel ve ekle (kullanıcı onayladıysa true yap)',
          },
        },
        'required': ['amount', 'category', 'decision'],
      },
    },
  };

  static final Map<String, dynamic> _updateExpenseDecision = {
    'type': 'function',
    'function': {
      'name': 'update_expense_decision',
      'description':
          'Düşünüyorum listesindeki bir harcamanın kararını günceller',
      'parameters': {
        'type': 'object',
        'properties': {
          'expense_description': {
            'type': 'string',
            'description': 'Harcamanın açıklaması veya kategorisi',
          },
          'new_decision': {
            'type': 'string',
            'description': 'Yeni karar: yes (aldım) veya no (vazgeçtim)',
          },
        },
        'required': ['expense_description', 'new_decision'],
      },
    },
  };

  // ==========================================
  // HESAPLAMA TOOL'LARI
  // ==========================================

  static final Map<String, dynamic> _calculateSavingsPlan = {
    'type': 'function',
    'function': {
      'name': 'calculate_savings_plan',
      'description': 'Belirli bir hedefe ulaşmak için tasarruf planı hesaplar',
      'parameters': {
        'type': 'object',
        'properties': {
          'target_amount': {
            'type': 'number',
            'description': 'Hedef tutar (TL)',
          },
          'target_months': {
            'type': 'integer',
            'description': 'Hedef süre (ay)',
          },
          'purpose': {
            'type': 'string',
            'description': 'Tasarruf amacı (opsiyonel)',
          },
        },
        'required': ['target_amount', 'target_months'],
      },
    },
  };

  static final Map<String, dynamic> _calculateHourlyEquivalent = {
    'type': 'function',
    'function': {
      'name': 'calculate_hourly_equivalent',
      'description':
          'Bir tutarın kaç saatlik çalışmaya denk geldiğini hesaplar',
      'parameters': {
        'type': 'object',
        'properties': {
          'amount': {
            'type': 'number',
            'description': 'Hesaplanacak tutar (TL)',
          },
        },
        'required': ['amount'],
      },
    },
  };

  static final Map<String, dynamic> _compareWithAlternative = {
    'type': 'function',
    'function': {
      'name': 'compare_with_alternative',
      'description':
          'Bir harcamayı alternatif yatırım seçenekleriyle karşılaştırır (altın, faiz, vb.)',
      'parameters': {
        'type': 'object',
        'properties': {
          'amount': {
            'type': 'number',
            'description': 'Karşılaştırılacak tutar (TL)',
          },
          'alternative': {
            'type': 'string',
            'description':
                'Alternatif: gold (altın), interest (faiz), savings (birikim)',
          },
          'period_months': {
            'type': 'integer',
            'description': 'Karşılaştırma süresi (ay)',
          },
        },
        'required': ['amount', 'alternative', 'period_months'],
      },
    },
  };
}


--- FILE: lib/services/sensory_feedback_service.dart ---

import 'package:flutter/services.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:vantag/theme/app_theme.dart';

/// Wealth Coach: Risk Seviyeleri
enum RiskLevel {
  none, // %0-10 - Risk yok
  low, // %10-15 - Düşük risk
  medium, // %15-25 - Orta risk
  high, // %25+ - Yüksek risk
  extreme; // %50+ - Ekstrem risk

  String get label {
    switch (this) {
      case RiskLevel.none:
        return 'Güvenli';
      case RiskLevel.low:
        return 'Düşük Risk';
      case RiskLevel.medium:
        return 'Orta Risk';
      case RiskLevel.high:
        return 'Yüksek Risk';
      case RiskLevel.extreme:
        return 'Kritik Risk';
    }
  }

  String get emoji {
    switch (this) {
      case RiskLevel.none:
        return '';
      case RiskLevel.low:
        return '';
      case RiskLevel.medium:
        return '';
      case RiskLevel.high:
        return '';
      case RiskLevel.extreme:
        return '';
    }
  }

  /// Geri sayım süresi (saniye)
  int get countdownSeconds {
    switch (this) {
      case RiskLevel.none:
      case RiskLevel.low:
        return 0; // Geri sayım yok
      case RiskLevel.medium:
        return 2;
      case RiskLevel.high:
        return 3;
      case RiskLevel.extreme:
        return 5;
    }
  }

  /// Arka plan renk yoğunluğu (0.0 - 1.0)
  double get backgroundIntensity {
    switch (this) {
      case RiskLevel.none:
        return 0.0;
      case RiskLevel.low:
        return 0.15;
      case RiskLevel.medium:
        return 0.35;
      case RiskLevel.high:
        return 0.55;
      case RiskLevel.extreme:
        return 0.75;
    }
  }
}

/// Wealth Coach: Sensory Feedback Manager
/// Haptic, ses ve görsel feedback merkezi yönetimi
class SensoryFeedbackManager {
  static final SensoryFeedbackManager _instance =
      SensoryFeedbackManager._internal();
  factory SensoryFeedbackManager() => _instance;
  SensoryFeedbackManager._internal();

  // Ayarlar
  bool _hapticEnabled = true;
  bool _soundEnabled = true;
  bool _visualFeedbackEnabled = true;

  // Kullanıcı finansal verileri (cache)
  double _hourlyRate = 100.0; // Varsayılan saatlik ücret
  double _monthlyIncome = 10000.0; // Varsayılan aylık gelir

  // Preference keys
  static const _keyHapticEnabled = 'sensory_haptic_enabled';
  static const _keySoundEnabled = 'sensory_sound_enabled';
  static const _keyVisualEnabled = 'sensory_visual_enabled';

  // Son tetiklenen tutar (performans için)
  double _lastTriggeredAmount = 0;
  int _lastTriggeredDigits = 0;

  /// Servisi başlat
  Future<void> init() async {
    final prefs = await SharedPreferences.getInstance();
    _hapticEnabled = prefs.getBool(_keyHapticEnabled) ?? true;
    _soundEnabled = prefs.getBool(_keySoundEnabled) ?? true;
    _visualFeedbackEnabled = prefs.getBool(_keyVisualEnabled) ?? true;
  }

  /// Kullanıcı finansal verilerini güncelle
  void updateFinancials({double? hourlyRate, double? monthlyIncome}) {
    if (hourlyRate != null) _hourlyRate = hourlyRate;
    if (monthlyIncome != null) _monthlyIncome = monthlyIncome;
  }

  // ==================== HAPTIC FEEDBACK ====================

  /// Tutar bazlı haptic feedback
  /// Sadece basamak değişiminde tetiklenir (performans)
  void triggerHapticForAmount(double amount) {
    if (!_hapticEnabled) return;

    // Basamak kontrolü (performans için)
    final digits = amount.toInt().toString().length;
    if (digits == _lastTriggeredDigits &&
        (amount - _lastTriggeredAmount).abs() < 50) {
      return; // Aynı basamakta küçük değişiklik, tetikleme
    }

    _lastTriggeredAmount = amount;
    _lastTriggeredDigits = digits;

    // Tutar bazlı haptic seçimi
    if (amount <= 100) {
      HapticFeedback.selectionClick();
    } else if (amount <= 500) {
      HapticFeedback.lightImpact();
    } else if (amount <= 1000) {
      HapticFeedback.mediumImpact();
    } else {
      HapticFeedback.heavyImpact();
    }
  }

  /// Karar anı haptic feedback
  void triggerDecisionHaptic(bool isPositive) {
    if (!_hapticEnabled) return;

    if (isPositive) {
      // Olumlu karar (vazgeçtim)
      HapticFeedback.mediumImpact();
      Future.delayed(const Duration(milliseconds: 100), () {
        HapticFeedback.lightImpact();
      });
    } else {
      // Olumsuz karar (aldım - büyük harcama)
      HapticFeedback.heavyImpact();
    }
  }

  /// Geri sayım tick haptic
  void triggerCountdownTick() {
    if (!_hapticEnabled) return;
    HapticFeedback.selectionClick();
  }

  /// Başarı haptic (golden glow anı)
  void triggerSuccessHaptic() {
    if (!_hapticEnabled) return;
    HapticFeedback.mediumImpact();
    Future.delayed(const Duration(milliseconds: 150), () {
      HapticFeedback.lightImpact();
    });
  }

  // ==================== RISK HESAPLAMA ====================

  /// Tutar için risk seviyesi hesapla
  RiskLevel getRiskLevel(double amount) {
    if (_monthlyIncome <= 0) return RiskLevel.none;

    final percentage = (amount / _monthlyIncome) * 100;

    if (percentage >= 50) return RiskLevel.extreme;
    if (percentage >= 25) return RiskLevel.high;
    if (percentage >= 15) return RiskLevel.medium;
    if (percentage >= 10) return RiskLevel.low;
    return RiskLevel.none;
  }

  /// Tutar için çalışma süresi hesapla
  Duration getWorkDuration(double amount) {
    if (_hourlyRate <= 0) return Duration.zero;
    final hours = amount / _hourlyRate;
    return Duration(minutes: (hours * 60).round());
  }

  /// Özgürlük hedefi gecikme günü hesapla
  int getFreedomDelayDays(double amount) {
    // Basit hesaplama: Aylık tasarruf hedefinin %20'si varsayılan
    final monthlyTarget = _monthlyIncome * 0.2;
    if (monthlyTarget <= 0) return 0;
    return (amount / (monthlyTarget / 30)).round();
  }

  /// Risk uyarı mesajı oluştur
  String getRiskWarningMessage(double amount) {
    final riskLevel = getRiskLevel(amount);
    final workDuration = getWorkDuration(amount);
    final delayDays = getFreedomDelayDays(amount);
    final percentage = (_monthlyIncome > 0)
        ? ((amount / _monthlyIncome) * 100).toStringAsFixed(1)
        : '0';

    switch (riskLevel) {
      case RiskLevel.none:
        return '';
      case RiskLevel.low:
        return 'Bu harcama özgürlük hedefini $delayDays gün geriye çeker';
      case RiskLevel.medium:
        return 'Bu harcama için ${_formatDuration(workDuration)} çalışman gerekiyor. Özgürlük hedefin $delayDays gün gecikecek.';
      case RiskLevel.high:
        return 'Bu harcama aylık gelirinin %$percentage\'i! Özgürlük hedefin $delayDays gün geriye gidecek.';
      case RiskLevel.extreme:
        return 'DİKKAT! Bu harcama aylık gelirinin %$percentage\'i! Bu karar finansal özgürlüğünü ciddi şekilde etkileyecek.';
    }
  }

  String _formatDuration(Duration duration) {
    if (duration.inDays > 0) {
      return '${duration.inDays} gün ${duration.inHours % 24} saat';
    } else if (duration.inHours > 0) {
      return '${duration.inHours} saat ${duration.inMinutes % 60} dakika';
    } else {
      return '${duration.inMinutes} dakika';
    }
  }

  // ==================== GÖRSEL FEEDBACK ====================

  /// Blood-Pressure arka plan rengi hesapla
  Color getBackgroundColor(
    double amount, {
    Color baseColor = AppColors.background,
  }) {
    if (!_visualFeedbackEnabled) return baseColor;

    final riskLevel = getRiskLevel(amount);
    final intensity = riskLevel.backgroundIntensity;

    if (intensity <= 0) return baseColor;

    // Kırmızı tonuna geçiş
    const dangerColor = AppColors.categoryBills;
    return Color.lerp(baseColor, dangerColor, intensity)!;
  }

  /// Tutar için arka plan gradient oluştur
  List<Color> getBackgroundGradient(double amount) {
    if (!_visualFeedbackEnabled) {
      return [AppColors.gradientStart, AppColors.gradientMid];
    }

    final riskLevel = getRiskLevel(amount);
    final intensity = riskLevel.backgroundIntensity;

    const baseStart = AppColors.gradientStart;
    const baseEnd = AppColors.gradientMid;
    const dangerStart = AppColors.dangerGradientStart;
    const dangerEnd = AppColors.dangerGradientEnd;

    return [
      Color.lerp(baseStart, dangerStart, intensity)!,
      Color.lerp(baseEnd, dangerEnd, intensity)!,
    ];
  }

  /// Tutar alanı border rengi
  Color getAmountBorderColor(double amount) {
    if (!_visualFeedbackEnabled) return AppColors.divider;

    final riskLevel = getRiskLevel(amount);

    switch (riskLevel) {
      case RiskLevel.none:
        return AppColors.divider;
      case RiskLevel.low:
        return AppColors.medalGold.withValues(alpha: 0.5);
      case RiskLevel.medium:
        return AppColors.categoryEducation.withValues(alpha: 0.6);
      case RiskLevel.high:
        return AppColors.categoryBills.withValues(alpha: 0.7);
      case RiskLevel.extreme:
        return AppColors.categoryBills;
    }
  }

  // ==================== AYARLAR ====================

  bool get hapticEnabled => _hapticEnabled;
  bool get soundEnabled => _soundEnabled;
  bool get visualFeedbackEnabled => _visualFeedbackEnabled;

  Future<void> setHapticEnabled(bool value) async {
    _hapticEnabled = value;
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_keyHapticEnabled, value);
  }

  Future<void> setSoundEnabled(bool value) async {
    _soundEnabled = value;
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_keySoundEnabled, value);
  }

  Future<void> setVisualFeedbackEnabled(bool value) async {
    _visualFeedbackEnabled = value;
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_keyVisualEnabled, value);
  }

  /// Haptic feedback sıfırla (yeni giriş için)
  void resetHapticState() {
    _lastTriggeredAmount = 0;
    _lastTriggeredDigits = 0;
  }
}

/// Global erişim için kısayol
final sensoryFeedback = SensoryFeedbackManager();


--- FILE: lib/services/haptic_service.dart ---

import 'package:flutter/services.dart';
import 'package:shared_preferences/shared_preferences.dart';

/// Centralized haptic feedback service with standardized patterns
class HapticService {
  static final HapticService _instance = HapticService._internal();
  factory HapticService() => _instance;
  HapticService._internal();

  static const _keyEnabled = 'haptic_enabled';
  bool _enabled = true;

  bool get enabled => _enabled;

  /// Initialize service
  Future<void> init() async {
    final prefs = await SharedPreferences.getInstance();
    _enabled = prefs.getBool(_keyEnabled) ?? true;
  }

  /// Toggle haptic feedback
  Future<void> setEnabled(bool value) async {
    _enabled = value;
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_keyEnabled, value);
  }

  // ==================== STANDARD PATTERNS ====================

  /// Light tap - for small interactions (toggles, selections)
  void tap() {
    if (!_enabled) return;
    HapticFeedback.selectionClick();
  }

  /// Selection click - for list/grid item selections
  void selection() {
    if (!_enabled) return;
    HapticFeedback.selectionClick();
  }

  /// Light impact - for button presses
  void light() {
    if (!_enabled) return;
    HapticFeedback.lightImpact();
  }

  /// Medium impact - for confirmations, transitions
  void medium() {
    if (!_enabled) return;
    HapticFeedback.mediumImpact();
  }

  /// Heavy impact - for important actions, warnings
  void heavy() {
    if (!_enabled) return;
    HapticFeedback.heavyImpact();
  }

  // ==================== SEMANTIC PATTERNS ====================

  /// Success feedback - double tap pattern
  void success() {
    if (!_enabled) return;
    HapticFeedback.mediumImpact();
    Future.delayed(const Duration(milliseconds: 100), () {
      HapticFeedback.lightImpact();
    });
  }

  /// Error feedback - heavy single
  void error() {
    if (!_enabled) return;
    HapticFeedback.heavyImpact();
  }

  /// Warning feedback - double heavy
  void warning() {
    if (!_enabled) return;
    HapticFeedback.mediumImpact();
    Future.delayed(const Duration(milliseconds: 150), () {
      HapticFeedback.heavyImpact();
    });
  }

  /// Notification feedback - light triple
  void notification() {
    if (!_enabled) return;
    HapticFeedback.lightImpact();
    Future.delayed(const Duration(milliseconds: 80), () {
      HapticFeedback.selectionClick();
    });
    Future.delayed(const Duration(milliseconds: 160), () {
      HapticFeedback.lightImpact();
    });
  }

  // ==================== CONTEXTUAL PATTERNS ====================

  /// Button press feedback
  void buttonPress() {
    if (!_enabled) return;
    HapticFeedback.mediumImpact();
  }

  /// Navigation change
  void navigation() {
    if (!_enabled) return;
    HapticFeedback.selectionClick();
  }

  /// Pull to refresh
  void refresh() {
    if (!_enabled) return;
    HapticFeedback.mediumImpact();
  }

  /// Swipe action
  void swipe() {
    if (!_enabled) return;
    HapticFeedback.lightImpact();
  }

  /// Delete action
  void delete() {
    if (!_enabled) return;
    HapticFeedback.heavyImpact();
  }

  /// Achievement unlocked
  void achievement() {
    if (!_enabled) return;
    HapticFeedback.heavyImpact();
    Future.delayed(const Duration(milliseconds: 100), () {
      HapticFeedback.mediumImpact();
    });
    Future.delayed(const Duration(milliseconds: 200), () {
      HapticFeedback.lightImpact();
    });
  }

  /// Celebration (confetti, victory)
  void celebrate() {
    if (!_enabled) return;
    // Rapid succession of light taps
    for (int i = 0; i < 3; i++) {
      Future.delayed(Duration(milliseconds: i * 80), () {
        HapticFeedback.lightImpact();
      });
    }
    Future.delayed(const Duration(milliseconds: 300), () {
      HapticFeedback.mediumImpact();
    });
  }

  /// Slider tick
  void tick() {
    if (!_enabled) return;
    HapticFeedback.selectionClick();
  }

  /// Modal open
  void modalOpen() {
    if (!_enabled) return;
    HapticFeedback.lightImpact();
  }

  /// Modal close
  void modalClose() {
    if (!_enabled) return;
    HapticFeedback.selectionClick();
  }

  /// Long press start
  void longPressStart() {
    if (!_enabled) return;
    HapticFeedback.mediumImpact();
  }

  /// Drag start
  void dragStart() {
    if (!_enabled) return;
    HapticFeedback.lightImpact();
  }

  /// Drag end / drop
  void dragEnd() {
    if (!_enabled) return;
    HapticFeedback.mediumImpact();
  }
}

/// Global instance for easy access
final haptics = HapticService();


--- FILE: lib/services/promo_service.dart ---

import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:flutter/foundation.dart';
import 'package:shared_preferences/shared_preferences.dart';

/// Result of promo code validation
class PromoResult {
  final bool isValid;
  final int? daysGranted;
  final String? errorMessage;
  final String? promoType;

  const PromoResult({
    required this.isValid,
    this.daysGranted,
    this.errorMessage,
    this.promoType,
  });

  factory PromoResult.success(int days, String type) => PromoResult(
        isValid: true,
        daysGranted: days,
        promoType: type,
      );

  factory PromoResult.error(String message) => PromoResult(
        isValid: false,
        errorMessage: message,
      );
}

/// Service for handling promotional codes
class PromoService {
  static final PromoService _instance = PromoService._internal();
  factory PromoService() => _instance;
  PromoService._internal();

  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  static const String _promoExpiryKey = 'promo_expiry_date';
  static const String _usedPromoCodesKey = 'used_promo_codes';

  /// Validate and apply a promo code
  Future<PromoResult> redeemPromoCode(String code, String userId) async {
    try {
      final normalizedCode = code.trim().toUpperCase();

      // Check if already used
      if (await _isCodeUsedByUser(normalizedCode, userId)) {
        return PromoResult.error('codeAlreadyUsed');
      }

      // Fetch code from Firestore
      final doc = await _firestore.collection('promo_codes').doc(normalizedCode).get();

      if (!doc.exists) {
        return PromoResult.error('invalidCode');
      }

      final data = doc.data()!;
      final isActive = data['isActive'] as bool? ?? false;
      final maxUses = data['maxUses'] as int? ?? 0;
      final currentUses = data['usedCount'] as int? ?? 0;
      final expiryDate = (data['expiryDate'] as Timestamp?)?.toDate();
      final daysGranted = data['daysGranted'] as int? ?? 7;
      final promoType = data['type'] as String? ?? 'pro_trial';

      // Validate code
      if (!isActive) {
        return PromoResult.error('codeExpired');
      }

      if (maxUses > 0 && currentUses >= maxUses) {
        return PromoResult.error('codeLimitReached');
      }

      if (expiryDate != null && DateTime.now().isAfter(expiryDate)) {
        return PromoResult.error('codeExpired');
      }

      // Apply the promo
      await _applyPromo(normalizedCode, userId, daysGranted);

      // Update usage count
      await _firestore.collection('promo_codes').doc(normalizedCode).update({
        'usedCount': FieldValue.increment(1),
        'usedBy': FieldValue.arrayUnion([userId]),
      });

      return PromoResult.success(daysGranted, promoType);
    } catch (e) {
      debugPrint('[PromoService] Error redeeming code: $e');
      return PromoResult.error('unknownError');
    }
  }

  /// Check if code was already used by this user
  Future<bool> _isCodeUsedByUser(String code, String userId) async {
    final prefs = await SharedPreferences.getInstance();
    final usedCodes = prefs.getStringList(_usedPromoCodesKey) ?? [];
    return usedCodes.contains('$code:$userId');
  }

  /// Apply promo days to user
  Future<void> _applyPromo(String code, String userId, int days) async {
    final prefs = await SharedPreferences.getInstance();

    // Get current expiry or use now
    final currentExpiryStr = prefs.getString(_promoExpiryKey);
    DateTime baseDate;
    if (currentExpiryStr != null) {
      final currentExpiry = DateTime.parse(currentExpiryStr);
      baseDate = currentExpiry.isAfter(DateTime.now()) ? currentExpiry : DateTime.now();
    } else {
      baseDate = DateTime.now();
    }

    // Add days
    final newExpiry = baseDate.add(Duration(days: days));
    await prefs.setString(_promoExpiryKey, newExpiry.toIso8601String());

    // Mark code as used
    final usedCodes = prefs.getStringList(_usedPromoCodesKey) ?? [];
    usedCodes.add('$code:$userId');
    await prefs.setStringList(_usedPromoCodesKey, usedCodes);
  }

  /// Check if user has active promo subscription
  Future<bool> hasActivePromo() async {
    final prefs = await SharedPreferences.getInstance();
    final expiryStr = prefs.getString(_promoExpiryKey);
    if (expiryStr == null) return false;

    final expiry = DateTime.parse(expiryStr);
    return DateTime.now().isBefore(expiry);
  }

  /// Get promo expiry date
  Future<DateTime?> getPromoExpiry() async {
    final prefs = await SharedPreferences.getInstance();
    final expiryStr = prefs.getString(_promoExpiryKey);
    if (expiryStr == null) return null;
    return DateTime.parse(expiryStr);
  }

  /// Get remaining promo days
  Future<int> getRemainingPromoDays() async {
    final expiry = await getPromoExpiry();
    if (expiry == null) return 0;

    final remaining = expiry.difference(DateTime.now()).inDays;
    return remaining > 0 ? remaining : 0;
  }
}

/// Global instance
final promoService = PromoService();


--- FILE: lib/services/device_service.dart ---

import 'dart:io';
import 'package:flutter/foundation.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:shared_preferences/shared_preferences.dart';

/// Device token mismatch result
enum DeviceCheckResult {
  /// Token matches - this is the active device
  valid,

  /// Token doesn't match - logged in from another device
  anotherDeviceLoggedIn,

  /// No user logged in
  notLoggedIn,

  /// Error occurred during check
  error,
}

/// Service for single device policy enforcement
/// Ensures only one device can be logged in at a time per user
class DeviceService {
  static final DeviceService _instance = DeviceService._internal();
  factory DeviceService() => _instance;
  DeviceService._internal();

  static const String _deviceTokenKey = 'device_token';
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final FirebaseAuth _auth = FirebaseAuth.instance;

  String? _cachedDeviceToken;

  /// Get or generate a unique device token for this device
  Future<String> getDeviceToken() async {
    // Return cached token if available
    if (_cachedDeviceToken != null) {
      return _cachedDeviceToken!;
    }

    final prefs = await SharedPreferences.getInstance();
    String? token = prefs.getString(_deviceTokenKey);

    // Generate new token if not exists
    if (token == null || token.isEmpty) {
      token = _generateDeviceToken();
      await prefs.setString(_deviceTokenKey, token);
      debugPrint(
        '📱 [Device] New device token generated: ${token.substring(0, 8)}...',
      );
    }

    _cachedDeviceToken = token;
    return token;
  }

  /// Generate a unique device token
  String _generateDeviceToken() {
    final timestamp = DateTime.now().millisecondsSinceEpoch;
    final platform = Platform.isAndroid
        ? 'android'
        : (Platform.isIOS ? 'ios' : 'other');
    final random = DateTime.now().microsecondsSinceEpoch.toString();
    return '${platform}_${timestamp}_$random';
  }

  /// Register this device as the active device for the user
  /// Call this after successful login
  Future<void> registerDevice() async {
    final user = _auth.currentUser;
    if (user == null) {
      debugPrint('⚠️ [Device] No user to register device for');
      return;
    }

    try {
      final deviceToken = await getDeviceToken();

      await _firestore.collection('users').doc(user.uid).set({
        'currentDevice': deviceToken,
        'lastDeviceLoginAt': FieldValue.serverTimestamp(),
        'devicePlatform': Platform.isAndroid
            ? 'android'
            : (Platform.isIOS ? 'ios' : 'other'),
      }, SetOptions(merge: true));

      debugPrint(
        '✅ [Device] Device registered for user ${user.uid.substring(0, 8)}...',
      );
    } catch (e) {
      debugPrint('❌ [Device] Failed to register device: $e');
    }
  }

  /// Check if this device is still the active device for the user
  /// Returns DeviceCheckResult indicating the status
  Future<DeviceCheckResult> checkDeviceStatus() async {
    final user = _auth.currentUser;
    if (user == null) {
      return DeviceCheckResult.notLoggedIn;
    }

    // Skip check for anonymous users
    if (user.isAnonymous) {
      return DeviceCheckResult.valid;
    }

    try {
      final deviceToken = await getDeviceToken();
      final doc = await _firestore.collection('users').doc(user.uid).get();

      if (!doc.exists) {
        // No Firestore record yet, register this device
        await registerDevice();
        return DeviceCheckResult.valid;
      }

      final data = doc.data();
      final serverToken = data?['currentDevice'] as String?;

      if (serverToken == null) {
        // No device registered, register this one
        await registerDevice();
        return DeviceCheckResult.valid;
      }

      if (serverToken == deviceToken) {
        debugPrint(
          '✅ [Device] Device token matches - this is the active device',
        );
        return DeviceCheckResult.valid;
      } else {
        debugPrint('⚠️ [Device] Device token mismatch!');
        debugPrint('   Local: ${deviceToken.substring(0, 8)}...');
        debugPrint('   Server: ${serverToken.substring(0, 8)}...');
        return DeviceCheckResult.anotherDeviceLoggedIn;
      }
    } catch (e) {
      debugPrint('❌ [Device] Error checking device status: $e');
      return DeviceCheckResult.error;
    }
  }

  /// Clear device token from Firestore on sign out
  Future<void> clearDeviceOnSignOut() async {
    final user = _auth.currentUser;
    if (user == null) return;

    try {
      final deviceToken = await getDeviceToken();
      final doc = await _firestore.collection('users').doc(user.uid).get();

      // Only clear if this device is the current one
      // (don't clear if we're being kicked out by another device)
      final serverToken = doc.data()?['currentDevice'] as String?;
      if (serverToken == deviceToken) {
        await _firestore.collection('users').doc(user.uid).update({
          'currentDevice': FieldValue.delete(),
          'lastDeviceLoginAt': FieldValue.delete(),
        });
        debugPrint('✅ [Device] Device token cleared from Firestore');
      }
    } catch (e) {
      debugPrint('⚠️ [Device] Failed to clear device token: $e');
    }
  }

  /// Listen to device changes in real-time
  /// Returns a stream that emits true when another device logs in
  Stream<bool> watchDeviceChanges() {
    final user = _auth.currentUser;
    if (user == null || user.isAnonymous) {
      return Stream.value(false);
    }

    return _firestore.collection('users').doc(user.uid).snapshots().asyncMap((
      snapshot,
    ) async {
      if (!snapshot.exists) return false;

      final serverToken = snapshot.data()?['currentDevice'] as String?;
      if (serverToken == null) return false;

      final localToken = await getDeviceToken();
      return serverToken != localToken;
    });
  }
}


--- FILE: lib/services/notification_service.dart ---

import 'dart:io';
import 'dart:math';
import 'package:flutter_local_notifications/flutter_local_notifications.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:timezone/timezone.dart' as tz;
import 'package:timezone/data/latest.dart' as tz_data;
import '../utils/currency_utils.dart';

// ============================================
// BİLDİRİM TÜRLERİ
// ============================================

enum NotificationType {
  delayedAwareness, // Gecikmiş farkındalık (aldım sonrası)
  reinforceDecision, // Vazgeçmeyi güçlendirme
  streakReminder, // Streak hatırlatma
  weeklyInsight, // Haftalık içgörü
  subscriptionReminder, // Abonelik yenileme hatırlatma
}

// ============================================
// BİLDİRİM MESAJ HAVUZLARI
// ============================================

class NotificationMessages {
  static final _random = Random();

  // Gecikmiş Farkındalık (Aldım sonrası 6-12 saat) - 10-20 kelime
  static const delayedAwareness = [
    'Bugün aldığın şey hala aynı heyecanı veriyor mu, yoksa heves geçti mi?',
    'Aldığın ürünü kullandın mı? Beklentilerini karşıladı mı merak ediyoruz.',
    'O alışveriş beklediğin gibi miydi? Bir an düşün ve değerlendir.',
    'Aradan saatler geçti. Hala memnun musun aldığın şeyle?',
    'Düşündüğün kadar gerekli miymiş? Şimdi geriye bakınca ne hissediyorsun?',
    'Aynı kararı tekrar verir miydin? Bir düşün, cevabını kendin bil.',
    'O ürün hayatına gerçek bir değer kattı mı, yoksa sadece anlık bir hevesti?',
    'Peki şimdi nasıl hissediyorsun? O para iyi harcanmış gibi mi geliyor?',
    'Aldığın şey beklentini karşıladı mı? Yoksa hayal kırıklığı mı yaşadın?',
    'Tekrar düşünsen yine alır mıydın? Cevabın sana çok şey söyleyecek.',
    'Birkaç saat önce harcadığın para, şimdi hala iyi bir karar gibi mi görünüyor?',
    'Aldığın şeyi ne kadar kullandın? Gerçekten ihtiyacın var mıydı?',
  ];

  // Vazgeçmeyi Güçlendirme (aynı gün) - 10-20 kelime
  static const reinforceDecision = [
    'Bugün kendin için iyi bir karar verdin. O para şimdi seninle kalıyor.',
    'Bir adım geri atabilmek güç ister. Bunu başardığın için kendini kutla.',
    'O parayı cebinde tutmayı başardın. Gelecekte bunun için teşekkür edeceksin.',
    'Dürtülerine karşı koydun, tebrikler. Bu küçük zaferler büyük farklar yaratır.',
    'Gelecekteki sen bugün için minnettardır. Akıllı bir karar verdin.',
    'Gereksiz bir harcamayı önledin. Bu paranı daha önemli şeylere ayırabilirsin.',
    'Bugün irade kazandı. Her vazgeçiş, finansal özgürlüğe bir adım daha yaklaştırır.',
    'Kolay olan almaktı, zor olanı seçtin. Bu karakter gücü göstergesi.',
    'Her hayır, geleceğine evet demektir. Bugün kendine yatırım yaptın.',
    'Kurtardığın her kuruş bir kazançtır. Küçük adımlar büyük sonuçlar doğurur.',
    'Bugün akıllıca davrandın. Bilinçli tüketici olma yolunda ilerliyorsun.',
    'Kontrolü elinde tuttun. Paraya değil, para sana hizmet etmeli.',
    'Paranın değerini biliyorsun. Bu farkındalık seni öne taşıyacak.',
  ];

  // Streak Hatırlatma (akşam, giriş yoksa) - 10-20 kelime
  static const streakReminder = [
    'Bugünkü zinciri koparmamak ister misin? Birkaç dakikan yeterli, serin devam etsin.',
    'Serilerin devam etmek için seni bekliyor. Gün bitmeden bir kayıt eklemeyi unutma.',
    'Günü kaydetmeden bitirme. O kadar emek verdikten sonra seriyi kaybetme.',
    'Bugün henüz bir şey girmedin. Küçük bir kayıt bile serin için yeterli.',
    'Serin tehlikede, bir göz at. Birkaç saniyeni ayırıp günü kaydet.',
    'Günlük alışkanlığını unutma. Her gün takip etmek başarının anahtarı.',
    'Bugün de kayıt tutmak ister misin? Düzenli takip, bilinçli harcamanın ilk adımı.',
    'Seriyi sürdürmek için son şans. Gece olmadan bir giriş yap.',
    'Bir dakikanı ayır, günü kaydet. O kadar güzel gidiyordun, devam et.',
    'Bugünü atlamamak için hatırlatma. Süreklilik, değişimin temelidir.',
    'Streak bozulmadan önce gel. Emeklerini boşa çıkarma.',
    'Gün bitmeden bir kayıt ekle. Yarın için bu alışkanlığı sürdür.',
  ];

  // Abonelik Yenileme Hatırlatma - 10-20 kelime
  static const subscriptionReminder = [
    '{name} aboneliğin yarın yenileniyor. {amount} TL hesabından çekilecek.',
    'Yarın {name} için {amount} TL ödenecek. Hazırlıklı ol!',
    '{name} yenileme günü yarın. {amount} TL otomatik çekilecek.',
    'Hatırlatma: {name} aboneliğin yarın {amount} TL ile yenilenecek.',
    'Yarın {amount} TL tutarında {name} ödemesi var. Bakiyeni kontrol et.',
  ];

  static String getSubscriptionReminderMessage(String name, double amount) {
    final template =
        subscriptionReminder[_random.nextInt(subscriptionReminder.length)];
    return template
        .replaceAll('{name}', name)
        .replaceAll(
          '{amount}',
          formatTurkishCurrency(amount, decimalDigits: 2),
        );
  }

  // Maaş Günü (Payday) - Kutlama mesajları
  static const paydayMessages = [
    'Bugün maaş günü! 💰 Bütçeni kontrol etmek için harika bir gün.',
    'Maaş yattı mı? Bütçeni planlamak için uygulamayı ziyaret et!',
    'Günaydın! Bugün hesabını kontrol etmeyi unutma. 💳',
    'Aylık gelirin hesabında! Hedeflerine yatırım yapmayı düşün.',
    'Maaş gününde küçük bir hatırlatma: Tasarruf hedefini gözden geçir!',
  ];

  static String getPaydayMessage() {
    return paydayMessages[_random.nextInt(paydayMessages.length)];
  }

  // Haftalık Mini İçgörü - 10-20 kelime
  static const weeklyInsightTemplates = [
    'Bu hafta en çok {category} kategorisinde düşündün. Belki bu alanda dikkatli olmalısın.',
    'Geçen hafta {count} kez vazgeçip {amount} TL kurtardın. Harika bir başarı!',
    'Bu hafta {category} için en çok zaman harcadın. Bu kategoriyi gözden geçirmeli misin?',
    '{days} günlük serin devam ediyor, harika gidiyorsun. Böyle devam et!',
    'Bu hafta ortalama {hours} saatlik işler için düşündün. Büyük kararlar veriyorsun.',
    'Geçen haftaya göre daha tutumlu davrandın. İlerleme kaydediyorsun, tebrikler!',
    'Bu hafta {count} harcama girdin. Her kayıt bilinçli harcama yolunda bir adım.',
    'En uzun düşünme süren {category} kategorisindeydi. Zor kararlarla yüzleşiyorsun.',
    'Bu hafta toplamda {amount} TL kaydettin. Bu para geleceğin için çalışıyor.',
    'Haftalık ortalamanın üzerinde kurtardın. Kendi rekorunu kırıyorsun!',
  ];

  static String getRandomMessage(List<String> messages) {
    return messages[_random.nextInt(messages.length)];
  }

  static String getWeeklyInsight({
    String? topCategory,
    int? savedCount,
    double? savedAmount,
    int? streakDays,
    double? avgHours,
    int? totalCount,
  }) {
    final template =
        weeklyInsightTemplates[_random.nextInt(weeklyInsightTemplates.length)];

    return template
        .replaceAll('{category}', topCategory ?? 'genel')
        .replaceAll('{count}', (savedCount ?? 0).toString())
        .replaceAll(
          '{amount}',
          formatTurkishCurrency(savedAmount ?? 0, decimalDigits: 2),
        )
        .replaceAll('{days}', (streakDays ?? 0).toString())
        .replaceAll('{hours}', (avgHours ?? 0).toStringAsFixed(1));
  }
}

// ============================================
// BİLDİRİM SERVİSİ
// ============================================

class NotificationService {
  static final NotificationService _instance = NotificationService._internal();
  factory NotificationService() => _instance;
  NotificationService._internal();

  final FlutterLocalNotificationsPlugin _notifications =
      FlutterLocalNotificationsPlugin();
  bool _isInitialized = false;

  // Bildirim ID'leri
  static const _idDelayedAwareness = 1;
  static const _idReinforceDecision = 2;
  static const _idStreakReminder = 3;
  static const _idWeeklyInsight = 4;
  // Trial notification IDs (5-9)
  static const _idTrialMidpoint = 5;
  static const _idTrialOneDayLeft = 6;
  static const _idTrialEndsToday = 7;
  static const _idTrialExpired = 8;
  static const _idFirstExpense = 9;
  // Daily reminder
  static const _idDailyReminder = 10;
  // Payday notification
  static const _idPayday = 11;
  // Thinking items reminder base ID (200+)
  static const _idThinkingReminderBase = 200;
  static const _idSubscriptionBase = 100; // Abonelikler için 100+ ID
  // Achievement & Streak notifications
  static const _idAchievementUnlocked = 12;
  static const _idStreakRiskAlert = 13;
  static const _idStreakMilestoneReward = 14;

  // Pref keys
  static const _keyLastReinforceDate = 'notif_last_reinforce_date';
  static const _keyNotificationsEnabled = 'notif_enabled';
  static const _keyDelayedAwarenessEnabled = 'notif_delayed_awareness';
  static const _keyReinforceEnabled = 'notif_reinforce';
  static const _keyStreakReminderEnabled = 'notif_streak_reminder';
  static const _keyWeeklyInsightEnabled = 'notif_weekly_insight';
  static const _keySubscriptionReminderEnabled = 'notif_subscription_reminder';
  // Trial & daily reminder keys
  static const _keyTrialReminderEnabled = 'notif_trial_reminder';
  static const _keyDailyReminderEnabled = 'notif_daily_reminder';
  static const _keyDailyReminderHour = 'notif_daily_reminder_hour';
  static const _keyDailyReminderMinute = 'notif_daily_reminder_minute';
  static const _keyTrialStartDate = 'notif_trial_start_date';
  static const _keyTrialDays = 'notif_trial_days';
  // Payday notification
  static const _keyPaydayReminderEnabled = 'notif_payday_reminder';
  // Thinking items reminder
  static const _keyThinkingReminderEnabled = 'notif_thinking_reminder';

  /// Servisi başlat
  Future<void> initialize() async {
    if (_isInitialized) return;

    // Timezone başlat
    tz_data.initializeTimeZones();

    // Android ayarları
    const androidSettings = AndroidInitializationSettings(
      '@mipmap/ic_launcher',
    );

    // iOS ayarları
    const darwinSettings = DarwinInitializationSettings(
      requestAlertPermission: true,
      requestBadgePermission: true,
      requestSoundPermission: true,
    );

    // Windows ayarları
    const windowsSettings = WindowsInitializationSettings(
      appName: 'Vantag',
      appUserModelId: 'com.vantag.app',
      guid: 'd49b0314-ee7b-4e96-8bc3-d8456a7dc348',
    );

    const initSettings = InitializationSettings(
      android: androidSettings,
      iOS: darwinSettings,
      macOS: darwinSettings,
      windows: windowsSettings,
    );

    await _notifications.initialize(
      settings: initSettings,
      onDidReceiveNotificationResponse: _onNotificationTap,
    );

    _isInitialized = true;
  }

  void _onNotificationTap(NotificationResponse response) {
    // Bildirimlere tıklandığında yapılacak işlemler
  }

  /// İzin iste
  Future<bool> requestPermission() async {
    if (Platform.isAndroid) {
      final androidPlugin = _notifications
          .resolvePlatformSpecificImplementation<
            AndroidFlutterLocalNotificationsPlugin
          >();
      final granted = await androidPlugin?.requestNotificationsPermission();
      return granted ?? false;
    } else if (Platform.isIOS) {
      final iosPlugin = _notifications
          .resolvePlatformSpecificImplementation<
            IOSFlutterLocalNotificationsPlugin
          >();
      final granted = await iosPlugin?.requestPermissions(
        alert: true,
        badge: true,
        sound: true,
      );
      return granted ?? false;
    }
    return true; // Windows, macOS vs.
  }

  // ============================================
  // ZAMAN KONTROL
  // ============================================

  /// Bir sonraki uygun saati hesapla
  DateTime _getNextAvailableTime(DateTime desiredTime) {
    if (desiredTime.hour >= 22) {
      // Ertesi gün 08:00
      return DateTime(
        desiredTime.year,
        desiredTime.month,
        desiredTime.day + 1,
        8,
        0,
      );
    } else if (desiredTime.hour < 8) {
      // Aynı gün 08:00
      return DateTime(
        desiredTime.year,
        desiredTime.month,
        desiredTime.day,
        8,
        0,
      );
    }
    return desiredTime;
  }

  // ============================================
  // 1. GECİKMELİ FARKINDALIK BİLDİRİMİ
  // ============================================

  /// Yüksek tutarlı "Aldım" kararı sonrası bildirim planla
  Future<void> scheduleDelayedAwareness({
    required double amount,
    required int currentStreak,
  }) async {
    final prefs = await SharedPreferences.getInstance();

    // Ayar kontrolü
    if (!(prefs.getBool(_keyNotificationsEnabled) ?? true)) return;
    if (!(prefs.getBool(_keyDelayedAwarenessEnabled) ?? true)) return;

    // Sadece yüksek tutarlar veya düşük streak
    final isHighAmount = amount >= 500; // 500 TL üstü
    final isLowStreak = currentStreak < 3;

    if (!isHighAmount && !isLowStreak) return;

    // 6-12 saat sonra veya ertesi sabah
    final random = Random();
    final hoursDelay = 6 + random.nextInt(7); // 6-12 saat
    var scheduledTime = DateTime.now().add(Duration(hours: hoursDelay));

    // Gece kontrolü
    scheduledTime = _getNextAvailableTime(scheduledTime);

    final message = NotificationMessages.getRandomMessage(
      NotificationMessages.delayedAwareness,
    );

    await _scheduleNotification(
      id: _idDelayedAwareness,
      title: 'Bir düşün',
      body: message,
      scheduledTime: scheduledTime,
    );
  }

  // ============================================
  // 2. VAZGEÇMEYİ GÜÇLENDİRME BİLDİRİMİ
  // ============================================

  /// "Vazgeçtim" kararı sonrası aynı gün bildirim
  Future<void> scheduleReinforceDecision() async {
    final prefs = await SharedPreferences.getInstance();

    // Ayar kontrolü
    if (!(prefs.getBool(_keyNotificationsEnabled) ?? true)) return;
    if (!(prefs.getBool(_keyReinforceEnabled) ?? true)) return;

    // Günde maksimum 1 kez
    final today = DateTime.now();
    final todayStr = '${today.year}-${today.month}-${today.day}';
    final lastDate = prefs.getString(_keyLastReinforceDate);

    if (lastDate == todayStr) {
      return;
    }

    // 2-4 saat sonra
    final random = Random();
    final hoursDelay = 2 + random.nextInt(3);
    var scheduledTime = DateTime.now().add(Duration(hours: hoursDelay));

    // Gece kontrolü
    if (scheduledTime.hour >= 22) {
      return; // Bugün göndermiyoruz
    }

    final message = NotificationMessages.getRandomMessage(
      NotificationMessages.reinforceDecision,
    );

    await _scheduleNotification(
      id: _idReinforceDecision,
      title: 'Tebrikler',
      body: message,
      scheduledTime: scheduledTime,
    );

    await prefs.setString(_keyLastReinforceDate, todayStr);
  }

  // ============================================
  // 3. STREAK HATIRLATMA BİLDİRİMİ
  // ============================================

  /// Streak varsa ama bugün giriş yoksa akşam hatırlat
  Future<void> scheduleStreakReminder({
    required int currentStreak,
    required DateTime? lastEntryDate,
  }) async {
    final prefs = await SharedPreferences.getInstance();

    // Ayar kontrolü
    if (!(prefs.getBool(_keyNotificationsEnabled) ?? true)) return;
    if (!(prefs.getBool(_keyStreakReminderEnabled) ?? true)) return;

    // Streak yoksa hatırlatma yapma
    if (currentStreak == 0) return;

    // Bugün zaten giriş yapıldıysa hatırlatma yapma
    if (lastEntryDate != null) {
      final today = DateTime.now();
      if (lastEntryDate.year == today.year &&
          lastEntryDate.month == today.month &&
          lastEntryDate.day == today.day) {
        await cancel(_idStreakReminder);
        return;
      }
    }

    // Akşam 20:00'da hatırlat
    final now = DateTime.now();
    var scheduledTime = DateTime(now.year, now.month, now.day, 20, 0);

    // Saat geçtiyse hatırlatma yapma
    if (scheduledTime.isBefore(now)) {
      return;
    }

    final message = NotificationMessages.getRandomMessage(
      NotificationMessages.streakReminder,
    );

    await _scheduleNotification(
      id: _idStreakReminder,
      title: 'Serin bekliyor',
      body: message,
      scheduledTime: scheduledTime,
    );
  }

  /// Streak hatırlatmasını iptal et (giriş yapıldığında)
  Future<void> cancelStreakReminder() async {
    await cancel(_idStreakReminder);
  }

  // ============================================
  // 4. HAFTALIK MİNİ İÇGÖRÜ
  // ============================================

  /// Haftalık içgörü bildirimi planla (Pazar 18:00)
  Future<void> scheduleWeeklyInsight({
    String? topCategory,
    int? savedCount,
    double? savedAmount,
    int? streakDays,
  }) async {
    final prefs = await SharedPreferences.getInstance();

    // Ayar kontrolü
    if (!(prefs.getBool(_keyNotificationsEnabled) ?? true)) return;
    if (!(prefs.getBool(_keyWeeklyInsightEnabled) ?? true)) return;

    // Bir sonraki Pazar 18:00
    final now = DateTime.now();
    var daysUntilSunday = DateTime.sunday - now.weekday;
    if (daysUntilSunday <= 0) daysUntilSunday += 7;

    final scheduledTime = DateTime(
      now.year,
      now.month,
      now.day + daysUntilSunday,
      18,
      0,
    );

    final message = NotificationMessages.getWeeklyInsight(
      topCategory: topCategory,
      savedCount: savedCount,
      savedAmount: savedAmount,
      streakDays: streakDays,
    );

    await _scheduleNotification(
      id: _idWeeklyInsight,
      title: 'Haftalık özet',
      body: message,
      scheduledTime: scheduledTime,
    );
  }

  // ============================================
  // 5. ABONELİK YENİLEME HATIRLATMASI
  // ============================================

  /// Yarın yenilenecek abonelikler için bildirim planla
  Future<void> scheduleSubscriptionReminders(
    List<({String id, String name, double amount})> subscriptions,
  ) async {
    final prefs = await SharedPreferences.getInstance();

    // Ayar kontrolü
    if (!(prefs.getBool(_keyNotificationsEnabled) ?? true)) return;
    if (!(prefs.getBool(_keySubscriptionReminderEnabled) ?? true)) return;

    // Ertesi gün sabah 09:00'da bildirim
    final now = DateTime.now();
    final tomorrow = DateTime(now.year, now.month, now.day + 1, 9, 0);

    for (var i = 0; i < subscriptions.length; i++) {
      final sub = subscriptions[i];
      final message = NotificationMessages.getSubscriptionReminderMessage(
        sub.name,
        sub.amount,
      );

      // Her abonelik için benzersiz ID
      final notificationId = _idSubscriptionBase + i;

      await _scheduleNotification(
        id: notificationId,
        title: 'Abonelik hatırlatma',
        body: message,
        scheduledTime: tomorrow,
      );
    }
  }

  /// Tüm abonelik bildirimlerini iptal et
  Future<void> cancelSubscriptionReminders() async {
    // 100'den 200'e kadar olan ID'leri iptal et
    for (var i = _idSubscriptionBase; i < _idSubscriptionBase + 100; i++) {
      await cancel(i);
    }
  }

  // ============================================
  // 6. TRIAL HATIRLATMA BİLDİRİMLERİ
  // ============================================

  /// Trial bildirimleri planla
  /// trialDays: 7 (referral) veya 3 (normal)
  Future<void> scheduleTrialNotifications({
    required DateTime trialStartDate,
    required int trialDays,
    String? totalSavedHours,
  }) async {
    final prefs = await SharedPreferences.getInstance();

    // Ayar kontrolü
    if (!(prefs.getBool(_keyNotificationsEnabled) ?? true)) return;
    if (!(prefs.getBool(_keyTrialReminderEnabled) ?? true)) return;

    // Trial bilgilerini kaydet (daha sonra kontrol için)
    await prefs.setString(_keyTrialStartDate, trialStartDate.toIso8601String());
    await prefs.setInt(_keyTrialDays, trialDays);

    final trialEndDate = trialStartDate.add(Duration(days: trialDays));
    final midpoint = trialStartDate.add(Duration(days: trialDays ~/ 2));
    final oneDayBefore = trialEndDate.subtract(const Duration(days: 1));
    final oneDayAfter = trialEndDate.add(const Duration(days: 1));

    final now = DateTime.now();
    final hours = totalSavedHours ?? '0';

    // Midpoint reminder (trial'ın yarısında)
    if (midpoint.isAfter(now)) {
      final midpointTime = DateTime(
        midpoint.year,
        midpoint.month,
        midpoint.day,
        12,
        0,
      );
      await _scheduleNotification(
        id: _idTrialMidpoint,
        title: 'Yarı yoldasın! ⏳',
        body: 'Deneme süren yarılandı. Şu ana kadar $hours saat biriktirdin!',
        scheduledTime: _getNextAvailableTime(midpointTime),
        channelId: 'trial_channel',
        channelName: 'Trial Reminders',
      );
    }

    // 1 day before end
    if (oneDayBefore.isAfter(now)) {
      final oneDayBeforeTime = DateTime(
        oneDayBefore.year,
        oneDayBefore.month,
        oneDayBefore.day,
        10,
        0,
      );
      await _scheduleNotification(
        id: _idTrialOneDayLeft,
        title: 'Denemen yarın bitiyor ⏰',
        body: 'Premium\'a geç, biriktirmeye devam et!',
        scheduledTime: _getNextAvailableTime(oneDayBeforeTime),
        channelId: 'trial_channel',
        channelName: 'Trial Reminders',
      );
    }

    // Trial end day
    if (trialEndDate.isAfter(now)) {
      final endDayTime = DateTime(
        trialEndDate.year,
        trialEndDate.month,
        trialEndDate.day,
        10,
        0,
      );
      await _scheduleNotification(
        id: _idTrialEndsToday,
        title: 'Denemenin son günü! 🎁',
        body: 'Bugün geçersen %50 indirim!',
        scheduledTime: _getNextAvailableTime(endDayTime),
        channelId: 'trial_channel',
        channelName: 'Trial Reminders',
      );
    }

    // 1 day after (win-back)
    if (oneDayAfter.isAfter(now)) {
      final dayAfterTime = DateTime(
        oneDayAfter.year,
        oneDayAfter.month,
        oneDayAfter.day,
        18,
        0,
      );
      await _scheduleNotification(
        id: _idTrialExpired,
        title: 'Seni özledik! 💜',
        body: 'Geri dön, hedeflerine devam et',
        scheduledTime: _getNextAvailableTime(dayAfterTime),
        channelId: 'trial_channel',
        channelName: 'Trial Reminders',
      );
    }
  }

  /// Trial bildirimlerini iptal et (kullanıcı premium'a geçtiğinde)
  Future<void> cancelTrialNotifications() async {
    await cancel(_idTrialMidpoint);
    await cancel(_idTrialOneDayLeft);
    await cancel(_idTrialEndsToday);
    await cancel(_idTrialExpired);
  }

  /// Trial'ın kalan günlerini hesapla
  Future<int?> getTrialDaysRemaining() async {
    final prefs = await SharedPreferences.getInstance();
    final startDateStr = prefs.getString(_keyTrialStartDate);
    final trialDays = prefs.getInt(_keyTrialDays);

    if (startDateStr == null || trialDays == null) return null;

    final startDate = DateTime.parse(startDateStr);
    final endDate = startDate.add(Duration(days: trialDays));
    final remaining = endDate.difference(DateTime.now()).inDays;

    return remaining > 0 ? remaining : 0;
  }

  // ============================================
  // 7. İLK HARCAMA KUTLAMASI
  // ============================================

  /// İlk harcama sonrası kutlama bildirimi
  Future<void> scheduleFirstExpenseCelebration({
    required String savedHours,
  }) async {
    final prefs = await SharedPreferences.getInstance();

    // Ayar kontrolü
    if (!(prefs.getBool(_keyNotificationsEnabled) ?? true)) return;

    // 2-4 saat sonra
    final random = Random();
    final hoursDelay = 2 + random.nextInt(3);
    var scheduledTime = DateTime.now().add(Duration(hours: hoursDelay));

    // Gece kontrolü
    scheduledTime = _getNextAvailableTime(scheduledTime);

    await _scheduleNotification(
      id: _idFirstExpense,
      title: 'Harika başlangıç! 🎉',
      body: 'Bugün $savedHours saat biriktirdin!',
      scheduledTime: scheduledTime,
    );
  }

  // ============================================
  // 8. GÜNLÜK HATIRLATMA
  // ============================================

  /// Günlük hatırlatma planla
  Future<void> scheduleDailyReminder({int hour = 20, int minute = 0}) async {
    final prefs = await SharedPreferences.getInstance();

    // Ayar kontrolü
    if (!(prefs.getBool(_keyNotificationsEnabled) ?? true)) return;
    if (!(prefs.getBool(_keyDailyReminderEnabled) ?? false)) return;

    // Windows ve Linux'ta desteklenmiyor
    if (Platform.isWindows || Platform.isLinux) return;

    // Saati kaydet
    await prefs.setInt(_keyDailyReminderHour, hour);
    await prefs.setInt(_keyDailyReminderMinute, minute);

    // Bir sonraki hatırlatma zamanını hesapla
    final now = DateTime.now();
    var scheduledTime = DateTime(now.year, now.month, now.day, hour, minute);

    // Saat geçtiyse yarına planla
    if (scheduledTime.isBefore(now)) {
      scheduledTime = scheduledTime.add(const Duration(days: 1));
    }

    final androidDetails = AndroidNotificationDetails(
      'daily_reminder_channel',
      'Günlük Hatırlatmalar',
      channelDescription: 'Günlük harcama girişi hatırlatmaları',
      importance: Importance.defaultImportance,
      priority: Priority.defaultPriority,
    );

    const darwinDetails = DarwinNotificationDetails();

    final details = NotificationDetails(
      android: androidDetails,
      iOS: darwinDetails,
      macOS: darwinDetails,
    );

    try {
      // Her gün tekrarlayan bildirim
      await _notifications.zonedSchedule(
        id: _idDailyReminder,
        title: 'Harcamalarını girmeyi unutma! 📝',
        body: 'Bugünkü harcamalarını saniyeler içinde gir',
        scheduledDate: tz.TZDateTime.from(scheduledTime, tz.local),
        notificationDetails: details,
        androidScheduleMode: AndroidScheduleMode.inexactAllowWhileIdle,
        matchDateTimeComponents: DateTimeComponents.time, // Her gün aynı saatte
      );
    } on UnimplementedError {
      // Platform desteklemiyor
    }
  }

  /// Günlük hatırlatmayı iptal et
  Future<void> cancelDailyReminder() async {
    await cancel(_idDailyReminder);
  }

  // ============================================
  // 9. MAAŞ GÜNÜ HATIRLATMASI
  // ============================================

  /// Maaş günü bildirimi planla
  /// [salaryDay]: Ayın günü (1-31)
  Future<void> schedulePaydayNotification({required int salaryDay}) async {
    final prefs = await SharedPreferences.getInstance();

    // Ayar kontrolü
    if (!(prefs.getBool(_keyNotificationsEnabled) ?? true)) return;
    if (!(prefs.getBool(_keyPaydayReminderEnabled) ?? true)) return;

    // Windows ve Linux'ta desteklenmiyor
    if (Platform.isWindows || Platform.isLinux) return;

    // Sonraki maaş gününü hesapla
    final now = DateTime.now();
    DateTime nextPayday;

    if (now.day < salaryDay) {
      // Bu ayın maaş günü henüz gelmedi
      nextPayday = DateTime(now.year, now.month, salaryDay, 9, 0);
    } else {
      // Gelecek ayın maaş günü
      nextPayday = DateTime(now.year, now.month + 1, salaryDay, 9, 0);
    }

    // Gece kontrolü - sabah 09:00'da gönder
    nextPayday = _getNextAvailableTime(nextPayday);

    final message = NotificationMessages.getPaydayMessage();

    final androidDetails = AndroidNotificationDetails(
      'payday_channel',
      'Maaş Günü',
      channelDescription: 'Maaş günü hatırlatmaları',
      importance: Importance.high,
      priority: Priority.high,
    );

    const darwinDetails = DarwinNotificationDetails();

    final details = NotificationDetails(
      android: androidDetails,
      iOS: darwinDetails,
      macOS: darwinDetails,
    );

    try {
      // Her ay aynı günde tekrarlayan bildirim
      await _notifications.zonedSchedule(
        id: _idPayday,
        title: 'Maaş Günü! 💰',
        body: message,
        scheduledDate: tz.TZDateTime.from(nextPayday, tz.local),
        notificationDetails: details,
        androidScheduleMode: AndroidScheduleMode.inexactAllowWhileIdle,
        matchDateTimeComponents:
            DateTimeComponents.dayOfMonthAndTime, // Ayın aynı gününde
      );
    } on UnimplementedError {
      // Platform desteklemiyor
    }
  }

  /// Maaş günü bildirimini iptal et
  Future<void> cancelPaydayNotification() async {
    await cancel(_idPayday);
  }

  /// Maaş günü hatırlatması aktif mi?
  Future<bool> isPaydayReminderEnabled() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getBool(_keyPaydayReminderEnabled) ?? true;
  }

  // ============================================
  // 10. DÜŞÜNÜYORUM (THINKING) HATIRLATMASI
  // ============================================

  /// "Düşünüyorum" kararı sonrası 72 saat sonra hatırlat
  Future<void> scheduleThinkingReminder({
    required String expenseId,
    required double amount,
    required String? description,
    required String currencySymbol,
  }) async {
    final prefs = await SharedPreferences.getInstance();

    // Ayar kontrolü
    if (!(prefs.getBool(_keyNotificationsEnabled) ?? true)) return;
    if (!(prefs.getBool(_keyThinkingReminderEnabled) ?? true)) return;

    // Windows ve Linux'ta desteklenmiyor
    if (Platform.isWindows || Platform.isLinux) return;

    // 72 saat sonra
    var scheduledTime = DateTime.now().add(const Duration(hours: 72));

    // Gece kontrolü
    scheduledTime = _getNextAvailableTime(scheduledTime);

    // Benzersiz ID oluştur (expenseId'nin hash'i)
    final notificationId =
        _idThinkingReminderBase + (expenseId.hashCode.abs() % 100);

    // Display amount with description if available
    final itemDisplay = description != null && description.isNotEmpty
        ? '$description ($currencySymbol${amount.toStringAsFixed(0)})'
        : '$currencySymbol${amount.toStringAsFixed(0)}';

    final androidDetails = AndroidNotificationDetails(
      'thinking_reminder_channel',
      'Düşünme Hatırlatmaları',
      channelDescription: 'Düşünüyorum kararları için 72 saat hatırlatmaları',
      importance: Importance.high,
      priority: Priority.high,
      styleInformation: BigTextStyleInformation(
        'Karar verdin mi? $itemDisplay',
      ),
    );

    const darwinDetails = DarwinNotificationDetails();

    final details = NotificationDetails(
      android: androidDetails,
      iOS: darwinDetails,
      macOS: darwinDetails,
    );

    try {
      await _notifications.zonedSchedule(
        id: notificationId,
        title: 'Hala düşünüyor musun? 🤔',
        body: 'Karar verdin mi? $itemDisplay',
        scheduledDate: tz.TZDateTime.from(scheduledTime, tz.local),
        notificationDetails: details,
        androidScheduleMode: AndroidScheduleMode.inexactAllowWhileIdle,
        payload: 'thinking_$expenseId',
      );
    } on UnimplementedError {
      // Platform desteklemiyor
    }
  }

  /// Düşünüyorum hatırlatmasını iptal et
  Future<void> cancelThinkingReminder(String expenseId) async {
    final notificationId =
        _idThinkingReminderBase + (expenseId.hashCode.abs() % 100);
    await cancel(notificationId);
  }

  // ============================================
  // 11. ACHIEVEMENT NOTIFICATION (Task 57)
  // ============================================

  /// Show achievement unlocked notification
  Future<void> showAchievementUnlocked({
    required String achievementTitle,
    required String achievementDescription,
  }) async {
    final prefs = await SharedPreferences.getInstance();
    if (!(prefs.getBool(_keyNotificationsEnabled) ?? true)) return;

    final androidDetails = AndroidNotificationDetails(
      'achievement_channel',
      'Başarılar',
      channelDescription: 'Başarı bildirimleri',
      importance: Importance.high,
      priority: Priority.high,
      styleInformation: BigTextStyleInformation(achievementDescription),
    );

    const darwinDetails = DarwinNotificationDetails();

    final details = NotificationDetails(
      android: androidDetails,
      iOS: darwinDetails,
      macOS: darwinDetails,
    );

    try {
      await _notifications.show(
        id: _idAchievementUnlocked,
        title: 'Başarı Açıldı! $achievementTitle',
        body: achievementDescription,
        notificationDetails: details,
      );
    } catch (e) {
      // Ignore notification errors
    }
  }

  // ============================================
  // 12. STREAK RISK ALERT (Task 58)
  // ============================================

  /// Show streak risk alert (4 hours before midnight, no entry today)
  Future<void> scheduleStreakRiskAlert({
    required int currentStreak,
  }) async {
    final prefs = await SharedPreferences.getInstance();
    if (!(prefs.getBool(_keyNotificationsEnabled) ?? true)) return;
    if (!(prefs.getBool(_keyStreakReminderEnabled) ?? true)) return;
    if (currentStreak < 3) return; // Only alert for meaningful streaks

    // Schedule for 20:00 (8 PM)
    final now = DateTime.now();
    var scheduledTime = DateTime(now.year, now.month, now.day, 20, 0);

    if (scheduledTime.isBefore(now)) return;

    await _scheduleNotification(
      id: _idStreakRiskAlert,
      title: 'Serin tehlikede!',
      body: '$currentStreak günlük serin bozulmak üzere. Gün bitmeden bir kayıt ekle!',
      scheduledTime: scheduledTime,
      channelId: 'streak_risk_channel',
      channelName: 'Streak Uyarıları',
      importance: Importance.high,
      priority: Priority.high,
    );
  }

  /// Cancel streak risk alert
  Future<void> cancelStreakRiskAlert() async {
    await cancel(_idStreakRiskAlert);
  }

  // ============================================
  // 13. STREAK MILESTONE REWARD (Task 53)
  // ============================================

  /// Show streak milestone reward notification
  Future<void> showStreakMilestoneReward({
    required int milestone,
    required int proDaysGranted,
  }) async {
    final prefs = await SharedPreferences.getInstance();
    if (!(prefs.getBool(_keyNotificationsEnabled) ?? true)) return;

    final androidDetails = AndroidNotificationDetails(
      'streak_reward_channel',
      'Streak Ödülleri',
      channelDescription: 'Streak milestone ödül bildirimleri',
      importance: Importance.high,
      priority: Priority.high,
    );

    const darwinDetails = DarwinNotificationDetails();

    final details = NotificationDetails(
      android: androidDetails,
      iOS: darwinDetails,
      macOS: darwinDetails,
    );

    try {
      await _notifications.show(
        id: _idStreakMilestoneReward,
        title: '$milestone Gün Serisi!',
        body: 'Tebrikler! $proDaysGranted gün ücretsiz Pro kazandın!',
        notificationDetails: details,
      );
    } catch (e) {
      // Ignore notification errors
    }
  }

  /// Thinking hatırlatması aktif mi?
  Future<bool> isThinkingReminderEnabled() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getBool(_keyThinkingReminderEnabled) ?? true;
  }

  /// Günlük hatırlatma saatini al
  Future<({int hour, int minute})?> getDailyReminderTime() async {
    final prefs = await SharedPreferences.getInstance();
    final hour = prefs.getInt(_keyDailyReminderHour);
    final minute = prefs.getInt(_keyDailyReminderMinute);

    if (hour == null) return null;
    return (hour: hour, minute: minute ?? 0);
  }

  /// Günlük hatırlatma aktif mi?
  Future<bool> isDailyReminderEnabled() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getBool(_keyDailyReminderEnabled) ?? false;
  }

  /// Trial hatırlatması aktif mi?
  Future<bool> isTrialReminderEnabled() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getBool(_keyTrialReminderEnabled) ?? true;
  }

  // ============================================
  // YARDIMCI METODLAR
  // ============================================

  Future<void> _scheduleNotification({
    required int id,
    required String title,
    required String body,
    required DateTime scheduledTime,
    String channelId = 'vantag_channel',
    String channelName = 'Vantag Bildirimleri',
    Importance importance = Importance.defaultImportance,
    Priority priority = Priority.defaultPriority,
  }) async {
    // Windows ve Linux'ta zamanlanmış bildirimler desteklenmiyor
    if (Platform.isWindows || Platform.isLinux) {
      return;
    }

    final androidDetails = AndroidNotificationDetails(
      channelId,
      channelName,
      channelDescription: 'Finansal takip bildirimleri',
      importance: importance,
      priority: priority,
      styleInformation: BigTextStyleInformation(body),
    );

    const darwinDetails = DarwinNotificationDetails();

    final details = NotificationDetails(
      android: androidDetails,
      iOS: darwinDetails,
      macOS: darwinDetails,
    );

    try {
      await _notifications.zonedSchedule(
        id: id,
        title: title,
        body: body,
        scheduledDate: tz.TZDateTime.from(scheduledTime, tz.local),
        notificationDetails: details,
        androidScheduleMode: AndroidScheduleMode.inexactAllowWhileIdle,
      );
    } on UnimplementedError {
      // Platform desteklemiyor
    }
  }

  /// Tüm bildirimleri iptal et
  Future<void> cancelAll() async {
    if (Platform.isWindows || Platform.isLinux) return;
    try {
      await _notifications.cancelAll();
    } on UnimplementedError {
      // Windows/Linux'ta desteklenmiyor
    }
  }

  /// Belirli bildirimi iptal et
  Future<void> cancel(int id) async {
    if (Platform.isWindows || Platform.isLinux) return;
    try {
      await _notifications.cancel(id: id);
    } on UnimplementedError {
      // Windows/Linux'ta desteklenmiyor
    }
  }

  // ============================================
  // AYARLAR
  // ============================================

  /// Bildirimlerin açık olup olmadığını kontrol et
  Future<bool> areNotificationsEnabled() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getBool(_keyNotificationsEnabled) ?? true;
  }

  /// Tüm bildirimleri aç/kapat
  Future<void> setNotificationsEnabled(bool enabled) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_keyNotificationsEnabled, enabled);

    if (!enabled) {
      await cancelAll();
    }
  }

  /// Bildirim ayarlarını getir
  Future<Map<String, bool>> getSettings() async {
    final prefs = await SharedPreferences.getInstance();
    return {
      'enabled': prefs.getBool(_keyNotificationsEnabled) ?? true,
      'delayedAwareness': prefs.getBool(_keyDelayedAwarenessEnabled) ?? true,
      'reinforce': prefs.getBool(_keyReinforceEnabled) ?? true,
      'streakReminder': prefs.getBool(_keyStreakReminderEnabled) ?? true,
      'weeklyInsight': prefs.getBool(_keyWeeklyInsightEnabled) ?? true,
      'subscriptionReminder':
          prefs.getBool(_keySubscriptionReminderEnabled) ?? true,
      'trialReminder': prefs.getBool(_keyTrialReminderEnabled) ?? true,
      'dailyReminder': prefs.getBool(_keyDailyReminderEnabled) ?? false,
      'paydayReminder': prefs.getBool(_keyPaydayReminderEnabled) ?? true,
      'thinkingReminder': prefs.getBool(_keyThinkingReminderEnabled) ?? true,
    };
  }

  /// Bildirim ayarını güncelle
  Future<void> updateSetting(String key, bool value) async {
    final prefs = await SharedPreferences.getInstance();

    final prefKey = switch (key) {
      'enabled' => _keyNotificationsEnabled,
      'delayedAwareness' => _keyDelayedAwarenessEnabled,
      'reinforce' => _keyReinforceEnabled,
      'streakReminder' => _keyStreakReminderEnabled,
      'weeklyInsight' => _keyWeeklyInsightEnabled,
      'subscriptionReminder' => _keySubscriptionReminderEnabled,
      'trialReminder' => _keyTrialReminderEnabled,
      'dailyReminder' => _keyDailyReminderEnabled,
      'paydayReminder' => _keyPaydayReminderEnabled,
      'thinkingReminder' => _keyThinkingReminderEnabled,
      _ => null,
    };

    if (prefKey != null) {
      await prefs.setBool(prefKey, value);

      if (key == 'enabled' && !value) {
        await cancelAll();
      } else if (key == 'trialReminder' && !value) {
        await cancelTrialNotifications();
      } else if (key == 'dailyReminder' && !value) {
        await cancelDailyReminder();
      } else if (key == 'dailyReminder' && value) {
        // Re-schedule with saved time
        final time = await getDailyReminderTime();
        await scheduleDailyReminder(
          hour: time?.hour ?? 20,
          minute: time?.minute ?? 0,
        );
      } else if (key == 'paydayReminder' && !value) {
        await cancelPaydayNotification();
      }
    }
  }

  /// Varsayılan ayarları oluştur (ilk kurulum)
  Future<void> initializeDefaultSettings() async {
    final prefs = await SharedPreferences.getInstance();

    if (!prefs.containsKey(_keyNotificationsEnabled)) {
      await prefs.setBool(_keyNotificationsEnabled, true);
      await prefs.setBool(_keyDelayedAwarenessEnabled, true);
      await prefs.setBool(_keyReinforceEnabled, true);
      await prefs.setBool(_keyStreakReminderEnabled, true);
      await prefs.setBool(_keyWeeklyInsightEnabled, true);
      await prefs.setBool(_keySubscriptionReminderEnabled, true);
      await prefs.setBool(_keyTrialReminderEnabled, true);
      await prefs.setBool(_keyPaydayReminderEnabled, true);
      await prefs.setBool(_keyThinkingReminderEnabled, true); // On by default
      await prefs.setBool(_keyDailyReminderEnabled, false); // Off by default
    }
  }
}


--- FILE: lib/services/statement_parse_service.dart ---

import 'dart:convert';
import 'dart:io';
import 'package:flutter/foundation.dart';
import 'package:http/http.dart' as http;
import 'package:flutter_dotenv/flutter_dotenv.dart';
import 'package:csv/csv.dart';
import 'package:syncfusion_flutter_pdf/pdf.dart';

/// A single parsed transaction from bank statement
class ParsedTransaction {
  final DateTime date;
  final String description;
  final double amount;
  final String category;
  final String? merchant;
  final bool isExpense; // true = expense, false = income

  ParsedTransaction({
    required this.date,
    required this.description,
    required this.amount,
    required this.category,
    this.merchant,
    this.isExpense = true,
  });

  factory ParsedTransaction.fromJson(Map<String, dynamic> json) {
    return ParsedTransaction(
      date: DateTime.tryParse(json['date'] ?? '') ?? DateTime.now(),
      description: json['description'] ?? '',
      amount: (json['amount'] as num?)?.toDouble() ?? 0,
      category: _mapCategory(json['category']),
      merchant: json['merchant'],
      isExpense: json['isExpense'] ?? true,
    );
  }

  static String _mapCategory(String? category) {
    const mapping = {
      'food': 'Yiyecek',
      'transport': 'Ulaşım',
      'entertainment': 'Eğlence',
      'shopping': 'Alışveriş',
      'health': 'Sağlık',
      'bills': 'Faturalar',
      'education': 'Eğitim',
      'subscription': 'Abonelik',
      'other': 'Diğer',
    };
    return mapping[category?.toLowerCase()] ?? 'Diğer';
  }
}

/// Result of parsing a bank statement
class StatementParseResult {
  final List<ParsedTransaction> transactions;
  final int totalFound;
  final int successfullyParsed;
  final String? error;
  final String? bankName;

  StatementParseResult({
    required this.transactions,
    required this.totalFound,
    required this.successfullyParsed,
    this.error,
    this.bankName,
  });

  bool get hasError => error != null;
  bool get isEmpty => transactions.isEmpty;
}

/// Service for parsing bank statements (PDF/CSV) using AI
class StatementParseService {
  static final StatementParseService _instance = StatementParseService._();
  factory StatementParseService() => _instance;
  StatementParseService._();

  /// Parse a bank statement file (PDF or CSV)
  Future<StatementParseResult> parseFile(File file) async {
    final extension = file.path.toLowerCase().split('.').last;

    String rawText;

    try {
      if (extension == 'pdf') {
        rawText = await _extractTextFromPDF(file);
      } else if (extension == 'csv') {
        rawText = await _extractTextFromCSV(file);
      } else {
        return StatementParseResult(
          transactions: [],
          totalFound: 0,
          successfullyParsed: 0,
          error: 'Desteklenmeyen dosya formatı: $extension',
        );
      }

      if (rawText.trim().isEmpty) {
        return StatementParseResult(
          transactions: [],
          totalFound: 0,
          successfullyParsed: 0,
          error: 'Dosyadan metin çıkarılamadı',
        );
      }

      // Parse with AI
      return await _parseWithAI(rawText);
    } catch (e) {
      debugPrint('[StatementParse] Error: $e');
      return StatementParseResult(
        transactions: [],
        totalFound: 0,
        successfullyParsed: 0,
        error: 'Dosya işlenirken hata: $e',
      );
    }
  }

  /// Extract text from PDF using Syncfusion
  Future<String> _extractTextFromPDF(File file) async {
    final bytes = await file.readAsBytes();
    final document = PdfDocument(inputBytes: bytes);

    final StringBuffer textBuffer = StringBuffer();

    // Extract text from all pages
    for (int i = 0; i < document.pages.count; i++) {
      final text = PdfTextExtractor(
        document,
      ).extractText(startPageIndex: i, endPageIndex: i);
      textBuffer.writeln(text);
    }

    document.dispose();

    return textBuffer.toString();
  }

  /// Extract text from CSV
  Future<String> _extractTextFromCSV(File file) async {
    final csvString = await file.readAsString();
    final rows = const CsvToListConverter(
      eol: '\n',
      shouldParseNumbers: false,
    ).convert(csvString);

    // Convert CSV to readable text format for AI
    final buffer = StringBuffer();
    for (final row in rows) {
      buffer.writeln(row.join(' | '));
    }

    return buffer.toString();
  }

  /// Parse extracted text using GPT-4o-mini
  Future<StatementParseResult> _parseWithAI(String rawText) async {
    final apiKey = dotenv.env['OPENAI_API_KEY'];
    if (apiKey == null || apiKey.isEmpty) {
      return StatementParseResult(
        transactions: [],
        totalFound: 0,
        successfullyParsed: 0,
        error: 'OpenAI API key not configured',
      );
    }

    // Truncate text if too long (GPT-4o-mini context limit)
    String textToSend = rawText;
    if (rawText.length > 15000) {
      textToSend = rawText.substring(0, 15000);
    }

    final prompt =
        '''You are a bank statement parser. Extract ALL expense transactions from this bank statement text.

BANK STATEMENT TEXT:
"""
$textToSend
"""

INSTRUCTIONS:
1. Find all expense/debit transactions (money going OUT)
2. Skip income/credit transactions (money coming IN)
3. Extract: date, description, amount, category, merchant name if identifiable
4. Use these categories: food, transport, entertainment, shopping, health, bills, education, subscription, other
5. For Turkish banks: amounts might use comma as decimal separator (1.234,56 = 1234.56)
6. Detect the bank name if possible

Return ONLY valid JSON array:
{
  "bank": "Bank name or null",
  "transactions": [
    {
      "date": "2024-01-15",
      "description": "MIGROS MARKET",
      "amount": 150.50,
      "category": "shopping",
      "merchant": "Migros",
      "isExpense": true
    }
  ]
}

If no transactions found, return: {"bank": null, "transactions": []}''';

    try {
      final response = await http
          .post(
            Uri.parse('https://api.openai.com/v1/chat/completions'),
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer $apiKey',
            },
            body: jsonEncode({
              'model': 'gpt-4o-mini',
              'messages': [
                {'role': 'user', 'content': prompt},
              ],
              'temperature': 0,
              'max_tokens': 4000,
            }),
          )
          .timeout(const Duration(seconds: 60));

      if (response.statusCode != 200) {
        debugPrint('[StatementParse] API error: ${response.statusCode}');
        debugPrint('[StatementParse] Body: ${response.body}');
        return StatementParseResult(
          transactions: [],
          totalFound: 0,
          successfullyParsed: 0,
          error: 'AI API hatası: ${response.statusCode}',
        );
      }

      final data = jsonDecode(response.body);
      final content = data['choices'][0]['message']['content'] as String;

      // Extract JSON from response (handle markdown code blocks)
      String jsonStr = content.trim();
      if (jsonStr.contains('```')) {
        final jsonMatch = RegExp(
          r'```(?:json)?\s*([\s\S]*?)```',
        ).firstMatch(jsonStr);
        if (jsonMatch != null) {
          jsonStr = jsonMatch.group(1)!.trim();
        }
      }

      final parsed = jsonDecode(jsonStr) as Map<String, dynamic>;
      final transactionsJson = parsed['transactions'] as List<dynamic>? ?? [];
      final bankName = parsed['bank'] as String?;

      final transactions = <ParsedTransaction>[];
      for (final t in transactionsJson) {
        try {
          transactions.add(
            ParsedTransaction.fromJson(t as Map<String, dynamic>),
          );
        } catch (e) {
          debugPrint('[StatementParse] Failed to parse transaction: $e');
        }
      }

      return StatementParseResult(
        transactions: transactions,
        totalFound: transactionsJson.length,
        successfullyParsed: transactions.length,
        bankName: bankName,
      );
    } catch (e) {
      debugPrint('[StatementParse] AI parse error: $e');
      return StatementParseResult(
        transactions: [],
        totalFound: 0,
        successfullyParsed: 0,
        error: 'AI parse hatası: $e',
      );
    }
  }

  /// Parse plain text (for manual paste)
  Future<StatementParseResult> parseText(String text) async {
    if (text.trim().isEmpty) {
      return StatementParseResult(
        transactions: [],
        totalFound: 0,
        successfullyParsed: 0,
        error: 'Metin boş',
      );
    }

    return await _parseWithAI(text);
  }
}


--- FILE: lib/services/exchange_rate_service.dart ---

import 'dart:convert';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:flutter/foundation.dart';
import 'package:http/http.dart' as http;
import 'package:shared_preferences/shared_preferences.dart';
import '../models/currency.dart';

/// USD-based exchange rate service
/// Primary source: Firestore (updated by Cloud Function every hour)
/// Fallback: Direct API calls
class ExchangeRateService {
  // Singleton
  static final ExchangeRateService _instance = ExchangeRateService._internal();
  factory ExchangeRateService() => _instance;
  ExchangeRateService._internal();

  // ═══════════════════════════════════════════════════════════════════
  // CURRENCY CLASSIFICATIONS
  // ═══════════════════════════════════════════════════════════════════
  static const List<String> majorCurrencies = ['USD', 'EUR', 'GBP'];
  static const List<String> minorCurrencies = ['TRY', 'SAR'];

  // Firestore path
  static const _firestorePath = 'app_data/exchange_rates';

  // Cache keys
  static const _ratesCacheKey = 'exchange_rates_usd_base';
  static const _goldCacheKey = 'gold_price_usd';
  static const _goldTryKey = 'gold_price_try_gram';
  static const _lastFetchKey = 'exchange_rates_last_fetch';

  // Fallback API URLs (used when Firestore is unavailable)
  static const _exchangeRateApiUrl =
      'https://api.exchangerate-api.com/v4/latest/USD';
  static const _goldApiUrl = 'https://api.metals.live/v1/spot/gold';
  static const _truncgilGoldUrl = 'https://finans.truncgil.com/v4/today.json';

  // State - rates relative to 1 USD
  Map<String, double> _ratesInUSD = {};
  double? _goldUSD; // Gold price in USD per troy ounce
  double? _goldTRYPerGram; // Gold price in TRY per gram (from Truncgil)
  DateTime? _lastFetch;
  bool _isLoading = false;
  String _source = 'none';

  // Getters
  bool get hasRates => _ratesInUSD.isNotEmpty;
  bool get hasGold => _goldUSD != null;
  bool get isLoading => _isLoading;
  DateTime? get lastFetch => _lastFetch;
  String get source => _source;
  Map<String, double> get rates => Map.unmodifiable(_ratesInUSD);
  double? get goldUsdPerOz => _goldUSD;
  double? get goldTryPerGram => _goldTRYPerGram;

  // ═══════════════════════════════════════════════════════════════════
  // RATE BAR DATA - For Currency Rate Widget Display
  // ═══════════════════════════════════════════════════════════════════

  /// Get formatted rate bar data for the selected currency
  /// Returns appropriate rates based on whether currency is major or minor
  RateBarData getRateBarData(String selectedCurrency) {
    final isMajor = majorCurrencies.contains(selectedCurrency);
    final isMinor = minorCurrencies.contains(selectedCurrency);

    List<RateItem> items = [];

    // Get current rates with fallbacks
    final usdTry = _ratesInUSD['TRY'] ?? 34.50;
    final eurUsd = _ratesInUSD['EUR'] ?? 0.93;
    final gbpUsd = _ratesInUSD['GBP'] ?? 0.79;
    final goldOz = _goldUSD ?? 2650.0;
    final goldGram = _goldTRYPerGram ?? (goldOz * usdTry / 31.1035);

    // Cross rates
    final eurTry = usdTry / eurUsd; // 1 EUR = X TRY
    final eurToUsd = 1 / eurUsd; // 1 EUR = X USD
    final gbpToUsd = 1 / gbpUsd; // 1 GBP = X USD

    if (isMinor) {
      // ─────────────────────────────────────────────────────────────────
      // MINOR CURRENCIES (TRY, SAR) - Show major currencies in local terms
      // ─────────────────────────────────────────────────────────────────
      if (selectedCurrency == 'TRY') {
        // TRY seçili → "🇺🇸 34.52 ₺ | 🇪🇺 37.18 ₺ | 🥇 2,890 ₺/gr"
        items = [
          RateItem(flag: '🇺🇸', value: usdTry, symbol: '₺'),
          RateItem(flag: '🇪🇺', value: eurTry, symbol: '₺'),
          RateItem(flag: '🥇', value: goldGram, symbol: '₺/gr', isGold: true),
        ];
      } else if (selectedCurrency == 'SAR') {
        // SAR seçili → Show rates in SAR (SAR is pegged ~3.75 to USD)
        final sarRate = _ratesInUSD['SAR'] ?? 3.75;
        final goldSar = goldOz * sarRate;
        items = [
          RateItem(flag: '🇺🇸', value: sarRate, symbol: '﷼'),
          RateItem(flag: '🇪🇺', value: sarRate / eurUsd, symbol: '﷼'),
          RateItem(flag: '🥇', value: goldSar, symbol: '\$/oz', isGold: true),
        ];
      }
    } else if (isMajor) {
      // ─────────────────────────────────────────────────────────────────
      // MAJOR CURRENCIES (USD, EUR, GBP) - Show other majors + gold
      // ─────────────────────────────────────────────────────────────────
      if (selectedCurrency == 'USD') {
        // USD seçili → "🇪🇺 0.93 € | 🇬🇧 0.79 £ | 🥇 $2,650/oz"
        items = [
          RateItem(flag: '🇪🇺', value: eurUsd, symbol: '€'),
          RateItem(flag: '🇬🇧', value: gbpUsd, symbol: '£'),
          RateItem(flag: '🥇', value: goldOz, symbol: '\$/oz', isGold: true),
        ];
      } else if (selectedCurrency == 'EUR') {
        // EUR seçili → "🇺🇸 1.08 $ | 🇬🇧 0.85 £ | 🥇 €2,465/oz"
        final gbpPerEur = gbpUsd / eurUsd;
        final goldEur = goldOz * eurUsd;
        items = [
          RateItem(flag: '🇺🇸', value: eurToUsd, symbol: '\$'),
          RateItem(flag: '🇬🇧', value: gbpPerEur, symbol: '£'),
          RateItem(flag: '🥇', value: goldEur, symbol: '€/oz', isGold: true),
        ];
      } else if (selectedCurrency == 'GBP') {
        // GBP seçili → "🇺🇸 1.27 $ | 🇪🇺 1.18 € | 🥇 £2,087/oz"
        final eurPerGbp = eurUsd / gbpUsd;
        final goldGbp = goldOz * gbpUsd;
        items = [
          RateItem(flag: '🇺🇸', value: gbpToUsd, symbol: '\$'),
          RateItem(flag: '🇪🇺', value: eurPerGbp, symbol: '€'),
          RateItem(flag: '🥇', value: goldGbp, symbol: '£/oz', isGold: true),
        ];
      }
    } else {
      // Unknown currency - show USD and EUR rates
      final rate = _ratesInUSD[selectedCurrency] ?? 1.0;
      items = [
        RateItem(flag: '🇺🇸', value: 1 / rate, symbol: '\$'),
        RateItem(flag: '🇪🇺', value: eurUsd / rate, symbol: '€'),
        RateItem(flag: '🥇', value: goldOz / rate, symbol: '/oz', isGold: true),
      ];
    }

    return RateBarData(
      items: items,
      selectedCurrency: selectedCurrency,
      lastUpdated: _lastFetch,
      source: _source,
    );
  }

  // ═══════════════════════════════════════════════════════════════════
  // FETCH METHODS
  // ═══════════════════════════════════════════════════════════════════

  /// Fetch all exchange rates
  /// Priority: 1. Firestore (Cloud Function), 2. Direct API, 3. Local cache
  /// Cache duration: 24 hours to prevent API rate limiting
  Future<void> fetchAllRates({bool forceRefresh = false}) async {
    // Cache check (24 hours)
    if (!forceRefresh && _lastFetch != null) {
      final age = DateTime.now().difference(_lastFetch!);
      if (age.inHours < 24 && _ratesInUSD.isNotEmpty) {
        return;
      }
    }

    if (_isLoading) return;
    _isLoading = true;

    try {
      // Try Firestore first (Cloud Function updates this every hour)
      final firestoreSuccess = await _fetchFromFirestore();

      if (!firestoreSuccess) {
        // Fallback to direct API calls
        await _fetchFromAPIs();
      }

      _lastFetch = DateTime.now();

      // Cache locally
      await _cacheRates();
    } catch (e) {
      // On error, try to load from local cache
      await _loadFromCache();
    } finally {
      _isLoading = false;
    }
  }

  /// Fetch rates from Firestore (primary source)
  Future<bool> _fetchFromFirestore() async {
    try {
      debugPrint('📊 [ExchangeRate] Fetching from Firestore...');
      final doc = await FirebaseFirestore.instance
          .doc(_firestorePath)
          .get(const GetOptions(source: Source.serverAndCache));

      if (!doc.exists) {
        debugPrint('📊 [ExchangeRate] Firestore doc not found');
        return false;
      }

      final data = doc.data();
      if (data == null) {
        debugPrint('📊 [ExchangeRate] Firestore data is null');
        return false;
      }

      // Parse rates
      final rates = data['rates'] as Map<String, dynamic>?;
      debugPrint('📊 [ExchangeRate] Raw rates from Firestore: $rates');

      if (rates != null) {
        _ratesInUSD = {};
        for (final entry in rates.entries) {
          if (entry.value is num) {
            _ratesInUSD[entry.key] = (entry.value as num).toDouble();
          }
        }
        _ratesInUSD['USD'] = 1.0;
      }

      debugPrint('📊 [ExchangeRate] Parsed _ratesInUSD: $_ratesInUSD');

      // Parse gold
      final gold = data['gold'] as Map<String, dynamic>?;
      if (gold != null) {
        _goldUSD = (gold['usdPerOz'] as num?)?.toDouble();
        _goldTRYPerGram = (gold['tryPerGram'] as num?)?.toDouble();
        debugPrint(
          '📊 [ExchangeRate] Gold - USD/oz: $_goldUSD, TRY/gr: $_goldTRYPerGram',
        );
      }

      // Parse timestamp
      final updatedAt = data['updatedAt'] as Timestamp?;
      if (updatedAt != null) {
        _lastFetch = updatedAt.toDate();
        debugPrint('📊 [ExchangeRate] Last updated: $_lastFetch');
      }

      _source = 'firestore';
      debugPrint(
        '📊 [ExchangeRate] ✅ Loaded ${_ratesInUSD.length} rates from Firestore',
      );
      return _ratesInUSD.isNotEmpty;
    } catch (e) {
      debugPrint('📊 [ExchangeRate] ❌ Firestore error: $e');
      return false;
    }
  }

  /// Fetch rates directly from APIs (fallback)
  Future<void> _fetchFromAPIs() async {
    await _fetchExchangeRates();
    await _fetchGoldPrice();
    _source = 'api';
  }

  /// Fetch exchange rates from API
  Future<void> _fetchExchangeRates() async {
    try {
      final response = await http
          .get(
            Uri.parse(_exchangeRateApiUrl),
            headers: {'Accept': 'application/json'},
          )
          .timeout(const Duration(seconds: 10));

      if (response.statusCode == 200) {
        final data = json.decode(response.body) as Map<String, dynamic>;
        final rates = data['rates'] as Map<String, dynamic>?;

        if (rates != null) {
          _ratesInUSD = {};
          for (final entry in rates.entries) {
            final value = entry.value;
            if (value is num) {
              _ratesInUSD[entry.key] = value.toDouble();
            }
          }
          _ratesInUSD['USD'] = 1.0;
        }
      }
    } catch (e) {
      // Keep existing rates if fetch fails
    }
  }

  /// Fetch gold price in USD per troy ounce
  Future<void> _fetchGoldPrice() async {
    // Try metals.live API first
    try {
      final response = await http
          .get(Uri.parse(_goldApiUrl), headers: {'Accept': 'application/json'})
          .timeout(const Duration(seconds: 5));

      if (response.statusCode == 200) {
        final data = json.decode(response.body);
        if (data is List && data.isNotEmpty) {
          final goldData = data[0] as Map<String, dynamic>?;
          final price = goldData?['price'];
          if (price is num && price > 0) {
            _goldUSD = price.toDouble();
            return;
          }
        }
      }
    } catch (e) {
      // Continue to fallback
    }

    // Fallback: Use Truncgil API for Turkish gold price
    await _fetchGoldFromTruncgil();
  }

  /// Fallback: Fetch gold from Truncgil and convert to USD
  Future<void> _fetchGoldFromTruncgil() async {
    try {
      final response = await http
          .get(
            Uri.parse(_truncgilGoldUrl),
            headers: {'Accept': 'application/json'},
          )
          .timeout(const Duration(seconds: 5));

      if (response.statusCode == 200) {
        final data = json.decode(response.body) as Map<String, dynamic>;
        final graData = data['GRA'] as Map<String, dynamic>?;

        if (graData != null) {
          final buyingTRY = (graData['Buying'] as num?)?.toDouble();
          final sellingTRY = (graData['Selling'] as num?)?.toDouble();

          if (buyingTRY != null && sellingTRY != null && buyingTRY > 0) {
            // Store TRY per gram directly
            _goldTRYPerGram = (buyingTRY + sellingTRY) / 2;

            // Convert to USD per oz if we have TRY rate
            final tryRate = _ratesInUSD['TRY'];
            if (tryRate != null && tryRate > 0) {
              _goldUSD = (_goldTRYPerGram! * 31.1035) / tryRate;
            }
          }
        }
      }
    } catch (e) {
      // Keep existing gold price
    }
  }

  // ═══════════════════════════════════════════════════════════════════
  // CONVERSION METHODS
  // ═══════════════════════════════════════════════════════════════════

  // Fallback rates (approximate, updated manually if needed)
  static const Map<String, double> _fallbackRates = {
    'USD': 1.0,
    'EUR': 0.92,
    'GBP': 0.79,
    'TRY': 34.5,
    'SAR': 3.75,
  };

  /// Convert amount from one currency to another
  double? convert(double amount, String from, String to) {
    if (from == to) return amount;

    // Use actual rates if available, otherwise use fallback
    final rates = _ratesInUSD.isNotEmpty ? _ratesInUSD : _fallbackRates;
    final source = _ratesInUSD.isNotEmpty ? 'live' : 'fallback';

    final fromRate = rates[from];
    final toRate = rates[to];

    // Debug logging for currency conversion
    debugPrint('💱 [Convert] $amount $from → $to');
    debugPrint('   Source: $source, Rates available: ${rates.keys.toList()}');
    debugPrint('   fromRate[$from]: $fromRate, toRate[$to]: $toRate');

    if (fromRate == null || toRate == null) {
      debugPrint('   ❌ Rate missing! Returning null');
      return null;
    }
    if (fromRate <= 0) {
      debugPrint('   ❌ Invalid fromRate! Returning null');
      return null;
    }

    final result = amount * (toRate / fromRate);
    debugPrint(
      '   ✅ Result: $result (formula: $amount * ($toRate / $fromRate))',
    );
    return result;
  }

  /// Get rate between two currencies
  double? getRate(String from, String to) {
    if (from == to) return 1.0;
    return convert(1, from, to);
  }

  /// Get display rates for the selected currency (legacy method)
  CurrencyDisplayRates getDisplayRates(String selectedCurrency) {
    final rates = <String, double>{};

    for (final currency in supportedCurrencies) {
      if (currency.code == selectedCurrency) {
        rates[currency.code] = 1.0;
      } else {
        final rate = convert(1, selectedCurrency, currency.code);
        if (rate != null) {
          rates[currency.code] = rate;
        }
      }
    }

    // Gold price in selected currency
    double? goldPrice;
    String goldUnit = 'oz';

    if (_goldUSD != null) {
      final selectedCurrencyObj = getCurrencyByCode(selectedCurrency);
      goldUnit = selectedCurrencyObj.goldUnit;

      // For TRY, use direct TRY/gram price if available
      if (selectedCurrency == 'TRY' && _goldTRYPerGram != null) {
        goldPrice = _goldTRYPerGram;
      } else {
        // Convert gold from USD to selected currency
        final goldInSelected = convert(_goldUSD!, 'USD', selectedCurrency);
        if (goldInSelected != null) {
          goldPrice = goldInSelected;
          if (goldUnit == 'gr') {
            goldPrice = goldPrice / 31.1035;
          }
        }
      }
    }

    return CurrencyDisplayRates(
      baseCurrency: selectedCurrency,
      rates: rates,
      goldPrice: goldPrice,
      goldUnit: goldUnit,
      lastUpdated: _lastFetch,
      source: _source,
    );
  }

  /// Get gold price in specified currency and unit
  double? getGoldPrice(String currencyCode, {String? unit}) {
    if (_goldUSD == null) return null;

    final currency = getCurrencyByCode(currencyCode);
    final targetUnit = unit ?? currency.goldUnit;

    // For TRY with gram unit, use direct price if available
    if (currencyCode == 'TRY' &&
        targetUnit == 'gr' &&
        _goldTRYPerGram != null) {
      return _goldTRYPerGram;
    }

    final goldInCurrency = convert(_goldUSD!, 'USD', currencyCode);
    if (goldInCurrency == null) return null;

    if (targetUnit == 'gr') {
      return goldInCurrency / 31.1035;
    }

    return goldInCurrency;
  }

  // ═══════════════════════════════════════════════════════════════════
  // CACHE METHODS
  // ═══════════════════════════════════════════════════════════════════

  /// Cache rates to SharedPreferences
  Future<void> _cacheRates() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      await prefs.setString(_ratesCacheKey, json.encode(_ratesInUSD));
      if (_goldUSD != null) {
        await prefs.setDouble(_goldCacheKey, _goldUSD!);
      }
      if (_goldTRYPerGram != null) {
        await prefs.setDouble(_goldTryKey, _goldTRYPerGram!);
      }
      if (_lastFetch != null) {
        await prefs.setString(_lastFetchKey, _lastFetch!.toIso8601String());
      }
    } catch (e) {
      // Ignore cache errors
    }
  }

  /// Load rates from local cache
  Future<void> _loadFromCache() async {
    try {
      final prefs = await SharedPreferences.getInstance();

      final ratesJson = prefs.getString(_ratesCacheKey);
      if (ratesJson != null) {
        final decoded = json.decode(ratesJson) as Map<String, dynamic>;
        _ratesInUSD = decoded.map((k, v) => MapEntry(k, (v as num).toDouble()));
      }

      final goldPrice = prefs.getDouble(_goldCacheKey);
      if (goldPrice != null && goldPrice > 0) {
        _goldUSD = goldPrice;
      }

      final goldTry = prefs.getDouble(_goldTryKey);
      if (goldTry != null && goldTry > 0) {
        _goldTRYPerGram = goldTry;
      }

      final lastFetchStr = prefs.getString(_lastFetchKey);
      if (lastFetchStr != null) {
        _lastFetch = DateTime.tryParse(lastFetchStr);
      }

      _source = 'cache';
    } catch (e) {
      // Ignore cache errors
    }
  }

  /// Initialize service (load from cache first, then fetch)
  Future<void> initialize() async {
    await _loadFromCache();
  }

  /// Clear all cached data
  Future<void> clearCache() async {
    _ratesInUSD = {};
    _goldUSD = null;
    _goldTRYPerGram = null;
    _lastFetch = null;
    _source = 'none';

    final prefs = await SharedPreferences.getInstance();
    await prefs.remove(_ratesCacheKey);
    await prefs.remove(_goldCacheKey);
    await prefs.remove(_goldTryKey);
    await prefs.remove(_lastFetchKey);
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// MODELS
// ═══════════════════════════════════════════════════════════════════════════

/// Single rate item for display in rate bar
class RateItem {
  final String flag;
  final double value;
  final String symbol;
  final bool isGold;

  const RateItem({
    required this.flag,
    required this.value,
    required this.symbol,
    this.isGold = false,
  });

  /// Formatted value string with appropriate decimal places
  String get formattedValue {
    String formatted;

    if (isGold) {
      // Gold: show as integer if > 100, otherwise 2 decimals
      if (value >= 1000) {
        // Add thousand separators for large gold values
        formatted = value
            .toStringAsFixed(0)
            .replaceAllMapped(
              RegExp(r'(\d{1,3})(?=(\d{3})+(?!\d))'),
              (Match m) => '${m[1]},',
            );
      } else if (value >= 100) {
        formatted = value.toStringAsFixed(0);
      } else {
        formatted = value.toStringAsFixed(2);
      }
    } else {
      // Currency rates: 2-4 decimal places based on value
      if (value >= 100) {
        formatted = value.toStringAsFixed(2);
      } else if (value >= 1) {
        formatted = value.toStringAsFixed(2);
      } else {
        formatted = value.toStringAsFixed(4);
      }
    }

    return '$formatted $symbol';
  }

  /// Just the formatted number without symbol
  String get formattedNumber {
    if (isGold) {
      if (value >= 1000) {
        return value
            .toStringAsFixed(0)
            .replaceAllMapped(
              RegExp(r'(\d{1,3})(?=(\d{3})+(?!\d))'),
              (Match m) => '${m[1]},',
            );
      } else if (value >= 100) {
        return value.toStringAsFixed(0);
      } else {
        return value.toStringAsFixed(2);
      }
    } else {
      if (value >= 100) {
        return value.toStringAsFixed(2);
      } else if (value >= 1) {
        return value.toStringAsFixed(2);
      } else {
        return value.toStringAsFixed(4);
      }
    }
  }
}

/// Rate bar data containing all items to display
class RateBarData {
  final List<RateItem> items;
  final String selectedCurrency;
  final DateTime? lastUpdated;
  final String source;

  const RateBarData({
    required this.items,
    required this.selectedCurrency,
    this.lastUpdated,
    this.source = 'none',
  });

  bool get isEmpty => items.isEmpty;
  bool get isNotEmpty => items.isNotEmpty;
}

/// Display rates model (legacy, kept for compatibility)
class CurrencyDisplayRates {
  final String baseCurrency;
  final Map<String, double> rates;
  final double? goldPrice;
  final String goldUnit;
  final DateTime? lastUpdated;
  final String source;

  const CurrencyDisplayRates({
    required this.baseCurrency,
    required this.rates,
    this.goldPrice,
    this.goldUnit = 'oz',
    this.lastUpdated,
    this.source = 'none',
  });

  bool hasRate(String code) => rates.containsKey(code);
  double? getRate(String code) => rates[code];

  String? get goldPriceFormatted {
    if (goldPrice == null) return null;
    final decimals = goldUnit == 'gr' ? 2 : 2;
    return goldPrice!.toStringAsFixed(decimals);
  }
}


--- FILE: lib/services/thinking_items_service.dart ---

import 'package:shared_preferences/shared_preferences.dart';
import '../models/models.dart';

/// Wealth Coach: ThinkingStats - Düşünüyorum istatistikleri
class ThinkingStats {
  final int totalCount;
  final int expiredCount;
  final int pendingCount;
  final double totalAmount;
  final double expiredAmount;
  final List<Expense> itemsNeedingReminder;

  const ThinkingStats({
    this.totalCount = 0,
    this.expiredCount = 0,
    this.pendingCount = 0,
    this.totalAmount = 0,
    this.expiredAmount = 0,
    this.itemsNeedingReminder = const [],
  });

  factory ThinkingStats.fromExpenses(List<Expense> expenses) {
    final thinkingItems = expenses
        .where((e) => e.decision == ExpenseDecision.thinking)
        .toList();

    final expiredItems = thinkingItems.where((e) => e.isExpired).toList();
    final pendingItems = thinkingItems.where((e) => !e.isExpired).toList();

    // 72 saat sonra hatırlatma gereken öğeler
    final reminderThreshold = DateTime.now().subtract(
      const Duration(hours: 72),
    );
    final needsReminder = thinkingItems.where((e) {
      final created = e.decisionDate ?? e.date;
      return created.isBefore(reminderThreshold) && !e.isExpired;
    }).toList();

    return ThinkingStats(
      totalCount: thinkingItems.length,
      expiredCount: expiredItems.length,
      pendingCount: pendingItems.length,
      totalAmount: thinkingItems.fold(0, (sum, e) => sum + e.amount),
      expiredAmount: expiredItems.fold(0, (sum, e) => sum + e.amount),
      itemsNeedingReminder: needsReminder,
    );
  }

  bool get hasExpiredItems => expiredCount > 0;
  bool get hasItemsNeedingReminder => itemsNeedingReminder.isNotEmpty;
}

/// Wealth Coach: Düşünüyorum listesi yönetimi servisi
class ThinkingItemsService {
  static const _keyLastExpirationCheck = 'thinking_last_expiration_check';
  static const _keyExpiredItemsNotified = 'thinking_expired_notified';

  /// Uygulama açılışında süresi dolan öğeleri kontrol et
  static Future<List<Expense>> checkAndExpireItems(
    List<Expense> expenses,
  ) async {
    final prefs = await SharedPreferences.getInstance();

    // Son kontrol zamanını al
    final lastCheckStr = prefs.getString(_keyLastExpirationCheck);
    final lastCheck = lastCheckStr != null
        ? DateTime.parse(lastCheckStr)
        : DateTime.now().subtract(const Duration(days: 1));

    // Günde bir kez kontrol et
    if (DateTime.now().difference(lastCheck).inHours < 24) {
      return [];
    }

    // Kontrol zamanını güncelle
    await prefs.setString(
      _keyLastExpirationCheck,
      DateTime.now().toIso8601String(),
    );

    // Süresi dolan thinking items'ları bul
    final expiredItems = expenses
        .where(
          (e) =>
              e.decision == ExpenseDecision.thinking &&
              e.isExpired &&
              e.status != ExpenseStatus.archived,
        )
        .toList();

    return expiredItems;
  }

  /// Süresi dolmuş öğeyi manuel olarak vazgeçilmiş olarak işaretle
  static Expense markAsAbandoned(Expense expense, {String? reason}) {
    return expense.copyWith(
      decision: ExpenseDecision.no,
      status: ExpenseStatus.archived,
      archivedAt: DateTime.now(),
      archiveReason: reason ?? 'Süre doldu - otomatik vazgeçildi',
    );
  }

  /// Süresi dolmuş öğeyi hâlâ almak istediğini işaretle
  static Expense markAsPurchased(Expense expense) {
    return expense.copyWith(
      decision: ExpenseDecision.yes,
      decisionDate: DateTime.now(),
    );
  }

  /// Düşünme süresini uzat (yeni karar tarihi ile)
  static Expense extendThinkingTime(Expense expense) {
    return expense.copyWith(decisionDate: DateTime.now());
  }

  /// 72 saat sonra hatırlatma gereken öğeleri getir
  static List<Expense> getItemsForReminder(List<Expense> expenses) {
    final reminderThreshold = DateTime.now().subtract(
      const Duration(hours: 72),
    );

    return expenses.where((e) {
      if (e.decision != ExpenseDecision.thinking) return false;
      if (e.isExpired) return false;

      final created = e.decisionDate ?? e.date;
      return created.isBefore(reminderThreshold);
    }).toList();
  }

  /// Kategori bazlı kalan süreyi formatla
  static String formatRemainingTime(Duration? remaining) {
    if (remaining == null ||
        remaining.isNegative ||
        remaining == Duration.zero) {
      return 'Süre doldu';
    }

    if (remaining.inDays > 0) {
      return '${remaining.inDays} gün kaldı';
    } else if (remaining.inHours > 0) {
      return '${remaining.inHours} saat kaldı';
    } else {
      return '${remaining.inMinutes} dk kaldı';
    }
  }

  /// Süresi yakında dolacak öğeler (son 6 saat)
  static List<Expense> getExpiringItems(List<Expense> expenses) {
    final warningThreshold = const Duration(hours: 6);

    return expenses.where((e) {
      if (e.decision != ExpenseDecision.thinking) return false;
      if (e.isExpired) return false;

      final remaining = e.remainingTime;
      return remaining != null && remaining <= warningThreshold;
    }).toList();
  }

  /// Bildirim gönderilmiş süresi dolmuş öğeleri takip et
  static Future<void> markExpiredAsNotified(List<String> expenseIds) async {
    final prefs = await SharedPreferences.getInstance();
    final existing = prefs.getStringList(_keyExpiredItemsNotified) ?? [];
    final updated = {...existing, ...expenseIds}.toList();
    await prefs.setStringList(_keyExpiredItemsNotified, updated);
  }

  /// Öğenin bildirilip bildirilmediğini kontrol et
  static Future<bool> wasNotified(String expenseId) async {
    final prefs = await SharedPreferences.getInstance();
    final notified = prefs.getStringList(_keyExpiredItemsNotified) ?? [];
    return notified.contains(expenseId);
  }

  /// Thinking items için özet mesaj oluştur
  static String getSummaryMessage(ThinkingStats stats) {
    if (stats.totalCount == 0) {
      return 'Düşündüğün bir harcama yok';
    }

    final parts = <String>[];

    if (stats.pendingCount > 0) {
      parts.add('${stats.pendingCount} harcama bekliyor');
    }

    if (stats.expiredCount > 0) {
      parts.add('${stats.expiredCount} karar bekliyor');
    }

    return parts.join(', ');
  }
}


--- FILE: lib/services/voice_parser_service.dart ---

import 'dart:convert';
import 'package:flutter/foundation.dart';
import 'package:http/http.dart' as http;
import 'package:flutter_dotenv/flutter_dotenv.dart';
import '../models/voice_parse_result.dart';

/// Service for parsing voice input into expense data
/// Uses hybrid approach: fast regex first, GPT-4o fallback for complex cases
class VoiceParserService {
  static final VoiceParserService _instance = VoiceParserService._();
  factory VoiceParserService() => _instance;
  VoiceParserService._();

  /// Category keywords for regex matching - keys match ExpenseCategory.all
  static const Map<String, List<String>> _categoryKeywords = {
    'Yiyecek': [
      'kahve',
      'coffee',
      'yemek',
      'food',
      'restoran',
      'restaurant',
      'market',
      'migros',
      'bim',
      'a101',
      'şok',
      'carrefour',
      'starbucks',
      'mcdonalds',
      'burger',
      'pizza',
      'döner',
      'kebap',
      'lokanta',
      'cafe',
      'kafe',
      'çay',
      'içecek',
      'atıştırmalık',
      'kahvaltı',
      'öğle yemeği',
      'akşam yemeği',
      'getir',
      'yemeksepeti',
      'glovo',
    ],
    'Ulaşım': [
      'uber',
      'taksi',
      'taxi',
      'benzin',
      'akaryakıt',
      'shell',
      'opet',
      'bp',
      'otobüs',
      'metro',
      'metrobüs',
      'tramvay',
      'vapur',
      'ferry',
      'uçak',
      'bilet',
      'thy',
      'pegasus',
      'ulaşım',
      'yol',
      'otopark',
      'parking',
      'bitaksi',
      'bolt',
      'grab',
    ],
    'Giyim': [
      'giyim',
      'ayakkabı',
      'çanta',
      'saat',
      'aksesuar',
      'kıyafet',
      'zara',
      'h&m',
      'lcw',
      'defacto',
      'koton',
      'mavi',
      'pantolon',
      'gömlek',
      'elbise',
      'ceket',
      'mont',
      'kazak',
    ],
    'Elektronik': [
      'telefon',
      'bilgisayar',
      'laptop',
      'tablet',
      'kulaklık',
      'elektronik',
      'iphone',
      'samsung',
      'apple',
      'macbook',
      'airpods',
      'şarj',
      'kablo',
      'adaptör',
      'monitor',
      'klavye',
      'mouse',
    ],
    'Eğlence': [
      'netflix',
      'spotify',
      'youtube',
      'prime',
      'disney',
      'eğlence',
      'sinema',
      'film',
      'konser',
      'tiyatro',
      'oyun',
      'game',
      'steam',
      'playstation',
      'xbox',
      'twitch',
      'müzik',
      'kitap',
      'dergi',
    ],
    'Sağlık': [
      'eczane',
      'pharmacy',
      'ilaç',
      'medicine',
      'doktor',
      'doctor',
      'hastane',
      'hospital',
      'klinik',
      'clinic',
      'sağlık',
      'health',
      'diş',
      'göz',
      'check-up',
      'muayene',
      'tedavi',
    ],
    'Eğitim': [
      'kurs',
      'course',
      'eğitim',
      'education',
      'okul',
      'school',
      'üniversite',
      'university',
      'udemy',
      'coursera',
      'özel ders',
      'dershane',
      'sınav',
      'exam',
    ],
    'Faturalar': [
      'fatura',
      'bill',
      'elektrik',
      'doğalgaz',
      'aidat',
      'kira',
      'rent',
    ],
    'Abonelik': [
      'abonelik',
      'subscription',
      'turkcell',
      'vodafone',
      'türk telekom',
      'internet',
      'telefon faturası',
      'aylık',
    ],
  };

  /// Amount patterns in Turkish
  static final List<RegExp> _amountPatterns = [
    // "50 lira", "50 TL", "50₺"
    RegExp(r'(\d+(?:[.,]\d+)?)\s*(?:lira|tl|₺)', caseSensitive: false),
    // "50 liralık"
    RegExp(r'(\d+(?:[.,]\d+)?)\s*liralık', caseSensitive: false),
    // Standalone numbers at start/end
    RegExp(r'^(\d+(?:[.,]\d+)?)\b'),
    RegExp(r'\b(\d+(?:[.,]\d+)?)$'),
    // Numbers with currency context
    RegExp(
      r'(\d+(?:[.,]\d+)?)\s*(?:para|tutar|ücret|fiyat)',
      caseSensitive: false,
    ),
  ];

  /// Main parse function - always uses AI for best accuracy
  Future<VoiceParseResult> parse(String text) async {
    final trimmed = text.trim();
    if (trimmed.isEmpty) {
      return VoiceParseResult.failed(text);
    }

    // Always use AI for parsing - handles any language and phrasing
    try {
      final aiResult = await parseWithAI(trimmed);
      if (aiResult.isValid) {
        return aiResult;
      }
    } catch (e) {
      debugPrint('[VoiceParser] AI error: $e');
      // AI failed, try basic regex fallback
    }

    // Fallback to basic regex only if AI fails
    return parseWithRegex(trimmed);
  }

  /// Parse using regex patterns (fast, no API cost)
  VoiceParseResult parseWithRegex(String text) {
    final normalized = _normalizeText(text);

    // Extract amount
    double? amount;
    for (final pattern in _amountPatterns) {
      final match = pattern.firstMatch(normalized);
      if (match != null) {
        final amountStr = match.group(1)!.replaceAll(',', '.');
        amount = double.tryParse(amountStr);
        if (amount != null && amount > 0) break;
      }
    }

    // Detect category
    String? category;
    final lowerText = normalized.toLowerCase();
    for (final entry in _categoryKeywords.entries) {
      for (final keyword in entry.value) {
        if (lowerText.contains(keyword)) {
          category = entry.key;
          break;
        }
      }
      if (category != null) break;
    }

    // Extract description (remove amount and currency markers)
    String description = text
        .replaceAll(
          RegExp(
            r'\d+(?:[.,]\d+)?\s*(?:lira|tl|₺|liralık)?',
            caseSensitive: false,
          ),
          '',
        )
        .replaceAll(RegExp(r'\s+'), ' ')
        .trim();

    if (description.isEmpty) {
      description = text;
    }

    // Try to extract merchant name
    String? merchantName;
    final knownMerchants = [
      'starbucks',
      'mcdonalds',
      'burger king',
      'kfc',
      'dominos',
      'migros',
      'bim',
      'a101',
      'şok',
      'carrefour',
      'uber',
      'bolt',
      'bitaksi',
      'netflix',
      'spotify',
      'youtube',
      'amazon',
      'trendyol',
      'hepsiburada',
      'getir',
      'yemeksepeti',
    ];

    for (final merchant in knownMerchants) {
      if (lowerText.contains(merchant)) {
        merchantName =
            merchant.substring(0, 1).toUpperCase() + merchant.substring(1);
        break;
      }
    }

    return VoiceParseResult.fromRegex(
      amount: amount,
      category: category,
      description: description,
      originalText: text,
      merchantName: merchantName,
    );
  }

  /// Parse using AI - handles any language naturally
  Future<VoiceParseResult> parseWithAI(String text) async {
    final apiKey = dotenv.env['OPENAI_API_KEY'];
    if (apiKey == null || apiKey.isEmpty) {
      throw Exception('OpenAI API key not configured');
    }

    // Use exact app category names from ExpenseCategory.all
    final prompt =
        '''Extract expense info from this sentence (any language):

"$text"

Return ONLY valid JSON:
{"amount": number or null, "description": "short description", "category": "CATEGORY", "store": "store name or null", "item": "item/product or null"}

IMPORTANT: category MUST be exactly one of these values:
Yiyecek, Ulaşım, Giyim, Elektronik, Eğlence, Sağlık, Eğitim, Faturalar, Abonelik, Diğer

Category guide:
- Yiyecek: food, groceries, restaurants, coffee, snacks
- Ulaşım: taxi, uber, gas, bus, metro, parking
- Giyim: clothes, shoes, accessories, shopping
- Elektronik: phone, laptop, electronics, gadgets
- Eğlence: netflix, spotify, games, cinema, entertainment
- Sağlık: medicine, doctor, pharmacy, health
- Eğitim: courses, books, school, education
- Faturalar: electricity, water, gas bills, rent
- Abonelik: subscriptions, monthly services
- Diğer: anything else

Field guide:
- store: The shop/brand name where purchase was made (HM, Starbucks, Migros, etc.)
- item: The specific product/item bought (Kazak, Kahve, Ekmek, etc.)
- description: Combine store + item if both exist, otherwise use what's available

Examples:
- "500 liraya HM'den kazak aldım" → {"amount": 500, "category": "Giyim", "store": "HM", "item": "Kazak", "description": "HM Kazak"}
- "Starbucks'ta kahve 80 lira" → {"amount": 80, "category": "Yiyecek", "store": "Starbucks", "item": "Kahve", "description": "Starbucks Kahve"}
- "Taksi tuttu 150" → {"amount": 150, "category": "Ulaşım", "store": null, "item": "Taksi", "description": "Taksi"}
- "Netflix 80 TL" → {"amount": 80, "category": "Eğlence", "store": "Netflix", "item": null, "description": "Netflix"}
- "Markete 200 verdim" → {"amount": 200, "category": "Yiyecek", "store": null, "item": null, "description": "Market alışverişi"}''';

    try {
      final response = await http
          .post(
            Uri.parse('https://api.openai.com/v1/chat/completions'),
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer $apiKey',
            },
            body: jsonEncode({
              'model': 'gpt-4o-mini',
              'messages': [
                {'role': 'user', 'content': prompt},
              ],
              'temperature': 0,
              'max_tokens': 100,
            }),
          )
          .timeout(const Duration(seconds: 30));

      if (response.statusCode != 200) {
        throw Exception('AI API error: ${response.statusCode}');
      }

      final data = jsonDecode(response.body);
      final content = data['choices'][0]['message']['content'] as String;

      // Extract JSON from response (handle markdown code blocks)
      String jsonStr = content.trim();
      if (jsonStr.contains('```')) {
        final jsonMatch = RegExp(
          r'```(?:json)?\s*([\s\S]*?)```',
        ).firstMatch(jsonStr);
        if (jsonMatch != null) {
          jsonStr = jsonMatch.group(1)!.trim();
        }
      }

      final parsed = jsonDecode(jsonStr) as Map<String, dynamic>;

      // Validate category is in allowed list
      final rawCategory = parsed['category'] as String? ?? 'Diğer';
      final validCategories = [
        'Yiyecek',
        'Ulaşım',
        'Giyim',
        'Elektronik',
        'Eğlence',
        'Sağlık',
        'Eğitim',
        'Faturalar',
        'Abonelik',
        'Diğer',
      ];
      final category = validCategories.contains(rawCategory)
          ? rawCategory
          : 'Diğer';

      // Extract store and item
      final store = parsed['store'] as String?;
      final item = parsed['item'] as String?;

      // Build result with high confidence since AI understood it
      return VoiceParseResult(
        amount: parsed['amount'] != null
            ? (parsed['amount'] as num).toDouble()
            : null,
        category: category,
        description: parsed['description'] as String? ?? text,
        originalText: text,
        confidence: parsed['amount'] != null
            ? VoiceConfidence.high
            : VoiceConfidence.low,
        source: VoiceParseSource.gpt,
        merchantName: store, // Use store as merchant name
        store: store,
        item: item,
      );
    } catch (e) {
      debugPrint('[VoiceParser] AI parse error: $e');
      return VoiceParseResult.failed(text);
    }
  }

  /// Legacy GPT method - kept for compatibility
  Future<VoiceParseResult> parseWithGPT(String text) => parseWithAI(text);

  /// Normalize Turkish text for matching
  String _normalizeText(String text) {
    return text
        .replaceAll('İ', 'i')
        .replaceAll('I', 'ı')
        .replaceAll('Ş', 'ş')
        .replaceAll('Ğ', 'ğ')
        .replaceAll('Ü', 'ü')
        .replaceAll('Ö', 'ö')
        .replaceAll('Ç', 'ç')
        .toLowerCase()
        .trim();
  }

  /// Get category display name
  static String getCategoryDisplayName(
    String? category, {
    bool turkish = true,
  }) {
    if (category == null) return turkish ? 'Diğer' : 'Other';

    final names = turkish
        ? {
            'food': 'Yiyecek',
            'transport': 'Ulaşım',
            'entertainment': 'Eğlence',
            'shopping': 'Giyim',
            'health': 'Sağlık',
            'bills': 'Faturalar',
            'education': 'Eğitim',
            'other': 'Diğer',
          }
        : {
            'food': 'Food',
            'transport': 'Transport',
            'entertainment': 'Entertainment',
            'shopping': 'Clothing',
            'health': 'Health',
            'bills': 'Bills',
            'education': 'Education',
            'other': 'Other',
          };

    return names[category.toLowerCase()] ?? (turkish ? 'Diğer' : 'Other');
  }

  /// Convert API category to app category
  static String mapToAppCategory(String? apiCategory) {
    if (apiCategory == null) return 'Diğer';

    // Valid app categories (must match ExpenseCategory.all)
    const validCategories = [
      'Yiyecek',
      'Ulaşım',
      'Giyim',
      'Elektronik',
      'Eğlence',
      'Sağlık',
      'Eğitim',
      'Faturalar',
      'Abonelik',
      'Diğer',
    ];

    // If already a valid category, return as-is
    if (validCategories.contains(apiCategory)) {
      return apiCategory;
    }

    // Fallback mapping for English categories (backwards compatibility)
    const englishMapping = {
      'food': 'Yiyecek',
      'transport': 'Ulaşım',
      'entertainment': 'Eğlence',
      'shopping': 'Giyim',
      'health': 'Sağlık',
      'bills': 'Faturalar',
      'education': 'Eğitim',
      'other': 'Diğer',
    };

    return englishMapping[apiCategory.toLowerCase()] ?? 'Diğer';
  }
}


--- FILE: lib/services/force_update_service.dart ---

import 'package:firebase_remote_config/firebase_remote_config.dart';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:url_launcher/url_launcher.dart';
import 'dart:io' show Platform;
import '../theme/theme.dart';
import 'package:vantag/l10n/app_localizations.dart';

/// Service for checking and enforcing app updates
class ForceUpdateService {
  static final ForceUpdateService _instance = ForceUpdateService._internal();
  factory ForceUpdateService() => _instance;
  ForceUpdateService._internal();

  static const String _currentVersion = '1.0.3';
  static const String _minVersionKey = 'min_app_version';
  static const String _recommendedVersionKey = 'recommended_app_version';

  // A/B Test flags
  static const String _paywallVariantKey = 'paywall_variant';
  static const String _onboardingShortKey = 'onboarding_short';

  late final FirebaseRemoteConfig _remoteConfig;
  bool _isInitialized = false;

  /// Initialize the service
  Future<void> initialize() async {
    if (_isInitialized) return;

    try {
      _remoteConfig = FirebaseRemoteConfig.instance;

      await _remoteConfig.setConfigSettings(
        RemoteConfigSettings(
          fetchTimeout: const Duration(seconds: 10),
          minimumFetchInterval: const Duration(hours: 1),
        ),
      );

      // Set defaults
      await _remoteConfig.setDefaults({
        _minVersionKey: '1.0.0',
        _recommendedVersionKey: '1.0.3',
        _paywallVariantKey: 'default',
        _onboardingShortKey: false,
      });

      // Fetch and activate
      await _remoteConfig.fetchAndActivate();

      _isInitialized = true;
      debugPrint('[ForceUpdate] Initialized - min: ${_remoteConfig.getString(_minVersionKey)}');
    } catch (e) {
      debugPrint('[ForceUpdate] Initialization error: $e');
    }
  }

  /// Check if current version is below minimum
  bool get isUpdateRequired {
    if (!_isInitialized) return false;

    final minVersion = _remoteConfig.getString(_minVersionKey);
    return _compareVersions(_currentVersion, minVersion) < 0;
  }

  /// Check if there's a recommended update
  bool get isUpdateRecommended {
    if (!_isInitialized) return false;

    final recommendedVersion = _remoteConfig.getString(_recommendedVersionKey);
    return _compareVersions(_currentVersion, recommendedVersion) < 0;
  }

  // A/B Test getters
  String get paywallVariant => _isInitialized
      ? _remoteConfig.getString(_paywallVariantKey)
      : 'default';

  bool get isOnboardingShort => _isInitialized
      ? _remoteConfig.getBool(_onboardingShortKey)
      : false;

  /// Compare version strings (returns -1 if v1 < v2, 0 if equal, 1 if v1 > v2)
  int _compareVersions(String v1, String v2) {
    final parts1 = v1.split('.').map(int.parse).toList();
    final parts2 = v2.split('.').map(int.parse).toList();

    for (var i = 0; i < 3; i++) {
      final p1 = i < parts1.length ? parts1[i] : 0;
      final p2 = i < parts2.length ? parts2[i] : 0;

      if (p1 < p2) return -1;
      if (p1 > p2) return 1;
    }
    return 0;
  }

  /// Show force update dialog
  static Future<void> showUpdateDialog(BuildContext context) async {
    final l10n = AppLocalizations.of(context);

    await showDialog(
      context: context,
      barrierDismissible: false,
      barrierColor: Colors.black.withValues(alpha: 0.9),
      builder: (context) => WillPopScope(
        onWillPop: () async => false,
        child: Dialog(
          backgroundColor: context.appColors.surface,
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
          child: Padding(
            padding: const EdgeInsets.all(24),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Container(
                  width: 70,
                  height: 70,
                  decoration: BoxDecoration(
                    color: context.appColors.warning.withValues(alpha: 0.15),
                    shape: BoxShape.circle,
                  ),
                  child: Icon(
                    CupertinoIcons.arrow_2_circlepath,
                    size: 36,
                    color: context.appColors.warning,
                  ),
                ),

                const SizedBox(height: 20),

                Text(
                  l10n.updateRequired,
                  style: TextStyle(
                    fontSize: 22,
                    fontWeight: FontWeight.bold,
                    color: context.appColors.textPrimary,
                  ),
                ),

                const SizedBox(height: 12),

                Text(
                  l10n.updateRequiredMessage,
                  textAlign: TextAlign.center,
                  style: TextStyle(
                    fontSize: 15,
                    color: context.appColors.textSecondary,
                    height: 1.5,
                  ),
                ),

                const SizedBox(height: 24),

                SizedBox(
                  width: double.infinity,
                  child: ElevatedButton(
                    onPressed: () => _openStore(),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: context.appColors.primary,
                      foregroundColor: Colors.white,
                      padding: const EdgeInsets.symmetric(vertical: 16),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                    ),
                    child: Text(
                      l10n.updateNow,
                      style: const TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  static Future<void> _openStore() async {
    final url = Platform.isIOS
        ? 'https://apps.apple.com/app/id6740157696'
        : 'https://play.google.com/store/apps/details?id=com.vantag.app';

    await launchUrl(Uri.parse(url), mode: LaunchMode.externalApplication);
  }
}

/// Global instance
final forceUpdateService = ForceUpdateService();


--- FILE: lib/services/budget_service.dart ---

import 'package:flutter/foundation.dart';
import '../models/expense.dart';
import '../models/user_profile.dart';
import '../providers/finance_provider.dart';

/// Bütçe hesaplama servisi
/// Zorunlu gider, taksit ve harcanabilir bütçe hesaplamalarını yapar
class BudgetService extends ChangeNotifier {
  final FinanceProvider _financeProvider;

  BudgetService(this._financeProvider) {
    // Provider değiştiğinde biz de güncelleniriz
    _financeProvider.addListener(_onProviderChanged);
  }

  void _onProviderChanged() {
    notifyListeners();
  }

  @override
  void dispose() {
    _financeProvider.removeListener(_onProviderChanged);
    super.dispose();
  }

  // ═══════════════════════════════════════════════════════════════
  // TEMEL GETTER'LAR
  // ═══════════════════════════════════════════════════════════════

  UserProfile? get _profile => _financeProvider.userProfile;
  List<Expense> get _currentMonthExpenses =>
      _financeProvider.currentMonthExpenses;

  /// Saatlik ücret (fallback ile)
  double get hourlyRate {
    if (_profile == null) return 0;
    final rate = _profile!.hourlyRate;
    if (rate <= 0) {
      // Fallback: aylık gelir / 160 saat (standart çalışma)
      return _profile!.monthlyIncome / 160;
    }
    return rate;
  }

  /// Aylık gelir
  double get monthlyIncome => _profile?.monthlyIncome ?? 0;

  // ═══════════════════════════════════════════════════════════════
  // BÜTÇE HESAPLAMALARI
  // ═══════════════════════════════════════════════════════════════

  /// Toplam bütçe (kullanıcı belirledi veya gelir)
  double get totalBudget {
    return _profile?.monthlyBudget ?? monthlyIncome;
  }

  /// Tasarruf hedefi
  double get savingsGoal => _profile?.monthlySavingsGoal ?? 0;

  /// Harcanabilir bütçe (toplam - tasarruf hedefi)
  /// NOT: Zorunlu giderler burada düşülmüyor, onlar ayrı gösterilecek
  double get spendableBudget {
    return totalBudget - savingsGoal;
  }

  // ═══════════════════════════════════════════════════════════════
  // HARCAMA ANALİZİ
  // ═══════════════════════════════════════════════════════════════

  /// Bu ayki toplam harcama
  double get totalExpenses {
    return _currentMonthExpenses.fold(0.0, (sum, e) => sum + e.amount);
  }

  /// Zorunlu giderler toplamı (kira, fatura, kredi vs.)
  /// NOT: "Vazgeçtim" (decision=no) harcamalar hariç
  double get mandatoryExpenses {
    return _currentMonthExpenses
        .where((e) => e.isMandatory && e.decision != ExpenseDecision.no)
        .fold(0.0, (sum, e) => sum + e.amount);
  }

  /// İsteğe bağlı harcamalar (zorunlu olmayanlar)
  /// NOT: "Vazgeçtim" (decision=no) harcamalar hariç - bunlar gerçek harcama değil
  double get discretionaryExpenses {
    return _currentMonthExpenses
        .where((e) => !e.isMandatory && e.decision != ExpenseDecision.no)
        .fold(0.0, (sum, e) => sum + e.amount);
  }

  /// Bu ayki taksit ödemeleri toplamı
  double get installmentPayments {
    return _currentMonthExpenses
        .where((e) => e.type == ExpenseType.installment)
        .fold(0.0, (sum, e) => sum + e.amount);
  }

  /// Bu ay ödenen vade farkı toplamı (tahmini)
  /// Her taksit için: toplam vade farkı / taksit sayısı
  double get totalInterestPaid {
    return _currentMonthExpenses
        .where(
          (e) =>
              e.type == ExpenseType.installment &&
              e.installmentCount != null &&
              e.installmentCount! > 0,
        )
        .fold(0.0, (sum, e) => sum + (e.interestAmount / e.installmentCount!));
  }

  // ═══════════════════════════════════════════════════════════════
  // KALAN BÜTÇE
  // ═══════════════════════════════════════════════════════════════

  /// Gerçek harcanabilir bütçe (zorunlu giderler düşülmüş)
  /// Bu, kullanıcının "kontrol edebildiği" alan
  double get availableBudget {
    final available = spendableBudget - mandatoryExpenses;
    return available > 0 ? available : 0;
  }

  /// Kalan bütçe (harcanabilir - isteğe bağlı harcamalar)
  double get remainingBudget {
    return availableBudget - discretionaryExpenses;
  }

  /// Bütçe aşıldı mı?
  bool get isOverBudget => remainingBudget < 0;

  // ═══════════════════════════════════════════════════════════════
  // PROGRESS BAR
  // ═══════════════════════════════════════════════════════════════

  /// Progress bar yüzdesi (isteğe bağlı harcamalar / harcanabilir bütçe)
  /// 0-100 arası, aşım varsa 100'ü geçebilir (max 150)
  double get budgetUsagePercent {
    if (availableBudget <= 0) return 100;
    final percent = (discretionaryExpenses / availableBudget) * 100;
    return percent.clamp(0, 150);
  }

  /// Progress bar renk seviyesi
  /// 0: Yeşil (<%50), 1: Sarı (%50-70), 2: Turuncu (%70-90), 3: Kırmızı (>%90)
  int get budgetWarningLevel {
    final percent = budgetUsagePercent;
    if (percent < 50) return 0;
    if (percent < 70) return 1;
    if (percent < 90) return 2;
    return 3;
  }

  // ═══════════════════════════════════════════════════════════════
  // SAAT HESAPLAMALARI (Zaman = Para)
  // ═══════════════════════════════════════════════════════════════

  /// Kalan bütçenin saat karşılığı
  double get remainingHours {
    if (hourlyRate <= 0) return 0;
    return remainingBudget / hourlyRate;
  }

  /// Kullanılan bütçenin saat karşılığı (isteğe bağlı)
  double get usedHours {
    if (hourlyRate <= 0) return 0;
    return discretionaryExpenses / hourlyRate;
  }

  /// Zorunlu giderlerin saat karşılığı
  double get mandatoryHours {
    if (hourlyRate <= 0) return 0;
    return mandatoryExpenses / hourlyRate;
  }

  /// Bu ay ödenen vade farklarının saat karşılığı
  double get interestHours {
    if (hourlyRate <= 0) return 0;
    return totalInterestPaid / hourlyRate;
  }

  /// Toplam bütçenin saat karşılığı
  double get totalBudgetHours {
    if (hourlyRate <= 0) return 0;
    return totalBudget / hourlyRate;
  }

  /// Harcanabilir bütçenin saat karşılığı
  double get availableBudgetHours {
    if (hourlyRate <= 0) return 0;
    return availableBudget / hourlyRate;
  }

  // ═══════════════════════════════════════════════════════════════
  // TAKSİT ANALİZİ
  // ═══════════════════════════════════════════════════════════════

  /// Aktif taksitler listesi
  List<Expense> get activeInstallments {
    return _financeProvider.activeInstallments;
  }

  /// Toplam aktif taksit sayısı
  int get activeInstallmentCount => activeInstallments.length;

  /// Aylık toplam taksit yükü
  double get monthlyInstallmentBurden {
    return activeInstallments.fold(0.0, (sum, e) => sum + e.installmentAmount);
  }

  /// Toplam kalan taksit borcu
  double get totalRemainingDebt {
    return activeInstallments.fold(0.0, (sum, e) {
      final remaining = e.remainingInstallments * e.installmentAmount;
      return sum + remaining;
    });
  }

  /// Toplam vade farkı (tüm aktif taksitler)
  double get totalInterestAmount {
    return activeInstallments.fold(0.0, (sum, e) => sum + e.interestAmount);
  }

  /// Toplam vade farkının saat karşılığı
  double get totalInterestHours {
    if (hourlyRate <= 0) return 0;
    return totalInterestAmount / hourlyRate;
  }

  // ═══════════════════════════════════════════════════════════════
  // HELPER METODLAR
  // ═══════════════════════════════════════════════════════════════

  /// Belirli bir tutarın saat karşılığı
  double amountToHours(double amount) {
    if (hourlyRate <= 0) return 0;
    return amount / hourlyRate;
  }

  /// Belirli bir saatin TL karşılığı
  double hoursToAmount(double hours) {
    return hours * hourlyRate;
  }

  /// Özet bilgi (debug/logging için)
  Map<String, dynamic> get summary => {
    'totalBudget': totalBudget,
    'savingsGoal': savingsGoal,
    'mandatoryExpenses': mandatoryExpenses,
    'discretionaryExpenses': discretionaryExpenses,
    'availableBudget': availableBudget,
    'remainingBudget': remainingBudget,
    'budgetUsagePercent': budgetUsagePercent,
    'hourlyRate': hourlyRate,
    'remainingHours': remainingHours,
    'activeInstallments': activeInstallmentCount,
    'monthlyInstallmentBurden': monthlyInstallmentBurden,
  };
}


--- FILE: lib/services/error_logging_service.dart ---

import 'package:firebase_crashlytics/firebase_crashlytics.dart';
import 'package:flutter/foundation.dart';

/// Centralized error logging service for Firebase Crashlytics
/// Ensures sensitive data is not leaked to crash reports
class ErrorLoggingService {
  // Patterns to redact from logs
  static final _sensitivePatterns = [
    RegExp(r'Bearer\s+[\w.-]+', caseSensitive: false),
    RegExp(r'api.?key\s*[=:]\s*\S+', caseSensitive: false),
    RegExp(r'password\s*[=:]\s*\S+', caseSensitive: false),
    RegExp(r'secret\s*[=:]\s*\S+', caseSensitive: false),
    RegExp(r'token\s*[=:]\s*\S+', caseSensitive: false),
    RegExp(r'sk-[A-Za-z0-9]{20,}'), // OpenAI API keys
    RegExp(r'AIza[A-Za-z0-9_-]{35}'), // Google/Firebase API keys
  ];

  /// Redact sensitive data from string
  static String _redactSensitive(String input) {
    var result = input;
    for (final pattern in _sensitivePatterns) {
      result = result.replaceAll(pattern, '[REDACTED]');
    }
    return result;
  }
  static final ErrorLoggingService _instance = ErrorLoggingService._internal();
  factory ErrorLoggingService() => _instance;
  ErrorLoggingService._internal();

  final FirebaseCrashlytics _crashlytics = FirebaseCrashlytics.instance;

  /// Log a non-fatal error to Crashlytics
  Future<void> logError(
    dynamic error,
    StackTrace? stackTrace, {
    String? reason,
    bool fatal = false,
    Map<String, dynamic>? extraInfo,
  }) async {
    try {
      // Log to debug console
      debugPrint('[$reason] Error: $error');
      if (stackTrace != null) {
        debugPrint('StackTrace: $stackTrace');
      }

      // Add custom keys for extra context
      if (extraInfo != null) {
        for (final entry in extraInfo.entries) {
          await _crashlytics.setCustomKey(entry.key, entry.value.toString());
        }
      }

      // Record to Crashlytics
      await _crashlytics.recordError(
        error,
        stackTrace,
        reason: reason,
        fatal: fatal,
      );
    } catch (e) {
      debugPrint('[ErrorLogging] Failed to log error: $e');
    }
  }

  /// Log a custom message to Crashlytics
  Future<void> log(String message) async {
    try {
      debugPrint('[Log] $message');
      await _crashlytics.log(message);
    } catch (e) {
      debugPrint('[ErrorLogging] Failed to log message: $e');
    }
  }

  /// Log API error with details (redacts sensitive data)
  Future<void> logApiError({
    required String endpoint,
    required int? statusCode,
    required dynamic error,
    StackTrace? stackTrace,
    String? responseBody,
  }) async {
    // Redact sensitive data from response body
    final safeResponseBody = responseBody != null
        ? _redactSensitive(responseBody.substring(0, (responseBody.length).clamp(0, 500)))
        : 'null';

    await logError(
      error,
      stackTrace,
      reason: 'API Error: $endpoint',
      extraInfo: {
        'endpoint': endpoint,
        'statusCode': statusCode ?? 'null',
        'responseBody': safeResponseBody,
      },
    );
  }

  /// Log parse error with details (redacts sensitive data)
  Future<void> logParseError({
    required String dataType,
    required dynamic error,
    StackTrace? stackTrace,
    String? rawData,
  }) async {
    // Redact sensitive data from raw data
    final safeRawData = rawData != null
        ? _redactSensitive(rawData.substring(0, (rawData.length).clamp(0, 200)))
        : 'null';

    await logError(
      error,
      stackTrace,
      reason: 'Parse Error: $dataType',
      extraInfo: {
        'dataType': dataType,
        'rawDataPreview': safeRawData,
      },
    );
  }

  /// Log offline error
  Future<void> logOfflineError(String feature) async {
    await log('Offline attempt: $feature');
  }

  /// Set user identifier for error tracking
  Future<void> setUserId(String userId) async {
    try {
      await _crashlytics.setUserIdentifier(userId);
    } catch (e) {
      debugPrint('[ErrorLogging] Failed to set user ID: $e');
    }
  }
}

/// Global instance for easy access
final errorLogger = ErrorLoggingService();


--- FILE: lib/services/streak_service.dart ---

import 'package:shared_preferences/shared_preferences.dart';

/// Streak milestone rewards
class StreakReward {
  final int milestone;
  final int proDaysGranted;
  final String title;
  final String description;

  const StreakReward({
    required this.milestone,
    required this.proDaysGranted,
    required this.title,
    required this.description,
  });

  static const rewards = [
    StreakReward(
      milestone: 7,
      proDaysGranted: 1,
      title: '7 Gün Serisi!',
      description: '1 gün ücretsiz Pro kazandın!',
    ),
    StreakReward(
      milestone: 30,
      proDaysGranted: 3,
      title: '30 Gün Serisi!',
      description: '3 gün ücretsiz Pro kazandın!',
    ),
    StreakReward(
      milestone: 100,
      proDaysGranted: 7,
      title: '100 Gün Serisi!',
      description: '7 gün ücretsiz Pro kazandın!',
    ),
  ];

  static StreakReward? getRewardForMilestone(int streak) {
    return rewards.where((r) => r.milestone == streak).firstOrNull;
  }
}

class StreakData {
  final int currentStreak;
  final int longestStreak;
  final DateTime? lastEntryDate;
  final bool isStale; // Streak kırılmış mı?
  final StreakReward? unclaimedReward; // Henüz alınmamış ödül

  const StreakData({
    required this.currentStreak,
    required this.longestStreak,
    this.lastEntryDate,
    this.isStale = false,
    this.unclaimedReward,
  });

  bool get hasStreak => displayStreak > 0;
  bool get isNewRecord =>
      !isStale && currentStreak > 0 && currentStreak >= longestStreak;

  /// Gösterilecek streak değeri (kırılmışsa 0)
  int get displayStreak => isStale ? 0 : currentStreak;

  /// Streak risk altında mı? (Son 4 saat içinde bozulabilir)
  bool get isAtRisk {
    if (lastEntryDate == null || currentStreak == 0) return false;
    final now = DateTime.now();
    final endOfDay = DateTime(now.year, now.month, now.day, 23, 59, 59);
    final hoursUntilMidnight = endOfDay.difference(now).inHours;
    return hoursUntilMidnight <= 4 && !_isToday(lastEntryDate!);
  }

  bool _isToday(DateTime date) {
    final now = DateTime.now();
    return date.year == now.year &&
           date.month == now.month &&
           date.day == now.day;
  }
}

class StreakService {
  static const _keyCurrentStreak = 'streak_current';
  static const _keyLongestStreak = 'streak_longest';
  static const _keyLastEntryDate = 'streak_last_entry';
  static const _keyClaimedRewards = 'streak_claimed_rewards';

  /// Streak verilerini getirir (SADECE OKUMA - side effect yok)
  Future<StreakData> getStreakData() async {
    final prefs = await SharedPreferences.getInstance();

    final currentStreak = prefs.getInt(_keyCurrentStreak) ?? 0;
    final longestStreak = prefs.getInt(_keyLongestStreak) ?? 0;
    final lastEntryStr = prefs.getString(_keyLastEntryDate);

    DateTime? lastEntryDate;
    if (lastEntryStr != null) {
      lastEntryDate = DateTime.tryParse(lastEntryStr);
    }

    // Streak kırılmış mı kontrol et (ama VERİYİ DEĞİŞTİRME)
    bool isStale = false;
    if (lastEntryDate != null && currentStreak > 0) {
      final daysDiff = _daysDifference(lastEntryDate, DateTime.now());
      if (daysDiff > 1) {
        // Streak kırılmış, ama burada sadece işaretle
        isStale = true;
      }
    }

    return StreakData(
      currentStreak: currentStreak,
      longestStreak: longestStreak,
      lastEntryDate: lastEntryDate,
      isStale: isStale,
    );
  }

  /// Harcama girişinde streak'i günceller
  Future<StreakData> recordEntry() async {
    final prefs = await SharedPreferences.getInstance();
    final now = DateTime.now();
    final today = DateTime(now.year, now.month, now.day);

    final lastEntryStr = prefs.getString(_keyLastEntryDate);
    DateTime? lastEntryDate;
    if (lastEntryStr != null) {
      lastEntryDate = DateTime.tryParse(lastEntryStr);
    }

    int currentStreak = prefs.getInt(_keyCurrentStreak) ?? 0;
    int longestStreak = prefs.getInt(_keyLongestStreak) ?? 0;

    if (lastEntryDate == null) {
      // İlk giriş
      currentStreak = 1;
    } else {
      final lastDate = DateTime(
        lastEntryDate.year,
        lastEntryDate.month,
        lastEntryDate.day,
      );
      final daysDiff = _daysDifference(lastDate, today);

      if (daysDiff == 0) {
        // Bugün zaten giriş yapılmış, streak değişmez
        return StreakData(
          currentStreak: currentStreak,
          longestStreak: longestStreak,
          lastEntryDate: lastEntryDate,
        );
      } else if (daysDiff == 1) {
        // Dün giriş yapılmış, streak artır
        currentStreak++;
      } else {
        // Gün atlanmış, streak sıfırla ve yeniden başla
        currentStreak = 1;
      }
    }

    // En uzun streak'i güncelle
    if (currentStreak > longestStreak) {
      longestStreak = currentStreak;
      await prefs.setInt(_keyLongestStreak, longestStreak);
    }

    // Kaydet
    await prefs.setInt(_keyCurrentStreak, currentStreak);
    await prefs.setString(_keyLastEntryDate, today.toIso8601String());

    return StreakData(
      currentStreak: currentStreak,
      longestStreak: longestStreak,
      lastEntryDate: today,
    );
  }

  /// Kırılmış streak'i temizle (explicit çağrı gerekir)
  Future<void> cleanupStaleStreak() async {
    final data = await getStreakData();
    if (data.isStale) {
      final prefs = await SharedPreferences.getInstance();
      await prefs.setInt(_keyCurrentStreak, 0);
      await prefs.remove(_keyLastEntryDate);
    }
  }

  /// İki tarih arasındaki gün farkını hesaplar
  int _daysDifference(DateTime from, DateTime to) {
    final fromDate = DateTime(from.year, from.month, from.day);
    final toDate = DateTime(to.year, to.month, to.day);
    return toDate.difference(fromDate).inDays;
  }

  /// Streak'i tamamen sıfırlar (test için)
  Future<void> resetAllStreakData() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.remove(_keyCurrentStreak);
    await prefs.remove(_keyLongestStreak);
    await prefs.remove(_keyLastEntryDate);
    await prefs.remove(_keyClaimedRewards);
  }

  /// Check for unclaimed streak rewards
  Future<StreakReward?> checkForUnclaimedReward() async {
    final prefs = await SharedPreferences.getInstance();
    final currentStreak = prefs.getInt(_keyCurrentStreak) ?? 0;
    final claimedRewards = prefs.getStringList(_keyClaimedRewards) ?? [];

    for (final reward in StreakReward.rewards) {
      if (currentStreak >= reward.milestone &&
          !claimedRewards.contains('${reward.milestone}')) {
        return reward;
      }
    }
    return null;
  }

  /// Claim a streak reward and return Pro days granted
  Future<int> claimReward(StreakReward reward) async {
    final prefs = await SharedPreferences.getInstance();
    final claimedRewards = prefs.getStringList(_keyClaimedRewards) ?? [];

    if (claimedRewards.contains('${reward.milestone}')) {
      return 0; // Already claimed
    }

    claimedRewards.add('${reward.milestone}');
    await prefs.setStringList(_keyClaimedRewards, claimedRewards);

    return reward.proDaysGranted;
  }

  /// Get list of claimed reward milestones
  Future<List<int>> getClaimedRewardMilestones() async {
    final prefs = await SharedPreferences.getInstance();
    final claimedRewards = prefs.getStringList(_keyClaimedRewards) ?? [];
    return claimedRewards.map((s) => int.parse(s)).toList();
  }

  /// Get next milestone for current streak
  Future<({int milestone, int daysRemaining})?> getNextMilestone() async {
    final prefs = await SharedPreferences.getInstance();
    final currentStreak = prefs.getInt(_keyCurrentStreak) ?? 0;

    for (final reward in StreakReward.rewards) {
      if (currentStreak < reward.milestone) {
        return (
          milestone: reward.milestone,
          daysRemaining: reward.milestone - currentStreak,
        );
      }
    }
    return null;
  }
}


--- FILE: lib/services/tour_service.dart ---

import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:vantag/l10n/app_localizations.dart';

/// Discovery Tour management service
class TourService {
  static const _keyHasSeenTour = 'has_seen_tour';
  static const _keyTourVersion = 'tour_version';

  // Tour version - increment when new features are added
  static const int currentTourVersion = 1;

  /// Has the user seen the tour before?
  static Future<bool> hasSeenTour() async {
    final prefs = await SharedPreferences.getInstance();
    final seenVersion = prefs.getInt(_keyTourVersion) ?? 0;
    return seenVersion >= currentTourVersion;
  }

  /// Mark tour as complete
  static Future<void> markTourComplete() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_keyHasSeenTour, true);
    await prefs.setInt(_keyTourVersion, currentTourVersion);
  }

  /// Reset tour (to restart from settings)
  static Future<void> resetTour() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.remove(_keyHasSeenTour);
    await prefs.setInt(_keyTourVersion, 0);
  }
}

/// Tour GlobalKeys
class TourKeys {
  // Expense Screen
  static final amountField = GlobalKey();
  static final descriptionField = GlobalKey();
  static final categoryField = GlobalKey();
  static final dateChips = GlobalKey();
  static final calculateButton = GlobalKey();

  // Main Screen - Nav Bar
  static final navBarExpense = GlobalKey();
  static final navBarReport = GlobalKey();
  static final navBarAchievements = GlobalKey();
  static final navBarProfile = GlobalKey();
  static final navBarAddButton = GlobalKey();

  // Header
  static final streakWidget = GlobalKey();
  static final subscriptionButton = GlobalKey();

  // Financial Snapshot
  static final financialSnapshot = GlobalKey();

  // Currency Rates
  static final currencyRates = GlobalKey();
}

/// Tour step information
class TourStep {
  final GlobalKey key;
  final String title;
  final String description;
  final ShapeBorder? shapeBorder;

  const TourStep({
    required this.key,
    required this.title,
    required this.description,
    this.shapeBorder,
  });
}

/// Tour steps list builder
class TourSteps {
  static List<TourStep> getAll(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    return [
      TourStep(
        key: TourKeys.amountField,
        title: l10n.tourAmountTitle,
        description: l10n.tourAmountDesc,
      ),
      TourStep(
        key: TourKeys.descriptionField,
        title: l10n.tourDescriptionTitle,
        description: l10n.tourDescriptionDesc,
      ),
      TourStep(
        key: TourKeys.categoryField,
        title: l10n.tourCategoryTitle,
        description: l10n.tourCategoryDesc,
      ),
      TourStep(
        key: TourKeys.dateChips,
        title: l10n.tourDateTitle,
        description: l10n.tourDateDesc,
      ),
      TourStep(
        key: TourKeys.financialSnapshot,
        title: l10n.tourSnapshotTitle,
        description: l10n.tourSnapshotDesc,
      ),
      TourStep(
        key: TourKeys.currencyRates,
        title: l10n.tourCurrencyTitle,
        description: l10n.tourCurrencyDesc,
      ),
      TourStep(
        key: TourKeys.streakWidget,
        title: l10n.tourStreakTitle,
        description: l10n.tourStreakDesc,
      ),
      TourStep(
        key: TourKeys.subscriptionButton,
        title: l10n.tourSubscriptionTitle,
        description: l10n.tourSubscriptionDesc,
      ),
      TourStep(
        key: TourKeys.navBarReport,
        title: l10n.tourReportTitle,
        description: l10n.tourReportDesc,
      ),
      TourStep(
        key: TourKeys.navBarAchievements,
        title: l10n.tourAchievementsTitle,
        description: l10n.tourAchievementsDesc,
      ),
      TourStep(
        key: TourKeys.navBarProfile,
        title: l10n.tourProfileTitle,
        description: l10n.tourProfileDesc,
      ),
      TourStep(
        key: TourKeys.navBarAddButton,
        title: l10n.tourQuickAddTitle,
        description: l10n.tourQuickAddDesc,
      ),
    ];
  }
}


--- FILE: lib/services/currency_service.dart ---

import 'dart:convert';
import 'package:http/http.dart' as http;
import 'package:shared_preferences/shared_preferences.dart';
import 'package:xml/xml.dart' as xml;
import 'error_logging_service.dart';

class ExchangeRates {
  final double usdBuying;
  final double usdSelling;
  final double eurBuying;
  final double eurSelling;
  final double goldBuying;
  final double goldSelling;
  final DateTime lastUpdated;
  final bool goldFromApi; // true: Truncgil API'den, false: fallback hesaplama

  const ExchangeRates({
    required this.usdBuying,
    required this.usdSelling,
    required this.eurBuying,
    required this.eurSelling,
    required this.goldBuying,
    required this.goldSelling,
    required this.lastUpdated,
    this.goldFromApi = true,
  });

  Map<String, dynamic> toJson() => {
    'usdBuying': usdBuying,
    'usdSelling': usdSelling,
    'eurBuying': eurBuying,
    'eurSelling': eurSelling,
    'goldBuying': goldBuying,
    'goldSelling': goldSelling,
    'lastUpdated': lastUpdated.toIso8601String(),
    'goldFromApi': goldFromApi,
  };

  factory ExchangeRates.fromJson(Map<String, dynamic> json) => ExchangeRates(
    usdBuying: (json['usdBuying'] as num).toDouble(),
    usdSelling: (json['usdSelling'] as num).toDouble(),
    eurBuying: (json['eurBuying'] as num).toDouble(),
    eurSelling: (json['eurSelling'] as num).toDouble(),
    goldBuying: (json['goldBuying'] as num).toDouble(),
    goldSelling: (json['goldSelling'] as num).toDouble(),
    lastUpdated: DateTime.parse(json['lastUpdated'] as String),
    goldFromApi: json['goldFromApi'] as bool? ?? true,
  );

  // Ortalama kurlar
  double get usdRate => (usdBuying + usdSelling) / 2;
  double get eurRate => (eurBuying + eurSelling) / 2;
  double get goldRate => (goldBuying + goldSelling) / 2; // TRY per gram

  // Gold in USD per troy ounce (1 oz = 31.1035 grams)
  // Convert from TRY/gram to USD/oz: (TRY/gram * 31.1035) / (TRY/USD)
  double? get goldOzUsd {
    if (usdRate <= 0) return null;
    return (goldRate * 31.1035) / usdRate;
  }

  // Alias for goldRate - TRY per gram
  double get goldGramTry => goldRate;
}

class CurrencyService {
  static const _tcmbUrl = 'https://www.tcmb.gov.tr/kurlar/today.xml';
  static const _truncgilUrl = 'https://finans.truncgil.com/v4/today.json';
  static const _cacheKey = 'cached_exchange_rates';
  static const _goldCacheKey = 'cached_gold_price';
  static const _goldCacheDateKey = 'cached_gold_date';

  /// TCMB'den güncel kurları çeker
  Future<ExchangeRates?> fetchRates() async {
    try {
      // TCMB'den döviz kurlarını al
      final tcmbResponse = await http
          .get(
            Uri.parse(_tcmbUrl),
            headers: {'Accept': 'application/xml', 'User-Agent': 'Mozilla/5.0'},
          )
          .timeout(const Duration(seconds: 10));

      if (tcmbResponse.statusCode != 200) {
        return null;
      }

      // Altın fiyatını al (Truncgil API)
      final goldPrice = await _fetchGoldPrice();

      final rates = _parseXml(tcmbResponse.body, goldPrice);
      if (rates != null) {
        await _cacheRates(rates);
      }
      return rates;
    } catch (e, stack) {
      await errorLogger.logApiError(
        endpoint: _tcmbUrl,
        statusCode: null,
        error: e,
        stackTrace: stack,
      );
      return null;
    }
  }

  /// Truncgil API'den gram altın fiyatını çeker
  Future<({double buying, double selling})?> _fetchGoldPrice() async {
    try {
      // Önce cache kontrol et (günde 1 kez güncelle)
      final cachedGold = await _getCachedGoldPrice();
      if (cachedGold != null) {
        return cachedGold;
      }

      final response = await http
          .get(
            Uri.parse(_truncgilUrl),
            headers: {
              'Accept': 'application/json',
              'User-Agent': 'Mozilla/5.0',
            },
          )
          .timeout(const Duration(seconds: 10));

      if (response.statusCode != 200) {
        return await _getLastCachedGoldPrice();
      }

      final json = jsonDecode(response.body) as Map<String, dynamic>;

      // GRA = Gram Altın
      final graData = json['GRA'] as Map<String, dynamic>?;
      if (graData == null) {
        return await _getLastCachedGoldPrice();
      }

      final buying = (graData['Buying'] as num?)?.toDouble() ?? 0;
      final selling = (graData['Selling'] as num?)?.toDouble() ?? 0;

      if (buying <= 0 || selling <= 0) {
        return await _getLastCachedGoldPrice();
      }

      // Cache'e kaydet
      await _cacheGoldPrice(buying, selling);

      return (buying: buying, selling: selling);
    } catch (e) {
      return await _getLastCachedGoldPrice();
    }
  }

  /// Altın fiyatını cache'e kaydeder
  Future<void> _cacheGoldPrice(double buying, double selling) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setDouble(_goldCacheKey, buying);
    await prefs.setDouble('${_goldCacheKey}_selling', selling);
    await prefs.setString(_goldCacheDateKey, DateTime.now().toIso8601String());
  }

  /// Cache'den altın fiyatını getirir (günde 1 kez güncelleme için)
  Future<({double buying, double selling})?> _getCachedGoldPrice() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      final dateStr = prefs.getString(_goldCacheDateKey);

      if (dateStr == null) return null;

      final cacheDate = DateTime.parse(dateStr);
      final now = DateTime.now();

      // Aynı gün içindeyse cache'i kullan
      if (cacheDate.year == now.year &&
          cacheDate.month == now.month &&
          cacheDate.day == now.day) {
        final buying = prefs.getDouble(_goldCacheKey);
        final selling = prefs.getDouble('${_goldCacheKey}_selling');

        if (buying != null && selling != null && buying > 0 && selling > 0) {
          return (buying: buying, selling: selling);
        }
      }

      return null;
    } catch (e) {
      return null;
    }
  }

  /// Hata durumunda son cache'lenmiş altın fiyatını getirir
  Future<({double buying, double selling})?> _getLastCachedGoldPrice() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      final buying = prefs.getDouble(_goldCacheKey);
      final selling = prefs.getDouble('${_goldCacheKey}_selling');

      if (buying != null && selling != null && buying > 0 && selling > 0) {
        return (buying: buying, selling: selling);
      }
      return null;
    } catch (e) {
      return null;
    }
  }

  /// XML'i parse eder ve kurları döndürür
  ExchangeRates? _parseXml(
    String xmlString,
    ({double buying, double selling})? goldPrice,
  ) {
    try {
      final document = xml.XmlDocument.parse(xmlString);
      final currencies = document.findAllElements('Currency');

      double? usdBuying, usdSelling;
      double? eurBuying, eurSelling;

      for (final currency in currencies) {
        final code = currency.getAttribute('CurrencyCode');

        if (code == 'USD') {
          usdBuying = _parseDouble(currency, 'ForexBuying');
          usdSelling = _parseDouble(currency, 'ForexSelling');
        } else if (code == 'EUR') {
          eurBuying = _parseDouble(currency, 'ForexBuying');
          eurSelling = _parseDouble(currency, 'ForexSelling');
        }
      }

      if (usdBuying == null ||
          usdSelling == null ||
          eurBuying == null ||
          eurSelling == null) {
        return null;
      }

      // Altın fiyatı Truncgil API'den alınıyor
      // Eğer API'den alınamazsa USD bazlı yaklaşık hesaplama yap
      double goldBuying;
      double goldSelling;
      bool goldFromApi;

      if (goldPrice != null) {
        goldBuying = goldPrice.buying;
        goldSelling = goldPrice.selling;
        goldFromApi = true;
      } else {
        // Fallback: XAU/USD dünya fiyatı üzerinden hesapla (~85 USD/gram)
        const fallbackGoldUsdPerGram = 85.0;
        goldBuying = fallbackGoldUsdPerGram * usdBuying;
        goldSelling = fallbackGoldUsdPerGram * usdSelling;
        goldFromApi = false;
      }

      return ExchangeRates(
        usdBuying: usdBuying,
        usdSelling: usdSelling,
        eurBuying: eurBuying,
        eurSelling: eurSelling,
        goldBuying: goldBuying,
        goldSelling: goldSelling,
        lastUpdated: DateTime.now(),
        goldFromApi: goldFromApi,
      );
    } catch (e) {
      return null;
    }
  }

  double? _parseDouble(xml.XmlElement element, String tagName) {
    try {
      final node = element.findElements(tagName).firstOrNull;
      if (node == null || node.innerText.isEmpty) return null;
      return double.tryParse(node.innerText);
    } catch (e) {
      return null;
    }
  }

  /// Kurları locale cache'ler
  Future<void> _cacheRates(ExchangeRates rates) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(_cacheKey, jsonEncode(rates.toJson()));
  }

  /// Cache'lenmiş kurları getirir
  Future<ExchangeRates?> getCachedRates() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      final jsonString = prefs.getString(_cacheKey);
      if (jsonString == null) return null;

      final json = jsonDecode(jsonString) as Map<String, dynamic>;
      return ExchangeRates.fromJson(json);
    } catch (e) {
      return null;
    }
  }

  /// Önce fetch dener, başarısız olursa cache'den getirir
  Future<ExchangeRates?> getRates({bool forceRefresh = false}) async {
    if (!forceRefresh) {
      // Önce cache kontrol et
      final cached = await getCachedRates();
      if (cached != null) {
        // Cache 1 saatten yeniyse direkt kullan
        final age = DateTime.now().difference(cached.lastUpdated);
        if (age.inHours < 1) {
          return cached;
        }
      }
    }

    // Fetch dene
    final fetched = await fetchRates();
    if (fetched != null) {
      return fetched;
    }

    // Fetch başarısız, cache'den dön
    return await getCachedRates();
  }

  /// TL'yi USD'ye çevirir
  double convertToUSD(double amountTL, ExchangeRates rates) {
    if (rates.usdRate <= 0) return 0;
    return amountTL / rates.usdRate;
  }

  /// TL'yi EUR'ya çevirir
  double convertToEUR(double amountTL, ExchangeRates rates) {
    if (rates.eurRate <= 0) return 0;
    return amountTL / rates.eurRate;
  }

  /// TL'yi gram altına çevirir
  double convertToGold(double amountTL, ExchangeRates rates) {
    if (rates.goldRate <= 0) return 0;
    return amountTL / rates.goldRate;
  }

  /// USD'yi TL'ye çevirir
  double convertFromUSD(double amountUSD, ExchangeRates rates) {
    return amountUSD * rates.usdRate;
  }

  /// EUR'yu TL'ye çevirir
  double convertFromEUR(double amountEUR, ExchangeRates rates) {
    return amountEUR * rates.eurRate;
  }

  /// Gram altını TL'ye çevirir
  double convertFromGold(double amountGold, ExchangeRates rates) {
    return amountGold * rates.goldRate;
  }
}


--- FILE: lib/services/secure_storage_service.dart ---

import 'package:flutter/foundation.dart';
import 'package:flutter_secure_storage/flutter_secure_storage.dart';

/// Secure storage service for sensitive data
/// Uses iOS Keychain / Android EncryptedSharedPreferences
class SecureStorageService {
  static final SecureStorageService _instance =
      SecureStorageService._internal();
  factory SecureStorageService() => _instance;
  SecureStorageService._internal();

  // Storage keys
  static const String _keyPinHash = 'pin_hash';
  static const String _keyFcmToken = 'fcm_token';
  static const String _keyDeviceToken = 'device_token';
  static const String _keyRefreshToken = 'refresh_token';

  // iOS Keychain options for maximum security
  static const _iosOptions = IOSOptions(
    accessibility: KeychainAccessibility.first_unlock_this_device,
    synchronizable: false,
  );

  // Android encrypted shared preferences
  static const _androidOptions = AndroidOptions(
    encryptedSharedPreferences: true,
  );

  final _storage = const FlutterSecureStorage(
    iOptions: _iosOptions,
    aOptions: _androidOptions,
  );

  // ─────────────────────────────────────────────────────────────────
  // GENERIC METHODS
  // ─────────────────────────────────────────────────────────────────

  /// Write a value securely
  Future<void> write(String key, String value) async {
    try {
      await _storage.write(key: key, value: value);
    } catch (e) {
      debugPrint('[SecureStorage] Write error for key $key');
    }
  }

  /// Read a value securely
  Future<String?> read(String key) async {
    try {
      return await _storage.read(key: key);
    } catch (e) {
      debugPrint('[SecureStorage] Read error for key $key');
      return null;
    }
  }

  /// Delete a value
  Future<void> delete(String key) async {
    try {
      await _storage.delete(key: key);
    } catch (e) {
      debugPrint('[SecureStorage] Delete error for key $key');
    }
  }

  /// Delete all stored values
  Future<void> deleteAll() async {
    try {
      await _storage.deleteAll();
    } catch (e) {
      debugPrint('[SecureStorage] DeleteAll error');
    }
  }

  // ─────────────────────────────────────────────────────────────────
  // PIN STORAGE
  // ─────────────────────────────────────────────────────────────────

  /// Save PIN hash securely
  Future<void> savePinHash(String hash) async {
    await write(_keyPinHash, hash);
  }

  /// Get PIN hash
  Future<String?> getPinHash() async {
    return await read(_keyPinHash);
  }

  /// Delete PIN hash
  Future<void> deletePinHash() async {
    await delete(_keyPinHash);
  }

  /// Check if PIN is set
  Future<bool> hasPinSet() async {
    final hash = await getPinHash();
    return hash != null && hash.isNotEmpty;
  }

  // ─────────────────────────────────────────────────────────────────
  // TOKEN STORAGE
  // ─────────────────────────────────────────────────────────────────

  /// Save FCM token securely
  Future<void> saveFcmToken(String token) async {
    await write(_keyFcmToken, token);
  }

  /// Get FCM token
  Future<String?> getFcmToken() async {
    return await read(_keyFcmToken);
  }

  /// Save device token securely
  Future<void> saveDeviceToken(String token) async {
    await write(_keyDeviceToken, token);
  }

  /// Get device token
  Future<String?> getDeviceToken() async {
    return await read(_keyDeviceToken);
  }

  /// Save refresh token securely
  Future<void> saveRefreshToken(String token) async {
    await write(_keyRefreshToken, token);
  }

  /// Get refresh token
  Future<String?> getRefreshToken() async {
    return await read(_keyRefreshToken);
  }
}

/// Global instance for easy access
final secureStorage = SecureStorageService();


--- FILE: lib/services/subscription_service.dart ---

import 'dart:async';
import 'package:flutter/foundation.dart';
import 'package:shared_preferences/shared_preferences.dart';
import '../models/models.dart';
import 'expense_history_service.dart';
import 'profile_service.dart';

class SubscriptionService {
  static const _keySubscriptions = 'subscriptions';

  // Future chain pattern - race condition önleme
  static Future<void> _chain = Future.value();

  Future<T> _withLock<T>(Future<T> Function() operation) async {
    final previous = _chain;
    final completer = Completer<void>();
    _chain = completer.future;

    await previous;

    try {
      return await operation();
    } finally {
      completer.complete();
    }
  }

  /// Tüm abonelikleri getir
  Future<List<Subscription>> getSubscriptions() async {
    final prefs = await SharedPreferences.getInstance();
    final json = prefs.getString(_keySubscriptions);

    if (json == null || json.isEmpty) {
      return [];
    }

    try {
      return Subscription.decodeList(json);
    } catch (e) {
      return [];
    }
  }

  /// Sadece aktif abonelikleri getir
  Future<List<Subscription>> getActiveSubscriptions() async {
    final all = await getSubscriptions();
    return all.where((s) => s.isActive).toList();
  }

  /// Abonelik ekle
  Future<void> addSubscription(Subscription subscription) async {
    await _withLock(() async {
      final subs = await getSubscriptions();
      subs.add(subscription);
      await _saveSubscriptions(subs);
    });
  }

  /// Abonelik güncelle
  Future<void> updateSubscription(String id, Subscription subscription) async {
    await _withLock(() async {
      final subs = await getSubscriptions();
      final index = subs.indexWhere((s) => s.id == id);
      if (index != -1) {
        subs[index] = subscription;
        await _saveSubscriptions(subs);
      }
    });
  }

  /// Abonelik sil
  Future<void> deleteSubscription(String id) async {
    await _withLock(() async {
      final subs = await getSubscriptions();
      subs.removeWhere((s) => s.id == id);
      await _saveSubscriptions(subs);
    });
  }

  /// Yaklaşan abonelikleri getir (önümüzdeki X gün içinde)
  Future<List<Subscription>> getUpcomingSubscriptions({
    int withinDays = 3,
  }) async {
    final active = await getActiveSubscriptions();
    return active.where((s) => s.daysUntilRenewal <= withinDays).toList()
      ..sort((a, b) => a.daysUntilRenewal.compareTo(b.daysUntilRenewal));
  }

  /// Yarın yenilenecek abonelikler (bildirim için)
  Future<List<Subscription>> getSubscriptionsRenewingTomorrow() async {
    final active = await getActiveSubscriptions();
    return active.where((s) => s.isRenewalTomorrow).toList();
  }

  /// Bugün yenilenecek abonelikler (otomatik kayıt için)
  Future<List<Subscription>> getSubscriptionsRenewingToday() async {
    final active = await getActiveSubscriptions();
    return active.where((s) => s.isRenewalToday).toList();
  }

  /// Toplam aylık abonelik tutarı
  Future<double> getTotalMonthlyAmount() async {
    final active = await getActiveSubscriptions();
    return active.fold<double>(0, (sum, s) => sum + s.amount);
  }

  /// Abonelik sayısı
  Future<int> getActiveCount() async {
    final active = await getActiveSubscriptions();
    return active.length;
  }

  Future<void> _saveSubscriptions(List<Subscription> subs) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(_keySubscriptions, Subscription.encodeList(subs));
  }

  /// Benzersiz ID oluştur
  String generateId() {
    return DateTime.now().millisecondsSinceEpoch.toString();
  }

  /// Sonraki kullanılabilir renk indeksini döndür (round-robin)
  Future<int> getNextColorIndex() async {
    final active = await getActiveSubscriptions();
    if (active.isEmpty) return 0;

    // Mevcut renkleri say
    final colorCounts = <int, int>{};
    for (final sub in active) {
      colorCounts[sub.colorIndex] = (colorCounts[sub.colorIndex] ?? 0) + 1;
    }

    // En az kullanılan rengi bul
    int minCount = 999;
    int minIndex = 0;
    for (int i = 0; i < SubscriptionColors.count; i++) {
      final count = colorCounts[i] ?? 0;
      if (count < minCount) {
        minCount = count;
        minIndex = i;
      }
    }

    return minIndex;
  }

  /// Bugün yenilenen ve otomatik kayıt açık olan abonelikleri getir
  Future<List<Subscription>> getAutoRecordSubscriptionsForToday() async {
    final today = await getSubscriptionsRenewingToday();
    return today.where((s) => s.autoRecord).toList();
  }

  /// Belirli bir ay için abonelikleri gün bazında grupla (takvim görünümü için)
  Future<Map<int, List<Subscription>>> getSubscriptionsByDay(
    int year,
    int month,
  ) async {
    final active = await getActiveSubscriptions();
    final Map<int, List<Subscription>> result = {};

    for (final sub in active) {
      final renewalDay = sub.getRenewalDayForMonth(year, month);
      result.putIfAbsent(renewalDay, () => []).add(sub);
    }

    return result;
  }

  // ============================================================
  // AUTO-RECORD FUNCTIONALITY
  // ============================================================

  static const _keyAutoRecordPrefix = 'auto_record_';

  /// Abonelik bugün zaten kaydedildi mi?
  Future<bool> wasRecordedToday(String subscriptionId) async {
    final prefs = await SharedPreferences.getInstance();
    final today = DateTime.now().toIso8601String().substring(0, 10);
    final key = '$_keyAutoRecordPrefix${subscriptionId}_$today';
    return prefs.getBool(key) ?? false;
  }

  /// Aboneliği bugün kaydedildi olarak işaretle
  Future<void> markAsRecordedToday(String subscriptionId) async {
    final prefs = await SharedPreferences.getInstance();
    final today = DateTime.now().toIso8601String().substring(0, 10);
    final key = '$_keyAutoRecordPrefix${subscriptionId}_$today';
    await prefs.setBool(key, true);
  }

  /// Eski auto-record flag'lerini temizle (7 günden eski)
  Future<void> cleanupOldAutoRecordFlags() async {
    final prefs = await SharedPreferences.getInstance();
    final keys = prefs.getKeys();
    final now = DateTime.now();

    for (final key in keys) {
      if (key.startsWith(_keyAutoRecordPrefix)) {
        // Key format: auto_record_{subId}_{date}
        final parts = key.split('_');
        if (parts.length >= 4) {
          final dateStr = parts.last;
          try {
            final date = DateTime.parse(dateStr);
            if (now.difference(date).inDays > 7) {
              await prefs.remove(key);
            }
          } catch (_) {
            // Invalid date format, remove it
            await prefs.remove(key);
          }
        }
      }
    }
  }

  /// Tüm auto-record aboneliklerini işle ve harcama oluştur
  /// Döndürülen değer: oluşturulan harcama sayısı
  Future<int> processAutoRecordSubscriptions() async {
    try {
      final subs = await getAutoRecordSubscriptionsForToday();
      if (subs.isEmpty) return 0;

      final expenseService = ExpenseHistoryService();
      final profileService = ProfileService();
      final profile = await profileService.getProfile();

      // Saatlik ücret hesapla
      double hourlyRate = 50.0; // Varsayılan
      if (profile != null && profile.dailyHours > 0) {
        hourlyRate =
            profile.monthlyIncome /
            (profile.dailyHours * profile.workDaysPerWeek * 4);
      }

      int count = 0;

      for (final sub in subs) {
        // Bugün zaten kaydedildi mi kontrol et
        if (await wasRecordedToday(sub.id)) {
          debugPrint(
            '[SubscriptionService] Already recorded today: ${sub.name}',
          );
          continue;
        }

        // Çalışma saati hesapla
        final hoursRequired = sub.amount / hourlyRate;
        final daysRequired = hoursRequired / (profile?.dailyHours ?? 8);

        // Harcama oluştur
        final expense = Expense(
          amount: sub.amount,
          category: sub.category,
          subCategory: sub.name,
          date: DateTime.now(),
          hoursRequired: hoursRequired,
          daysRequired: daysRequired,
          decision: ExpenseDecision.yes,
          decisionDate: DateTime.now(),
          recordType: RecordType.real,
          type: ExpenseType.recurring,
          isMandatory: true,
          isAutoRecorded: true,
          subscriptionId: sub.id,
        );

        await expenseService.addExpense(expense);
        await markAsRecordedToday(sub.id);
        count++;

        debugPrint(
          '[SubscriptionService] Auto-recorded: ${sub.name} - ${sub.amount}₺',
        );
      }

      // Eski flag'leri temizle
      if (count > 0) {
        await cleanupOldAutoRecordFlags();
      }

      return count;
    } catch (e) {
      debugPrint('[SubscriptionService] Error processing auto-records: $e');
      return 0;
    }
  }
}


--- FILE: lib/services/connectivity_service.dart ---

import 'dart:async';
import 'package:connectivity_plus/connectivity_plus.dart';

class ConnectivityService {
  final Connectivity _connectivity = Connectivity();
  StreamSubscription<List<ConnectivityResult>>? _subscription;

  final _controller = StreamController<bool>.broadcast();

  Stream<bool> get onConnectivityChanged => _controller.stream;

  bool _isConnected = true;
  bool get isConnected => _isConnected;

  /// Servis başlat ve bağlantı durumunu dinlemeye başla
  Future<void> initialize() async {
    // Mevcut durumu kontrol et
    await checkConnectivity();

    // Değişiklikleri dinle
    _subscription = _connectivity.onConnectivityChanged.listen((results) {
      _updateConnectivity(results);
    });
  }

  /// Mevcut bağlantı durumunu kontrol et
  Future<bool> checkConnectivity() async {
    try {
      final results = await _connectivity.checkConnectivity();
      _updateConnectivity(results);
      return _isConnected;
    } catch (e) {
      _isConnected = false;
      _controller.add(false);
      return false;
    }
  }

  void _updateConnectivity(List<ConnectivityResult> results) {
    final wasConnected = _isConnected;

    // none dışında herhangi bir bağlantı varsa connected
    _isConnected =
        results.isNotEmpty &&
        !results.every((r) => r == ConnectivityResult.none);

    // Sadece değişiklik olduğunda bildir
    if (wasConnected != _isConnected) {
      _controller.add(_isConnected);
    }
  }

  /// Gerçek internet erişimini test et (opsiyonel, daha yavaş)
  Future<bool> hasRealInternetAccess() async {
    try {
      // Basit bir HTTP isteği yaparak gerçek erişimi test et
      // Bu opsiyonel, connectivity_plus sadece ağ bağlantısını kontrol eder
      return _isConnected;
    } catch (e) {
      return false;
    }
  }

  void dispose() {
    _subscription?.cancel();
    _controller.close();
  }
}


--- FILE: lib/services/widget_service.dart ---

import 'dart:io';
import 'package:flutter/foundation.dart';
import 'package:home_widget/home_widget.dart';

/// Service for providing data to home screen widgets (iOS/Android)
/// Uses home_widget package for cross-platform support
class WidgetService {
  static final WidgetService _instance = WidgetService._internal();
  factory WidgetService() => _instance;
  WidgetService._internal();

  // iOS App Group ID (must match widget extension)
  static const String appGroupId = 'group.com.vantag.app';

  // Widget names (must match Swift widget kind names exactly)
  static const String iOSSmallWidgetName = 'VantagSmallWidget';
  static const String iOSMediumWidgetName = 'VantagMediumWidget';
  static const String androidSmallWidgetName = 'VantagSmallWidgetProvider';
  static const String androidMediumWidgetName = 'VantagMediumWidgetProvider';

  /// Initialize widget service
  Future<void> initialize() async {
    try {
      // Set app group for iOS
      if (Platform.isIOS) {
        await HomeWidget.setAppGroupId(appGroupId);
      }

      // Register interactivity callback for widget taps
      await HomeWidget.registerInteractivityCallback(widgetBackgroundCallback);

      // Populate default data if not exists (prevents "Can't load widget" error)
      final existingTime = await HomeWidget.getWidgetData<String>('formattedTime');
      if (existingTime == null || existingTime.isEmpty) {
        await _populateDefaultData();
      }

      debugPrint('[Widget] Service initialized');
    } catch (e) {
      debugPrint('[Widget] Initialization error: $e');
    }
  }

  /// Populate default widget data for first-time use
  Future<void> _populateDefaultData() async {
    try {
      await HomeWidget.saveWidgetData<String>('formattedTime', '0h 0m');
      await HomeWidget.saveWidgetData<String>('formattedAmount', '₺0');
      await HomeWidget.saveWidgetData<String>('spendingLevel', 'low');
      await HomeWidget.saveWidgetData<String>('locale', 'tr');
      await HomeWidget.saveWidgetData<bool>('hasPursuit', false);
      await HomeWidget.saveWidgetData<String>('pursuitName', '');
      await HomeWidget.saveWidgetData<String>('pursuitProgressText', '');
      await HomeWidget.saveWidgetData<double>('pursuitProgress', 0.0);
      await HomeWidget.saveWidgetData<double>('pursuitTarget', 0.0);
      await _updateWidgets();
      debugPrint('[Widget] Default data populated');
    } catch (e) {
      debugPrint('[Widget] Error populating default data: $e');
    }
  }

  /// Update widget data - call this whenever relevant data changes
  Future<void> updateWidgetData({
    required double todayHours,
    required int todayMinutes,
    required double todayAmount,
    required String currencySymbol,
    required String spendingLevel, // "low", "medium", "high"
    String? pursuitName,
    double? pursuitProgress,
    double? pursuitTarget,
    required String locale, // "en" or "tr"
  }) async {
    try {
      // Save all data for widgets to read
      await HomeWidget.saveWidgetData<double>('todayHours', todayHours);
      await HomeWidget.saveWidgetData<int>('todayMinutes', todayMinutes);
      await HomeWidget.saveWidgetData<double>('todayAmount', todayAmount);
      await HomeWidget.saveWidgetData<String>('currencySymbol', currencySymbol);
      await HomeWidget.saveWidgetData<String>('spendingLevel', spendingLevel);
      await HomeWidget.saveWidgetData<String>('pursuitName', pursuitName ?? '');
      await HomeWidget.saveWidgetData<double>(
        'pursuitProgress',
        pursuitProgress ?? 0.0,
      );
      await HomeWidget.saveWidgetData<double>(
        'pursuitTarget',
        pursuitTarget ?? 0.0,
      );
      await HomeWidget.saveWidgetData<String>('locale', locale);
      await HomeWidget.saveWidgetData<String>(
        'lastUpdate',
        DateTime.now().toIso8601String(),
      );

      // Format time strings for widgets (avoids computation on widget side)
      final hourAbbrev = locale == 'tr' ? 's' : 'h';
      final minAbbrev = locale == 'tr' ? 'dk' : 'm';
      final formattedTime =
          '${todayHours.toInt()}$hourAbbrev $todayMinutes$minAbbrev';
      final formattedAmount =
          '$currencySymbol${todayAmount.toStringAsFixed(0)}';

      await HomeWidget.saveWidgetData<String>('formattedTime', formattedTime);
      await HomeWidget.saveWidgetData<String>(
        'formattedAmount',
        formattedAmount,
      );

      // Pursuit formatted string
      if (pursuitName != null &&
          pursuitName.isNotEmpty &&
          pursuitTarget != null &&
          pursuitTarget > 0) {
        final pursuitProgressStr =
            '${pursuitProgress?.toInt() ?? 0}/${pursuitTarget.toInt()} $hourAbbrev';
        await HomeWidget.saveWidgetData<String>(
          'pursuitProgressText',
          pursuitProgressStr,
        );
        await HomeWidget.saveWidgetData<bool>('hasPursuit', true);
      } else {
        await HomeWidget.saveWidgetData<String>('pursuitProgressText', '');
        await HomeWidget.saveWidgetData<bool>('hasPursuit', false);
      }

      // Trigger widget update on both platforms
      await _updateWidgets();

      debugPrint(
        '[Widget] Data updated: $formattedTime, $formattedAmount, level: $spendingLevel',
      );
    } catch (e) {
      debugPrint('[Widget] Error updating widget data: $e');
    }
  }

  /// Update all widgets
  Future<void> _updateWidgets() async {
    try {
      if (Platform.isIOS) {
        // Update both widget sizes on iOS
        await HomeWidget.updateWidget(iOSName: iOSSmallWidgetName);
        await HomeWidget.updateWidget(iOSName: iOSMediumWidgetName);
        debugPrint('[Widget] iOS widgets updated: $iOSSmallWidgetName, $iOSMediumWidgetName');
      } else if (Platform.isAndroid) {
        // Update both widget sizes on Android
        await HomeWidget.updateWidget(androidName: androidSmallWidgetName);
        await HomeWidget.updateWidget(androidName: androidMediumWidgetName);
      }
    } catch (e) {
      debugPrint('[Widget] Error triggering widget update: $e');
    }
  }

  /// Request widget refresh (call on app launch to sync)
  Future<void> refreshWidgets() async {
    try {
      await _updateWidgets();
      debugPrint('[Widget] Refresh requested');
    } catch (e) {
      debugPrint('[Widget] Refresh error: $e');
    }
  }

  /// Get widget data (for reading back saved data)
  Future<T?> getWidgetData<T>(String key) async {
    try {
      return await HomeWidget.getWidgetData<T>(key);
    } catch (e) {
      debugPrint('[Widget] Error getting widget data: $e');
      return null;
    }
  }

  /// Check if widgets are supported on this platform
  bool get isSupported => Platform.isIOS || Platform.isAndroid;

  /// Calculate spending level based on daily average
  /// Returns "low", "medium", or "high"
  static String calculateSpendingLevel({
    required double todaySpending,
    required double dailyAverage,
  }) {
    if (dailyAverage <= 0) return 'low';

    final ratio = todaySpending / dailyAverage;

    if (ratio < 0.5) {
      return 'low'; // Green - under 50%
    } else if (ratio < 0.7) {
      return 'medium'; // Yellow - 50-70%
    } else {
      return 'high'; // Red - over 70%
    }
  }
}

/// Background callback for widget tap interactions
/// This is called when user taps on widget elements
@pragma('vm:entry-point')
Future<void> widgetBackgroundCallback(Uri? uri) async {
  debugPrint('[Widget] Background callback: $uri');

  if (uri == null) return;

  // Handle different deep link paths
  // vantag://home - Open main screen
  // vantag://pursuits - Open pursuits tab
  // These are handled by the app's deep link service when app opens
}

/// Global instance for easy access
final widgetService = WidgetService();

/// Widget types available
enum WidgetType {
  small, // Small widget (2x2) - daily spending
  medium, // Medium widget (4x2) - spending + pursuit
}

/// Widget spending level colors
enum SpendingLevel {
  low, // Green - under 50% of daily average
  medium, // Yellow - 50-70% of daily average
  high, // Red - over 70% of daily average
}

extension SpendingLevelExtension on SpendingLevel {
  String get value {
    switch (this) {
      case SpendingLevel.low:
        return 'low';
      case SpendingLevel.medium:
        return 'medium';
      case SpendingLevel.high:
        return 'high';
    }
  }

  static SpendingLevel fromString(String value) {
    switch (value) {
      case 'medium':
        return SpendingLevel.medium;
      case 'high':
        return SpendingLevel.high;
      default:
        return SpendingLevel.low;
    }
  }
}


--- FILE: lib/services/sound_service.dart ---

import 'package:audioplayers/audioplayers.dart';
import 'package:flutter/foundation.dart';
import 'package:shared_preferences/shared_preferences.dart';

/// Sound effect types available in the app
enum SoundType {
  celebration, // Pursuit completed, achievement unlocked
  success, // Expense added, settings saved
  coin, // Quick add expense, money-related
  tap, // Button taps (optional)
  warning, // Spending exceeds threshold
  cashOut, // Expense confirmation
  victory, // "Vazgectim" decision
  countdown, // Timer tick
}

/// Sound effects service for key moments in the app
/// Provides audio feedback to enhance user experience
class SoundService {
  static final SoundService _instance = SoundService._internal();
  factory SoundService() => _instance;
  SoundService._internal();

  final AudioPlayer _player = AudioPlayer();
  bool _isEnabled = true;
  bool _isInitialized = false;
  double _volume = 0.7;

  // SharedPreferences keys
  static const _keySoundEnabled = 'sound_enabled';
  static const _keySoundVolume = 'sound_volume';

  // Sound asset paths
  static const Map<SoundType, String> _soundPaths = {
    SoundType.celebration: 'sounds/celebration.mp3',
    SoundType.success: 'sounds/success.mp3',
    SoundType.coin: 'sounds/coin.mp3',
    SoundType.tap: 'sounds/tap.mp3',
    SoundType.warning: 'sounds/warning.mp3',
    SoundType.cashOut: 'sounds/cash_out.mp3',
    SoundType.victory: 'sounds/victory.mp3',
    SoundType.countdown: 'sounds/countdown_tick.mp3',
  };

  /// Initialize sound service - call in main.dart
  Future<void> init() async {
    if (_isInitialized) return;

    try {
      final prefs = await SharedPreferences.getInstance();
      _isEnabled = prefs.getBool(_keySoundEnabled) ?? true;
      _volume = prefs.getDouble(_keySoundVolume) ?? 0.7;

      // Configure audio player
      await _player.setReleaseMode(ReleaseMode.stop);

      _isInitialized = true;
      debugPrint(
        '[Sound] Service initialized. Enabled: $_isEnabled, Volume: $_volume',
      );
    } catch (e) {
      debugPrint('[Sound] Initialization error: $e');
      _isInitialized = true; // Mark as initialized to avoid retry loops
    }
  }

  /// Play a sound effect by type
  Future<void> play(SoundType type) async {
    if (!_isEnabled || !_isInitialized) return;

    final assetPath = _soundPaths[type];
    if (assetPath == null) return;

    try {
      await _player.stop(); // Stop any currently playing sound
      await _player.setVolume(_volume);
      await _player.play(AssetSource(assetPath));
      debugPrint('[Sound] Playing: $assetPath');
    } catch (e) {
      // Silently fail - sound is enhancement, not critical
      debugPrint('[Sound] Play error for $type: $e');
    }
  }

  // ==================== CONVENIENCE METHODS ====================

  /// Play celebration sound (pursuit completed, achievement unlocked)
  Future<void> playCelebration() => play(SoundType.celebration);

  /// Play success sound (expense added, settings saved)
  Future<void> playSuccess() => play(SoundType.success);

  /// Play coin sound (money-related actions)
  Future<void> playCoin() => play(SoundType.coin);

  /// Play tap sound (button taps - optional)
  Future<void> playTap() => play(SoundType.tap);

  /// Play warning sound (spending threshold exceeded)
  Future<void> playWarning() => play(SoundType.warning);

  /// Play cash out sound (expense confirmation)
  Future<void> playCashOut() => play(SoundType.cashOut);

  /// Play victory sound ("Vazgectim" decision)
  Future<void> playVictory() => play(SoundType.victory);

  /// Play countdown tick sound
  Future<void> playCountdownTick() => play(SoundType.countdown);

  // ==================== CONTROL ====================

  /// Stop currently playing sound
  Future<void> stop() async {
    try {
      await _player.stop();
    } catch (e) {
      debugPrint('[Sound] Stop error: $e');
    }
  }

  // ==================== SETTINGS ====================

  /// Check if sound effects are enabled
  bool get isEnabled => _isEnabled;

  /// Get current volume (0.0 - 1.0)
  double get volume => _volume;

  /// Enable or disable sound effects
  Future<void> setEnabled(bool value) async {
    _isEnabled = value;
    try {
      final prefs = await SharedPreferences.getInstance();
      await prefs.setBool(_keySoundEnabled, value);
      debugPrint('[Sound] Enabled set to: $value');
    } catch (e) {
      debugPrint('[Sound] setEnabled error: $e');
    }
  }

  /// Set volume level (0.0 - 1.0)
  Future<void> setVolume(double value) async {
    _volume = value.clamp(0.0, 1.0);
    try {
      final prefs = await SharedPreferences.getInstance();
      await prefs.setDouble(_keySoundVolume, _volume);
      await _player.setVolume(_volume);
      debugPrint('[Sound] Volume set to: $_volume');
    } catch (e) {
      debugPrint('[Sound] setVolume error: $e');
    }
  }

  /// Toggle sound effects on/off
  Future<void> toggle() async {
    await setEnabled(!_isEnabled);
  }

  /// Dispose of resources
  void dispose() {
    _player.dispose();
    _isInitialized = false;
  }
}

/// Global instance for easy access
final soundService = SoundService();


--- FILE: lib/services/ai_service.dart ---

import 'dart:convert';
import 'package:flutter/foundation.dart';
import 'package:http/http.dart' as http;
import 'package:firebase_auth/firebase_auth.dart';
import '../models/models.dart';
import '../providers/finance_provider.dart';
import '../providers/pro_provider.dart';
import 'ai_tool_handler.dart';
import 'ai_memory_service.dart';
import 'connectivity_service.dart';
import 'error_logging_service.dart';

/// AI Chat limit aşıldığında dönen hata
class AILimitExceededException implements Exception {
  final DateTime resetDate;
  final int remainingQuota;
  final String limitType; // "daily" or "monthly"

  AILimitExceededException({
    required this.resetDate,
    required this.remainingQuota,
    required this.limitType,
  });

  @override
  String toString() => 'AI limit exceeded. Resets at: $resetDate';
}

class AIService {
  static final AIService _instance = AIService._internal();
  factory AIService() => _instance;
  AIService._internal();

  // Cloud Function URL - europe-west1 region
  static const String _baseUrl =
      'https://europe-west1-flutter-ai-playground-b188b.cloudfunctions.net/aiChat';

  final AIMemoryService _memory = AIMemoryService();
  final ConnectivityService _connectivity = ConnectivityService();
  bool _isInitialized = false;

  PersonalityMode _personalityMode = PersonalityMode.friendly;

  // Last known remaining quota (updated after each request)
  int _remainingQuota = -1;
  int get remainingQuota => _remainingQuota;

  Future<void> initialize() async {
    debugPrint('🤖 [AIService] Başlatılıyor...');

    try {
      await _memory.initialize();
      _isInitialized = true;
      debugPrint(
        '✅ [AIService] Cloud Function tabanlı AI başarıyla başlatıldı!',
      );
    } catch (e, stack) {
      debugPrint('❌ [AIService] Hata: $e');
      debugPrint('Stack: $stack');
    }
  }

  bool get isInitialized => _isInitialized;

  /// Check if AI service is available and ready to use
  bool get isAvailable => _isInitialized;

  void setPersonalityMode(PersonalityMode mode) => _personalityMode = mode;
  PersonalityMode get personalityMode => _personalityMode;
  List<String> get userFacts => _memory.facts;

  /// Get current user ID from Firebase Auth
  String? get _currentUserId => FirebaseAuth.instance.currentUser?.uid;

  /// Get subscription type from ProProvider
  /// Note: Currently ProProvider only tracks isPro (pro subscription)
  /// Lifetime detection would need RevenueCat entitlement check
  String _getSubscriptionType(ProProvider? proProvider) {
    if (proProvider == null) return 'free';
    if (proProvider.isPro) return 'pro';
    return 'free';
  }

  Future<String> getResponse({
    required String message,
    required FinanceProvider financeProvider,
    bool isPremium = true,
    ProProvider? proProvider,
    String languageCode = 'tr',
  }) async {
    debugPrint('🚀 [AIService] getResponse çağrıldı');
    debugPrint('📱 [AIService] Initialized: $_isInitialized');
    debugPrint('💬 [AIService] Mesaj: "$message"');
    debugPrint('👑 [AIService] Premium: $isPremium');
    debugPrint('🌍 [AIService] Language: $languageCode');

    if (!_isInitialized) {
      debugPrint('⚠️ [AIService] Servis hazır değil!');
      return languageCode == 'en'
          ? 'Service is loading, one moment...'
          : 'Servis hazırlanıyor, bir saniye...';
    }

    final userId = _currentUserId;
    if (userId == null) {
      debugPrint('⚠️ [AIService] Kullanıcı girişi yok!');
      return languageCode == 'en'
          ? 'Please sign in first.'
          : 'Lütfen önce giriş yapın.';
    }

    // Check connectivity before making API call
    final isOnline = await _connectivity.checkConnectivity();
    if (!isOnline) {
      debugPrint('⚠️ [AIService] Çevrimdışı!');
      return languageCode == 'en'
          ? 'You are offline. Please check your internet connection.'
          : 'Çevrimdışısın. Lütfen internet bağlantını kontrol et.';
    }

    try {
      final handler = AIToolHandler(financeProvider);
      final subscriptionType = _getSubscriptionType(proProvider);

      // İlk istek - Cloud Function'a gönder
      var response = await _sendCloudRequest(
        message: message,
        userId: userId,
        isPremium: isPremium,
        subscriptionType: subscriptionType,
        languageCode: languageCode,
      );

      debugPrint('📥 [AIService] İlk response alındı');

      // Tool call loop
      int maxIterations = 5;
      int iteration = 0;
      List<Map<String, dynamic>> toolResults = [];

      while (response['requiresToolExecution'] == true &&
          response['toolCalls'] != null &&
          iteration < maxIterations) {
        iteration++;
        final toolCalls = response['toolCalls'] as List<dynamic>;
        debugPrint(
          '🔧 [AIService] Tool çağrısı algılandı (iteration $iteration): ${toolCalls.length} adet',
        );

        // Assistant message with tool calls
        toolResults.add({
          'role': 'assistant',
          'content': response['response'],
          'tool_calls': toolCalls,
        });

        // Her tool call için sonuç al
        for (final toolCall in toolCalls) {
          final functionName = toolCall['function']['name'] as String;
          final arguments =
              jsonDecode(toolCall['function']['arguments'] as String)
                  as Map<String, dynamic>;

          debugPrint('📞 [AIService] Tool: $functionName');
          debugPrint('📋 [AIService] Args: $arguments');

          // Tool'u local olarak çalıştır
          final result = await handler.handleToolCall(functionName, arguments);
          debugPrint('✅ [AIService] Result: $result');

          // Tool response ekle
          toolResults.add({
            'role': 'tool',
            'tool_call_id': toolCall['id'],
            'content': jsonEncode(result),
          });
        }

        // Tool sonuçlarıyla tekrar Cloud Function'a gönder
        response = await _sendCloudRequest(
          message: message,
          userId: userId,
          isPremium: isPremium,
          subscriptionType: subscriptionType,
          languageCode: languageCode,
          toolResults: toolResults,
        );
        debugPrint('📥 [AIService] Tool sonrası response alındı');
      }

      // Update remaining quota
      if (response['remainingQuota'] != null) {
        _remainingQuota = response['remainingQuota'] as int;
        debugPrint('📊 [AIService] Kalan kota: $_remainingQuota');
      }

      // Final cevabı al
      final responseText = (response['response'] as String?)?.trim();

      if (responseText == null || responseText.isEmpty) {
        return languageCode == 'en'
            ? 'I couldn\'t analyze that, could you ask again?'
            : 'Analiz yapamadım, tekrar sorar mısın?';
      }

      // Mesajları kaydet
      await _memory.saveMessage('user', message);
      await _memory.saveMessage('assistant', responseText);

      debugPrint(
        '✅ [AIService] Cevap: ${responseText.substring(0, responseText.length.clamp(0, 100))}...',
      );
      return responseText;
    } on AILimitExceededException {
      rethrow; // UI'da handle edilecek
    } catch (e, stack) {
      debugPrint('❌ [AIService] Hata: $e');
      debugPrint('❌ [AIService] Stack: $stack');

      // Log to Crashlytics
      await errorLogger.logApiError(
        endpoint: 'AI Chat Cloud Function',
        statusCode: null,
        error: e,
        stackTrace: stack,
      );

      if (e.toString().contains('LIMIT_EXCEEDED')) {
        return languageCode == 'en'
            ? 'You\'ve reached your daily AI limit. Try again tomorrow or upgrade to Premium!'
            : 'Günlük AI limitine ulaştın. Yarın tekrar dene veya Premium\'a geç!';
      }
      if (e.toString().contains('429')) {
        return languageCode == 'en'
            ? 'Rate limit exceeded, please wait a moment.'
            : 'Rate limit aşıldı, biraz bekle.';
      }
      return languageCode == 'en'
          ? 'Something went wrong, please try again.'
          : 'Bir sorun oluştu, tekrar dene.';
    }
  }

  Future<Map<String, dynamic>> _sendCloudRequest({
    required String message,
    required String userId,
    required bool isPremium,
    required String subscriptionType,
    String languageCode = 'tr',
    List<Map<String, dynamic>>? toolResults,
  }) async {
    final body = jsonEncode({
      'message': message,
      'userId': userId,
      'isPremium': isPremium,
      'subscriptionType': subscriptionType,
      'language': languageCode,
      if (toolResults != null) 'toolResults': toolResults,
    });

    debugPrint('📤 [AIService] Cloud Function\'a istek gönderiliyor...');

    final response = await http
        .post(
          Uri.parse(_baseUrl),
          headers: {'Content-Type': 'application/json'},
          body: body,
        )
        .timeout(const Duration(seconds: 60));

    debugPrint('📥 [AIService] HTTP Status: ${response.statusCode}');

    final json = jsonDecode(response.body) as Map<String, dynamic>;

    // Handle errors
    if (response.statusCode == 429) {
      final error = json['error'] as String?;
      if (error == 'LIMIT_EXCEEDED') {
        final resetDateStr = json['resetDate'] as String?;
        final remainingQuota = json['remainingQuota'] as int? ?? 0;
        final limitType = json['limitType'] as String? ?? 'daily';

        throw AILimitExceededException(
          resetDate: resetDateStr != null
              ? DateTime.parse(resetDateStr)
              : DateTime.now().add(const Duration(days: 1)),
          remainingQuota: remainingQuota,
          limitType: limitType,
        );
      }
      throw Exception('Rate limited');
    }

    if (response.statusCode != 200) {
      debugPrint('❌ [AIService] HTTP Error: ${response.statusCode}');
      debugPrint('❌ [AIService] Body: ${response.body}');
      final errorMsg = json['message'] ?? json['error'] ?? 'Unknown error';
      throw Exception(
        'Cloud Function error: ${response.statusCode} - $errorMsg',
      );
    }

    return json;
  }

  Future<String> getGreeting(
    String prompt, {
    String languageCode = 'tr',
  }) async {
    final isEnglish = languageCode == 'en';
    final defaultGreeting = isEnglish
        ? 'Hello! How can I help you today?'
        : 'Merhaba! Nasıl yardımcı olabilirim?';

    if (!_isInitialized) {
      return defaultGreeting;
    }

    final userId = _currentUserId;
    if (userId == null) {
      return defaultGreeting;
    }

    try {
      // Simple greeting - use Cloud Function
      final response = await _sendCloudRequest(
        message: prompt,
        userId: userId,
        isPremium: true, // Greeting doesn't count against quota
        subscriptionType: 'pro',
        languageCode: languageCode,
      );

      return (response['response'] as String?)?.trim() ??
          (isEnglish ? 'Hello!' : 'Merhaba!');
    } catch (e) {
      debugPrint('⚠️ [AIService] Greeting error: $e');
      return isEnglish
          ? 'Hello! How can I help you today?'
          : 'Merhaba! Bugün nasıl yardımcı olabilirim?';
    }
  }

  Future<void> clearHistory() async {
    await _memory.clearAll();
    debugPrint('🗑️ [AIService] Geçmiş temizlendi');
  }

  Future<void> removeFact(String fact) async {
    await _memory.removeFact(fact);
  }
}


--- FILE: lib/services/simple_mode_service.dart ---

import 'package:flutter/foundation.dart';
import 'package:shared_preferences/shared_preferences.dart';

/// Service to manage Simple Mode functionality
/// Simple Mode provides a streamlined experience with essential features only
class SimpleModeService extends ChangeNotifier {
  // ═══════════════════════════════════════════════════════════════════════════
  // CONSTANTS
  // ═══════════════════════════════════════════════════════════════════════════

  static const String _keySimpleModeEnabled = 'simple_mode_enabled';

  /// Top 5 essential categories for simple mode
  static const List<String> simpleModeCategories = [
    'food', // Yemek
    'transport', // Ulaşım
    'shopping', // Alışveriş
    'bills', // Faturalar
    'entertainment', // Eğlence
  ];

  // ═══════════════════════════════════════════════════════════════════════════
  // SINGLETON
  // ═══════════════════════════════════════════════════════════════════════════

  static final SimpleModeService _instance = SimpleModeService._internal();
  factory SimpleModeService() => _instance;
  SimpleModeService._internal();

  // ═══════════════════════════════════════════════════════════════════════════
  // STATE
  // ═══════════════════════════════════════════════════════════════════════════

  bool _isEnabled = false;
  bool _isInitialized = false;

  /// Whether simple mode is currently enabled
  bool get isEnabled => _isEnabled;

  /// Whether the service has been initialized
  bool get isInitialized => _isInitialized;

  // ═══════════════════════════════════════════════════════════════════════════
  // INITIALIZATION
  // ═══════════════════════════════════════════════════════════════════════════

  /// Initialize the service and load saved state
  Future<void> initialize() async {
    if (_isInitialized) return;

    final prefs = await SharedPreferences.getInstance();
    _isEnabled = prefs.getBool(_keySimpleModeEnabled) ?? false;
    _isInitialized = true;
    notifyListeners();
    debugPrint('[SimpleModeService] Initialized: isEnabled=$_isEnabled');
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // TOGGLE
  // ═══════════════════════════════════════════════════════════════════════════

  /// Enable or disable simple mode
  Future<void> setEnabled(bool value) async {
    if (_isEnabled == value) return;

    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_keySimpleModeEnabled, value);
    _isEnabled = value;
    notifyListeners();
    debugPrint(
      '[SimpleModeService] Simple mode ${value ? 'enabled' : 'disabled'}',
    );
  }

  /// Toggle simple mode on/off
  Future<void> toggle() async {
    await setEnabled(!_isEnabled);
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // FEATURE FLAGS
  // ═══════════════════════════════════════════════════════════════════════════

  /// Whether AI Chat should be shown
  /// Simple mode hides AI chat completely
  bool get showAiChat => !_isEnabled;

  /// Whether to show full dashboard stats
  /// Simple mode shows only today's work hours
  bool get showFullDashboard => !_isEnabled;

  /// Whether to show all categories
  /// Simple mode shows only top 5 categories
  bool get showAllCategories => !_isEnabled;

  /// Get available categories based on mode
  List<String> getAvailableCategories(List<String> allCategories) {
    if (!_isEnabled) return allCategories;
    // Filter to only simple mode categories, maintaining order
    return simpleModeCategories
        .where((cat) => allCategories.contains(cat))
        .toList();
  }

  /// Whether to show advanced report periods
  /// Simple mode only shows weekly reports
  bool get showAdvancedReports => !_isEnabled;

  /// Whether multiple pursuits are allowed
  /// Simple mode limits to 1 pursuit
  bool get allowMultiplePursuits => !_isEnabled;

  // ═══════════════════════════════════════════════════════════════════════════
  // DEBUG
  // ═══════════════════════════════════════════════════════════════════════════

  /// Reset to default state (for testing)
  Future<void> reset() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.remove(_keySimpleModeEnabled);
    _isEnabled = false;
    notifyListeners();
    debugPrint('[SimpleModeService] Reset to default');
  }
}

/// Global instance for easy access
final simpleModeService = SimpleModeService();


--- FILE: lib/services/offline_queue_service.dart ---

import 'dart:async';
import 'dart:convert';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:flutter/foundation.dart';
import 'connectivity_service.dart';

/// Represents a queued operation for offline sync
class QueuedOperation {
  final String id;
  final String type; // 'expense', 'pursuit', 'subscription', etc.
  final String action; // 'add', 'update', 'delete'
  final Map<String, dynamic> data;
  final DateTime createdAt;
  int retryCount;

  QueuedOperation({
    required this.id,
    required this.type,
    required this.action,
    required this.data,
    required this.createdAt,
    this.retryCount = 0,
  });

  Map<String, dynamic> toJson() => {
    'id': id,
    'type': type,
    'action': action,
    'data': data,
    'createdAt': createdAt.toIso8601String(),
    'retryCount': retryCount,
  };

  factory QueuedOperation.fromJson(Map<String, dynamic> json) {
    return QueuedOperation(
      id: json['id'] as String,
      type: json['type'] as String,
      action: json['action'] as String,
      data: Map<String, dynamic>.from(json['data'] as Map),
      createdAt: DateTime.parse(json['createdAt'] as String),
      retryCount: json['retryCount'] as int? ?? 0,
    );
  }
}

/// Service to manage offline operation queue
class OfflineQueueService extends ChangeNotifier {
  static const _queueKey = 'offline_queue_v1';
  static const _maxRetries = 3;

  final ConnectivityService _connectivityService;
  List<QueuedOperation> _queue = [];
  bool _isSyncing = false;
  StreamSubscription<bool>? _connectivitySubscription;

  OfflineQueueService({ConnectivityService? connectivityService})
    : _connectivityService = connectivityService ?? ConnectivityService();

  List<QueuedOperation> get queue => List.unmodifiable(_queue);
  int get pendingCount => _queue.length;
  bool get hasPending => _queue.isNotEmpty;
  bool get isSyncing => _isSyncing;

  /// Initialize service
  Future<void> initialize() async {
    await _loadQueue();
    await _connectivityService.initialize();

    // Listen for connectivity changes
    _connectivitySubscription = _connectivityService.onConnectivityChanged
        .listen((isConnected) {
          if (isConnected && hasPending) {
            syncQueue();
          }
        });

    // Initial sync attempt if online
    if (_connectivityService.isConnected && hasPending) {
      syncQueue();
    }
  }

  /// Add operation to queue
  Future<void> enqueue({
    required String type,
    required String action,
    required Map<String, dynamic> data,
  }) async {
    final operation = QueuedOperation(
      id: DateTime.now().millisecondsSinceEpoch.toString(),
      type: type,
      action: action,
      data: data,
      createdAt: DateTime.now(),
    );

    _queue.add(operation);
    await _saveQueue();
    notifyListeners();

    // Try to sync immediately if online
    if (_connectivityService.isConnected) {
      syncQueue();
    }
  }

  /// Remove operation from queue
  Future<void> dequeue(String id) async {
    _queue.removeWhere((op) => op.id == id);
    await _saveQueue();
    notifyListeners();
  }

  /// Sync all pending operations
  Future<void> syncQueue() async {
    if (_isSyncing || _queue.isEmpty) return;

    _isSyncing = true;
    notifyListeners();

    final operationsToProcess = List<QueuedOperation>.from(_queue);
    final failedOperations = <QueuedOperation>[];

    for (final operation in operationsToProcess) {
      try {
        await _processOperation(operation);
        await dequeue(operation.id);
      } catch (e) {
        debugPrint('Failed to sync operation ${operation.id}: $e');
        operation.retryCount++;

        if (operation.retryCount < _maxRetries) {
          failedOperations.add(operation);
        } else {
          // Remove after max retries
          await dequeue(operation.id);
          debugPrint(
            'Removed operation ${operation.id} after $_maxRetries retries',
          );
        }
      }
    }

    // Update queue with failed operations
    _queue = failedOperations;
    await _saveQueue();

    _isSyncing = false;
    notifyListeners();
  }

  /// Process a single operation
  Future<void> _processOperation(QueuedOperation operation) async {
    // This is a placeholder - actual implementation depends on the operation type
    // Each service should register its sync handlers
    debugPrint(
      'Processing ${operation.type}:${operation.action} - ${operation.id}',
    );

    // Simulate network delay for now
    await Future.delayed(const Duration(milliseconds: 100));

    // In a real implementation, you would:
    // 1. Get the appropriate service based on operation.type
    // 2. Call the appropriate method based on operation.action
    // 3. Pass operation.data to the method
  }

  /// Load queue from storage
  Future<void> _loadQueue() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      final jsonString = prefs.getString(_queueKey);

      if (jsonString != null) {
        final List<dynamic> jsonList = json.decode(jsonString) as List;
        _queue = jsonList
            .map(
              (item) => QueuedOperation.fromJson(item as Map<String, dynamic>),
            )
            .toList();
      }
    } catch (e) {
      debugPrint('Error loading offline queue: $e');
      _queue = [];
    }
  }

  /// Save queue to storage
  Future<void> _saveQueue() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      final jsonString = json.encode(_queue.map((op) => op.toJson()).toList());
      await prefs.setString(_queueKey, jsonString);
    } catch (e) {
      debugPrint('Error saving offline queue: $e');
    }
  }

  /// Clear all pending operations
  Future<void> clearQueue() async {
    _queue.clear();
    await _saveQueue();
    notifyListeners();
  }

  @override
  void dispose() {
    _connectivitySubscription?.cancel();
    super.dispose();
  }
}


--- FILE: lib/services/services.dart ---

export 'auth_service.dart';
export 'device_service.dart';
export 'budget_service.dart';
export 'calculation_service.dart';
export 'profile_service.dart';
export 'expense_history_service.dart';
export 'insight_service.dart';
export 'receipt_scanner_service.dart';
export 'currency_service.dart';
export 'connectivity_service.dart';
export 'offline_queue_service.dart';
export 'streak_service.dart';
export 'messages_service.dart';
export 'notification_service.dart';
export 'push_notification_service.dart';
export 'widget_service.dart';
export 'achievements_service.dart';
export 'subscription_service.dart';
export 'sub_category_service.dart';
export 'category_learning_service.dart';
export 'tour_service.dart';
// Wealth Coach
export 'thinking_items_service.dart';
export 'sensory_feedback_service.dart';
export 'haptic_service.dart';
export 'accessibility_service.dart';
export 'sound_service.dart';
export 'victory_manager.dart';
export 'streak_manager.dart';
export 'subscription_manager.dart';
// Sharing
export 'share_service.dart';
// AI
export 'ai_service.dart';
export 'ai_memory_service.dart';
// Export
export 'export_service.dart';
// Merchant Learning
export 'merchant_learning_service.dart';
export 'import_service.dart';
// Statement Import (PDF/CSV with AI)
export 'statement_parse_service.dart';
// Voice Assistant
export 'voice_parser_service.dart';
export 'deep_link_service.dart';
export 'siri_service.dart';
// Pursuits
export 'pursuit_service.dart';
// Savings Pool
export 'savings_pool_service.dart';
// Analytics & Crashlytics
export 'analytics_service.dart';
export 'error_logging_service.dart';
// Exchange Rates
export 'exchange_rate_service.dart';
// Referral System
export 'referral_service.dart';
// Free Tier
export 'free_tier_service.dart';
// Simple Mode
export 'simple_mode_service.dart';
export 'category_budget_service.dart';
// Security
export 'lock_service.dart';
export 'secure_storage_service.dart';
// Backup
export 'backup_service.dart';
// Update
export 'force_update_service.dart';
// Promo Codes
export 'promo_service.dart';
// App Security (Anti-tampering, Anti-debug)
export 'app_security_service.dart';
// Engagement
export 'engagement_service.dart';
// Re-engagement (Stalled User Handling)
export 'reengagement_service.dart';
// Email Triggers
export 'email_trigger_service.dart';


--- FILE: lib/services/category_learning_service.dart ---

import 'dart:convert';
import 'package:shared_preferences/shared_preferences.dart';
import '../data/store_categories.dart';

/// Kullanıcının manuel kategori seçimlerini öğrenen ve hatırlayan servis
/// Öncelik: Kullanıcının öğrettiği > Built-in sözlük
class CategoryLearningService {
  static const _keyLearnedCategories = 'learned_categories';

  /// Kullanıcının öğrettiği kategoriler (description -> category)
  static Map<String, String> _learnedCategories = {};
  static bool _isInitialized = false;

  /// Servisi başlat ve önceki öğrenmeleri yükle
  static Future<void> initialize() async {
    if (_isInitialized) return;

    final prefs = await SharedPreferences.getInstance();
    final json = prefs.getString(_keyLearnedCategories);

    if (json != null && json.isNotEmpty) {
      try {
        final decoded = jsonDecode(json) as Map<String, dynamic>;
        _learnedCategories = decoded.map((k, v) => MapEntry(k, v.toString()));
      } catch (e) {
        _learnedCategories = {};
      }
    }

    _isInitialized = true;
  }

  /// Kullanıcının manuel seçimini öğren ve kaydet
  /// [description]: Kullanıcının girdiği açıklama
  /// [category]: Kullanıcının seçtiği kategori
  static Future<void> learn(String description, String category) async {
    if (description.trim().isEmpty || category.isEmpty) return;

    // Açıklamadan anahtar kelimeler çıkar
    final keywords = _extractKeywords(description);

    for (final keyword in keywords) {
      _learnedCategories[keyword] = category;
    }

    // Tam açıklamayı da kaydet
    _learnedCategories[description.toLowerCase().trim()] = category;

    await _save();
  }

  /// Verilen açıklamadan kategori tahmini yap
  /// Önce kullanıcı tercihlerine, sonra built-in sözlüğe bakar
  static String? predictCategory(String description) {
    if (description.trim().isEmpty) return null;

    final searchText = description.toLowerCase().trim();

    // 1. Önce kullanıcının tam eşleşmelerine bak
    if (_learnedCategories.containsKey(searchText)) {
      return _learnedCategories[searchText];
    }

    // 2. Kullanıcının öğrendiği kelimelerde partial match
    for (final entry in _learnedCategories.entries) {
      if (searchText.contains(entry.key) || entry.key.contains(searchText)) {
        return entry.value;
      }
    }

    // 3. Kelime bazlı arama (öğrenilmiş)
    final words = searchText.split(RegExp(r'\s+'));
    for (final word in words) {
      if (word.length < 2) continue;
      if (_learnedCategories.containsKey(word)) {
        return _learnedCategories[word];
      }
    }

    // 4. Built-in sözlüğe bak
    final builtInCategory = StoreCategories.findCategory(description);
    if (builtInCategory != null) {
      return builtInCategory;
    }

    return null;
  }

  /// Açıklamadan anahtar kelimeler çıkar
  static List<String> _extractKeywords(String description) {
    final text = description.toLowerCase().trim();
    final words = text.split(RegExp(r'\s+'));

    // En az 3 karakterli kelimeleri al
    return words
        .where((w) => w.length >= 3)
        .map((w) => w.replaceAll(RegExp(r'[^\w\sğüşıöçĞÜŞİÖÇ]'), ''))
        .where((w) => w.isNotEmpty)
        .toList();
  }

  /// Öğrenilen kategorileri SharedPreferences'a kaydet
  static Future<void> _save() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(
      _keyLearnedCategories,
      jsonEncode(_learnedCategories),
    );
  }

  /// Tüm öğrenmeleri sıfırla (debug için)
  static Future<void> reset() async {
    _learnedCategories.clear();
    final prefs = await SharedPreferences.getInstance();
    await prefs.remove(_keyLearnedCategories);
  }

  /// Debug: Öğrenilmiş kategori sayısı
  static int get learnedCount => _learnedCategories.length;

  /// Debug: Tüm öğrenilmiş kategorileri göster
  static Map<String, String> get learnedCategories =>
      Map.unmodifiable(_learnedCategories);
}


--- FILE: lib/services/achievements_service.dart ---

import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';
import 'streak_service.dart';
import 'expense_history_service.dart';
import 'currency_service.dart';
import 'subscription_service.dart';

class AchievementsService {
  static const _keyPrefix = 'achievement_unlocked_';
  static const _keyFirstInstall = 'first_install_date';

  final _streakService = StreakService();
  final _historyService = ExpenseHistoryService();
  final _currencyService = CurrencyService();
  final _subscriptionService = SubscriptionService();

  // ========== ACHIEVEMENT DEFINITIONS (ID, category, tier, target only) ==========

  static const _streakAchievements = <_AchievementDef>[
    _AchievementDef(
      id: 'streak_b1',
      category: AchievementCategory.streak,
      tier: AchievementTier.bronze,
      subTier: 1,
      target: 3,
    ),
    _AchievementDef(
      id: 'streak_b2',
      category: AchievementCategory.streak,
      tier: AchievementTier.bronze,
      subTier: 2,
      target: 7,
    ),
    _AchievementDef(
      id: 'streak_b3',
      category: AchievementCategory.streak,
      tier: AchievementTier.bronze,
      subTier: 3,
      target: 14,
    ),
    _AchievementDef(
      id: 'streak_s1',
      category: AchievementCategory.streak,
      tier: AchievementTier.silver,
      subTier: 1,
      target: 30,
    ),
    _AchievementDef(
      id: 'streak_s2',
      category: AchievementCategory.streak,
      tier: AchievementTier.silver,
      subTier: 2,
      target: 60,
    ),
    _AchievementDef(
      id: 'streak_s3',
      category: AchievementCategory.streak,
      tier: AchievementTier.silver,
      subTier: 3,
      target: 90,
    ),
    _AchievementDef(
      id: 'streak_g1',
      category: AchievementCategory.streak,
      tier: AchievementTier.gold,
      subTier: 1,
      target: 150,
    ),
    _AchievementDef(
      id: 'streak_g2',
      category: AchievementCategory.streak,
      tier: AchievementTier.gold,
      subTier: 2,
      target: 250,
    ),
    _AchievementDef(
      id: 'streak_g3',
      category: AchievementCategory.streak,
      tier: AchievementTier.gold,
      subTier: 3,
      target: 365,
    ),
    _AchievementDef(
      id: 'streak_p',
      category: AchievementCategory.streak,
      tier: AchievementTier.platinum,
      subTier: 1,
      target: 730,
    ),
  ];

  static const _savingsAchievements = <_AchievementDef>[
    _AchievementDef(
      id: 'savings_b1',
      category: AchievementCategory.savings,
      tier: AchievementTier.bronze,
      subTier: 1,
      target: 250,
    ),
    _AchievementDef(
      id: 'savings_b2',
      category: AchievementCategory.savings,
      tier: AchievementTier.bronze,
      subTier: 2,
      target: 500,
    ),
    _AchievementDef(
      id: 'savings_b3',
      category: AchievementCategory.savings,
      tier: AchievementTier.bronze,
      subTier: 3,
      target: 1000,
    ),
    _AchievementDef(
      id: 'savings_s1',
      category: AchievementCategory.savings,
      tier: AchievementTier.silver,
      subTier: 1,
      target: 2500,
    ),
    _AchievementDef(
      id: 'savings_s2',
      category: AchievementCategory.savings,
      tier: AchievementTier.silver,
      subTier: 2,
      target: 5000,
    ),
    _AchievementDef(
      id: 'savings_s3',
      category: AchievementCategory.savings,
      tier: AchievementTier.silver,
      subTier: 3,
      target: 10000,
    ),
    _AchievementDef(
      id: 'savings_g1',
      category: AchievementCategory.savings,
      tier: AchievementTier.gold,
      subTier: 1,
      target: 25000,
    ),
    _AchievementDef(
      id: 'savings_g2',
      category: AchievementCategory.savings,
      tier: AchievementTier.gold,
      subTier: 2,
      target: 50000,
    ),
    _AchievementDef(
      id: 'savings_g3',
      category: AchievementCategory.savings,
      tier: AchievementTier.gold,
      subTier: 3,
      target: 100000,
    ),
    _AchievementDef(
      id: 'savings_p1',
      category: AchievementCategory.savings,
      tier: AchievementTier.platinum,
      subTier: 1,
      target: 250000,
    ),
    _AchievementDef(
      id: 'savings_p2',
      category: AchievementCategory.savings,
      tier: AchievementTier.platinum,
      subTier: 2,
      target: 500000,
    ),
    _AchievementDef(
      id: 'savings_p3',
      category: AchievementCategory.savings,
      tier: AchievementTier.platinum,
      subTier: 3,
      target: 1000000,
    ),
  ];

  static const _decisionAchievements = <_AchievementDef>[
    _AchievementDef(
      id: 'decision_b1',
      category: AchievementCategory.decision,
      tier: AchievementTier.bronze,
      subTier: 1,
      target: 3,
    ),
    _AchievementDef(
      id: 'decision_b2',
      category: AchievementCategory.decision,
      tier: AchievementTier.bronze,
      subTier: 2,
      target: 7,
    ),
    _AchievementDef(
      id: 'decision_b3',
      category: AchievementCategory.decision,
      tier: AchievementTier.bronze,
      subTier: 3,
      target: 15,
    ),
    _AchievementDef(
      id: 'decision_s1',
      category: AchievementCategory.decision,
      tier: AchievementTier.silver,
      subTier: 1,
      target: 30,
    ),
    _AchievementDef(
      id: 'decision_s2',
      category: AchievementCategory.decision,
      tier: AchievementTier.silver,
      subTier: 2,
      target: 60,
    ),
    _AchievementDef(
      id: 'decision_s3',
      category: AchievementCategory.decision,
      tier: AchievementTier.silver,
      subTier: 3,
      target: 100,
    ),
    _AchievementDef(
      id: 'decision_g1',
      category: AchievementCategory.decision,
      tier: AchievementTier.gold,
      subTier: 1,
      target: 200,
    ),
    _AchievementDef(
      id: 'decision_g2',
      category: AchievementCategory.decision,
      tier: AchievementTier.gold,
      subTier: 2,
      target: 400,
    ),
    _AchievementDef(
      id: 'decision_g3',
      category: AchievementCategory.decision,
      tier: AchievementTier.gold,
      subTier: 3,
      target: 700,
    ),
    _AchievementDef(
      id: 'decision_p',
      category: AchievementCategory.decision,
      tier: AchievementTier.platinum,
      subTier: 1,
      target: 1000,
    ),
  ];

  static const _recordAchievements = <_AchievementDef>[
    _AchievementDef(
      id: 'record_b1',
      category: AchievementCategory.record,
      tier: AchievementTier.bronze,
      subTier: 1,
      target: 5,
    ),
    _AchievementDef(
      id: 'record_b2',
      category: AchievementCategory.record,
      tier: AchievementTier.bronze,
      subTier: 2,
      target: 15,
    ),
    _AchievementDef(
      id: 'record_b3',
      category: AchievementCategory.record,
      tier: AchievementTier.bronze,
      subTier: 3,
      target: 30,
    ),
    _AchievementDef(
      id: 'record_s1',
      category: AchievementCategory.record,
      tier: AchievementTier.silver,
      subTier: 1,
      target: 60,
    ),
    _AchievementDef(
      id: 'record_s2',
      category: AchievementCategory.record,
      tier: AchievementTier.silver,
      subTier: 2,
      target: 120,
    ),
    _AchievementDef(
      id: 'record_s3',
      category: AchievementCategory.record,
      tier: AchievementTier.silver,
      subTier: 3,
      target: 200,
    ),
    _AchievementDef(
      id: 'record_g1',
      category: AchievementCategory.record,
      tier: AchievementTier.gold,
      subTier: 1,
      target: 350,
    ),
    _AchievementDef(
      id: 'record_g2',
      category: AchievementCategory.record,
      tier: AchievementTier.gold,
      subTier: 2,
      target: 600,
    ),
    _AchievementDef(
      id: 'record_g3',
      category: AchievementCategory.record,
      tier: AchievementTier.gold,
      subTier: 3,
      target: 1000,
    ),
    _AchievementDef(
      id: 'record_p',
      category: AchievementCategory.record,
      tier: AchievementTier.platinum,
      subTier: 1,
      target: 2000,
    ),
  ];

  static const _hiddenAchievements = <_HiddenAchievementDef>[
    // EASY
    _HiddenAchievementDef(
      id: 'hidden_night',
      difficulty: HiddenDifficulty.easy,
      checkType: HiddenCheckType.nightRecord,
    ),
    _HiddenAchievementDef(
      id: 'hidden_early',
      difficulty: HiddenDifficulty.easy,
      checkType: HiddenCheckType.earlyRecord,
    ),
    _HiddenAchievementDef(
      id: 'hidden_weekend',
      difficulty: HiddenDifficulty.easy,
      checkType: HiddenCheckType.weekendRecords,
      target: 5,
    ),
    _HiddenAchievementDef(
      id: 'hidden_first_scan',
      difficulty: HiddenDifficulty.easy,
      checkType: HiddenCheckType.firstOcrScan,
    ),
    _HiddenAchievementDef(
      id: 'curious_cat',
      difficulty: HiddenDifficulty.easy,
      checkType: HiddenCheckType.manualUnlock,
    ),
    // MEDIUM
    _HiddenAchievementDef(
      id: 'hidden_balanced_week',
      difficulty: HiddenDifficulty.medium,
      checkType: HiddenCheckType.balancedWeek,
      target: 7,
    ),
    _HiddenAchievementDef(
      id: 'hidden_all_categories',
      difficulty: HiddenDifficulty.medium,
      checkType: HiddenCheckType.allCategories,
      target: 6,
    ),
    _HiddenAchievementDef(
      id: 'hidden_gold_equiv',
      difficulty: HiddenDifficulty.medium,
      checkType: HiddenCheckType.goldEquivalent,
      target: 1,
    ),
    _HiddenAchievementDef(
      id: 'hidden_usd_equiv',
      difficulty: HiddenDifficulty.medium,
      checkType: HiddenCheckType.usdEquivalent,
      target: 100,
    ),
    _HiddenAchievementDef(
      id: 'hidden_subscriptions',
      difficulty: HiddenDifficulty.medium,
      checkType: HiddenCheckType.subscriptionCount,
      target: 5,
    ),
    // HARD
    _HiddenAchievementDef(
      id: 'hidden_no_spend_month',
      difficulty: HiddenDifficulty.hard,
      checkType: HiddenCheckType.noSpendMonth,
      target: 30,
    ),
    _HiddenAchievementDef(
      id: 'hidden_gold_kg',
      difficulty: HiddenDifficulty.hard,
      checkType: HiddenCheckType.goldKgEquivalent,
      target: 1000,
    ),
    _HiddenAchievementDef(
      id: 'hidden_usd_10k',
      difficulty: HiddenDifficulty.hard,
      checkType: HiddenCheckType.usd10kEquivalent,
      target: 10000,
    ),
    _HiddenAchievementDef(
      id: 'hidden_anniversary',
      difficulty: HiddenDifficulty.hard,
      checkType: HiddenCheckType.usageAnniversary,
      target: 365,
    ),
    // LEGENDARY
    _HiddenAchievementDef(
      id: 'hidden_early_adopter',
      difficulty: HiddenDifficulty.legendary,
      checkType: HiddenCheckType.earlyAdopter,
      target: 730,
    ),
    _HiddenAchievementDef(
      id: 'hidden_ultimate',
      difficulty: HiddenDifficulty.legendary,
      checkType: HiddenCheckType.ultimateCombo,
    ),
    _HiddenAchievementDef(
      id: 'hidden_collector',
      difficulty: HiddenDifficulty.legendary,
      checkType: HiddenCheckType.collector,
    ),
  ];

  // ========== LOCALIZATION HELPERS ==========

  String _getAchievementTitle(AppLocalizations l10n, String id) {
    return switch (id) {
      // Streak
      'streak_b1' => l10n.achievementStreakB1Title,
      'streak_b2' => l10n.achievementStreakB2Title,
      'streak_b3' => l10n.achievementStreakB3Title,
      'streak_s1' => l10n.achievementStreakS1Title,
      'streak_s2' => l10n.achievementStreakS2Title,
      'streak_s3' => l10n.achievementStreakS3Title,
      'streak_g1' => l10n.achievementStreakG1Title,
      'streak_g2' => l10n.achievementStreakG2Title,
      'streak_g3' => l10n.achievementStreakG3Title,
      'streak_p' => l10n.achievementStreakPTitle,
      // Savings
      'savings_b1' => l10n.achievementSavingsB1Title,
      'savings_b2' => l10n.achievementSavingsB2Title,
      'savings_b3' => l10n.achievementSavingsB3Title,
      'savings_s1' => l10n.achievementSavingsS1Title,
      'savings_s2' => l10n.achievementSavingsS2Title,
      'savings_s3' => l10n.achievementSavingsS3Title,
      'savings_g1' => l10n.achievementSavingsG1Title,
      'savings_g2' => l10n.achievementSavingsG2Title,
      'savings_g3' => l10n.achievementSavingsG3Title,
      'savings_p1' => l10n.achievementSavingsP1Title,
      'savings_p2' => l10n.achievementSavingsP2Title,
      'savings_p3' => l10n.achievementSavingsP3Title,
      // Decision
      'decision_b1' => l10n.achievementDecisionB1Title,
      'decision_b2' => l10n.achievementDecisionB2Title,
      'decision_b3' => l10n.achievementDecisionB3Title,
      'decision_s1' => l10n.achievementDecisionS1Title,
      'decision_s2' => l10n.achievementDecisionS2Title,
      'decision_s3' => l10n.achievementDecisionS3Title,
      'decision_g1' => l10n.achievementDecisionG1Title,
      'decision_g2' => l10n.achievementDecisionG2Title,
      'decision_g3' => l10n.achievementDecisionG3Title,
      'decision_p' => l10n.achievementDecisionPTitle,
      // Record
      'record_b1' => l10n.achievementRecordB1Title,
      'record_b2' => l10n.achievementRecordB2Title,
      'record_b3' => l10n.achievementRecordB3Title,
      'record_s1' => l10n.achievementRecordS1Title,
      'record_s2' => l10n.achievementRecordS2Title,
      'record_s3' => l10n.achievementRecordS3Title,
      'record_g1' => l10n.achievementRecordG1Title,
      'record_g2' => l10n.achievementRecordG2Title,
      'record_g3' => l10n.achievementRecordG3Title,
      'record_p' => l10n.achievementRecordPTitle,
      // Hidden
      'hidden_night' => l10n.achievementHiddenNightTitle,
      'hidden_early' => l10n.achievementHiddenEarlyTitle,
      'hidden_weekend' => l10n.achievementHiddenWeekendTitle,
      'hidden_first_scan' => l10n.achievementHiddenOcrTitle,
      'curious_cat' => l10n.achievementHiddenCuriousCatTitle,
      'hidden_balanced_week' => l10n.achievementHiddenBalancedTitle,
      'hidden_all_categories' => l10n.achievementHiddenCategoriesTitle,
      'hidden_gold_equiv' => l10n.achievementHiddenGoldTitle,
      'hidden_usd_equiv' => l10n.achievementHiddenUsdTitle,
      'hidden_subscriptions' => l10n.achievementHiddenSubsTitle,
      'hidden_no_spend_month' => l10n.achievementHiddenNoSpendTitle,
      'hidden_gold_kg' => l10n.achievementHiddenGoldKgTitle,
      'hidden_usd_10k' => l10n.achievementHiddenUsd10kTitle,
      'hidden_anniversary' => l10n.achievementHiddenAnniversaryTitle,
      'hidden_early_adopter' => l10n.achievementHiddenEarlyAdopterTitle,
      'hidden_ultimate' => l10n.achievementHiddenUltimateTitle,
      'hidden_collector' => l10n.achievementHiddenCollectorTitle,
      _ => id,
    };
  }

  String _getAchievementDescription(AppLocalizations l10n, String id) {
    return switch (id) {
      // Streak
      'streak_b1' => l10n.achievementStreakB1Desc,
      'streak_b2' => l10n.achievementStreakB2Desc,
      'streak_b3' => l10n.achievementStreakB3Desc,
      'streak_s1' => l10n.achievementStreakS1Desc,
      'streak_s2' => l10n.achievementStreakS2Desc,
      'streak_s3' => l10n.achievementStreakS3Desc,
      'streak_g1' => l10n.achievementStreakG1Desc,
      'streak_g2' => l10n.achievementStreakG2Desc,
      'streak_g3' => l10n.achievementStreakG3Desc,
      'streak_p' => l10n.achievementStreakPDesc,
      // Savings
      'savings_b1' => l10n.achievementSavingsB1Desc,
      'savings_b2' => l10n.achievementSavingsB2Desc,
      'savings_b3' => l10n.achievementSavingsB3Desc,
      'savings_s1' => l10n.achievementSavingsS1Desc,
      'savings_s2' => l10n.achievementSavingsS2Desc,
      'savings_s3' => l10n.achievementSavingsS3Desc,
      'savings_g1' => l10n.achievementSavingsG1Desc,
      'savings_g2' => l10n.achievementSavingsG2Desc,
      'savings_g3' => l10n.achievementSavingsG3Desc,
      'savings_p1' => l10n.achievementSavingsP1Desc,
      'savings_p2' => l10n.achievementSavingsP2Desc,
      'savings_p3' => l10n.achievementSavingsP3Desc,
      // Decision
      'decision_b1' => l10n.achievementDecisionB1Desc,
      'decision_b2' => l10n.achievementDecisionB2Desc,
      'decision_b3' => l10n.achievementDecisionB3Desc,
      'decision_s1' => l10n.achievementDecisionS1Desc,
      'decision_s2' => l10n.achievementDecisionS2Desc,
      'decision_s3' => l10n.achievementDecisionS3Desc,
      'decision_g1' => l10n.achievementDecisionG1Desc,
      'decision_g2' => l10n.achievementDecisionG2Desc,
      'decision_g3' => l10n.achievementDecisionG3Desc,
      'decision_p' => l10n.achievementDecisionPDesc,
      // Record
      'record_b1' => l10n.achievementRecordB1Desc,
      'record_b2' => l10n.achievementRecordB2Desc,
      'record_b3' => l10n.achievementRecordB3Desc,
      'record_s1' => l10n.achievementRecordS1Desc,
      'record_s2' => l10n.achievementRecordS2Desc,
      'record_s3' => l10n.achievementRecordS3Desc,
      'record_g1' => l10n.achievementRecordG1Desc,
      'record_g2' => l10n.achievementRecordG2Desc,
      'record_g3' => l10n.achievementRecordG3Desc,
      'record_p' => l10n.achievementRecordPDesc,
      // Hidden
      'hidden_night' => l10n.achievementHiddenNightDesc,
      'hidden_early' => l10n.achievementHiddenEarlyDesc,
      'hidden_weekend' => l10n.achievementHiddenWeekendDesc,
      'hidden_first_scan' => l10n.achievementHiddenOcrDesc,
      'curious_cat' => l10n.achievementHiddenCuriousCatDesc,
      'hidden_balanced_week' => l10n.achievementHiddenBalancedDesc,
      'hidden_all_categories' => l10n.achievementHiddenCategoriesDesc,
      'hidden_gold_equiv' => l10n.achievementHiddenGoldDesc,
      'hidden_usd_equiv' => l10n.achievementHiddenUsdDesc,
      'hidden_subscriptions' => l10n.achievementHiddenSubsDesc,
      'hidden_no_spend_month' => l10n.achievementHiddenNoSpendDesc,
      'hidden_gold_kg' => l10n.achievementHiddenGoldKgDesc,
      'hidden_usd_10k' => l10n.achievementHiddenUsd10kDesc,
      'hidden_anniversary' => l10n.achievementHiddenAnniversaryDesc,
      'hidden_early_adopter' => l10n.achievementHiddenEarlyAdopterDesc,
      'hidden_ultimate' => l10n.achievementHiddenUltimateDesc,
      'hidden_collector' => l10n.achievementHiddenCollectorDesc,
      _ => id,
    };
  }

  /// Calculate and return all achievements
  Future<List<Achievement>> getAchievements(BuildContext context) async {
    final l10n = AppLocalizations.of(context);
    final prefs = await SharedPreferences.getInstance();

    // Save first install date
    await _ensureFirstInstallDate(prefs);

    // Collect data
    final streakData = await _streakService.getStreakData();
    final expenses = await _historyService.getRealExpenses();
    final stats = DecisionStats.fromExpenses(expenses);

    // Get exchange rates
    double? usdRate;
    double? goldGramRate;
    try {
      final rates = await _currencyService.fetchRates();
      if (rates != null) {
        usdRate = rates.usdRate;
        goldGramRate = rates.goldRate;
      }
    } catch (_) {}

    // Get subscription count
    int subscriptionCount = 0;
    try {
      final subs = await _subscriptionService.getSubscriptions();
      subscriptionCount = subs.length;
    } catch (_) {}

    final achievements = <Achievement>[];

    // Regular achievements
    final allDefs = [
      ..._streakAchievements,
      ..._savingsAchievements,
      ..._decisionAchievements,
      ..._recordAchievements,
    ];

    for (final def in allDefs) {
      final currentValue = _getCurrentValue(
        def,
        streakData,
        stats,
        expenses.length,
      );
      final progress = (currentValue / def.target).clamp(0.0, 1.0);
      final isComplete = currentValue >= def.target;

      DateTime? unlockedAt;
      final savedDate = prefs.getString('$_keyPrefix${def.id}');

      if (savedDate != null) {
        unlockedAt = DateTime.tryParse(savedDate);
      } else if (isComplete) {
        unlockedAt = DateTime.now();
        await prefs.setString(
          '$_keyPrefix${def.id}',
          unlockedAt.toIso8601String(),
        );
      }

      achievements.add(
        Achievement(
          id: def.id,
          title: _getAchievementTitle(l10n, def.id),
          description: _getAchievementDescription(l10n, def.id),
          category: def.category,
          tier: def.tier,
          subTier: def.subTier,
          progress: progress,
          currentValue: currentValue,
          targetValue: def.target,
          unlockedAt: unlockedAt,
        ),
      );
    }

    // Hidden achievements
    for (final def in _hiddenAchievements) {
      final checkResult = await _checkHiddenAchievement(
        def,
        prefs,
        expenses,
        stats,
        streakData,
        usdRate,
        goldGramRate,
        subscriptionCount,
        achievements,
      );

      DateTime? unlockedAt;
      final savedDate = prefs.getString('$_keyPrefix${def.id}');

      if (savedDate != null) {
        unlockedAt = DateTime.tryParse(savedDate);
      } else if (checkResult.isComplete) {
        unlockedAt = DateTime.now();
        await prefs.setString(
          '$_keyPrefix${def.id}',
          unlockedAt.toIso8601String(),
        );
      }

      achievements.add(
        Achievement(
          id: def.id,
          title: _getAchievementTitle(l10n, def.id),
          description: _getAchievementDescription(l10n, def.id),
          category: AchievementCategory.hidden,
          tier: _difficultyToTier(def.difficulty),
          subTier: 1,
          progress: checkResult.progress,
          currentValue: checkResult.currentValue,
          targetValue: def.target ?? 1,
          unlockedAt: unlockedAt,
          isHidden: true,
          hiddenDifficulty: def.difficulty,
        ),
      );
    }

    return achievements;
  }

  Future<void> _ensureFirstInstallDate(SharedPreferences prefs) async {
    if (prefs.getString(_keyFirstInstall) == null) {
      await prefs.setString(_keyFirstInstall, DateTime.now().toIso8601String());
    }
  }

  int _getCurrentValue(
    _AchievementDef def,
    StreakData streakData,
    DecisionStats stats,
    int totalExpenses,
  ) {
    switch (def.category) {
      case AchievementCategory.streak:
        return streakData.longestStreak;
      case AchievementCategory.savings:
        return stats.savedAmount.toInt();
      case AchievementCategory.decision:
        return stats.noCount;
      case AchievementCategory.record:
        return totalExpenses;
      case AchievementCategory.hidden:
        return 0;
    }
  }

  Future<_HiddenCheckResult> _checkHiddenAchievement(
    _HiddenAchievementDef def,
    SharedPreferences prefs,
    List<Expense> expenses,
    DecisionStats stats,
    StreakData streakData,
    double? usdRate,
    double? goldGramRate,
    int subscriptionCount,
    List<Achievement> currentAchievements,
  ) async {
    switch (def.checkType) {
      case HiddenCheckType.nightRecord:
        final hasNightRecord = expenses.any((e) {
          final hour = e.date.hour;
          return hour >= 0 && hour < 5;
        });
        return _HiddenCheckResult(
          isComplete: hasNightRecord,
          currentValue: hasNightRecord ? 1 : 0,
          progress: hasNightRecord ? 1.0 : 0.0,
        );

      case HiddenCheckType.earlyRecord:
        final hasEarlyRecord = expenses.any((e) {
          final hour = e.date.hour;
          return hour >= 5 && hour < 7;
        });
        return _HiddenCheckResult(
          isComplete: hasEarlyRecord,
          currentValue: hasEarlyRecord ? 1 : 0,
          progress: hasEarlyRecord ? 1.0 : 0.0,
        );

      case HiddenCheckType.weekendRecords:
        final weekendCount = expenses.where((e) {
          final weekday = e.date.weekday;
          return weekday == DateTime.saturday || weekday == DateTime.sunday;
        }).length;
        final target = def.target ?? 5;
        return _HiddenCheckResult(
          isComplete: weekendCount >= target,
          currentValue: weekendCount,
          progress: (weekendCount / target).clamp(0.0, 1.0),
        );

      case HiddenCheckType.firstOcrScan:
        final hasOcrScan = prefs.getBool('ocr_used') ?? false;
        return _HiddenCheckResult(
          isComplete: hasOcrScan,
          currentValue: hasOcrScan ? 1 : 0,
          progress: hasOcrScan ? 1.0 : 0.0,
        );

      case HiddenCheckType.balancedWeek:
        final consecutiveNoBuy = _getConsecutiveNoBuyDays(expenses);
        final target = def.target ?? 7;
        return _HiddenCheckResult(
          isComplete: consecutiveNoBuy >= target,
          currentValue: consecutiveNoBuy,
          progress: (consecutiveNoBuy / target).clamp(0.0, 1.0),
        );

      case HiddenCheckType.allCategories:
        final usedCategories = expenses.map((e) => e.category).toSet();
        final target = def.target ?? 6;
        return _HiddenCheckResult(
          isComplete: usedCategories.length >= target,
          currentValue: usedCategories.length,
          progress: (usedCategories.length / target).clamp(0.0, 1.0),
        );

      case HiddenCheckType.goldEquivalent:
        if (goldGramRate == null || goldGramRate <= 0) {
          return _HiddenCheckResult(
            isComplete: false,
            currentValue: 0,
            progress: 0.0,
          );
        }
        final goldGrams = stats.savedAmount / goldGramRate;
        final target = def.target ?? 1;
        return _HiddenCheckResult(
          isComplete: goldGrams >= target,
          currentValue: goldGrams.toInt(),
          progress: (goldGrams / target).clamp(0.0, 1.0),
        );

      case HiddenCheckType.usdEquivalent:
        if (usdRate == null || usdRate <= 0) {
          return _HiddenCheckResult(
            isComplete: false,
            currentValue: 0,
            progress: 0.0,
          );
        }
        final usdAmount = stats.savedAmount / usdRate;
        final target = def.target ?? 100;
        return _HiddenCheckResult(
          isComplete: usdAmount >= target,
          currentValue: usdAmount.toInt(),
          progress: (usdAmount / target).clamp(0.0, 1.0),
        );

      case HiddenCheckType.subscriptionCount:
        final target = def.target ?? 5;
        return _HiddenCheckResult(
          isComplete: subscriptionCount >= target,
          currentValue: subscriptionCount,
          progress: (subscriptionCount / target).clamp(0.0, 1.0),
        );

      case HiddenCheckType.noSpendMonth:
        final consecutiveNoBuy = _getConsecutiveNoBuyDays(expenses);
        final target = def.target ?? 30;
        return _HiddenCheckResult(
          isComplete: consecutiveNoBuy >= target,
          currentValue: consecutiveNoBuy,
          progress: (consecutiveNoBuy / target).clamp(0.0, 1.0),
        );

      case HiddenCheckType.goldKgEquivalent:
        if (goldGramRate == null || goldGramRate <= 0) {
          return _HiddenCheckResult(
            isComplete: false,
            currentValue: 0,
            progress: 0.0,
          );
        }
        final goldGrams = stats.savedAmount / goldGramRate;
        final target = def.target ?? 1000;
        return _HiddenCheckResult(
          isComplete: goldGrams >= target,
          currentValue: goldGrams.toInt(),
          progress: (goldGrams / target).clamp(0.0, 1.0),
        );

      case HiddenCheckType.usd10kEquivalent:
        if (usdRate == null || usdRate <= 0) {
          return _HiddenCheckResult(
            isComplete: false,
            currentValue: 0,
            progress: 0.0,
          );
        }
        final usdAmount = stats.savedAmount / usdRate;
        final target = def.target ?? 10000;
        return _HiddenCheckResult(
          isComplete: usdAmount >= target,
          currentValue: usdAmount.toInt(),
          progress: (usdAmount / target).clamp(0.0, 1.0),
        );

      case HiddenCheckType.usageAnniversary:
        final firstInstall = prefs.getString(_keyFirstInstall);
        if (firstInstall == null) {
          return _HiddenCheckResult(
            isComplete: false,
            currentValue: 0,
            progress: 0.0,
          );
        }
        final installDate = DateTime.tryParse(firstInstall);
        if (installDate == null) {
          return _HiddenCheckResult(
            isComplete: false,
            currentValue: 0,
            progress: 0.0,
          );
        }
        final daysSinceInstall = DateTime.now().difference(installDate).inDays;
        final target = def.target ?? 365;
        return _HiddenCheckResult(
          isComplete: daysSinceInstall >= target,
          currentValue: daysSinceInstall,
          progress: (daysSinceInstall / target).clamp(0.0, 1.0),
        );

      case HiddenCheckType.earlyAdopter:
        final firstInstall = prefs.getString(_keyFirstInstall);
        if (firstInstall == null) {
          return _HiddenCheckResult(
            isComplete: false,
            currentValue: 0,
            progress: 0.0,
          );
        }
        final installDate = DateTime.tryParse(firstInstall);
        if (installDate == null) {
          return _HiddenCheckResult(
            isComplete: false,
            currentValue: 0,
            progress: 0.0,
          );
        }
        final daysSinceInstall = DateTime.now().difference(installDate).inDays;
        final target = def.target ?? 730;
        return _HiddenCheckResult(
          isComplete: daysSinceInstall >= target,
          currentValue: daysSinceInstall,
          progress: (daysSinceInstall / target).clamp(0.0, 1.0),
        );

      case HiddenCheckType.ultimateCombo:
        final hasMillion = stats.savedAmount >= 1000000;
        final hasYearStreak = streakData.longestStreak >= 365;
        final isComplete = hasMillion && hasYearStreak;
        double progress = 0.0;
        if (hasMillion && hasYearStreak) {
          progress = 1.0;
        } else if (hasMillion || hasYearStreak) {
          progress = 0.5;
        }
        return _HiddenCheckResult(
          isComplete: isComplete,
          currentValue: isComplete ? 1 : 0,
          progress: progress,
        );

      case HiddenCheckType.collector:
        final nonPlatinumNonHidden = currentAchievements
            .where((a) => a.tier != AchievementTier.platinum && !a.isHidden)
            .toList();
        final unlockedCount = nonPlatinumNonHidden
            .where((a) => a.isUnlocked)
            .length;
        final totalCount = nonPlatinumNonHidden.length;
        final isComplete = unlockedCount >= totalCount && totalCount > 0;
        return _HiddenCheckResult(
          isComplete: isComplete,
          currentValue: unlockedCount,
          progress: totalCount > 0
              ? (unlockedCount / totalCount).clamp(0.0, 1.0)
              : 0.0,
        );

      case HiddenCheckType.manualUnlock:
        final isUnlocked = prefs.getString('$_keyPrefix${def.id}') != null;
        return _HiddenCheckResult(
          isComplete: isUnlocked,
          currentValue: isUnlocked ? 1 : 0,
          progress: isUnlocked ? 1.0 : 0.0,
        );
    }
  }

  int _getConsecutiveNoBuyDays(List<Expense> expenses) {
    if (expenses.isEmpty) return 0;

    final buyDates = expenses
        .where((e) => e.decision == ExpenseDecision.yes)
        .map((e) => DateTime(e.date.year, e.date.month, e.date.day))
        .toSet();

    if (buyDates.isEmpty) {
      final firstRecord = expenses
          .map((e) => e.date)
          .reduce((a, b) => a.isBefore(b) ? a : b);
      return DateTime.now().difference(firstRecord).inDays;
    }

    int consecutive = 0;
    var checkDate = DateTime.now();
    checkDate = DateTime(checkDate.year, checkDate.month, checkDate.day);

    while (!buyDates.contains(checkDate)) {
      consecutive++;
      checkDate = checkDate.subtract(const Duration(days: 1));
      if (consecutive > 365) break;
    }

    return consecutive;
  }

  AchievementTier _difficultyToTier(HiddenDifficulty difficulty) {
    switch (difficulty) {
      case HiddenDifficulty.easy:
        return AchievementTier.bronze;
      case HiddenDifficulty.medium:
        return AchievementTier.silver;
      case HiddenDifficulty.hard:
        return AchievementTier.gold;
      case HiddenDifficulty.legendary:
        return AchievementTier.platinum;
    }
  }

  /// Total achievement count
  int get totalCount =>
      _streakAchievements.length +
      _savingsAchievements.length +
      _decisionAchievements.length +
      _recordAchievements.length +
      _hiddenAchievements.length;

  /// Visible (non-hidden) achievement count
  int get visibleCount =>
      _streakAchievements.length +
      _savingsAchievements.length +
      _decisionAchievements.length +
      _recordAchievements.length;

  /// Check for newly unlocked achievements (unlocked today)
  Future<List<Achievement>> getNewlyUnlockedAchievements(
    BuildContext context,
  ) async {
    final achievements = await getAchievements(context);
    return achievements.where((a) => a.isNewlyUnlocked).toList();
  }

  /// Mark OCR as used
  Future<void> markOcrUsed() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool('ocr_used', true);
  }

  /// Manually unlock an achievement (for Easter Eggs, etc.)
  Future<bool> unlockManualAchievement(String achievementId) async {
    final prefs = await SharedPreferences.getInstance();
    final key = '$_keyPrefix$achievementId';

    if (prefs.getString(key) != null) {
      return false; // Already unlocked
    }

    await prefs.setString(key, DateTime.now().toIso8601String());
    return true;
  }

  /// Check if an achievement is unlocked
  Future<bool> isAchievementUnlocked(String achievementId) async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getString('$_keyPrefix$achievementId') != null;
  }

  /// Reset all achievement data (for testing)
  Future<void> resetAllAchievements() async {
    final prefs = await SharedPreferences.getInstance();
    final allDefs = [
      ..._streakAchievements,
      ..._savingsAchievements,
      ..._decisionAchievements,
      ..._recordAchievements,
    ];
    for (final def in allDefs) {
      await prefs.remove('$_keyPrefix${def.id}');
    }
    for (final def in _hiddenAchievements) {
      await prefs.remove('$_keyPrefix${def.id}');
    }
    await prefs.remove('ocr_used');
  }
}

// ========== HELPER CLASSES ==========

class _AchievementDef {
  final String id;
  final AchievementCategory category;
  final AchievementTier tier;
  final int subTier;
  final int target;

  const _AchievementDef({
    required this.id,
    required this.category,
    required this.tier,
    required this.subTier,
    required this.target,
  });
}

enum HiddenCheckType {
  nightRecord,
  earlyRecord,
  weekendRecords,
  firstOcrScan,
  balancedWeek,
  allCategories,
  goldEquivalent,
  usdEquivalent,
  subscriptionCount,
  noSpendMonth,
  goldKgEquivalent,
  usd10kEquivalent,
  usageAnniversary,
  earlyAdopter,
  ultimateCombo,
  collector,
  manualUnlock,
}

class _HiddenAchievementDef {
  final String id;
  final HiddenDifficulty difficulty;
  final HiddenCheckType checkType;
  final int? target;

  const _HiddenAchievementDef({
    required this.id,
    required this.difficulty,
    required this.checkType,
    this.target,
  });
}

class _HiddenCheckResult {
  final bool isComplete;
  final int currentValue;
  final double progress;

  const _HiddenCheckResult({
    required this.isComplete,
    required this.currentValue,
    required this.progress,
  });
}


--- FILE: lib/services/backup_service.dart ---

import 'dart:convert';
import 'dart:io';
import 'package:file_picker/file_picker.dart';
import 'package:flutter/foundation.dart';
import 'package:path_provider/path_provider.dart';
import 'package:share_plus/share_plus.dart';
import '../models/models.dart';
import 'expense_history_service.dart';
import 'pursuit_service.dart';
import 'subscription_service.dart';

/// Backup and restore service for user data
class BackupService {
  static final BackupService _instance = BackupService._internal();
  factory BackupService() => _instance;
  BackupService._internal();

  final _expenseService = ExpenseHistoryService();
  final _pursuitService = PursuitService();
  final _subscriptionService = SubscriptionService();

  /// Create a backup of all user data
  Future<Map<String, dynamic>> createBackup() async {
    try {
      // Get all data
      final expenses = await _expenseService.getExpenses();
      final pursuits = await _pursuitService.getAllPursuits();
      final subscriptions = await _subscriptionService.getSubscriptions();

      // Create backup structure
      final backup = {
        'version': 1,
        'createdAt': DateTime.now().toIso8601String(),
        'appVersion': '1.0.3',
        'data': {
          'expenses': expenses.map((e) => e.toJson()).toList(),
          'pursuits': pursuits.map((p) => p.toJson()).toList(),
          'subscriptions': subscriptions.map((s) => s.toJson()).toList(),
        },
      };

      return backup;
    } catch (e) {
      debugPrint('[Backup] Error creating backup: $e');
      rethrow;
    }
  }

  /// Export backup to a file and share
  Future<String?> exportBackup() async {
    try {
      final backup = await createBackup();
      final jsonString = const JsonEncoder.withIndent('  ').convert(backup);

      // Get temp directory
      final tempDir = await getTemporaryDirectory();
      final timestamp = DateTime.now().millisecondsSinceEpoch;
      final fileName = 'vantag_backup_$timestamp.json';
      final filePath = '${tempDir.path}/$fileName';

      // Write to file
      final file = File(filePath);
      await file.writeAsString(jsonString);

      // Share file
      await Share.shareXFiles(
        [XFile(filePath)],
        subject: 'Vantag Backup',
        text: 'Vantag verilerim yedegi',
      );

      return filePath;
    } catch (e) {
      debugPrint('[Backup] Error exporting backup: $e');
      return null;
    }
  }

  /// Import backup from a file
  Future<BackupResult> importBackup() async {
    try {
      // Pick file
      final result = await FilePicker.platform.pickFiles(
        type: FileType.custom,
        allowedExtensions: ['json'],
      );

      if (result == null || result.files.isEmpty) {
        return BackupResult(success: false, error: 'noFileSelected');
      }

      final file = File(result.files.single.path!);
      final jsonString = await file.readAsString();
      final backup = jsonDecode(jsonString) as Map<String, dynamic>;

      // Validate backup
      if (backup['version'] == null || backup['data'] == null) {
        return BackupResult(success: false, error: 'invalidBackupFormat');
      }

      return await restoreBackup(backup);
    } catch (e) {
      debugPrint('[Backup] Error importing backup: $e');
      return BackupResult(success: false, error: 'importError');
    }
  }

  /// Restore data from backup
  Future<BackupResult> restoreBackup(Map<String, dynamic> backup) async {
    try {
      final data = backup['data'] as Map<String, dynamic>;
      int expensesRestored = 0;
      int pursuitsRestored = 0;
      int subscriptionsRestored = 0;

      // Restore expenses
      if (data['expenses'] != null) {
        final expenses = (data['expenses'] as List)
            .map((e) => Expense.fromJson(e as Map<String, dynamic>))
            .toList();

        for (final expense in expenses) {
          await _expenseService.addExpense(expense);
          expensesRestored++;
        }
      }

      // Restore pursuits
      if (data['pursuits'] != null) {
        final pursuits = (data['pursuits'] as List)
            .map((p) => Pursuit.fromJson(p as Map<String, dynamic>))
            .toList();

        for (final pursuit in pursuits) {
          await _pursuitService.createPursuit(pursuit);
          pursuitsRestored++;
        }
      }

      // Restore subscriptions
      if (data['subscriptions'] != null) {
        final subscriptions = (data['subscriptions'] as List)
            .map((s) => Subscription.fromJson(s as Map<String, dynamic>))
            .toList();

        for (final subscription in subscriptions) {
          await _subscriptionService.addSubscription(subscription);
          subscriptionsRestored++;
        }
      }

      return BackupResult(
        success: true,
        expensesRestored: expensesRestored,
        pursuitsRestored: pursuitsRestored,
        subscriptionsRestored: subscriptionsRestored,
      );
    } catch (e) {
      debugPrint('[Backup] Error restoring backup: $e');
      return BackupResult(success: false, error: 'restoreError');
    }
  }

  /// Get backup stats
  Future<BackupStats> getBackupStats() async {
    final expenses = await _expenseService.getExpenses();
    final pursuits = await _pursuitService.getAllPursuits();
    final subscriptions = await _subscriptionService.getSubscriptions();

    return BackupStats(
      expenseCount: expenses.length,
      pursuitCount: pursuits.length,
      subscriptionCount: subscriptions.length,
    );
  }
}

/// Result of a backup operation
class BackupResult {
  final bool success;
  final String? error;
  final int expensesRestored;
  final int pursuitsRestored;
  final int subscriptionsRestored;

  BackupResult({
    required this.success,
    this.error,
    this.expensesRestored = 0,
    this.pursuitsRestored = 0,
    this.subscriptionsRestored = 0,
  });
}

/// Stats about data to be backed up
class BackupStats {
  final int expenseCount;
  final int pursuitCount;
  final int subscriptionCount;

  BackupStats({
    required this.expenseCount,
    required this.pursuitCount,
    required this.subscriptionCount,
  });

  int get totalItems => expenseCount + pursuitCount + subscriptionCount;
}

/// Global instance
final backupService = BackupService();


--- FILE: lib/services/receipt_scanner_service.dart ---

import 'dart:io';
import 'package:flutter/foundation.dart';
// TEMPORARILY DISABLED for iOS Simulator - ML Kit doesn't support arm64 simulator
// import 'package:google_mlkit_text_recognition/google_mlkit_text_recognition.dart';
import 'package:image_picker/image_picker.dart';
import 'analytics_service.dart';

/// Result from scanning a receipt
class ScanResult {
  final double? amount;
  final String? merchant;
  final DateTime? date;
  final String? currency;

  const ScanResult({this.amount, this.merchant, this.date, this.currency});

  bool get hasAmount => amount != null && amount! > 0;

  @override
  String toString() =>
      'ScanResult(amount: $amount, merchant: $merchant, date: $date, currency: $currency)';
}

class ReceiptScannerService {
  // TEMPORARILY DISABLED for iOS Simulator
  // final _textRecognizer = TextRecognizer(script: TextRecognitionScript.latin);
  final _imagePicker = ImagePicker();

  Future<File?> pickImage({required bool fromCamera}) async {
    final XFile? image = await _imagePicker.pickImage(
      source: fromCamera ? ImageSource.camera : ImageSource.gallery,
      imageQuality: 85,
    );

    if (image == null) return null;
    return File(image.path);
  }

  /// Scan receipt and extract amount, merchant, and currency
  /// TEMPORARILY DISABLED - Returns empty result for simulator testing
  Future<ScanResult> scanReceipt() async {
    // Track receipt scanner usage
    AnalyticsService().logReceiptScanned();

    // TEMPORARILY DISABLED for iOS Simulator
    debugPrint('[ReceiptScanner] ML Kit temporarily disabled for simulator testing');
    return const ScanResult();

    /* ORIGINAL CODE - Re-enable when ML Kit is restored:
    final imageFile = await pickImage(fromCamera: true);
    if (imageFile == null) {
      return const ScanResult();
    }
    return extractFromReceipt(imageFile);
    */
  }

  /// Extract data from receipt image
  /// TEMPORARILY DISABLED - Returns empty result for simulator testing
  Future<ScanResult> extractFromReceipt(File imageFile) async {
    // TEMPORARILY DISABLED for iOS Simulator
    debugPrint('[ReceiptScanner] ML Kit temporarily disabled for simulator testing');
    return const ScanResult();

    /* ORIGINAL CODE - Re-enable when ML Kit is restored:
    final inputImage = InputImage.fromFile(imageFile);
    final recognizedText = await _textRecognizer.processImage(inputImage);

    final fullText = recognizedText.text;
    final lines = fullText.split('\n');

    // Detect currency from receipt
    final currency = _detectCurrency(fullText);

    // Extract merchant (usually first non-empty line or line with store name)
    final merchant = _extractMerchant(lines);

    // Extract total amount
    final amount = _extractTotal(lines);

    debugPrint(
      '[ReceiptScanner] Extracted: amount=$amount, currency=$currency, merchant=$merchant',
    );

    return ScanResult(amount: amount, merchant: merchant, currency: currency);
    */
  }

  /// Legacy method for backwards compatibility
  Future<double?> extractTotalFromReceipt(File imageFile) async {
    final result = await extractFromReceipt(imageFile);
    return result.amount;
  }

  void dispose() {
    // TEMPORARILY DISABLED for iOS Simulator
    // _textRecognizer.close();
  }
}


--- FILE: lib/services/referral_service.dart ---

import 'dart:convert';
import 'package:crypto/crypto.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:flutter/foundation.dart';
import 'package:http/http.dart' as http;
import 'notification_service.dart';

/// Service for handling referral system with IP-based abuse prevention
/// Prevents same IP from creating multiple accounts for referral bonus abuse
class ReferralService {
  static final ReferralService _instance = ReferralService._internal();
  factory ReferralService() => _instance;
  ReferralService._internal();

  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final FirebaseAuth _auth = FirebaseAuth.instance;

  static const int _maxAccountsPerIP = 3;
  static const String _ipHashCollection = 'ip_hashes';
  static const String _referralsCollection = 'referrals';

  /// Get current user's IP address
  Future<String?> _getIPAddress() async {
    try {
      final response = await http
          .get(Uri.parse('https://api.ipify.org?format=json'))
          .timeout(const Duration(seconds: 5));

      if (response.statusCode == 200) {
        final data = json.decode(response.body);
        return data['ip'] as String?;
      }
    } catch (e) {
      debugPrint('[ReferralService] Error getting IP: $e');
    }
    return null;
  }

  /// Hash an IP address for privacy
  String _hashIP(String ip) {
    final bytes = utf8.encode(ip);
    final digest = sha256.convert(bytes);
    return digest.toString();
  }

  /// Register user's IP hash when they create an account
  Future<void> registerUserIP() async {
    final user = _auth.currentUser;
    if (user == null) return;

    final ip = await _getIPAddress();
    if (ip == null) {
      debugPrint('[ReferralService] Could not get IP, skipping registration');
      return;
    }

    final ipHash = _hashIP(ip);

    try {
      // Store IP hash with user ID
      await _firestore.collection(_ipHashCollection).doc(user.uid).set({
        'ipHash': ipHash,
        'createdAt': FieldValue.serverTimestamp(),
      }, SetOptions(merge: true));

      debugPrint('[ReferralService] Registered IP hash for user ${user.uid}');
    } catch (e) {
      debugPrint('[ReferralService] Error registering IP: $e');
    }
  }

  /// Check if a referral bonus can be granted (IP not abused)
  /// Returns true if bonus can be granted, false if abuse detected
  Future<bool> canGrantReferralBonus() async {
    final ip = await _getIPAddress();
    if (ip == null) {
      // If we can't get IP, allow the bonus (benefit of doubt)
      debugPrint('[ReferralService] Could not get IP, allowing bonus');
      return true;
    }

    final ipHash = _hashIP(ip);

    try {
      // Count how many users have this IP hash
      final query = await _firestore
          .collection(_ipHashCollection)
          .where('ipHash', isEqualTo: ipHash)
          .get();

      final accountCount = query.docs.length;
      debugPrint('[ReferralService] Accounts with same IP: $accountCount');

      if (accountCount >= _maxAccountsPerIP) {
        debugPrint(
          '[ReferralService] IP abuse detected: $accountCount accounts from same IP',
        );
        return false;
      }

      return true;
    } catch (e) {
      debugPrint('[ReferralService] Error checking IP abuse: $e');
      // On error, allow the bonus
      return true;
    }
  }

  /// Apply referral code and grant bonus if valid
  /// Returns true if successful, false if abused or invalid
  Future<ReferralResult> applyReferralCode(String referralCode) async {
    final user = _auth.currentUser;
    if (user == null) {
      return ReferralResult(success: false, message: 'User not logged in');
    }

    // Check if user already used a referral code
    final userDoc = await _firestore.collection('users').doc(user.uid).get();
    if (userDoc.exists && userDoc.data()?['usedReferralCode'] != null) {
      return ReferralResult(
        success: false,
        message: 'Already used a referral code',
      );
    }

    // Check IP abuse
    final canGrant = await canGrantReferralBonus();
    if (!canGrant) {
      return ReferralResult(
        success: false,
        message: 'Referral bonus not available',
        isAbuse: true,
      );
    }

    // Validate referral code exists
    final referrerQuery = await _firestore
        .collection('users')
        .where('referralCode', isEqualTo: referralCode)
        .limit(1)
        .get();

    if (referrerQuery.docs.isEmpty) {
      return ReferralResult(success: false, message: 'Invalid referral code');
    }

    final referrerId = referrerQuery.docs.first.id;

    // Can't refer yourself
    if (referrerId == user.uid) {
      return ReferralResult(
        success: false,
        message: 'Cannot use your own referral code',
      );
    }

    try {
      // Record the referral
      await _firestore.collection(_referralsCollection).add({
        'referrerId': referrerId,
        'refereeId': user.uid,
        'referralCode': referralCode,
        'createdAt': FieldValue.serverTimestamp(),
        'bonusGranted': true,
      });

      // Mark user as having used a referral code
      await _firestore.collection('users').doc(user.uid).set({
        'usedReferralCode': referralCode,
        'referredBy': referrerId,
      }, SetOptions(merge: true));

      // Increment referrer's referral count
      await _firestore.collection('users').doc(referrerId).set({
        'referralCount': FieldValue.increment(1),
      }, SetOptions(merge: true));

      // Grant 7 days trial to new user (referee)
      // Schedule trial reminder notifications
      try {
        await NotificationService().scheduleTrialNotifications(
          trialStartDate: DateTime.now(),
          trialDays: 7,
        );
        debugPrint(
          '[ReferralService] Trial notifications scheduled for 7 days',
        );
      } catch (e) {
        debugPrint(
          '[ReferralService] Error scheduling trial notifications: $e',
        );
      }

      // Referrer gets bonus when referee adds first expense
      return ReferralResult(
        success: true,
        message: 'Referral bonus applied!',
        bonusDays: 7,
        referrerId: referrerId,
      );
    } catch (e) {
      debugPrint('[ReferralService] Error applying referral: $e');
      return ReferralResult(success: false, message: 'Error applying referral');
    }
  }

  /// Generate a unique referral code for a user (VANTAG-XXXXX format)
  Future<String?> generateReferralCode() async {
    final user = _auth.currentUser;
    if (user == null) return null;

    // Check if user already has a referral code
    final userDoc = await _firestore.collection('users').doc(user.uid).get();
    if (userDoc.exists && userDoc.data()?['referralCode'] != null) {
      return userDoc.data()?['referralCode'] as String?;
    }

    // Generate VANTAG-XXXXX format code (no confusing chars: 0,O,1,I,L)
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    final random = DateTime.now().millisecondsSinceEpoch;
    String code;

    // Use hash of user ID + timestamp for uniqueness
    final hash = _hashIP('${user.uid}_$random');
    code = 'VANTAG-';
    for (int i = 0; i < 5; i++) {
      final index = hash.codeUnitAt(i) % chars.length;
      code += chars[index];
    }

    try {
      // Check if code already exists (rare but possible)
      final existingCode = await _firestore
          .collection('users')
          .where('referralCode', isEqualTo: code)
          .limit(1)
          .get();

      if (existingCode.docs.isNotEmpty) {
        // Regenerate with different seed
        code = 'VANTAG-';
        final hash2 = _hashIP('${user.uid}_${random + 1}');
        for (int i = 0; i < 5; i++) {
          final index = hash2.codeUnitAt(i) % chars.length;
          code += chars[index];
        }
      }

      await _firestore.collection('users').doc(user.uid).set({
        'referralCode': code,
      }, SetOptions(merge: true));

      return code;
    } catch (e) {
      debugPrint('[ReferralService] Error generating referral code: $e');
      return null;
    }
  }

  /// Reward referrer when referee adds first expense
  Future<void> rewardReferrerOnFirstExpense(String refereeId) async {
    try {
      // Check if referee was referred by someone
      final refereeDoc = await _firestore
          .collection('users')
          .doc(refereeId)
          .get();
      if (!refereeDoc.exists) return;

      final referrerId = refereeDoc.data()?['referredBy'] as String?;
      if (referrerId == null) return;

      // Check if bonus was already granted
      final referralQuery = await _firestore
          .collection(_referralsCollection)
          .where('refereeId', isEqualTo: refereeId)
          .where('referrerBonusGranted', isEqualTo: true)
          .limit(1)
          .get();

      if (referralQuery.docs.isNotEmpty) {
        debugPrint('[ReferralService] Referrer bonus already granted');
        return;
      }

      // Grant 7-day bonus to referrer
      await _firestore.collection(_referralsCollection).doc().set({
        'referrerId': referrerId,
        'refereeId': refereeId,
        'referrerBonusGranted': true,
        'bonusDays': 7,
        'grantedAt': FieldValue.serverTimestamp(),
      }, SetOptions(merge: true));

      // Update referral document to mark bonus granted
      final referralDocs = await _firestore
          .collection(_referralsCollection)
          .where('refereeId', isEqualTo: refereeId)
          .get();

      for (final doc in referralDocs.docs) {
        await doc.reference.update({'referrerBonusGranted': true});
      }

      debugPrint(
        '[ReferralService] Referrer $referrerId rewarded for referral',
      );
    } catch (e) {
      debugPrint('[ReferralService] Error rewarding referrer: $e');
    }
  }

  /// Get user's referral code, generating one if needed
  Future<String?> getOrCreateReferralCode() async {
    final user = _auth.currentUser;
    if (user == null) return null;

    final userDoc = await _firestore.collection('users').doc(user.uid).get();
    if (userDoc.exists && userDoc.data()?['referralCode'] != null) {
      return userDoc.data()?['referralCode'] as String?;
    }

    return await generateReferralCode();
  }

  /// Get referral statistics for a user
  Future<ReferralStats> getReferralStats() async {
    final user = _auth.currentUser;
    if (user == null) {
      return ReferralStats(totalReferrals: 0, bonusDaysEarned: 0);
    }

    try {
      final referrals = await _firestore
          .collection(_referralsCollection)
          .where('referrerId', isEqualTo: user.uid)
          .get();

      return ReferralStats(
        totalReferrals: referrals.docs.length,
        bonusDaysEarned: referrals.docs.length * 7, // 7 days per referral
      );
    } catch (e) {
      debugPrint('[ReferralService] Error getting stats: $e');
      return ReferralStats(totalReferrals: 0, bonusDaysEarned: 0);
    }
  }
}

/// Result of applying a referral code
class ReferralResult {
  final bool success;
  final String message;
  final bool isAbuse;
  final int bonusDays;
  final String? referrerId;

  ReferralResult({
    required this.success,
    required this.message,
    this.isAbuse = false,
    this.bonusDays = 0,
    this.referrerId,
  });
}

/// Statistics about a user's referrals
class ReferralStats {
  final int totalReferrals;
  final int bonusDaysEarned;

  ReferralStats({required this.totalReferrals, required this.bonusDaysEarned});
}


--- FILE: lib/services/export_service.dart ---

import 'dart:io';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:excel/excel.dart';
import 'package:intl/intl.dart';
import 'package:path_provider/path_provider.dart';
import 'package:share_plus/share_plus.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';
import 'services.dart';

/// Premium Excel Export Service
/// 6 sheet'li detaylı profesyonel finansal rapor oluşturur
class ExportService {
  // Styling constants
  static const _headerColor = '#8B5CF6'; // Mor
  static const _headerTextColor = '#FFFFFF';
  static const _positiveColor = '#10B981'; // Yeşil
  static const _negativeColor = '#EF4444'; // Kırmızı
  static const _warningColor = '#F59E0B'; // Sarı
  static const _alternateRowColor = '#F8FAFC';
  static const _titleColor = '#6366F1'; // Indigo

  /// Excel dosyası oluştur ve paylaş
  Future<File?> exportToExcel(BuildContext context) async {
    final l10n = AppLocalizations.of(context);

    try {
      // Verileri topla
      final profileService = ProfileService();
      final expenseService = ExpenseHistoryService();
      final calculationService = CalculationService();

      final profile = await profileService.getProfile();
      final expenses = await expenseService.getExpenses();

      if (profile == null) {
        throw Exception('Profile not found');
      }

      // Calculate hourly rate
      final now = DateTime.now();
      final workDays = calculationService.workDaysInMonth(
        now.year,
        now.month,
        profile.workDaysPerWeek,
      );
      final totalWorkHoursPerMonth = workDays * profile.dailyHours;
      final hourlyRate = totalWorkHoursPerMonth > 0
          ? profile.monthlyIncome / totalWorkHoursPerMonth
          : profile.monthlyIncome / 160;

      // Sadece gerçek harcamalar (simülasyonları hariç tut)
      final realExpenses = expenses.where((e) => !e.isSimulation).toList();

      // Excel oluştur
      final excel = Excel.createExcel();

      // 6 Sheet oluştur
      _createExpensesSheet(excel, l10n, realExpenses, hourlyRate);
      _createSummarySheet(excel, l10n, profile, realExpenses, hourlyRate);
      _createCategoriesSheet(excel, l10n, realExpenses, hourlyRate);
      _createTimeAnalysisSheet(excel, l10n, realExpenses);
      _createDecisionsSheet(excel, l10n, realExpenses, hourlyRate);
      _createInstallmentsSheet(excel, l10n, realExpenses, hourlyRate);

      // Varsayılan Sheet1'i sil
      excel.delete('Sheet1');

      // Dosyayı kaydet
      final bytes = excel.save();
      if (bytes == null) throw Exception('Failed to generate Excel');

      final tempDir = await getTemporaryDirectory();
      final dateStr = DateFormat('yyyy-MM-dd_HH-mm').format(DateTime.now());
      final fileName = 'Vantag_Rapor_$dateStr.xlsx';
      final file = File('${tempDir.path}/$fileName');
      await file.writeAsBytes(bytes);

      return file;
    } catch (e) {
      debugPrint('[ExportService] Error: $e');
      rethrow;
    }
  }

  /// Dosyayı paylaş
  Future<void> shareFile(File file) async {
    await Share.shareXFiles([
      XFile(file.path),
    ], subject: 'Vantag Finansal Rapor');
  }

  /// Alias for backwards compatibility
  Future<void> shareExcel(File file) => shareFile(file);

  /// Platform channel for saving to Downloads
  static const _fileSaverChannel = MethodChannel('com.vantag.app/file_saver');

  /// Downloads klasörüne kaydet (MediaStore API ile Android 10+ uyumlu)
  Future<({File? file, String? path, String? error})> saveToDownloads(
    File sourceFile,
  ) async {
    debugPrint('[ExportService] ═══════════════════════════════════════');
    debugPrint('[ExportService] Starting saveToDownloads with MediaStore...');
    debugPrint('[ExportService] Source file: ${sourceFile.path}');

    try {
      // Step 1: Verify source file exists
      final sourceExists = await sourceFile.exists();
      debugPrint('[ExportService] Step 1 - Source file exists: $sourceExists');
      if (!sourceExists) {
        return (file: null, path: null, error: 'Source file does not exist');
      }

      // Step 2: Get source file size
      final sourceSize = await sourceFile.length();
      debugPrint(
        '[ExportService] Step 2 - Source file size: $sourceSize bytes',
      );
      if (sourceSize == 0) {
        return (file: null, path: null, error: 'Source file is empty');
      }

      // Step 3: Extract file name and determine MIME type
      final fileName = sourceFile.path.split('/').last;
      debugPrint('[ExportService] Step 3 - File name: $fileName');

      String mimeType = 'application/octet-stream';
      if (fileName.endsWith('.xlsx')) {
        mimeType =
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
      } else if (fileName.endsWith('.csv')) {
        mimeType = 'text/csv';
      }

      // Step 4: Save using platform channel (MediaStore API)
      debugPrint('[ExportService] Step 4 - Calling platform channel...');
      final savedPath = await _fileSaverChannel
          .invokeMethod<String>('saveToDownloads', {
            'sourcePath': sourceFile.path,
            'fileName': fileName,
            'mimeType': mimeType,
            'subFolder': 'Vantag',
          });

      if (savedPath != null) {
        debugPrint('[ExportService] ✅ SUCCESS - Saved to: $savedPath');
        debugPrint('[ExportService] ═══════════════════════════════════════');
        return (file: sourceFile, path: savedPath, error: null);
      } else {
        return (file: null, path: null, error: 'MediaStore save returned null');
      }
    } on PlatformException catch (e) {
      debugPrint('[ExportService] ❌ Platform ERROR: ${e.message}');
      debugPrint('[ExportService] Details: ${e.details}');
      debugPrint('[ExportService] ═══════════════════════════════════════');
      return (file: null, path: null, error: e.message ?? 'Platform error');
    } catch (e, stack) {
      debugPrint('[ExportService] ❌ ERROR: $e');
      debugPrint('[ExportService] Stack: $stack');
      debugPrint('[ExportService] ═══════════════════════════════════════');
      return (file: null, path: null, error: e.toString());
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // SHEET 1: EXPENSES (Harcama Listesi)
  // ═══════════════════════════════════════════════════════════════════════════
  void _createExpensesSheet(
    Excel excel,
    AppLocalizations l10n,
    List<Expense> expenses,
    double hourlyRate,
  ) {
    final sheet = excel[l10n.excelSheetExpenses];

    // Header row
    final headers = [
      l10n.csvHeaderDate, // Tarih
      l10n.excelHeaderDay, // Gün
      l10n.csvHeaderTime, // Saat
      l10n.csvHeaderAmount, // Tutar
      l10n.csvHeaderCurrency, // Para Birimi
      l10n.csvHeaderCategory, // Kategori
      l10n.csvHeaderSubcategory, // Alt Kategori
      l10n.excelHeaderStore, // Mağaza/Yer
      l10n.csvHeaderProduct, // Ürün/Açıklama
      l10n.csvHeaderDecision, // Karar
      l10n.excelHeaderHoursEquiv, // Saat Karşılığı
      l10n.excelHeaderMinutes, // Dakika Karşılığı
      l10n.excelHeaderInstallmentCount, // Taksit
      l10n.excelHeaderMonthlyInstallment, // Aylık Taksit
      l10n.csvHeaderMandatory, // Zorunlu
      l10n.excelHeaderSimulation, // Simülasyon
    ];

    for (var i = 0; i < headers.length; i++) {
      _setCell(
        sheet,
        '${_columnLetter(i)}1',
        headers[i],
        isBold: true,
        bgColor: _headerColor,
        textColor: _headerTextColor,
      );
    }

    // Sort expenses by date (newest first)
    final sortedExpenses = List<Expense>.from(expenses)
      ..sort((a, b) => b.date.compareTo(a.date));

    // Data rows
    for (var i = 0; i < sortedExpenses.length; i++) {
      final expense = sortedExpenses[i];
      final row = i + 2;
      final isAlternate = i % 2 == 1;

      // Tarih
      _setCell(
        sheet,
        'A$row',
        DateFormat('dd/MM/yyyy').format(expense.date),
        bgColor: isAlternate ? _alternateRowColor : null,
      );

      // Gün (lokalize)
      _setCell(
        sheet,
        'B$row',
        _getLocalizedDayName(l10n, expense.date.weekday),
        bgColor: isAlternate ? _alternateRowColor : null,
      );

      // Saat
      _setCell(
        sheet,
        'C$row',
        DateFormat('HH:mm').format(expense.date),
        bgColor: isAlternate ? _alternateRowColor : null,
      );

      // Tutar
      _setCell(
        sheet,
        'D$row',
        _formatCurrency(expense.amount),
        bgColor: isAlternate ? _alternateRowColor : null,
      );

      // Para Birimi
      _setCell(
        sheet,
        'E$row',
        expense.originalCurrency ?? 'TRY',
        bgColor: isAlternate ? _alternateRowColor : null,
      );

      // Kategori (lokalize)
      _setCell(
        sheet,
        'F$row',
        ExpenseCategory.getLocalizedName(expense.category, l10n),
        bgColor: isAlternate ? _alternateRowColor : null,
      );

      // Alt Kategori
      _setCell(
        sheet,
        'G$row',
        expense.subCategory ?? '-',
        bgColor: isAlternate ? _alternateRowColor : null,
      );

      // Mağaza/Yer - subCategory'den çıkar veya boş bırak
      _setCell(
        sheet,
        'H$row',
        expense.subCategory ?? '-',
        bgColor: isAlternate ? _alternateRowColor : null,
      );

      // Ürün/Açıklama
      _setCell(
        sheet,
        'I$row',
        expense.subCategory ?? expense.category,
        bgColor: isAlternate ? _alternateRowColor : null,
      );

      // Karar (renkli)
      String? decisionBgColor;
      String decisionText = '-';
      if (expense.decision == ExpenseDecision.yes) {
        decisionBgColor = _positiveColor;
        decisionText = l10n.excelDecisionsBought;
      } else if (expense.decision == ExpenseDecision.thinking) {
        decisionBgColor = _warningColor;
        decisionText = l10n.excelDecisionsThinking;
      } else if (expense.decision == ExpenseDecision.no) {
        decisionBgColor = _negativeColor;
        decisionText = l10n.excelDecisionsPassed;
      }
      _setCell(
        sheet,
        'J$row',
        decisionText,
        bgColor: decisionBgColor,
        textColor: decisionBgColor != null ? '#FFFFFF' : null,
      );

      // Saat Karşılığı
      _setCell(
        sheet,
        'K$row',
        '${expense.hoursRequired.toStringAsFixed(1)} h',
        bgColor: isAlternate ? _alternateRowColor : null,
      );

      // Dakika Karşılığı
      final minutes = (expense.hoursRequired * 60).round();
      _setCell(
        sheet,
        'L$row',
        '$minutes dk',
        bgColor: isAlternate ? _alternateRowColor : null,
      );

      // Taksit
      final installmentText = expense.installmentCount != null
          ? '${expense.currentInstallment ?? 1}/${expense.installmentCount}'
          : '-';
      _setCell(
        sheet,
        'M$row',
        installmentText,
        bgColor: isAlternate ? _alternateRowColor : null,
      );

      // Aylık Taksit
      final monthlyPayment =
          expense.installmentCount != null && expense.installmentCount! > 0
          ? expense.amount / expense.installmentCount!
          : 0.0;
      _setCell(
        sheet,
        'N$row',
        expense.installmentCount != null
            ? _formatCurrency(monthlyPayment)
            : '-',
        bgColor: isAlternate ? _alternateRowColor : null,
      );

      // Zorunlu
      _setCell(
        sheet,
        'O$row',
        expense.isMandatory ? l10n.excelYes : l10n.excelNo,
        bgColor: isAlternate ? _alternateRowColor : null,
      );

      // Simülasyon
      _setCell(
        sheet,
        'P$row',
        expense.isSimulation ? l10n.excelSimulation : l10n.excelReal,
        bgColor: isAlternate ? _alternateRowColor : null,
      );
    }

    // Column widths
    sheet.setColumnWidth(0, 12); // Tarih
    sheet.setColumnWidth(1, 12); // Gün
    sheet.setColumnWidth(2, 8); // Saat
    sheet.setColumnWidth(3, 15); // Tutar
    sheet.setColumnWidth(4, 10); // Para Birimi
    sheet.setColumnWidth(5, 14); // Kategori
    sheet.setColumnWidth(6, 18); // Alt Kategori
    sheet.setColumnWidth(7, 18); // Mağaza
    sheet.setColumnWidth(8, 20); // Ürün
    sheet.setColumnWidth(9, 14); // Karar
    sheet.setColumnWidth(10, 12); // Saat
    sheet.setColumnWidth(11, 12); // Dakika
    sheet.setColumnWidth(12, 10); // Taksit
    sheet.setColumnWidth(13, 14); // Aylık Taksit
    sheet.setColumnWidth(14, 10); // Zorunlu
    sheet.setColumnWidth(15, 12); // Simülasyon
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // SHEET 2: SUMMARY (Özet)
  // ═══════════════════════════════════════════════════════════════════════════
  void _createSummarySheet(
    Excel excel,
    AppLocalizations l10n,
    UserProfile profile,
    List<Expense> expenses,
    double hourlyRate,
  ) {
    final sheet = excel[l10n.excelSheetSummary];

    // Title
    _setMergedCell(sheet, 'A1', 'VANTAG', 4);
    _setCell(sheet, 'A3', l10n.excelReportTitle, isBold: true, fontSize: 16);
    _setCell(
      sheet,
      'A4',
      '${l10n.excelReportGeneratedAt}: ${DateFormat('dd.MM.yyyy HH:mm').format(DateTime.now())}',
    );

    // Calculate period
    DateTime? firstDate;
    DateTime? lastDate;
    if (expenses.isNotEmpty) {
      firstDate = expenses
          .map((e) => e.date)
          .reduce((a, b) => a.isBefore(b) ? a : b);
      lastDate = expenses
          .map((e) => e.date)
          .reduce((a, b) => a.isAfter(b) ? a : b);
    }

    if (firstDate != null && lastDate != null) {
      final periodStart = DateFormat('dd.MM.yyyy').format(firstDate);
      final periodEnd = DateFormat('dd.MM.yyyy').format(lastDate);
      _setCell(
        sheet,
        'A5',
        '${l10n.excelReportPeriod}: $periodStart - $periodEnd',
      );
    }

    // Calculations
    final yesExpenses = expenses
        .where((e) => e.decision == ExpenseDecision.yes)
        .toList();
    final noExpenses = expenses
        .where((e) => e.decision == ExpenseDecision.no)
        .toList();

    final totalSpent = yesExpenses.fold<double>(0, (sum, e) => sum + e.amount);
    final totalSaved = noExpenses.fold<double>(0, (sum, e) => sum + e.amount);
    final totalIncome = profile.monthlyIncome;
    final savingsRate = totalIncome > 0 ? (totalSaved / totalIncome * 100) : 0;
    final totalWorkHours = hourlyRate > 0 ? totalSpent / hourlyRate : 0.0;
    final totalWorkDays = totalWorkHours / profile.dailyHours;

    // Summary cards
    int row = 7;

    _setCell(sheet, 'A$row', l10n.totalIncome, isBold: true);
    _setCell(sheet, 'B$row', _formatCurrency(totalIncome));
    row++;

    _setCell(sheet, 'A$row', l10n.excelTotalExpenses, isBold: true);
    _setCell(
      sheet,
      'B$row',
      _formatCurrency(totalSpent),
      bgColor: _negativeColor,
      textColor: '#FFFFFF',
    );
    row++;

    _setCell(sheet, 'A$row', l10n.totalSaved, isBold: true);
    _setCell(
      sheet,
      'B$row',
      _formatCurrency(totalSaved),
      bgColor: _positiveColor,
      textColor: '#FFFFFF',
    );
    row++;

    _setCell(sheet, 'A$row', l10n.excelSavingsRate, isBold: true);
    _setCell(sheet, 'B$row', '${savingsRate.toStringAsFixed(1)}%');
    row++;

    row++; // Empty row

    _setCell(sheet, 'A$row', l10n.excelTotalTransactions, isBold: true);
    _setCell(sheet, 'B$row', expenses.length.toString());
    row++;

    if (yesExpenses.isNotEmpty) {
      final avgPerTransaction = totalSpent / yesExpenses.length;
      _setCell(sheet, 'A$row', l10n.excelAvgPerTransaction, isBold: true);
      _setCell(sheet, 'B$row', _formatCurrency(avgPerTransaction));
      row++;
    }

    // Time-based averages
    if (firstDate != null && lastDate != null) {
      final daysDiff = lastDate.difference(firstDate).inDays + 1;

      if (daysDiff > 0) {
        final dailyAvg = totalSpent / daysDiff;
        _setCell(sheet, 'A$row', l10n.excelDailyAverage, isBold: true);
        _setCell(sheet, 'B$row', _formatCurrency(dailyAvg));
        row++;
      }

      if (daysDiff >= 7) {
        final weeklyAvg = totalSpent / (daysDiff / 7);
        _setCell(sheet, 'A$row', l10n.excelWeeklyAverage, isBold: true);
        _setCell(sheet, 'B$row', _formatCurrency(weeklyAvg));
        row++;
      }

      if (daysDiff >= 30) {
        final monthlyAvg = totalSpent / (daysDiff / 30);
        _setCell(sheet, 'A$row', l10n.excelMonthlyAverage, isBold: true);
        _setCell(sheet, 'B$row', _formatCurrency(monthlyAvg));
        row++;
      }
    }

    row++; // Empty row

    _setCell(sheet, 'A$row', l10n.hourlyRate, isBold: true);
    _setCell(sheet, 'B$row', _formatCurrency(hourlyRate));
    row++;

    _setCell(sheet, 'A$row', l10n.excelTotalWorkHours, isBold: true);
    _setCell(
      sheet,
      'B$row',
      '${totalWorkHours.toStringAsFixed(1)} ${l10n.hours}',
    );
    row++;

    _setCell(sheet, 'A$row', l10n.excelTotalWorkDays, isBold: true);
    _setCell(
      sheet,
      'B$row',
      '${totalWorkDays.toStringAsFixed(1)} ${l10n.days}',
    );

    // Column widths
    sheet.setColumnWidth(0, 28);
    sheet.setColumnWidth(1, 22);
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // SHEET 3: CATEGORIES (Kategori Analizi)
  // ═══════════════════════════════════════════════════════════════════════════
  void _createCategoriesSheet(
    Excel excel,
    AppLocalizations l10n,
    List<Expense> expenses,
    double hourlyRate,
  ) {
    final sheet = excel[l10n.excelSheetCategories];

    // Header
    final headers = [
      l10n.excelCategoryRank,
      l10n.category,
      l10n.excelCategoryTotal,
      l10n.excelCategoryCount,
      l10n.excelCategoryAvg,
      l10n.excelCategoryShare,
      l10n.excelCategoryHours,
    ];

    for (var i = 0; i < headers.length; i++) {
      _setCell(
        sheet,
        '${_columnLetter(i)}1',
        headers[i],
        isBold: true,
        bgColor: _headerColor,
        textColor: _headerTextColor,
      );
    }

    // Only "bought" expenses
    final yesExpenses = expenses
        .where((e) => e.decision == ExpenseDecision.yes)
        .toList();
    final totalSpent = yesExpenses.fold<double>(0, (sum, e) => sum + e.amount);

    // Group by category
    final categoryMap = <String, List<Expense>>{};
    for (final expense in yesExpenses) {
      categoryMap.putIfAbsent(expense.category, () => []).add(expense);
    }

    // Sort by total amount (highest first)
    final sortedCategories = categoryMap.entries.toList()
      ..sort((a, b) {
        final totalA = a.value.fold<double>(0, (sum, e) => sum + e.amount);
        final totalB = b.value.fold<double>(0, (sum, e) => sum + e.amount);
        return totalB.compareTo(totalA);
      });

    // Data rows
    for (var i = 0; i < sortedCategories.length; i++) {
      final entry = sortedCategories[i];
      final category = entry.key;
      final categoryExpenses = entry.value;
      final row = i + 2;
      final isAlternate = i % 2 == 1;
      final isTop = i == 0;

      final catTotal = categoryExpenses.fold<double>(
        0,
        (sum, e) => sum + e.amount,
      );
      final catCount = categoryExpenses.length;
      final catAverage = catCount > 0 ? catTotal / catCount : 0.0;
      final catPercentage = totalSpent > 0 ? (catTotal / totalSpent * 100) : 0;
      final catHours = hourlyRate > 0 ? catTotal / hourlyRate : 0.0;

      // Sıra
      _setCell(
        sheet,
        'A$row',
        '#${i + 1}',
        isBold: isTop,
        bgColor: isTop
            ? _warningColor
            : (isAlternate ? _alternateRowColor : null),
      );

      // Kategori
      _setCell(
        sheet,
        'B$row',
        ExpenseCategory.getLocalizedName(category, l10n),
        isBold: isTop,
        bgColor: isTop
            ? _warningColor
            : (isAlternate ? _alternateRowColor : null),
      );

      // Toplam
      _setCell(
        sheet,
        'C$row',
        _formatCurrency(catTotal),
        bgColor: isAlternate && !isTop ? _alternateRowColor : null,
      );

      // Adet
      _setCell(
        sheet,
        'D$row',
        catCount.toString(),
        bgColor: isAlternate && !isTop ? _alternateRowColor : null,
      );

      // Ortalama
      _setCell(
        sheet,
        'E$row',
        _formatCurrency(catAverage),
        bgColor: isAlternate && !isTop ? _alternateRowColor : null,
      );

      // Pay %
      _setCell(
        sheet,
        'F$row',
        '${catPercentage.toStringAsFixed(1)}%',
        bgColor: isAlternate && !isTop ? _alternateRowColor : null,
      );

      // Çalışma Saati
      _setCell(
        sheet,
        'G$row',
        '${catHours.toStringAsFixed(1)}h',
        bgColor: isAlternate && !isTop ? _alternateRowColor : null,
      );
    }

    // Total row
    final totalRow = sortedCategories.length + 3;
    _setCell(sheet, 'A$totalRow', l10n.total, isBold: true);
    _setCell(sheet, 'C$totalRow', _formatCurrency(totalSpent), isBold: true);
    _setCell(sheet, 'D$totalRow', yesExpenses.length.toString(), isBold: true);
    _setCell(sheet, 'F$totalRow', '100%', isBold: true);
    _setCell(
      sheet,
      'G$totalRow',
      '${(hourlyRate > 0 ? totalSpent / hourlyRate : 0).toStringAsFixed(1)}h',
      isBold: true,
    );

    // Column widths
    sheet.setColumnWidth(0, 8); // Sıra
    sheet.setColumnWidth(1, 18); // Kategori
    sheet.setColumnWidth(2, 18); // Toplam
    sheet.setColumnWidth(3, 12); // Adet
    sheet.setColumnWidth(4, 16); // Ortalama
    sheet.setColumnWidth(5, 12); // Pay %
    sheet.setColumnWidth(6, 14); // Çalışma Saati
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // SHEET 4: TIME ANALYSIS (Zaman Analizi)
  // ═══════════════════════════════════════════════════════════════════════════
  void _createTimeAnalysisSheet(
    Excel excel,
    AppLocalizations l10n,
    List<Expense> expenses,
  ) {
    final sheet = excel[l10n.excelSheetTimeAnalysis];

    // Title
    _setCell(sheet, 'A1', l10n.excelTimeTitle, isBold: true, fontSize: 14);

    // Only "bought" expenses
    final yesExpenses = expenses
        .where((e) => e.decision == ExpenseDecision.yes)
        .toList();

    if (yesExpenses.isEmpty) {
      _setCell(sheet, 'A3', '-');
      return;
    }

    int row = 3;

    // ═══════════════════════════════════════════════════════════════════════
    // BÖLÜM 1: Genel İstatistikler
    // ═══════════════════════════════════════════════════════════════════════

    // By day of week
    final dayTotals = <int, double>{1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0};
    final dayCounts = <int, int>{1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0};

    // By hour
    final hourTotals = <int, double>{};
    for (var h = 0; h < 24; h++) {
      hourTotals[h] = 0;
    }

    // By time of day
    double morningTotal = 0,
        afternoonTotal = 0,
        eveningTotal = 0,
        nightTotal = 0;

    for (final expense in yesExpenses) {
      final weekday = expense.date.weekday;
      final hour = expense.date.hour;

      dayTotals[weekday] = (dayTotals[weekday] ?? 0) + expense.amount;
      dayCounts[weekday] = (dayCounts[weekday] ?? 0) + 1;
      hourTotals[hour] = (hourTotals[hour] ?? 0) + expense.amount;

      if (hour >= 6 && hour < 12) {
        morningTotal += expense.amount;
      } else if (hour >= 12 && hour < 18) {
        afternoonTotal += expense.amount;
      } else if (hour >= 18 && hour < 24) {
        eveningTotal += expense.amount;
      } else {
        nightTotal += expense.amount;
      }
    }

    // Most active day
    final mostActiveDay = dayTotals.entries.reduce(
      (a, b) => a.value > b.value ? a : b,
    );
    _setCell(sheet, 'A$row', l10n.excelMostActiveDay, isBold: true);
    _setCell(sheet, 'B$row', _getLocalizedDayName(l10n, mostActiveDay.key));
    _setCell(sheet, 'C$row', _formatCurrency(mostActiveDay.value));
    row++;

    // Most active hour
    final mostActiveHour = hourTotals.entries.reduce(
      (a, b) => a.value > b.value ? a : b,
    );
    _setCell(sheet, 'A$row', l10n.excelMostActiveHour, isBold: true);
    _setCell(
      sheet,
      'B$row',
      '${mostActiveHour.key.toString().padLeft(2, '0')}:00',
    );
    _setCell(sheet, 'C$row', _formatCurrency(mostActiveHour.value));
    row++;

    // Weekday vs Weekend average
    final weekdayTotal =
        dayTotals[1]! +
        dayTotals[2]! +
        dayTotals[3]! +
        dayTotals[4]! +
        dayTotals[5]!;
    final weekendTotal = dayTotals[6]! + dayTotals[7]!;
    final weekdayCount =
        dayCounts[1]! +
        dayCounts[2]! +
        dayCounts[3]! +
        dayCounts[4]! +
        dayCounts[5]!;
    final weekendCount = dayCounts[6]! + dayCounts[7]!;

    row++;
    _setCell(sheet, 'A$row', l10n.excelWeekdayAvg, isBold: true);
    _setCell(
      sheet,
      'B$row',
      weekdayCount > 0 ? _formatCurrency(weekdayTotal / weekdayCount) : '-',
    );
    row++;

    _setCell(sheet, 'A$row', l10n.excelWeekendAvg, isBold: true);
    _setCell(
      sheet,
      'B$row',
      weekendCount > 0 ? _formatCurrency(weekendTotal / weekendCount) : '-',
    );
    row++;

    // ═══════════════════════════════════════════════════════════════════════
    // BÖLÜM 2: Günün Saatlerine Göre
    // ═══════════════════════════════════════════════════════════════════════
    row += 2;
    _setCell(sheet, 'A$row', l10n.excelByHour, isBold: true, fontSize: 12);
    row++;

    _setCell(sheet, 'A$row', l10n.excelMorningSpend, isBold: true);
    _setCell(sheet, 'B$row', _formatCurrency(morningTotal));
    row++;

    _setCell(sheet, 'A$row', l10n.excelAfternoonSpend, isBold: true);
    _setCell(sheet, 'B$row', _formatCurrency(afternoonTotal));
    row++;

    _setCell(sheet, 'A$row', l10n.excelEveningSpend, isBold: true);
    _setCell(sheet, 'B$row', _formatCurrency(eveningTotal));
    row++;

    _setCell(sheet, 'A$row', l10n.excelNightSpend, isBold: true);
    _setCell(sheet, 'B$row', _formatCurrency(nightTotal));
    row++;

    // ═══════════════════════════════════════════════════════════════════════
    // BÖLÜM 3: Haftanın Günlerine Göre
    // ═══════════════════════════════════════════════════════════════════════
    row += 2;
    _setCell(sheet, 'A$row', l10n.excelByDayOfWeek, isBold: true, fontSize: 12);
    row++;

    final dayNames = [
      l10n.excelDayMonday,
      l10n.excelDayTuesday,
      l10n.excelDayWednesday,
      l10n.excelDayThursday,
      l10n.excelDayFriday,
      l10n.excelDaySaturday,
      l10n.excelDaySunday,
    ];

    for (var i = 1; i <= 7; i++) {
      final isAlternate = i % 2 == 0;
      _setCell(
        sheet,
        'A$row',
        dayNames[i - 1],
        bgColor: isAlternate ? _alternateRowColor : null,
      );
      _setCell(
        sheet,
        'B$row',
        _formatCurrency(dayTotals[i] ?? 0),
        bgColor: isAlternate ? _alternateRowColor : null,
      );
      _setCell(
        sheet,
        'C$row',
        '${dayCounts[i] ?? 0} ${l10n.excelDecisionCount.toLowerCase()}',
        bgColor: isAlternate ? _alternateRowColor : null,
      );
      row++;
    }

    // Column widths
    sheet.setColumnWidth(0, 24);
    sheet.setColumnWidth(1, 18);
    sheet.setColumnWidth(2, 14);
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // SHEET 5: DECISIONS (Kararlar Analizi)
  // ═══════════════════════════════════════════════════════════════════════════
  void _createDecisionsSheet(
    Excel excel,
    AppLocalizations l10n,
    List<Expense> expenses,
    double hourlyRate,
  ) {
    final sheet = excel[l10n.excelSheetDecisions];

    // Header
    final headers = [
      l10n.csvHeaderDecision,
      l10n.excelDecisionCount,
      l10n.excelDecisionAmount,
      l10n.excelDecisionPercent,
      l10n.excelDecisionAvg,
      l10n.excelDecisionHours,
    ];

    for (var i = 0; i < headers.length; i++) {
      _setCell(
        sheet,
        '${_columnLetter(i)}1',
        headers[i],
        isBold: true,
        bgColor: _headerColor,
        textColor: _headerTextColor,
      );
    }

    // Calculate stats
    final yesExpenses = expenses
        .where((e) => e.decision == ExpenseDecision.yes)
        .toList();
    final thinkingExpenses = expenses
        .where((e) => e.decision == ExpenseDecision.thinking)
        .toList();
    final noExpenses = expenses
        .where((e) => e.decision == ExpenseDecision.no)
        .toList();

    final yesTotal = yesExpenses.fold<double>(0, (sum, e) => sum + e.amount);
    final thinkingTotal = thinkingExpenses.fold<double>(
      0,
      (sum, e) => sum + e.amount,
    );
    final noTotal = noExpenses.fold<double>(0, (sum, e) => sum + e.amount);
    final grandTotal = yesTotal + thinkingTotal + noTotal;

    // Row 2: Bought
    _setCell(
      sheet,
      'A2',
      l10n.excelDecisionsBought,
      isBold: true,
      bgColor: _positiveColor,
      textColor: '#FFFFFF',
    );
    _setCell(sheet, 'B2', yesExpenses.length.toString());
    _setCell(sheet, 'C2', _formatCurrency(yesTotal));
    _setCell(
      sheet,
      'D2',
      '${grandTotal > 0 ? (yesTotal / grandTotal * 100).toStringAsFixed(1) : 0}%',
    );
    _setCell(
      sheet,
      'E2',
      yesExpenses.isNotEmpty
          ? _formatCurrency(yesTotal / yesExpenses.length)
          : '-',
    );
    _setCell(
      sheet,
      'F2',
      '${(hourlyRate > 0 ? yesTotal / hourlyRate : 0).toStringAsFixed(1)}h',
    );

    // Row 3: Thinking
    _setCell(
      sheet,
      'A3',
      l10n.excelDecisionsThinking,
      isBold: true,
      bgColor: _warningColor,
      textColor: '#FFFFFF',
    );
    _setCell(sheet, 'B3', thinkingExpenses.length.toString());
    _setCell(sheet, 'C3', _formatCurrency(thinkingTotal));
    _setCell(
      sheet,
      'D3',
      '${grandTotal > 0 ? (thinkingTotal / grandTotal * 100).toStringAsFixed(1) : 0}%',
    );
    _setCell(
      sheet,
      'E3',
      thinkingExpenses.isNotEmpty
          ? _formatCurrency(thinkingTotal / thinkingExpenses.length)
          : '-',
    );
    _setCell(
      sheet,
      'F3',
      '${(hourlyRate > 0 ? thinkingTotal / hourlyRate : 0).toStringAsFixed(1)}h',
    );

    // Row 4: Passed
    _setCell(
      sheet,
      'A4',
      l10n.excelDecisionsPassed,
      isBold: true,
      bgColor: _negativeColor,
      textColor: '#FFFFFF',
    );
    _setCell(sheet, 'B4', noExpenses.length.toString());
    _setCell(sheet, 'C4', _formatCurrency(noTotal));
    _setCell(
      sheet,
      'D4',
      '${grandTotal > 0 ? (noTotal / grandTotal * 100).toStringAsFixed(1) : 0}%',
    );
    _setCell(
      sheet,
      'E4',
      noExpenses.isNotEmpty
          ? _formatCurrency(noTotal / noExpenses.length)
          : '-',
    );
    _setCell(
      sheet,
      'F4',
      '${(hourlyRate > 0 ? noTotal / hourlyRate : 0).toStringAsFixed(1)}h',
    );

    // Total row
    _setCell(sheet, 'A6', l10n.total, isBold: true);
    _setCell(sheet, 'B6', expenses.length.toString(), isBold: true);
    _setCell(sheet, 'C6', _formatCurrency(grandTotal), isBold: true);
    _setCell(sheet, 'D6', '100%', isBold: true);

    // Additional insights
    int row = 8;
    _setCell(
      sheet,
      'A$row',
      l10n.excelSavingsFromPassed,
      isBold: true,
      fontSize: 12,
    );
    row++;
    _setCell(sheet, 'A$row', l10n.totalSaved);
    _setCell(
      sheet,
      'B$row',
      _formatCurrency(noTotal),
      bgColor: _positiveColor,
      textColor: '#FFFFFF',
    );
    row++;

    _setCell(sheet, 'A$row', l10n.excelTotalWorkHours);
    _setCell(
      sheet,
      'B$row',
      '${(hourlyRate > 0 ? noTotal / hourlyRate : 0).toStringAsFixed(1)} ${l10n.hours}',
    );
    row++;

    row++;
    _setCell(
      sheet,
      'A$row',
      l10n.excelPotentialSavings,
      isBold: true,
      fontSize: 12,
    );
    row++;
    _setCell(sheet, 'A$row', l10n.excelDecisionAmount);
    _setCell(
      sheet,
      'B$row',
      _formatCurrency(thinkingTotal),
      bgColor: _warningColor,
      textColor: '#FFFFFF',
    );

    // Column widths
    sheet.setColumnWidth(0, 20);
    sheet.setColumnWidth(1, 12);
    sheet.setColumnWidth(2, 18);
    sheet.setColumnWidth(3, 12);
    sheet.setColumnWidth(4, 16);
    sheet.setColumnWidth(5, 14);
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // SHEET 6: INSTALLMENTS (Taksitler)
  // ═══════════════════════════════════════════════════════════════════════════
  void _createInstallmentsSheet(
    Excel excel,
    AppLocalizations l10n,
    List<Expense> expenses,
    double hourlyRate,
  ) {
    final sheet = excel[l10n.excelSheetInstallments];

    // Header
    final headers = [
      l10n.excelInstallmentName,
      l10n.csvHeaderCategory,
      l10n.excelInstallmentTotal,
      l10n.excelInstallmentMonthly,
      l10n.excelInstallmentProgress,
      l10n.excelInstallmentRemaining,
      l10n.excelInstallmentStartDate,
      l10n.excelInstallmentInterest,
    ];

    for (var i = 0; i < headers.length; i++) {
      _setCell(
        sheet,
        '${_columnLetter(i)}1',
        headers[i],
        isBold: true,
        bgColor: _headerColor,
        textColor: _headerTextColor,
      );
    }

    // Filter installment expenses
    final installmentExpenses = expenses
        .where((e) => e.installmentCount != null && e.installmentCount! > 1)
        .toList();

    if (installmentExpenses.isEmpty) {
      _setCell(sheet, 'A3', l10n.excelNoInstallments, fontSize: 12);
      sheet.setColumnWidth(0, 30);
      return;
    }

    // Sort by remaining amount (highest first)
    installmentExpenses.sort((a, b) {
      final remainingA =
          (a.installmentCount! - (a.currentInstallment ?? 1)) *
          a.installmentAmount;
      final remainingB =
          (b.installmentCount! - (b.currentInstallment ?? 1)) *
          b.installmentAmount;
      return remainingB.compareTo(remainingA);
    });

    double totalMonthlyPayments = 0;
    double totalRemaining = 0;

    // Data rows
    for (var i = 0; i < installmentExpenses.length; i++) {
      final expense = installmentExpenses[i];
      final row = i + 2;
      final isAlternate = i % 2 == 1;

      final monthlyPayment = expense.installmentAmount;
      final current = expense.currentInstallment ?? 1;
      final total = expense.installmentCount!;
      final remaining = (total - current) * monthlyPayment;
      final progress = current / total * 100;

      totalMonthlyPayments += monthlyPayment;
      totalRemaining += remaining;

      // Açıklama
      _setCell(
        sheet,
        'A$row',
        expense.subCategory ?? expense.category,
        bgColor: isAlternate ? _alternateRowColor : null,
      );

      // Kategori
      _setCell(
        sheet,
        'B$row',
        ExpenseCategory.getLocalizedName(expense.category, l10n),
        bgColor: isAlternate ? _alternateRowColor : null,
      );

      // Toplam Tutar
      _setCell(
        sheet,
        'C$row',
        _formatCurrency(expense.installmentTotal ?? expense.amount),
        bgColor: isAlternate ? _alternateRowColor : null,
      );

      // Aylık Ödeme
      _setCell(
        sheet,
        'D$row',
        _formatCurrency(monthlyPayment),
        bgColor: isAlternate ? _alternateRowColor : null,
      );

      // İlerleme
      _setCell(
        sheet,
        'E$row',
        '$current/$total (${progress.toStringAsFixed(0)}%)',
        bgColor: progress >= 80
            ? _positiveColor
            : (isAlternate ? _alternateRowColor : null),
        textColor: progress >= 80 ? '#FFFFFF' : null,
      );

      // Kalan
      _setCell(
        sheet,
        'F$row',
        _formatCurrency(remaining),
        bgColor: isAlternate ? _alternateRowColor : null,
      );

      // Başlangıç Tarihi
      _setCell(
        sheet,
        'G$row',
        DateFormat(
          'dd.MM.yyyy',
        ).format(expense.installmentStartDate ?? expense.date),
        bgColor: isAlternate ? _alternateRowColor : null,
      );

      // Vade Farkı
      final interest = expense.interestAmount;
      _setCell(
        sheet,
        'H$row',
        interest > 0 ? _formatCurrency(interest) : '-',
        bgColor: interest > 0
            ? _warningColor
            : (isAlternate ? _alternateRowColor : null),
        textColor: interest > 0 ? '#FFFFFF' : null,
      );
    }

    // Summary rows
    final summaryRow = installmentExpenses.length + 4;
    _setCell(
      sheet,
      'A$summaryRow',
      l10n.excelTotalMonthlyPayments,
      isBold: true,
    );
    _setCell(
      sheet,
      'D$summaryRow',
      _formatCurrency(totalMonthlyPayments),
      isBold: true,
      bgColor: _warningColor,
      textColor: '#FFFFFF',
    );

    final debtRow = summaryRow + 1;
    _setCell(sheet, 'A$debtRow', l10n.excelTotalRemainingDebt, isBold: true);
    _setCell(
      sheet,
      'F$debtRow',
      _formatCurrency(totalRemaining),
      isBold: true,
      bgColor: _negativeColor,
      textColor: '#FFFFFF',
    );

    // Work hours equivalent
    final hoursRow = debtRow + 1;
    _setCell(sheet, 'A$hoursRow', l10n.workHoursEquivalent, isBold: true);
    _setCell(
      sheet,
      'D$hoursRow',
      '${(hourlyRate > 0 ? totalMonthlyPayments / hourlyRate : 0).toStringAsFixed(1)}h/${l10n.monthly.toLowerCase()}',
    );

    // Column widths
    sheet.setColumnWidth(0, 22);
    sheet.setColumnWidth(1, 14);
    sheet.setColumnWidth(2, 16);
    sheet.setColumnWidth(3, 14);
    sheet.setColumnWidth(4, 16);
    sheet.setColumnWidth(5, 16);
    sheet.setColumnWidth(6, 14);
    sheet.setColumnWidth(7, 14);
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // HELPER METHODS
  // ═══════════════════════════════════════════════════════════════════════════

  String _getLocalizedDayName(AppLocalizations l10n, int weekday) {
    switch (weekday) {
      case 1:
        return l10n.excelDayMonday;
      case 2:
        return l10n.excelDayTuesday;
      case 3:
        return l10n.excelDayWednesday;
      case 4:
        return l10n.excelDayThursday;
      case 5:
        return l10n.excelDayFriday;
      case 6:
        return l10n.excelDaySaturday;
      case 7:
        return l10n.excelDaySunday;
      default:
        return '-';
    }
  }

  void _setCell(
    Sheet sheet,
    String cellRef,
    String value, {
    bool isBold = false,
    int fontSize = 11,
    String? bgColor,
    String? textColor,
  }) {
    final cell = sheet.cell(CellIndex.indexByString(cellRef));
    cell.value = TextCellValue(value);

    cell.cellStyle = CellStyle(
      bold: isBold,
      fontSize: fontSize,
      fontColorHex: textColor != null
          ? _hexToExcelColor(textColor)
          : ExcelColor.black,
      backgroundColorHex: bgColor != null
          ? _hexToExcelColor(bgColor)
          : ExcelColor.none,
      horizontalAlign: HorizontalAlign.Left,
      verticalAlign: VerticalAlign.Center,
    );
  }

  void _setMergedCell(Sheet sheet, String startCell, String value, int cols) {
    final cell = sheet.cell(CellIndex.indexByString(startCell));
    cell.value = TextCellValue(value);
    cell.cellStyle = CellStyle(
      bold: true,
      fontSize: 24,
      fontColorHex: _hexToExcelColor(_titleColor),
      horizontalAlign: HorizontalAlign.Center,
    );

    // Merge cells
    final startIndex = CellIndex.indexByString(startCell);
    final endCol = startIndex.columnIndex + cols - 1;
    sheet.merge(
      CellIndex.indexByColumnRow(
        columnIndex: startIndex.columnIndex,
        rowIndex: startIndex.rowIndex,
      ),
      CellIndex.indexByColumnRow(
        columnIndex: endCol,
        rowIndex: startIndex.rowIndex,
      ),
    );
  }

  String _columnLetter(int index) {
    return String.fromCharCode(65 + index); // A, B, C, ...
  }

  String _formatCurrency(double value) {
    final formatter = NumberFormat('#,##0.00', 'tr');
    return '${formatter.format(value)} ₺';
  }

  ExcelColor _hexToExcelColor(String hex) {
    // #RRGGBB formatını AARRGGBB'ye çevir
    final cleanHex = hex.replaceAll('#', '');
    return ExcelColor.fromHexString('FF$cleanHex');
  }
}


--- FILE: lib/services/ai_tool_handler.dart ---

import '../models/models.dart';
import '../providers/finance_provider.dart';
import '../utils/duplicate_checker.dart';
import 'calculation_service.dart';
import 'currency_service.dart';

/// AI tool çağrılarını işleyen handler
class AIToolHandler {
  final FinanceProvider _financeProvider;
  final CalculationService _calculationService = CalculationService();
  final CurrencyService _currencyService = CurrencyService();

  AIToolHandler(this._financeProvider);

  /// Tool çağrısını işle ve sonucu döndür
  Future<Map<String, dynamic>> handleToolCall(
    String toolName,
    Map<String, dynamic> args,
  ) async {
    switch (toolName) {
      // OKUMA
      case 'get_expenses_summary':
        return _getExpensesSummary();
      case 'get_category_breakdown':
        return _getCategoryBreakdown(args['category'] as String);
      case 'get_subscriptions':
        return await _getSubscriptions();
      case 'get_budget_status':
        return _getBudgetStatus();
      case 'get_thinking_items':
        return _getThinkingItems();
      case 'get_saved_items':
        return _getSavedItems();

      // YAZMA
      case 'add_expense':
        return await _addExpense(args);
      case 'update_expense_decision':
        return await _updateExpenseDecision(args);

      // HESAPLAMA
      case 'calculate_savings_plan':
        return _calculateSavingsPlan(args);
      case 'calculate_hourly_equivalent':
        return _calculateHourlyEquivalent(args['amount'] as double);
      case 'compare_with_alternative':
        return _compareWithAlternative(args);

      default:
        return {'error': 'Bilinmeyen tool: $toolName'};
    }
  }

  // ==========================================
  // OKUMA HANDLER'LARI
  // ==========================================

  Map<String, dynamic> _getExpensesSummary() {
    final now = DateTime.now();
    final expenses = _financeProvider.realExpenses;
    final user = _financeProvider.userProfile;

    // Bu ay - sadece ALDIM olanlar
    final thisMonth = expenses
        .where(
          (e) =>
              e.date.month == now.month &&
              e.date.year == now.year &&
              e.decision == ExpenseDecision.yes,
        )
        .toList();

    // Geçen ay
    final lastMonth = expenses
        .where(
          (e) =>
              e.date.month == (now.month == 1 ? 12 : now.month - 1) &&
              e.date.year == (now.month == 1 ? now.year - 1 : now.year) &&
              e.decision == ExpenseDecision.yes,
        )
        .toList();

    final thisMonthTotal = thisMonth.fold(0.0, (sum, e) => sum + e.amount);
    final lastMonthTotal = lastMonth.fold(0.0, (sum, e) => sum + e.amount);
    final changePercent = lastMonthTotal > 0
        ? ((thisMonthTotal - lastMonthTotal) / lastMonthTotal * 100)
        : 0.0;

    // Kategori dağılımı
    final categoryTotals = <String, double>{};
    for (final e in thisMonth) {
      categoryTotals[e.category] = (categoryTotals[e.category] ?? 0) + e.amount;
    }

    return {
      'this_month_total': thisMonthTotal,
      'last_month_total': lastMonthTotal,
      'change_percent': changePercent.roundToDouble(),
      'expense_count': thisMonth.length,
      'category_breakdown': categoryTotals,
      'monthly_income': user?.monthlyIncome ?? 0,
      'remaining': (user?.monthlyIncome ?? 0) - thisMonthTotal,
    };
  }

  Map<String, dynamic> _getCategoryBreakdown(String category) {
    final now = DateTime.now();
    final expenses = _financeProvider.realExpenses;

    final categoryExpenses = expenses
        .where(
          (e) =>
              e.date.month == now.month &&
              e.date.year == now.year &&
              e.category == category &&
              e.decision == ExpenseDecision.yes,
        )
        .toList();

    final total = categoryExpenses.fold(0.0, (sum, e) => sum + e.amount);
    final items = categoryExpenses
        .map(
          (e) => {
            'amount': e.amount,
            'description': e.subCategory ?? e.category,
            'date': e.date.day,
          },
        )
        .toList();

    return {
      'category': category,
      'total': total,
      'count': categoryExpenses.length,
      'items': items,
    };
  }

  Future<Map<String, dynamic>> _getSubscriptions() async {
    final subscriptions = await _financeProvider.getActiveSubscriptions();
    final total = subscriptions.fold(0.0, (sum, s) => sum + s.amount);

    final items = subscriptions
        .map(
          (s) => {
            'name': s.name,
            'amount': s.amount,
            'renewal_day': s.renewalDay,
            'days_until_renewal': s.daysUntilRenewal,
          },
        )
        .toList();

    return {
      'total_monthly': total,
      'count': subscriptions.length,
      'subscriptions': items,
    };
  }

  Map<String, dynamic> _getBudgetStatus() {
    final user = _financeProvider.userProfile;
    final now = DateTime.now();
    final expenses = _financeProvider.realExpenses;

    final thisMonthTotal = expenses
        .where(
          (e) =>
              e.date.month == now.month &&
              e.date.year == now.year &&
              e.decision == ExpenseDecision.yes,
        )
        .fold(0.0, (sum, e) => sum + e.amount);

    final income = user?.monthlyIncome ?? 0;
    final remaining = income - thisMonthTotal;
    final usedPercent = income > 0 ? (thisMonthTotal / income * 100) : 0;

    // Saatlik kazanç
    final hourlyRate = user != null
        ? income / (user.dailyHours * user.workDaysPerWeek * 4.33)
        : 0.0;

    return {
      'monthly_income': income,
      'total_spent': thisMonthTotal,
      'remaining': remaining,
      'used_percent': usedPercent.roundToDouble(),
      'hourly_rate': hourlyRate.roundToDouble(),
      'status': usedPercent > 80
          ? 'critical'
          : usedPercent > 50
          ? 'warning'
          : 'healthy',
    };
  }

  Map<String, dynamic> _getThinkingItems() {
    final now = DateTime.now();
    final expenses = _financeProvider.realExpenses;

    final thinking = expenses
        .where(
          (e) =>
              e.date.month == now.month &&
              e.date.year == now.year &&
              e.decision == ExpenseDecision.thinking,
        )
        .toList();

    final total = thinking.fold(0.0, (sum, e) => sum + e.amount);
    final items = thinking
        .map(
          (e) => {
            'amount': e.amount,
            'category': e.category,
            'description': e.subCategory ?? e.category,
          },
        )
        .toList();

    return {'total': total, 'count': thinking.length, 'items': items};
  }

  Map<String, dynamic> _getSavedItems() {
    final now = DateTime.now();
    final expenses = _financeProvider.realExpenses;

    // Vazgeçilenler
    final rejected = expenses
        .where(
          (e) =>
              e.date.month == now.month &&
              e.date.year == now.year &&
              e.decision == ExpenseDecision.no,
        )
        .toList();

    // Smart Choice tasarrufları
    final smartChoice = expenses
        .where(
          (e) =>
              e.date.month == now.month &&
              e.date.year == now.year &&
              e.isSmartChoice &&
              e.savedAmount > 0,
        )
        .toList();

    final rejectedTotal = rejected.fold(0.0, (sum, e) => sum + e.amount);
    final smartChoiceTotal = smartChoice.fold(
      0.0,
      (sum, e) => sum + e.savedAmount,
    );

    return {
      'rejected_total': rejectedTotal,
      'rejected_count': rejected.length,
      'smart_choice_total': smartChoiceTotal,
      'smart_choice_count': smartChoice.length,
      'total_saved': rejectedTotal + smartChoiceTotal,
    };
  }

  // ==========================================
  // YAZMA HANDLER'LARI
  // ==========================================

  Future<Map<String, dynamic>> _addExpense(Map<String, dynamic> args) async {
    final user = _financeProvider.userProfile;
    if (user == null) {
      return {'error': 'Kullanıcı profili bulunamadı'};
    }

    final enteredAmount = (args['amount'] as num).toDouble();
    final category = args['category'] as String;
    final description = args['description'] as String?;
    final decisionStr = args['decision'] as String;
    final currencyCode = args['currency'] as String?;
    final force = args['force'] as bool? ?? false;

    // Get user's income currency
    final incomeCurrencyCode = user.incomeSources.isNotEmpty
        ? user.incomeSources.first.currencyCode
        : 'TRY';
    final expenseCurrencyCode = currencyCode ?? incomeCurrencyCode;
    final isDifferentCurrency = expenseCurrencyCode != incomeCurrencyCode;

    // Convert to income currency if needed
    double amountInIncomeCurrency = enteredAmount;
    if (isDifferentCurrency) {
      final rates = await _currencyService.getRates();
      if (rates != null) {
        amountInIncomeCurrency = _convertCurrency(
          enteredAmount,
          expenseCurrencyCode,
          incomeCurrencyCode,
          rates,
        );
      }
    }

    // Duplicate kontrolü (force değilse)
    if (!force) {
      final duplicates = DuplicateChecker.findDuplicates(
        expenses: _financeProvider.realExpenses,
        amount: amountInIncomeCurrency,
        category: category,
      );

      if (duplicates.isNotEmpty) {
        final match = duplicates.first;
        final timeDiff = match.timeSinceEntry;
        String timeAgo;
        if (timeDiff.inMinutes < 1) {
          timeAgo = 'just now';
        } else if (timeDiff.inMinutes < 60) {
          timeAgo = '${timeDiff.inMinutes} minutes ago';
        } else if (timeDiff.inHours < 24) {
          timeAgo = '${timeDiff.inHours} hours ago';
        } else {
          timeAgo = '${timeDiff.inDays} days ago';
        }

        return {
          'duplicate_found': true,
          'amount': enteredAmount,
          'currency': expenseCurrencyCode,
          'category': category,
          'existing_amount': match.expense.amount,
          'existing_category': match.expense.category,
          'time_ago': timeAgo,
          'message':
              'Similar expense found: ${match.expense.amount.toStringAsFixed(0)} $category ($timeAgo). Add anyway?',
        };
      }
    }

    ExpenseDecision decision;
    switch (decisionStr) {
      case 'yes':
        decision = ExpenseDecision.yes;
        break;
      case 'thinking':
        decision = ExpenseDecision.thinking;
        break;
      case 'no':
        decision = ExpenseDecision.no;
        break;
      default:
        decision = ExpenseDecision.yes;
    }

    // Hesaplama (income currency üzerinden)
    final result = _calculationService.calculateExpense(
      userProfile: user,
      expenseAmount: amountInIncomeCurrency,
      month: DateTime.now().month,
      year: DateTime.now().year,
    );

    final expense = Expense(
      amount: amountInIncomeCurrency,
      category: category,
      subCategory: description,
      date: DateTime.now(),
      hoursRequired: result.hoursRequired,
      daysRequired: result.daysRequired,
      decision: decision,
      decisionDate: DateTime.now(),
      recordType: RecordType.real,
      originalAmount: isDifferentCurrency ? enteredAmount : null,
      originalCurrency: isDifferentCurrency ? expenseCurrencyCode : null,
    );

    await _financeProvider.addExpense(expense);

    final currency = getCurrencyByCode(expenseCurrencyCode);
    return {
      'success': true,
      'amount': enteredAmount,
      'currency': expenseCurrencyCode,
      'currency_symbol': currency.symbol,
      'converted_amount': isDifferentCurrency ? amountInIncomeCurrency : null,
      'category': category,
      'description': description,
      'decision': decisionStr,
      'hours_required': result.hoursRequired.roundToDouble(),
      'message': isDifferentCurrency
          ? 'Harcama kaydedildi (${currency.symbol}$enteredAmount → ₺${amountInIncomeCurrency.toStringAsFixed(0)})'
          : 'Harcama kaydedildi',
    };
  }

  /// Convert amount between currencies using exchange rates
  double _convertCurrency(
    double amount,
    String from,
    String to,
    ExchangeRates rates,
  ) {
    // Get TRY values for each currency
    double getTryValue(String code) {
      switch (code) {
        case 'TRY':
          return 1.0;
        case 'USD':
          return rates.usdRate;
        case 'EUR':
          return rates.eurRate;
        case 'GBP':
          return rates.usdRate * 1.27; // Approximate GBP/USD
        case 'SAR':
          return rates.usdRate / 3.75; // SAR pegged to USD
        default:
          return 1.0;
      }
    }

    final fromTry = getTryValue(from);
    final toTry = getTryValue(to);

    // Convert: from -> TRY -> to
    final amountInTry = amount * fromTry;
    return amountInTry / toTry;
  }

  Future<Map<String, dynamic>> _updateExpenseDecision(
    Map<String, dynamic> args,
  ) async {
    final expenseDesc = args['expense_description'] as String;
    final newDecisionStr = args['new_decision'] as String;

    ExpenseDecision newDecision;
    switch (newDecisionStr) {
      case 'yes':
        newDecision = ExpenseDecision.yes;
        break;
      case 'no':
        newDecision = ExpenseDecision.no;
        break;
      default:
        return {'error': 'Geçersiz karar: $newDecisionStr'};
    }

    // Düşünüyorum listesinde ara
    final expenses = _financeProvider.realExpenses;
    final index = expenses.indexWhere(
      (e) =>
          e.decision == ExpenseDecision.thinking &&
          (e.subCategory?.toLowerCase().contains(expenseDesc.toLowerCase()) ==
                  true ||
              e.category.toLowerCase().contains(expenseDesc.toLowerCase())),
    );

    if (index == -1) {
      return {'error': 'Düşünüyorum listesinde "$expenseDesc" bulunamadı'};
    }

    await _financeProvider.updateExpenseDecision(index, newDecision);

    return {
      'success': true,
      'expense': expenseDesc,
      'new_decision': newDecisionStr,
      'message': newDecisionStr == 'no'
          ? 'İrade zaferi! Tebrikler!'
          : 'Karar güncellendi',
    };
  }

  // ==========================================
  // HESAPLAMA HANDLER'LARI
  // ==========================================

  Map<String, dynamic> _calculateSavingsPlan(Map<String, dynamic> args) {
    final targetAmount = (args['target_amount'] as num).toDouble();
    final targetMonths = args['target_months'] as int;
    final purpose = args['purpose'] as String?;

    final user = _financeProvider.userProfile;
    final income = user?.monthlyIncome ?? 0;

    final monthlySavingNeeded = targetAmount / targetMonths;
    final percentOfIncome = income > 0
        ? (monthlySavingNeeded / income * 100)
        : 0;

    // Mevcut harcamaları kontrol et
    final now = DateTime.now();
    final thisMonthSpent = _financeProvider.realExpenses
        .where(
          (e) =>
              e.date.month == now.month &&
              e.date.year == now.year &&
              e.decision == ExpenseDecision.yes,
        )
        .fold(0.0, (sum, e) => sum + e.amount);

    final currentMonthlySavings = income - thisMonthSpent;
    final isRealistic = currentMonthlySavings >= monthlySavingNeeded;

    // Alternatif süre hesapla
    final realisticMonths = currentMonthlySavings > 0
        ? (targetAmount / currentMonthlySavings).ceil()
        : 0;

    return {
      'target_amount': targetAmount,
      'target_months': targetMonths,
      'purpose': purpose,
      'monthly_saving_needed': monthlySavingNeeded.roundToDouble(),
      'percent_of_income': percentOfIncome.roundToDouble(),
      'is_realistic': isRealistic,
      'current_monthly_savings': currentMonthlySavings.roundToDouble(),
      'realistic_months': realisticMonths,
      'recommendation': isRealistic
          ? 'Hedefe ulaşılabilir görünüyor'
          : 'Hedef için $realisticMonths ay daha gerçekçi',
    };
  }

  Map<String, dynamic> _calculateHourlyEquivalent(double amount) {
    final user = _financeProvider.userProfile;
    if (user == null) {
      return {'error': 'Kullanıcı profili bulunamadı'};
    }

    final divisor = user.dailyHours * user.workDaysPerWeek * 4.33;
    final hourlyRate = divisor > 0 ? user.monthlyIncome / divisor : 0.0;
    final hours = hourlyRate > 0 ? amount / hourlyRate : 0.0;
    final days = user.dailyHours > 0 ? hours / user.dailyHours : 0.0;
    final weeks = user.workDaysPerWeek > 0 ? days / user.workDaysPerWeek : 0.0;

    return {
      'amount': amount,
      'hourly_rate': hourlyRate.roundToDouble(),
      'hours': hours.roundToDouble(),
      'days': days.roundToDouble(),
      'weeks': weeks.roundToDouble(),
      'description':
          '${amount.toStringAsFixed(0)} TL = ${hours.toStringAsFixed(1)} saat çalışman',
    };
  }

  Map<String, dynamic> _compareWithAlternative(Map<String, dynamic> args) {
    final amount = (args['amount'] as num).toDouble();
    final alternative = args['alternative'] as String;
    final periodMonths = args['period_months'] as int;

    double returnRate;
    String alternativeName;

    switch (alternative) {
      case 'gold':
        returnRate = 0.03; // Aylık ortalama %3 (yıllık ~%40)
        alternativeName = 'Altın';
        break;
      case 'interest':
        returnRate = 0.035; // Aylık ortalama %3.5
        alternativeName = 'Mevduat Faizi';
        break;
      case 'savings':
        returnRate = 0.02; // Aylık ortalama %2
        alternativeName = 'Birikim Hesabı';
        break;
      default:
        returnRate = 0.025;
        alternativeName = 'Yatırım';
    }

    // Bileşik getiri hesapla
    final futureValue = amount * (1 + returnRate * periodMonths);
    final profit = futureValue - amount;
    final totalReturnPercent = (profit / amount * 100);

    return {
      'amount': amount,
      'alternative': alternativeName,
      'period_months': periodMonths,
      'future_value': futureValue.roundToDouble(),
      'profit': profit.roundToDouble(),
      'total_return_percent': totalReturnPercent.roundToDouble(),
      'monthly_return_percent': (returnRate * 100).roundToDouble(),
      'description':
          '$periodMonths ay sonra ${futureValue.toStringAsFixed(0)} TL olur, ${profit.toStringAsFixed(0)} TL kar',
    };
  }
}


--- FILE: lib/services/email_trigger_service.dart ---

import 'package:shared_preferences/shared_preferences.dart';
import 'package:vantag/services/analytics_service.dart';

/// Email trigger service for backend integration
/// This service logs analytics events that the backend uses to trigger emails
class EmailTriggerService {
  static final EmailTriggerService _instance = EmailTriggerService._internal();
  factory EmailTriggerService() => _instance;
  EmailTriggerService._internal();

  // Pref keys
  static const String _keyOnboardingEmailsSent = 'email_onboarding_sent';
  static const String _keyLastEmailTrigger = 'email_last_trigger';

  // ===========================================
  // ONBOARDING EMAIL TRIGGERS
  // ===========================================

  /// Trigger welcome email on user registration
  Future<void> triggerWelcomeEmail({required String userId}) async {
    await AnalyticsService().logEvent(
      'trigger_email',
      parameters: {
        'email_type': 'welcome',
        'sequence': 'onboarding',
        'user_id': userId,
      },
    );
  }

  /// Trigger onboarding sequence based on day
  Future<void> triggerOnboardingEmail({
    required int dayNumber,
    required String userId,
    required int expenseCount,
  }) async {
    final prefs = await SharedPreferences.getInstance();
    final sentEmails = prefs.getStringList(_keyOnboardingEmailsSent) ?? [];

    final emailKey = 'onboarding_day$dayNumber';

    // Don't send if already sent
    if (sentEmails.contains(emailKey)) return;

    // Condition checks based on day
    bool shouldSend = false;
    String emailType = '';

    switch (dayNumber) {
      case 1:
        shouldSend = expenseCount < 1;
        emailType = 'quick_win';
        break;
      case 3:
        shouldSend = expenseCount < 3;
        emailType = 'value_reminder';
        break;
      case 7:
        shouldSend = true; // Always send feature discovery
        emailType = 'feature_discovery';
        break;
      case 14:
        shouldSend = true;
        emailType = 'streak_motivation';
        break;
    }

    if (!shouldSend) return;

    await AnalyticsService().logEvent(
      'trigger_email',
      parameters: {
        'email_type': emailType,
        'sequence': 'onboarding',
        'day_number': dayNumber,
        'user_id': userId,
        'expense_count': expenseCount,
      },
    );

    // Mark as sent
    sentEmails.add(emailKey);
    await prefs.setStringList(_keyOnboardingEmailsSent, sentEmails);
  }

  // ===========================================
  // RE-ENGAGEMENT EMAIL TRIGGERS
  // ===========================================

  /// Trigger re-engagement email based on inactivity
  Future<void> triggerReengagementEmail({
    required int daysInactive,
    required String userId,
    bool hadStreak = false,
  }) async {
    String emailType;

    if (daysInactive >= 30) {
      emailType = 'final_attempt';
    } else if (daysInactive >= 14) {
      emailType = 'win_back';
    } else if (daysInactive >= 7) {
      emailType = 'value_recap';
    } else if (daysInactive >= 5 && hadStreak) {
      emailType = 'streak_warning';
    } else if (daysInactive >= 3) {
      emailType = 'miss_you';
    } else {
      return; // Not inactive enough
    }

    await AnalyticsService().logEvent(
      'trigger_email',
      parameters: {
        'email_type': emailType,
        'sequence': 'reengagement',
        'days_inactive': daysInactive,
        'user_id': userId,
        'had_streak': hadStreak,
      },
    );

    await _recordEmailTrigger(emailType);
  }

  // ===========================================
  // MILESTONE EMAIL TRIGGERS
  // ===========================================

  /// Trigger milestone celebration email
  Future<void> triggerMilestoneEmail({
    required String milestoneType,
    required String userId,
    Map<String, dynamic>? extraData,
  }) async {
    await AnalyticsService().logEvent(
      'trigger_email',
      parameters: {
        'email_type': 'milestone_$milestoneType',
        'sequence': 'milestone',
        'milestone_type': milestoneType,
        'user_id': userId,
        ...?extraData,
      },
    );
  }

  /// Trigger streak milestone email
  Future<void> triggerStreakMilestoneEmail({
    required int streakDays,
    required String userId,
  }) async {
    // Only trigger for specific milestones
    final milestones = [7, 14, 30, 60, 100, 365];
    if (!milestones.contains(streakDays)) return;

    await triggerMilestoneEmail(
      milestoneType: 'streak_$streakDays',
      userId: userId,
      extraData: {'streak_days': streakDays},
    );
  }

  /// Trigger savings milestone email
  Future<void> triggerSavingsMilestoneEmail({
    required double totalSaved,
    required String userId,
    required String currencySymbol,
  }) async {
    // Check for milestones
    final milestones = [1000, 5000, 10000, 50000, 100000];

    for (final milestone in milestones) {
      if (totalSaved >= milestone && totalSaved < milestone * 1.1) {
        await triggerMilestoneEmail(
          milestoneType: 'saved_$milestone',
          userId: userId,
          extraData: {
            'amount': totalSaved,
            'currency': currencySymbol,
          },
        );
        break;
      }
    }
  }

  // ===========================================
  // SUBSCRIPTION EMAIL TRIGGERS
  // ===========================================

  /// Trigger trial ending email
  Future<void> triggerTrialEndingEmail({
    required String userId,
    required int daysRemaining,
  }) async {
    if (daysRemaining > 3) return;

    await AnalyticsService().logEvent(
      'trigger_email',
      parameters: {
        'email_type': 'trial_ending',
        'sequence': 'subscription',
        'user_id': userId,
        'days_remaining': daysRemaining,
      },
    );
  }

  /// Trigger subscription confirmed email
  Future<void> triggerSubscriptionConfirmedEmail({
    required String userId,
    required String planType,
  }) async {
    await AnalyticsService().logEvent(
      'trigger_email',
      parameters: {
        'email_type': 'subscription_confirmed',
        'sequence': 'subscription',
        'user_id': userId,
        'plan_type': planType,
      },
    );
  }

  /// Trigger subscription cancelled email
  Future<void> triggerSubscriptionCancelledEmail({
    required String userId,
  }) async {
    await AnalyticsService().logEvent(
      'trigger_email',
      parameters: {
        'email_type': 'subscription_cancelled',
        'sequence': 'subscription',
        'user_id': userId,
      },
    );
  }

  /// Trigger win-back email for expired subscriptions
  Future<void> triggerSubscriptionWinBackEmail({
    required String userId,
    required int daysSinceExpiry,
  }) async {
    if (daysSinceExpiry < 7) return;

    await AnalyticsService().logEvent(
      'trigger_email',
      parameters: {
        'email_type': 'subscription_winback',
        'sequence': 'subscription',
        'user_id': userId,
        'days_since_expiry': daysSinceExpiry,
      },
    );
  }

  // ===========================================
  // WEEKLY DIGEST TRIGGER
  // ===========================================

  /// Trigger weekly digest email
  Future<void> triggerWeeklyDigestEmail({
    required String userId,
    required double weeklyTotal,
    required double weeklyHours,
    required double? previousWeekTotal,
    required String currencySymbol,
  }) async {
    await AnalyticsService().logEvent(
      'trigger_email',
      parameters: {
        'email_type': 'weekly_digest',
        'sequence': 'digest',
        'user_id': userId,
        'weekly_total': weeklyTotal,
        'weekly_hours': weeklyHours,
        'previous_week_total': previousWeekTotal ?? 0,
        'currency': currencySymbol,
      },
    );
  }

  // ===========================================
  // EMAIL CTA TRACKING
  // ===========================================

  /// Track when user clicks email CTA (deep link opened)
  Future<void> trackEmailCtaClicked({
    required String emailType,
    required String ctaAction,
  }) async {
    await AnalyticsService().logEvent(
      'email_cta_clicked',
      parameters: {
        'email_type': emailType,
        'cta_action': ctaAction,
      },
    );
  }

  // ===========================================
  // HELPER METHODS
  // ===========================================

  Future<void> _recordEmailTrigger(String emailType) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(
      _keyLastEmailTrigger,
      '${emailType}_${DateTime.now().toIso8601String()}',
    );
  }

  /// Check if enough time has passed since last email trigger
  Future<bool> canTriggerEmail({
    Duration minimumInterval = const Duration(hours: 24),
  }) async {
    final prefs = await SharedPreferences.getInstance();
    final lastTrigger = prefs.getString(_keyLastEmailTrigger);

    if (lastTrigger == null) return true;

    final parts = lastTrigger.split('_');
    if (parts.length < 2) return true;

    final timestamp = DateTime.tryParse(parts.last);
    if (timestamp == null) return true;

    return DateTime.now().difference(timestamp) >= minimumInterval;
  }

  /// Clear onboarding email tracking (for testing)
  Future<void> resetOnboardingEmails() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.remove(_keyOnboardingEmailsSent);
  }
}


--- FILE: lib/services/savings_pool_service.dart ---

import 'dart:async';
import 'dart:convert';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:flutter/foundation.dart';
import 'package:shared_preferences/shared_preferences.dart';
import '../models/savings_pool.dart';

/// Tasarruf Havuzu Service (Local + Firestore hybrid)
/// Falls back to local storage when Firestore fails
class SavingsPoolService {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final FirebaseAuth _auth = FirebaseAuth.instance;

  // Local storage key
  static const _localKey = 'savings_pool_local';

  // Stream controller for local updates
  final _localStreamController = StreamController<SavingsPool>.broadcast();
  SavingsPool _cachedPool = SavingsPool.empty();
  bool _useLocalOnly = false;

  /// Firestore document reference
  DocumentReference<Map<String, dynamic>>? get _docRef {
    final user = _auth.currentUser;
    if (user == null) return null;
    return _firestore
        .collection('users')
        .doc(user.uid)
        .collection('savings_pool')
        .doc('current');
  }

  /// Havuz verisi stream'i (hybrid - tries Firestore, falls back to local)
  Stream<SavingsPool> get poolStream {
    if (_useLocalOnly) {
      // Emit cached pool immediately for local-only mode
      Future.microtask(() => _localStreamController.add(_cachedPool));
      return _localStreamController.stream;
    }

    final ref = _docRef;
    if (ref == null) {
      // No user, use local stream
      Future.microtask(() => _localStreamController.add(_cachedPool));
      return _localStreamController.stream;
    }

    // Try Firestore first, fall back to local on error
    return ref
        .snapshots()
        .handleError((e) {
          debugPrint(
            '⚠️ [SavingsPoolService] Firestore error, switching to local: $e',
          );
          _useLocalOnly = true;
          _loadLocalPool().then((pool) {
            _cachedPool = pool;
            _localStreamController.add(pool);
          });
        })
        .map((snapshot) {
          if (!snapshot.exists || snapshot.data() == null) {
            return _cachedPool;
          }
          _cachedPool = SavingsPool.fromFirestore(snapshot.data()!);
          // Also save locally as backup
          _saveLocalPool(_cachedPool);
          return _cachedPool;
        });
  }

  /// Mevcut havuzu getir
  Future<SavingsPool> getPool() async {
    // Try Firestore first
    if (!_useLocalOnly) {
      final ref = _docRef;
      if (ref != null) {
        try {
          final snapshot = await ref.get();
          if (snapshot.exists && snapshot.data() != null) {
            _cachedPool = SavingsPool.fromFirestore(snapshot.data()!);
            _saveLocalPool(_cachedPool); // Backup locally
            return _cachedPool;
          }
        } catch (e) {
          debugPrint(
            '⚠️ [SavingsPoolService] Firestore getPool error, using local: $e',
          );
          _useLocalOnly = true;
        }
      }
    }

    // Fall back to local
    return _loadLocalPool();
  }

  /// Load pool from local storage
  Future<SavingsPool> _loadLocalPool() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      final json = prefs.getString(_localKey);
      if (json != null) {
        final data = jsonDecode(json) as Map<String, dynamic>;
        _cachedPool = SavingsPool.fromFirestore(data);
        debugPrint('💾 [SavingsPoolService] Loaded from local: $_cachedPool');
        return _cachedPool;
      }
    } catch (e) {
      debugPrint('❌ [SavingsPoolService] Local load error: $e');
    }
    return SavingsPool.empty();
  }

  /// Save pool to local storage
  Future<void> _saveLocalPool(SavingsPool pool) async {
    try {
      final prefs = await SharedPreferences.getInstance();
      await prefs.setString(
        _localKey,
        jsonEncode(pool.toFirestore(forLocalStorage: true)),
      );
    } catch (e) {
      debugPrint('❌ [SavingsPoolService] Local save error: $e');
    }
  }

  /// Havuzu güncelle (tries Firestore, always updates local)
  Future<void> updatePool(SavingsPool pool) async {
    _cachedPool = pool;

    // Always save locally first
    await _saveLocalPool(pool);
    _localStreamController.add(pool);

    // Try Firestore if not in local-only mode
    if (!_useLocalOnly) {
      final ref = _docRef;
      if (ref != null) {
        try {
          await ref.set(pool.toFirestore(), SetOptions(merge: true));
          debugPrint('✅ [SavingsPoolService] Pool updated (Firestore): $pool');
          return;
        } catch (e) {
          debugPrint(
            '⚠️ [SavingsPoolService] Firestore update failed, local only: $e',
          );
          _useLocalOnly = true;
        }
      }
    }

    debugPrint('✅ [SavingsPoolService] Pool updated (local): $pool');
  }

  /// Tasarruf ekle (vazgeçme durumunda)
  Future<void> addSavings(double amount) async {
    if (amount <= 0) return;

    final pool = await getPool();

    // Önce borç varsa onu kapat
    double remainingAmount = amount;
    double newDebt = pool.shadowDebt;

    if (pool.hasDebt) {
      if (amount >= pool.shadowDebt) {
        // Borç tamamen kapanıyor
        remainingAmount = amount - pool.shadowDebt;
        newDebt = 0;
        debugPrint(
          '💰 [SavingsPoolService] Debt fully paid: ${pool.shadowDebt}',
        );
      } else {
        // Borç kısmen ödeniyor
        newDebt = pool.shadowDebt - amount;
        remainingAmount = 0;
        debugPrint(
          '💰 [SavingsPoolService] Debt partially paid: $amount, remaining debt: $newDebt',
        );
      }
    }

    final newPool = pool.copyWith(
      totalSaved: pool.totalSaved + remainingAmount,
      shadowDebt: newDebt,
    );

    await updatePool(newPool);
  }

  /// Hayale para ayır
  Future<bool> allocateToDream(
    double amount,
    String dreamId, {
    BudgetShiftSource? source,
  }) async {
    if (amount <= 0) return false;

    final pool = await getPool();

    // Joker kontrolü
    if (source == BudgetShiftSource.joker) {
      if (pool.jokerUsedThisMonth) {
        debugPrint('❌ [SavingsPoolService] Joker already used this month');
        return false;
      }

      // Joker kullanıldı, direkt ekle
      final newPool = pool.copyWith(
        allocatedToDreams: pool.allocatedToDreams + amount,
        jokerUsedThisMonth: true,
      );
      await updatePool(newPool);
      debugPrint(
        '🃏 [SavingsPoolService] Joker used for $amount to dream $dreamId',
      );
      return true;
    }

    // Ekstra gelir - direkt ekle
    if (source == BudgetShiftSource.extraIncome) {
      final newPool = pool.copyWith(
        totalSaved: pool.totalSaved + amount,
        allocatedToDreams: pool.allocatedToDreams + amount,
      );
      await updatePool(newPool);
      debugPrint(
        '💰 [SavingsPoolService] Extra income $amount added to dream $dreamId',
      );
      return true;
    }

    // Normal akış - havuzdan al
    if (pool.available >= amount) {
      // Yeterli bakiye var
      final newPool = pool.copyWith(
        allocatedToDreams: pool.allocatedToDreams + amount,
      );
      await updatePool(newPool);
      debugPrint('✅ [SavingsPoolService] Allocated $amount to dream $dreamId');
      return true;
    }

    // Bütçe kaydırma ile ekle (kategori seçilmiş)
    if (source != null) {
      final newPool = pool.copyWith(
        allocatedToDreams: pool.allocatedToDreams + amount,
      );
      await updatePool(newPool);
      debugPrint(
        '📊 [SavingsPoolService] Budget shift from ${source.name}: $amount to dream $dreamId',
      );
      return true;
    }

    // Yetersiz bakiye ve kaynak belirtilmemiş
    debugPrint(
      '❌ [SavingsPoolService] Insufficient funds: available ${pool.available}, requested $amount',
    );
    return false;
  }

  /// Gölge borç oluştur (havuz eksiye düşürülür)
  Future<void> createShadowDebt(double amount, String dreamId) async {
    if (amount <= 0) return;

    final pool = await getPool();
    final newPool = pool.copyWith(
      allocatedToDreams: pool.allocatedToDreams + amount,
      shadowDebt: pool.shadowDebt + amount,
    );
    await updatePool(newPool);
    debugPrint(
      '🔴 [SavingsPoolService] Shadow debt created: $amount for dream $dreamId',
    );
  }

  /// Borç öde
  Future<void> repayDebt(double amount) async {
    if (amount <= 0) return;

    final pool = await getPool();
    if (!pool.hasDebt) return;

    final newDebt = (pool.shadowDebt - amount).clamp(0.0, double.infinity);
    final newPool = pool.copyWith(shadowDebt: newDebt);
    await updatePool(newPool);
    debugPrint(
      '💳 [SavingsPoolService] Debt repaid: $amount, remaining: $newDebt',
    );
  }

  /// Aylık joker reset (ay değişince çağrılır)
  Future<void> resetMonthlyJoker() async {
    final pool = await getPool();
    final now = DateTime.now();
    final currentMonth = DateTime(now.year, now.month, 1);

    // Aynı ayda zaten resetlenmişse atla
    if (pool.jokerResetDate.year == currentMonth.year &&
        pool.jokerResetDate.month == currentMonth.month) {
      return;
    }

    final newPool = pool.copyWith(
      jokerUsedThisMonth: false,
      jokerResetDate: currentMonth,
    );
    await updatePool(newPool);
    debugPrint('🔄 [SavingsPoolService] Monthly joker reset');
  }

  /// Havuzdan hayale ayrılan tutarı geri al (hayal silindiğinde)
  Future<void> deallocateFromDream(double amount) async {
    if (amount <= 0) return;

    final pool = await getPool();
    final newPool = pool.copyWith(
      allocatedToDreams: (pool.allocatedToDreams - amount).clamp(
        0.0,
        double.infinity,
      ),
    );
    await updatePool(newPool);
    debugPrint('↩️ [SavingsPoolService] Deallocated $amount from dreams');
  }
}


--- FILE: lib/widgets/savings_pool_card.dart ---

import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../providers/savings_pool_provider.dart';
import '../providers/currency_provider.dart';
import '../theme/theme.dart';
import '../utils/currency_utils.dart';

/// Tasarruf Havuzu kartı - Hayallerim ekranında gösterilir
class SavingsPoolCard extends StatelessWidget {
  final bool compact;

  const SavingsPoolCard({super.key, this.compact = false});

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final pool = context.watch<SavingsPoolProvider>();
    final currency = context.watch<CurrencyProvider>();
    final symbol = currency.currency.symbol;

    if (pool.isLoading) {
      return _buildLoadingState(context);
    }

    if (compact) {
      return _buildCompactCard(context, l10n, pool, symbol);
    }

    return _buildFullCard(context, l10n, pool, symbol);
  }

  Widget _buildLoadingState(BuildContext context) {
    return Container(
      height: 80,
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(16),
      ),
      child: const Center(
        child: SizedBox(
          width: 24,
          height: 24,
          child: CircularProgressIndicator(strokeWidth: 2),
        ),
      ),
    );
  }

  Widget _buildCompactCard(
    BuildContext context,
    AppLocalizations l10n,
    SavingsPoolProvider pool,
    String symbol,
  ) {
    final hasDebt = pool.hasDebt;
    final available = pool.available;

    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: hasDebt
              ? [
                  context.appColors.error.withValues(alpha: 0.15),
                  context.appColors.error.withValues(alpha: 0.05),
                ]
              : [
                  context.appColors.primary.withValues(alpha: 0.15),
                  context.appColors.primary.withValues(alpha: 0.05),
                ],
        ),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: hasDebt
              ? context.appColors.error.withValues(alpha: 0.3)
              : context.appColors.primary.withValues(alpha: 0.3),
        ),
      ),
      child: Row(
        children: [
          // Icon
          Container(
            width: 36,
            height: 36,
            decoration: BoxDecoration(
              color: hasDebt
                  ? context.appColors.error.withValues(alpha: 0.15)
                  : context.appColors.primary.withValues(alpha: 0.15),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Center(
              child: Text(
                hasDebt ? '🔴' : '💰',
                style: const TextStyle(fontSize: 18),
              ),
            ),
          ),
          const SizedBox(width: 12),

          // Info
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              mainAxisSize: MainAxisSize.min,
              children: [
                Text(
                  l10n.savingsPool,
                  style: TextStyle(
                    fontSize: 12,
                    color: context.appColors.textSecondary,
                  ),
                ),
                const SizedBox(height: 2),
                Row(
                  children: [
                    Text(
                      hasDebt
                          ? '-$symbol${formatTurkishCurrency(pool.shadowDebt.abs(), decimalDigits: 0, showDecimals: false)}'
                          : '$symbol${formatTurkishCurrency(available, decimalDigits: 0, showDecimals: false)}',
                      style: TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.w700,
                        color: hasDebt
                            ? context.appColors.error
                            : context.appColors.textPrimary,
                      ),
                    ),
                    const SizedBox(width: 6),
                    Text(
                      hasDebt
                          ? l10n.savingsPoolDebt
                          : l10n.savingsPoolAvailable,
                      style: TextStyle(
                        fontSize: 13,
                        color: hasDebt
                            ? context.appColors.error
                            : context.appColors.textSecondary,
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildFullCard(
    BuildContext context,
    AppLocalizations l10n,
    SavingsPoolProvider pool,
    String symbol,
  ) {
    final hasDebt = pool.hasDebt;

    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: hasDebt
              ? [
                  context.appColors.error.withValues(alpha: 0.1),
                  context.appColors.surface,
                ]
              : [
                  context.appColors.primary.withValues(alpha: 0.1),
                  context.appColors.surface,
                ],
        ),
        borderRadius: BorderRadius.circular(24),
        border: Border.all(
          color: hasDebt
              ? context.appColors.error.withValues(alpha: 0.2)
              : context.appColors.cardBorder,
        ),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Header
          Row(
            children: [
              Text(hasDebt ? '🔴' : '💰', style: const TextStyle(fontSize: 24)),
              const SizedBox(width: 12),
              Text(
                l10n.savingsPool,
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textPrimary,
                ),
              ),
            ],
          ),
          const SizedBox(height: 20),

          // Main amount
          if (hasDebt) ...[
            Text(
              '-$symbol${formatTurkishCurrency(pool.shadowDebt.abs(), decimalDigits: 0, showDecimals: false)}',
              style: TextStyle(
                fontSize: 32,
                fontWeight: FontWeight.w800,
                color: context.appColors.error,
              ),
            ),
            const SizedBox(height: 4),
            Text(
              l10n.shadowDebtMessage(
                '$symbol${formatTurkishCurrency(pool.shadowDebt.abs(), decimalDigits: 0, showDecimals: false)}',
              ),
              style: TextStyle(
                fontSize: 13,
                color: context.appColors.error.withValues(alpha: 0.8),
              ),
            ),
          ] else ...[
            Text(
              '$symbol${formatTurkishCurrency(pool.available, decimalDigits: 0, showDecimals: false)}',
              style: TextStyle(
                fontSize: 32,
                fontWeight: FontWeight.w800,
                color: context.appColors.textPrimary,
              ),
            ),
            const SizedBox(height: 4),
            Text(
              l10n.savingsPoolAvailable,
              style: TextStyle(
                fontSize: 13,
                color: context.appColors.textSecondary,
              ),
            ),
          ],

          const SizedBox(height: 20),

          // Breakdown
          Container(
            padding: const EdgeInsets.all(14),
            decoration: BoxDecoration(
              color: context.appColors.surfaceLight.withValues(alpha: 0.5),
              borderRadius: BorderRadius.circular(16),
            ),
            child: Column(
              children: [
                _buildBreakdownRow(
                  context,
                  l10n.poolSummaryTotal,
                  '$symbol${formatTurkishCurrency(pool.totalSaved, decimalDigits: 0, showDecimals: false)}',
                  context.appColors.textPrimary,
                ),
                const SizedBox(height: 8),
                _buildBreakdownRow(
                  context,
                  l10n.poolSummaryAllocated,
                  '-$symbol${formatTurkishCurrency(pool.allocatedToDreams, decimalDigits: 0, showDecimals: false)}',
                  context.appColors.primary,
                ),
                if (hasDebt) ...[
                  const SizedBox(height: 8),
                  _buildBreakdownRow(
                    context,
                    'Borç',
                    '-$symbol${formatTurkishCurrency(pool.shadowDebt, decimalDigits: 0, showDecimals: false)}',
                    context.appColors.error,
                  ),
                ],
                Divider(height: 16, color: context.appColors.cardBorder),
                _buildBreakdownRow(
                  context,
                  l10n.poolSummaryAvailable,
                  hasDebt
                      ? '-$symbol${formatTurkishCurrency(pool.shadowDebt, decimalDigits: 0, showDecimals: false)}'
                      : '$symbol${formatTurkishCurrency(pool.available, decimalDigits: 0, showDecimals: false)}',
                  hasDebt ? context.appColors.error : context.appColors.success,
                  isBold: true,
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildBreakdownRow(
    BuildContext context,
    String label,
    String value,
    Color valueColor, {
    bool isBold = false,
  }) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        Text(
          label,
          style: TextStyle(
            fontSize: 13,
            color: context.appColors.textSecondary,
            fontWeight: isBold ? FontWeight.w600 : FontWeight.w400,
          ),
        ),
        Text(
          value,
          style: TextStyle(
            fontSize: 14,
            fontWeight: isBold ? FontWeight.w700 : FontWeight.w500,
            color: valueColor,
          ),
        ),
      ],
    );
  }
}


--- FILE: lib/widgets/animated_counter.dart ---

import 'dart:math' as math;
import 'package:flutter/material.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../theme/theme.dart';

/// Animasyonlu sayaç widget'ı
/// Sayılar pat diye değişmez, akışkan bir şekilde artar/azalır
class AnimatedCounter extends StatelessWidget {
  final double value;
  final String? prefix;
  final String? suffix;
  final TextStyle? style;
  final int decimalPlaces;
  final Duration duration;
  final Duration delay;
  final Curve curve;
  final bool useGrouping; // 1.000,00 formatı

  const AnimatedCounter({
    super.key,
    required this.value,
    this.prefix,
    this.suffix,
    this.style,
    this.decimalPlaces = 0,
    this.duration = AppAnimations.counter,
    this.delay = Duration.zero,
    this.curve = AppAnimations.standardCurve,
    this.useGrouping = true,
  });

  @override
  Widget build(BuildContext context) {
    return TweenAnimationBuilder<double>(
      tween: Tween<double>(begin: 0, end: value),
      duration: duration,
      curve: curve,
      builder: (context, animatedValue, child) {
        return Text(_formatValue(animatedValue), style: style);
      },
    );
  }

  String _formatValue(double val) {
    String formatted;

    if (decimalPlaces > 0) {
      formatted = val.toStringAsFixed(decimalPlaces);
    } else {
      formatted = val.toInt().toString();
    }

    if (useGrouping) {
      // Türkçe format: 1.234.567,89
      final parts = formatted.split('.');
      final intPart = parts[0];
      final decPart = parts.length > 1 ? parts[1] : null;

      final buffer = StringBuffer();
      int count = 0;
      for (int i = intPart.length - 1; i >= 0; i--) {
        if (count > 0 && count % 3 == 0) {
          buffer.write('.');
        }
        buffer.write(intPart[i]);
        count++;
      }
      formatted = buffer.toString().split('').reversed.join();
      if (decPart != null) {
        formatted = '$formatted,$decPart';
      }
    }

    final result = StringBuffer();
    if (prefix != null) result.write(prefix);
    result.write(formatted);
    if (suffix != null) result.write(suffix);

    return result.toString();
  }
}

/// Gecikmeli animasyonlu sayaç
/// Karar verildikten sonra kısa bir bekleme ile başlar
class DelayedAnimatedCounter extends StatefulWidget {
  final double value;
  final String? prefix;
  final String? suffix;
  final TextStyle? style;
  final int decimalPlaces;
  final Duration duration;
  final Duration delay;
  final Curve curve;
  final bool useGrouping;

  const DelayedAnimatedCounter({
    super.key,
    required this.value,
    this.prefix,
    this.suffix,
    this.style,
    this.decimalPlaces = 0,
    this.duration = AppAnimations.counter,
    this.delay = AppAnimations.decisionDelay,
    this.curve = AppAnimations.standardCurve,
    this.useGrouping = true,
  });

  @override
  State<DelayedAnimatedCounter> createState() => _DelayedAnimatedCounterState();
}

class _DelayedAnimatedCounterState extends State<DelayedAnimatedCounter> {
  double _displayValue = 0;
  bool _started = false;

  @override
  void initState() {
    super.initState();
    _startAnimation();
  }

  @override
  void didUpdateWidget(DelayedAnimatedCounter oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (oldWidget.value != widget.value) {
      _startAnimation();
    }
  }

  void _startAnimation() async {
    if (widget.delay > Duration.zero) {
      await Future.delayed(widget.delay);
    }
    if (mounted) {
      setState(() {
        _displayValue = widget.value;
        _started = true;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return TweenAnimationBuilder<double>(
      key: ValueKey(_displayValue),
      tween: Tween<double>(begin: _started ? null : 0, end: _displayValue),
      duration: widget.duration,
      curve: widget.curve,
      builder: (context, animatedValue, child) {
        return Text(_formatValue(animatedValue), style: widget.style);
      },
    );
  }

  String _formatValue(double val) {
    String formatted;

    if (widget.decimalPlaces > 0) {
      formatted = val.toStringAsFixed(widget.decimalPlaces);
    } else {
      formatted = val.toInt().toString();
    }

    if (widget.useGrouping) {
      final parts = formatted.split('.');
      final intPart = parts[0];
      final decPart = parts.length > 1 ? parts[1] : null;

      final buffer = StringBuffer();
      int count = 0;
      for (int i = intPart.length - 1; i >= 0; i--) {
        if (count > 0 && count % 3 == 0) {
          buffer.write('.');
        }
        buffer.write(intPart[i]);
        count++;
      }
      formatted = buffer.toString().split('').reversed.join();
      if (decPart != null) {
        formatted = '$formatted,$decPart';
      }
    }

    final result = StringBuffer();
    if (widget.prefix != null) result.write(widget.prefix);
    result.write(formatted);
    if (widget.suffix != null) result.write(widget.suffix);

    return result.toString();
  }
}

/// Saat ve gün sayacı
/// "12.5 saat" veya "3.2 gün" formatında gösterir
class AnimatedTimeCounter extends StatelessWidget {
  final double hours;
  final TextStyle? valueStyle;
  final TextStyle? unitStyle;
  final Duration duration;
  final Curve curve;
  final bool showDays; // Günleri de göster

  const AnimatedTimeCounter({
    super.key,
    required this.hours,
    this.valueStyle,
    this.unitStyle,
    this.duration = AppAnimations.counter,
    this.curve = AppAnimations.standardCurve,
    this.showDays = true,
  });

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    // 8 saatten fazlaysa gün olarak göster
    final bool displayAsDays = showDays && hours >= 8;
    final double displayValue = displayAsDays ? hours / 8 : hours;
    final String unit = ' ${displayAsDays ? l10n.days : l10n.hours}';

    return TweenAnimationBuilder<double>(
      tween: Tween<double>(begin: 0, end: displayValue),
      duration: duration,
      curve: curve,
      builder: (context, animatedValue, child) {
        final formattedValue = animatedValue < 10
            ? animatedValue.toStringAsFixed(1)
            : animatedValue.toInt().toString();

        return RichText(
          text: TextSpan(
            children: [
              TextSpan(
                text: formattedValue,
                style:
                    valueStyle ??
                    TextStyle(
                      fontSize: 32,
                      fontWeight: FontWeight.w700,
                      color: context.appColors.textPrimary,
                    ),
              ),
              TextSpan(
                text: unit,
                style:
                    unitStyle ??
                    TextStyle(
                      fontSize: 16,
                      fontWeight: FontWeight.w500,
                      color: context.appColors.textSecondary,
                    ),
              ),
            ],
          ),
        );
      },
    );
  }
}

/// Premium Number Ticker Widget
/// Her rakam bağımsız olarak slot makinesi gibi döner
class NumberTicker extends StatefulWidget {
  final double value;
  final String? prefix;
  final String? suffix;
  final TextStyle? style;
  final int decimalPlaces;
  final Duration duration;
  final Curve curve;
  final bool useGrouping;

  const NumberTicker({
    super.key,
    required this.value,
    this.prefix,
    this.suffix,
    this.style,
    this.decimalPlaces = 0,
    this.duration = const Duration(milliseconds: 800),
    this.curve = Curves.easeOutCubic,
    this.useGrouping = true,
  });

  @override
  State<NumberTicker> createState() => _NumberTickerState();
}

class _NumberTickerState extends State<NumberTicker> {
  late List<int> _digits;
  late List<int> _oldDigits;
  String _formattedPrefix = '';
  String _formattedSuffix = '';

  @override
  void initState() {
    super.initState();
    _parseValue(widget.value, isInitial: true);
  }

  @override
  void didUpdateWidget(NumberTicker oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (oldWidget.value != widget.value) {
      _oldDigits = List.from(_digits);
      _parseValue(widget.value, isInitial: false);
    }
  }

  void _parseValue(double value, {required bool isInitial}) {
    String formatted;
    if (widget.decimalPlaces > 0) {
      formatted = value.toStringAsFixed(widget.decimalPlaces);
    } else {
      formatted = value.toInt().abs().toString();
    }

    // Apply grouping
    if (widget.useGrouping && widget.decimalPlaces == 0) {
      final buffer = StringBuffer();
      int count = 0;
      for (int i = formatted.length - 1; i >= 0; i--) {
        if (count > 0 && count % 3 == 0) {
          buffer.write('.');
        }
        buffer.write(formatted[i]);
        count++;
      }
      formatted = buffer.toString().split('').reversed.join();
    }

    // Parse digits and separators
    final List<int> newDigits = [];
    for (int i = 0; i < formatted.length; i++) {
      final char = formatted[i];
      if (char == '.' || char == ',') {
        newDigits.add(-1); // Separator marker
      } else {
        newDigits.add(int.parse(char));
      }
    }

    if (isInitial) {
      _oldDigits = List.filled(newDigits.length, 0);
    }

    // Pad old digits if needed
    while (_oldDigits.length < newDigits.length) {
      _oldDigits.insert(0, 0);
    }

    _digits = newDigits;
    _formattedPrefix = widget.prefix ?? '';
    _formattedSuffix = widget.suffix ?? '';
  }

  @override
  Widget build(BuildContext context) {
    final effectiveStyle =
        widget.style ?? Theme.of(context).textTheme.headlineMedium;

    return Row(
      mainAxisSize: MainAxisSize.min,
      crossAxisAlignment: CrossAxisAlignment.baseline,
      textBaseline: TextBaseline.alphabetic,
      children: [
        // Prefix
        if (_formattedPrefix.isNotEmpty)
          Text(_formattedPrefix, style: effectiveStyle),

        // Digits
        ..._digits.asMap().entries.map((entry) {
          final index = entry.key;
          final digit = entry.value;

          if (digit == -1) {
            // Separator (dot or comma)
            return Text(
              widget.decimalPlaces > 0 &&
                      index == _digits.length - widget.decimalPlaces - 1
                  ? ','
                  : '.',
              style: effectiveStyle,
            );
          }

          final oldDigit = index < _oldDigits.length ? _oldDigits[index] : 0;

          return _TickerDigit(
            digit: digit,
            oldDigit: oldDigit < 0 ? 0 : oldDigit,
            style: effectiveStyle!,
            duration: widget.duration,
            curve: widget.curve,
            delay: Duration(milliseconds: 50 * index),
          );
        }),

        // Suffix
        if (_formattedSuffix.isNotEmpty)
          Text(_formattedSuffix, style: effectiveStyle),
      ],
    );
  }
}

class _TickerDigit extends StatefulWidget {
  final int digit;
  final int oldDigit;
  final TextStyle style;
  final Duration duration;
  final Curve curve;
  final Duration delay;

  const _TickerDigit({
    required this.digit,
    required this.oldDigit,
    required this.style,
    required this.duration,
    required this.curve,
    required this.delay,
  });

  @override
  State<_TickerDigit> createState() => _TickerDigitState();
}

class _TickerDigitState extends State<_TickerDigit>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _animation;
  late int _currentDigit;
  late int _targetDigit;

  @override
  void initState() {
    super.initState();
    _currentDigit = widget.oldDigit;
    _targetDigit = widget.digit;

    _controller = AnimationController(duration: widget.duration, vsync: this);

    _animation = CurvedAnimation(parent: _controller, curve: widget.curve);

    _startAnimation();
  }

  void _startAnimation() async {
    if (widget.delay > Duration.zero) {
      await Future.delayed(widget.delay);
    }
    if (mounted) {
      _controller.forward();
    }
  }

  @override
  void didUpdateWidget(_TickerDigit oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (oldWidget.digit != widget.digit) {
      _currentDigit = oldWidget.digit;
      _targetDigit = widget.digit;
      _controller.reset();
      _startAnimation();
    }
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: _animation,
      builder: (context, child) {
        // Calculate scroll offset
        final diff = _targetDigit - _currentDigit;
        final progress = _animation.value;

        return ClipRect(
          child: SizedBox(
            width: _getDigitWidth(),
            height: widget.style.fontSize! * 1.2,
            child: Stack(
              children: [
                // Old digit sliding out
                Positioned(
                  top:
                      -widget.style.fontSize! *
                      1.2 *
                      progress *
                      (diff > 0 ? 1 : -1),
                  left: 0,
                  right: 0,
                  child: Opacity(
                    opacity: 1 - progress,
                    child: Text(
                      _currentDigit.toString(),
                      style: widget.style,
                      textAlign: TextAlign.center,
                    ),
                  ),
                ),
                // New digit sliding in
                Positioned(
                  top:
                      widget.style.fontSize! *
                      1.2 *
                      (1 - progress) *
                      (diff > 0 ? 1 : -1),
                  left: 0,
                  right: 0,
                  child: Opacity(
                    opacity: progress,
                    child: Text(
                      _targetDigit.toString(),
                      style: widget.style,
                      textAlign: TextAlign.center,
                    ),
                  ),
                ),
              ],
            ),
          ),
        );
      },
    );
  }

  double _getDigitWidth() {
    final textPainter = TextPainter(
      text: TextSpan(text: '0', style: widget.style),
      textDirection: TextDirection.ltr,
    )..layout();
    return textPainter.width * 1.1; // Slight padding
  }
}

/// Flip Clock Style Number Ticker
/// Premium flip-card animation like airport departure boards
class FlipNumberTicker extends StatefulWidget {
  final double value;
  final String? prefix;
  final String? suffix;
  final TextStyle? style;
  final Color? backgroundColor;
  final int decimalPlaces;
  final Duration duration;

  const FlipNumberTicker({
    super.key,
    required this.value,
    this.prefix,
    this.suffix,
    this.style,
    this.backgroundColor,
    this.decimalPlaces = 0,
    this.duration = const Duration(milliseconds: 600),
  });

  @override
  State<FlipNumberTicker> createState() => _FlipNumberTickerState();
}

class _FlipNumberTickerState extends State<FlipNumberTicker> {
  late String _currentValue;
  late String _oldValue;

  @override
  void initState() {
    super.initState();
    _currentValue = _formatValue(widget.value);
    _oldValue = _currentValue;
  }

  @override
  void didUpdateWidget(FlipNumberTicker oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (oldWidget.value != widget.value) {
      _oldValue = _currentValue;
      _currentValue = _formatValue(widget.value);
    }
  }

  String _formatValue(double value) {
    if (widget.decimalPlaces > 0) {
      return value.toStringAsFixed(widget.decimalPlaces);
    }
    return value.toInt().abs().toString();
  }

  @override
  Widget build(BuildContext context) {
    final effectiveStyle =
        widget.style ??
        Theme.of(
          context,
        ).textTheme.headlineLarge?.copyWith(fontWeight: FontWeight.bold);
    final bgColor = widget.backgroundColor ?? context.appColors.cardBackground;

    // Pad to same length
    final maxLen = math.max(_currentValue.length, _oldValue.length);
    final paddedOld = _oldValue.padLeft(maxLen, '0');
    final paddedCurrent = _currentValue.padLeft(maxLen, '0');

    return Row(
      mainAxisSize: MainAxisSize.min,
      children: [
        if (widget.prefix != null)
          Padding(
            padding: const EdgeInsets.only(right: 4),
            child: Text(widget.prefix!, style: effectiveStyle),
          ),
        ...List.generate(maxLen, (index) {
          final oldChar = paddedOld[index];
          final newChar = paddedCurrent[index];

          return Padding(
            padding: const EdgeInsets.symmetric(horizontal: 1),
            child: _FlipCard(
              oldValue: oldChar,
              newValue: newChar,
              style: effectiveStyle!,
              backgroundColor: bgColor,
              duration: widget.duration,
              delay: Duration(milliseconds: 80 * index),
            ),
          );
        }),
        if (widget.suffix != null)
          Padding(
            padding: const EdgeInsets.only(left: 4),
            child: Text(widget.suffix!, style: effectiveStyle),
          ),
      ],
    );
  }
}

class _FlipCard extends StatefulWidget {
  final String oldValue;
  final String newValue;
  final TextStyle style;
  final Color backgroundColor;
  final Duration duration;
  final Duration delay;

  const _FlipCard({
    required this.oldValue,
    required this.newValue,
    required this.style,
    required this.backgroundColor,
    required this.duration,
    required this.delay,
  });

  @override
  State<_FlipCard> createState() => _FlipCardState();
}

class _FlipCardState extends State<_FlipCard>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _flipAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(duration: widget.duration, vsync: this);

    _flipAnimation = Tween<double>(begin: 0, end: 1).animate(
      CurvedAnimation(parent: _controller, curve: Curves.easeInOutQuart),
    );

    _startAnimation();
  }

  void _startAnimation() async {
    await Future.delayed(widget.delay);
    if (mounted && widget.oldValue != widget.newValue) {
      _controller.forward();
    }
  }

  @override
  void didUpdateWidget(_FlipCard oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (oldWidget.newValue != widget.newValue) {
      _controller.reset();
      _startAnimation();
    }
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final size = widget.style.fontSize! * 1.4;

    return SizedBox(
      width: size * 0.7,
      height: size,
      child: AnimatedBuilder(
        animation: _flipAnimation,
        builder: (context, child) {
          final progress = _flipAnimation.value;

          return Stack(
            children: [
              // Background card
              Container(
                decoration: BoxDecoration(
                  color: widget.backgroundColor,
                  borderRadius: BorderRadius.circular(4),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withValues(alpha: 0.2),
                      blurRadius: 4,
                      offset: const Offset(0, 2),
                    ),
                  ],
                ),
              ),

              // Static bottom half (new value)
              Positioned(
                top: size / 2,
                left: 0,
                right: 0,
                bottom: 0,
                child: ClipRect(
                  child: Align(
                    alignment: Alignment.topCenter,
                    child: Text(widget.newValue, style: widget.style),
                  ),
                ),
              ),

              // Animated top half
              if (progress < 0.5)
                Transform(
                  alignment: Alignment.bottomCenter,
                  transform: Matrix4.identity()
                    ..setEntry(3, 2, 0.002)
                    ..rotateX(-progress * math.pi),
                  child: Container(
                    height: size / 2,
                    decoration: BoxDecoration(
                      color: widget.backgroundColor,
                      borderRadius: const BorderRadius.vertical(
                        top: Radius.circular(4),
                      ),
                    ),
                    child: ClipRect(
                      child: Align(
                        alignment: Alignment.bottomCenter,
                        child: Text(widget.oldValue, style: widget.style),
                      ),
                    ),
                  ),
                ),

              // Animated bottom half (flipping in)
              if (progress >= 0.5)
                Positioned(
                  top: size / 2,
                  left: 0,
                  right: 0,
                  child: Transform(
                    alignment: Alignment.topCenter,
                    transform: Matrix4.identity()
                      ..setEntry(3, 2, 0.002)
                      ..rotateX((1 - progress) * math.pi),
                    child: Container(
                      height: size / 2,
                      decoration: BoxDecoration(
                        color: widget.backgroundColor,
                        borderRadius: const BorderRadius.vertical(
                          bottom: Radius.circular(4),
                        ),
                      ),
                      child: ClipRect(
                        child: Align(
                          alignment: Alignment.topCenter,
                          child: Text(widget.newValue, style: widget.style),
                        ),
                      ),
                    ),
                  ),
                ),

              // Divider line
              Positioned(
                top: size / 2 - 0.5,
                left: 0,
                right: 0,
                child: Container(
                  height: 1,
                  color: Colors.black.withValues(alpha: 0.3),
                ),
              ),
            ],
          );
        },
      ),
    );
  }
}


--- FILE: lib/widgets/create_pursuit_sheet.dart ---

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';
import '../providers/providers.dart';
import '../services/analytics_service.dart';
import '../theme/quiet_luxury.dart';
import '../utils/emoji_helper.dart';
import 'upgrade_dialog.dart';

/// Bottom sheet for creating or editing a pursuit
class CreatePursuitSheet extends StatefulWidget {
  final Pursuit? pursuit; // If provided, edit mode

  const CreatePursuitSheet({super.key, this.pursuit});

  @override
  State<CreatePursuitSheet> createState() => _CreatePursuitSheetState();
}

class _CreatePursuitSheetState extends State<CreatePursuitSheet> {
  final _nameController = TextEditingController();
  final _targetController = TextEditingController();
  final _initialSavingsController = TextEditingController();
  final _formKey = GlobalKey<FormState>();

  PursuitCategory _selectedCategory = PursuitCategory.other;
  String _selectedEmoji = '📦';
  bool _isLoading = false;

  bool get _isEditMode => widget.pursuit != null;

  @override
  void initState() {
    super.initState();
    if (widget.pursuit != null) {
      _nameController.text = widget.pursuit!.name;
      _targetController.text = widget.pursuit!.targetAmount.toStringAsFixed(0);
      _selectedCategory = widget.pursuit!.category;
      _selectedEmoji = widget.pursuit!.emoji;
    }
  }

  @override
  void dispose() {
    _nameController.dispose();
    _targetController.dispose();
    _initialSavingsController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final currencyProvider = context.watch<CurrencyProvider>();
    final currencySymbol = currencyProvider.currency.symbol;

    return Container(
      decoration: BoxDecoration(
        color: QuietLuxury.background,
        borderRadius: const BorderRadius.vertical(top: Radius.circular(20)),
      ),
      child: SafeArea(
        child: Padding(
          padding: EdgeInsets.only(
            left: 20,
            right: 20,
            top: 16,
            bottom: MediaQuery.of(context).viewInsets.bottom + 16,
          ),
          child: Form(
            key: _formKey,
            child: SingleChildScrollView(
              child: Column(
                mainAxisSize: MainAxisSize.min,
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // Handle bar
                  Center(
                    child: Container(
                      width: 40,
                      height: 4,
                      decoration: BoxDecoration(
                        color: QuietLuxury.cardBorder,
                        borderRadius: BorderRadius.circular(2),
                      ),
                    ),
                  ),
                  const SizedBox(height: 20),

                  // Title
                  Text(
                    _isEditMode ? l10n.editPursuit : l10n.createPursuit,
                    style: QuietLuxury.heading,
                  ),
                  const SizedBox(height: 24),

                  // Name input
                  _buildLabel(l10n.pursuitName),
                  const SizedBox(height: 8),
                  TextFormField(
                    controller: _nameController,
                    keyboardType: TextInputType.text,
                    enableSuggestions: true,
                    autocorrect: false,
                    enableIMEPersonalizedLearning: true,
                    style: QuietLuxury.body.copyWith(
                      color: QuietLuxury.textPrimary,
                    ),
                    decoration: _inputDecoration(
                      hintText: l10n.pursuitNameHint,
                    ),
                    validator: (value) {
                      if (value == null || value.trim().isEmpty) {
                        return l10n.pursuitNameRequired;
                      }
                      return null;
                    },
                    textCapitalization: TextCapitalization.sentences,
                  ),
                  const SizedBox(height: 20),

                  // Target amount
                  _buildLabel(l10n.targetAmount),
                  const SizedBox(height: 8),
                  TextFormField(
                    controller: _targetController,
                    style: QuietLuxury.body.copyWith(
                      color: QuietLuxury.textPrimary,
                    ),
                    decoration: _inputDecoration(
                      hintText: '0',
                      prefixText: currencySymbol,
                    ),
                    keyboardType: TextInputType.number,
                    inputFormatters: [
                      FilteringTextInputFormatter.digitsOnly,
                      _ThousandsSeparatorFormatter(),
                    ],
                    validator: (value) {
                      if (value == null || value.isEmpty) {
                        return l10n.pursuitAmountRequired;
                      }
                      final amount = _parseAmount(value);
                      if (amount <= 0) {
                        return l10n.pursuitAmountInvalid;
                      }
                      return null;
                    },
                  ),
                  const SizedBox(height: 20),

                  // Category selection
                  _buildLabel(l10n.pursuitSelectCategory),
                  const SizedBox(height: 12),
                  _buildCategoryGrid(),
                  const SizedBox(height: 20),

                  // Initial savings (only for new pursuits)
                  if (!_isEditMode) ...[
                    _buildLabel(l10n.pursuitInitialSavings),
                    const SizedBox(height: 8),
                    TextFormField(
                      controller: _initialSavingsController,
                      style: QuietLuxury.body.copyWith(
                        color: QuietLuxury.textPrimary,
                      ),
                      decoration: _inputDecoration(
                        hintText: l10n.pursuitInitialSavingsHint,
                        prefixText: currencySymbol,
                      ),
                      keyboardType: TextInputType.number,
                      inputFormatters: [
                        FilteringTextInputFormatter.digitsOnly,
                        _ThousandsSeparatorFormatter(),
                      ],
                    ),
                    const SizedBox(height: 24),
                  ],

                  // Create/Save button
                  SizedBox(
                    width: double.infinity,
                    child: ElevatedButton(
                      onPressed: _isLoading ? null : _onSubmit,
                      style: ElevatedButton.styleFrom(
                        backgroundColor: QuietLuxury.positive,
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(vertical: 16),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(16),
                        ),
                        disabledBackgroundColor: QuietLuxury.positive
                            .withValues(alpha: 0.5),
                      ),
                      child: _isLoading
                          ? const SizedBox(
                              width: 20,
                              height: 20,
                              child: CircularProgressIndicator(
                                strokeWidth: 2,
                                valueColor: AlwaysStoppedAnimation<Color>(
                                  Colors.white,
                                ),
                              ),
                            )
                          : Text(
                              _isEditMode ? l10n.save : l10n.createPursuit,
                              style: const TextStyle(
                                fontSize: 16,
                                fontWeight: FontWeight.w600,
                              ),
                            ),
                    ),
                  ),
                  const SizedBox(height: 8),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildLabel(String text) {
    return Text(
      text,
      style: QuietLuxury.label.copyWith(
        color: QuietLuxury.textSecondary,
        fontWeight: FontWeight.w500,
      ),
    );
  }

  InputDecoration _inputDecoration({String? hintText, String? prefixText}) {
    return InputDecoration(
      hintText: hintText,
      prefixText: prefixText,
      hintStyle: QuietLuxury.body.copyWith(color: QuietLuxury.textTertiary),
      prefixStyle: QuietLuxury.body.copyWith(color: QuietLuxury.textSecondary),
      filled: true,
      fillColor: QuietLuxury.cardBackground,
      border: OutlineInputBorder(
        borderRadius: BorderRadius.circular(16),
        borderSide: BorderSide(color: QuietLuxury.cardBorder),
      ),
      enabledBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(16),
        borderSide: BorderSide(color: QuietLuxury.cardBorder),
      ),
      focusedBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(16),
        borderSide: BorderSide(
          color: QuietLuxury.positive.withValues(alpha: 0.5),
        ),
      ),
      errorBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(16),
        borderSide: BorderSide(color: QuietLuxury.negative),
      ),
      contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
    );
  }

  Widget _buildCategoryGrid() {
    return Wrap(
      spacing: 8,
      runSpacing: 8,
      children: PursuitCategory.values.map((category) {
        final isSelected = category == _selectedCategory;
        final categoryLabel = _getCategoryLabel(category);
        return Semantics(
          label: categoryLabel,
          selected: isSelected,
          button: true,
          child: GestureDetector(
            onTap: () {
              HapticFeedback.selectionClick();
              setState(() {
                _selectedCategory = category;
                _selectedEmoji = category.emoji;
              });
            },
            child: AnimatedContainer(
              duration: const Duration(milliseconds: 200),
              padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
              decoration: BoxDecoration(
                color: isSelected
                    ? QuietLuxury.positive.withValues(alpha: 0.2)
                    : QuietLuxury.cardBackground,
                borderRadius: BorderRadius.circular(24),
                border: Border.all(
                  color: isSelected
                      ? QuietLuxury.positive.withValues(alpha: 0.5)
                      : QuietLuxury.cardBorder,
                  width: isSelected ? 1.5 : 0.5,
                ),
              ),
              child: Row(
                mainAxisSize: MainAxisSize.min,
                children: [
                  Text(category.emoji, style: const TextStyle(fontSize: 16)),
                  const SizedBox(width: 6),
                  Text(
                    _getCategoryLabel(category),
                    style: QuietLuxury.label.copyWith(
                      color: isSelected
                          ? QuietLuxury.positive
                          : QuietLuxury.textSecondary,
                      fontWeight: isSelected
                          ? FontWeight.w600
                          : FontWeight.w400,
                    ),
                  ),
                ],
              ),
            ),
          ),
        );
      }).toList(),
    );
  }

  String _getCategoryLabel(PursuitCategory category) {
    final l10n = AppLocalizations.of(context);
    switch (category) {
      case PursuitCategory.tech:
        return l10n.pursuitCategoryTech;
      case PursuitCategory.travel:
        return l10n.pursuitCategoryTravel;
      case PursuitCategory.home:
        return l10n.pursuitCategoryHome;
      case PursuitCategory.fashion:
        return l10n.pursuitCategoryFashion;
      case PursuitCategory.vehicle:
        return l10n.pursuitCategoryVehicle;
      case PursuitCategory.education:
        return l10n.pursuitCategoryEducation;
      case PursuitCategory.health:
        return l10n.pursuitCategoryHealth;
      case PursuitCategory.other:
        return l10n.pursuitCategoryOther;
    }
  }

  double _parseAmount(String value) {
    // Handle Turkish number format (1.234,56)
    final cleaned = value
        .replaceAll('.', '')
        .replaceAll(',', '.')
        .replaceAll(RegExp(r'[^\d.]'), '');
    return double.tryParse(cleaned) ?? 0;
  }

  Future<void> _onSubmit() async {
    if (!_formKey.currentState!.validate()) return;

    setState(() => _isLoading = true);

    final l10n = AppLocalizations.of(context);
    final pursuitProvider = context.read<PursuitProvider>();
    final proProvider = context.read<ProProvider>();
    final currencyProvider = context.read<CurrencyProvider>();

    try {
      final targetAmount = _parseAmount(_targetController.text);
      final initialSavings = _parseAmount(_initialSavingsController.text);

      if (_isEditMode) {
        // Update existing pursuit
        final updated = widget.pursuit!.copyWith(
          name: _nameController.text.trim(),
          targetAmount: targetAmount,
          category: _selectedCategory,
          emoji: _selectedEmoji,
        );
        await pursuitProvider.updatePursuit(updated);
        HapticFeedback.mediumImpact();
        if (mounted) {
          Navigator.of(context).pop(true);
        }
      } else {
        // Create new pursuit
        final name = _nameController.text.trim();

        // Get smart emoji based on name, fallback to selected/category emoji
        final smartEmoji = getDefaultPursuitEmoji(name);
        final finalEmoji = hasSmartEmoji(name) ? smartEmoji : _selectedEmoji;

        final pursuit = Pursuit.create(
          name: name,
          targetAmount: targetAmount,
          currency: currencyProvider.currency.code,
          category: _selectedCategory,
          emoji: finalEmoji,
          initialSavings: initialSavings,
        );

        final success = await pursuitProvider.createPursuit(
          pursuit,
          isPremium: proProvider.isPro,
        );

        if (!success) {
          // Free tier limit reached - show upgrade dialog
          HapticFeedback.heavyImpact();
          setState(() => _isLoading = false);
          if (mounted) {
            Navigator.of(context).pop(); // Close the sheet first
            UpgradeDialog.show(context, l10n.pursuitLimitReachedFree);
          }
          return;
        }

        // Track pursuit created
        AnalyticsService().logPursuitCreatedSimple();
        AnalyticsService().logPursuitCreated(
          category: _selectedCategory.name,
          targetAmount: targetAmount,
        );

        HapticFeedback.mediumImpact();
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text(l10n.pursuitCreated),
              backgroundColor: QuietLuxury.positive,
              behavior: SnackBarBehavior.floating,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(8),
              ),
            ),
          );
          Navigator.of(context).pop(true);
        }
      }
    } catch (e) {
      HapticFeedback.heavyImpact();
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('${l10n.error}: $e'),
            backgroundColor: QuietLuxury.negative,
          ),
        );
      }
    } finally {
      if (mounted) {
        setState(() => _isLoading = false);
      }
    }
  }
}

/// Input formatter for thousands separator
class _ThousandsSeparatorFormatter extends TextInputFormatter {
  @override
  TextEditingValue formatEditUpdate(
    TextEditingValue oldValue,
    TextEditingValue newValue,
  ) {
    if (newValue.text.isEmpty) return newValue;

    final digits = newValue.text.replaceAll('.', '');
    if (digits.isEmpty) return newValue;

    final number = int.tryParse(digits);
    if (number == null) return oldValue;

    final formatted = formatWithThousandsSeparator(number);

    return TextEditingValue(
      text: formatted,
      selection: TextSelection.collapsed(offset: formatted.length),
    );
  }

  String formatWithThousandsSeparator(int number) {
    final str = number.toString();
    final result = StringBuffer();
    for (var i = 0; i < str.length; i++) {
      if (i > 0 && (str.length - i) % 3 == 0) {
        result.write('.');
      }
      result.write(str[i]);
    }
    return result.toString();
  }
}

/// Show the create pursuit sheet
Future<bool?> showCreatePursuitSheet(BuildContext context, {Pursuit? pursuit}) {
  return showModalBottomSheet<bool>(
    context: context,
    isScrollControlled: true,
    barrierColor: Colors.black.withValues(alpha: 0.85),
    backgroundColor: Colors.transparent,
    builder: (_) => CreatePursuitSheet(pursuit: pursuit),
  );
}


--- FILE: lib/widgets/expense_form_content.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';
import '../services/services.dart';
import '../theme/theme.dart';
import '../utils/currency_helper.dart';
import 'labeled_text_field.dart';
import 'turkish_currency_input.dart';
import 'smart_choice_toggle.dart';

/// Harcama formu içeriği - Modal ve inline kullanım için
class ExpenseFormContent extends StatefulWidget {
  final Expense? editingExpense;
  final Function(ExpenseFormData) onSubmit;
  final VoidCallback? onCancel;
  final String submitLabel;
  final bool showSmartChoice;

  const ExpenseFormContent({
    super.key,
    this.editingExpense,
    required this.onSubmit,
    this.onCancel,
    this.submitLabel = 'Kaydet',
    this.showSmartChoice = true,
  });

  @override
  State<ExpenseFormContent> createState() => ExpenseFormContentState();
}

class ExpenseFormContentState extends State<ExpenseFormContent>
    with SingleTickerProviderStateMixin {
  final _amountController = TextEditingController();
  final _descriptionController = TextEditingController();
  final _subCategoryController = TextEditingController();
  final _subCategoryFocusNode = FocusNode();

  String? _selectedCategory;
  DateTime _selectedDate = DateTime.now();
  double? _smartChoiceSavedFrom;
  bool _showSubCategorySuggestions = false;
  SubCategorySuggestions? _subCategorySuggestions;

  // Currency
  static const List<String> _availableCurrencies = ['TRY', 'USD', 'EUR', 'GBP'];
  String _selectedCurrencyCode = 'TRY';

  // Smart Match
  late AnimationController _smartMatchAnimController;
  late Animation<double> _smartMatchScale;
  bool _smartMatchActive = false;
  bool _categoryValidationError = false;
  bool _userManuallySelectedCategory = false;

  // Dirty tracking
  bool _isDirty = false;
  String _initialAmount = '';
  String _initialDescription = '';
  String? _initialCategory;

  @override
  void initState() {
    super.initState();

    // Smart match animasyonu
    _smartMatchAnimController = AnimationController(
      duration: const Duration(milliseconds: 300),
      vsync: this,
    );
    _smartMatchScale = Tween<double>(begin: 1.0, end: 1.05).animate(
      CurvedAnimation(
        parent: _smartMatchAnimController,
        curve: Curves.easeOutBack,
      ),
    );

    // Editing mode
    if (widget.editingExpense != null) {
      final expense = widget.editingExpense!;
      // Use original amount and currency if available, otherwise use converted amount
      if (expense.originalAmount != null && expense.originalCurrency != null) {
        _amountController.text = formatTurkishCurrency(expense.originalAmount!);
        _selectedCurrencyCode = expense.originalCurrency!;
      } else {
        _amountController.text = formatTurkishCurrency(expense.amount);
      }
      _selectedCategory = expense.category;
      _selectedDate = expense.date;
      if (expense.subCategory != null) {
        _subCategoryController.text = expense.subCategory!;
      }
      _userManuallySelectedCategory = true;
    }

    // Track initial values
    _initialAmount = _amountController.text;
    _initialDescription = _descriptionController.text;
    _initialCategory = _selectedCategory;

    // Listeners
    _amountController.addListener(_checkDirty);
    _descriptionController.addListener(_checkDirty);

    _subCategoryFocusNode.addListener(() {
      if (_subCategoryFocusNode.hasFocus) {
        setState(() => _showSubCategorySuggestions = true);
      }
    });

    _loadSubCategorySuggestions();
  }

  @override
  void dispose() {
    _amountController.dispose();
    _descriptionController.dispose();
    _subCategoryController.dispose();
    _subCategoryFocusNode.dispose();
    _smartMatchAnimController.dispose();
    super.dispose();
  }

  void _checkDirty() {
    final isDirty =
        _amountController.text != _initialAmount ||
        _descriptionController.text != _initialDescription ||
        _selectedCategory != _initialCategory;
    if (isDirty != _isDirty) {
      setState(() => _isDirty = isDirty);
    }
  }

  /// Dışarıdan dirty kontrolü için
  bool get isDirty => _isDirty;

  Future<void> _loadSubCategorySuggestions() async {
    if (_selectedCategory == null) {
      if (mounted) setState(() => _subCategorySuggestions = null);
      return;
    }
    final suggestions = await SubCategoryService().getSuggestions(
      _selectedCategory!,
    );
    if (mounted) setState(() => _subCategorySuggestions = suggestions);
  }

  void _onDescriptionChanged(String text) {
    if (_userManuallySelectedCategory) return;

    final predicted = CategoryLearningService.predictCategory(text);
    if (predicted != null && ExpenseCategory.all.contains(predicted)) {
      setState(() {
        _selectedCategory = predicted;
        _smartMatchActive = true;
        _categoryValidationError = false;
      });
      _smartMatchAnimController.forward().then((_) {
        _smartMatchAnimController.reverse();
      });
      _loadSubCategorySuggestions();
    }
    _checkDirty();
  }

  void _onCategoryManuallySelected(String? category) {
    if (category == null) return;

    setState(() {
      _selectedCategory = category;
      _userManuallySelectedCategory = true;
      _categoryValidationError = false;
      _smartMatchActive = false;
    });

    _loadSubCategorySuggestions();

    final description = _descriptionController.text.trim();
    if (description.isNotEmpty) {
      CategoryLearningService.learn(description, category);
    }
    _checkDirty();
  }

  void _selectSubCategory(String subCategory) {
    _subCategoryController.text = subCategory;
    setState(() => _showSubCategorySuggestions = false);
    _subCategoryFocusNode.unfocus();
  }

  Future<void> _showDatePicker() async {
    final l10n = AppLocalizations.of(context);
    final picked = await showDatePicker(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      initialDate: _selectedDate,
      firstDate: DateTime.now().subtract(const Duration(days: 365)),
      lastDate: DateTime.now(),
      helpText: l10n.selectExpenseDate,
      cancelText: l10n.cancel,
      confirmText: l10n.select,
      builder: (context, child) {
        return Theme(
          data: Theme.of(context).copyWith(
            colorScheme: ColorScheme.dark(
              primary: context.appColors.primary,
              onPrimary: context.appColors.background,
              surface: context.appColors.surface,
              onSurface: context.appColors.textPrimary,
            ),
          ),
          child: child!,
        );
      },
    );

    if (picked != null) {
      setState(() => _selectedDate = picked);
      _checkDirty();
    }
  }

  void _submit() {
    final l10n = AppLocalizations.of(context);
    final amount = parseTurkishCurrency(_amountController.text);

    if (amount == null || amount <= 0) {
      _showError(l10n.pleaseEnterValidAmount);
      return;
    }

    if (amount > 100000000) {
      _showError(l10n.amountTooHigh);
      return;
    }

    if (_selectedCategory == null) {
      setState(() => _categoryValidationError = true);
      _showError(l10n.pleaseSelectCategory);
      return;
    }

    HapticFeedback.mediumImpact();

    widget.onSubmit(
      ExpenseFormData(
        amount: amount,
        category: _selectedCategory!,
        currencyCode: _selectedCurrencyCode,
        subCategory: _subCategoryController.text.trim().isEmpty
            ? null
            : SubCategoryService.normalize(_subCategoryController.text.trim()),
        description: _descriptionController.text.trim().isEmpty
            ? null
            : _descriptionController.text.trim(),
        date: _selectedDate,
        savedFrom: _smartChoiceSavedFrom,
        isSmartChoice:
            _smartChoiceSavedFrom != null && _smartChoiceSavedFrom! > amount,
      ),
    );
  }

  void _showError(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: context.appColors.error,
        behavior: SnackBarBehavior.floating,
      ),
    );
  }

  String _formatDate(DateTime date, AppLocalizations l10n) {
    final now = DateTime.now();
    final today = DateTime(now.year, now.month, now.day);
    final yesterday = today.subtract(const Duration(days: 1));
    final dateOnly = DateTime(date.year, date.month, date.day);

    if (dateOnly == today) return l10n.today;
    if (dateOnly == yesterday) return l10n.yesterday;

    final months = [
      l10n.monthJan,
      l10n.monthFeb,
      l10n.monthMar,
      l10n.monthApr,
      l10n.monthMay,
      l10n.monthJun,
      l10n.monthJul,
      l10n.monthAug,
      l10n.monthSep,
      l10n.monthOct,
      l10n.monthNov,
      l10n.monthDec,
    ];
    return '${date.day} ${months[date.month - 1]} ${date.year}';
  }

  Widget _buildCurrencyDropdown() {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
      decoration: BoxDecoration(
        color: context.appColors.surfaceLight,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: context.appColors.cardBorder),
      ),
      child: DropdownButtonHideUnderline(
        child: DropdownButton<String>(
          value: _selectedCurrencyCode,
          icon: Icon(
            CupertinoIcons.chevron_down,
            size: 14,
            color: context.appColors.textSecondary,
          ),
          dropdownColor: context.appColors.cardBackground,
          borderRadius: BorderRadius.circular(16),
          style: TextStyle(
            fontSize: 14,
            fontWeight: FontWeight.w500,
            color: context.appColors.textPrimary,
          ),
          items: _availableCurrencies.map((code) {
            return DropdownMenuItem<String>(
              value: code,
              child: Text(
                CurrencyHelper.getDisplay(code),
                style: TextStyle(
                  fontSize: 14,
                  fontWeight: _selectedCurrencyCode == code
                      ? FontWeight.w600
                      : FontWeight.w400,
                  color: context.appColors.textPrimary,
                ),
              ),
            );
          }).toList(),
          onChanged: (code) {
            if (code != null) {
              HapticFeedback.selectionClick();
              setState(() => _selectedCurrencyCode = code);
            }
          },
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // 1. Amount with Currency
        Row(
          crossAxisAlignment: CrossAxisAlignment.end,
          children: [
            // Currency dropdown
            _buildCurrencyDropdown(),
            const SizedBox(width: 12),
            // Amount field
            Expanded(
              child: LabeledTextField(
                controller: _amountController,
                label: l10n.amount,
                keyboardType: const TextInputType.numberWithOptions(
                  decimal: true,
                ),
                hint: '0,00',
                inputFormatters: [TurkishCurrencyInputFormatter()],
              ),
            ),
          ],
        ),

        const SizedBox(height: 16),

        // Bilinçli Tercih (Smart Choice)
        if (widget.showSmartChoice)
          SmartChoiceToggle(
            selectedCategory: _selectedCategory,
            currentAmount: parseTurkishCurrency(_amountController.text) ?? 0,
            onSavedFromChanged: (value) {
              setState(() => _smartChoiceSavedFrom = value);
            },
          ),

        if (widget.showSmartChoice) const SizedBox(height: 16),

        // 2. Description
        TextField(
          controller: _descriptionController,
          keyboardType: TextInputType.text,
          enableSuggestions: true,
          autocorrect: false,
          enableIMEPersonalizedLearning: true,
          style: TextStyle(color: context.appColors.textPrimary, fontSize: 14),
          decoration: InputDecoration(
            labelText: l10n.descriptionLabel,
            labelStyle: TextStyle(
              color: context.appColors.textSecondary,
              fontSize: 14,
            ),
            hintText: l10n.descriptionHint,
            hintStyle: TextStyle(
              color: context.appColors.textTertiary,
              fontSize: 14,
            ),
            filled: true,
            fillColor: context.appColors.surfaceLight,
            contentPadding: const EdgeInsets.symmetric(
              horizontal: 16,
              vertical: 14,
            ),
            border: OutlineInputBorder(
              borderRadius: BorderRadius.circular(16),
              borderSide: BorderSide(color: context.appColors.cardBorder),
            ),
            enabledBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(16),
              borderSide: BorderSide(color: context.appColors.cardBorder),
            ),
            focusedBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(16),
              borderSide: BorderSide(
                color: context.appColors.primary,
                width: 1.5,
              ),
            ),
            suffixIcon: _smartMatchActive
                ? Padding(
                    padding: const EdgeInsets.only(right: 8),
                    child: Icon(
                      CupertinoIcons.sparkles,
                      size: 18,
                      color: context.appColors.success,
                    ),
                  )
                : null,
          ),
          onChanged: _onDescriptionChanged,
        ),

        const SizedBox(height: 16),

        // 3. Kategori
        AnimatedBuilder(
          animation: _smartMatchAnimController,
          builder: (context, child) {
            return Transform.scale(
              scale: _smartMatchActive ? _smartMatchScale.value : 1.0,
              child: Container(
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(16),
                  boxShadow: _smartMatchActive
                      ? [
                          BoxShadow(
                            color: context.appColors.success.withValues(
                              alpha: 0.3,
                            ),
                            blurRadius: 8,
                            spreadRadius: 1,
                          ),
                        ]
                      : _categoryValidationError
                      ? [
                          BoxShadow(
                            color: context.appColors.error.withValues(
                              alpha: 0.3,
                            ),
                            blurRadius: 8,
                            spreadRadius: 1,
                          ),
                        ]
                      : null,
                ),
                child: DropdownButtonFormField<String>(
                  initialValue: _selectedCategory,
                  hint: Text(
                    l10n.selectCategory,
                    style: TextStyle(
                      color: context.appColors.textTertiary,
                      fontSize: 14,
                    ),
                  ),
                  items: ExpenseCategory.all.map((category) {
                    return DropdownMenuItem(
                      value: category,
                      child: Row(
                        children: [
                          Icon(
                            ExpenseCategory.getIcon(category),
                            size: 18,
                            color: ExpenseCategory.getColor(category),
                          ),
                          const SizedBox(width: 8),
                          Text(
                            ExpenseCategory.getLocalizedName(category, l10n),
                          ),
                        ],
                      ),
                    );
                  }).toList(),
                  onChanged: _onCategoryManuallySelected,
                  decoration: InputDecoration(
                    labelText: l10n.category,
                    labelStyle: TextStyle(
                      color: _categoryValidationError
                          ? context.appColors.error
                          : context.appColors.textSecondary,
                      fontSize: 14,
                    ),
                    filled: true,
                    fillColor: context.appColors.surfaceLight,
                    contentPadding: const EdgeInsets.symmetric(
                      horizontal: 16,
                      vertical: 14,
                    ),
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(16),
                      borderSide: BorderSide(
                        color: _categoryValidationError
                            ? context.appColors.error
                            : context.appColors.cardBorder,
                      ),
                    ),
                    enabledBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(16),
                      borderSide: BorderSide(
                        color: _categoryValidationError
                            ? context.appColors.error
                            : (_smartMatchActive
                                  ? context.appColors.success
                                  : context.appColors.cardBorder),
                        width: _smartMatchActive || _categoryValidationError
                            ? 1.5
                            : 1,
                      ),
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(16),
                      borderSide: BorderSide(
                        color: context.appColors.primary,
                        width: 1.5,
                      ),
                    ),
                  ),
                  dropdownColor: context.appColors.surface,
                  style: TextStyle(
                    color: context.appColors.textPrimary,
                    fontSize: 14,
                  ),
                ),
              ),
            );
          },
        ),

        // Smart match indicator
        if (_smartMatchActive && _selectedCategory != null)
          Padding(
            padding: const EdgeInsets.only(top: 6, left: 4),
            child: Row(
              children: [
                Icon(
                  CupertinoIcons.sparkles,
                  size: 14,
                  color: context.appColors.success,
                ),
                const SizedBox(width: 4),
                Text(
                  l10n.autoSelected(
                    ExpenseCategory.getLocalizedName(_selectedCategory!, l10n),
                  ),
                  style: TextStyle(
                    fontSize: 12,
                    color: context.appColors.success,
                  ),
                ),
              ],
            ),
          ),

        const SizedBox(height: 16),

        // 4. Sub-category
        TextField(
          controller: _subCategoryController,
          focusNode: _subCategoryFocusNode,
          keyboardType: TextInputType.text,
          enableSuggestions: true,
          autocorrect: false,
          enableIMEPersonalizedLearning: true,
          style: TextStyle(color: context.appColors.textPrimary, fontSize: 14),
          decoration: InputDecoration(
            hintText: l10n.subCategoryOptional,
            hintStyle: TextStyle(
              color: context.appColors.textTertiary,
              fontSize: 14,
            ),
            filled: true,
            fillColor: context.appColors.surfaceLight,
            contentPadding: const EdgeInsets.symmetric(
              horizontal: 16,
              vertical: 14,
            ),
            border: OutlineInputBorder(
              borderRadius: BorderRadius.circular(16),
              borderSide: BorderSide(color: context.appColors.cardBorder),
            ),
            enabledBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(16),
              borderSide: BorderSide(color: context.appColors.cardBorder),
            ),
            focusedBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(16),
              borderSide: BorderSide(
                color: context.appColors.primary,
                width: 1.5,
              ),
            ),
          ),
          onTap: () => setState(() => _showSubCategorySuggestions = true),
        ),

        // Sub category suggestions
        if (_showSubCategorySuggestions &&
            _subCategorySuggestions != null &&
            !_subCategorySuggestions!.isEmpty)
          _buildSubCategoryChips(),

        const SizedBox(height: 16),

        // 5. Tarih
        GestureDetector(
          onTap: _showDatePicker,
          child: Container(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
            decoration: BoxDecoration(
              color: context.appColors.surfaceLight,
              borderRadius: BorderRadius.circular(16),
              border: Border.all(color: context.appColors.cardBorder),
            ),
            child: Row(
              children: [
                Icon(
                  CupertinoIcons.calendar,
                  size: 20,
                  color: context.appColors.textSecondary,
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        l10n.date,
                        style: TextStyle(
                          fontSize: 11,
                          color: context.appColors.textTertiary,
                        ),
                      ),
                      const SizedBox(height: 2),
                      Text(
                        _formatDate(_selectedDate, l10n),
                        style: TextStyle(
                          fontSize: 14,
                          color: context.appColors.textPrimary,
                          fontWeight: FontWeight.w500,
                        ),
                      ),
                    ],
                  ),
                ),
                Icon(
                  CupertinoIcons.chevron_right,
                  color: context.appColors.textTertiary,
                ),
              ],
            ),
          ),
        ),

        const SizedBox(height: 24),

        // Submit button
        SizedBox(
          width: double.infinity,
          child: ElevatedButton(
            onPressed: _submit,
            style: ElevatedButton.styleFrom(
              backgroundColor: context.appColors.primary,
              foregroundColor: context.appColors.background,
              padding: const EdgeInsets.symmetric(vertical: 16),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(16),
              ),
              elevation: 0,
            ),
            child: Text(
              widget.submitLabel,
              style: const TextStyle(fontSize: 16, fontWeight: FontWeight.w600),
            ),
          ),
        ),

        // Cancel button
        if (widget.onCancel != null) ...[
          const SizedBox(height: 12),
          SizedBox(
            width: double.infinity,
            child: TextButton(
              onPressed: widget.onCancel,
              style: TextButton.styleFrom(
                foregroundColor: context.appColors.textSecondary,
              ),
              child: Text(l10n.cancel),
            ),
          ),
        ],

        const SizedBox(height: 16),
      ],
    );
  }

  Widget _buildSubCategoryChips() {
    final suggestions = _subCategorySuggestions!;
    return Padding(
      padding: const EdgeInsets.only(top: 10),
      child: Wrap(
        spacing: 8,
        runSpacing: 6,
        children: [
          ...suggestions.recent.map(
            (s) => _SubCatChip(
              label: s,
              isRecent: true,
              onTap: () => _selectSubCategory(s),
            ),
          ),
          ...suggestions.fixed.map(
            (s) => _SubCatChip(
              label: s,
              isRecent: false,
              onTap: () => _selectSubCategory(s),
            ),
          ),
        ],
      ),
    );
  }
}

class _SubCatChip extends StatelessWidget {
  final String label;
  final bool isRecent;
  final VoidCallback onTap;

  const _SubCatChip({
    required this.label,
    required this.isRecent,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
        decoration: BoxDecoration(
          color: isRecent ? Colors.transparent : context.appColors.surface,
          borderRadius: BorderRadius.circular(8),
          border: Border.all(
            color: isRecent
                ? context.appColors.primary.withValues(alpha: 0.5)
                : context.appColors.cardBorder,
          ),
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            if (isRecent)
              Padding(
                padding: const EdgeInsets.only(right: 4),
                child: Icon(
                  CupertinoIcons.clock_fill,
                  size: 12,
                  color: context.appColors.primary.withValues(alpha: 0.7),
                ),
              ),
            Text(
              label,
              style: TextStyle(
                fontSize: 13,
                color: isRecent
                    ? context.appColors.primary
                    : context.appColors.textSecondary,
              ),
            ),
          ],
        ),
      ),
    );
  }
}

/// Form verisi
class ExpenseFormData {
  final double amount;
  final String category;
  final String currencyCode;
  final String? subCategory;
  final String? description;
  final DateTime date;
  final double? savedFrom;
  final bool isSmartChoice;

  const ExpenseFormData({
    required this.amount,
    required this.category,
    this.currencyCode = 'TRY',
    this.subCategory,
    this.description,
    required this.date,
    this.savedFrom,
    this.isSmartChoice = false,
  });
}


--- FILE: lib/widgets/share_card_widget.dart ---

import 'package:flutter/material.dart';
import 'package:vantag/l10n/app_localizations.dart';
import 'package:vantag/theme/app_theme.dart';

/// Share card widget
/// Instagram story size: 1080x1920 (3:1 scale = 360x640)
class ShareCardWidget extends StatelessWidget {
  final IconData icon;
  final Color iconColor;
  final String categoryName;
  final int yearlyDays;
  final double? yearlyAmount;
  final String? frequency;

  const ShareCardWidget({
    super.key,
    required this.icon,
    required this.iconColor,
    required this.categoryName,
    required this.yearlyDays,
    this.yearlyAmount,
    this.frequency,
  });

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return Container(
      width: 360,
      height: 640,
      decoration: BoxDecoration(
        gradient: const LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [AppColors.cardBackground, AppColors.primary],
        ),
        borderRadius: BorderRadius.circular(24),
      ),
      padding: const EdgeInsets.symmetric(vertical: 32, horizontal: 24),
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        mainAxisSize: MainAxisSize.min,
        children: [
          // Icon
          Container(
            width: 100,
            height: 100,
            decoration: BoxDecoration(
              color: iconColor.withValues(alpha: 0.2),
              shape: BoxShape.circle,
            ),
            child: Icon(icon, size: 52, color: iconColor),
          ),
          const SizedBox(height: 20),

          // Main number
          Text(
            l10n.shareCardDays(yearlyDays),
            style: const TextStyle(
              fontSize: 56,
              fontWeight: FontWeight.bold,
              color: Colors.white,
            ),
          ),
          const SizedBox(height: 12),

          // Description
          Text(
            l10n.shareCardDescription(categoryName),
            textAlign: TextAlign.center,
            style: const TextStyle(fontSize: 18, color: Color(0xCCFFFFFF)),
          ),

          // Optional: Amount
          if (yearlyAmount != null) ...[
            const SizedBox(height: 12),
            Text(
              '\$${_formatCurrency(yearlyAmount!)}',
              style: const TextStyle(fontSize: 16, color: Color(0x88FFFFFF)),
            ),
          ],

          // Optional: Frequency
          if (frequency != null) ...[
            const SizedBox(height: 8),
            Text(
              frequency!,
              style: const TextStyle(fontSize: 14, color: Color(0x60FFFFFF)),
            ),
          ],

          const SizedBox(height: 32),

          // Divider
          Container(width: 100, height: 1, color: const Color(0x40FFFFFF)),
          const SizedBox(height: 16),

          // CTA
          Text(
            l10n.shareCardQuestion,
            style: const TextStyle(
              fontSize: 18,
              fontWeight: FontWeight.bold,
              color: Colors.white,
            ),
          ),
          const SizedBox(height: 20),

          // Logo/URL
          const Text(
            'vantag.app',
            style: TextStyle(
              fontSize: 14,
              color: Color(0x88FFFFFF),
              letterSpacing: 1,
            ),
          ),
        ],
      ),
    );
  }

  String _formatCurrency(double amount) {
    if (amount >= 1000000) {
      return '${(amount / 1000000).toStringAsFixed(1)}M';
    } else if (amount >= 1000) {
      return '${(amount / 1000).toStringAsFixed(0)},000';
    }
    return amount.toStringAsFixed(0);
  }
}


--- FILE: lib/widgets/collapsible_saved_header.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';
import '../providers/currency_provider.dart';
import '../theme/theme.dart';
import 'animated_counter.dart';

/// Kaydırılabilir header widget'ı
/// Scroll edince küçülür, opacity azalır, scale değişir
class CollapsibleSavedHeader extends StatelessWidget {
  final DecisionStats stats;
  final double expandRatio; // 1.0 = tam açık, 0.0 = tam kapalı

  const CollapsibleSavedHeader({
    super.key,
    required this.stats,
    required this.expandRatio,
  });

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final currencyProvider = context.watch<CurrencyProvider>();

    // Animasyon değerleri
    final opacity =
        AppAnimations.headerMinOpacity +
        ((1.0 - AppAnimations.headerMinOpacity) * expandRatio);
    final scale =
        AppAnimations.headerMinScale +
        ((1.0 - AppAnimations.headerMinScale) * expandRatio);

    // Boyutları expandRatio'ya göre hesapla
    final iconSize = 40.0 + (40.0 * expandRatio); // 40px -> 80px
    final iconContainerSize = 48.0 + (48.0 * expandRatio); // 48px -> 96px
    final amountFontSize = 20.0 + (12.0 * expandRatio); // 20px -> 32px
    final labelFontSize = 12.0 + (4.0 * expandRatio); // 12px -> 16px

    // Parallax offset (yukarı kayma efekti)
    final parallaxOffset = (1.0 - expandRatio) * -10;

    // Hiç kurtarılan para yoksa küçük placeholder göster
    if (stats.noCount == 0) {
      return RepaintBoundary(
        child: Transform.translate(
          offset: Offset(0, parallaxOffset),
          child: Transform.scale(
            scale: scale,
            child: Opacity(
              opacity: opacity,
              child: FittedBox(
                fit: BoxFit.scaleDown,
                child: _buildEmptyState(context, expandRatio, l10n),
              ),
            ),
          ),
        ),
      );
    }

    return RepaintBoundary(
      child: Transform.translate(
        offset: Offset(0, parallaxOffset),
        child: Transform.scale(
          scale: scale,
          alignment: Alignment.center,
          child: Opacity(
            opacity: opacity,
            child: FittedBox(
              fit: BoxFit.scaleDown,
              child: Container(
                padding: EdgeInsets.symmetric(
                  vertical: 8 + (12 * expandRatio),
                  horizontal: 12 + (8 * expandRatio),
                ),
                decoration: BoxDecoration(
                  color: context.appColors.surface,
                  borderRadius: BorderRadius.circular(12 + (4 * expandRatio)),
                  border: Border.all(
                    color: context.appColors.primary.withValues(
                      alpha: 0.2 + (0.1 * expandRatio),
                    ),
                    width: 1,
                  ),
                  boxShadow: [
                    BoxShadow(
                      color: context.appColors.primary.withValues(
                        alpha: 0.05 * expandRatio,
                      ),
                      blurRadius: 20 * expandRatio,
                      spreadRadius: 0,
                    ),
                  ],
                ),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  crossAxisAlignment: CrossAxisAlignment.center,
                  children: [
                    // Animated Icon
                    _AnimatedSavingsIcon(
                      size: iconContainerSize,
                      iconSize: iconSize,
                      expandRatio: expandRatio,
                    ),
                    SizedBox(width: 10 + (6 * expandRatio)),

                    // Amount ve Label
                    Row(
                      mainAxisSize: MainAxisSize.min,
                      crossAxisAlignment: CrossAxisAlignment.end,
                      children: [
                        // Slot-machine style counter
                        NumberTicker(
                          value: stats.savedAmount,
                          style: TextStyle(
                            fontSize: amountFontSize,
                            fontWeight: FontWeight.w700,
                            color: context.appColors.primary,
                            letterSpacing: -1,
                            height: 1.2,
                          ),
                          duration: const Duration(milliseconds: 800),
                          curve: Curves.easeOutCubic,
                        ),
                        Padding(
                          padding: EdgeInsets.only(
                            left: 2 + (2 * expandRatio),
                            bottom: 2,
                          ),
                          child: Text(
                            currencyProvider.symbol,
                            style: TextStyle(
                              fontSize: 10 + (4 * expandRatio),
                              fontWeight: FontWeight.w600,
                              color: context.appColors.primary,
                            ),
                          ),
                        ),
                        SizedBox(width: 6 + (4 * expandRatio)),
                        Padding(
                          padding: const EdgeInsets.only(bottom: 2),
                          child: Text(
                            l10n.youSaved,
                            style: TextStyle(
                              fontSize: labelFontSize,
                              fontWeight: FontWeight.w500,
                              color: context.appColors.textSecondary,
                            ),
                          ),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildEmptyState(
    BuildContext context,
    double expandRatio,
    AppLocalizations l10n,
  ) {
    return Container(
      padding: EdgeInsets.symmetric(
        horizontal: 12 + (8 * expandRatio),
        vertical: 8 + (8 * expandRatio),
      ),
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: context.appColors.cardBorder, width: 1),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(
            CupertinoIcons.shield_lefthalf_fill,
            size: 20 + (12 * expandRatio),
            color: context.appColors.textTertiary,
          ),
          SizedBox(width: 6 + (4 * expandRatio)),
          Text(
            l10n.noSavingsYet,
            style: TextStyle(
              fontSize: 12 + (2 * expandRatio),
              fontWeight: FontWeight.w500,
              color: context.appColors.textTertiary,
            ),
          ),
        ],
      ),
    );
  }
}

/// Animasyonlu tasarruf ikonu
class _AnimatedSavingsIcon extends StatefulWidget {
  final double size;
  final double iconSize;
  final double expandRatio;

  const _AnimatedSavingsIcon({
    required this.size,
    required this.iconSize,
    required this.expandRatio,
  });

  @override
  State<_AnimatedSavingsIcon> createState() => _AnimatedSavingsIconState();
}

class _AnimatedSavingsIconState extends State<_AnimatedSavingsIcon>
    with SingleTickerProviderStateMixin {
  late AnimationController _pulseController;
  late Animation<double> _pulseAnimation;

  @override
  void initState() {
    super.initState();
    _pulseController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 2000),
    );

    _pulseAnimation = Tween<double>(begin: 1.0, end: 1.05).animate(
      CurvedAnimation(parent: _pulseController, curve: Curves.easeInOut),
    );

    // Sürekli yumuşak pulse
    _pulseController.repeat(reverse: true);
  }

  @override
  void dispose() {
    _pulseController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: _pulseAnimation,
      builder: (context, child) {
        // Sadece açık durumda pulse efekti
        final scale = widget.expandRatio > 0.5 ? _pulseAnimation.value : 1.0;

        return Transform.scale(
          scale: scale,
          child: Container(
            width: widget.size,
            height: widget.size,
            decoration: BoxDecoration(
              color: context.appColors.primary.withValues(alpha: 0.1),
              borderRadius: BorderRadius.circular(
                12 + (8 * widget.expandRatio),
              ),
            ),
            child: Icon(
              CupertinoIcons.shield_lefthalf_fill,
              size: widget.iconSize,
              color: context.appColors.primary,
            ),
          ),
        );
      },
    );
  }
}

/// SliverAppBar için delegasyon widget'ı
class CollapsibleSavedHeaderDelegate extends SliverPersistentHeaderDelegate {
  final DecisionStats stats;
  final double minHeight;
  final double maxHeight;

  CollapsibleSavedHeaderDelegate({
    required this.stats,
    this.minHeight = 60,
    this.maxHeight = 120,
  });

  @override
  Widget build(
    BuildContext context,
    double shrinkOffset,
    bool overlapsContent,
  ) {
    final expandRatio =
        1.0 - (shrinkOffset / (maxHeight - minHeight)).clamp(0.0, 1.0);

    return Container(
      color: context.appColors.background,
      alignment: Alignment.center,
      child: CollapsibleSavedHeader(stats: stats, expandRatio: expandRatio),
    );
  }

  @override
  double get maxExtent => maxHeight;

  @override
  double get minExtent => minHeight;

  @override
  bool shouldRebuild(covariant CollapsibleSavedHeaderDelegate oldDelegate) {
    return stats.savedAmount != oldDelegate.stats.savedAmount ||
        stats.noCount != oldDelegate.stats.noCount;
  }
}


--- FILE: lib/widgets/animated_expense_list.dart ---

import 'package:flutter/material.dart';
import '../models/models.dart';
import '../theme/theme.dart';
import 'expense_history_card.dart';

/// Animasyonlu harcama listesi
/// Yeni kartlar slideUp + fadeIn ile eklenir
/// Silinen kartlar slideOut + fadeOut ile çıkar
class AnimatedExpenseList extends StatefulWidget {
  final List<Expense> expenses;
  final Function(Expense, ExpenseDecision)? onDecisionUpdate;
  final Function(Expense)? onDelete;
  final ScrollController? scrollController;
  final double dailyWorkHours;

  const AnimatedExpenseList({
    super.key,
    required this.expenses,
    this.onDecisionUpdate,
    this.onDelete,
    this.scrollController,
    this.dailyWorkHours = 8,
  });

  @override
  State<AnimatedExpenseList> createState() => AnimatedExpenseListState();
}

class AnimatedExpenseListState extends State<AnimatedExpenseList> {
  final GlobalKey<AnimatedListState> _listKey = GlobalKey<AnimatedListState>();
  late List<Expense> _items;

  @override
  void initState() {
    super.initState();
    _items = List.from(widget.expenses);
  }

  @override
  void didUpdateWidget(AnimatedExpenseList oldWidget) {
    super.didUpdateWidget(oldWidget);

    // Yeni eklenen itemları bul
    final newItems = widget.expenses.where((e) => !_items.contains(e)).toList();
    final removedItems = _items
        .where((e) => !widget.expenses.contains(e))
        .toList();

    // Önce silinen itemları kaldır
    for (final item in removedItems) {
      final index = _items.indexOf(item);
      if (index >= 0) {
        _removeItem(index);
      }
    }

    // Sonra yeni itemları ekle
    for (final item in newItems) {
      _insertItem(0, item);
    }
  }

  void _insertItem(int index, Expense item) {
    _items.insert(index, item);
    _listKey.currentState?.insertItem(index, duration: AppAnimations.medium);
  }

  void _removeItem(int index) {
    final removedItem = _items.removeAt(index);
    _listKey.currentState?.removeItem(
      index,
      (context, animation) => _buildRemovedItem(removedItem, animation),
      duration: AppAnimations.medium,
    );
  }

  /// Dışarıdan item ekleme (örn: yeni harcama kaydı)
  void addExpense(Expense expense) {
    _insertItem(0, expense);
  }

  /// Dışarıdan item silme
  void removeExpense(Expense expense) {
    final index = _items.indexOf(expense);
    if (index >= 0) {
      _removeItem(index);
    }
  }

  Widget _buildItem(
    BuildContext context,
    int index,
    Animation<double> animation,
  ) {
    final expense = _items[index];

    return SlideTransition(
      position: Tween<Offset>(begin: const Offset(0, 0.5), end: Offset.zero)
          .animate(
            CurvedAnimation(
              parent: animation,
              curve: AppAnimations.standardCurve,
            ),
          ),
      child: FadeTransition(
        opacity: animation,
        child: RepaintBoundary(
          child: Padding(
            padding: const EdgeInsets.only(bottom: 12),
            child: ExpenseHistoryCard(
              expense: expense,
              dailyWorkHours: widget.dailyWorkHours,
              onDecisionUpdate: widget.onDecisionUpdate != null
                  ? (decision) => widget.onDecisionUpdate!(expense, decision)
                  : null,
              onDelete: widget.onDelete != null
                  ? () => widget.onDelete!(expense)
                  : null,
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildRemovedItem(Expense expense, Animation<double> animation) {
    return SlideTransition(
      position: Tween<Offset>(begin: Offset.zero, end: const Offset(-1, 0))
          .animate(
            CurvedAnimation(parent: animation, curve: AppAnimations.exitCurve),
          ),
      child: FadeTransition(
        opacity: animation,
        child: SizeTransition(
          sizeFactor: animation,
          child: Padding(
            padding: const EdgeInsets.only(bottom: 12),
            child: ExpenseHistoryCard(
              expense: expense,
              dailyWorkHours: widget.dailyWorkHours,
            ),
          ),
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    if (_items.isEmpty) {
      return const SizedBox.shrink();
    }

    return AnimatedList(
      key: _listKey,
      controller: widget.scrollController,
      shrinkWrap: true,
      physics: const NeverScrollableScrollPhysics(),
      initialItemCount: _items.length,
      itemBuilder: _buildItem,
    );
  }
}

/// Staggered fade-in ile liste görünümü
/// Her item belirli bir gecikmeyle görünür
class StaggeredFadeList extends StatefulWidget {
  final List<Widget> children;
  final Duration initialDelay;
  final Duration staggerDelay;
  final Duration itemDuration;
  final Curve curve;
  final Offset slideOffset;

  const StaggeredFadeList({
    super.key,
    required this.children,
    this.initialDelay = AppAnimations.initialDelay,
    this.staggerDelay = AppAnimations.staggerDelay,
    this.itemDuration = AppAnimations.medium,
    this.curve = AppAnimations.standardCurve,
    this.slideOffset = const Offset(0, 20),
  });

  @override
  State<StaggeredFadeList> createState() => _StaggeredFadeListState();
}

class _StaggeredFadeListState extends State<StaggeredFadeList>
    with TickerProviderStateMixin {
  late List<AnimationController> _controllers;
  late List<Animation<double>> _fadeAnimations;
  late List<Animation<Offset>> _slideAnimations;

  @override
  void initState() {
    super.initState();
    _initAnimations();
  }

  void _initAnimations() {
    _controllers = List.generate(
      widget.children.length,
      (index) =>
          AnimationController(vsync: this, duration: widget.itemDuration),
    );

    _fadeAnimations = _controllers.map((controller) {
      return Tween<double>(
        begin: 0.0,
        end: 1.0,
      ).animate(CurvedAnimation(parent: controller, curve: widget.curve));
    }).toList();

    _slideAnimations = _controllers.map((controller) {
      return Tween<Offset>(
        begin: widget.slideOffset,
        end: Offset.zero,
      ).animate(CurvedAnimation(parent: controller, curve: widget.curve));
    }).toList();

    _startAnimations();
  }

  Future<void> _startAnimations() async {
    await Future.delayed(widget.initialDelay);

    for (int i = 0; i < _controllers.length; i++) {
      if (!mounted) return;
      _controllers[i].forward();
      if (i < _controllers.length - 1) {
        await Future.delayed(widget.staggerDelay);
      }
    }
  }

  @override
  void dispose() {
    for (final controller in _controllers) {
      controller.dispose();
    }
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: List.generate(widget.children.length, (index) {
        return AnimatedBuilder(
          animation: _controllers[index],
          builder: (context, child) {
            return Transform.translate(
              offset: _slideAnimations[index].value,
              child: Opacity(
                opacity: _fadeAnimations[index].value,
                child: widget.children[index],
              ),
            );
          },
        );
      }),
    );
  }
}

/// Grid için staggered animasyon
class StaggeredFadeGrid extends StatefulWidget {
  final List<Widget> children;
  final int crossAxisCount;
  final double mainAxisSpacing;
  final double crossAxisSpacing;
  final double childAspectRatio;
  final Duration initialDelay;
  final Duration staggerDelay;

  const StaggeredFadeGrid({
    super.key,
    required this.children,
    this.crossAxisCount = 2,
    this.mainAxisSpacing = 12,
    this.crossAxisSpacing = 12,
    this.childAspectRatio = 1.0,
    this.initialDelay = AppAnimations.initialDelay,
    this.staggerDelay = AppAnimations.staggerDelay,
  });

  @override
  State<StaggeredFadeGrid> createState() => _StaggeredFadeGridState();
}

class _StaggeredFadeGridState extends State<StaggeredFadeGrid>
    with TickerProviderStateMixin {
  late List<AnimationController> _controllers;
  late List<Animation<double>> _animations;

  @override
  void initState() {
    super.initState();
    _initAnimations();
  }

  void _initAnimations() {
    _controllers = List.generate(
      widget.children.length,
      (index) =>
          AnimationController(vsync: this, duration: AppAnimations.medium),
    );

    _animations = _controllers.map((controller) {
      return CurvedAnimation(
        parent: controller,
        curve: AppAnimations.standardCurve,
      );
    }).toList();

    _startAnimations();
  }

  Future<void> _startAnimations() async {
    await Future.delayed(widget.initialDelay);

    for (int i = 0; i < _controllers.length; i++) {
      if (!mounted) return;
      _controllers[i].forward();
      if (i < _controllers.length - 1) {
        await Future.delayed(widget.staggerDelay);
      }
    }
  }

  @override
  void dispose() {
    for (final controller in _controllers) {
      controller.dispose();
    }
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return GridView.builder(
      shrinkWrap: true,
      physics: const NeverScrollableScrollPhysics(),
      gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
        crossAxisCount: widget.crossAxisCount,
        mainAxisSpacing: widget.mainAxisSpacing,
        crossAxisSpacing: widget.crossAxisSpacing,
        childAspectRatio: widget.childAspectRatio,
      ),
      itemCount: widget.children.length,
      itemBuilder: (context, index) {
        return FadeTransition(
          opacity: _animations[index],
          child: ScaleTransition(
            scale: Tween<double>(
              begin: 0.8,
              end: 1.0,
            ).animate(_animations[index]),
            child: widget.children[index],
          ),
        );
      },
    );
  }
}


--- FILE: lib/widgets/vertical_budget_indicator.dart ---

import 'package:flutter/material.dart';
import '../theme/theme.dart';
import '../core/theme/premium_effects.dart';

/// Vertical Budget Indicator - Premium UI Element
/// A distinctive vertical progress bar that fills from TOP to BOTTOM
/// Colors change based on budget usage:
/// - Purple gradient: < 70% spent (healthy)
/// - Red: >= 70% spent (danger)
class VerticalBudgetIndicator extends StatefulWidget {
  final double progress; // 0.0 - 1.0 (spent percentage)
  final double height;
  final double width;
  final bool showGlow;
  final bool animated;
  final bool showShimmer;
  final Duration animationDuration;

  const VerticalBudgetIndicator({
    super.key,
    required this.progress,
    this.height = 120,
    this.width = 8,
    this.showGlow = true,
    this.animated = true,
    this.showShimmer = true,
    this.animationDuration = const Duration(milliseconds: 800),
  });

  @override
  State<VerticalBudgetIndicator> createState() =>
      _VerticalBudgetIndicatorState();
}

class _VerticalBudgetIndicatorState extends State<VerticalBudgetIndicator>
    with SingleTickerProviderStateMixin {
  late AnimationController _breatheController;
  late Animation<double> _breatheAnimation;

  @override
  void initState() {
    super.initState();
    _breatheController = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 3),
    )..repeat(reverse: true);

    _breatheAnimation = Tween<double>(begin: 0.4, end: 0.7).animate(
      CurvedAnimation(parent: _breatheController, curve: Curves.easeInOut),
    );
  }

  @override
  void dispose() {
    _breatheController.dispose();
    super.dispose();
  }

  Color _getFillColor(BuildContext context) {
    final clampedProgress = widget.progress.clamp(0.0, 1.0);
    // %70'te kırmızıya dön
    if (clampedProgress >= 0.7) {
      return context.appColors.error;
    }
    return PremiumColors.purple;
  }

  @override
  Widget build(BuildContext context) {
    final clampedProgress = widget.progress.clamp(0.0, 1.0);
    final fillColor = _getFillColor(context);
    final errorColor = context.appColors.error;

    return Container(
      width: widget.width,
      height: widget.height,
      decoration: BoxDecoration(
        color: context.appColors.textPrimary.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(widget.width / 2),
      ),
      child: Stack(
        alignment: Alignment.topCenter, // Yukarıdan aşağı dol
        children: [
          // Fill bar
          widget.animated
              ? TweenAnimationBuilder<double>(
                  tween: Tween(begin: 0, end: clampedProgress),
                  duration: widget.animationDuration,
                  curve: Curves.easeOutCubic,
                  builder: (context, value, child) {
                    return _buildFillBar(value, fillColor, errorColor);
                  },
                )
              : _buildFillBar(clampedProgress, fillColor, errorColor),
        ],
      ),
    );
  }

  Widget _buildFillBar(double value, Color color, Color errorColor) {
    final isRed = color == errorColor;

    Widget bar = AnimatedBuilder(
      animation: _breatheAnimation,
      builder: (context, child) {
        return Container(
          width: widget.width,
          height: widget.height * value,
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(widget.width / 2),
            gradient: LinearGradient(
              begin: Alignment.topCenter,
              end: Alignment.bottomCenter,
              colors: isRed
                  ? [errorColor, errorColor.withValues(alpha: 0.8)]
                  : [PremiumColors.purple, PremiumColors.purpleLight],
            ),
            boxShadow: widget.showGlow
                ? [
                    BoxShadow(
                      color: color.withValues(alpha: _breatheAnimation.value),
                      blurRadius: 20,
                      spreadRadius: 0,
                    ),
                    BoxShadow(
                      color: color.withValues(
                        alpha: _breatheAnimation.value * 0.5,
                      ),
                      blurRadius: 40,
                      spreadRadius: 0,
                    ),
                  ]
                : null,
          ),
        );
      },
    );

    // Shimmer efekti ekle
    if (widget.showShimmer && value > 0) {
      bar = _ShimmerOverlay(child: bar);
    }

    return bar;
  }
}

/// Internal shimmer overlay for progress bar
class _ShimmerOverlay extends StatefulWidget {
  final Widget child;

  const _ShimmerOverlay({required this.child});

  @override
  State<_ShimmerOverlay> createState() => _ShimmerOverlayState();
}

class _ShimmerOverlayState extends State<_ShimmerOverlay>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 2000),
    )..repeat();
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: _controller,
      builder: (context, child) {
        return ShaderMask(
          shaderCallback: (bounds) {
            return LinearGradient(
              begin: Alignment.topCenter,
              end: Alignment.bottomCenter,
              colors: [
                Colors.transparent,
                Colors.white.withValues(alpha: 0.35),
                Colors.transparent,
              ],
              stops: [
                (_controller.value - 0.3).clamp(0.0, 1.0),
                _controller.value,
                (_controller.value + 0.3).clamp(0.0, 1.0),
              ],
            ).createShader(bounds);
          },
          blendMode: BlendMode.srcATop,
          child: widget.child,
        );
      },
    );
  }
}

/// Horizontal version of the budget indicator
/// Used in cards and compact layouts
class HorizontalBudgetIndicator extends StatefulWidget {
  final double progress; // 0.0 - 1.0
  final double height;
  final double? width;
  final bool showGlow;
  final bool animated;
  final bool showShimmer;
  final Duration animationDuration;

  const HorizontalBudgetIndicator({
    super.key,
    required this.progress,
    this.height = 6,
    this.width,
    this.showGlow = true,
    this.animated = true,
    this.showShimmer = true,
    this.animationDuration = const Duration(milliseconds: 800),
  });

  @override
  State<HorizontalBudgetIndicator> createState() =>
      _HorizontalBudgetIndicatorState();
}

class _HorizontalBudgetIndicatorState extends State<HorizontalBudgetIndicator>
    with SingleTickerProviderStateMixin {
  late AnimationController _breatheController;
  late Animation<double> _breatheAnimation;

  @override
  void initState() {
    super.initState();
    _breatheController = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 3),
    )..repeat(reverse: true);

    _breatheAnimation = Tween<double>(begin: 0.4, end: 0.7).animate(
      CurvedAnimation(parent: _breatheController, curve: Curves.easeInOut),
    );
  }

  @override
  void dispose() {
    _breatheController.dispose();
    super.dispose();
  }

  Color _getFillColor(BuildContext context) {
    final clampedProgress = widget.progress.clamp(0.0, 1.0);
    if (clampedProgress >= 0.7) {
      return context.appColors.error;
    }
    return PremiumColors.purple;
  }

  @override
  Widget build(BuildContext context) {
    final clampedProgress = widget.progress.clamp(0.0, 1.0);
    final fillColor = _getFillColor(context);
    final errorColor = context.appColors.error;

    return LayoutBuilder(
      builder: (context, constraints) {
        final totalWidth = widget.width ?? constraints.maxWidth;

        return Container(
          width: totalWidth,
          height: widget.height,
          decoration: BoxDecoration(
            color: context.appColors.textPrimary.withValues(alpha: 0.1),
            borderRadius: BorderRadius.circular(widget.height / 2),
          ),
          child: Stack(
            alignment: Alignment.centerLeft,
            children: [
              // Fill bar
              widget.animated
                  ? TweenAnimationBuilder<double>(
                      tween: Tween(begin: 0, end: clampedProgress),
                      duration: widget.animationDuration,
                      curve: Curves.easeOutCubic,
                      builder: (context, value, child) {
                        return _buildFillBar(
                          value,
                          fillColor,
                          totalWidth,
                          errorColor,
                        );
                      },
                    )
                  : _buildFillBar(
                      clampedProgress,
                      fillColor,
                      totalWidth,
                      errorColor,
                    ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildFillBar(
    double value,
    Color color,
    double totalWidth,
    Color errorColor,
  ) {
    final isRed = color == errorColor;

    Widget bar = AnimatedBuilder(
      animation: _breatheAnimation,
      builder: (context, child) {
        return Container(
          width: totalWidth * value,
          height: widget.height,
          decoration: BoxDecoration(
            gradient: LinearGradient(
              colors: isRed
                  ? [errorColor, errorColor.withValues(alpha: 0.8)]
                  : [
                      PremiumColors.purpleDark,
                      PremiumColors.purple,
                      PremiumColors.purpleLight,
                    ],
            ),
            borderRadius: BorderRadius.circular(widget.height / 2),
            boxShadow: widget.showGlow
                ? [
                    BoxShadow(
                      color: color.withValues(alpha: _breatheAnimation.value),
                      blurRadius: 12,
                      spreadRadius: -2,
                    ),
                  ]
                : null,
          ),
        );
      },
    );

    if (widget.showShimmer && value > 0) {
      bar = ShimmerEffect(child: bar);
    }

    return bar;
  }
}

/// Accent line - A small vertical accent used for section headers
/// Part of the signature design language
class AccentLine extends StatelessWidget {
  final double height;
  final double width;
  final Color? color;
  final bool showGradient;

  const AccentLine({
    super.key,
    this.height = 20,
    this.width = 3,
    this.color,
    this.showGradient = true,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      width: width,
      height: height,
      decoration: BoxDecoration(
        color: showGradient ? null : (color ?? context.appColors.primary),
        gradient: showGradient ? AppGradients.primaryButton : null,
        borderRadius: BorderRadius.circular(width / 2),
      ),
    );
  }
}

/// Category accent line - Shows category color
class CategoryAccentLine extends StatelessWidget {
  final double height;
  final double width;
  final Color color;

  const CategoryAccentLine({
    super.key,
    this.height = 60,
    this.width = 3,
    required this.color,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      width: width,
      height: height,
      decoration: BoxDecoration(
        color: color,
        borderRadius: BorderRadius.circular(width / 2),
      ),
    );
  }
}


--- FILE: lib/widgets/income_summary_widget.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import '../theme/theme.dart';
import '../utils/currency_utils.dart';

/// Dashboard'da gelir ve net bakiye özetini gösteren widget
class IncomeSummaryWidget extends StatelessWidget {
  final double totalIncome;
  final double totalSpent;
  final int incomeSourceCount;
  final VoidCallback? onTap;
  final double expandRatio;

  const IncomeSummaryWidget({
    super.key,
    required this.totalIncome,
    required this.totalSpent,
    this.incomeSourceCount = 1,
    this.onTap,
    this.expandRatio = 1.0,
  });

  double get netBalance => totalIncome - totalSpent;
  double get spendingRate =>
      totalIncome > 0 ? (totalSpent / totalIncome * 100) : 0;
  bool get isPositive => netBalance >= 0;

  @override
  Widget build(BuildContext context) {
    // Boyutları expandRatio'ya göre hesapla
    final containerPadding = 12.0 + (8.0 * expandRatio);
    final iconSize = 16.0 + (8.0 * expandRatio);
    final mainFontSize = 14.0 + (6.0 * expandRatio);
    final subFontSize = 10.0 + (2.0 * expandRatio);

    return GestureDetector(
      onTap: onTap,
      child: Container(
        padding: EdgeInsets.symmetric(
          horizontal: containerPadding,
          vertical: containerPadding * 0.75,
        ),
        decoration: BoxDecoration(
          color: context.appColors.surface,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: context.appColors.cardBorder.withValues(
              alpha: 0.5 + (0.3 * expandRatio),
            ),
          ),
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            // Gelir ikonu
            Container(
              width: iconSize * 1.8,
              height: iconSize * 1.8,
              decoration: BoxDecoration(
                color: context.appColors.success.withValues(alpha: 0.1),
                borderRadius: BorderRadius.circular(8),
              ),
              child: Icon(
                CupertinoIcons.creditcard_fill,
                size: iconSize,
                color: context.appColors.success,
              ),
            ),
            SizedBox(width: 8 + (4 * expandRatio)),

            // Gelir bilgileri
            Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              mainAxisSize: MainAxisSize.min,
              children: [
                // Toplam gelir
                Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Text(
                      formatTurkishCurrency(
                        totalIncome,
                        decimalDigits: 0,
                        showDecimals: false,
                      ),
                      style: TextStyle(
                        fontSize: mainFontSize,
                        fontWeight: FontWeight.w700,
                        color: context.appColors.textPrimary,
                      ),
                    ),
                    Text(
                      ' TL',
                      style: TextStyle(
                        fontSize: subFontSize,
                        fontWeight: FontWeight.w500,
                        color: context.appColors.textSecondary,
                      ),
                    ),
                    if (incomeSourceCount > 1) ...[
                      SizedBox(width: 4 + (2 * expandRatio)),
                      Container(
                        padding: EdgeInsets.symmetric(
                          horizontal: 4 + (2 * expandRatio),
                          vertical: 1 + expandRatio,
                        ),
                        decoration: BoxDecoration(
                          color: context.appColors.success.withValues(
                            alpha: 0.1,
                          ),
                          borderRadius: BorderRadius.circular(4),
                        ),
                        child: Text(
                          '$incomeSourceCount',
                          style: TextStyle(
                            fontSize: subFontSize - 2,
                            fontWeight: FontWeight.w600,
                            color: context.appColors.success,
                          ),
                        ),
                      ),
                    ],
                  ],
                ),
                SizedBox(height: 2 * expandRatio),
                // Net bakiye
                Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Icon(
                      isPositive
                          ? CupertinoIcons.arrow_up_right
                          : CupertinoIcons.arrow_down_right,
                      size: subFontSize + 2,
                      color: isPositive
                          ? context.appColors.success
                          : context.appColors.error,
                    ),
                    const SizedBox(width: 4),
                    Text(
                      '${isPositive ? '+' : ''}${formatTurkishCurrency(netBalance, decimalDigits: 2)}',
                      style: TextStyle(
                        fontSize: subFontSize,
                        fontWeight: FontWeight.w600,
                        color: isPositive
                            ? context.appColors.success
                            : context.appColors.error,
                      ),
                    ),
                  ],
                ),
              ],
            ),

            // Navigasyon ikonu (expanded durumda)
            if (expandRatio > 0.5 && onTap != null) ...[
              SizedBox(width: 8 + (4 * expandRatio)),
              Icon(
                CupertinoIcons.chevron_right,
                size: iconSize,
                color: context.appColors.textTertiary,
              ),
            ],
          ],
        ),
      ),
    );
  }
}

/// Kompakt gelir gösterimi (header için)
class CompactIncomeIndicator extends StatelessWidget {
  final double totalIncome;
  final double totalSpent;
  final VoidCallback? onTap;

  const CompactIncomeIndicator({
    super.key,
    required this.totalIncome,
    required this.totalSpent,
    this.onTap,
  });

  double get netBalance => totalIncome - totalSpent;
  bool get isPositive => netBalance >= 0;
  double get spendingRate =>
      totalIncome > 0 ? (totalSpent / totalIncome * 100) : 0;

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
        decoration: BoxDecoration(
          color: context.appColors.surface,
          borderRadius: BorderRadius.circular(8),
          border: Border.all(color: context.appColors.cardBorder),
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            // Net bakiye göstergesi
            Container(
              width: 6,
              height: 6,
              decoration: BoxDecoration(
                color: isPositive
                    ? context.appColors.success
                    : context.appColors.error,
                shape: BoxShape.circle,
              ),
            ),
            const SizedBox(width: 6),
            Text(
              '${spendingRate.toStringAsFixed(0)}%',
              style: TextStyle(
                fontSize: 12,
                fontWeight: FontWeight.w600,
                color: _getSpendingColor(context),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Color _getSpendingColor(BuildContext context) {
    if (spendingRate < 50) return context.appColors.success;
    if (spendingRate < 75) return context.appColors.warning;
    if (spendingRate < 100) return context.appColors.error;
    return context.appColors.error;
  }
}

/// Gelir/Harcama ilerleme çubuğu
class IncomeProgressBar extends StatelessWidget {
  final double totalIncome;
  final double totalSpent;
  final double height;

  const IncomeProgressBar({
    super.key,
    required this.totalIncome,
    required this.totalSpent,
    this.height = 6,
  });

  double get progress =>
      totalIncome > 0 ? (totalSpent / totalIncome).clamp(0.0, 1.5) : 0;

  @override
  Widget build(BuildContext context) {
    return Container(
      height: height,
      decoration: BoxDecoration(
        color: context.appColors.surfaceLight,
        borderRadius: BorderRadius.circular(height / 2),
      ),
      child: LayoutBuilder(
        builder: (context, constraints) {
          final progressWidth = constraints.maxWidth * progress.clamp(0.0, 1.0);
          return Stack(
            children: [
              // Progress bar
              AnimatedContainer(
                duration: const Duration(milliseconds: 300),
                width: progressWidth,
                height: height,
                decoration: BoxDecoration(
                  gradient: LinearGradient(colors: _getGradientColors(context)),
                  borderRadius: BorderRadius.circular(height / 2),
                ),
              ),
              // Overflow indicator (eğer %100'ü aştıysa)
              if (progress > 1.0)
                Positioned(
                  right: 0,
                  child: Container(
                    width: height * 1.5,
                    height: height,
                    decoration: BoxDecoration(
                      color: context.appColors.error,
                      borderRadius: BorderRadius.circular(height / 2),
                    ),
                    child: Icon(
                      CupertinoIcons.exclamationmark_circle_fill,
                      size: height - 2,
                      color: Colors.white,
                    ),
                  ),
                ),
            ],
          );
        },
      ),
    );
  }

  List<Color> _getGradientColors(BuildContext context) {
    if (progress < 0.5) {
      return [
        context.appColors.success,
        context.appColors.success.withValues(alpha: 0.8),
      ];
    } else if (progress < 0.75) {
      return [context.appColors.success, context.appColors.warning];
    } else if (progress < 1.0) {
      return [context.appColors.warning, context.appColors.error];
    } else {
      return [
        context.appColors.error,
        context.appColors.error.withValues(alpha: 0.8),
      ];
    }
  }
}


--- FILE: lib/widgets/additional_income_prompt.dart ---

import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../theme/theme.dart';
import '../screens/income_wizard_screen.dart';

/// Prompt card asking users if they have additional income
/// Glassmorphism design with yes/no options
class AdditionalIncomePrompt extends StatelessWidget {
  final VoidCallback? onYes;
  final VoidCallback? onNo;

  const AdditionalIncomePrompt({
    super.key,
    this.onYes,
    this.onNo,
  });

  void _openIncomeWizard(BuildContext context) {
    HapticFeedback.mediumImpact();
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => const IncomeWizardScreen(
          skipToAdditional: true,
        ),
      ),
    ).then((_) {
      onYes?.call();
    });
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(24),
        child: BackdropFilter(
          filter: ImageFilter.blur(sigmaX: 20, sigmaY: 20),
          child: Container(
            padding: const EdgeInsets.all(20),
            decoration: BoxDecoration(
              color: context.appColors.surface.withValues(alpha: 0.8),
              borderRadius: BorderRadius.circular(24),
              border: Border.all(
                color: context.appColors.success.withValues(alpha: 0.3),
                width: 1,
              ),
              boxShadow: [
                BoxShadow(
                  color: context.appColors.success.withValues(alpha: 0.1),
                  blurRadius: 20,
                  offset: const Offset(0, 4),
                ),
              ],
            ),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                // Icon
                Container(
                  width: 56,
                  height: 56,
                  decoration: BoxDecoration(
                    color: context.appColors.success.withValues(alpha: 0.15),
                    borderRadius: BorderRadius.circular(16),
                  ),
                  child: Center(
                    child: Icon(
                      CupertinoIcons.money_dollar_circle_fill,
                      size: 28,
                      color: context.appColors.success,
                    ),
                  ),
                ),

                const SizedBox(height: 16),

                // Title
                Text(
                  l10n.additionalIncomePromptTitle,
                  style: TextStyle(
                    fontSize: 18,
                    fontWeight: FontWeight.w700,
                    color: context.appColors.textPrimary,
                  ),
                ),

                const SizedBox(height: 8),

                // Subtitle
                Text(
                  l10n.additionalIncomePromptSubtitle,
                  textAlign: TextAlign.center,
                  style: TextStyle(
                    fontSize: 14,
                    color: context.appColors.textSecondary,
                  ),
                ),

                const SizedBox(height: 20),

                // Buttons row
                Row(
                  children: [
                    // Yes button
                    Expanded(
                      child: Semantics(
                        button: true,
                        label: l10n.additionalIncomeYes,
                        child: GestureDetector(
                          onTap: () => _openIncomeWizard(context),
                          child: Container(
                            height: 48,
                            decoration: BoxDecoration(
                              color: context.appColors.success,
                              borderRadius: BorderRadius.circular(16),
                            ),
                            child: Center(
                              child: Row(
                                mainAxisAlignment: MainAxisAlignment.center,
                                children: [
                                  Icon(
                                    CupertinoIcons.plus_circle_fill,
                                    size: 18,
                                    color: context.appColors.textPrimary,
                                  ),
                                  const SizedBox(width: 8),
                                  Text(
                                    l10n.additionalIncomeYes,
                                    style: TextStyle(
                                      fontSize: 14,
                                      fontWeight: FontWeight.w600,
                                      color: context.appColors.textPrimary,
                                    ),
                                  ),
                                ],
                              ),
                            ),
                          ),
                        ),
                      ),
                    ),
                    const SizedBox(width: 12),
                    // No button
                    Expanded(
                      child: Semantics(
                        button: true,
                        label: l10n.additionalIncomeNo,
                        child: GestureDetector(
                          onTap: () {
                            HapticFeedback.lightImpact();
                            onNo?.call();
                          },
                          child: Container(
                            height: 48,
                            decoration: BoxDecoration(
                              color: context.appColors.surfaceLight,
                              borderRadius: BorderRadius.circular(16),
                              border: Border.all(
                                color: context.appColors.cardBorder,
                              ),
                            ),
                            child: Center(
                              child: Text(
                                l10n.additionalIncomeNo,
                                style: TextStyle(
                                  fontSize: 14,
                                  fontWeight: FontWeight.w600,
                                  color: context.appColors.textSecondary,
                                ),
                              ),
                            ),
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}


--- FILE: lib/widgets/widgets.dart ---

export 'labeled_text_field.dart';
export 'labeled_dropdown.dart';
export 'result_card.dart';
export 'expense_history_card.dart';
export 'decision_buttons.dart';
export 'saved_money_counter.dart';
export 'currency_rate_widget.dart';
export 'currency_ticker.dart';
export 'currency_selector.dart';
export 'profile_photo_widget.dart';
export 'streak_widget.dart';
export 'subscription_sheet.dart';
export 'collapsible_saved_header.dart';
export 'animated_counter.dart';
export 'animated_expense_list.dart';
export 'animated_bottom_sheet.dart';
export 'empty_state.dart';
export 'shimmer_effect.dart';
export 'offline_banner.dart';
export 'turkish_currency_input.dart';
export 'income_summary_widget.dart';
export 'financial_snapshot_card.dart';
export 'premium_nav_bar.dart';
export 'quick_add_sheet.dart';
// Wealth Coach
export 'smart_choice_toggle.dart';
export 'expense_form_content.dart';
export 'decision_stress_timer.dart';
export 'renewal_warning_banner.dart';
export 'add_subscription_sheet.dart';
export 'subscription_detail_sheet.dart';
export 'subscription_calendar_view.dart';
// Sharing
export 'share_card_widget.dart';
export 'share_edit_sheet.dart';
export 'premium_share_card.dart';

// Expense Entry
export 'add_expense_sheet.dart';
export 'expense_form_chips.dart';

// Income Entry
export 'add_income_sheet.dart';
export 'payday_confirmation_dialog.dart';

// AI Chat
export 'ai_fab.dart';
export 'ai_chat_sheet.dart';

// Premium UI
export 'ai_insights_card.dart';
export 'vertical_budget_indicator.dart';
export 'budget_breakdown_card.dart';
export 'installment_summary_card.dart';
export 'locked_pro_feature.dart';

// Merchant Learning
export 'pending_review_banner.dart';
export 'pending_review_sheet.dart';

// Voice Assistant
export 'voice_input_button.dart';

// In-App Purchases
export 'pro_feature_gate.dart';
export 'ai_limit_dialog.dart';

// Pursuits
export 'pursuit_progress_visual.dart';
export 'pursuit_card.dart';
export 'create_pursuit_sheet.dart';
export 'add_savings_sheet.dart';
export 'pursuit_completion_modal.dart';
export 'pursuit_celebration_overlay.dart';
export 'redirect_savings_sheet.dart';

// Savings Pool
export 'savings_pool_card.dart';
export 'budget_shift_dialog.dart';
export 'pool_allocation_dialog.dart';

// Category Budgets
export 'category_budget_card.dart';
export 'budget_summary_card.dart';
export 'create_budget_sheet.dart';

// Free Tier
export 'upgrade_dialog.dart';
export 'multi_currency_pro_sheet.dart';

// Animations
export 'lottie_animations.dart';

// Security
export 'app_lock_wrapper.dart';

// Dialogs
export 'whats_new_dialog.dart';

// Usage
export 'usage_limits_card.dart';

// Data Visualization
export 'spending_heatmap.dart';

// Paywall
export 'paywall_variants.dart';

// Debug
export 'debug_menu.dart';

// Onboarding
export 'onboarding_checklist.dart';
export 'login_prompt_card.dart';
export 'additional_income_prompt.dart';

// Re-engagement
export 'welcome_back_sheet.dart';


--- FILE: lib/widgets/ai_fab.dart ---

import 'dart:ui';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../theme/theme.dart';

class AIFloatingButton extends StatefulWidget {
  final VoidCallback onTap;
  const AIFloatingButton({super.key, required this.onTap});

  @override
  State<AIFloatingButton> createState() => _AIFloatingButtonState();
}

class _AIFloatingButtonState extends State<AIFloatingButton>
    with TickerProviderStateMixin {
  late AnimationController _glowController;
  late AnimationController _pulseController;
  late Animation<double> _glowAnimation;
  late Animation<double> _pulseAnimation;

  @override
  void initState() {
    super.initState();

    // Glow animation - subtle breathing effect
    _glowController = AnimationController(
      duration: const Duration(milliseconds: 2000),
      vsync: this,
    )..repeat(reverse: true);

    _glowAnimation = Tween<double>(
      begin: 0.4,
      end: 1.0,
    ).animate(CurvedAnimation(parent: _glowController, curve: Curves.easeInOut));

    // Pulse animation - subtle scale effect
    _pulseController = AnimationController(
      duration: const Duration(milliseconds: 1500),
      vsync: this,
    )..repeat(reverse: true);

    _pulseAnimation = Tween<double>(
      begin: 1.0,
      end: 1.05,
    ).animate(CurvedAnimation(parent: _pulseController, curve: Curves.easeInOut));
  }

  @override
  void dispose() {
    _glowController.dispose();
    _pulseController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return AnimatedBuilder(
      animation: Listenable.merge([_glowAnimation, _pulseAnimation]),
      builder: (context, child) {
        return Semantics(
          label: l10n.featureAiChat,
          button: true,
          child: Tooltip(
            message: l10n.featureAiChat,
            child: Transform.scale(
              scale: _pulseAnimation.value,
              child: SizedBox(
                width: 60,
                height: 60,
                child: Stack(
                  alignment: Alignment.center,
                  children: [
                    // Outer glow ring
                    Container(
                      width: 60,
                      height: 60,
                      decoration: BoxDecoration(
                        shape: BoxShape.circle,
                        boxShadow: [
                          // Primary glow
                          BoxShadow(
                            color: context.appColors.primary.withValues(
                              alpha: 0.5 * _glowAnimation.value,
                            ),
                            blurRadius: 20 * _glowAnimation.value,
                            spreadRadius: 4 * _glowAnimation.value,
                          ),
                          // Secondary subtle glow (purple)
                          BoxShadow(
                            color: context.appColors.primaryDark.withValues(
                              alpha: 0.3 * _glowAnimation.value,
                            ),
                            blurRadius: 30 * _glowAnimation.value,
                            spreadRadius: 2,
                          ),
                        ],
                      ),
                    ),
                    // Main button
                    Material(
                      color: Colors.transparent,
                      shape: const CircleBorder(),
                      clipBehavior: Clip.antiAlias,
                      child: InkWell(
                        onTap: () {
                          HapticFeedback.lightImpact();
                          widget.onTap();
                        },
                        child: Container(
                          width: 56,
                          height: 56,
                          decoration: BoxDecoration(
                            gradient: LinearGradient(
                              begin: Alignment.topLeft,
                              end: Alignment.bottomRight,
                              colors: [
                                context.appColors.primary,
                                context.appColors.primaryDark,
                              ],
                            ),
                            shape: BoxShape.circle,
                            border: Border.all(
                              color: Colors.white.withValues(alpha: 0.2),
                              width: 1.5,
                            ),
                          ),
                          child: ClipOval(
                            child: BackdropFilter(
                              filter: ImageFilter.blur(sigmaX: 2, sigmaY: 2),
                              child: Center(
                                child: Container(
                                  width: 36,
                                  height: 36,
                                  decoration: BoxDecoration(
                                    shape: BoxShape.circle,
                                    boxShadow: [
                                      BoxShadow(
                                        color: Colors.white.withValues(alpha: 0.3),
                                        blurRadius: 8,
                                      ),
                                    ],
                                  ),
                                  child: ClipOval(
                                    child: Image.asset(
                                      'assets/icon/app_icon.png',
                                      fit: BoxFit.cover,
                                    ),
                                  ),
                                ),
                              ),
                            ),
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ),
        );
      },
    );
  }
}


--- FILE: lib/widgets/pursuit_celebration_overlay.dart ---

import 'dart:math';
import 'package:confetti/confetti.dart';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter_animate/flutter_animate.dart';
import 'package:lottie/lottie.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';
import '../services/haptic_service.dart';
import '../services/sound_service.dart';
import '../theme/theme.dart';

/// Shows a celebration overlay for pursuit completion
void showPursuitCelebration(
  BuildContext context,
  Pursuit completedPursuit, {
  required VoidCallback onShare,
  required VoidCallback onNewGoal,
}) {
  showGeneralDialog(
    context: context,
    barrierDismissible: false,
    barrierColor: Colors.black87,
    transitionDuration: const Duration(milliseconds: 300),
    pageBuilder: (context, animation, secondaryAnimation) {
      return PursuitCelebrationOverlay(
        completedPursuit: completedPursuit,
        onShare: onShare,
        onNewGoal: onNewGoal,
        onDismiss: () => Navigator.of(context).pop(),
      );
    },
    transitionBuilder: (context, animation, secondaryAnimation, child) {
      return FadeTransition(opacity: animation, child: child);
    },
  );
}

/// Full-screen celebration overlay for pursuit completion
class PursuitCelebrationOverlay extends StatefulWidget {
  final Pursuit completedPursuit;
  final VoidCallback onShare;
  final VoidCallback onNewGoal;
  final VoidCallback onDismiss;

  const PursuitCelebrationOverlay({
    super.key,
    required this.completedPursuit,
    required this.onShare,
    required this.onNewGoal,
    required this.onDismiss,
  });

  @override
  State<PursuitCelebrationOverlay> createState() =>
      _PursuitCelebrationOverlayState();
}

class _PursuitCelebrationOverlayState extends State<PursuitCelebrationOverlay>
    with TickerProviderStateMixin {
  late ConfettiController _confettiController;
  late AnimationController _iconController;
  late Animation<double> _iconScale;

  // Animation timing
  bool _showIcon = false;
  bool _showTitle = false;
  bool _showSubtitle = false;
  bool _showStats = false;
  bool _showButtons = false;

  @override
  void initState() {
    super.initState();

    // Confetti controller
    _confettiController = ConfettiController(
      duration: const Duration(seconds: 3),
    );

    // Icon bounce animation
    _iconController = AnimationController(
      duration: const Duration(milliseconds: 600),
      vsync: this,
    );

    _iconScale = TweenSequence<double>([
      TweenSequenceItem(
        tween: Tween(
          begin: 0.0,
          end: 1.3,
        ).chain(CurveTween(curve: Curves.easeOut)),
        weight: 60,
      ),
      TweenSequenceItem(
        tween: Tween(
          begin: 1.3,
          end: 1.0,
        ).chain(CurveTween(curve: Curves.elasticOut)),
        weight: 40,
      ),
    ]).animate(_iconController);

    // Start animation sequence
    _startAnimationSequence();
  }

  void _startAnimationSequence() async {
    // 200ms - Confetti starts
    await Future.delayed(const Duration(milliseconds: 200));
    if (!mounted) return;
    _confettiController.play();
    haptics.celebrate();
    soundService.playCelebration();

    // 400ms - Icon bounces in
    await Future.delayed(const Duration(milliseconds: 200));
    if (!mounted) return;
    setState(() => _showIcon = true);
    _iconController.forward();
    haptics.light();

    // 600ms - Title fades in
    await Future.delayed(const Duration(milliseconds: 200));
    if (!mounted) return;
    setState(() => _showTitle = true);
    haptics.tap();

    // 800ms - Subtitle fades in
    await Future.delayed(const Duration(milliseconds: 200));
    if (!mounted) return;
    setState(() => _showSubtitle = true);
    haptics.tap();

    // 1000ms - Stats card slides up
    await Future.delayed(const Duration(milliseconds: 200));
    if (!mounted) return;
    setState(() => _showStats = true);
    haptics.light();

    // 1500ms - Buttons fade in
    await Future.delayed(const Duration(milliseconds: 500));
    if (!mounted) return;
    setState(() => _showButtons = true);
    haptics.tap();
  }

  @override
  void dispose() {
    _confettiController.dispose();
    _iconController.dispose();
    super.dispose();
  }

  /// Calculate duration in days
  int get _durationDays {
    final now = widget.completedPursuit.completedAt ?? DateTime.now();
    return now.difference(widget.completedPursuit.createdAt).inDays;
  }

  /// Format saved hours
  String get _savedHoursFormatted {
    // Calculate hours based on saved amount
    // This is simplified - in real implementation you'd calculate based on hourly rate
    final hours =
        widget.completedPursuit.savedAmount / 100; // Placeholder calculation
    return hours.toStringAsFixed(1);
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final colors = context.appColors;

    return Material(
      color: Colors.transparent,
      child: Stack(
        children: [
          // Lottie celebration background
          if (_showIcon)
            Positioned.fill(
              child: IgnorePointer(
                child: Lottie.asset(
                  'assets/animations/celebration.json',
                  repeat: false,
                  fit: BoxFit.cover,
                ),
              ),
            ),

          // Confetti
          Align(
            alignment: Alignment.topCenter,
            child: ConfettiWidget(
              confettiController: _confettiController,
              blastDirection: pi / 2,
              maxBlastForce: 5,
              minBlastForce: 2,
              emissionFrequency: 0.05,
              numberOfParticles: 30,
              gravity: 0.2,
              shouldLoop: false,
              colors: [
                AppColors.primary,
                AppColors.gold,
                Colors.white,
                AppColors.secondary,
                AppColors.accent, // Light gold
              ],
              createParticlePath: (size) => _drawStar(size),
            ),
          ),

          // Content
          SafeArea(
            child: Center(
              child: Padding(
                padding: const EdgeInsets.symmetric(horizontal: 32),
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    // Icon
                    if (_showIcon)
                      ScaleTransition(
                        scale: _iconScale,
                        child: Container(
                          width: 120,
                          height: 120,
                          decoration: BoxDecoration(
                            gradient: LinearGradient(
                              begin: Alignment.topLeft,
                              end: Alignment.bottomRight,
                              colors: [AppColors.primary, AppColors.secondary],
                            ),
                            shape: BoxShape.circle,
                            boxShadow: [
                              BoxShadow(
                                color: AppColors.primary.withValues(alpha: 0.4),
                                blurRadius: 30,
                                spreadRadius: 5,
                              ),
                            ],
                          ),
                          child: Center(
                            child: Text(
                              widget.completedPursuit.emoji,
                              style: const TextStyle(fontSize: 56),
                            ),
                          ),
                        ),
                      ),

                    const SizedBox(height: 32),

                    // Title
                    if (_showTitle)
                      Text(
                            '🎉 ${l10n.celebrationTitle}',
                            style: TextStyle(
                              fontSize: 32,
                              fontWeight: FontWeight.bold,
                              color: colors.textPrimary,
                            ),
                          )
                          .animate()
                          .fadeIn(duration: 300.ms)
                          .slideY(
                            begin: 0.2,
                            end: 0,
                            duration: 300.ms,
                            curve: Curves.easeOut,
                          ),

                    const SizedBox(height: 12),

                    // Subtitle
                    if (_showSubtitle)
                      Text(
                            l10n.celebrationSubtitle(
                              widget.completedPursuit.name,
                            ),
                            style: TextStyle(
                              fontSize: 18,
                              color: colors.textSecondary,
                            ),
                            textAlign: TextAlign.center,
                          )
                          .animate()
                          .fadeIn(duration: 300.ms)
                          .slideY(
                            begin: 0.2,
                            end: 0,
                            duration: 300.ms,
                            curve: Curves.easeOut,
                          ),

                    const SizedBox(height: 32),

                    // Stats Card
                    if (_showStats)
                      Container(
                            padding: const EdgeInsets.all(20),
                            decoration: BoxDecoration(
                              color: colors.surface,
                              borderRadius: BorderRadius.circular(24),
                              border: Border.all(
                                color: colors.cardBorder,
                                width: 1,
                              ),
                            ),
                            child: Column(
                              children: [
                                _buildStatRow(
                                  icon: CupertinoIcons.clock_fill,
                                  label: l10n.celebrationTotalSaved(
                                    _savedHoursFormatted,
                                  ),
                                  colors: colors,
                                ),
                                const SizedBox(height: 12),
                                _buildStatRow(
                                  icon: CupertinoIcons.calendar,
                                  label: l10n.celebrationDuration(
                                    _durationDays,
                                  ),
                                  colors: colors,
                                ),
                              ],
                            ),
                          )
                          .animate()
                          .fadeIn(duration: 300.ms)
                          .slideY(
                            begin: 0.3,
                            end: 0,
                            duration: 400.ms,
                            curve: Curves.easeOut,
                          ),

                    const SizedBox(height: 40),

                    // Buttons
                    if (_showButtons) ...[
                      // Share Button (Primary)
                      SizedBox(
                            width: double.infinity,
                            height: 56,
                            child: ElevatedButton(
                              onPressed: () {
                                haptics.buttonPress();
                                widget.onDismiss();
                                widget.onShare();
                              },
                              style: ElevatedButton.styleFrom(
                                backgroundColor: AppColors.primary,
                                foregroundColor: Colors.white,
                                shape: RoundedRectangleBorder(
                                  borderRadius: BorderRadius.circular(16),
                                ),
                                elevation: 0,
                              ),
                              child: Row(
                                mainAxisAlignment: MainAxisAlignment.center,
                                children: [
                                  Icon(
                                    CupertinoIcons.share,
                                    size: 20,
                                  ),
                                  const SizedBox(width: 8),
                                  Text(
                                    l10n.celebrationShare,
                                    style: const TextStyle(
                                      fontSize: 16,
                                      fontWeight: FontWeight.w600,
                                    ),
                                  ),
                                ],
                              ),
                            ),
                          )
                          .animate()
                          .fadeIn(duration: 300.ms)
                          .slideY(
                            begin: 0.2,
                            end: 0,
                            duration: 300.ms,
                            curve: Curves.easeOut,
                          ),

                      const SizedBox(height: 12),

                      // New Goal Button (Secondary)
                      SizedBox(
                            width: double.infinity,
                            height: 56,
                            child: OutlinedButton(
                              onPressed: () {
                                haptics.buttonPress();
                                widget.onDismiss();
                                widget.onNewGoal();
                              },
                              style: OutlinedButton.styleFrom(
                                foregroundColor: colors.textPrimary,
                                side: BorderSide(
                                  color: colors.cardBorder,
                                  width: 1.5,
                                ),
                                shape: RoundedRectangleBorder(
                                  borderRadius: BorderRadius.circular(16),
                                ),
                              ),
                              child: Row(
                                mainAxisAlignment: MainAxisAlignment.center,
                                children: [
                                  Icon(
                                    CupertinoIcons.scope,
                                    size: 20,
                                  ),
                                  const SizedBox(width: 8),
                                  Text(
                                    l10n.celebrationNewGoal,
                                    style: const TextStyle(
                                      fontSize: 16,
                                      fontWeight: FontWeight.w600,
                                    ),
                                  ),
                                ],
                              ),
                            ),
                          )
                          .animate()
                          .fadeIn(duration: 300.ms, delay: 100.ms)
                          .slideY(
                            begin: 0.2,
                            end: 0,
                            duration: 300.ms,
                            delay: 100.ms,
                            curve: Curves.easeOut,
                          ),

                      const SizedBox(height: 16),

                      // Dismiss Button
                      TextButton(
                        onPressed: () {
                          haptics.tap();
                          widget.onDismiss();
                        },
                        child: Text(
                          l10n.celebrationDismiss,
                          style: TextStyle(
                            color: colors.textTertiary,
                            fontSize: 14,
                          ),
                        ),
                      ).animate().fadeIn(duration: 300.ms, delay: 200.ms),
                    ],
                  ],
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildStatRow({
    required IconData icon,
    required String label,
    required dynamic colors,
  }) {
    return Row(
      children: [
        Container(
          width: 40,
          height: 40,
          decoration: BoxDecoration(
            color: AppColors.primary.withValues(alpha: 0.1),
            borderRadius: BorderRadius.circular(8),
          ),
          child: Icon(icon, color: AppColors.primary, size: 20),
        ),
        const SizedBox(width: 12),
        Text(
          label,
          style: TextStyle(
            fontSize: 16,
            color: colors.textPrimary,
            fontWeight: FontWeight.w500,
          ),
        ),
      ],
    );
  }

  /// Draw a star shape for confetti
  Path _drawStar(Size size) {
    final path = Path();
    final double halfWidth = size.width / 2;
    final double halfHeight = size.height / 2;
    final double outerRadius = halfWidth;
    final double innerRadius = halfWidth * 0.4;

    for (int i = 0; i < 5; i++) {
      final double angle = (i * 72 - 90) * pi / 180;
      final double nextAngle = ((i * 72) + 36 - 90) * pi / 180;

      final outerX = halfWidth + outerRadius * cos(angle);
      final outerY = halfHeight + outerRadius * sin(angle);
      final innerX = halfWidth + innerRadius * cos(nextAngle);
      final innerY = halfHeight + innerRadius * sin(nextAngle);

      if (i == 0) {
        path.moveTo(outerX, outerY);
      } else {
        path.lineTo(outerX, outerY);
      }
      path.lineTo(innerX, innerY);
    }

    path.close();
    return path;
  }
}


--- FILE: lib/widgets/locked_pro_feature.dart ---

import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import '../l10n/app_localizations.dart';
import '../providers/pro_provider.dart';
import '../screens/paywall_screen.dart';
import '../services/analytics_service.dart';
import '../theme/theme.dart';

/// A widget that blurs content and shows a lock icon for PRO-only features.
/// Tapping opens a PRO features sheet with paywall access.
class LockedProFeature extends StatelessWidget {
  /// The widget to display (will be blurred if not PRO)
  final Widget child;

  /// Feature name to highlight in the PRO sheet
  final String featureName;

  /// Whether to show the lock badge
  final bool showLockBadge;

  /// Blur intensity (default 8.0)
  final double blurSigma;

  const LockedProFeature({
    super.key,
    required this.child,
    required this.featureName,
    this.showLockBadge = true,
    this.blurSigma = 8.0,
  });

  @override
  Widget build(BuildContext context) {
    final isPro = context.watch<ProProvider>().isPro;

    // PRO users see the content normally
    if (isPro) {
      return child;
    }

    // FREE users see blurred content with lock
    return GestureDetector(
      onTap: () {
        HapticFeedback.mediumImpact();
        // Track Pro feature tapped for conversion funnel
        AnalyticsService().logProFeatureTapped(featureName);
        _showProFeaturesSheet(context);
      },
      child: Stack(
        children: [
          // Blurred content
          ClipRRect(
            borderRadius: BorderRadius.circular(16),
            child: ImageFiltered(
              imageFilter: ImageFilter.blur(
                sigmaX: blurSigma,
                sigmaY: blurSigma,
              ),
              child: child,
            ),
          ),

          // Overlay with lock icon
          Positioned.fill(
            child: LayoutBuilder(
              builder: (context, constraints) {
                final isCompact = constraints.maxHeight < 120;
                final iconSize = isCompact ? 32.0 : 56.0;
                final lockIconSize = isCompact ? 18.0 : 28.0;

                return Container(
                  decoration: BoxDecoration(
                    borderRadius: BorderRadius.circular(16),
                    color: Colors.black.withValues(alpha: 0.3),
                  ),
                  child: Center(
                    child: SingleChildScrollView(
                      physics: const NeverScrollableScrollPhysics(),
                      child: Padding(
                        padding: const EdgeInsets.symmetric(vertical: 8),
                        child: Column(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            // Lock icon with glow
                            Container(
                              width: iconSize,
                              height: iconSize,
                              decoration: BoxDecoration(
                                color: context.appColors.primary
                                    .withValues(alpha: 0.2),
                                shape: BoxShape.circle,
                                boxShadow: [
                                  BoxShadow(
                                    color: context.appColors.primary.withValues(
                                      alpha: 0.4,
                                    ),
                                    blurRadius: isCompact ? 10 : 20,
                                    spreadRadius: isCompact ? 1 : 2,
                                  ),
                                ],
                              ),
                              child: Icon(
                                CupertinoIcons.lock_fill,
                                color: Colors.white,
                                size: lockIconSize,
                              ),
                            ),
                            if (!isCompact) ...[
                              const SizedBox(height: 12),
                              // PRO badge
                              if (showLockBadge)
                                Container(
                                  padding: const EdgeInsets.symmetric(
                                    horizontal: 16,
                                    vertical: 8,
                                  ),
                                  decoration: BoxDecoration(
                                    gradient: LinearGradient(
                                      colors: [
                                        context.appColors.primary,
                                        context.appColors.primary
                                            .withValues(alpha: 0.8),
                                      ],
                                    ),
                                    borderRadius: BorderRadius.circular(24),
                                    boxShadow: [
                                      BoxShadow(
                                        color:
                                            context.appColors.primary.withValues(
                                          alpha: 0.4,
                                        ),
                                        blurRadius: 12,
                                        offset: const Offset(0, 4),
                                      ),
                                    ],
                                  ),
                                  child: Row(
                                    mainAxisSize: MainAxisSize.min,
                                    children: [
                                      const Icon(
                                        CupertinoIcons.star_circle_fill,
                                        color: Colors.white,
                                        size: 16,
                                      ),
                                      const SizedBox(width: 6),
                                      Text(
                                        'PRO',
                                        style: TextStyle(
                                          color: Colors.white,
                                          fontSize: 14,
                                          fontWeight: FontWeight.w700,
                                          letterSpacing: 1,
                                        ),
                                      ),
                                    ],
                                  ),
                                ),
                              const SizedBox(height: 8),
                              Text(
                                AppLocalizations.of(context)
                                    .lockedFeatureTapToUnlock,
                                style: TextStyle(
                                  color: Colors.white.withValues(alpha: 0.8),
                                  fontSize: 12,
                                  fontWeight: FontWeight.w500,
                                ),
                              ),
                            ],
                          ],
                        ),
                      ),
                    ),
                  ),
                );
              },
            ),
          ),
        ],
      ),
    );
  }

  void _showProFeaturesSheet(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      builder: (context) => ProFeaturesSheet(highlightedFeature: featureName),
    );
  }
}

/// Bottom sheet that shows all PRO features and opens paywall
class ProFeaturesSheet extends StatelessWidget {
  final String? highlightedFeature;

  const ProFeaturesSheet({super.key, this.highlightedFeature});

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    final proFeatures = [
      _ProFeatureItem(
        icon: CupertinoIcons.chart_bar_alt_fill,
        title: l10n.proFeatureHeatmap,
        description: l10n.proFeatureHeatmapDesc,
        color: context.appColors.primary,
      ),
      _ProFeatureItem(
        icon: CupertinoIcons.chart_pie_fill,
        title: l10n.proFeatureCategoryBreakdown,
        description: l10n.proFeatureCategoryBreakdownDesc,
        color: context.appColors.warning,
      ),
      _ProFeatureItem(
        icon: CupertinoIcons.arrow_up_right,
        title: l10n.proFeatureSpendingTrends,
        description: l10n.proFeatureSpendingTrendsDesc,
        color: context.appColors.success,
      ),
      _ProFeatureItem(
        icon: CupertinoIcons.clock_fill,
        title: l10n.proFeatureTimeAnalysis,
        description: l10n.proFeatureTimeAnalysisDesc,
        color: context.appColors.info,
      ),
      _ProFeatureItem(
        icon: CupertinoIcons.money_dollar_circle_fill,
        title: l10n.proFeatureBudgetBreakdown,
        description: l10n.proFeatureBudgetBreakdownDesc,
        color: context.appColors.error,
      ),
      _ProFeatureItem(
        icon: CupertinoIcons.slider_horizontal_3,
        title: l10n.proFeatureAdvancedFilters,
        description: l10n.proFeatureAdvancedFiltersDesc,
        color: context.appColors.primary,
      ),
      _ProFeatureItem(
        icon: CupertinoIcons.doc_chart_fill,
        title: l10n.proFeatureExcelExport,
        description: l10n.proFeatureExcelExportDesc,
        color: context.appColors.success,
      ),
      _ProFeatureItem(
        icon: CupertinoIcons.arrow_counterclockwise,
        title: l10n.proFeatureUnlimitedHistory,
        description: l10n.proFeatureUnlimitedHistoryDesc,
        color: context.appColors.warning,
      ),
    ];

    return Container(
      constraints: BoxConstraints(
        maxHeight: MediaQuery.of(context).size.height * 0.85,
      ),
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
      ),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          // Handle bar
          Padding(
            padding: const EdgeInsets.only(top: 12, bottom: 8),
            child: Container(
              width: 40,
              height: 4,
              decoration: BoxDecoration(
                color: context.appColors.textTertiary.withValues(alpha: 0.3),
                borderRadius: BorderRadius.circular(2),
              ),
            ),
          ),

          // Header
          Padding(
            padding: const EdgeInsets.fromLTRB(24, 8, 24, 16),
            child: Column(
              children: [
                // Crown icon with glow
                Container(
                  width: 72,
                  height: 72,
                  decoration: BoxDecoration(
                    gradient: LinearGradient(
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                      colors: [
                        context.appColors.primary,
                        context.appColors.primary.withValues(alpha: 0.7),
                      ],
                    ),
                    shape: BoxShape.circle,
                    boxShadow: [
                      BoxShadow(
                        color: context.appColors.primary.withValues(alpha: 0.4),
                        blurRadius: 24,
                        spreadRadius: 4,
                      ),
                    ],
                  ),
                  child: const Icon(
                    CupertinoIcons.star_circle_fill,
                    color: Colors.white,
                    size: 36,
                  ),
                ),
                const SizedBox(height: 16),
                Text(
                  l10n.proFeaturesSheetTitle,
                  style: TextStyle(
                    fontSize: 24,
                    fontWeight: FontWeight.w700,
                    color: context.appColors.textPrimary,
                  ),
                ),
                const SizedBox(height: 8),
                Text(
                  l10n.proFeaturesSheetSubtitle,
                  style: TextStyle(
                    fontSize: 14,
                    color: context.appColors.textSecondary,
                  ),
                  textAlign: TextAlign.center,
                ),
              ],
            ),
          ),

          // Features list
          Flexible(
            child: SingleChildScrollView(
              padding: const EdgeInsets.symmetric(horizontal: 24),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    l10n.proFeaturesIncluded,
                    style: TextStyle(
                      fontSize: 14,
                      fontWeight: FontWeight.w600,
                      color: context.appColors.textSecondary,
                      letterSpacing: 0.5,
                    ),
                  ),
                  const SizedBox(height: 16),
                  ...proFeatures.map(
                    (feature) => _buildFeatureItem(
                      context,
                      feature,
                      isHighlighted: feature.title == highlightedFeature,
                    ),
                  ),
                ],
              ),
            ),
          ),

          // Go PRO button
          SafeArea(
            child: Padding(
              padding: const EdgeInsets.all(24),
              child: SizedBox(
                width: double.infinity,
                height: 56,
                child: ElevatedButton(
                  onPressed: () {
                    Navigator.pop(context);
                    // Navigate to paywall screen
                    Navigator.push(
                      context,
                      MaterialPageRoute(
                        builder: (context) => const PaywallScreen(),
                      ),
                    );
                  },
                  style: ElevatedButton.styleFrom(
                    backgroundColor: context.appColors.primary,
                    foregroundColor: Colors.white,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(16),
                    ),
                    elevation: 0,
                  ),
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      const Icon(CupertinoIcons.star_circle_fill, size: 20),
                      const SizedBox(width: 8),
                      Text(
                        l10n.goProButton,
                        style: const TextStyle(
                          fontSize: 16,
                          fontWeight: FontWeight.w700,
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildFeatureItem(
    BuildContext context,
    _ProFeatureItem feature, {
    bool isHighlighted = false,
  }) {
    return Container(
      margin: const EdgeInsets.only(bottom: 12),
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: isHighlighted
            ? context.appColors.primary.withValues(alpha: 0.1)
            : context.appColors.surfaceLight,
        borderRadius: BorderRadius.circular(16),
        border: isHighlighted
            ? Border.all(
                color: context.appColors.primary.withValues(alpha: 0.5),
                width: 1.5,
              )
            : null,
      ),
      child: Row(
        children: [
          Container(
            width: 44,
            height: 44,
            decoration: BoxDecoration(
              color: feature.color.withValues(alpha: 0.15),
              borderRadius: BorderRadius.circular(16),
            ),
            child: Icon(feature.icon, color: feature.color, size: 22),
          ),
          const SizedBox(width: 14),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Expanded(
                      child: Text(
                        feature.title,
                        style: TextStyle(
                          fontSize: 15,
                          fontWeight: FontWeight.w600,
                          color: context.appColors.textPrimary,
                        ),
                      ),
                    ),
                    if (isHighlighted)
                      Container(
                        padding: const EdgeInsets.symmetric(
                          horizontal: 8,
                          vertical: 4,
                        ),
                        decoration: BoxDecoration(
                          color: context.appColors.primary,
                          borderRadius: BorderRadius.circular(6),
                        ),
                        child: const Icon(
                          CupertinoIcons.star_fill,
                          color: Colors.white,
                          size: 12,
                        ),
                      ),
                  ],
                ),
                const SizedBox(height: 4),
                Text(
                  feature.description,
                  style: TextStyle(
                    fontSize: 12,
                    color: context.appColors.textSecondary,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

class _ProFeatureItem {
  final IconData icon;
  final String title;
  final String description;
  final Color color;

  const _ProFeatureItem({
    required this.icon,
    required this.title,
    required this.description,
    required this.color,
  });
}


--- FILE: lib/widgets/quick_add_sheet.dart ---

import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';
import '../providers/currency_provider.dart';
import '../services/services.dart';
import '../theme/theme.dart';
import '../theme/app_theme.dart';
import '../utils/currency_utils.dart';
import 'decision_stress_timer.dart';
import 'voice_input_button.dart';

/// Quick add expense bottom sheet
/// Article 11: Category selection required, subcategories open with animation
class QuickAddSheet extends StatefulWidget {
  final Function(double amount, String category, String? subCategory) onAdd;
  final VoidCallback? onCancel;

  const QuickAddSheet({super.key, required this.onAdd, this.onCancel});

  @override
  State<QuickAddSheet> createState() => _QuickAddSheetState();
}

class _QuickAddSheetState extends State<QuickAddSheet>
    with SingleTickerProviderStateMixin {
  final _amountController = TextEditingController();
  final _subCategoryController = TextEditingController();
  final _amountFocusNode = FocusNode();
  final _subCategoryService = SubCategoryService();

  // Anayasa Madde 11: Varsayılan kategori YOK
  String? _selectedCategory;
  String? _selectedSubCategory;
  SubCategorySuggestions? _subCategorySuggestions;
  bool _hasValidAmount = false;
  bool _showCategoryWarning = false;

  // Alt kategori animasyonu
  late AnimationController _subCategoryAnimController;
  late Animation<double> _subCategorySlideAnimation;
  late Animation<double> _subCategoryFadeAnimation;

  @override
  void initState() {
    super.initState();

    // Alt kategori animasyon controller
    _subCategoryAnimController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 350),
    );

    _subCategorySlideAnimation = Tween<double>(begin: -20, end: 0).animate(
      CurvedAnimation(
        parent: _subCategoryAnimController,
        curve: Curves.easeOutCubic,
      ),
    );

    _subCategoryFadeAnimation = Tween<double>(begin: 0, end: 1).animate(
      CurvedAnimation(
        parent: _subCategoryAnimController,
        curve: Curves.easeOut,
      ),
    );

    // Klavyeyi otomatik aç
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _amountFocusNode.requestFocus();
    });
  }

  @override
  void dispose() {
    _amountController.dispose();
    _subCategoryController.dispose();
    _amountFocusNode.dispose();
    _subCategoryAnimController.dispose();
    super.dispose();
  }

  void _validateAmount() {
    final amount = parseAmount(_amountController.text);
    setState(() {
      _hasValidAmount = amount != null && amount > 0;
      // Uyarıyı kaldır (tekrar deneyebilir)
      if (_hasValidAmount) _showCategoryWarning = false;
    });
  }

  /// Ana kategori seçildiğinde
  Future<void> _onCategorySelected(String category) async {
    HapticFeedback.selectionClick();

    setState(() {
      _selectedCategory = category;
      _selectedSubCategory = null;
      _showCategoryWarning = false;
    });

    // Alt kategori önerilerini yükle
    final suggestions = await _subCategoryService.getSuggestions(category);

    if (mounted) {
      setState(() {
        _subCategorySuggestions = suggestions;
      });

      // Animasyonu başlat
      _subCategoryAnimController.forward(from: 0);
    }
  }

  /// Alt kategori seçildiğinde
  void _onSubCategorySelected(String subCategory) {
    HapticFeedback.lightImpact();
    setState(() {
      _selectedSubCategory = subCategory;
      _subCategoryController.text = subCategory;
    });
  }

  /// Submit form
  void _submit() {
    final l10n = AppLocalizations.of(context);
    final amount = parseAmount(_amountController.text);

    // Amount validation
    if (amount == null || amount <= 0) {
      HapticFeedback.heavyImpact();
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(l10n.pleaseEnterValidAmount),
          backgroundColor: context.appColors.error,
          behavior: SnackBarBehavior.floating,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(16),
          ),
        ),
      );
      return;
    }

    // Article 11: Category validation
    if (_selectedCategory == null) {
      HapticFeedback.heavyImpact();
      setState(() => _showCategoryWarning = true);
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Row(
            children: [
              Icon(
                CupertinoIcons.exclamationmark_circle_fill,
                color: context.appColors.background,
                size: 20,
              ),
              const SizedBox(width: 10),
              Expanded(
                child: Text(
                  l10n.pleaseSelectExpenseGroup,
                  style: const TextStyle(fontWeight: FontWeight.w500),
                ),
              ),
            ],
          ),
          backgroundColor: context.appColors.warning,
          behavior: SnackBarBehavior.floating,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(16),
          ),
          duration: const Duration(seconds: 3),
        ),
      );
      return;
    }

    // Başarılı - kaydet
    HapticFeedback.mediumImpact();
    soundService.playCoin();
    final subCategory = _subCategoryController.text.trim().isNotEmpty
        ? _subCategoryController.text.trim()
        : _selectedSubCategory;

    widget.onAdd(amount, _selectedCategory!, subCategory);
    Navigator.pop(context);
  }

  bool get _canSubmit => _hasValidAmount && _selectedCategory != null;

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    return Container(
      padding: EdgeInsets.only(
        left: 24,
        right: 24,
        top: 16,
        bottom: MediaQuery.of(context).viewInsets.bottom + 24,
      ),
      decoration: BoxDecoration(
        // Solid dark background - not transparent
        color: context.appColors.gradientMid, // #1A1A2E - solid dark
        borderRadius: const BorderRadius.vertical(top: Radius.circular(28)),
        border: Border.all(color: context.appColors.cardBorder, width: 1),
      ),
      child: SingleChildScrollView(
        child: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Handle bar
            Center(
              child: Container(
                width: 40,
                height: 4,
                decoration: BoxDecoration(
                  color: context.appColors.textTertiary.withValues(alpha: 0.3),
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
            ),

            const SizedBox(height: 24),

            // Header
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      l10n.newExpense,
                      style: TextStyle(
                        fontSize: 22,
                        fontWeight: FontWeight.w700,
                        color: context.appColors.textPrimary,
                        letterSpacing: -0.5,
                      ),
                    ),
                    const SizedBox(height: 4),
                    Text(
                      l10n.categoryRequired,
                      style: TextStyle(
                        fontSize: 12,
                        fontWeight: FontWeight.w500,
                        color: context.appColors.textTertiary,
                      ),
                    ),
                  ],
                ),
                Row(
                  children: [
                    // Voice input button - opens full VoiceInputScreen
                    const CompactVoiceButton(),
                    const SizedBox(width: 8),
                    // Close button
                    IconButton(
                      tooltip: l10n.close,
                      onPressed: () {
                        widget.onCancel?.call();
                        Navigator.pop(context);
                      },
                      icon: Container(
                        width: 36,
                        height: 36,
                        decoration: BoxDecoration(
                          color: context.appColors.surfaceLight,
                          shape: BoxShape.circle,
                        ),
                        child: Icon(
                          CupertinoIcons.xmark,
                          size: 20,
                          color: context.appColors.textSecondary,
                        ),
                      ),
                    ),
                  ],
                ),
              ],
            ),

            const SizedBox(height: 28),

            // STEP 1: Amount input
            _buildAmountInput(l10n),

            const SizedBox(height: 24),

            // STEP 2: Category selection (required)
            _buildCategorySection(l10n),

            // STEP 3: Subcategory (animated, optional)
            _buildSubCategorySection(l10n),

            const SizedBox(height: 28),

            // Calculate button
            _buildSubmitButton(l10n),
          ],
        ),
      ),
    );
  }

  /// Amount input field
  Widget _buildAmountInput(AppLocalizations l10n) {
    return Container(
      padding: const EdgeInsets.symmetric(vertical: 20, horizontal: 24),
      decoration: BoxDecoration(
        color: context.appColors.surfaceLight,
        borderRadius: BorderRadius.circular(24),
        border: Border.all(
          color: _hasValidAmount
              ? context.appColors.primary.withValues(alpha: 0.5)
              : context.appColors.cardBorder,
          width: _hasValidAmount ? 2 : 1,
        ),
      ),
      child: Row(
        children: [
          Expanded(
            child: TextField(
              controller: _amountController,
              focusNode: _amountFocusNode,
              keyboardType: const TextInputType.numberWithOptions(
                decimal: true,
              ),
              inputFormatters: [
                PremiumCurrencyFormatter(
                  allowDecimals: true,
                  maxIntegerDigits: 12,
                ),
              ],
              style: TextStyle(
                fontSize: 32,
                fontWeight: FontWeight.w700,
                color: context.appColors.textPrimary,
                letterSpacing: -1,
              ),
              textAlign: TextAlign.center,
              decoration: InputDecoration(
                hintText: '0',
                hintStyle: TextStyle(
                  fontSize: 32,
                  fontWeight: FontWeight.w700,
                  color: context.appColors.textTertiary.withValues(alpha: 0.5),
                ),
                border: InputBorder.none,
                contentPadding: EdgeInsets.zero,
              ),
              onChanged: (_) => _validateAmount(),
            ),
          ),
          const SizedBox(width: 8),
          Text(
            l10n.tl,
            style: TextStyle(
              fontSize: 20,
              fontWeight: FontWeight.w600,
              color: context.appColors.textSecondary,
            ),
          ),
        ],
      ),
    );
  }

  /// Category selection section
  Widget _buildCategorySection(AppLocalizations l10n) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // Title
        Row(
          children: [
            Container(
              width: 4,
              height: 16,
              decoration: BoxDecoration(
                color: _showCategoryWarning
                    ? context.appColors.warning
                    : context.appColors.primary,
                borderRadius: BorderRadius.circular(2),
              ),
            ),
            const SizedBox(width: 10),
            Text(
              l10n.expenseGroup,
              style: TextStyle(
                fontSize: 14,
                fontWeight: FontWeight.w600,
                color: _showCategoryWarning
                    ? context.appColors.warning
                    : context.appColors.textPrimary,
              ),
            ),
            const SizedBox(width: 6),
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
              decoration: BoxDecoration(
                color: _showCategoryWarning
                    ? context.appColors.warning.withValues(alpha: 0.15)
                    : context.appColors.primary.withValues(alpha: 0.1),
                borderRadius: BorderRadius.circular(4),
              ),
              child: Text(
                l10n.required,
                style: TextStyle(
                  fontSize: 10,
                  fontWeight: FontWeight.w600,
                  color: _showCategoryWarning
                      ? context.appColors.warning
                      : context.appColors.primary,
                ),
              ),
            ),
          ],
        ),

        const SizedBox(height: 14),

        // Kategori chips - yatay scroll
        SizedBox(
          height: 48,
          child: ListView.separated(
            scrollDirection: Axis.horizontal,
            itemCount: ExpenseCategory.all.length,
            separatorBuilder: (context, index) => const SizedBox(width: 10),
            itemBuilder: (context, index) {
              final category = ExpenseCategory.all[index];
              final isSelected = category == _selectedCategory;

              return Semantics(
                label: ExpenseCategory.getLocalizedName(category, l10n),
                button: true,
                selected: isSelected,
                child: GestureDetector(
                  onTap: () => _onCategorySelected(category),
                  child: AnimatedContainer(
                    duration: const Duration(milliseconds: 200),
                    padding: const EdgeInsets.symmetric(horizontal: 16),
                    decoration: BoxDecoration(
                      color: isSelected
                          ? context.appColors.primary
                          : _showCategoryWarning
                          ? context.appColors.warning.withValues(alpha: 0.08)
                          : context.appColors.surfaceLight,
                      borderRadius: BorderRadius.circular(24),
                      border: Border.all(
                        color: isSelected
                            ? context.appColors.primary
                            : _showCategoryWarning
                            ? context.appColors.warning.withValues(alpha: 0.3)
                            : context.appColors.cardBorder,
                        width: isSelected ? 2 : 1,
                      ),
                      boxShadow: isSelected
                          ? [
                              BoxShadow(
                                color: context.appColors.primary.withValues(
                                  alpha: 0.3,
                                ),
                                blurRadius: 8,
                                offset: const Offset(0, 2),
                              ),
                            ]
                          : null,
                    ),
                    alignment: Alignment.center,
                    child: Row(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        Icon(
                          ExpenseCategory.getIcon(category),
                          size: 20,
                          color: isSelected
                              ? context.appColors.background
                              : ExpenseCategory.getColor(category),
                        ),
                        const SizedBox(width: 8),
                        Text(
                          ExpenseCategory.getLocalizedName(category, l10n),
                          style: TextStyle(
                            fontSize: 14,
                            fontWeight: isSelected
                                ? FontWeight.w600
                                : FontWeight.w500,
                            color: isSelected
                                ? context.appColors.background
                                : context.appColors.textSecondary,
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              );
            },
          ),
        ),
      ],
    );
  }

  /// Subcategory section (animated)
  Widget _buildSubCategorySection(AppLocalizations l10n) {
    // Don't show if category not selected
    if (_selectedCategory == null) {
      return const SizedBox.shrink();
    }

    return AnimatedBuilder(
      animation: _subCategoryAnimController,
      builder: (context, child) {
        return Transform.translate(
          offset: Offset(0, _subCategorySlideAnimation.value),
          child: Opacity(
            opacity: _subCategoryFadeAnimation.value,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const SizedBox(height: 24),

                // Subcategory title
                Row(
                  children: [
                    Container(
                      width: 4,
                      height: 16,
                      decoration: BoxDecoration(
                        color: context.appColors.secondary,
                        borderRadius: BorderRadius.circular(2),
                      ),
                    ),
                    const SizedBox(width: 10),
                    Text(
                      l10n.detail,
                      style: TextStyle(
                        fontSize: 14,
                        fontWeight: FontWeight.w600,
                        color: context.appColors.textPrimary,
                      ),
                    ),
                    const SizedBox(width: 6),
                    Container(
                      padding: const EdgeInsets.symmetric(
                        horizontal: 6,
                        vertical: 2,
                      ),
                      decoration: BoxDecoration(
                        color: context.appColors.surfaceLight,
                        borderRadius: BorderRadius.circular(4),
                      ),
                      child: Text(
                        l10n.optional,
                        style: TextStyle(
                          fontSize: 10,
                          fontWeight: FontWeight.w500,
                          color: context.appColors.textTertiary,
                        ),
                      ),
                    ),
                  ],
                ),

                const SizedBox(height: 14),

                // Alt kategori önerileri
                if (_subCategorySuggestions != null &&
                    !_subCategorySuggestions!.isEmpty) ...[
                  Wrap(
                    spacing: 8,
                    runSpacing: 8,
                    children: [
                      // Son kullanılanlar (outline stil)
                      ..._subCategorySuggestions!.recent.map(
                        (sub) => _buildSubCategoryChip(sub, isRecent: true),
                      ),
                      // Sabit öneriler
                      ..._subCategorySuggestions!.fixed.map(
                        (sub) => _buildSubCategoryChip(sub, isRecent: false),
                      ),
                    ],
                  ),
                  const SizedBox(height: 14),
                ],

                // Manuel giriş alanı
                Container(
                  decoration: BoxDecoration(
                    color: context.appColors.surfaceLight,
                    borderRadius: BorderRadius.circular(16),
                    border: Border.all(color: context.appColors.cardBorder),
                  ),
                  child: TextField(
                    controller: _subCategoryController,
                    keyboardType: TextInputType.text,
                    enableSuggestions: true,
                    autocorrect: false,
                    enableIMEPersonalizedLearning: true,
                    textCapitalization: TextCapitalization.words,
                    style: TextStyle(
                      fontSize: 15,
                      fontWeight: FontWeight.w500,
                      color: context.appColors.textPrimary,
                    ),
                    decoration: InputDecoration(
                      hintText:
                          'Örn: ${_getExampleForCategory(_selectedCategory!)}',
                      hintStyle: TextStyle(
                        fontSize: 14,
                        color: context.appColors.textTertiary.withValues(
                          alpha: 0.6,
                        ),
                      ),
                      prefixIcon: Icon(
                        CupertinoIcons.doc_text,
                        size: 22,
                        color: context.appColors.textTertiary,
                      ),
                      border: InputBorder.none,
                      contentPadding: const EdgeInsets.symmetric(
                        horizontal: 16,
                        vertical: 14,
                      ),
                    ),
                    onChanged: (value) {
                      if (value.isNotEmpty) {
                        setState(() => _selectedSubCategory = null);
                      }
                    },
                  ),
                ),
              ],
            ),
          ),
        );
      },
    );
  }

  /// Alt kategori chip
  Widget _buildSubCategoryChip(String subCategory, {required bool isRecent}) {
    final isSelected = _selectedSubCategory == subCategory;

    return Semantics(
      label: subCategory,
      button: true,
      selected: isSelected,
      child: GestureDetector(
        onTap: () => _onSubCategorySelected(subCategory),
        child: AnimatedContainer(
          duration: const Duration(milliseconds: 150),
          padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 8),
          decoration: BoxDecoration(
            color: isSelected
                ? context.appColors.secondary.withValues(alpha: 0.15)
                : isRecent
                ? Colors.transparent
                : context.appColors.surfaceLighter,
            borderRadius: BorderRadius.circular(24),
            border: Border.all(
              color: isSelected
                  ? context.appColors.secondary
                  : isRecent
                  ? context.appColors.secondary.withValues(alpha: 0.4)
                  : context.appColors.cardBorder,
              width: isSelected ? 1.5 : 1,
            ),
          ),
          child: Row(
            mainAxisSize: MainAxisSize.min,
            children: [
              if (isRecent)
                Padding(
                  padding: const EdgeInsets.only(right: 6),
                  child: Icon(
                    CupertinoIcons.clock_fill,
                    size: 14,
                    color: isSelected
                        ? context.appColors.secondary
                        : context.appColors.textTertiary,
                  ),
                ),
              Text(
                subCategory,
                style: TextStyle(
                  fontSize: 13,
                  fontWeight: isSelected ? FontWeight.w600 : FontWeight.w500,
                  color: isSelected
                      ? context.appColors.secondary
                      : context.appColors.textSecondary,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  /// Submit button
  Widget _buildSubmitButton(AppLocalizations l10n) {
    return SizedBox(
      width: double.infinity,
      height: 56,
      child: ElevatedButton(
        onPressed: _submit, // Always clickable, validation inside
        style: ElevatedButton.styleFrom(
          backgroundColor: _canSubmit
              ? context.appColors.primary
              : context.appColors.surfaceLight,
          foregroundColor: _canSubmit
              ? context.appColors.background
              : context.appColors.textTertiary,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(16),
          ),
          elevation: 0,
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              _canSubmit
                  ? CupertinoIcons.plus_slash_minus
                  : CupertinoIcons.hand_point_right_fill,
              size: 22,
            ),
            const SizedBox(width: 10),
            Text(
              _selectedCategory == null ? l10n.selectCategory : l10n.calculate,
              style: const TextStyle(fontSize: 16, fontWeight: FontWeight.w600),
            ),
          ],
        ),
      ),
    );
  }

  /// Kategori için örnek alt kategori
  String _getExampleForCategory(String category) {
    switch (category) {
      case 'Yiyecek':
        return 'Kahve, Market, Restoran';
      case 'Ulaşım':
        return 'Benzin, Taksi, Otobüs';
      case 'Giyim':
        return 'Kaban, Ayakkabı, T-shirt';
      case 'Elektronik':
        return 'Telefon, Kulaklık, Şarj';
      case 'Eğlence':
        return 'Sinema, Oyun, Konser';
      case 'Sağlık':
        return 'İlaç, Doktor, Vitamin';
      case 'Eğitim':
        return 'Kitap, Kurs, Defter';
      case 'Faturalar':
        return 'Elektrik, Su, İnternet';
      default:
        return 'Açıklama yazın...';
    }
  }
}

/// Quick Add Sheet'i göster (legacy)
void showQuickAddSheet(
  BuildContext context, {
  required Function(double amount, String category, String? subCategory) onAdd,
}) {
  HapticFeedback.lightImpact();
  showModalBottomSheet(
    context: context,
    isScrollControlled: true,
    backgroundColor: Colors.transparent,
    barrierColor: Colors.black.withValues(alpha: 0.85),
    builder: (context) => QuickAddSheet(onAdd: onAdd),
  );
}

/// Premium harcama ekleme modal'ı göster (WealthModal ile)
void showPremiumExpenseModal(
  BuildContext context, {
  required Function(double amount, String category, String? subCategory) onAdd,
}) {
  HapticFeedback.lightImpact();
  showModalBottomSheet(
    context: context,
    isScrollControlled: true,
    isDismissible: true,
    enableDrag: true,
    backgroundColor: Colors.transparent,
    barrierColor: Colors.black.withValues(alpha: 0.85),
    transitionAnimationController: AnimationController(
      vsync: Navigator.of(context),
      duration: const Duration(milliseconds: 350),
    ),
    builder: (context) => _PremiumQuickAddModal(onAdd: onAdd),
  );
}

/// Premium Quick Add Modal (WealthModal benzeri tasarım)
class _PremiumQuickAddModal extends StatefulWidget {
  final Function(double amount, String category, String? subCategory) onAdd;

  const _PremiumQuickAddModal({required this.onAdd});

  @override
  State<_PremiumQuickAddModal> createState() => _PremiumQuickAddModalState();
}

class _PremiumQuickAddModalState extends State<_PremiumQuickAddModal>
    with SingleTickerProviderStateMixin {
  final _amountController = TextEditingController();
  final _subCategoryController = TextEditingController();
  final _subCategoryService = SubCategoryService();

  String? _selectedCategory;
  SubCategorySuggestions? _subCategorySuggestions;
  bool _hasValidAmount = false;
  bool _showCategoryWarning = false;
  bool _showGoldenGlow = false;

  // Sensory feedback için
  double _currentAmount = 0;

  late AnimationController _fadeController;
  late Animation<double> _fadeAnimation;

  @override
  void initState() {
    super.initState();
    _fadeController = AnimationController(
      duration: const Duration(milliseconds: 200),
      vsync: this,
    );
    _fadeAnimation = CurvedAnimation(
      parent: _fadeController,
      curve: Curves.easeOut,
    );

    // Sensory feedback sıfırla
    sensoryFeedback.resetHapticState();

    Future.delayed(const Duration(milliseconds: 200), () {
      if (mounted) _fadeController.forward();
    });
  }

  @override
  void dispose() {
    _amountController.dispose();
    _subCategoryController.dispose();
    _fadeController.dispose();
    super.dispose();
  }

  void _validateAmount() {
    final amount = parseAmount(_amountController.text);
    setState(() {
      _hasValidAmount = amount != null && amount > 0;
      _currentAmount = amount ?? 0;
      if (_hasValidAmount) _showCategoryWarning = false;
    });

    // Haptic Weight - tutar bazlı titreşim
    if (amount != null && amount > 0) {
      sensoryFeedback.triggerHapticForAmount(amount);
    }
  }

  Future<void> _onCategorySelected(String category) async {
    HapticFeedback.selectionClick();
    setState(() {
      _selectedCategory = category;
      _showCategoryWarning = false;
    });

    final suggestions = await _subCategoryService.getSuggestions(category);
    if (mounted) {
      setState(() => _subCategorySuggestions = suggestions);
    }
  }

  void _submit() {
    final amount = parseAmount(_amountController.text);

    if (amount == null || amount <= 0) {
      HapticFeedback.heavyImpact();
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: const Text('Lütfen geçerli bir tutar girin'),
          backgroundColor: context.appColors.error,
        ),
      );
      return;
    }

    if (_selectedCategory == null) {
      HapticFeedback.heavyImpact();
      setState(() => _showCategoryWarning = true);
      return;
    }

    // Golden glow efekti
    setState(() => _showGoldenGlow = true);
    HapticFeedback.mediumImpact();
    soundService.playCoin();

    Future.delayed(const Duration(milliseconds: 400), () {
      if (mounted) {
        final subCategory = _subCategoryController.text.trim().isNotEmpty
            ? _subCategoryController.text.trim()
            : null;
        widget.onAdd(amount, _selectedCategory!, subCategory);
        Navigator.pop(context);
      }
    });
  }

  @override
  Widget build(BuildContext context) {
    final gradientColors = sensoryFeedback.getBackgroundGradient(
      _currentAmount,
    );
    final riskLevel = sensoryFeedback.getRiskLevel(_currentAmount);

    return Container(
      height: MediaQuery.of(context).size.height * 0.85,
      decoration: const BoxDecoration(
        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
      ),
      child: ClipRRect(
        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
        child: BackdropFilter(
          filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
          child: AnimatedContainer(
            duration: const Duration(milliseconds: 500),
            curve: Curves.easeInOut,
            decoration: BoxDecoration(
              // Blood Pressure Background
              gradient: LinearGradient(
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
                colors: [
                  gradientColors[0].withValues(alpha: 0.95),
                  gradientColors[1].withValues(alpha: 0.98),
                ],
              ),
              borderRadius: const BorderRadius.vertical(
                top: Radius.circular(24),
              ),
              border: Border.all(
                color: _showGoldenGlow
                    ? AppColors.medalGold
                    : riskLevel.backgroundIntensity > 0.3
                    ? AppColors.categoryBills.withValues(alpha: 0.5)
                    : context.appColors.cardBorder,
                width: _showGoldenGlow || riskLevel.backgroundIntensity > 0.3
                    ? 2
                    : 1,
              ),
              boxShadow: [
                if (_showGoldenGlow)
                  BoxShadow(
                    color: AppColors.medalGold.withValues(alpha: 0.4),
                    blurRadius: 20,
                    spreadRadius: 2,
                  )
                else if (riskLevel.backgroundIntensity > 0.2)
                  BoxShadow(
                    color: AppColors.categoryBills.withValues(
                      alpha: riskLevel.backgroundIntensity * 0.3,
                    ),
                    blurRadius: 20,
                    spreadRadius: 2,
                  ),
              ],
            ),
            child: Column(
              children: [
                // Drag Handle
                Padding(
                  padding: const EdgeInsets.only(top: 12, bottom: 8),
                  child: Container(
                    width: 40,
                    height: 4,
                    decoration: BoxDecoration(
                      color: context.appColors.textTertiary.withValues(
                        alpha: 0.5,
                      ),
                      borderRadius: BorderRadius.circular(2),
                    ),
                  ),
                ),
                // Header
                Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 20),
                  child: Row(
                    children: [
                      Semantics(
                        label: AppLocalizations.of(
                          context,
                        ).accessibilityCloseSheet,
                        button: true,
                        child: GestureDetector(
                          onTap: () => Navigator.pop(context),
                          child: Container(
                            width: 36,
                            height: 36,
                            decoration: BoxDecoration(
                              color: context.appColors.surfaceLight,
                              borderRadius: BorderRadius.circular(8),
                            ),
                            child: Icon(
                              CupertinoIcons.xmark,
                              size: 20,
                              color: context.appColors.textSecondary,
                            ),
                          ),
                        ),
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: Text(
                          'Yeni Harcama',
                          style: TextStyle(
                            fontSize: 18,
                            fontWeight: FontWeight.w700,
                            color: context.appColors.textPrimary,
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
                const SizedBox(height: 16),
                // Content
                Expanded(
                  child: FadeTransition(
                    opacity: _fadeAnimation,
                    child: SingleChildScrollView(
                      padding: EdgeInsets.only(
                        left: 20,
                        right: 20,
                        bottom: MediaQuery.of(context).viewInsets.bottom + 20,
                      ),
                      child: _buildForm(),
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildForm() {
    final currencyProvider = context.watch<CurrencyProvider>();
    final riskLevel = sensoryFeedback.getRiskLevel(_currentAmount);
    final borderColor = sensoryFeedback.getAmountBorderColor(_currentAmount);

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // Risk göstergesi (varsa)
        if (riskLevel != RiskLevel.none && _hasValidAmount)
          Padding(
            padding: const EdgeInsets.only(bottom: 12),
            child: RiskBadge(riskLevel: riskLevel),
          ),

        // Tutar - Blood Pressure efekti ile
        AnimatedContainer(
          duration: const Duration(milliseconds: 300),
          curve: Curves.easeOut,
          padding: const EdgeInsets.symmetric(vertical: 20, horizontal: 24),
          decoration: BoxDecoration(
            color: context.appColors.surfaceLight,
            borderRadius: BorderRadius.circular(24),
            border: Border.all(
              color: _hasValidAmount
                  ? borderColor
                  : context.appColors.cardBorder,
              width: _hasValidAmount && riskLevel != RiskLevel.none ? 2 : 1,
            ),
            boxShadow: _hasValidAmount && riskLevel.backgroundIntensity > 0.2
                ? [
                    BoxShadow(
                      color: borderColor.withValues(alpha: 0.2),
                      blurRadius: 12,
                      spreadRadius: 1,
                    ),
                  ]
                : null,
          ),
          child: Row(
            children: [
              Expanded(
                child: TextField(
                  controller: _amountController,
                  autofocus: true,
                  keyboardType: const TextInputType.numberWithOptions(
                    decimal: true,
                  ),
                  inputFormatters: [
                    PremiumCurrencyFormatter(
                      allowDecimals: true,
                      maxIntegerDigits: 12,
                    ),
                  ],
                  style: TextStyle(
                    fontSize: 32,
                    fontWeight: FontWeight.w700,
                    color: context.appColors.textPrimary,
                  ),
                  textAlign: TextAlign.center,
                  decoration: InputDecoration(
                    hintText: '0',
                    hintStyle: TextStyle(
                      fontSize: 32,
                      fontWeight: FontWeight.w700,
                      color: context.appColors.textTertiary.withValues(
                        alpha: 0.5,
                      ),
                    ),
                    border: InputBorder.none,
                  ),
                  onChanged: (_) => _validateAmount(),
                ),
              ),
              Text(
                currencyProvider.code,
                style: TextStyle(
                  fontSize: 20,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textSecondary,
                ),
              ),
            ],
          ),
        ),

        const SizedBox(height: 24),

        // Kategori başlık
        Row(
          children: [
            Container(
              width: 4,
              height: 16,
              decoration: BoxDecoration(
                color: _showCategoryWarning
                    ? context.appColors.warning
                    : context.appColors.primary,
                borderRadius: BorderRadius.circular(2),
              ),
            ),
            const SizedBox(width: 10),
            Text(
              'Harcama Grubu',
              style: TextStyle(
                fontSize: 14,
                fontWeight: FontWeight.w600,
                color: _showCategoryWarning
                    ? context.appColors.warning
                    : context.appColors.textPrimary,
              ),
            ),
          ],
        ),

        const SizedBox(height: 12),

        // Kategori grid - Premium visibility
        GridView.builder(
          shrinkWrap: true,
          physics: const NeverScrollableScrollPhysics(),
          gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
            crossAxisCount: 3,
            childAspectRatio: 2.0, // Daha büyük tıklama alanı (min 48px height)
            crossAxisSpacing: 10,
            mainAxisSpacing: 10,
          ),
          itemCount: ExpenseCategory.all.length,
          itemBuilder: (context, index) {
            final category = ExpenseCategory.all[index];
            final isSelected = category == _selectedCategory;

            return _PremiumCategoryButton(
              category: category,
              isSelected: isSelected,
              showWarning: _showCategoryWarning,
              onTap: () => _onCategorySelected(category),
            );
          },
        ),

        // Alt kategori önerileri
        if (_selectedCategory != null &&
            _subCategorySuggestions != null &&
            !_subCategorySuggestions!.isEmpty) ...[
          const SizedBox(height: 20),
          Text(
            'Detay (Opsiyonel)',
            style: TextStyle(
              fontSize: 14,
              fontWeight: FontWeight.w600,
              color: context.appColors.textPrimary,
            ),
          ),
          const SizedBox(height: 10),
          Wrap(
            spacing: 8,
            runSpacing: 8,
            children: [
              ..._subCategorySuggestions!.recent.map(
                (s) => _buildChip(s, true),
              ),
              ..._subCategorySuggestions!.fixed.map(
                (s) => _buildChip(s, false),
              ),
            ],
          ),
        ],

        const SizedBox(height: 24),

        // Kaydet butonu
        SizedBox(
          width: double.infinity,
          height: 56,
          child: ElevatedButton(
            onPressed: _submit,
            style: ElevatedButton.styleFrom(
              backgroundColor: (_hasValidAmount && _selectedCategory != null)
                  ? context.appColors.primary
                  : context.appColors.surfaceLight,
              foregroundColor: (_hasValidAmount && _selectedCategory != null)
                  ? context.appColors.background
                  : context.appColors.textTertiary,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(16),
              ),
              elevation: 0,
            ),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                const Icon(CupertinoIcons.checkmark_alt, size: 22),
                const SizedBox(width: 10),
                const Text(
                  'Hesapla',
                  style: TextStyle(fontSize: 16, fontWeight: FontWeight.w600),
                ),
              ],
            ),
          ),
        ),

        const SizedBox(height: 24),
      ],
    );
  }

  Widget _buildChip(String label, bool isRecent) {
    return Semantics(
      label: label,
      button: true,
      child: GestureDetector(
        onTap: () {
          HapticFeedback.selectionClick();
          _subCategoryController.text = label;
          setState(() {});
        },
        child: Container(
          padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),
          decoration: BoxDecoration(
            color: isRecent
                ? context.appColors.primary.withValues(alpha: 0.15)
                : context.appColors.surfaceLight,
            borderRadius: BorderRadius.circular(8),
            border: Border.all(
              color: isRecent
                  ? context.appColors.primary.withValues(alpha: 0.5)
                  : context.appColors.cardBorder,
            ),
          ),
          child: Row(
            mainAxisSize: MainAxisSize.min,
            children: [
              if (isRecent)
                Padding(
                  padding: const EdgeInsets.only(right: 6),
                  child: Icon(
                    CupertinoIcons.clock_fill,
                    size: 14,
                    color: context.appColors.primary,
                  ),
                ),
              Text(
                label,
                style: TextStyle(
                  fontSize: 13,
                  fontWeight: FontWeight.w500,
                  color: isRecent
                      ? context.appColors.primary
                      : context.appColors.textPrimary,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

/// Premium Category Button with press state
/// Daha görünür arka plan, beyaz yazı, press efekti
class _PremiumCategoryButton extends StatefulWidget {
  final String category;
  final bool isSelected;
  final bool showWarning;
  final VoidCallback onTap;

  const _PremiumCategoryButton({
    required this.category,
    required this.isSelected,
    required this.showWarning,
    required this.onTap,
  });

  @override
  State<_PremiumCategoryButton> createState() => _PremiumCategoryButtonState();
}

class _PremiumCategoryButtonState extends State<_PremiumCategoryButton> {
  bool _isPressed = false;

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    return GestureDetector(
      onTapDown: (_) => setState(() => _isPressed = true),
      onTapUp: (_) {
        setState(() => _isPressed = false);
        HapticFeedback.selectionClick();
        widget.onTap();
      },
      onTapCancel: () => setState(() => _isPressed = false),
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 150),
        curve: Curves.easeOutCubic,
        transform: Matrix4.identity()..scale(_isPressed ? 0.95 : 1.0),
        transformAlignment: Alignment.center,
        decoration: BoxDecoration(
          // Daha görünür arka plan: seçili=primary, basılı=surfaceLighter, normal=surfaceLight
          color: widget.isSelected
              ? context.appColors.primary
              : _isPressed
              ? context.appColors.surfaceLighter
              : widget.showWarning
              ? context.appColors.warning.withValues(alpha: 0.12)
              : context.appColors.surfaceLight,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: widget.isSelected
                ? context.appColors.primary
                : _isPressed
                ? context.appColors.primary.withValues(alpha: 0.5)
                : widget.showWarning
                ? context.appColors.warning.withValues(alpha: 0.4)
                : context.appColors.cardBorder,
            width: widget.isSelected || _isPressed ? 2 : 1,
          ),
          boxShadow: widget.isSelected
              ? [
                  BoxShadow(
                    color: context.appColors.primary.withValues(alpha: 0.4),
                    blurRadius: 12,
                    offset: const Offset(0, 4),
                  ),
                ]
              : _isPressed
              ? [
                  BoxShadow(
                    color: context.appColors.textPrimary.withValues(alpha: 0.1),
                    blurRadius: 8,
                  ),
                ]
              : null,
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            // Category icon
            Icon(
              ExpenseCategory.getIcon(widget.category),
              size: 20,
              color: widget.isSelected
                  ? context.appColors.background
                  : ExpenseCategory.getColor(widget.category),
              shadows: widget.isSelected || _isPressed
                  ? [
                      Shadow(
                        color: context.appColors.textPrimary.withValues(
                          alpha: 0.5,
                        ),
                        blurRadius: 8,
                      ),
                    ]
                  : null,
            ),
            const SizedBox(width: 8),
            // Kategori adı - theme-aware colors
            Flexible(
              child: Text(
                ExpenseCategory.getLocalizedName(widget.category, l10n),
                style: TextStyle(
                  fontSize: 13,
                  fontWeight: widget.isSelected
                      ? FontWeight.w700
                      : FontWeight.w600,
                  // Seçili: koyu arka plan, diğer: theme text
                  color: widget.isSelected
                      ? context.appColors.background
                      : context.appColors.textPrimary,
                  letterSpacing: -0.2,
                ),
                overflow: TextOverflow.ellipsis,
              ),
            ),
          ],
        ),
      ),
    );
  }
}


--- FILE: lib/widgets/budget_summary_card.dart ---

import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/category_budget.dart';
import '../providers/category_budget_provider.dart';
import '../services/category_budget_service.dart';
import '../providers/currency_provider.dart';
import '../theme/theme.dart';
import '../utils/currency_utils.dart';
import 'category_budget_card.dart';
import 'create_budget_sheet.dart';

/// Card showing overall budget summary with warnings
/// iOS 26 Liquid Glass Premium Design
class BudgetSummaryCard extends StatefulWidget {
  final VoidCallback? onViewAll;
  final VoidCallback? onAddBudget;

  const BudgetSummaryCard({super.key, this.onViewAll, this.onAddBudget});

  @override
  State<BudgetSummaryCard> createState() => _BudgetSummaryCardState();
}

class _BudgetSummaryCardState extends State<BudgetSummaryCard>
    with SingleTickerProviderStateMixin {
  // iOS 26 Liquid Glass: Animated breathing glow
  late AnimationController _glowController;
  late Animation<double> _glowAnimation;

  @override
  void initState() {
    super.initState();
    _glowController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 2500),
    )..repeat(reverse: true);

    _glowAnimation = Tween<double>(begin: 0.2, end: 0.5).animate(
      CurvedAnimation(parent: _glowController, curve: Curves.easeInOut),
    );
  }

  @override
  void dispose() {
    _glowController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final budgetProvider = context.watch<CategoryBudgetProvider>();
    final currencyProvider = context.watch<CurrencyProvider>();

    if (budgetProvider.isLoading) {
      return const SizedBox.shrink();
    }

    // No budgets - show empty state
    if (!budgetProvider.hasBudgets) {
      return _buildEmptyState(context, l10n);
    }

    final summary = budgetProvider.summary;
    if (summary == null) return const SizedBox.shrink();

    final totalBudgetConverted = currencyProvider.convertFromTRY(
      summary.totalBudget,
    );
    final totalSpentConverted = currencyProvider.convertFromTRY(
      summary.totalSpent,
    );

    // iOS 26 Liquid Glass: Animated card with breathing glow
    return AnimatedBuilder(
      animation: _glowAnimation,
      builder: (context, child) {
        return Container(
          margin: const EdgeInsets.symmetric(horizontal: 20),
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(24),
            boxShadow: [
              // Animated breathing glow
              BoxShadow(
                color: context.appColors.primary.withValues(
                  alpha: _glowAnimation.value,
                ),
                blurRadius: 28,
                spreadRadius: 0,
                offset: const Offset(0, 6),
              ),
              // Deep shadow for depth
              BoxShadow(
                color: Colors.black.withValues(alpha: 0.3),
                blurRadius: 16,
                offset: const Offset(0, 8),
              ),
            ],
          ),
          child: ClipRRect(
            borderRadius: BorderRadius.circular(24),
            child: BackdropFilter(
              // iOS 26: Enhanced 24σ blur
              filter: ImageFilter.blur(sigmaX: 24, sigmaY: 24),
              child: Container(
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(24),
                  // iOS 26 Liquid Glass: Premium gradient
                  gradient: LinearGradient(
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                    colors: [
                      const Color(0xFF8B5CF6).withValues(alpha: 0.2),
                      const Color(0xFF7C3AED).withValues(alpha: 0.12),
                      const Color(0xFF1E1B4B).withValues(alpha: 0.25),
                    ],
                    stops: const [0.0, 0.5, 1.0],
                  ),
                  // Glass border
                  border: Border.all(
                    color: Colors.white.withValues(alpha: 0.15),
                    width: 1,
                  ),
                ),
                child: Stack(
                  children: [
                    // iOS 26: Top highlight for glass light refraction
                    Positioned(
                      top: 0,
                      left: 0,
                      right: 0,
                      height: 40,
                      child: Container(
                        decoration: BoxDecoration(
                          borderRadius: const BorderRadius.vertical(
                            top: Radius.circular(24),
                          ),
                          gradient: LinearGradient(
                            begin: Alignment.topCenter,
                            end: Alignment.bottomCenter,
                            colors: [
                              Colors.white.withValues(alpha: 0.1),
                              Colors.white.withValues(alpha: 0.0),
                            ],
                          ),
                        ),
                      ),
                    ),
                    // Content
                    Padding(
                      padding: const EdgeInsets.all(20),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // Header
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Row(
                      children: [
                        Container(
                          width: 36,
                          height: 36,
                          decoration: BoxDecoration(
                            color: context.appColors.primary.withValues(
                              alpha: 0.15,
                            ),
                            borderRadius: BorderRadius.circular(8),
                          ),
                          child: Icon(
                            CupertinoIcons.creditcard,
                            color: context.appColors.primary,
                            size: 18,
                          ),
                        ),
                        const SizedBox(width: 12),
                        Text(
                          l10n.budgetProgress,
                          style: TextStyle(
                            fontSize: 16,
                            fontWeight: FontWeight.w600,
                            color: context.appColors.textPrimary,
                          ),
                        ),
                      ],
                    ),
                    GestureDetector(
                      onTap: () {
                        HapticFeedback.lightImpact();
                        widget.onViewAll?.call();
                      },
                      child: Container(
                        padding: const EdgeInsets.symmetric(
                          horizontal: 12,
                          vertical: 6,
                        ),
                        decoration: BoxDecoration(
                          color: context.appColors.primary.withValues(
                            alpha: 0.1,
                          ),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: Row(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            Text(
                              l10n.viewAll,
                              style: TextStyle(
                                fontSize: 12,
                                fontWeight: FontWeight.w600,
                                color: context.appColors.primary,
                              ),
                            ),
                            const SizedBox(width: 4),
                            Icon(
                              CupertinoIcons.chevron_right,
                              size: 14,
                              color: context.appColors.primary,
                            ),
                          ],
                        ),
                      ),
                    ),
                  ],
                ),

                const SizedBox(height: 20),

                // Total progress
                Row(
                  children: [
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            l10n.totalBudget,
                            style: TextStyle(
                              fontSize: 12,
                              color: context.appColors.textSecondary,
                            ),
                          ),
                          const SizedBox(height: 4),
                          Text(
                            '${currencyProvider.symbol}${formatTurkishCurrency(totalSpentConverted, decimalDigits: 0)} / ${currencyProvider.symbol}${formatTurkishCurrency(totalBudgetConverted, decimalDigits: 0)}',
                            style: TextStyle(
                              fontSize: 18,
                              fontWeight: FontWeight.w700,
                              color: context.appColors.textPrimary,
                            ),
                          ),
                        ],
                      ),
                    ),
                    // Overall percentage
                    Container(
                      padding: const EdgeInsets.symmetric(
                        horizontal: 12,
                        vertical: 8,
                      ),
                      decoration: BoxDecoration(
                        color: _getOverallColor(
                          context,
                          summary,
                        ).withValues(alpha: 0.15),
                        borderRadius: BorderRadius.circular(8),
                      ),
                      child: Text(
                        '%${summary.overallPercentUsed.toStringAsFixed(0)}',
                        style: TextStyle(
                          fontSize: 16,
                          fontWeight: FontWeight.w700,
                          color: _getOverallColor(context, summary),
                        ),
                      ),
                    ),
                  ],
                ),

                const SizedBox(height: 16),

                // Overall progress bar
                ClipRRect(
                  borderRadius: BorderRadius.circular(6),
                  child: LinearProgressIndicator(
                    value: (summary.overallPercentUsed / 100).clamp(0, 1),
                    backgroundColor: context.appColors.surfaceLight,
                    valueColor: AlwaysStoppedAnimation(
                      _getOverallColor(context, summary),
                    ),
                    minHeight: 8,
                  ),
                ),

                const SizedBox(height: 16),

                // Category status counts
                Row(
                  children: [
                    _buildStatusChip(
                      context,
                      icon: CupertinoIcons.checkmark_circle_fill,
                      color: context.appColors.success,
                      label: l10n.categoriesOnTrack(summary.categoriesOnTrack),
                    ),
                    const SizedBox(width: 8),
                    if (summary.categoriesNearLimit > 0 ||
                        summary.categoriesOverBudget > 0)
                      _buildStatusChip(
                        context,
                        icon: CupertinoIcons.exclamationmark_triangle_fill,
                        color: summary.categoriesOverBudget > 0
                            ? context.appColors.error
                            : context.appColors.warning,
                        label: summary.categoriesOverBudget > 0
                            ? l10n.categoriesOverBudget(
                                summary.categoriesOverBudget,
                              )
                            : l10n.categoriesNearLimit(
                                summary.categoriesNearLimit,
                              ),
                      ),
                  ],
                ),

                // Warning budgets (if any)
                if (budgetProvider.warningBudgets.isNotEmpty) ...[
                  const SizedBox(height: 16),
                  const Divider(height: 1),
                  const SizedBox(height: 12),
                  Wrap(
                    spacing: 8,
                    runSpacing: 8,
                    children: budgetProvider.warningBudgets
                        .take(3)
                        .map(
                          (b) => CompactBudgetCard(budget: b, onTap: widget.onViewAll),
                        )
                        .toList(),
                  ),
                ],
              ],
            ),
                    ),
                  ],
                ),
              ),
            ),
          ),
        );
      },
    );
  }

  Widget _buildEmptyState(BuildContext context, AppLocalizations l10n) {
    return Container(
      margin: const EdgeInsets.symmetric(horizontal: 20),
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: context.appColors.cardBackground,
        borderRadius: BorderRadius.circular(24),
        border: Border.all(
          color: context.appColors.cardBorder,
          style: BorderStyle.solid,
        ),
      ),
      child: Column(
        children: [
          Container(
            width: 56,
            height: 56,
            decoration: BoxDecoration(
              color: context.appColors.primary.withValues(alpha: 0.1),
              shape: BoxShape.circle,
            ),
            child: Icon(
              CupertinoIcons.creditcard,
              color: context.appColors.primary,
              size: 28,
            ),
          ),
          const SizedBox(height: 16),
          Text(
            l10n.noBudgetsYet,
            style: TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.w600,
              color: context.appColors.textPrimary,
            ),
          ),
          const SizedBox(height: 8),
          Text(
            l10n.noBudgetsDescription,
            textAlign: TextAlign.center,
            style: TextStyle(
              fontSize: 13,
              color: context.appColors.textSecondary,
            ),
          ),
          const SizedBox(height: 20),
          ElevatedButton.icon(
            onPressed: () {
              HapticFeedback.lightImpact();
              CreateBudgetSheet.show(context);
            },
            icon: const Icon(CupertinoIcons.plus, size: 18),
            label: Text(l10n.addBudget),
            style: ElevatedButton.styleFrom(
              backgroundColor: context.appColors.primary,
              foregroundColor: Colors.white,
              padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 12),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(16),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildStatusChip(
    BuildContext context, {
    required IconData icon,
    required Color color,
    required String label,
  }) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
      decoration: BoxDecoration(
        color: color.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(8),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(icon, size: 14, color: color),
          const SizedBox(width: 6),
          Text(
            label,
            style: TextStyle(
              fontSize: 12,
              fontWeight: FontWeight.w500,
              color: color,
            ),
          ),
        ],
      ),
    );
  }

  Color _getOverallColor(BuildContext context, BudgetSummary summary) {
    if (summary.overallPercentUsed >= 100) return context.appColors.error;
    if (summary.overallPercentUsed >= 80) return context.appColors.warning;
    if (summary.overallPercentUsed >= 50) return Colors.amber;
    return context.appColors.success;
  }
}

/// Warning banner for dashboard when budgets are at risk
class BudgetWarningBanner extends StatelessWidget {
  final List<CategoryBudgetWithSpent> budgets;
  final VoidCallback? onTap;

  const BudgetWarningBanner({super.key, required this.budgets, this.onTap});

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    if (budgets.isEmpty) return const SizedBox.shrink();

    final hasOverBudget = budgets.any((b) => b.isOverBudget);
    final color = hasOverBudget
        ? context.appColors.error
        : context.appColors.warning;

    return GestureDetector(
      onTap: onTap,
      child: Container(
        margin: const EdgeInsets.symmetric(horizontal: 20),
        padding: const EdgeInsets.all(14),
        decoration: BoxDecoration(
          color: color.withValues(alpha: 0.1),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: color.withValues(alpha: 0.3)),
        ),
        child: Row(
          children: [
            Container(
              width: 36,
              height: 36,
              decoration: BoxDecoration(
                color: color.withValues(alpha: 0.15),
                borderRadius: BorderRadius.circular(8),
              ),
              child: Icon(
                hasOverBudget
                    ? CupertinoIcons.exclamationmark_triangle
                    : CupertinoIcons.exclamationmark_circle,
                color: color,
                size: 18,
              ),
            ),
            const SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    hasOverBudget
                        ? l10n.budgetExceededTitle
                        : l10n.budgetNearLimit,
                    style: TextStyle(
                      fontSize: 14,
                      fontWeight: FontWeight.w600,
                      color: color,
                    ),
                  ),
                  const SizedBox(height: 2),
                  Text(
                    '${budgets.length} ${budgets.length == 1 ? l10n.category.toLowerCase() : l10n.categories.toLowerCase()}',
                    style: TextStyle(
                      fontSize: 12,
                      color: color.withValues(alpha: 0.8),
                    ),
                  ),
                ],
              ),
            ),
            Icon(CupertinoIcons.chevron_right, color: color, size: 20),
          ],
        ),
      ),
    );
  }
}


--- FILE: lib/widgets/decision_stress_timer.dart ---

import 'dart:async';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../services/sensory_feedback_service.dart';
import '../theme/theme.dart';

/// Wealth Coach: Decision Stress Timer
/// Graduated countdown system based on risk level
class DecisionStressTimer extends StatefulWidget {
  final double amount;
  final RiskLevel riskLevel;
  final VoidCallback onConfirm;
  final VoidCallback? onCancel;
  final String? confirmLabel;
  final String? warningMessage;

  const DecisionStressTimer({
    super.key,
    required this.amount,
    required this.riskLevel,
    required this.onConfirm,
    this.onCancel,
    this.confirmLabel,
    this.warningMessage,
  });

  @override
  State<DecisionStressTimer> createState() => _DecisionStressTimerState();
}

class _DecisionStressTimerState extends State<DecisionStressTimer>
    with SingleTickerProviderStateMixin {
  late int _remainingSeconds;
  Timer? _timer;
  bool _canConfirm = false;

  late AnimationController _pulseController;
  late Animation<double> _pulseAnimation;

  @override
  void initState() {
    super.initState();

    _remainingSeconds = widget.riskLevel.countdownSeconds;
    _canConfirm = _remainingSeconds == 0;

    // Pulse animation (for high risk)
    _pulseController = AnimationController(
      duration: const Duration(milliseconds: 1000),
      vsync: this,
    );
    _pulseAnimation = Tween<double>(begin: 1.0, end: 1.05).animate(
      CurvedAnimation(parent: _pulseController, curve: Curves.easeInOut),
    );

    if (!_canConfirm) {
      _startCountdown();
      if (widget.riskLevel == RiskLevel.high ||
          widget.riskLevel == RiskLevel.extreme) {
        _pulseController.repeat(reverse: true);
      }
    }
  }

  @override
  void dispose() {
    _timer?.cancel();
    _pulseController.dispose();
    super.dispose();
  }

  void _startCountdown() {
    _timer = Timer.periodic(const Duration(seconds: 1), (timer) {
      if (_remainingSeconds > 0) {
        setState(() => _remainingSeconds--);
        sensoryFeedback.triggerCountdownTick();
      }

      if (_remainingSeconds == 0) {
        timer.cancel();
        _pulseController.stop();
        setState(() => _canConfirm = true);
        HapticFeedback.mediumImpact();
      }
    });
  }

  Color get _riskColor {
    switch (widget.riskLevel) {
      case RiskLevel.none:
      case RiskLevel.low:
        return AppColors.medalGold; // Gold
      case RiskLevel.medium:
        return AppColors.warning; // Orange
      case RiskLevel.high:
        return AppColors.categoryBills; // Red
      case RiskLevel.extreme:
        return AppColors.dangerRed; // Dark Red
    }
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    // No risk - direct confirm button
    if (widget.riskLevel == RiskLevel.none) {
      return _buildConfirmButton(l10n);
    }

    return Column(
      children: [
        // Warning message
        if (widget.warningMessage != null && widget.warningMessage!.isNotEmpty)
          _buildWarningCard(l10n),

        const SizedBox(height: 16),

        // Countdown or confirm button
        if (!_canConfirm)
          _buildCountdownIndicator(l10n)
        else
          _buildConfirmButton(l10n),

        // Cancel button
        if (widget.onCancel != null) ...[
          const SizedBox(height: 12),
          TextButton(
            onPressed: widget.onCancel,
            style: TextButton.styleFrom(
              foregroundColor: context.appColors.textSecondary,
            ),
            child: Text(l10n.giveUp),
          ),
        ],
      ],
    );
  }

  Widget _buildWarningCard(AppLocalizations l10n) {
    return AnimatedBuilder(
      animation: _pulseAnimation,
      builder: (context, child) {
        return Transform.scale(
          scale: _canConfirm ? 1.0 : _pulseAnimation.value,
          child: Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: _riskColor.withValues(alpha: 0.15),
              borderRadius: BorderRadius.circular(16),
              border: Border.all(
                color: _riskColor.withValues(alpha: 0.4),
                width: 1.5,
              ),
            ),
            child: Row(
              children: [
                // Risk icon
                Container(
                  width: 44,
                  height: 44,
                  decoration: BoxDecoration(
                    color: _riskColor.withValues(alpha: 0.2),
                    borderRadius: BorderRadius.circular(16),
                  ),
                  child: Icon(_getWarningIcon(), color: _riskColor, size: 24),
                ),
                const SizedBox(width: 12),
                // Message
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        _getRiskLabel(l10n),
                        style: TextStyle(
                          fontSize: 13,
                          fontWeight: FontWeight.w700,
                          color: _riskColor,
                        ),
                      ),
                      const SizedBox(height: 4),
                      Text(
                        widget.warningMessage!,
                        style: TextStyle(
                          fontSize: 12,
                          color: context.appColors.textSecondary,
                          height: 1.4,
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
        );
      },
    );
  }

  String _getRiskLabel(AppLocalizations l10n) {
    switch (widget.riskLevel) {
      case RiskLevel.none:
        return l10n.riskLevelNone;
      case RiskLevel.low:
        return l10n.riskLevelLow;
      case RiskLevel.medium:
        return l10n.riskLevelMedium;
      case RiskLevel.high:
        return l10n.riskLevelHigh;
      case RiskLevel.extreme:
        return l10n.riskLevelExtreme;
    }
  }

  IconData _getWarningIcon() {
    switch (widget.riskLevel) {
      case RiskLevel.none:
        return CupertinoIcons.checkmark_circle;
      case RiskLevel.low:
        return CupertinoIcons.info_circle;
      case RiskLevel.medium:
        return CupertinoIcons.exclamationmark_circle;
      case RiskLevel.high:
        return CupertinoIcons.exclamationmark_octagon;
      case RiskLevel.extreme:
        return CupertinoIcons.xmark_octagon;
    }
  }

  Widget _buildCountdownIndicator(AppLocalizations l10n) {
    return Container(
      width: double.infinity,
      padding: const EdgeInsets.symmetric(vertical: 20),
      decoration: BoxDecoration(
        color: _riskColor.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: _riskColor.withValues(alpha: 0.3)),
      ),
      child: Column(
        children: [
          // Countdown number
          Text(
            '$_remainingSeconds',
            style: TextStyle(
              fontSize: 48,
              fontWeight: FontWeight.w800,
              color: _riskColor,
            ),
          ),
          const SizedBox(height: 4),
          Text(
            l10n.thinkingTime,
            style: TextStyle(
              fontSize: 14,
              color: context.appColors.textSecondary,
            ),
          ),
          const SizedBox(height: 12),
          // Progress bar
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 24),
            child: ClipRRect(
              borderRadius: BorderRadius.circular(4),
              child: LinearProgressIndicator(
                value:
                    1 - (_remainingSeconds / widget.riskLevel.countdownSeconds),
                backgroundColor: _riskColor.withValues(alpha: 0.2),
                valueColor: AlwaysStoppedAnimation<Color>(_riskColor),
                minHeight: 6,
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildConfirmButton(AppLocalizations l10n) {
    return SizedBox(
      width: double.infinity,
      height: 56,
      child: ElevatedButton(
        onPressed: () {
          HapticFeedback.mediumImpact();
          widget.onConfirm();
        },
        style: ElevatedButton.styleFrom(
          backgroundColor: widget.riskLevel == RiskLevel.none
              ? context.appColors.primary
              : _riskColor,
          foregroundColor: Colors.white,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(16),
          ),
          elevation: 0,
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              widget.riskLevel == RiskLevel.none
                  ? CupertinoIcons.checkmark
                  : CupertinoIcons.exclamationmark_circle,
              size: 22,
            ),
            const SizedBox(width: 10),
            Text(
              widget.confirmLabel ?? l10n.confirm,
              style: const TextStyle(fontSize: 16, fontWeight: FontWeight.w600),
            ),
          ],
        ),
      ),
    );
  }
}

/// Risk level badge widget
class RiskBadge extends StatelessWidget {
  final RiskLevel riskLevel;
  final bool showLabel;

  const RiskBadge({super.key, required this.riskLevel, this.showLabel = true});

  Color _getColor(BuildContext context) {
    switch (riskLevel) {
      case RiskLevel.none:
        return context.appColors.success;
      case RiskLevel.low:
        return AppColors.medalGold;
      case RiskLevel.medium:
        return AppColors.warning;
      case RiskLevel.high:
        return AppColors.categoryBills;
      case RiskLevel.extreme:
        return AppColors.dangerRed;
    }
  }

  String _getRiskLabel(AppLocalizations l10n) {
    switch (riskLevel) {
      case RiskLevel.none:
        return l10n.riskLevelNone;
      case RiskLevel.low:
        return l10n.riskLevelLow;
      case RiskLevel.medium:
        return l10n.riskLevelMedium;
      case RiskLevel.high:
        return l10n.riskLevelHigh;
      case RiskLevel.extreme:
        return l10n.riskLevelExtreme;
    }
  }

  @override
  Widget build(BuildContext context) {
    if (riskLevel == RiskLevel.none) {
      return const SizedBox.shrink();
    }

    final l10n = AppLocalizations.of(context);
    final color = _getColor(context);

    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 5),
      decoration: BoxDecoration(
        color: color.withValues(alpha: 0.15),
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: color.withValues(alpha: 0.4)),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Text(riskLevel.emoji, style: const TextStyle(fontSize: 12)),
          if (showLabel) ...[
            const SizedBox(width: 4),
            Text(
              _getRiskLabel(l10n),
              style: TextStyle(
                fontSize: 11,
                fontWeight: FontWeight.w600,
                color: color,
              ),
            ),
          ],
        ],
      ),
    );
  }
}


--- FILE: lib/widgets/budget_breakdown_card.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../providers/currency_provider.dart';
import '../services/budget_service.dart';
import '../theme/theme.dart' hide GlassCard;
import '../core/theme/premium_effects.dart';
import '../utils/currency_utils.dart';

/// Bütçe dağılımını gösteren kart
/// Zorunlu giderler vs İsteğe bağlı harcamalar
/// Premium animasyonlar: staggered slide-up, count-up, progress bar
class BudgetBreakdownCard extends StatefulWidget {
  final BudgetService budgetService;
  final int animationIndex;

  const BudgetBreakdownCard({
    super.key,
    required this.budgetService,
    this.animationIndex = 0,
  });

  @override
  State<BudgetBreakdownCard> createState() => _BudgetBreakdownCardState();
}

class _BudgetBreakdownCardState extends State<BudgetBreakdownCard>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _slideAnimation;
  late Animation<double> _fadeAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      duration: const Duration(milliseconds: 400),
      vsync: this,
    );

    _slideAnimation = Tween<double>(
      begin: 30,
      end: 0,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeOutCubic));

    _fadeAnimation = Tween<double>(
      begin: 0,
      end: 1,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeOutCubic));

    // Staggered delay based on index
    Future.delayed(Duration(milliseconds: 100 * widget.animationIndex), () {
      if (mounted) _controller.forward();
    });
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final currencyProvider = context.watch<CurrencyProvider>();

    final mandatory = widget.budgetService.mandatoryExpenses;
    final discretionary = widget.budgetService.discretionaryExpenses;
    final total = mandatory + discretionary;
    final mandatoryHours = widget.budgetService.mandatoryHours;
    final discretionaryHours = widget.budgetService.usedHours;

    // Hiç harcama yoksa gösterme
    if (total <= 0) return const SizedBox.shrink();

    final mandatoryPercent = total > 0 ? (mandatory / total * 100) : 0.0;
    final discretionaryPercent = total > 0
        ? (discretionary / total * 100)
        : 0.0;

    // Currency conversion
    final mandatoryConverted = currencyProvider.convertFromTRY(mandatory);
    final discretionaryConverted = currencyProvider.convertFromTRY(
      discretionary,
    );
    final remainingConverted = currencyProvider.convertFromTRY(
      widget.budgetService.remainingBudget.abs(),
    );

    return AnimatedBuilder(
      animation: _controller,
      builder: (context, child) {
        return Transform.translate(
          offset: Offset(0, _slideAnimation.value),
          child: Opacity(
            opacity: _fadeAnimation.value,
            child: Padding(
              padding: const EdgeInsets.symmetric(horizontal: 20),
              child: GlassCard(
                borderRadius: 20,
                padding: const EdgeInsets.all(20),
                blur: 15,
                boxShadow: PremiumShadows.shadowPremium,
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    // Başlık with icon halo
                    Row(
                      children: [
                        Container(
                          width: 36,
                          height: 36,
                          decoration: BoxDecoration(
                            color: context.appColors.primary.withValues(
                              alpha: 0.15,
                            ),
                            borderRadius: BorderRadius.circular(8),
                            boxShadow: PremiumShadows.coloredGlow(
                              context.appColors.primary,
                              intensity: 0.3,
                            ),
                          ),
                          child: Icon(
                            CupertinoIcons.chart_pie_fill,
                            color: context.appColors.primary,
                            size: 18,
                            shadows: PremiumShadows.iconHalo(
                              context.appColors.primary,
                            ),
                          ),
                        ),
                        const SizedBox(width: 12),
                        Text(
                          l10n.monthlySpendingBreakdown,
                          style: TextStyle(
                            color: context.appColors.textPrimary,
                            fontSize: 14,
                            fontWeight: FontWeight.w600,
                            letterSpacing: 0.5,
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 20),

                    // Animated stacked progress bar
                    _AnimatedStackedProgress(
                      mandatoryPercent: mandatoryPercent,
                      discretionaryPercent: discretionaryPercent,
                    ),
                    const SizedBox(height: 20),

                    // Detaylar - stat items with staggered animation
                    Row(
                      children: [
                        // Zorunlu giderler
                        Expanded(
                          child: _AnimatedStatItem(
                            index: 0,
                            icon: CupertinoIcons.lock_fill,
                            iconColor: context.appColors.info,
                            label: l10n.mandatoryExpenses,
                            amount: mandatoryConverted,
                            hours: mandatoryHours,
                            percent: mandatoryPercent,
                            currencySymbol: currencyProvider.symbol,
                            l10n: l10n,
                          ),
                        ),
                        const SizedBox(width: 16),
                        // İsteğe bağlı
                        Expanded(
                          child: _AnimatedStatItem(
                            index: 1,
                            icon: CupertinoIcons.bag_fill,
                            iconColor: context.appColors.warning,
                            label: l10n.discretionaryExpenses,
                            amount: discretionaryConverted,
                            hours: discretionaryHours,
                            percent: discretionaryPercent,
                            currencySymbol: currencyProvider.symbol,
                            l10n: l10n,
                          ),
                        ),
                      ],
                    ),

                    // Kalan bütçe bilgisi
                    if (widget.budgetService.remainingBudget > 0) ...[
                      const SizedBox(height: 16),
                      Container(
                        padding: const EdgeInsets.all(14),
                        decoration: BoxDecoration(
                          color: context.appColors.success.withValues(
                            alpha: 0.08,
                          ),
                          borderRadius: BorderRadius.circular(16),
                          border: Border.all(
                            color: context.appColors.success.withValues(
                              alpha: 0.2,
                            ),
                            width: 1,
                          ),
                        ),
                        child: Row(
                          children: [
                            Icon(
                              CupertinoIcons.checkmark_circle_fill,
                              color: context.appColors.success,
                              size: 20,
                              shadows: PremiumShadows.iconHalo(
                                context.appColors.success,
                              ),
                            ),
                            const SizedBox(width: 10),
                            Expanded(
                              child: Text(
                                l10n.remainingHoursToSpend(
                                  widget.budgetService.remainingHours
                                      .toStringAsFixed(0),
                                ),
                                style: TextStyle(
                                  color: context.appColors.success,
                                  fontSize: 13,
                                  fontWeight: FontWeight.w600,
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],

                    // Bütçe aşıldı uyarısı
                    if (widget.budgetService.isOverBudget) ...[
                      const SizedBox(height: 16),
                      Container(
                        padding: const EdgeInsets.all(14),
                        decoration: BoxDecoration(
                          color: context.appColors.error.withValues(
                            alpha: 0.08,
                          ),
                          borderRadius: BorderRadius.circular(16),
                          border: Border.all(
                            color: context.appColors.error.withValues(
                              alpha: 0.2,
                            ),
                            width: 1,
                          ),
                        ),
                        child: Row(
                          children: [
                            Icon(
                              CupertinoIcons.exclamationmark_triangle_fill,
                              color: context.appColors.error,
                              size: 20,
                              shadows: PremiumShadows.iconHalo(
                                context.appColors.error,
                              ),
                            ),
                            const SizedBox(width: 10),
                            Expanded(
                              child: Text(
                                l10n.budgetExceeded(
                                  formatTurkishCurrency(
                                    remainingConverted,
                                    decimalDigits: 0,
                                    showDecimals: false,
                                  ),
                                ),
                                style: TextStyle(
                                  color: context.appColors.error,
                                  fontSize: 13,
                                  fontWeight: FontWeight.w600,
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ],
                ),
              ),
            ),
          ),
        );
      },
    );
  }
}

/// Animated stacked progress bar
class _AnimatedStackedProgress extends StatefulWidget {
  final double mandatoryPercent;
  final double discretionaryPercent;

  const _AnimatedStackedProgress({
    required this.mandatoryPercent,
    required this.discretionaryPercent,
  });

  @override
  State<_AnimatedStackedProgress> createState() =>
      _AnimatedStackedProgressState();
}

class _AnimatedStackedProgressState extends State<_AnimatedStackedProgress>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _animation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      duration: const Duration(milliseconds: 600),
      vsync: this,
    );
    _animation = CurvedAnimation(
      parent: _controller,
      curve: Curves.easeOutCubic,
    );

    // 200ms delay
    Future.delayed(const Duration(milliseconds: 200), () {
      if (mounted) _controller.forward();
    });
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: _animation,
      builder: (context, child) {
        final animatedMandatory = widget.mandatoryPercent * _animation.value;
        final animatedDiscretionary =
            widget.discretionaryPercent * _animation.value;

        final isDark = Theme.of(context).brightness == Brightness.dark;
        final trackColor = isDark
            ? Colors.white.withValues(alpha: 0.1)
            : Colors.black.withValues(alpha: 0.08);

        return Container(
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(8),
            boxShadow: [
              BoxShadow(
                color: context.appColors.primary.withValues(alpha: 0.2),
                blurRadius: 12,
                spreadRadius: 0,
              ),
            ],
          ),
          child: ClipRRect(
            borderRadius: BorderRadius.circular(8),
            child: Container(
              height: 10,
              color: trackColor,
              child: Row(
                children: [
                  // Zorunlu (mavi/info)
                  if (animatedMandatory > 0)
                    Expanded(
                      flex: animatedMandatory.round().clamp(1, 100),
                      child: Container(
                        decoration: BoxDecoration(
                          gradient: LinearGradient(
                            colors: [
                              context.appColors.info,
                              context.appColors.info.withValues(alpha: 0.8),
                            ],
                          ),
                        ),
                      ),
                    ),
                  // İsteğe bağlı (turuncu/warning)
                  if (animatedDiscretionary > 0)
                    Expanded(
                      flex: animatedDiscretionary.round().clamp(1, 100),
                      child: Container(
                        decoration: BoxDecoration(
                          gradient: LinearGradient(
                            colors: [
                              context.appColors.warning,
                              context.appColors.warning.withValues(alpha: 0.8),
                            ],
                          ),
                        ),
                      ),
                    ),
                  // Kalan boşluk
                  if (animatedMandatory + animatedDiscretionary < 100)
                    Expanded(
                      flex: (100 - animatedMandatory - animatedDiscretionary)
                          .round()
                          .clamp(1, 100),
                      child: const SizedBox(),
                    ),
                ],
              ),
            ),
          ),
        );
      },
    );
  }
}

/// Animated stat item with count-up
class _AnimatedStatItem extends StatefulWidget {
  final int index;
  final IconData icon;
  final Color iconColor;
  final String label;
  final double amount;
  final double hours;
  final double percent;
  final String currencySymbol;
  final AppLocalizations l10n;

  const _AnimatedStatItem({
    required this.index,
    required this.icon,
    required this.iconColor,
    required this.label,
    required this.amount,
    required this.hours,
    required this.percent,
    required this.currencySymbol,
    required this.l10n,
  });

  @override
  State<_AnimatedStatItem> createState() => _AnimatedStatItemState();
}

class _AnimatedStatItemState extends State<_AnimatedStatItem>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _slideAnimation;
  late Animation<double> _fadeAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      duration: const Duration(milliseconds: 400),
      vsync: this,
    );

    _slideAnimation = Tween<double>(
      begin: 20,
      end: 0,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeOutCubic));

    _fadeAnimation = Tween<double>(
      begin: 0,
      end: 1,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeOutCubic));

    // Staggered delay: 300ms base + 100ms per index
    Future.delayed(Duration(milliseconds: 300 + (100 * widget.index)), () {
      if (mounted) _controller.forward();
    });
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: _controller,
      builder: (context, child) {
        return Transform.translate(
          offset: Offset(0, _slideAnimation.value),
          child: Opacity(
            opacity: _fadeAnimation.value,
            child: Container(
              padding: const EdgeInsets.all(14),
              decoration: BoxDecoration(
                color: widget.iconColor.withValues(alpha: 0.08),
                borderRadius: BorderRadius.circular(16),
                border: Border.all(
                  color: widget.iconColor.withValues(alpha: 0.15),
                  width: 1,
                ),
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    children: [
                      Container(
                        width: 28,
                        height: 28,
                        decoration: BoxDecoration(
                          color: widget.iconColor.withValues(alpha: 0.15),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: Icon(
                          widget.icon,
                          color: widget.iconColor,
                          size: 14,
                          shadows: PremiumShadows.iconHalo(widget.iconColor),
                        ),
                      ),
                      const SizedBox(width: 8),
                      Expanded(
                        child: Text(
                          widget.label,
                          style: TextStyle(
                            color: context.appColors.textSecondary,
                            fontSize: 11,
                            fontWeight: FontWeight.w500,
                          ),
                          overflow: TextOverflow.ellipsis,
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 12),
                  // Count-up animation for amount
                  AnimatedCountUp(
                    value: widget.amount,
                    duration: const Duration(milliseconds: 800),
                    formatter: (value) => formatTurkishCurrency(
                      value,
                      decimalDigits: 0,
                      showDecimals: false,
                    ),
                    style: TextStyle(
                      color: context.appColors.textPrimary,
                      fontSize: 22,
                      fontWeight: FontWeight.w700,
                      shadows: [
                        Shadow(
                          color: widget.iconColor.withValues(alpha: 0.2),
                          blurRadius: 8,
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 6),
                  Text(
                    '${widget.hours.toStringAsFixed(1)} ${widget.l10n.hourAbbreviation} · %${widget.percent.toStringAsFixed(0)}',
                    style: TextStyle(
                      color: context.appColors.textTertiary,
                      fontSize: 11,
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                ],
              ),
            ),
          ),
        );
      },
    );
  }
}


--- FILE: lib/widgets/multi_currency_pro_sheet.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../theme/theme.dart';

/// Bottom sheet explaining Multi-Currency as a PRO feature
/// Shows lock icon with list of PRO benefits
class MultiCurrencyProSheet extends StatelessWidget {
  const MultiCurrencyProSheet({super.key});

  /// Show the Multi-Currency PRO sheet
  static void show(BuildContext context) {
    HapticFeedback.mediumImpact();
    showModalBottomSheet(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      backgroundColor: Colors.transparent,
      isScrollControlled: true,
      builder: (_) => const MultiCurrencyProSheet(),
    );
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return Container(
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
      ),
      child: SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(24),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              // Handle
              Container(
                width: 40,
                height: 4,
                decoration: BoxDecoration(
                  color: context.appColors.textTertiary,
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
              const SizedBox(height: 24),

              // Lock icon with crown
              Container(
                width: 80,
                height: 80,
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                    colors: [
                      context.appColors.gold.withValues(alpha: 0.2),
                      context.appColors.gold.withValues(alpha: 0.1),
                    ],
                  ),
                  shape: BoxShape.circle,
                ),
                child: Stack(
                  alignment: Alignment.center,
                  children: [
                    Icon(
                      CupertinoIcons.lock_fill,
                      size: 36,
                      color: context.appColors.gold,
                    ),
                    Positioned(
                      top: 8,
                      right: 8,
                      child: Container(
                        padding: const EdgeInsets.all(4),
                        decoration: BoxDecoration(
                          color: context.appColors.gold,
                          shape: BoxShape.circle,
                        ),
                        child: Icon(
                          CupertinoIcons.star_fill,
                          size: 14,
                          color: context.appColors.background,
                        ),
                      ),
                    ),
                  ],
                ),
              ),
              const SizedBox(height: 20),

              // Title
              Text(
                l10n.multiCurrencyProTitle,
                style: TextStyle(
                  fontSize: 22,
                  fontWeight: FontWeight.w700,
                  color: context.appColors.textPrimary,
                ),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 12),

              // Description
              Text(
                l10n.multiCurrencyProDescription,
                style: TextStyle(
                  fontSize: 14,
                  color: context.appColors.textSecondary,
                  height: 1.5,
                ),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 24),

              // Divider
              Divider(color: context.appColors.cardBorder),
              const SizedBox(height: 16),

              // PRO benefits title
              Align(
                alignment: Alignment.centerLeft,
                child: Text(
                  l10n.premiumIncludes,
                  style: TextStyle(
                    fontSize: 14,
                    fontWeight: FontWeight.w600,
                    color: context.appColors.textPrimary,
                  ),
                ),
              ),
              const SizedBox(height: 16),

              // Benefits list
              _buildBenefitRow(
                context,
                CupertinoIcons.money_dollar_circle,
                l10n.multiCurrencyBenefit,
              ),
              _buildBenefitRow(
                context,
                CupertinoIcons.chat_bubble_2,
                l10n.unlimitedAiChat,
              ),
              _buildBenefitRow(
                context,
                CupertinoIcons.scope,
                l10n.unlimitedPursuits,
              ),
              _buildBenefitRow(
                context,
                CupertinoIcons.square_arrow_up,
                l10n.exportFeature,
              ),
              _buildBenefitRow(
                context,
                CupertinoIcons.chart_bar,
                l10n.fullReports,
              ),
              _buildBenefitRow(
                context,
                CupertinoIcons.share,
                l10n.cleanShareCards,
              ),

              const SizedBox(height: 24),

              // Upgrade button
              SizedBox(
                width: double.infinity,
                child: Container(
                  decoration: BoxDecoration(
                    gradient: LinearGradient(
                      colors: [
                        context.appColors.primary,
                        context.appColors.primaryDark,
                      ],
                    ),
                    borderRadius: BorderRadius.circular(16),
                    boxShadow: [
                      BoxShadow(
                        color: context.appColors.primary.withValues(alpha: 0.3),
                        blurRadius: 12,
                        offset: const Offset(0, 4),
                      ),
                    ],
                  ),
                  child: ElevatedButton(
                    onPressed: () {
                      Navigator.pop(context);
                      Navigator.of(context).pushNamed('/paywall');
                    },
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.transparent,
                      foregroundColor: Colors.white,
                      shadowColor: Colors.transparent,
                      padding: const EdgeInsets.symmetric(vertical: 16),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(16),
                      ),
                    ),
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(
                          CupertinoIcons.star_fill,
                          size: 20,
                          color: context.appColors.gold,
                        ),
                        const SizedBox(width: 8),
                        Text(
                          l10n.upgradeToPro,
                          style: const TextStyle(
                            fontSize: 16,
                            fontWeight: FontWeight.w600,
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              ),
              const SizedBox(height: 12),

              // Maybe later button
              TextButton(
                onPressed: () => Navigator.pop(context),
                child: Text(
                  l10n.maybeLater,
                  style: TextStyle(
                    color: context.appColors.textSecondary,
                    fontWeight: FontWeight.w500,
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildBenefitRow(BuildContext context, IconData icon, String text) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 6),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(6),
            decoration: BoxDecoration(
              color: context.appColors.success.withValues(alpha: 0.15),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Icon(icon, size: 18, color: context.appColors.success),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Text(
              text,
              style: TextStyle(
                fontSize: 14,
                color: context.appColors.textSecondary,
              ),
            ),
          ),
        ],
      ),
    );
  }
}


--- FILE: lib/widgets/profile_photo_widget.dart ---

import 'dart:io';
import 'package:flutter/material.dart';
import 'package:image_picker/image_picker.dart';
import 'package:flutter/cupertino.dart';
import '../services/services.dart';
import '../theme/theme.dart';

/// Profil fotoğrafı widget'ı
/// Tıklanabilir, fotoğraf seçme/çekme özellikli
class ProfilePhotoWidget extends StatefulWidget {
  final double size;
  final bool editable;
  final VoidCallback? onPhotoChanged;

  const ProfilePhotoWidget({
    super.key,
    this.size = 100,
    this.editable = true,
    this.onPhotoChanged,
  });

  @override
  State<ProfilePhotoWidget> createState() => _ProfilePhotoWidgetState();
}

class _ProfilePhotoWidgetState extends State<ProfilePhotoWidget> {
  final _profileService = ProfileService();
  final _imagePicker = ImagePicker();
  String? _photoPath;
  bool _isLoading = false;

  @override
  void initState() {
    super.initState();
    _loadPhoto();
  }

  Future<void> _loadPhoto() async {
    final path = await _profileService.getProfilePhotoPath();
    if (mounted) {
      setState(() => _photoPath = path);
    }
  }

  Future<void> _pickImage(ImageSource source) async {
    try {
      setState(() => _isLoading = true);

      final pickedFile = await _imagePicker.pickImage(
        source: source,
        maxWidth: 512,
        maxHeight: 512,
        imageQuality: 85,
      );

      if (pickedFile == null) {
        setState(() => _isLoading = false);
        return;
      }

      final savedPath = await _profileService.saveProfilePhoto(
        File(pickedFile.path),
      );

      if (mounted) {
        setState(() {
          _photoPath = savedPath;
          _isLoading = false;
        });
        widget.onPhotoChanged?.call();
      }
    } catch (e) {
      if (mounted) {
        setState(() => _isLoading = false);
        ScaffoldMessenger.of(
          context,
        ).showSnackBar(const SnackBar(content: Text('Fotoğraf seçilemedi')));
      }
    }
  }

  Future<void> _deletePhoto() async {
    await _profileService.deleteProfilePhoto();
    if (mounted) {
      setState(() => _photoPath = null);
      widget.onPhotoChanged?.call();
    }
  }

  void _showOptions() {
    showModalBottomSheet(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      backgroundColor: context.appColors.surface,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
      ),
      builder: (context) => SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(24),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Container(
                width: 40,
                height: 4,
                decoration: BoxDecoration(
                  color: context.appColors.textTertiary,
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
              const SizedBox(height: 24),
              Text(
                'Profil Fotoğrafı',
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textPrimary,
                ),
              ),
              const SizedBox(height: 20),
              _buildOption(
                icon: CupertinoIcons.camera,
                label: 'Kameradan çek',
                onTap: () {
                  Navigator.pop(context);
                  _pickImage(ImageSource.camera);
                },
              ),
              const SizedBox(height: 12),
              _buildOption(
                icon: CupertinoIcons.photo,
                label: 'Galeriden seç',
                onTap: () {
                  Navigator.pop(context);
                  _pickImage(ImageSource.gallery);
                },
              ),
              if (_photoPath != null) ...[
                const SizedBox(height: 12),
                _buildOption(
                  icon: CupertinoIcons.trash,
                  label: 'Fotoğrafı kaldır',
                  isDestructive: true,
                  onTap: () {
                    Navigator.pop(context);
                    _deletePhoto();
                  },
                ),
              ],
              const SizedBox(height: 12),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildOption({
    required IconData icon,
    required String label,
    required VoidCallback onTap,
    bool isDestructive = false,
  }) {
    return Semantics(
      label: label,
      button: true,
      child: Material(
        color: Colors.transparent,
        child: InkWell(
          onTap: onTap,
          borderRadius: BorderRadius.circular(16),
          child: Container(
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: isDestructive
                ? context.appColors.error.withValues(alpha: 0.1)
                : context.appColors.surfaceLight,
            borderRadius: BorderRadius.circular(16),
          ),
          child: Row(
            children: [
              Icon(
                icon,
                color: isDestructive
                    ? context.appColors.error
                    : context.appColors.textSecondary,
                size: 24,
              ),
              const SizedBox(width: 16),
              Text(
                label,
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.w500,
                  color: isDestructive
                      ? context.appColors.error
                      : context.appColors.textPrimary,
                ),
              ),
            ],
          ),
        ),
      ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: widget.editable ? _showOptions : null,
      child: Stack(
        children: [
          // Ana fotoğraf/ikon alanı
          Container(
            width: widget.size,
            height: widget.size,
            decoration: BoxDecoration(
              color: context.appColors.primary.withValues(alpha: 0.1),
              shape: BoxShape.circle,
              border: Border.all(
                color: context.appColors.primary.withValues(alpha: 0.3),
                width: 2,
              ),
            ),
            child: ClipOval(
              child: _isLoading
                  ? Center(
                      child: CircularProgressIndicator(
                        strokeWidth: 2,
                        valueColor: AlwaysStoppedAnimation<Color>(
                          context.appColors.primary,
                        ),
                      ),
                    )
                  : _photoPath != null
                  ? Image.file(
                      File(_photoPath!),
                      fit: BoxFit.cover,
                      width: widget.size,
                      height: widget.size,
                      errorBuilder: (context, error, stackTrace) {
                        return Icon(
                          CupertinoIcons.person,
                          size: widget.size * 0.48,
                          color: context.appColors.primary,
                        );
                      },
                    )
                  : Icon(
                      CupertinoIcons.person,
                      size: widget.size * 0.48,
                      color: context.appColors.primary,
                    ),
            ),
          ),
          // Düzenleme ikonu
          if (widget.editable)
            Positioned(
              right: 0,
              bottom: 0,
              child: Container(
                width: widget.size * 0.32,
                height: widget.size * 0.32,
                decoration: BoxDecoration(
                  color: context.appColors.primary,
                  shape: BoxShape.circle,
                  border: Border.all(
                    color: context.appColors.background,
                    width: 2,
                  ),
                ),
                child: Icon(
                  CupertinoIcons.camera,
                  size: widget.size * 0.16,
                  color: context.appColors.background,
                ),
              ),
            ),
        ],
      ),
    );
  }
}

/// Küçük profil fotoğrafı (navigation bar için)
class SmallProfilePhoto extends StatefulWidget {
  final double size;

  const SmallProfilePhoto({super.key, this.size = 24});

  @override
  State<SmallProfilePhoto> createState() => _SmallProfilePhotoState();
}

class _SmallProfilePhotoState extends State<SmallProfilePhoto> {
  final _profileService = ProfileService();
  String? _photoPath;

  @override
  void initState() {
    super.initState();
    _loadPhoto();
  }

  Future<void> _loadPhoto() async {
    final path = await _profileService.getProfilePhotoPath();
    if (mounted) {
      setState(() => _photoPath = path);
    }
  }

  @override
  Widget build(BuildContext context) {
    if (_photoPath == null) {
      return const SizedBox.shrink(); // Fotoğraf yoksa boş döndür
    }

    return ClipOval(
      child: Image.file(
        File(_photoPath!),
        fit: BoxFit.cover,
        width: widget.size,
        height: widget.size,
        errorBuilder: (context, error, stackTrace) {
          return const SizedBox.shrink();
        },
      ),
    );
  }
}


--- FILE: lib/widgets/pending_review_banner.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../theme/theme.dart';

/// Banner widget shown when there are pending expenses to review
class PendingReviewBanner extends StatelessWidget {
  /// Number of expenses pending categorization
  final int pendingCount;

  /// Number of expenses with suggestions
  final int suggestionCount;

  /// Callback when banner is tapped
  final VoidCallback onTap;

  /// Optional callback for dismiss
  final VoidCallback? onDismiss;

  const PendingReviewBanner({
    super.key,
    required this.pendingCount,
    required this.suggestionCount,
    required this.onTap,
    this.onDismiss,
  });

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final totalCount = pendingCount + suggestionCount;

    if (totalCount == 0) return const SizedBox.shrink();

    return Semantics(
      button: true,
      label: l10n.pendingCategorization(totalCount),
      child: GestureDetector(
        onTap: () {
          HapticFeedback.lightImpact();
          onTap();
        },
        child: Container(
          margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
          decoration: BoxDecoration(
            gradient: LinearGradient(
              colors: [
                AppColors.warning.withValues(alpha: 0.9),
                AppColors.warning,
              ],
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
            ),
            borderRadius: BorderRadius.circular(16),
            boxShadow: [
              BoxShadow(
                color: Colors.orange.withValues(alpha: 0.3),
                blurRadius: 12,
                offset: const Offset(0, 4),
              ),
            ],
          ),
          child: Stack(
            children: [
              // Main content
              Padding(
                padding: const EdgeInsets.all(16),
                child: Row(
                  children: [
                    // Icon with pulse animation
                    _buildPulsingIcon(),
                    const SizedBox(width: 12),

                    // Text content
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          Text(
                            l10n.pendingCategorization(totalCount),
                            style: const TextStyle(
                              color: Colors.white,
                              fontWeight: FontWeight.bold,
                              fontSize: 16,
                            ),
                          ),
                          if (suggestionCount > 0) ...[
                            const SizedBox(height: 2),
                            Text(
                              l10n.suggestionsAvailable(suggestionCount),
                              style: TextStyle(
                                color: Colors.white.withValues(alpha: 0.85),
                                fontSize: 13,
                              ),
                            ),
                          ],
                        ],
                      ),
                    ),

                    // Arrow
                    const Icon(
                      CupertinoIcons.chevron_right,
                      color: Colors.white,
                      size: 24,
                    ),
                  ],
                ),
              ),

              // Dismiss button (if provided)
              if (onDismiss != null)
                Positioned(
                  top: 4,
                  right: 4,
                  child: IconButton(
                    icon: Icon(
                      CupertinoIcons.xmark,
                      color: Colors.white.withValues(alpha: 0.7),
                      size: 18,
                    ),
                    tooltip: l10n.close,
                    onPressed: () {
                      HapticFeedback.lightImpact();
                      onDismiss!();
                    },
                    padding: EdgeInsets.zero,
                    constraints: const BoxConstraints(
                      minWidth: 32,
                      minHeight: 32,
                    ),
                  ),
                ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildPulsingIcon() {
    return TweenAnimationBuilder<double>(
      tween: Tween(begin: 0.95, end: 1.05),
      duration: const Duration(milliseconds: 800),
      curve: Curves.easeInOut,
      builder: (context, scale, child) {
        return Transform.scale(
          scale: scale,
          child: Container(
            width: 44,
            height: 44,
            decoration: BoxDecoration(
              color: Colors.white.withValues(alpha: 0.2),
              borderRadius: BorderRadius.circular(16),
            ),
            child: const Center(
              child: Icon(
                CupertinoIcons.exclamationmark_triangle_fill,
                color: Colors.white,
                size: 24,
              ),
            ),
          ),
        );
      },
      onEnd: () {},
    );
  }
}

/// Compact version for smaller spaces
class PendingReviewChip extends StatelessWidget {
  final int count;
  final VoidCallback onTap;

  const PendingReviewChip({
    super.key,
    required this.count,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    if (count == 0) return const SizedBox.shrink();

    return Semantics(
      button: true,
      label: l10n.pendingCategorization(count),
      child: GestureDetector(
        onTap: () {
          HapticFeedback.lightImpact();
          onTap();
        },
        child: Container(
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
          decoration: BoxDecoration(
            color: context.appColors.warning.withValues(alpha: 0.2),
            borderRadius: BorderRadius.circular(24),
            border: Border.all(
              color: context.appColors.warning.withValues(alpha: 0.5),
            ),
          ),
          child: Row(
            mainAxisSize: MainAxisSize.min,
            children: [
              Icon(
                CupertinoIcons.exclamationmark_triangle_fill,
                color: context.appColors.warning,
                size: 16,
              ),
              const SizedBox(width: 6),
              Text(
                '$count',
                style: TextStyle(
                  color: context.appColors.warning,
                  fontWeight: FontWeight.w600,
                  fontSize: 14,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}


--- FILE: lib/widgets/ai_limit_dialog.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../theme/theme.dart';
import '../screens/paywall_screen.dart';
import '../screens/credit_purchase_screen.dart';

/// AI Limit Dialog Types
enum AILimitType {
  free, // 5/day limit reached
  proSubscription, // 500/month limit reached
  lifetime, // 100/month limit reached (can buy credits)
}

/// Shows AI limit dialog based on user type
class AILimitDialog {
  /// Show the appropriate dialog based on user type
  static Future<void> show(
    BuildContext context, {
    required AILimitType type,
    int? daysUntilReset,
    DateTime? resetDate,
  }) {
    return showDialog(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      barrierDismissible: false,
      builder: (context) => _AILimitDialogContent(
        type: type,
        daysUntilReset: daysUntilReset,
        resetDate: resetDate,
      ),
    );
  }
}

class _AILimitDialogContent extends StatelessWidget {
  final AILimitType type;
  final int? daysUntilReset;
  final DateTime? resetDate;

  const _AILimitDialogContent({
    required this.type,
    this.daysUntilReset,
    this.resetDate,
  });

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return Dialog(
      backgroundColor: Colors.transparent,
      child: Container(
        constraints: const BoxConstraints(maxWidth: 340),
        decoration: BoxDecoration(
          color: context.appColors.surface,
          borderRadius: BorderRadius.circular(24),
          border: Border.all(color: context.appColors.cardBorder, width: 1),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withValues(alpha: 0.3),
              blurRadius: 30,
              offset: const Offset(0, 10),
            ),
          ],
        ),
        child: Padding(
          padding: const EdgeInsets.all(24),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              // Icon
              _buildIcon(context),
              const SizedBox(height: 20),

              // Title
              Text(
                _getTitle(l10n),
                style: TextStyle(
                  fontSize: 20,
                  fontWeight: FontWeight.w700,
                  color: context.appColors.textPrimary,
                ),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 12),

              // Message
              Text(
                _getMessage(l10n),
                style: TextStyle(
                  fontSize: 14,
                  color: context.appColors.textSecondary,
                  height: 1.5,
                ),
                textAlign: TextAlign.center,
              ),

              // Reset date info (for Pro/Lifetime)
              if (type != AILimitType.free && resetDate != null) ...[
                const SizedBox(height: 16),
                _buildResetInfo(context, l10n),
              ],

              const SizedBox(height: 24),

              // Primary Button
              _buildPrimaryButton(context, l10n),

              // Secondary text/button
              if (type != AILimitType.proSubscription) ...[
                const SizedBox(height: 12),
                _buildSecondaryAction(context, l10n),
              ],
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildIcon(BuildContext context) {
    final IconData icon;
    final Color color;

    switch (type) {
      case AILimitType.free:
        icon = CupertinoIcons.lock_fill;
        color = context.appColors.warning;
      case AILimitType.proSubscription:
      case AILimitType.lifetime:
        icon = CupertinoIcons.hourglass;
        color = context.appColors.primary;
    }

    return Container(
      width: 72,
      height: 72,
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [color.withValues(alpha: 0.2), color.withValues(alpha: 0.1)],
        ),
        borderRadius: BorderRadius.circular(24),
      ),
      child: Icon(icon, size: 36, color: color),
    );
  }

  String _getTitle(AppLocalizations l10n) {
    switch (type) {
      case AILimitType.free:
        return l10n.aiLimitFreeTitleEmoji;
      case AILimitType.proSubscription:
      case AILimitType.lifetime:
        return l10n.aiLimitProTitleEmoji;
    }
  }

  String _getMessage(AppLocalizations l10n) {
    switch (type) {
      case AILimitType.free:
        return l10n.aiLimitFreeMessage;
      case AILimitType.proSubscription:
        return l10n.aiLimitProMessage;
      case AILimitType.lifetime:
        return l10n.aiLimitLifetimeMessage;
    }
  }

  Widget _buildResetInfo(BuildContext context, AppLocalizations l10n) {
    final monthName = _getMonthName(resetDate!.month, l10n);
    final resetText = l10n.aiLimitResetDate(
      resetDate!.day.toString(),
      monthName,
      daysUntilReset ?? 0,
    );

    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
      decoration: BoxDecoration(
        color: context.appColors.primary.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: context.appColors.primary.withValues(alpha: 0.2),
        ),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(
            CupertinoIcons.calendar_badge_plus,
            size: 18,
            color: context.appColors.primary,
          ),
          const SizedBox(width: 8),
          Flexible(
            child: Text(
              resetText,
              style: TextStyle(
                fontSize: 13,
                color: context.appColors.primary,
                fontWeight: FontWeight.w500,
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildPrimaryButton(BuildContext context, AppLocalizations l10n) {
    switch (type) {
      case AILimitType.free:
        return _GradientButton(
          onPressed: () {
            HapticFeedback.mediumImpact();
            Navigator.pop(context);
            Navigator.push(
              context,
              MaterialPageRoute(builder: (_) => const PaywallScreen()),
            );
          },
          icon: CupertinoIcons.rocket_fill,
          label: l10n.aiLimitUpgradeToPro,
        );

      case AILimitType.proSubscription:
        return SizedBox(
          width: double.infinity,
          child: ElevatedButton(
            onPressed: () {
              HapticFeedback.lightImpact();
              Navigator.pop(context);
            },
            style: ElevatedButton.styleFrom(
              backgroundColor: context.appColors.primary,
              foregroundColor: Colors.white,
              padding: const EdgeInsets.symmetric(vertical: 16),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(16),
              ),
              elevation: 0,
            ),
            child: Text(
              l10n.ok,
              style: const TextStyle(fontSize: 16, fontWeight: FontWeight.w600),
            ),
          ),
        );

      case AILimitType.lifetime:
        return _GradientButton(
          onPressed: () {
            HapticFeedback.mediumImpact();
            Navigator.pop(context);
            Navigator.push(
              context,
              MaterialPageRoute(builder: (_) => const CreditPurchaseScreen()),
            );
          },
          icon: CupertinoIcons.battery_charging,
          label: l10n.aiLimitBuyCredits,
        );
    }
  }

  Widget _buildSecondaryAction(BuildContext context, AppLocalizations l10n) {
    final text = type == AILimitType.free
        ? l10n.aiLimitTryTomorrow
        : l10n.aiLimitOrWaitDays(daysUntilReset ?? 0);

    return TextButton(
      onPressed: () {
        HapticFeedback.lightImpact();
        Navigator.pop(context);
      },
      child: Text(
        text,
        style: TextStyle(fontSize: 13, color: context.appColors.textTertiary),
      ),
    );
  }

  String _getMonthName(int month, AppLocalizations l10n) {
    switch (month) {
      case 1:
        return l10n.monthJan;
      case 2:
        return l10n.monthFeb;
      case 3:
        return l10n.monthMar;
      case 4:
        return l10n.monthApr;
      case 5:
        return l10n.monthMay;
      case 6:
        return l10n.monthJun;
      case 7:
        return l10n.monthJul;
      case 8:
        return l10n.monthAug;
      case 9:
        return l10n.monthSep;
      case 10:
        return l10n.monthOct;
      case 11:
        return l10n.monthNov;
      case 12:
        return l10n.monthDec;
      default:
        return '';
    }
  }
}

/// Gradient button widget
class _GradientButton extends StatelessWidget {
  final VoidCallback onPressed;
  final IconData icon;
  final String label;

  const _GradientButton({
    required this.onPressed,
    required this.icon,
    required this.label,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      width: double.infinity,
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [context.appColors.primary, context.appColors.secondary],
        ),
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(
            color: context.appColors.primary.withValues(alpha: 0.4),
            blurRadius: 15,
            offset: const Offset(0, 5),
          ),
        ],
      ),
      child: Material(
        color: Colors.transparent,
        child: InkWell(
          onTap: onPressed,
          borderRadius: BorderRadius.circular(16),
          child: Padding(
            padding: const EdgeInsets.symmetric(vertical: 16),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(icon, size: 20, color: Colors.white),
                const SizedBox(width: 8),
                Text(
                  label,
                  style: const TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.w600,
                    color: Colors.white,
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}


--- FILE: lib/widgets/currency_ticker.dart ---

import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../models/currency.dart';
import '../providers/currency_provider.dart';
import '../services/currency_service.dart';
import '../theme/theme.dart';

/// Currency ticker data model
class _TickerData {
  final String flag;
  final String code;
  final String value;

  const _TickerData({
    required this.flag,
    required this.code,
    required this.value,
  });
}

/// Currency Ticker Widget
/// Shows relevant exchange rates based on selected currency
class CurrencyTicker extends StatelessWidget {
  final ExchangeRates? rates;
  final bool isLoading;

  const CurrencyTicker({super.key, this.rates, this.isLoading = false});

  /// Get ticker items based on selected currency
  List<_TickerData> _getTickerItems(Currency selected, ExchangeRates? rates) {
    if (rates == null) {
      return [
        const _TickerData(flag: '🇺🇸', code: 'USD', value: '-'),
        const _TickerData(flag: '🇪🇺', code: 'EUR', value: '-'),
        const _TickerData(flag: '🪙', code: 'GOLD', value: '-'),
      ];
    }

    // Base rates from API (all TRY-based)
    final usdTry = rates.usdRate;
    final eurTry = rates.eurRate;
    final goldGramTry = rates.goldRate; // TRY per gram
    final goldOzUsd = rates.goldOzUsd; // USD per oz

    // Cross rates calculated from TRY rates
    final eurUsd = usdTry > 0 ? eurTry / usdTry : 0.0; // EUR/USD
    final usdEur = eurTry > 0 ? usdTry / eurTry : 0.0; // USD/EUR

    // GBP approximate rates (not available from TCMB)
    const gbpUsd = 1.27; // Approximate GBP/USD rate
    const gbpEur = 1.18; // Approximate GBP/EUR rate

    // SAR is pegged to USD at 3.75
    const sarUsd = 3.75;

    switch (selected.code) {
      case 'TRY':
        // TRY selected → USD/TRY, EUR/TRY, GOLD (₺/gr)
        return [
          _TickerData(
            flag: '🇺🇸',
            code: 'USD',
            value: '${_formatNumber(usdTry, 2)} ₺',
          ),
          _TickerData(
            flag: '🇪🇺',
            code: 'EUR',
            value: '${_formatNumber(eurTry, 2)} ₺',
          ),
          _TickerData(
            flag: '🪙',
            code: 'GOLD',
            value: '${_formatNumber(goldGramTry, 0)} ₺/gr',
          ),
        ];

      case 'USD':
        // USD selected → EUR/USD, TRY/USD, GOLD ($/oz)
        final tryUsd = usdTry > 0 ? 1 / usdTry : 0.0;
        return [
          _TickerData(
            flag: '🇪🇺',
            code: 'EUR',
            value: '${_formatNumber(eurUsd, 4)} \$',
          ),
          _TickerData(
            flag: '🇹🇷',
            code: 'TRY',
            value: '${_formatNumber(tryUsd, 4)} \$',
          ),
          _TickerData(
            flag: '🪙',
            code: 'GOLD',
            value: goldOzUsd != null
                ? '${_formatNumber(goldOzUsd, 0)} \$/oz'
                : '-',
          ),
        ];

      case 'EUR':
        // EUR selected → USD/EUR, TRY/EUR, GOLD (€/oz)
        final tryEur = eurTry > 0 ? 1 / eurTry : 0.0;
        final goldOzEur = goldOzUsd != null && eurUsd > 0
            ? goldOzUsd / eurUsd
            : null;
        return [
          _TickerData(
            flag: '🇺🇸',
            code: 'USD',
            value: '${_formatNumber(usdEur, 4)} €',
          ),
          _TickerData(
            flag: '🇹🇷',
            code: 'TRY',
            value: '${_formatNumber(tryEur, 4)} €',
          ),
          _TickerData(
            flag: '🪙',
            code: 'GOLD',
            value: goldOzEur != null
                ? '${_formatNumber(goldOzEur, 0)} €/oz'
                : '-',
          ),
        ];

      case 'GBP':
        // GBP selected → USD/GBP, EUR/GBP, GOLD (£/oz)
        final usdGbp = 1 / gbpUsd; // How many GBP per USD
        final eurGbp = 1 / gbpEur; // How many GBP per EUR
        final goldOzGbp = goldOzUsd != null ? goldOzUsd / gbpUsd : null;
        return [
          _TickerData(
            flag: '🇺🇸',
            code: 'USD',
            value: '${_formatNumber(usdGbp, 4)} £',
          ),
          _TickerData(
            flag: '🇪🇺',
            code: 'EUR',
            value: '${_formatNumber(eurGbp, 4)} £',
          ),
          _TickerData(
            flag: '🪙',
            code: 'GOLD',
            value: goldOzGbp != null
                ? '${_formatNumber(goldOzGbp, 0)} £/oz'
                : '-',
          ),
        ];

      case 'SAR':
        // SAR selected → USD/SAR, EUR/SAR, GOLD (﷼/oz)
        final eurSar = eurUsd * sarUsd; // EUR in SAR
        final goldOzSar = goldOzUsd != null ? goldOzUsd * sarUsd : null;
        return [
          _TickerData(
            flag: '🇺🇸',
            code: 'USD',
            value: '${_formatNumber(sarUsd, 2)} ﷼',
          ),
          _TickerData(
            flag: '🇪🇺',
            code: 'EUR',
            value: '${_formatNumber(eurSar, 2)} ﷼',
          ),
          _TickerData(
            flag: '🪙',
            code: 'GOLD',
            value: goldOzSar != null
                ? '${_formatNumber(goldOzSar, 0)} ﷼/oz'
                : '-',
          ),
        ];

      default:
        // Default: Show USD and EUR in TRY
        return [
          _TickerData(
            flag: '🇺🇸',
            code: 'USD',
            value: '${_formatNumber(usdTry, 2)} ₺',
          ),
          _TickerData(
            flag: '🇪🇺',
            code: 'EUR',
            value: '${_formatNumber(eurTry, 2)} ₺',
          ),
          _TickerData(
            flag: '🪙',
            code: 'GOLD',
            value: '${_formatNumber(goldGramTry, 0)} ₺/gr',
          ),
        ];
    }
  }

  String _formatNumber(double value, int decimals) {
    if (value >= 1000) {
      return value
          .toStringAsFixed(0)
          .replaceAllMapped(
            RegExp(r'(\d{1,3})(?=(\d{3})+(?!\d))'),
            (Match m) => '${m[1]},',
          );
    }
    return value.toStringAsFixed(decimals);
  }

  @override
  Widget build(BuildContext context) {
    final currencyProvider = context.watch<CurrencyProvider>();
    final selectedCurrency = currencyProvider.currency;
    final items = _getTickerItems(selectedCurrency, rates);

    if (isLoading) {
      return Container(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
        decoration: BoxDecoration(
          color: context.appColors.surface,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: context.appColors.cardBorder),
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            SizedBox(
              width: 14,
              height: 14,
              child: CircularProgressIndicator(
                strokeWidth: 2,
                valueColor: AlwaysStoppedAnimation<Color>(
                  context.appColors.textTertiary.withValues(alpha: 0.7),
                ),
              ),
            ),
            const SizedBox(width: 10),
            Text(
              'Loading rates...',
              style: TextStyle(
                fontSize: 12,
                color: context.appColors.textTertiary,
              ),
            ),
          ],
        ),
      );
    }

    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: context.appColors.cardBorder),
      ),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceEvenly,
        children: items.map((item) => _buildTickerItem(context, item)).toList(),
      ),
    );
  }

  Widget _buildTickerItem(BuildContext context, _TickerData item) {
    return Row(
      mainAxisSize: MainAxisSize.min,
      children: [
        Text(item.flag, style: const TextStyle(fontSize: 14)),
        const SizedBox(width: 4),
        Text(
          item.value,
          style: TextStyle(
            fontSize: 12,
            fontWeight: FontWeight.w600,
            color: context.appColors.textPrimary,
          ),
        ),
      ],
    );
  }
}


--- FILE: lib/widgets/redirect_savings_sheet.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';
import '../providers/providers.dart';
import '../theme/quiet_luxury.dart';
import 'pursuit_progress_visual.dart';
import 'budget_shift_dialog.dart';

/// Bottom sheet for redirecting cancelled expense to a pursuit
class RedirectSavingsSheet extends StatefulWidget {
  final double amount;
  final String currency;

  const RedirectSavingsSheet({
    super.key,
    required this.amount,
    required this.currency,
  });

  @override
  State<RedirectSavingsSheet> createState() => _RedirectSavingsSheetState();
}

class _RedirectSavingsSheetState extends State<RedirectSavingsSheet> {
  String? _selectedPursuitId;
  bool _isLoading = false;

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final pursuitProvider = context.watch<PursuitProvider>();
    final currencyProvider = context.watch<CurrencyProvider>();
    final pursuits = pursuitProvider.activePursuits;

    final formattedAmount =
        '${currencyProvider.currency.symbol}${widget.amount.toStringAsFixed(0)}';

    return Container(
      decoration: BoxDecoration(
        color: QuietLuxury.background,
        borderRadius: const BorderRadius.vertical(top: Radius.circular(20)),
      ),
      child: SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(20),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Handle bar
              Center(
                child: Container(
                  width: 40,
                  height: 4,
                  decoration: BoxDecoration(
                    color: QuietLuxury.cardBorder,
                    borderRadius: BorderRadius.circular(2),
                  ),
                ),
              ),
              const SizedBox(height: 20),

              // Header with icon
              Row(
                children: [
                  Container(
                    padding: const EdgeInsets.all(12),
                    decoration: BoxDecoration(
                      color: QuietLuxury.positive.withValues(alpha: 0.2),
                      borderRadius: BorderRadius.circular(16),
                    ),
                    child: Icon(
                      CupertinoIcons.money_dollar_circle_fill,
                      color: QuietLuxury.positive,
                      size: 24,
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          l10n.redirectSavings,
                          style: QuietLuxury.heading.copyWith(fontSize: 18),
                        ),
                        const SizedBox(height: 4),
                        Text(
                          l10n.redirectSavingsMessage(formattedAmount),
                          style: QuietLuxury.body,
                        ),
                      ],
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 20),

              // Pursuit list
              if (pursuits.isEmpty)
                _buildEmptyState(l10n)
              else
                ConstrainedBox(
                  constraints: BoxConstraints(
                    maxHeight: MediaQuery.of(context).size.height * 0.35,
                  ),
                  child: ListView.separated(
                    shrinkWrap: true,
                    itemCount: pursuits.length,
                    separatorBuilder: (_, __) => const SizedBox(height: 8),
                    itemBuilder: (context, index) {
                      final pursuit = pursuits[index];
                      final isSelected = pursuit.id == _selectedPursuitId;

                      return _PursuitSelectionTile(
                        pursuit: pursuit,
                        isSelected: isSelected,
                        currencySymbol: currencyProvider.currency.symbol,
                        onTap: () {
                          HapticFeedback.selectionClick();
                          setState(() => _selectedPursuitId = pursuit.id);
                        },
                      );
                    },
                  ),
                ),
              const SizedBox(height: 20),

              // Action buttons
              Row(
                children: [
                  // Skip button
                  Expanded(
                    child: OutlinedButton(
                      onPressed: () => Navigator.of(context).pop(false),
                      style: OutlinedButton.styleFrom(
                        foregroundColor: QuietLuxury.textSecondary,
                        side: BorderSide(color: QuietLuxury.cardBorder),
                        padding: const EdgeInsets.symmetric(vertical: 14),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(16),
                        ),
                      ),
                      child: Text(l10n.skipRedirect),
                    ),
                  ),
                  const SizedBox(width: 12),
                  // Add button
                  Expanded(
                    child: Semantics(
                      label: l10n.accessibilityAddSavings,
                      button: true,
                      child: ElevatedButton(
                        onPressed: _selectedPursuitId == null || _isLoading
                            ? null
                            : _onAddSavings,
                        style: ElevatedButton.styleFrom(
                          backgroundColor: QuietLuxury.positive,
                          foregroundColor: Colors.white,
                          padding: const EdgeInsets.symmetric(vertical: 14),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(16),
                          ),
                          disabledBackgroundColor: QuietLuxury.positive
                              .withValues(alpha: 0.3),
                        ),
                        child: _isLoading
                            ? const SizedBox(
                                width: 20,
                                height: 20,
                                child: CircularProgressIndicator(
                                  strokeWidth: 2,
                                  valueColor: AlwaysStoppedAnimation<Color>(
                                    Colors.white,
                                  ),
                                ),
                              )
                            : Text(
                                l10n.addSavings,
                                style: const TextStyle(
                                  fontWeight: FontWeight.w600,
                                ),
                              ),
                      ),
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildEmptyState(AppLocalizations l10n) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: QuietLuxury.cardBackground,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: QuietLuxury.cardBorder, width: 0.5),
      ),
      child: Column(
        children: [
          Icon(
            CupertinoIcons.star_fill,
            size: 48,
            color: QuietLuxury.textTertiary,
          ),
          const SizedBox(height: 12),
          Text(
            l10n.emptyPursuitsTitle,
            style: QuietLuxury.body.copyWith(color: QuietLuxury.textPrimary),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 4),
          Text(
            l10n.emptyPursuitsMessage,
            style: QuietLuxury.label,
            textAlign: TextAlign.center,
          ),
        ],
      ),
    );
  }

  Future<void> _onAddSavings() async {
    if (_selectedPursuitId == null) return;

    setState(() => _isLoading = true);

    final savingsPoolProvider = context.read<SavingsPoolProvider>();
    final pursuitProvider = context.read<PursuitProvider>();
    final currencyProvider = context.read<CurrencyProvider>();
    final l10n = AppLocalizations.of(context);

    // Get pursuit details for dialog
    final pursuit = pursuitProvider.getPursuitById(_selectedPursuitId!);
    if (pursuit == null) {
      setState(() => _isLoading = false);
      return;
    }

    try {
      // Try to allocate from pool
      final result = await savingsPoolProvider.allocateToDream(
        widget.amount,
        _selectedPursuitId!,
      );

      if (result.isSuccess) {
        // Also update pursuit's saved amount
        final reachedTarget = await pursuitProvider.addSavings(
          _selectedPursuitId!,
          widget.amount,
          source: TransactionSource.expenseCancelled,
          currency: widget.currency,
        );

        HapticFeedback.mediumImpact();

        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text(l10n.savingsAdded),
              backgroundColor: QuietLuxury.positive,
              behavior: SnackBarBehavior.floating,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(8),
              ),
            ),
          );
          Navigator.of(context).pop(reachedTarget);
        }
      } else if (result.needsBudgetShift || result.needsFullSource) {
        // Show budget shift dialog
        if (mounted) {
          Navigator.of(context).pop(); // Close redirect sheet first

          final shiftResult = await BudgetShiftDialog.show(
            context: context,
            shortfall: result.shortfall ?? widget.amount,
            totalAmount: widget.amount,
            dreamId: _selectedPursuitId!,
            dreamName: pursuit.name,
            currencySymbol: currencyProvider.currency.symbol,
          );

          if (shiftResult != null && shiftResult.success) {
            // Allocation was done in dialog, now update pursuit
            await pursuitProvider.addSavings(
              _selectedPursuitId!,
              widget.amount,
              source: TransactionSource.expenseCancelled,
              currency: widget.currency,
            );
          }
        }
      } else {
        // Other error
        HapticFeedback.heavyImpact();
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text(result.errorMessage ?? 'Error'),
              backgroundColor: QuietLuxury.negative,
              behavior: SnackBarBehavior.floating,
            ),
          );
        }
      }
    } catch (e) {
      debugPrint('[RedirectSavingsSheet] Error: $e');
      HapticFeedback.heavyImpact();
      if (mounted) {
        final l10n = AppLocalizations.of(context);
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(l10n.somethingWentWrong),
            backgroundColor: QuietLuxury.negative,
            behavior: SnackBarBehavior.floating,
          ),
        );
      }
    } finally {
      if (mounted) {
        setState(() => _isLoading = false);
      }
    }
  }
}

class _PursuitSelectionTile extends StatelessWidget {
  final Pursuit pursuit;
  final bool isSelected;
  final String currencySymbol;
  final VoidCallback onTap;

  const _PursuitSelectionTile({
    required this.pursuit,
    required this.isSelected,
    required this.currencySymbol,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    return Semantics(
      label: l10n.accessibilityPursuitCard(
        pursuit.name,
        '$currencySymbol${pursuit.savedAmount.toStringAsFixed(0)}',
        '$currencySymbol${pursuit.targetAmount.toStringAsFixed(0)}',
        pursuit.progressPercentDisplay,
      ),
      selected: isSelected,
      button: true,
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(16),
        child: AnimatedContainer(
          duration: const Duration(milliseconds: 200),
          padding: const EdgeInsets.all(12),
          decoration: BoxDecoration(
            color: isSelected
                ? QuietLuxury.positive.withValues(alpha: 0.15)
                : QuietLuxury.cardBackground,
            borderRadius: BorderRadius.circular(16),
            border: Border.all(
              color: isSelected
                  ? QuietLuxury.positive.withValues(alpha: 0.5)
                  : QuietLuxury.cardBorder,
              width: isSelected ? 1.5 : 0.5,
            ),
          ),
          child: Row(
            children: [
              // Progress visual
              PursuitCircularProgress(
                progress: pursuit.progressPercent,
                emoji: pursuit.emoji,
                size: 44,
                strokeWidth: 3,
                progressColor: isSelected
                    ? QuietLuxury.positive
                    : QuietLuxury.textTertiary,
              ),
              const SizedBox(width: 12),
              // Info
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      pursuit.name,
                      style: QuietLuxury.body.copyWith(
                        color: QuietLuxury.textPrimary,
                        fontWeight: isSelected
                            ? FontWeight.w600
                            : FontWeight.w400,
                      ),
                      maxLines: 1,
                      overflow: TextOverflow.ellipsis,
                    ),
                    const SizedBox(height: 2),
                    Text(
                      '$currencySymbol${pursuit.savedAmount.toStringAsFixed(0)} / $currencySymbol${pursuit.targetAmount.toStringAsFixed(0)}',
                      style: QuietLuxury.label,
                    ),
                  ],
                ),
              ),
              // Progress badge
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                decoration: BoxDecoration(
                  color: isSelected
                      ? QuietLuxury.positive.withValues(alpha: 0.2)
                      : QuietLuxury.cardBorder.withValues(alpha: 0.3),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Text(
                  '${pursuit.progressPercentDisplay}%',
                  style: QuietLuxury.label.copyWith(
                    color: isSelected
                        ? QuietLuxury.positive
                        : QuietLuxury.textTertiary,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

/// Show the redirect savings sheet
Future<bool?> showRedirectSavingsSheet(
  BuildContext context, {
  required double amount,
  required String currency,
}) {
  return showModalBottomSheet<bool>(
    context: context,
    barrierColor: Colors.black.withValues(alpha: 0.85),
    backgroundColor: Colors.transparent,
    isScrollControlled: true,
    builder: (_) => RedirectSavingsSheet(amount: amount, currency: currency),
  );
}


--- FILE: lib/widgets/expense_form_chips.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import '../theme/theme.dart';

/// Reusable date chip widget for expense form
class ExpenseDateChip extends StatelessWidget {
  final String? label;
  final IconData? icon;
  final bool isSelected;
  final VoidCallback onTap;

  const ExpenseDateChip({
    super.key,
    this.label,
    this.icon,
    required this.isSelected,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    return GestureDetector(
      onTap: onTap,
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        padding: EdgeInsets.symmetric(
          horizontal: label != null ? 16 : 12,
          vertical: 10,
        ),
        decoration: BoxDecoration(
          gradient: isSelected ? AppGradients.primaryButton : null,
          color: isSelected
              ? null
              : (isDark
                    ? Colors.white.withValues(alpha: 0.05)
                    : Colors.black.withValues(alpha: 0.04)),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: isSelected
                ? Colors.transparent
                : (isDark
                      ? Colors.white.withValues(alpha: 0.1)
                      : Colors.black.withValues(alpha: 0.1)),
            width: 1,
          ),
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            if (icon != null)
              Icon(
                icon,
                size: 14,
                color: isSelected
                    ? Colors.white
                    : context.appColors.textSecondary,
              ),
            if (icon != null && label != null) const SizedBox(width: 6),
            if (label != null)
              Text(
                label!,
                style: TextStyle(
                  fontSize: 13,
                  fontWeight: isSelected ? FontWeight.w600 : FontWeight.w500,
                  color: isSelected
                      ? Colors.white
                      : context.appColors.textSecondary,
                ),
              ),
          ],
        ),
      ),
    );
  }
}

/// Reusable subcategory chip widget for expense form
class ExpenseSubCategoryChip extends StatelessWidget {
  final String label;
  final bool isRecent;
  final VoidCallback onTap;

  const ExpenseSubCategoryChip({
    super.key,
    required this.label,
    required this.isRecent,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    return GestureDetector(
      onTap: onTap,
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 150),
        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
        decoration: BoxDecoration(
          color: isRecent
              ? context.appColors.primary.withValues(alpha: 0.15)
              : (isDark
                    ? Colors.white.withValues(alpha: 0.05)
                    : Colors.black.withValues(alpha: 0.04)),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: isRecent
                ? context.appColors.primary.withValues(alpha: 0.5)
                : (isDark
                      ? Colors.white.withValues(alpha: 0.1)
                      : Colors.black.withValues(alpha: 0.1)),
            width: 1,
          ),
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            if (isRecent)
              Padding(
                padding: const EdgeInsets.only(right: 4),
                child: Icon(
                  CupertinoIcons.clock_fill,
                  size: 12,
                  color: context.appColors.primary,
                ),
              ),
            Text(
              label,
              style: TextStyle(
                fontSize: 13,
                fontWeight: isRecent ? FontWeight.w500 : FontWeight.w400,
                color: isRecent
                    ? context.appColors.primary
                    : context.appColors.textSecondary,
              ),
            ),
          ],
        ),
      ),
    );
  }
}


--- FILE: lib/widgets/share_edit_sheet.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../theme/theme.dart';
import '../theme/app_theme.dart';
import 'share_card_widget.dart';

/// Share card edit bottom sheet
class ShareEditSheet extends StatefulWidget {
  final IconData icon;
  final Color iconColor;
  final String categoryName;
  final int yearlyDays;
  final double yearlyAmount;
  final String frequency;
  final void Function(bool showAmount, bool showFrequency) onShare;

  const ShareEditSheet({
    super.key,
    required this.icon,
    required this.iconColor,
    required this.categoryName,
    required this.yearlyDays,
    required this.yearlyAmount,
    required this.frequency,
    required this.onShare,
  });

  @override
  State<ShareEditSheet> createState() => _ShareEditSheetState();
}

class _ShareEditSheetState extends State<ShareEditSheet> {
  bool showAmount = false;
  bool showFrequency = false;

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return Container(
      height: MediaQuery.of(context).size.height * 0.85,
      decoration: BoxDecoration(
        color: context.appColors.background,
        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
      ),
      child: Column(
        children: [
          // Handle
          Container(
            margin: const EdgeInsets.only(top: 12),
            width: 40,
            height: 4,
            decoration: BoxDecoration(
              color: context.appColors.cardBorder,
              borderRadius: BorderRadius.circular(2),
            ),
          ),

          // Title with close button
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text(
                  l10n.editYourCard,
                  style: TextStyle(
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                    color: context.appColors.textPrimary,
                  ),
                ),
                Semantics(
                  label: l10n.accessibilityCloseSheet,
                  button: true,
                  child: IconButton(
                    onPressed: () => Navigator.pop(context),
                    tooltip: l10n.close,
                    icon: Icon(
                      CupertinoIcons.xmark,
                      color: context.appColors.textPrimary,
                    ),
                  ),
                ),
              ],
            ),
          ),

          // Card preview (live updates)
          Expanded(
            child: Center(
              child: FittedBox(
                fit: BoxFit.contain,
                child: ShareCardWidget(
                  icon: widget.icon,
                  iconColor: widget.iconColor,
                  categoryName: widget.categoryName,
                  yearlyDays: widget.yearlyDays,
                  yearlyAmount: showAmount ? widget.yearlyAmount : null,
                  frequency: showFrequency ? widget.frequency : null,
                ),
              ),
            ),
          ),

          // Toggle options
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 24),
            child: Column(
              children: [
                // Duration - always on, cannot be changed
                _buildToggleRow(
                  CupertinoIcons.timer,
                  l10n.shareCardDuration(widget.yearlyDays),
                  true,
                  null,
                  locked: true,
                ),

                // Amount
                _buildToggleRow(
                  CupertinoIcons.money_dollar_circle,
                  l10n.shareCardAmountLabel(
                    _formatCurrency(widget.yearlyAmount),
                  ),
                  showAmount,
                  (val) {
                    HapticFeedback.selectionClick();
                    setState(() => showAmount = val);
                  },
                ),

                // Frequency
                _buildToggleRow(
                  CupertinoIcons.calendar,
                  l10n.shareCardFrequency(widget.frequency),
                  showFrequency,
                  (val) {
                    HapticFeedback.selectionClick();
                    setState(() => showFrequency = val);
                  },
                ),
              ],
            ),
          ),

          const SizedBox(height: 24),

          // Share button
          Padding(
            padding: const EdgeInsets.all(24),
            child: Semantics(
              label: l10n.share,
              button: true,
              child: Container(
                width: double.infinity,
                decoration: BoxDecoration(
                  gradient: const LinearGradient(
                    colors: [AppColors.primary, AppColors.secondary],
                  ),
                  borderRadius: BorderRadius.circular(16),
                  boxShadow: [
                    BoxShadow(
                      color: AppColors.primary.withValues(alpha: 0.3),
                      blurRadius: 12,
                      offset: const Offset(0, 4),
                    ),
                  ],
                ),
                child: ElevatedButton(
                  onPressed: _handleShare,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.transparent,
                    foregroundColor: Colors.white,
                    shadowColor: Colors.transparent,
                    padding: const EdgeInsets.symmetric(vertical: 18),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(16),
                    ),
                  ),
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      const Icon(CupertinoIcons.share_solid, size: 22),
                      const SizedBox(width: 8),
                      Text(
                        l10n.share,
                        style: const TextStyle(
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildToggleRow(
    IconData icon,
    String label,
    bool value,
    void Function(bool)? onChanged, {
    bool locked = false,
  }) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8),
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
        decoration: BoxDecoration(
          color: context.appColors.surfaceLight,
          borderRadius: BorderRadius.circular(16),
        ),
        child: Row(
          children: [
            Icon(icon, size: 20, color: context.appColors.primary),
            const SizedBox(width: 12),
            Expanded(
              child: Text(
                label,
                style: TextStyle(
                  color: context.appColors.textPrimary,
                  fontSize: 16,
                ),
              ),
            ),
            if (locked)
              const Icon(
                CupertinoIcons.lock_fill,
                color: Color(0x60FFFFFF),
                size: 20,
              )
            else
              Switch(
                value: value,
                onChanged: onChanged,
                activeTrackColor: context.appColors.primary,
                inactiveThumbColor: Colors.white54,
                inactiveTrackColor: context.appColors.surfaceLight,
              ),
          ],
        ),
      ),
    );
  }

  void _handleShare() {
    HapticFeedback.mediumImpact();
    Navigator.pop(context);
    widget.onShare(showAmount, showFrequency);
  }

  String _formatCurrency(double amount) {
    if (amount >= 1000000) {
      return '${(amount / 1000000).toStringAsFixed(1)}M';
    } else if (amount >= 1000) {
      return '${(amount / 1000).toStringAsFixed(0)}K';
    }
    return amount.toStringAsFixed(0);
  }
}


--- FILE: lib/widgets/app_lock_wrapper.dart ---

import 'package:flutter/material.dart';
import '../services/lock_service.dart';
import '../screens/lock_screen.dart';
import '../theme/app_theme.dart';

/// Wrapper widget that shows lock screen when app requires authentication
class AppLockWrapper extends StatefulWidget {
  final Widget child;

  const AppLockWrapper({super.key, required this.child});

  @override
  State<AppLockWrapper> createState() => _AppLockWrapperState();
}

class _AppLockWrapperState extends State<AppLockWrapper>
    with WidgetsBindingObserver {
  bool _isLocked = true;
  bool _checkingLock = true;
  bool _wasInBackground = false;

  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addObserver(this);
    _checkLock();
  }

  @override
  void dispose() {
    WidgetsBinding.instance.removeObserver(this);
    super.dispose();
  }

  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    if (state == AppLifecycleState.paused) {
      // App going to background - mark for lock check on return
      _wasInBackground = true;
    } else if (state == AppLifecycleState.resumed && _wasInBackground) {
      // App returning from background - check if should lock
      _wasInBackground = false;
      _checkLockOnResume();
    }
  }

  Future<void> _checkLock() async {
    final lockEnabled = await LockService.isLockEnabled();
    final hasPinSet = await LockService.hasPinSet();

    if (mounted) {
      setState(() {
        _isLocked = lockEnabled && hasPinSet;
        _checkingLock = false;
      });
    }
  }

  Future<void> _checkLockOnResume() async {
    final lockEnabled = await LockService.isLockEnabled();
    final hasPinSet = await LockService.hasPinSet();

    if (lockEnabled && hasPinSet && mounted) {
      setState(() => _isLocked = true);
    }
  }

  void _onUnlocked() {
    setState(() => _isLocked = false);
  }

  @override
  Widget build(BuildContext context) {
    if (_checkingLock) {
      // Show loading while checking lock status
      return MaterialApp(
        debugShowCheckedModeBanner: false,
        home: Scaffold(
          backgroundColor: AppColors.background,
          body: Center(
            child: CircularProgressIndicator(color: AppColors.primary),
          ),
        ),
      );
    }

    if (_isLocked) {
      return LockScreen(onUnlocked: _onUnlocked);
    }

    return widget.child;
  }
}


--- FILE: lib/widgets/create_budget_sheet.dart ---

import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/category_budget.dart';
import '../models/expense.dart';
import '../providers/category_budget_provider.dart';
import '../providers/currency_provider.dart';
import '../theme/theme.dart';
import '../utils/currency_utils.dart';
import 'turkish_currency_input.dart';

/// Bottom sheet to create or edit a category budget
class CreateBudgetSheet extends StatefulWidget {
  final CategoryBudget? existingBudget;
  final String? preselectedCategory;

  const CreateBudgetSheet({
    super.key,
    this.existingBudget,
    this.preselectedCategory,
  });

  bool get isEditMode => existingBudget != null;

  /// Show the create budget sheet
  static Future<bool?> show(
    BuildContext context, {
    CategoryBudget? existingBudget,
    String? preselectedCategory,
  }) {
    return showModalBottomSheet<bool>(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      builder: (context) => CreateBudgetSheet(
        existingBudget: existingBudget,
        preselectedCategory: preselectedCategory,
      ),
    );
  }

  @override
  State<CreateBudgetSheet> createState() => _CreateBudgetSheetState();
}

class _CreateBudgetSheetState extends State<CreateBudgetSheet> {
  final _amountController = TextEditingController();
  String? _selectedCategory;
  bool _isSaving = false;

  @override
  void initState() {
    super.initState();

    if (widget.isEditMode) {
      _selectedCategory = widget.existingBudget!.category;
      _amountController.text = formatTurkishCurrency(
        widget.existingBudget!.monthlyLimit,
        decimalDigits: 0,
      );
    } else if (widget.preselectedCategory != null) {
      _selectedCategory = widget.preselectedCategory;
    }
  }

  @override
  void dispose() {
    _amountController.dispose();
    super.dispose();
  }

  Future<void> _saveBudget() async {
    if (_selectedCategory == null) {
      _showError(AppLocalizations.of(context).pleaseSelectCategory);
      return;
    }

    final amount = parseTurkishCurrency(_amountController.text);
    if (amount == null || amount <= 0) {
      _showError(AppLocalizations.of(context).validationAmountPositive);
      return;
    }

    setState(() => _isSaving = true);

    try {
      final budgetProvider = context.read<CategoryBudgetProvider>();

      final budget = widget.isEditMode
          ? widget.existingBudget!.copyWith(
              monthlyLimit: amount,
              category: _selectedCategory,
            )
          : CategoryBudget(category: _selectedCategory!, monthlyLimit: amount);

      final success = widget.isEditMode
          ? await budgetProvider.updateBudget(budget)
          : await budgetProvider.addBudget(budget);

      if (success && mounted) {
        HapticFeedback.mediumImpact();
        Navigator.pop(context, true);
      }
    } catch (e) {
      if (mounted) {
        _showError(e.toString());
      }
    } finally {
      if (mounted) {
        setState(() => _isSaving = false);
      }
    }
  }

  Future<void> _deleteBudget() async {
    if (!widget.isEditMode) return;

    final l10n = AppLocalizations.of(context);

    final confirmed = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: context.appColors.cardBackground,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
        title: Text(
          l10n.deleteBudget,
          style: TextStyle(color: context.appColors.textPrimary),
        ),
        content: Text(
          l10n.deleteBudgetConfirm,
          style: TextStyle(color: context.appColors.textSecondary),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: Text(
              l10n.cancel,
              style: TextStyle(color: context.appColors.textSecondary),
            ),
          ),
          ElevatedButton(
            onPressed: () => Navigator.pop(context, true),
            style: ElevatedButton.styleFrom(
              backgroundColor: context.appColors.error,
              foregroundColor: Colors.white,
            ),
            child: Text(l10n.delete),
          ),
        ],
      ),
    );

    if (confirmed == true) {
      setState(() => _isSaving = true);

      try {
        final budgetProvider = context.read<CategoryBudgetProvider>();
        final success = await budgetProvider.deleteBudget(
          widget.existingBudget!.id,
        );

        if (success && mounted) {
          HapticFeedback.mediumImpact();
          Navigator.pop(context, true);
        }
      } finally {
        if (mounted) {
          setState(() => _isSaving = false);
        }
      }
    }
  }

  void _showError(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: context.appColors.error,
        behavior: SnackBarBehavior.floating,
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final currencyProvider = context.watch<CurrencyProvider>();
    final budgetProvider = context.watch<CategoryBudgetProvider>();

    // Get available categories (exclude already budgeted unless editing)
    final availableCategories = widget.isEditMode
        ? ExpenseCategory.all
        : budgetProvider.getCategoriesWithoutBudget(ExpenseCategory.all);

    return DraggableScrollableSheet(
      initialChildSize: 0.6,
      minChildSize: 0.4,
      maxChildSize: 0.85,
      builder: (context, scrollController) {
        return ClipRRect(
          borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
          child: BackdropFilter(
            filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
            child: Container(
              decoration: BoxDecoration(
                color: context.appColors.gradientMid,
                borderRadius: const BorderRadius.vertical(
                  top: Radius.circular(24),
                ),
                border: Border.all(
                  color: Colors.white.withValues(alpha: 0.1),
                  width: 1,
                ),
              ),
              child: Column(
                children: [
                  // Handle bar
                  Padding(
                    padding: const EdgeInsets.only(top: 12, bottom: 8),
                    child: Container(
                      width: 40,
                      height: 4,
                      decoration: BoxDecoration(
                        color: context.appColors.textTertiary.withValues(
                          alpha: 0.5,
                        ),
                        borderRadius: BorderRadius.circular(2),
                      ),
                    ),
                  ),

                  // Header
                  Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 20),
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Text(
                          widget.isEditMode ? l10n.editBudget : l10n.addBudget,
                          style: TextStyle(
                            fontSize: 22,
                            fontWeight: FontWeight.w700,
                            color: context.appColors.textPrimary,
                            letterSpacing: -0.5,
                          ),
                        ),
                        Row(
                          children: [
                            if (widget.isEditMode)
                              Semantics(
                                button: true,
                                label: l10n.delete,
                                child: IconButton(
                                  onPressed: _isSaving ? null : _deleteBudget,
                                  tooltip: l10n.delete,
                                  icon: Icon(
                                    CupertinoIcons.trash,
                                    color: context.appColors.error,
                                    size: 22,
                                  ),
                                ),
                              ),
                            Semantics(
                              button: true,
                              label: l10n.accessibilityCloseSheet,
                              child: IconButton(
                                onPressed: () => Navigator.pop(context),
                                tooltip: l10n.close,
                                icon: Container(
                                  width: 36,
                                  height: 36,
                                  decoration: BoxDecoration(
                                    color: context.appColors.surfaceLight,
                                    shape: BoxShape.circle,
                                  ),
                                  child: Icon(
                                    CupertinoIcons.xmark,
                                    size: 20,
                                    color: context.appColors.textSecondary,
                                  ),
                                ),
                              ),
                            ),
                          ],
                        ),
                      ],
                    ),
                  ),

                  const SizedBox(height: 24),

                  // Content
                  Expanded(
                    child: SingleChildScrollView(
                      controller: scrollController,
                      padding: EdgeInsets.only(
                        left: 20,
                        right: 20,
                        bottom: MediaQuery.of(context).viewInsets.bottom + 24,
                      ),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          // Category dropdown
                          Text(
                            l10n.category,
                            style: TextStyle(
                              fontSize: 14,
                              fontWeight: FontWeight.w600,
                              color: context.appColors.textSecondary,
                            ),
                          ),
                          const SizedBox(height: 8),
                          DropdownButtonFormField<String>(
                            initialValue: _selectedCategory,
                            hint: Text(
                              l10n.selectCategory,
                              style: TextStyle(
                                color: context.appColors.textTertiary,
                              ),
                            ),
                            items: availableCategories.map((category) {
                              return DropdownMenuItem(
                                value: category,
                                child: Row(
                                  children: [
                                    Icon(
                                      ExpenseCategory.getIcon(category),
                                      size: 20,
                                      color: context.appColors.primary,
                                    ),
                                    const SizedBox(width: 12),
                                    Text(
                                      ExpenseCategory.getLocalizedName(
                                        category,
                                        l10n,
                                      ),
                                    ),
                                  ],
                                ),
                              );
                            }).toList(),
                            onChanged: widget.isEditMode
                                ? null
                                : (value) {
                                    setState(() => _selectedCategory = value);
                                  },
                            decoration: InputDecoration(
                              filled: true,
                              fillColor: context.appColors.surface,
                              contentPadding: const EdgeInsets.symmetric(
                                horizontal: 16,
                                vertical: 14,
                              ),
                              border: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(16),
                                borderSide: BorderSide(
                                  color: context.appColors.cardBorder,
                                ),
                              ),
                              enabledBorder: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(16),
                                borderSide: BorderSide(
                                  color: context.appColors.cardBorder,
                                ),
                              ),
                              focusedBorder: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(16),
                                borderSide: BorderSide(
                                  color: context.appColors.primary,
                                  width: 1.5,
                                ),
                              ),
                            ),
                            dropdownColor: context.appColors.surface,
                            style: TextStyle(
                              color: context.appColors.textPrimary,
                              fontSize: 14,
                            ),
                          ),

                          const SizedBox(height: 24),

                          // Amount input
                          Text(
                            l10n.monthlyLimit,
                            style: TextStyle(
                              fontSize: 14,
                              fontWeight: FontWeight.w600,
                              color: context.appColors.textSecondary,
                            ),
                          ),
                          const SizedBox(height: 8),
                          Container(
                            padding: const EdgeInsets.symmetric(
                              vertical: 16,
                              horizontal: 20,
                            ),
                            decoration: BoxDecoration(
                              color: context.appColors.surfaceLight,
                              borderRadius: BorderRadius.circular(16),
                              border: Border.all(
                                color: context.appColors.cardBorder,
                              ),
                            ),
                            child: Row(
                              children: [
                                Text(
                                  currencyProvider.symbol,
                                  style: TextStyle(
                                    fontSize: 24,
                                    fontWeight: FontWeight.w600,
                                    color: context.appColors.primary,
                                  ),
                                ),
                                const SizedBox(width: 12),
                                Expanded(
                                  child: TextField(
                                    controller: _amountController,
                                    keyboardType:
                                        const TextInputType.numberWithOptions(
                                          decimal: true,
                                        ),
                                    inputFormatters: [
                                      TurkishCurrencyInputFormatter(),
                                    ],
                                    style: TextStyle(
                                      fontSize: 28,
                                      fontWeight: FontWeight.w700,
                                      color: context.appColors.textPrimary,
                                    ),
                                    decoration: InputDecoration(
                                      hintText: '0',
                                      hintStyle: TextStyle(
                                        fontSize: 28,
                                        fontWeight: FontWeight.w700,
                                        color: context.appColors.textTertiary
                                            .withValues(alpha: 0.5),
                                      ),
                                      border: InputBorder.none,
                                    ),
                                  ),
                                ),
                              ],
                            ),
                          ),

                          const SizedBox(height: 16),

                          // Helper text
                          Container(
                            padding: const EdgeInsets.all(14),
                            decoration: BoxDecoration(
                              color: context.appColors.info.withValues(
                                alpha: 0.1,
                              ),
                              borderRadius: BorderRadius.circular(16),
                              border: Border.all(
                                color: context.appColors.info.withValues(
                                  alpha: 0.2,
                                ),
                              ),
                            ),
                            child: Row(
                              children: [
                                Icon(
                                  CupertinoIcons.info_circle,
                                  color: context.appColors.info,
                                  size: 20,
                                ),
                                const SizedBox(width: 10),
                                Expanded(
                                  child: Text(
                                    l10n.budgetHelperText,
                                    style: TextStyle(
                                      color: context.appColors.info,
                                      fontSize: 13,
                                    ),
                                  ),
                                ),
                              ],
                            ),
                          ),

                          const SizedBox(height: 32),

                          // Save button
                          SizedBox(
                            width: double.infinity,
                            height: 56,
                            child: Container(
                              decoration: BoxDecoration(
                                gradient: AppGradients.primaryButton,
                                borderRadius: BorderRadius.circular(16),
                                boxShadow: [
                                  BoxShadow(
                                    color: context.appColors.primary.withValues(
                                      alpha: 0.3,
                                    ),
                                    blurRadius: 12,
                                    offset: const Offset(0, 4),
                                  ),
                                ],
                              ),
                              child: ElevatedButton(
                                onPressed: _isSaving ? null : _saveBudget,
                                style: ElevatedButton.styleFrom(
                                  backgroundColor: Colors.transparent,
                                  shadowColor: Colors.transparent,
                                  shape: RoundedRectangleBorder(
                                    borderRadius: BorderRadius.circular(16),
                                  ),
                                ),
                                child: _isSaving
                                    ? SizedBox(
                                        width: 24,
                                        height: 24,
                                        child: CircularProgressIndicator(
                                          strokeWidth: 2,
                                          color: Colors.white,
                                        ),
                                      )
                                    : Row(
                                        mainAxisAlignment:
                                            MainAxisAlignment.center,
                                        children: [
                                          Icon(
                                            CupertinoIcons.floppy_disk,
                                            size: 22,
                                          ),
                                          const SizedBox(width: 10),
                                          Text(
                                            widget.isEditMode
                                                ? l10n.save
                                                : l10n.addBudget,
                                            style: const TextStyle(
                                              fontSize: 16,
                                              fontWeight: FontWeight.w600,
                                            ),
                                          ),
                                        ],
                                      ),
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        );
      },
    );
  }
}


--- FILE: lib/widgets/usage_limits_card.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../theme/theme.dart';
import '../services/free_tier_service.dart';
import '../constants/app_limits.dart';

/// Card showing user's remaining daily usage limits
class UsageLimitsCard extends StatefulWidget {
  final bool isPremium;

  const UsageLimitsCard({super.key, this.isPremium = false});

  @override
  State<UsageLimitsCard> createState() => _UsageLimitsCardState();
}

class _UsageLimitsCardState extends State<UsageLimitsCard> {
  final _freeTierService = FreeTierService();

  int _aiChatsUsed = 0;
  int _aiChatsTotal = AppLimits.freeAiChatsPerDay;
  int _voiceUsed = 0;
  int _voiceTotal = AppLimits.freeVoiceInputPerDay;

  @override
  void initState() {
    super.initState();
    _loadUsage();
  }

  Future<void> _loadUsage() async {
    final (aiUsed, aiTotal) = await _freeTierService.getAiChatUsage();
    final (voiceUsed, voiceTotal) = await _freeTierService.getVoiceInputUsage(widget.isPremium);

    if (mounted) {
      setState(() {
        _aiChatsUsed = aiUsed;
        _aiChatsTotal = aiTotal;
        _voiceUsed = voiceUsed;
        _voiceTotal = voiceTotal;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    if (widget.isPremium) {
      return _buildPremiumCard(context, l10n);
    }

    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: context.appColors.cardBorder),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(
                CupertinoIcons.chart_bar_fill,
                size: 20,
                color: context.appColors.primary,
              ),
              const SizedBox(width: 8),
              Text(
                l10n.dailyLimits,
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textPrimary,
                ),
              ),
            ],
          ),

          const SizedBox(height: 16),

          _buildLimitRow(
            context,
            icon: CupertinoIcons.chat_bubble_2_fill,
            label: l10n.aiChat,
            used: _aiChatsUsed,
            total: _aiChatsTotal,
            color: AppColors.categoryEntertainment,
          ),

          const SizedBox(height: 12),

          _buildLimitRow(
            context,
            icon: CupertinoIcons.mic_fill,
            label: l10n.voiceInput,
            used: _voiceUsed,
            total: _voiceTotal,
            color: AppColors.categoryTransport,
          ),
        ],
      ),
    );
  }

  Widget _buildPremiumCard(BuildContext context, AppLocalizations l10n) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [
            context.appColors.primary.withValues(alpha: 0.2),
            context.appColors.secondary.withValues(alpha: 0.2),
          ],
        ),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: context.appColors.primary.withValues(alpha: 0.3)),
      ),
      child: Row(
        children: [
          Icon(
            CupertinoIcons.infinite,
            size: 28,
            color: context.appColors.primary,
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  l10n.unlimitedWithPro,
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.w600,
                    color: context.appColors.textPrimary,
                  ),
                ),
                Text(
                  l10n.proMember,
                  style: TextStyle(
                    fontSize: 13,
                    color: context.appColors.textSecondary,
                  ),
                ),
              ],
            ),
          ),
          Icon(
            CupertinoIcons.star_fill,
            size: 24,
            color: AppColors.gold,
          ),
        ],
      ),
    );
  }

  Widget _buildLimitRow(
    BuildContext context, {
    required IconData icon,
    required String label,
    required int used,
    required int total,
    required Color color,
  }) {
    final remaining = total - used;
    final progress = total > 0 ? used / total : 0.0;
    final isExhausted = remaining <= 0;

    return Row(
      children: [
        Icon(icon, size: 18, color: color),
        const SizedBox(width: 10),
        Expanded(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(
                    label,
                    style: TextStyle(
                      fontSize: 13,
                      color: context.appColors.textSecondary,
                    ),
                  ),
                  Text(
                    '$remaining / $total',
                    style: TextStyle(
                      fontSize: 13,
                      fontWeight: FontWeight.w600,
                      color: isExhausted
                          ? context.appColors.error
                          : context.appColors.textPrimary,
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 6),
              ClipRRect(
                borderRadius: BorderRadius.circular(4),
                child: LinearProgressIndicator(
                  value: progress,
                  backgroundColor: context.appColors.surfaceLight,
                  valueColor: AlwaysStoppedAnimation<Color>(
                    isExhausted ? context.appColors.error : color,
                  ),
                  minHeight: 4,
                ),
              ),
            ],
          ),
        ),
      ],
    );
  }
}


--- FILE: lib/widgets/lottie_animations.dart ---

import 'package:flutter/material.dart';
import 'package:lottie/lottie.dart';

/// Centralized Lottie animation widgets for consistent app-wide usage
class LottieAnimations {
  // Asset paths
  static const String _celebration = 'assets/animations/celebration.json';
  static const String _success = 'assets/animations/success.json';
  static const String _coin = 'assets/animations/coin.json';
  static const String _empty = 'assets/animations/empty.json';
  static const String _loading = 'assets/animations/loading.json';

  /// Celebration animation for pursuit completion, achievements
  static Widget celebration({
    double size = 200,
    bool repeat = false,
    BoxFit fit = BoxFit.contain,
    AnimationController? controller,
  }) {
    return Lottie.asset(
      _celebration,
      width: size,
      height: size,
      repeat: repeat,
      fit: fit,
      controller: controller,
    );
  }

  /// Success checkmark animation for confirmations
  static Widget success({
    double size = 80,
    bool repeat = false,
    VoidCallback? onComplete,
  }) {
    return Lottie.asset(
      _success,
      width: size,
      height: size,
      repeat: repeat,
      onLoaded: onComplete != null
          ? (composition) {
              Future.delayed(composition.duration, onComplete);
            }
          : null,
    );
  }

  /// Coin/money animation for savings, rewards
  static Widget coin({double size = 60, bool repeat = true}) {
    return Lottie.asset(_coin, width: size, height: size, repeat: repeat);
  }

  /// Empty state animation when no data
  static Widget emptyState({double size = 150, bool repeat = true}) {
    return Lottie.asset(_empty, width: size, height: size, repeat: repeat);
  }

  /// Loading animation for async operations
  static Widget loading({double size = 50, Color? color}) {
    final widget = Lottie.asset(
      _loading,
      width: size,
      height: size,
      repeat: true,
    );

    if (color != null) {
      return ColorFiltered(
        colorFilter: ColorFilter.mode(color, BlendMode.srcIn),
        child: widget,
      );
    }
    return widget;
  }

  /// Shows a success animation dialog that auto-dismisses
  static Future<void> showSuccessOverlay(
    BuildContext context, {
    double size = 120,
    Duration? duration,
  }) async {
    final navigator = Navigator.of(context);
    showDialog(
      context: context,
      barrierColor: Colors.black26,
      barrierDismissible: false,
      builder: (_) => Center(
        child: Lottie.asset(
          _success,
          width: size,
          height: size,
          repeat: false,
          onLoaded: (composition) {
            final dismissDuration = duration ?? composition.duration;
            Future.delayed(dismissDuration, () {
              if (navigator.canPop()) {
                navigator.pop();
              }
            });
          },
        ),
      ),
    );
  }

  /// Full-screen celebration overlay
  static Widget celebrationOverlay({bool repeat = false}) {
    return IgnorePointer(
      child: Lottie.asset(_celebration, repeat: repeat, fit: BoxFit.cover),
    );
  }
}


--- FILE: lib/widgets/labeled_dropdown.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import '../theme/theme.dart';

class LabeledDropdown<T> extends StatelessWidget {
  final T value;
  final List<T> items;
  final String Function(T) labelBuilder;
  final String Function(T)? shortLabelBuilder;
  final ValueChanged<T?> onChanged;
  final String? label;

  const LabeledDropdown({
    super.key,
    required this.value,
    required this.items,
    required this.labelBuilder,
    this.shortLabelBuilder,
    required this.onChanged,
    this.label,
  });

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        if (label != null) ...[
          Text(
            label!,
            style: TextStyle(
              fontSize: 13,
              fontWeight: FontWeight.w500,
              color: context.appColors.textSecondary,
            ),
          ),
          const SizedBox(height: 8),
        ],
        Container(
          padding: const EdgeInsets.symmetric(horizontal: 16),
          decoration: BoxDecoration(
            color: context.appColors.surface,
            borderRadius: BorderRadius.circular(16),
            border: Border.all(color: context.appColors.cardBorder),
          ),
          child: DropdownButtonHideUnderline(
            child: DropdownButton<T>(
              value: value,
              isExpanded: true,
              icon: Icon(
                CupertinoIcons.chevron_down,
                color: context.appColors.textSecondary,
              ),
              dropdownColor: context.appColors.surfaceLight,
              borderRadius: BorderRadius.circular(16),
              style: TextStyle(
                fontSize: 15,
                fontWeight: FontWeight.w500,
                color: context.appColors.textPrimary,
              ),
              onChanged: onChanged,
              selectedItemBuilder: shortLabelBuilder != null
                  ? (context) => items
                        .map(
                          (item) => Align(
                            alignment: Alignment.centerLeft,
                            child: Text(
                              shortLabelBuilder!(item),
                              style: TextStyle(
                                fontSize: 15,
                                fontWeight: FontWeight.w500,
                                color: context.appColors.textPrimary,
                              ),
                            ),
                          ),
                        )
                        .toList()
                  : null,
              items: items
                  .map(
                    (item) => DropdownMenuItem<T>(
                      value: item,
                      child: Text(
                        labelBuilder(item),
                        style: TextStyle(
                          fontSize: 15,
                          fontWeight: FontWeight.w400,
                          color: context.appColors.textPrimary,
                        ),
                      ),
                    ),
                  )
                  .toList(),
            ),
          ),
        ),
      ],
    );
  }
}


--- FILE: lib/widgets/renewal_warning_banner.dart ---

import 'dart:ui';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter/cupertino.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';
import '../services/subscription_manager.dart';
import '../theme/theme.dart';

/// Yaklaşan Yenileme Uyarı Banner'ı
/// Yaklaşan abonelik yenilemelerini gösteren banner
class RenewalWarningBanner extends StatefulWidget {
  final int withinHours;
  final VoidCallback? onTap;
  final VoidCallback? onDismiss;

  const RenewalWarningBanner({
    super.key,
    this.withinHours = 24,
    this.onTap,
    this.onDismiss,
  });

  @override
  State<RenewalWarningBanner> createState() => _RenewalWarningBannerState();
}

class _RenewalWarningBannerState extends State<RenewalWarningBanner>
    with SingleTickerProviderStateMixin {
  List<Subscription> _upcomingRenewals = [];
  bool _isLoading = true;
  bool _isDismissed = false;

  late AnimationController _pulseController;
  late Animation<double> _pulseAnimation;

  @override
  void initState() {
    super.initState();
    _pulseController = AnimationController(
      duration: const Duration(seconds: 2),
      vsync: this,
    )..repeat(reverse: true);

    _pulseAnimation = Tween<double>(begin: 0.8, end: 1.0).animate(
      CurvedAnimation(parent: _pulseController, curve: Curves.easeInOut),
    );

    _loadRenewals();
  }

  @override
  void dispose() {
    _pulseController.dispose();
    super.dispose();
  }

  Future<void> _loadRenewals() async {
    try {
      // withinHours'u gün cinsine çevir (24 saat = 1 gün)
      final days = (widget.withinHours / 24).ceil();
      final renewals = await subscriptionManager.getUpcomingRenewals(days);

      setState(() {
        _upcomingRenewals = renewals;
        _isLoading = false;
      });
    } catch (e) {
      debugPrint('[RenewalWarningBanner] Error loading renewals: $e');
      if (mounted) {
        setState(() => _isLoading = false);
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    if (_isLoading || _isDismissed || _upcomingRenewals.isEmpty) {
      return const SizedBox.shrink();
    }

    final totalAmount = _upcomingRenewals.fold<double>(
      0,
      (sum, s) => sum + s.amount,
    );

    final isUrgent = _upcomingRenewals.any((s) => s.hoursUntilRenewal <= 6);

    return AnimatedBuilder(
      animation: _pulseAnimation,
      builder: (context, child) {
        return Container(
          margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(16),
            border: Border.all(
              color: (isUrgent ? AppColors.urgentOrange : AppColors.secondary)
                  .withValues(alpha: 0.5 * _pulseAnimation.value),
              width: 1.5,
            ),
            boxShadow: [
              BoxShadow(
                color: (isUrgent ? AppColors.urgentOrange : AppColors.secondary)
                    .withValues(alpha: 0.2 * _pulseAnimation.value),
                blurRadius: 16,
                spreadRadius: 2,
              ),
            ],
          ),
          child: ClipRRect(
            borderRadius: BorderRadius.circular(16),
            child: BackdropFilter(
              filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
              child: Container(
                color: context.appColors.surface.withValues(alpha: 0.9),
                child: Material(
                  color: Colors.transparent,
                  child: InkWell(
                    onTap: () {
                      HapticFeedback.lightImpact();
                      widget.onTap?.call();
                    },
                    borderRadius: BorderRadius.circular(16),
                    child: Padding(
                      padding: const EdgeInsets.all(14),
                      child: Row(
                        children: [
                          // Icon
                          Container(
                            width: 44,
                            height: 44,
                            decoration: BoxDecoration(
                              gradient: LinearGradient(
                                colors: isUrgent
                                    ? [AppColors.urgentOrange, AppColors.error]
                                    : [AppColors.secondary, AppColors.primary],
                              ),
                              borderRadius: BorderRadius.circular(16),
                            ),
                            child: Icon(
                              isUrgent
                                  ? CupertinoIcons.exclamationmark_circle
                                  : CupertinoIcons.bell,
                              color: Colors.white,
                              size: 22,
                            ),
                          ),
                          const SizedBox(width: 12),

                          // Content
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  isUrgent
                                      ? l10n.urgentRenewalWarning
                                      : l10n.upcomingRenewals,
                                  style: TextStyle(
                                    fontSize: 14,
                                    fontWeight: FontWeight.w700,
                                    color: isUrgent
                                        ? AppColors.urgentOrange
                                        : AppColors.secondary,
                                  ),
                                ),
                                const SizedBox(height: 2),
                                Text(
                                  _buildDescription(l10n),
                                  style: TextStyle(
                                    fontSize: 12,
                                    color: context.appColors.textSecondary,
                                  ),
                                  maxLines: 1,
                                  overflow: TextOverflow.ellipsis,
                                ),
                              ],
                            ),
                          ),

                          // Amount
                          Container(
                            padding: const EdgeInsets.symmetric(
                              horizontal: 10,
                              vertical: 6,
                            ),
                            decoration: BoxDecoration(
                              color:
                                  (isUrgent
                                          ? AppColors.urgentOrange
                                          : AppColors.secondary)
                                      .withValues(alpha: 0.15),
                              borderRadius: BorderRadius.circular(8),
                            ),
                            child: Text(
                              '${totalAmount.toStringAsFixed(0)} ₺',
                              style: TextStyle(
                                fontSize: 14,
                                fontWeight: FontWeight.w700,
                                color: isUrgent
                                    ? AppColors.urgentOrange
                                    : AppColors.secondary,
                              ),
                            ),
                          ),

                          // Dismiss button
                          if (widget.onDismiss != null) ...[
                            const SizedBox(width: 8),
                            GestureDetector(
                              onTap: () {
                                HapticFeedback.lightImpact();
                                setState(() => _isDismissed = true);
                                widget.onDismiss?.call();
                              },
                              child: Icon(
                                CupertinoIcons.xmark,
                                size: 18,
                                color: context.appColors.textTertiary,
                              ),
                            ),
                          ],
                        ],
                      ),
                    ),
                  ),
                ),
              ),
            ),
          ),
        );
      },
    );
  }

  String _buildDescription(AppLocalizations l10n) {
    if (_upcomingRenewals.length == 1) {
      final sub = _upcomingRenewals.first;
      final hours = sub.hoursUntilRenewal;

      if (hours <= 1) {
        return l10n.renewsWithinOneHour(sub.name);
      } else if (hours <= 6) {
        return l10n.renewsWithinHours(sub.name, hours);
      } else if (sub.isRenewalToday) {
        return l10n.renewsToday(sub.name);
      } else {
        return l10n.renewsTomorrow(sub.name);
      }
    }

    return l10n.subscriptionsRenewingSoon(_upcomingRenewals.length);
  }
}

/// Kompakt Yenileme Uyarısı (Header için)
class CompactRenewalBadge extends StatelessWidget {
  final int count;
  final double totalAmount;
  final VoidCallback? onTap;

  const CompactRenewalBadge({
    super.key,
    required this.count,
    required this.totalAmount,
    this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    if (count == 0) return const SizedBox.shrink();

    return GestureDetector(
      onTap: () {
        HapticFeedback.lightImpact();
        onTap?.call();
      },
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
        decoration: BoxDecoration(
          gradient: const LinearGradient(
            colors: [AppColors.secondary, AppColors.primary],
          ),
          borderRadius: BorderRadius.circular(24),
          boxShadow: [
            BoxShadow(
              color: AppColors.secondary.withValues(alpha: 0.3),
              blurRadius: 8,
              offset: const Offset(0, 2),
            ),
          ],
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            const Icon(
              CupertinoIcons.bell,
              color: Colors.white,
              size: 14,
            ),
            const SizedBox(width: 4),
            Text(
              '$count',
              style: const TextStyle(
                fontSize: 12,
                fontWeight: FontWeight.w700,
                color: Colors.white,
              ),
            ),
            const SizedBox(width: 4),
            Container(
              width: 1,
              height: 12,
              color: Colors.white.withValues(alpha: 0.5),
            ),
            const SizedBox(width: 4),
            Text(
              '${totalAmount.toStringAsFixed(0)}₺',
              style: const TextStyle(
                fontSize: 12,
                fontWeight: FontWeight.w600,
                color: Colors.white,
              ),
            ),
          ],
        ),
      ),
    );
  }
}

/// FutureBuilder ile Renewal Badge
class RenewalBadgeLoader extends StatelessWidget {
  final int withinDays;
  final VoidCallback? onTap;

  const RenewalBadgeLoader({super.key, this.withinDays = 1, this.onTap});

  @override
  Widget build(BuildContext context) {
    return FutureBuilder<List<Subscription>>(
      future: subscriptionManager.getUpcomingRenewals(withinDays),
      builder: (context, snapshot) {
        if (!snapshot.hasData || snapshot.data!.isEmpty) {
          return const SizedBox.shrink();
        }

        final renewals = snapshot.data!;
        final total = renewals.fold<double>(0, (sum, s) => sum + s.amount);

        return CompactRenewalBadge(
          count: renewals.length,
          totalAmount: total,
          onTap: onTap,
        );
      },
    );
  }
}

/// Abonelik Özet Kartı (Dashboard için)
class SubscriptionSummaryCard extends StatefulWidget {
  final VoidCallback? onTap;

  const SubscriptionSummaryCard({super.key, this.onTap});

  @override
  State<SubscriptionSummaryCard> createState() =>
      _SubscriptionSummaryCardState();
}

class _SubscriptionSummaryCardState extends State<SubscriptionSummaryCard> {
  SubscriptionStats? _stats;
  bool _isLoading = true;

  @override
  void initState() {
    super.initState();
    _loadStats();
  }

  Future<void> _loadStats() async {
    try {
      final stats = await subscriptionManager.getStats();
      setState(() {
        _stats = stats;
        _isLoading = false;
      });
    } catch (e) {
      debugPrint('[SubscriptionSummaryCard] Error loading stats: $e');
      if (mounted) {
        setState(() => _isLoading = false);
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    if (_isLoading || _stats == null || _stats!.totalCount == 0) {
      return const SizedBox.shrink();
    }

    return Container(
      margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: _stats!.statusColor.withValues(alpha: 0.3)),
      ),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(16),
        child: BackdropFilter(
          filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
          child: Container(
            color: context.appColors.surface.withValues(alpha: 0.8),
            child: Material(
              color: Colors.transparent,
              child: InkWell(
                onTap: () {
                  HapticFeedback.lightImpact();
                  widget.onTap?.call();
                },
                borderRadius: BorderRadius.circular(16),
                child: Padding(
                  padding: const EdgeInsets.all(16),
                  child: Row(
                    children: [
                      Container(
                        width: 36,
                        height: 36,
                        decoration: BoxDecoration(
                          color: _stats!.statusColor.withValues(alpha: 0.15),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: Icon(
                          _stats!.statusIcon,
                          color: _stats!.statusColor,
                          size: 18,
                        ),
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              l10n.subscriptions,
                              style: TextStyle(
                                fontSize: 13,
                                fontWeight: FontWeight.w600,
                                color: _stats!.statusColor,
                              ),
                            ),
                            Text(
                              _stats!.statusText,
                              style: TextStyle(
                                fontSize: 11,
                                color: context.appColors.textTertiary,
                              ),
                            ),
                          ],
                        ),
                      ),
                      Text(
                        l10n.amountPerMonth(
                          _stats!.totalMonthlyCost.toStringAsFixed(0),
                        ),
                        style: TextStyle(
                          fontSize: 14,
                          fontWeight: FontWeight.w600,
                          color: context.appColors.textPrimary,
                        ),
                      ),
                      const SizedBox(width: 8),
                      Icon(
                        CupertinoIcons.chevron_right,
                        size: 14,
                        color: context.appColors.textTertiary,
                      ),
                    ],
                  ),
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }
}


--- FILE: lib/widgets/paywall_variants.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../theme/theme.dart';

/// Paywall Variant A: Feature-focused
class PaywallVariantA extends StatelessWidget {
  final VoidCallback onSubscribe;
  final String price;
  final bool isYearly;

  const PaywallVariantA({
    super.key,
    required this.onSubscribe,
    required this.price,
    this.isYearly = true,
  });

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    final features = [
      (CupertinoIcons.infinite, l10n.unlimitedAiChat),
      (CupertinoIcons.mic, l10n.voiceInput),
      (CupertinoIcons.scope, l10n.unlimitedPursuits),
      (CupertinoIcons.chart_bar_alt_fill, 'Gelismis Raporlar'),
      (CupertinoIcons.doc_on_doc_fill, l10n.statementImport),
      (CupertinoIcons.money_dollar_circle, 'Coklu Para Birimi'),
    ];

    return Column(
      children: [
        // Header
        Text(
          'Vantag Pro',
          style: TextStyle(
            fontSize: 28,
            fontWeight: FontWeight.bold,
            color: context.appColors.textPrimary,
          ),
        ),
        const SizedBox(height: 8),
        Text(
          'Tüm özelliklerin kilidini aç',
          style: TextStyle(
            fontSize: 16,
            color: context.appColors.textSecondary,
          ),
        ),
        const SizedBox(height: 32),

        // Feature list
        ...features.map((f) => Padding(
              padding: const EdgeInsets.symmetric(vertical: 8),
              child: Row(
                children: [
                  Container(
                    padding: const EdgeInsets.all(8),
                    decoration: BoxDecoration(
                      color: context.appColors.primary.withValues(alpha: 0.1),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Icon(f.$1, size: 20, color: context.appColors.primary),
                  ),
                  const SizedBox(width: 16),
                  Expanded(
                    child: Text(
                      f.$2,
                      style: TextStyle(
                        fontSize: 15,
                        color: context.appColors.textPrimary,
                      ),
                    ),
                  ),
                  Icon(
                    CupertinoIcons.checkmark_circle,
                    size: 20,
                    color: context.appColors.success,
                  ),
                ],
              ),
            )),

        const SizedBox(height: 32),

        // CTA
        SizedBox(
          width: double.infinity,
          child: ElevatedButton(
            onPressed: onSubscribe,
            style: ElevatedButton.styleFrom(
              backgroundColor: context.appColors.primary,
              padding: const EdgeInsets.symmetric(vertical: 16),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(16),
              ),
            ),
            child: Text(
              '$price / ${isYearly ? l10n.year : l10n.month}',
              style: const TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.bold,
                color: Colors.white,
              ),
            ),
          ),
        ),
      ],
    );
  }
}

/// Paywall Variant B: Price-focused with discount emphasis
class PaywallVariantB extends StatelessWidget {
  final VoidCallback onSubscribe;
  final String monthlyPrice;
  final String yearlyPrice;
  final int discountPercent;

  const PaywallVariantB({
    super.key,
    required this.onSubscribe,
    required this.monthlyPrice,
    required this.yearlyPrice,
    this.discountPercent = 50,
  });

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return Column(
      children: [
        // Discount banner
        Container(
          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
          decoration: BoxDecoration(
            gradient: LinearGradient(
              colors: [
                context.appColors.primary,
                context.appColors.secondary,
              ],
            ),
            borderRadius: BorderRadius.circular(24),
          ),
          child: Text(
            '%$discountPercent İndirim',
            style: const TextStyle(
              fontSize: 14,
              fontWeight: FontWeight.bold,
              color: Colors.white,
            ),
          ),
        ),
        const SizedBox(height: 24),

        // Price comparison
        Row(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Text(
              monthlyPrice,
              style: TextStyle(
                fontSize: 24,
                color: context.appColors.textTertiary,
                decoration: TextDecoration.lineThrough,
              ),
            ),
            const SizedBox(width: 16),
            Icon(
              CupertinoIcons.arrow_right,
              color: context.appColors.success,
            ),
            const SizedBox(width: 16),
            Text(
              yearlyPrice,
              style: TextStyle(
                fontSize: 32,
                fontWeight: FontWeight.bold,
                color: context.appColors.success,
              ),
            ),
          ],
        ),
        Text(
          l10n.perMonth,
          style: TextStyle(
            fontSize: 14,
            color: context.appColors.textSecondary,
          ),
        ),

        const SizedBox(height: 32),

        // Urgency text
        Container(
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: context.appColors.warning.withValues(alpha: 0.1),
            borderRadius: BorderRadius.circular(16),
            border: Border.all(
              color: context.appColors.warning.withValues(alpha: 0.3),
            ),
          ),
          child: Row(
            children: [
              Icon(
                CupertinoIcons.clock,
                color: context.appColors.warning,
              ),
              const SizedBox(width: 12),
              Expanded(
                child: Text(
                  'Sınırlı süreli teklif!',
                  style: TextStyle(
                    fontSize: 14,
                    color: context.appColors.warning,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ),
            ],
          ),
        ),

        const SizedBox(height: 32),

        // CTA
        SizedBox(
          width: double.infinity,
          child: ElevatedButton(
            onPressed: onSubscribe,
            style: ElevatedButton.styleFrom(
              backgroundColor: context.appColors.success,
              padding: const EdgeInsets.symmetric(vertical: 16),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(16),
              ),
            ),
            child: const Text(
              'İndirimimi Al',
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.bold,
                color: Colors.white,
              ),
            ),
          ),
        ),
      ],
    );
  }
}

/// Paywall Variant C: Social proof
class PaywallVariantC extends StatelessWidget {
  final VoidCallback onSubscribe;
  final String price;
  final int userCount;
  final double rating;

  const PaywallVariantC({
    super.key,
    required this.onSubscribe,
    required this.price,
    this.userCount = 50000,
    this.rating = 4.8,
  });

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        // User count
        Row(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              CupertinoIcons.person_2,
              size: 24,
              color: context.appColors.primary,
            ),
            const SizedBox(width: 8),
            Text(
              '${_formatNumber(userCount)}+',
              style: TextStyle(
                fontSize: 28,
                fontWeight: FontWeight.bold,
                color: context.appColors.textPrimary,
              ),
            ),
          ],
        ),
        Text(
          'Mutlu kullanıcı',
          style: TextStyle(
            fontSize: 16,
            color: context.appColors.textSecondary,
          ),
        ),

        const SizedBox(height: 24),

        // Rating
        Row(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            ...List.generate(
              5,
              (i) => Icon(
                i < rating.floor()
                    ? CupertinoIcons.star_fill
                    : CupertinoIcons.star,
                size: 24,
                color: AppColors.gold,
              ),
            ),
            const SizedBox(width: 8),
            Text(
              '$rating',
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.bold,
                color: context.appColors.textPrimary,
              ),
            ),
          ],
        ),

        const SizedBox(height: 32),

        // Testimonials
        _buildTestimonial(
          context,
          'Ayda 2000₺ biriktirdim!',
          'Ahmet K.',
          '⭐⭐⭐⭐⭐',
        ),
        const SizedBox(height: 12),
        _buildTestimonial(
          context,
          'En iyi finans uygulaması',
          'Zeynep T.',
          '⭐⭐⭐⭐⭐',
        ),

        const SizedBox(height: 32),

        // CTA
        SizedBox(
          width: double.infinity,
          child: ElevatedButton(
            onPressed: onSubscribe,
            style: ElevatedButton.styleFrom(
              backgroundColor: context.appColors.primary,
              padding: const EdgeInsets.symmetric(vertical: 16),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(16),
              ),
            ),
            child: const Text(
              'Binlerce Kullanıcıya Katıl',
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.bold,
                color: Colors.white,
              ),
            ),
          ),
        ),
        const SizedBox(height: 8),
        Text(
          price,
          style: TextStyle(
            fontSize: 14,
            color: context.appColors.textSecondary,
          ),
        ),
      ],
    );
  }

  Widget _buildTestimonial(
    BuildContext context,
    String text,
    String author,
    String stars,
  ) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: context.appColors.cardBorder),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(stars, style: const TextStyle(fontSize: 12)),
          const SizedBox(height: 4),
          Text(
            '"$text"',
            style: TextStyle(
              fontSize: 14,
              fontStyle: FontStyle.italic,
              color: context.appColors.textPrimary,
            ),
          ),
          const SizedBox(height: 4),
          Text(
            '— $author',
            style: TextStyle(
              fontSize: 12,
              color: context.appColors.textSecondary,
            ),
          ),
        ],
      ),
    );
  }

  String _formatNumber(int number) {
    if (number >= 1000000) {
      return '${(number / 1000000).toStringAsFixed(1)}M';
    } else if (number >= 1000) {
      return '${(number / 1000).toStringAsFixed(0)}K';
    }
    return number.toString();
  }
}


--- FILE: lib/widgets/pro_feature_gate.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import 'package:vantag/providers/pro_provider.dart';
import 'package:vantag/screens/paywall_screen.dart';
import 'package:vantag/services/purchase_service.dart';
import 'package:vantag/theme/app_theme.dart';

/// Types of Pro features that can be gated
enum ProFeature { aiChat, fullHistory, export, widgets }

/// A widget that gates Pro features with soft paywall
class ProFeatureGate extends StatelessWidget {
  final ProFeature feature;
  final Widget child;
  final Widget? lockedChild;

  const ProFeatureGate({
    super.key,
    required this.feature,
    required this.child,
    this.lockedChild,
  });

  @override
  Widget build(BuildContext context) {
    final proProvider = context.watch<ProProvider>();

    if (proProvider.isPro) {
      return child;
    }

    return lockedChild ?? _buildLockedState(context);
  }

  Widget _buildLockedState(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return GestureDetector(
      onTap: () => showPaywall(context, feature: feature),
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: context.appColors.cardBackground,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: context.appColors.cardBorder),
        ),
        child: Row(
          children: [
            Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  colors: [
                    context.appColors.primary.withValues(alpha: 0.2),
                    context.appColors.secondary.withValues(alpha: 0.2),
                  ],
                ),
                borderRadius: BorderRadius.circular(16),
              ),
              child: Icon(
                CupertinoIcons.star_fill,
                color: context.appColors.gold,
                size: 24,
              ),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    _getFeatureTitle(l10n),
                    style: Theme.of(context).textTheme.titleMedium,
                  ),
                  const SizedBox(height: 4),
                  Text(
                    l10n.paywallSubtitle,
                    style: Theme.of(context).textTheme.bodySmall?.copyWith(
                      color: context.appColors.textSecondary,
                    ),
                  ),
                ],
              ),
            ),
            Icon(
              CupertinoIcons.chevron_right,
              color: context.appColors.textSecondary,
            ),
          ],
        ),
      ),
    );
  }

  String _getFeatureTitle(AppLocalizations l10n) {
    switch (feature) {
      case ProFeature.aiChat:
        return l10n.featureAiChat;
      case ProFeature.fullHistory:
        return l10n.featureHistory;
      case ProFeature.export:
        return l10n.featureExport;
      case ProFeature.widgets:
        return l10n.featureWidgets;
    }
  }

  /// Show paywall screen
  static Future<bool> showPaywall(
    BuildContext context, {
    ProFeature? feature,
  }) async {
    final result = await Navigator.of(context).push<bool>(
      MaterialPageRoute(
        builder: (_) => PaywallScreen(featureName: feature?.name),
        fullscreenDialog: true,
      ),
    );
    return result ?? false;
  }

  /// Check if AI chat is available (with limit check for free users)
  static Future<bool> canUseAiChat(BuildContext context) async {
    final proProvider = context.read<ProProvider>();

    if (proProvider.isPro) return true;

    final canUse = await PurchaseService().canUseAiChat(false);

    if (!canUse && context.mounted) {
      _showAiLimitDialog(context);
      return false;
    }

    return true;
  }

  /// Increment AI usage and check if limit reached
  static Future<bool> useAiChat(BuildContext context) async {
    final proProvider = context.read<ProProvider>();

    if (proProvider.isPro) return true;

    final canUse = await PurchaseService().canUseAiChat(false);

    if (!canUse && context.mounted) {
      _showAiLimitDialog(context);
      return false;
    }

    // Increment usage
    await PurchaseService().incrementAiUsage();
    return true;
  }

  /// Show AI limit reached dialog
  static void _showAiLimitDialog(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    showDialog(
      context: context,
      builder: (ctx) => AlertDialog(
        backgroundColor: context.appColors.cardBackground,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(24)),
        title: Row(
          children: [
            Icon(CupertinoIcons.sparkles, color: context.appColors.primary),
            const SizedBox(width: 12),
            Text(l10n.aiLimitReached),
          ],
        ),
        content: Text(
          l10n.aiLimitMessage(
            PurchaseService.freeAiChatLimit,
            PurchaseService.freeAiChatLimit,
          ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(ctx),
            child: Text(l10n.cancel),
          ),
          ElevatedButton(
            onPressed: () {
              Navigator.pop(ctx);
              showPaywall(context, feature: ProFeature.aiChat);
            },
            style: ElevatedButton.styleFrom(
              backgroundColor: context.appColors.primary,
            ),
            child: Text(l10n.subscribeToPro),
          ),
        ],
      ),
    );
  }

  /// Show history limit dialog
  static void showHistoryLimitDialog(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    showDialog(
      context: context,
      builder: (ctx) => AlertDialog(
        backgroundColor: context.appColors.cardBackground,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(24)),
        title: Row(
          children: [
            Icon(CupertinoIcons.clock, color: context.appColors.primary),
            const SizedBox(width: 12),
            Text(l10n.historyLimitReached),
          ],
        ),
        content: Text(l10n.historyLimitMessage),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(ctx),
            child: Text(l10n.cancel),
          ),
          ElevatedButton(
            onPressed: () {
              Navigator.pop(ctx);
              showPaywall(context, feature: ProFeature.fullHistory);
            },
            style: ElevatedButton.styleFrom(
              backgroundColor: context.appColors.primary,
            ),
            child: Text(l10n.subscribeToPro),
          ),
        ],
      ),
    );
  }

  /// Show export Pro-only dialog
  static void showExportProDialog(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    showDialog(
      context: context,
      builder: (ctx) => AlertDialog(
        backgroundColor: context.appColors.cardBackground,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(24)),
        title: Row(
          children: [
            Icon(CupertinoIcons.doc_text, color: context.appColors.primary),
            const SizedBox(width: 12),
            Expanded(child: Text(l10n.exportProOnly)),
          ],
        ),
        content: Text(l10n.upgradeForExport),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(ctx),
            child: Text(l10n.cancel),
          ),
          ElevatedButton(
            onPressed: () {
              Navigator.pop(ctx);
              showPaywall(context, feature: ProFeature.export);
            },
            style: ElevatedButton.styleFrom(
              backgroundColor: context.appColors.primary,
            ),
            child: Text(l10n.subscribeToPro),
          ),
        ],
      ),
    );
  }
}

/// AI usage indicator widget (shows remaining uses for free users)
class AiUsageIndicator extends StatelessWidget {
  const AiUsageIndicator({super.key});

  @override
  Widget build(BuildContext context) {
    final proProvider = context.watch<ProProvider>();
    final l10n = AppLocalizations.of(context);

    if (proProvider.isPro) {
      return const SizedBox.shrink();
    }

    return FutureBuilder<int>(
      future: PurchaseService().getRemainingAiUses(false),
      builder: (context, snapshot) {
        final remaining = snapshot.data ?? PurchaseService.freeAiChatLimit;

        return Container(
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
          decoration: BoxDecoration(
            color: remaining <= 3
                ? context.appColors.error.withValues(alpha: 0.2)
                : context.appColors.surface,
            borderRadius: BorderRadius.circular(24),
            border: Border.all(
              color: remaining <= 3
                  ? context.appColors.error.withValues(alpha: 0.5)
                  : context.appColors.cardBorder,
            ),
          ),
          child: Row(
            mainAxisSize: MainAxisSize.min,
            children: [
              Icon(
                CupertinoIcons.sparkles,
                size: 14,
                color: remaining <= 3
                    ? context.appColors.error
                    : context.appColors.textSecondary,
              ),
              const SizedBox(width: 6),
              Text(
                l10n.remainingAiUses(remaining),
                style: Theme.of(context).textTheme.bodySmall?.copyWith(
                  color: remaining <= 3
                      ? context.appColors.error
                      : context.appColors.textSecondary,
                ),
              ),
            ],
          ),
        );
      },
    );
  }
}


--- FILE: lib/widgets/premium_share_card.dart ---

import 'dart:io';
import 'dart:math' as math;
import 'dart:ui';
import 'package:flutter/material.dart';
import 'package:flutter/rendering.dart';
import 'package:path_provider/path_provider.dart';
import 'package:flutter/cupertino.dart';
import 'package:share_plus/share_plus.dart';
import 'package:url_launcher/url_launcher.dart';
import 'package:image_gallery_saver_plus/image_gallery_saver_plus.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../theme/theme.dart';
import '../models/models.dart';
import '../utils/currency_utils.dart';
import '../services/referral_service.dart';
import '../services/deep_link_service.dart';
import '../services/haptic_service.dart';

/// Premium Share Card Format
enum ShareCardFormat {
  story, // 1080x1920 (9:16) - Instagram/TikTok Story
  square, // 1080x1080 (1:1) - Instagram Post / Twitter
}

/// Premium Share Card Widget
/// Designed for maximum viral potential and app downloads
class PremiumShareCard extends StatefulWidget {
  final double amount;
  final double hoursRequired;
  final String category;
  final DateTime date;
  final String currencySymbol;
  final ShareCardFormat format;
  final ExpenseDecision? decision;

  /// Whether to show a watermark (for free users)
  final bool showWatermark;

  const PremiumShareCard({
    super.key,
    required this.amount,
    required this.hoursRequired,
    required this.category,
    required this.date,
    this.currencySymbol = '₺',
    this.format = ShareCardFormat.story,
    this.decision,
    this.showWatermark = false,
  });

  @override
  State<PremiumShareCard> createState() => _PremiumShareCardState();
}

class _PremiumShareCardState extends State<PremiumShareCard>
    with SingleTickerProviderStateMixin {
  late AnimationController _glowController;
  late Animation<double> _glowAnimation;

  @override
  void initState() {
    super.initState();
    _glowController = AnimationController(
      duration: const Duration(seconds: 3),
      vsync: this,
    )..repeat(reverse: true);

    _glowAnimation = Tween<double>(begin: 0.4, end: 0.8).animate(
      CurvedAnimation(parent: _glowController, curve: Curves.easeInOut),
    );
  }

  @override
  void dispose() {
    _glowController.dispose();
    super.dispose();
  }

  Size get _cardSize {
    switch (widget.format) {
      case ShareCardFormat.story:
        return const Size(360, 640); // 9:16 ratio (scaled for preview)
      case ShareCardFormat.square:
        return const Size(360, 360); // 1:1 ratio
    }
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final size = _cardSize;

    return Container(
      width: size.width,
      height: size.height,
      decoration: BoxDecoration(borderRadius: BorderRadius.circular(24)),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(24),
        child: Stack(
          children: [
            // Background gradient
            _buildBackground(),

            // Noise texture overlay
            _buildNoiseOverlay(),

            // Ambient glow orb
            _buildGlowOrb(),

            // Main content
            _buildContent(l10n),

            // Vantag branding
            _buildBranding(),

            // Watermark for free users
            if (widget.showWatermark) _buildWatermark(),
          ],
        ),
      ),
    );
  }

  Widget _buildWatermark() {
    return Positioned(
      bottom: 12,
      right: 12,
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
        decoration: BoxDecoration(
          color: Colors.black.withValues(alpha: 0.5),
          borderRadius: BorderRadius.circular(6),
          border: Border.all(color: Colors.white.withValues(alpha: 0.2)),
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(
              CupertinoIcons.sparkles,
              size: 14,
              color: Colors.white.withValues(alpha: 0.8),
            ),
            const SizedBox(width: 6),
            Text(
              'vantag.app',
              style: TextStyle(
                color: Colors.white.withValues(alpha: 0.8),
                fontSize: 12,
                fontWeight: FontWeight.w600,
                letterSpacing: 0.5,
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildBackground() {
    return Container(
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            AppColors.background, // Deep purple-black
            AppColors.cardBackground, // Mid purple
            AppColors.background.withValues(alpha: 0.95), // Dark purple
          ],
          stops: const [0.0, 0.5, 1.0],
        ),
      ),
    );
  }

  Widget _buildNoiseOverlay() {
    return Opacity(
      opacity: 0.03,
      child: Container(
        decoration: const BoxDecoration(
          image: DecorationImage(
            image: AssetImage('assets/images/noise.png'),
            repeat: ImageRepeat.repeat,
          ),
        ),
      ),
    );
  }

  Widget _buildGlowOrb() {
    return AnimatedBuilder(
      animation: _glowAnimation,
      builder: (context, child) {
        return Positioned(
          top: widget.format == ShareCardFormat.story ? 120 : 40,
          left: 0,
          right: 0,
          child: Center(
            child: Container(
              width: 280,
              height: 280,
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                gradient: RadialGradient(
                  colors: [
                    context.appColors.primary.withValues(
                      alpha: _glowAnimation.value * 0.4,
                    ),
                    context.appColors.primary.withValues(
                      alpha: _glowAnimation.value * 0.2,
                    ),
                    context.appColors.primary.withValues(alpha: 0.0),
                  ],
                  stops: const [0.0, 0.5, 1.0],
                ),
              ),
            ),
          ),
        );
      },
    );
  }

  Widget _buildContent(AppLocalizations l10n) {
    final isStory = widget.format == ShareCardFormat.story;

    return Padding(
      padding: EdgeInsets.symmetric(
        horizontal: 24,
        vertical: isStory ? 60 : 32,
      ),
      child: Column(
        children: [
          if (isStory) const SizedBox(height: 40),

          // Category badge
          _buildCategoryBadge(),

          SizedBox(height: isStory ? 40 : 24),

          // Hero: Hours display
          _buildHeroSection(l10n),

          SizedBox(height: isStory ? 32 : 20),

          // Amount card
          _buildAmountCard(l10n),

          if (isStory) ...[
            const Spacer(),

            // CTA Section
            _buildCTASection(l10n),

            const SizedBox(height: 24),
          ],
        ],
      ),
    );
  }

  Widget _buildCategoryBadge() {
    final icon = ExpenseCategory.getIcon(widget.category);
    final color = ExpenseCategory.getColor(widget.category);

    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
      decoration: BoxDecoration(
        color: Colors.white.withValues(alpha: 0.08),
        borderRadius: BorderRadius.circular(24),
        border: Border.all(
          color: Colors.white.withValues(alpha: 0.1),
          width: 1,
        ),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Container(
            width: 32,
            height: 32,
            decoration: BoxDecoration(
              color: color.withValues(alpha: 0.2),
              shape: BoxShape.circle,
            ),
            child: Icon(icon, size: 16, color: color),
          ),
          const SizedBox(width: 10),
          Text(
            widget.category,
            style: const TextStyle(
              fontSize: 14,
              fontWeight: FontWeight.w600,
              color: Colors.white,
              letterSpacing: 0.5,
            ),
          ),
          const SizedBox(width: 8),
          Container(
            width: 4,
            height: 4,
            decoration: BoxDecoration(
              color: Colors.white.withValues(alpha: 0.4),
              shape: BoxShape.circle,
            ),
          ),
          const SizedBox(width: 8),
          Text(
            _formatDate(widget.date),
            style: TextStyle(
              fontSize: 12,
              color: Colors.white.withValues(alpha: 0.6),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildHeroSection(AppLocalizations l10n) {
    final hours = widget.hoursRequired;
    final displayHours = hours < 1
        ? hours * 60
        : hours; // Convert to minutes if < 1 hour
    final isMinutes = hours < 1;
    final unit = isMinutes ? 'dk' : 'saat';

    return Column(
      children: [
        // Pre-text
        Text(
          'Bunu almak için',
          style: TextStyle(
            fontSize: 16,
            fontWeight: FontWeight.w400,
            color: Colors.white.withValues(alpha: 0.7),
            letterSpacing: 0.5,
          ),
        ),

        const SizedBox(height: 12),

        // Hero number with gradient
        ShaderMask(
          shaderCallback: (bounds) {
            return const LinearGradient(
              colors: [Color(0xFFFFFFFF), Color(0xFFE8E4FF), Color(0xFFB8B0FF)],
              begin: Alignment.topCenter,
              end: Alignment.bottomCenter,
            ).createShader(bounds);
          },
          child: Text(
            isMinutes
                ? displayHours.toStringAsFixed(0)
                : (hours >= 10
                      ? hours.toStringAsFixed(0)
                      : hours.toStringAsFixed(1)),
            style: TextStyle(
              fontSize: widget.format == ShareCardFormat.story ? 96 : 72,
              fontWeight: FontWeight.w800,
              color: Colors.white,
              height: 1,
              letterSpacing: -4,
            ),
          ),
        ),

        const SizedBox(height: 4),

        // Unit badge
        Container(
          padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 8),
          decoration: BoxDecoration(
            gradient: LinearGradient(
              colors: [
                context.appColors.primary.withValues(alpha: 0.3),
                context.appColors.primary.withValues(alpha: 0.1),
              ],
            ),
            borderRadius: BorderRadius.circular(24),
            border: Border.all(
              color: context.appColors.primary.withValues(alpha: 0.4),
              width: 1,
            ),
          ),
          child: Text(
            unit.toUpperCase(),
            style: const TextStyle(
              fontSize: 18,
              fontWeight: FontWeight.w700,
              color: Colors.white,
              letterSpacing: 3,
            ),
          ),
        ),

        const SizedBox(height: 12),

        // Post-text
        Text(
          'çalışman gerekiyor',
          style: TextStyle(
            fontSize: 16,
            fontWeight: FontWeight.w400,
            color: Colors.white.withValues(alpha: 0.7),
            letterSpacing: 0.5,
          ),
        ),
      ],
    );
  }

  Widget _buildAmountCard(AppLocalizations l10n) {
    return ClipRRect(
      borderRadius: BorderRadius.circular(16),
      child: BackdropFilter(
        filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
        child: Container(
          padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
          decoration: BoxDecoration(
            color: Colors.white.withValues(alpha: 0.08),
            borderRadius: BorderRadius.circular(16),
            border: Border.all(
              color: Colors.white.withValues(alpha: 0.1),
              width: 1,
            ),
          ),
          child: Row(
            mainAxisSize: MainAxisSize.min,
            children: [
              // Amount
              Text(
                '${widget.currencySymbol}${formatTurkishCurrency(widget.amount, decimalDigits: 0)}',
                style: const TextStyle(
                  fontSize: 28,
                  fontWeight: FontWeight.w700,
                  color: Colors.white,
                  letterSpacing: -0.5,
                ),
              ),

              const SizedBox(width: 16),

              // Decision indicator (if any)
              if (widget.decision != null) _buildDecisionIndicator(),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildDecisionIndicator() {
    final decision = widget.decision!;
    final (icon, color, label) = switch (decision) {
      ExpenseDecision.yes => (
        CupertinoIcons.checkmark_circle_fill,
        context.appColors.error,
        'Aldım',
      ),
      ExpenseDecision.no => (
        CupertinoIcons.nosign,
        context.appColors.success,
        'Vazgeçtim',
      ),
      ExpenseDecision.thinking => (
        CupertinoIcons.clock_fill,
        context.appColors.warning,
        'Düşünüyorum',
      ),
    };

    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
      decoration: BoxDecoration(
        color: color.withValues(alpha: 0.2),
        borderRadius: BorderRadius.circular(24),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(icon, size: 16, color: color),
          const SizedBox(width: 6),
          Text(
            label,
            style: TextStyle(
              fontSize: 12,
              fontWeight: FontWeight.w600,
              color: color,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildCTASection(AppLocalizations l10n) {
    return Column(
      children: [
        // Divider with glow
        Container(
          width: 120,
          height: 2,
          decoration: BoxDecoration(
            gradient: LinearGradient(
              colors: [
                Colors.transparent,
                context.appColors.primary.withValues(alpha: 0.6),
                Colors.transparent,
              ],
            ),
            borderRadius: BorderRadius.circular(1),
          ),
        ),

        const SizedBox(height: 20),

        // CTA text
        Text(
          'Sen kaç saat çalışıyorsun?',
          style: TextStyle(
            fontSize: 18,
            fontWeight: FontWeight.w600,
            color: Colors.white.withValues(alpha: 0.9),
          ),
        ),

        // Bottom spacing to prevent overlap with branding
        const SizedBox(height: 48),
      ],
    );
  }

  Widget _buildBranding() {
    return Positioned(
      bottom: widget.format == ShareCardFormat.story ? 20 : 16,
      left: 0,
      right: 0,
      child: Row(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          // Vantag logo placeholder (could be actual logo)
          Container(
            width: 24,
            height: 24,
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [
                  context.appColors.primary,
                  context.appColors.primaryLight,
                ],
              ),
              borderRadius: BorderRadius.circular(6),
            ),
            child: const Center(
              child: Text(
                'V',
                style: TextStyle(
                  fontSize: 14,
                  fontWeight: FontWeight.w800,
                  color: Colors.white,
                ),
              ),
            ),
          ),
          const SizedBox(width: 8),
          Text(
            'vantag.app',
            style: TextStyle(
              fontSize: 14,
              fontWeight: FontWeight.w500,
              color: Colors.white.withValues(alpha: 0.5),
              letterSpacing: 1,
            ),
          ),
        ],
      ),
    );
  }

  String _formatDate(DateTime date) {
    final months = [
      'Oca',
      'Şub',
      'Mar',
      'Nis',
      'May',
      'Haz',
      'Tem',
      'Ağu',
      'Eyl',
      'Eki',
      'Kas',
      'Ara',
    ];
    return '${date.day} ${months[date.month - 1]}';
  }
}

/// Animated glow painter for extra premium effect
class GlowPainter extends CustomPainter {
  final double animationValue;
  final Color color;

  GlowPainter({required this.animationValue, required this.color});

  @override
  void paint(Canvas canvas, Size size) {
    final center = Offset(size.width / 2, size.height / 2);
    final radius = math.min(size.width, size.height) / 2;

    final paint = Paint()
      ..shader = RadialGradient(
        colors: [
          color.withValues(alpha: animationValue * 0.5),
          color.withValues(alpha: animationValue * 0.2),
          color.withValues(alpha: 0.0),
        ],
        stops: const [0.0, 0.5, 1.0],
      ).createShader(Rect.fromCircle(center: center, radius: radius));

    canvas.drawCircle(center, radius, paint);
  }

  @override
  bool shouldRepaint(GlowPainter oldDelegate) {
    return oldDelegate.animationValue != animationValue;
  }
}

/// Square format variant for social posts
class PremiumShareCardSquare extends StatelessWidget {
  final double amount;
  final double hoursRequired;
  final String category;
  final DateTime date;
  final String currencySymbol;
  final ExpenseDecision? decision;

  const PremiumShareCardSquare({
    super.key,
    required this.amount,
    required this.hoursRequired,
    required this.category,
    required this.date,
    this.currencySymbol = '₺',
    this.decision,
  });

  @override
  Widget build(BuildContext context) {
    return PremiumShareCard(
      amount: amount,
      hoursRequired: hoursRequired,
      category: category,
      date: date,
      currencySymbol: currencySymbol,
      format: ShareCardFormat.square,
      decision: decision,
    );
  }
}

/// Helper function to show share card preview
void showShareCardPreview(
  BuildContext context, {
  required double amount,
  required double hoursRequired,
  required String category,
  required DateTime date,
  String currencySymbol = '₺',
  ExpenseDecision? decision,
}) {
  showModalBottomSheet(
    context: context,
    isScrollControlled: true,
    backgroundColor: Colors.transparent,
    barrierColor: Colors.black.withValues(alpha: 0.85),
    builder: (context) => _ShareCardPreviewSheet(
      amount: amount,
      hoursRequired: hoursRequired,
      category: category,
      date: date,
      currencySymbol: currencySymbol,
      decision: decision,
    ),
  );
}

class _ShareCardPreviewSheet extends StatefulWidget {
  final double amount;
  final double hoursRequired;
  final String category;
  final DateTime date;
  final String currencySymbol;
  final ExpenseDecision? decision;

  const _ShareCardPreviewSheet({
    required this.amount,
    required this.hoursRequired,
    required this.category,
    required this.date,
    required this.currencySymbol,
    this.decision,
  });

  @override
  State<_ShareCardPreviewSheet> createState() => _ShareCardPreviewSheetState();
}

class _ShareCardPreviewSheetState extends State<_ShareCardPreviewSheet> {
  ShareCardFormat _selectedFormat = ShareCardFormat.story;
  final GlobalKey _cardKey = GlobalKey();
  bool _isProcessing = false;

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return DraggableScrollableSheet(
      initialChildSize: 0.9,
      minChildSize: 0.5,
      maxChildSize: 0.95,
      builder: (context, scrollController) {
        return Container(
          decoration: BoxDecoration(
            color: context.appColors.background,
            borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
          ),
          child: Column(
            children: [
              // Handle
              Padding(
                padding: const EdgeInsets.only(top: 12, bottom: 8),
                child: Container(
                  width: 40,
                  height: 4,
                  decoration: BoxDecoration(
                    color: Colors.white.withValues(alpha: 0.2),
                    borderRadius: BorderRadius.circular(2),
                  ),
                ),
              ),

              // Header
              Padding(
                padding: const EdgeInsets.symmetric(
                  horizontal: 20,
                  vertical: 8,
                ),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Text(
                      l10n.shareResult,
                      style: const TextStyle(
                        fontSize: 20,
                        fontWeight: FontWeight.w700,
                        color: Colors.white,
                      ),
                    ),
                    Semantics(
                      label: l10n.accessibilityCloseSheet,
                      button: true,
                      child: IconButton(
                        onPressed: () => Navigator.pop(context),
                        tooltip: l10n.close,
                        icon: const Icon(
                          CupertinoIcons.xmark,
                          color: Colors.white,
                        ),
                      ),
                    ),
                  ],
                ),
              ),

              // Format selector
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 20),
                child: Row(
                  children: [
                    _FormatButton(
                      label: 'Story',
                      icon: CupertinoIcons.device_phone_portrait,
                      isSelected: _selectedFormat == ShareCardFormat.story,
                      onTap: () => setState(
                        () => _selectedFormat = ShareCardFormat.story,
                      ),
                    ),
                    const SizedBox(width: 12),
                    _FormatButton(
                      label: 'Post',
                      icon: CupertinoIcons.square,
                      isSelected: _selectedFormat == ShareCardFormat.square,
                      onTap: () => setState(
                        () => _selectedFormat = ShareCardFormat.square,
                      ),
                    ),
                  ],
                ),
              ),

              const SizedBox(height: 24),

              // Card preview
              Expanded(
                child: SingleChildScrollView(
                  controller: scrollController,
                  child: Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 20),
                    child: Center(
                      child: RepaintBoundary(
                        key: _cardKey,
                        child: PremiumShareCard(
                          amount: widget.amount,
                          hoursRequired: widget.hoursRequired,
                          category: widget.category,
                          date: widget.date,
                          currencySymbol: widget.currencySymbol,
                          format: _selectedFormat,
                          decision: widget.decision,
                        ),
                      ),
                    ),
                  ),
                ),
              ),

              // Share buttons - Row 1: Social platforms
              Padding(
                padding: const EdgeInsets.fromLTRB(20, 20, 20, 8),
                child: Row(
                  children: [
                    Expanded(
                      child: Semantics(
                        label: '${l10n.share} Instagram',
                        button: true,
                        child: _ShareButton(
                          label: 'Instagram',
                          icon: CupertinoIcons.camera,
                          color: AppColors.instagram,
                          onTap: () => _shareToInstagram(l10n),
                        ),
                      ),
                    ),
                    const SizedBox(width: 8),
                    Expanded(
                      child: Semantics(
                        label: '${l10n.share} TikTok',
                        button: true,
                        child: _ShareButton(
                          label: 'TikTok',
                          icon: CupertinoIcons.music_note,
                          color: Colors.white,
                          onTap: () => _shareToTikTok(l10n),
                        ),
                      ),
                    ),
                    const SizedBox(width: 8),
                    Expanded(
                      child: Semantics(
                        label: '${l10n.share} WhatsApp',
                        button: true,
                        child: _ShareButton(
                          label: 'WhatsApp',
                          icon: CupertinoIcons.chat_bubble_fill,
                          color: AppColors.whatsapp,
                          onTap: () => _shareToWhatsApp(l10n),
                        ),
                      ),
                    ),
                    const SizedBox(width: 8),
                    Expanded(
                      child: Semantics(
                        label: '${l10n.share} X',
                        button: true,
                        child: _ShareButton(
                          label: 'X',
                          icon: CupertinoIcons.at,
                          color: Colors.white,
                          onTap: () => _shareToTwitter(l10n),
                        ),
                      ),
                    ),
                  ],
                ),
              ),

              // Share buttons - Row 2: More options
              Padding(
                padding: const EdgeInsets.fromLTRB(20, 0, 20, 20),
                child: Row(
                  children: [
                    Expanded(
                      child: Semantics(
                        label: l10n.saveToGallery,
                        button: true,
                        child: _ShareButton(
                          label: l10n.saveToGallery,
                          icon: CupertinoIcons.arrow_down_to_line,
                          color: context.appColors.primary,
                          onTap: () => _saveToGallery(l10n),
                          isLoading: _isProcessing,
                        ),
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Semantics(
                        label: l10n.otherApps,
                        button: true,
                        child: _ShareButton(
                          label: l10n.otherApps,
                          icon: CupertinoIcons.share,
                          color: context.appColors.textSecondary,
                          onTap: () => _shareGeneric(l10n),
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        );
      },
    );
  }

  /// Capture card as image and return file path
  Future<String?> _captureCard() async {
    try {
      final boundary =
          _cardKey.currentContext?.findRenderObject() as RenderRepaintBoundary?;
      if (boundary == null) return null;

      final image = await boundary.toImage(pixelRatio: 3.0);
      final byteData = await image.toByteData(format: ImageByteFormat.png);
      if (byteData == null) return null;

      final pngBytes = byteData.buffer.asUint8List();
      final directory = await getTemporaryDirectory();
      final timestamp = DateTime.now().millisecondsSinceEpoch;
      final filePath = '${directory.path}/vantag_share_$timestamp.png';
      final file = File(filePath);
      await file.writeAsBytes(pngBytes);

      return filePath;
    } catch (_) {
      return null;
    }
  }

  /// Get share text with referral link
  Future<String> _getShareText() async {
    String shareText = 'Sen kaç saat çalışıyorsun? 👀 vantag.app';
    try {
      final referralCode = await ReferralService().getOrCreateReferralCode();
      if (referralCode != null) {
        final referralLink = DeepLinkService.generateReferralLink(referralCode);
        shareText = 'Sen kaç saat çalışıyorsun? 👀 $referralLink';
      }
    } catch (_) {
      // Use default text if referral fails
    }
    return shareText;
  }

  /// Share to Instagram Stories
  Future<void> _shareToInstagram(AppLocalizations l10n) async {
    if (_isProcessing) return;
    setState(() => _isProcessing = true);
    haptics.light();

    try {
      final filePath = await _captureCard();
      if (filePath == null) {
        _showError(l10n);
        return;
      }

      // Try to open Instagram Stories with image
      // Instagram Stories deep link format
      final instagramUrl = Uri.parse('instagram-stories://share');
      if (await canLaunchUrl(instagramUrl)) {
        // Save to gallery first, then user can share from there
        await ImageGallerySaverPlus.saveFile(filePath);
        await launchUrl(instagramUrl, mode: LaunchMode.externalApplication);
        haptics.success();
        if (mounted) Navigator.pop(context);
      } else {
        // Fallback to generic share
        await _shareGeneric(l10n);
      }
    } catch (_) {
      _showError(l10n);
    } finally {
      if (mounted) setState(() => _isProcessing = false);
    }
  }

  /// Share to TikTok
  Future<void> _shareToTikTok(AppLocalizations l10n) async {
    if (_isProcessing) return;
    setState(() => _isProcessing = true);
    haptics.light();

    try {
      final filePath = await _captureCard();
      if (filePath == null) {
        _showError(l10n);
        return;
      }

      // TikTok doesn't have a direct share API, save and open app
      final tiktokUrl = Uri.parse('tiktok://');
      if (await canLaunchUrl(tiktokUrl)) {
        await ImageGallerySaverPlus.saveFile(filePath);
        await launchUrl(tiktokUrl, mode: LaunchMode.externalApplication);
        haptics.success();
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text(l10n.savedToGallery),
              backgroundColor: context.appColors.success,
              behavior: SnackBarBehavior.floating,
            ),
          );
          Navigator.pop(context);
        }
      } else {
        await _shareGeneric(l10n);
      }
    } catch (_) {
      _showError(l10n);
    } finally {
      if (mounted) setState(() => _isProcessing = false);
    }
  }

  /// Share to WhatsApp
  Future<void> _shareToWhatsApp(AppLocalizations l10n) async {
    if (_isProcessing) return;
    setState(() => _isProcessing = true);
    haptics.light();

    try {
      final filePath = await _captureCard();
      if (filePath == null) {
        _showError(l10n);
        return;
      }

      final shareText = await _getShareText();
      final whatsappUrl = Uri.parse(
        'whatsapp://send?text=${Uri.encodeComponent(shareText)}',
      );

      if (await canLaunchUrl(whatsappUrl)) {
        // Share with image and text
        await Share.shareXFiles([XFile(filePath)], text: shareText);
        haptics.success();
        if (mounted) Navigator.pop(context);
      } else {
        await _shareGeneric(l10n);
      }
    } catch (_) {
      _showError(l10n);
    } finally {
      if (mounted) setState(() => _isProcessing = false);
    }
  }

  /// Share to Twitter/X
  Future<void> _shareToTwitter(AppLocalizations l10n) async {
    if (_isProcessing) return;
    setState(() => _isProcessing = true);
    haptics.light();

    try {
      final filePath = await _captureCard();
      if (filePath == null) {
        _showError(l10n);
        return;
      }

      final shareText = await _getShareText();

      // Use share_plus to share to Twitter
      await Share.shareXFiles([XFile(filePath)], text: shareText);
      haptics.success();
      if (mounted) Navigator.pop(context);
    } catch (_) {
      _showError(l10n);
    } finally {
      if (mounted) setState(() => _isProcessing = false);
    }
  }

  /// Save to gallery
  Future<void> _saveToGallery(AppLocalizations l10n) async {
    if (_isProcessing) return;
    setState(() => _isProcessing = true);
    haptics.light();

    try {
      final filePath = await _captureCard();
      if (filePath == null) {
        _showError(l10n);
        return;
      }

      final result = await ImageGallerySaverPlus.saveFile(filePath);

      if (result['isSuccess'] == true) {
        haptics.success();
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Row(
                children: [
                  Icon(
                    CupertinoIcons.checkmark_circle_fill,
                    color: Colors.white,
                    size: 20,
                  ),
                  const SizedBox(width: 12),
                  Text(l10n.savedToGallery),
                ],
              ),
              backgroundColor: context.appColors.success,
              behavior: SnackBarBehavior.floating,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(16),
              ),
            ),
          );
        }
      } else {
        _showError(l10n);
      }
    } catch (_) {
      _showError(l10n);
    } finally {
      if (mounted) setState(() => _isProcessing = false);
    }
  }

  /// Generic share (system share sheet)
  Future<void> _shareGeneric(AppLocalizations l10n) async {
    if (_isProcessing) return;
    setState(() => _isProcessing = true);
    haptics.light();

    try {
      final filePath = await _captureCard();
      if (filePath == null) {
        _showError(l10n);
        return;
      }

      final shareText = await _getShareText();
      await Share.shareXFiles([XFile(filePath)], text: shareText);
      haptics.success();
      if (mounted) Navigator.pop(context);
    } catch (_) {
      _showError(l10n);
    } finally {
      if (mounted) setState(() => _isProcessing = false);
    }
  }

  void _showError(AppLocalizations l10n) {
    haptics.error();
    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(l10n.shareError),
          backgroundColor: context.appColors.error,
          behavior: SnackBarBehavior.floating,
        ),
      );
    }
  }
}

class _FormatButton extends StatelessWidget {
  final String label;
  final IconData icon;
  final bool isSelected;
  final VoidCallback onTap;

  const _FormatButton({
    required this.label,
    required this.icon,
    required this.isSelected,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
        decoration: BoxDecoration(
          color: isSelected
              ? context.appColors.primary.withValues(alpha: 0.2)
              : Colors.white.withValues(alpha: 0.05),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: isSelected
                ? context.appColors.primary
                : Colors.white.withValues(alpha: 0.1),
            width: 1,
          ),
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(
              icon,
              size: 18,
              color: isSelected
                  ? context.appColors.primary
                  : Colors.white.withValues(alpha: 0.6),
            ),
            const SizedBox(width: 8),
            Text(
              label,
              style: TextStyle(
                fontSize: 14,
                fontWeight: isSelected ? FontWeight.w600 : FontWeight.w400,
                color: isSelected
                    ? context.appColors.primary
                    : Colors.white.withValues(alpha: 0.6),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

class _ShareButton extends StatelessWidget {
  final String label;
  final IconData icon;
  final Color color;
  final VoidCallback onTap;
  final bool isLoading;

  const _ShareButton({
    required this.label,
    required this.icon,
    required this.color,
    required this.onTap,
    this.isLoading = false,
  });

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: isLoading ? null : onTap,
      child: Container(
        padding: const EdgeInsets.symmetric(vertical: 14),
        decoration: BoxDecoration(
          color: color.withValues(alpha: 0.15),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: color.withValues(alpha: 0.3), width: 1),
        ),
        child: Column(
          children: [
            if (isLoading)
              SizedBox(
                width: 24,
                height: 24,
                child: CircularProgressIndicator(strokeWidth: 2, color: color),
              )
            else
              Icon(icon, size: 24, color: color),
            const SizedBox(height: 6),
            Text(
              label,
              style: TextStyle(
                fontSize: 11,
                fontWeight: FontWeight.w500,
                color: color,
              ),
              textAlign: TextAlign.center,
              maxLines: 1,
              overflow: TextOverflow.ellipsis,
            ),
          ],
        ),
      ),
    );
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// HABIT SHARE CARD - For Habit Calculator viral sharing
// ═══════════════════════════════════════════════════════════════════════════

/// Premium Habit Share Card Widget
/// Shows yearly work days cost for a habit
class HabitShareCard extends StatefulWidget {
  final IconData icon;
  final Color iconColor;
  final String categoryName;
  final int yearlyDays;
  final double? yearlyAmount;
  final String? frequency;
  final ShareCardFormat format;
  // Additional details for post mode
  final int? monthlyDays;
  final int? monthlyExtraHours;
  final double? monthlyAmount;
  final String? currencySymbol;

  const HabitShareCard({
    super.key,
    required this.icon,
    required this.iconColor,
    required this.categoryName,
    required this.yearlyDays,
    this.yearlyAmount,
    this.frequency,
    this.format = ShareCardFormat.story,
    this.monthlyDays,
    this.monthlyExtraHours,
    this.monthlyAmount,
    this.currencySymbol,
  });

  @override
  State<HabitShareCard> createState() => _HabitShareCardState();
}

class _HabitShareCardState extends State<HabitShareCard>
    with SingleTickerProviderStateMixin {
  late AnimationController _glowController;
  late Animation<double> _glowAnimation;

  @override
  void initState() {
    super.initState();
    _glowController = AnimationController(
      duration: const Duration(seconds: 3),
      vsync: this,
    )..repeat(reverse: true);

    _glowAnimation = Tween<double>(begin: 0.4, end: 0.8).animate(
      CurvedAnimation(parent: _glowController, curve: Curves.easeInOut),
    );
  }

  @override
  void dispose() {
    _glowController.dispose();
    super.dispose();
  }

  Size get _cardSize {
    switch (widget.format) {
      case ShareCardFormat.story:
        return const Size(360, 640);
      case ShareCardFormat.square:
        return const Size(400, 400); // Larger for better content fit
    }
  }

  @override
  Widget build(BuildContext context) {
    final size = _cardSize;

    return Container(
      width: size.width,
      height: size.height,
      decoration: BoxDecoration(borderRadius: BorderRadius.circular(24)),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(24),
        child: Stack(
          children: [
            // Background gradient
            _buildBackground(),

            // Noise texture overlay
            _buildNoiseOverlay(),

            // Ambient glow orb (uses habit color)
            _buildGlowOrb(),

            // Main content
            _buildContent(AppLocalizations.of(context)),

            // Vantag branding
            _buildBranding(),
          ],
        ),
      ),
    );
  }

  Widget _buildBackground() {
    return Container(
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            AppColors.background,
            AppColors.cardBackground,
            AppColors.background.withValues(alpha: 0.95),
          ],
          stops: const [0.0, 0.5, 1.0],
        ),
      ),
    );
  }

  Widget _buildNoiseOverlay() {
    return Opacity(
      opacity: 0.03,
      child: Container(
        decoration: const BoxDecoration(
          image: DecorationImage(
            image: AssetImage('assets/images/noise.png'),
            repeat: ImageRepeat.repeat,
          ),
        ),
      ),
    );
  }

  Widget _buildGlowOrb() {
    return AnimatedBuilder(
      animation: _glowAnimation,
      builder: (context, child) {
        return Positioned(
          top: widget.format == ShareCardFormat.story ? 120 : 40,
          left: 0,
          right: 0,
          child: Center(
            child: Container(
              width: 280,
              height: 280,
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                gradient: RadialGradient(
                  colors: [
                    widget.iconColor.withValues(
                      alpha: _glowAnimation.value * 0.4,
                    ),
                    widget.iconColor.withValues(
                      alpha: _glowAnimation.value * 0.2,
                    ),
                    widget.iconColor.withValues(alpha: 0.0),
                  ],
                  stops: const [0.0, 0.5, 1.0],
                ),
              ),
            ),
          ),
        );
      },
    );
  }

  Widget _buildContent(AppLocalizations l10n) {
    final isStory = widget.format == ShareCardFormat.story;

    if (!isStory) {
      // POST MODE - Compact layout with all details
      return _buildPostContent(l10n);
    }

    return Padding(
      padding: EdgeInsets.symmetric(
        horizontal: 24,
        vertical: isStory ? 60 : 32,
      ),
      child: Column(
        children: [
          if (isStory) const SizedBox(height: 40),

          // Category icon badge
          _buildCategoryBadge(),

          SizedBox(height: isStory ? 40 : 24),

          // Hero: Days display
          _buildHeroSection(l10n),

          SizedBox(height: isStory ? 32 : 20),

          // Info cards (amount + frequency)
          if (widget.yearlyAmount != null || widget.frequency != null)
            _buildInfoCards(l10n),

          if (isStory) ...[
            const Spacer(),

            // CTA Section
            _buildCTASection(l10n),

            const SizedBox(height: 24),
          ],
        ],
      ),
    );
  }

  /// Post mode content - compact square layout with all details
  Widget _buildPostContent(AppLocalizations l10n) {
    final symbol = widget.currencySymbol ?? '₺';

    return Padding(
      padding: const EdgeInsets.fromLTRB(20, 24, 20, 48),
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          // Category badge (compact)
          Row(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Container(
                width: 32,
                height: 32,
                decoration: BoxDecoration(
                  color: widget.iconColor.withValues(alpha: 0.2),
                  shape: BoxShape.circle,
                ),
                child: Icon(widget.icon, size: 18, color: widget.iconColor),
              ),
              const SizedBox(width: 8),
              Flexible(
                child: Text(
                  widget.categoryName,
                  style: const TextStyle(
                    fontSize: 14,
                    fontWeight: FontWeight.w600,
                    color: Colors.white,
                  ),
                  overflow: TextOverflow.ellipsis,
                ),
              ),
            ],
          ),

          const SizedBox(height: 16),

          // Hero number
          ShaderMask(
            shaderCallback: (bounds) {
              return LinearGradient(
                colors: [Colors.white, widget.iconColor.withValues(alpha: 0.9)],
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
              ).createShader(bounds);
            },
            child: Text(
              widget.yearlyDays.toString(),
              style: const TextStyle(
                fontSize: 72,
                fontWeight: FontWeight.w800,
                color: Colors.white,
                height: 1,
                letterSpacing: -3,
              ),
            ),
          ),

          // Work days label
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 6),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [
                  widget.iconColor.withValues(alpha: 0.3),
                  widget.iconColor.withValues(alpha: 0.1),
                ],
              ),
              borderRadius: BorderRadius.circular(16),
            ),
            child: Text(
              l10n.habitShareWorkDays,
              style: const TextStyle(
                fontSize: 12,
                fontWeight: FontWeight.w700,
                color: Colors.white,
                letterSpacing: 2,
              ),
            ),
          ),

          const SizedBox(height: 4),

          // "of work per year" text
          Text(
            l10n.habitSharePostText,
            style: TextStyle(
              fontSize: 11,
              color: Colors.white.withValues(alpha: 0.7),
            ),
            textAlign: TextAlign.center,
          ),

          const SizedBox(height: 12),

          // Details grid
          _buildPostDetailsGrid(l10n, symbol),
        ],
      ),
    );
  }

  /// Details grid for post mode
  Widget _buildPostDetailsGrid(AppLocalizations l10n, String symbol) {
    final details = <_DetailItem>[];

    // Monthly work time
    if (widget.monthlyDays != null) {
      final monthlyText =
          widget.monthlyExtraHours != null && widget.monthlyExtraHours! > 0
          ? '${widget.monthlyDays}d ${widget.monthlyExtraHours}h'
          : '${widget.monthlyDays} ${l10n.daysAbbrev}';
      details.add(
        _DetailItem(
          icon: CupertinoIcons.calendar,
          label: l10n.monthly,
          value: monthlyText,
        ),
      );
    }

    // Yearly amount
    if (widget.yearlyAmount != null) {
      details.add(
        _DetailItem(
          icon: CupertinoIcons.money_dollar_circle,
          label: l10n.yearly,
          value: '$symbol${_formatAmount(widget.yearlyAmount!)}',
        ),
      );
    }

    // Monthly amount
    if (widget.monthlyAmount != null) {
      details.add(
        _DetailItem(
          icon: CupertinoIcons.creditcard,
          label: l10n.monthly,
          value: '$symbol${_formatAmount(widget.monthlyAmount!)}',
        ),
      );
    }

    // Frequency
    if (widget.frequency != null) {
      details.add(
        _DetailItem(
          icon: CupertinoIcons.repeat,
          label: l10n.frequency,
          value: widget.frequency!,
        ),
      );
    }

    if (details.isEmpty) return const SizedBox.shrink();

    // Show 2x2 grid or single row depending on count
    if (details.length <= 2) {
      return Row(
        mainAxisAlignment: MainAxisAlignment.center,
        children: details
            .map(
              (d) => Padding(
                padding: const EdgeInsets.symmetric(horizontal: 8),
                child: _buildDetailChip(d),
              ),
            )
            .toList(),
      );
    }

    return Wrap(
      alignment: WrapAlignment.center,
      spacing: 8,
      runSpacing: 6,
      children: details.take(4).map((d) => _buildDetailChip(d)).toList(),
    );
  }

  Widget _buildDetailChip(_DetailItem item) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
      decoration: BoxDecoration(
        color: Colors.white.withValues(alpha: 0.08),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: Colors.white.withValues(alpha: 0.1)),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(item.icon, size: 14, color: Colors.white.withValues(alpha: 0.7)),
          const SizedBox(width: 6),
          Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            mainAxisSize: MainAxisSize.min,
            children: [
              Text(
                item.label,
                style: TextStyle(
                  fontSize: 9,
                  color: Colors.white.withValues(alpha: 0.5),
                ),
              ),
              Text(
                item.value,
                style: const TextStyle(
                  fontSize: 11,
                  fontWeight: FontWeight.w600,
                  color: Colors.white,
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildCategoryBadge() {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 12),
      decoration: BoxDecoration(
        color: Colors.white.withValues(alpha: 0.08),
        borderRadius: BorderRadius.circular(24),
        border: Border.all(
          color: Colors.white.withValues(alpha: 0.1),
          width: 1,
        ),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Container(
            width: 40,
            height: 40,
            decoration: BoxDecoration(
              color: widget.iconColor.withValues(alpha: 0.2),
              shape: BoxShape.circle,
            ),
            child: Icon(widget.icon, size: 22, color: widget.iconColor),
          ),
          const SizedBox(width: 12),
          Text(
            widget.categoryName,
            style: const TextStyle(
              fontSize: 18,
              fontWeight: FontWeight.w600,
              color: Colors.white,
              letterSpacing: 0.5,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildHeroSection(AppLocalizations l10n) {
    return Column(
      children: [
        // Pre-text
        Text(
          l10n.habitSharePreText,
          style: TextStyle(
            fontSize: 16,
            fontWeight: FontWeight.w400,
            color: Colors.white.withValues(alpha: 0.7),
            letterSpacing: 0.5,
          ),
        ),

        const SizedBox(height: 12),

        // Hero number with gradient
        ShaderMask(
          shaderCallback: (bounds) {
            return LinearGradient(
              colors: [
                Colors.white,
                widget.iconColor.withValues(alpha: 0.9),
                widget.iconColor,
              ],
              begin: Alignment.topCenter,
              end: Alignment.bottomCenter,
            ).createShader(bounds);
          },
          child: Text(
            widget.yearlyDays.toString(),
            style: TextStyle(
              fontSize: widget.format == ShareCardFormat.story ? 120 : 88,
              fontWeight: FontWeight.w800,
              color: Colors.white,
              height: 1,
              letterSpacing: -4,
            ),
          ),
        ),

        const SizedBox(height: 8),

        // Unit badge
        Container(
          padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 10),
          decoration: BoxDecoration(
            gradient: LinearGradient(
              colors: [
                widget.iconColor.withValues(alpha: 0.3),
                widget.iconColor.withValues(alpha: 0.1),
              ],
            ),
            borderRadius: BorderRadius.circular(24),
            border: Border.all(
              color: widget.iconColor.withValues(alpha: 0.4),
              width: 1,
            ),
          ),
          child: Text(
            l10n.habitShareWorkDays,
            style: const TextStyle(
              fontSize: 18,
              fontWeight: FontWeight.w700,
              color: Colors.white,
              letterSpacing: 4,
            ),
          ),
        ),

        const SizedBox(height: 12),

        // Post-text
        Text(
          l10n.habitSharePostText,
          style: TextStyle(
            fontSize: 16,
            fontWeight: FontWeight.w400,
            color: Colors.white.withValues(alpha: 0.7),
            letterSpacing: 0.5,
          ),
        ),
      ],
    );
  }

  Widget _buildInfoCards(AppLocalizations l10n) {
    return ClipRRect(
      borderRadius: BorderRadius.circular(16),
      child: BackdropFilter(
        filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
        child: Container(
          padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 14),
          decoration: BoxDecoration(
            color: Colors.white.withValues(alpha: 0.08),
            borderRadius: BorderRadius.circular(16),
            border: Border.all(
              color: Colors.white.withValues(alpha: 0.1),
              width: 1,
            ),
          ),
          child: Row(
            mainAxisSize: MainAxisSize.min,
            children: [
              if (widget.yearlyAmount != null) ...[
                Icon(
                  CupertinoIcons.money_dollar_circle,
                  size: 18,
                  color: Colors.white.withValues(alpha: 0.7),
                ),
                const SizedBox(width: 8),
                Text(
                  '₺${_formatAmount(widget.yearlyAmount!)}${l10n.habitSharePerYear}',
                  style: const TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.w600,
                    color: Colors.white,
                  ),
                ),
              ],
              if (widget.yearlyAmount != null && widget.frequency != null)
                Container(
                  margin: const EdgeInsets.symmetric(horizontal: 12),
                  width: 4,
                  height: 4,
                  decoration: BoxDecoration(
                    color: Colors.white.withValues(alpha: 0.4),
                    shape: BoxShape.circle,
                  ),
                ),
              if (widget.frequency != null) ...[
                Icon(
                  CupertinoIcons.calendar,
                  size: 18,
                  color: Colors.white.withValues(alpha: 0.7),
                ),
                const SizedBox(width: 8),
                Text(
                  widget.frequency!,
                  style: const TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.w600,
                    color: Colors.white,
                  ),
                ),
              ],
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildCTASection(AppLocalizations l10n) {
    return Column(
      children: [
        // Divider with glow
        Container(
          width: 120,
          height: 2,
          decoration: BoxDecoration(
            gradient: LinearGradient(
              colors: [
                Colors.transparent,
                widget.iconColor.withValues(alpha: 0.6),
                Colors.transparent,
              ],
            ),
            borderRadius: BorderRadius.circular(1),
          ),
        ),

        const SizedBox(height: 20),

        // CTA text
        Text(
          l10n.habitShareCTA,
          style: TextStyle(
            fontSize: 18,
            fontWeight: FontWeight.w600,
            color: Colors.white.withValues(alpha: 0.9),
          ),
        ),

        // Bottom spacing to prevent overlap with branding
        const SizedBox(height: 48),
      ],
    );
  }

  Widget _buildBranding() {
    return Positioned(
      bottom: widget.format == ShareCardFormat.story ? 20 : 16,
      left: 0,
      right: 0,
      child: Row(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Container(
            width: 24,
            height: 24,
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [
                  context.appColors.primary,
                  context.appColors.primaryLight,
                ],
              ),
              borderRadius: BorderRadius.circular(6),
            ),
            child: const Center(
              child: Text(
                'V',
                style: TextStyle(
                  fontSize: 14,
                  fontWeight: FontWeight.w800,
                  color: Colors.white,
                ),
              ),
            ),
          ),
          const SizedBox(width: 8),
          Text(
            'vantag.app',
            style: TextStyle(
              fontSize: 14,
              fontWeight: FontWeight.w500,
              color: Colors.white.withValues(alpha: 0.5),
              letterSpacing: 1,
            ),
          ),
        ],
      ),
    );
  }

  String _formatAmount(double amount) {
    if (amount >= 1000000) {
      return '${(amount / 1000000).toStringAsFixed(1)}M';
    } else if (amount >= 1000) {
      return '${(amount / 1000).toStringAsFixed(0)}K';
    }
    return amount.toStringAsFixed(0);
  }
}

/// Helper class for detail items in post mode
class _DetailItem {
  final IconData icon;
  final String label;
  final String value;

  const _DetailItem({
    required this.icon,
    required this.label,
    required this.value,
  });
}

/// Helper function to show habit share card preview
void showHabitShareCardPreview(
  BuildContext context, {
  required IconData icon,
  required Color iconColor,
  required String categoryName,
  required int yearlyDays,
  double? yearlyAmount,
  String? frequency,
  int? monthlyDays,
  int? monthlyExtraHours,
  double? monthlyAmount,
  String? currencySymbol,
}) {
  showModalBottomSheet(
    context: context,
    isScrollControlled: true,
    backgroundColor: Colors.transparent,
    barrierColor: Colors.black.withValues(alpha: 0.85),
    builder: (context) => _HabitShareCardPreviewSheet(
      icon: icon,
      iconColor: iconColor,
      categoryName: categoryName,
      yearlyDays: yearlyDays,
      yearlyAmount: yearlyAmount,
      frequency: frequency,
      monthlyDays: monthlyDays,
      monthlyExtraHours: monthlyExtraHours,
      monthlyAmount: monthlyAmount,
      currencySymbol: currencySymbol,
    ),
  );
}

class _HabitShareCardPreviewSheet extends StatefulWidget {
  final IconData icon;
  final Color iconColor;
  final String categoryName;
  final int yearlyDays;
  final double? yearlyAmount;
  final String? frequency;
  final int? monthlyDays;
  final int? monthlyExtraHours;
  final double? monthlyAmount;
  final String? currencySymbol;

  const _HabitShareCardPreviewSheet({
    required this.icon,
    required this.iconColor,
    required this.categoryName,
    required this.yearlyDays,
    this.yearlyAmount,
    this.frequency,
    this.monthlyDays,
    this.monthlyExtraHours,
    this.monthlyAmount,
    this.currencySymbol,
  });

  @override
  State<_HabitShareCardPreviewSheet> createState() =>
      _HabitShareCardPreviewSheetState();
}

class _HabitShareCardPreviewSheetState
    extends State<_HabitShareCardPreviewSheet> {
  ShareCardFormat _selectedFormat = ShareCardFormat.story;
  bool _showAmount = true;
  bool _showFrequency = true;
  final GlobalKey _cardKey = GlobalKey();
  bool _isSharing = false;

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return DraggableScrollableSheet(
      initialChildSize: 0.9,
      minChildSize: 0.5,
      maxChildSize: 0.95,
      builder: (context, scrollController) {
        return Container(
          decoration: BoxDecoration(
            color: context.appColors.background,
            borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
          ),
          child: Column(
            children: [
              // Handle
              Padding(
                padding: const EdgeInsets.only(top: 12, bottom: 8),
                child: Container(
                  width: 40,
                  height: 4,
                  decoration: BoxDecoration(
                    color: Colors.white.withValues(alpha: 0.2),
                    borderRadius: BorderRadius.circular(2),
                  ),
                ),
              ),

              // Header
              Padding(
                padding: const EdgeInsets.symmetric(
                  horizontal: 20,
                  vertical: 8,
                ),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Text(
                      l10n.shareResult,
                      style: const TextStyle(
                        fontSize: 20,
                        fontWeight: FontWeight.w700,
                        color: Colors.white,
                      ),
                    ),
                    Semantics(
                      label: l10n.accessibilityCloseSheet,
                      button: true,
                      child: IconButton(
                        onPressed: () => Navigator.pop(context),
                        tooltip: l10n.close,
                        icon: const Icon(
                          CupertinoIcons.xmark,
                          color: Colors.white,
                        ),
                      ),
                    ),
                  ],
                ),
              ),

              // Format selector
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 20),
                child: Row(
                  children: [
                    _FormatButton(
                      label: 'Story',
                      icon: CupertinoIcons.device_phone_portrait,
                      isSelected: _selectedFormat == ShareCardFormat.story,
                      onTap: () => setState(
                        () => _selectedFormat = ShareCardFormat.story,
                      ),
                    ),
                    const SizedBox(width: 12),
                    _FormatButton(
                      label: 'Post',
                      icon: CupertinoIcons.square,
                      isSelected: _selectedFormat == ShareCardFormat.square,
                      onTap: () => setState(
                        () => _selectedFormat = ShareCardFormat.square,
                      ),
                    ),
                  ],
                ),
              ),

              // Toggle options
              if (widget.yearlyAmount != null || widget.frequency != null)
                Padding(
                  padding: const EdgeInsets.fromLTRB(20, 16, 20, 0),
                  child: Row(
                    children: [
                      if (widget.yearlyAmount != null)
                        _ToggleChip(
                          label: l10n.amount,
                          isSelected: _showAmount,
                          onTap: () =>
                              setState(() => _showAmount = !_showAmount),
                        ),
                      if (widget.yearlyAmount != null &&
                          widget.frequency != null)
                        const SizedBox(width: 8),
                      if (widget.frequency != null)
                        _ToggleChip(
                          label: l10n.frequency,
                          isSelected: _showFrequency,
                          onTap: () =>
                              setState(() => _showFrequency = !_showFrequency),
                        ),
                    ],
                  ),
                ),

              const SizedBox(height: 16),

              // Card preview
              Expanded(
                child: SingleChildScrollView(
                  controller: scrollController,
                  child: Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 20),
                    child: Center(
                      child: RepaintBoundary(
                        key: _cardKey,
                        child: HabitShareCard(
                          icon: widget.icon,
                          iconColor: widget.iconColor,
                          categoryName: widget.categoryName,
                          yearlyDays: widget.yearlyDays,
                          yearlyAmount: _showAmount
                              ? widget.yearlyAmount
                              : null,
                          frequency: _showFrequency ? widget.frequency : null,
                          format: _selectedFormat,
                          monthlyDays: widget.monthlyDays,
                          monthlyExtraHours: widget.monthlyExtraHours,
                          monthlyAmount: widget.monthlyAmount,
                          currencySymbol: widget.currencySymbol,
                        ),
                      ),
                    ),
                  ),
                ),
              ),

              // Share button
              Padding(
                padding: const EdgeInsets.all(20),
                child: SizedBox(
                  width: double.infinity,
                  child: Container(
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        colors: [AppColors.primary, AppColors.premiumCyan],
                      ),
                      borderRadius: BorderRadius.circular(16),
                      boxShadow: [
                        BoxShadow(
                          color: AppColors.primary.withValues(alpha: 0.3),
                          blurRadius: 12,
                          offset: const Offset(0, 4),
                        ),
                      ],
                    ),
                    child: ElevatedButton.icon(
                      onPressed: _isSharing ? null : _shareCard,
                      icon: _isSharing
                          ? const SizedBox(
                              width: 20,
                              height: 20,
                              child: CircularProgressIndicator(
                                strokeWidth: 2,
                                color: Colors.white,
                              ),
                            )
                          : const Icon(CupertinoIcons.share_solid, size: 22),
                      label: Text(
                        _isSharing ? l10n.sharing : l10n.share,
                        style: const TextStyle(
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.transparent,
                        foregroundColor: Colors.white,
                        shadowColor: Colors.transparent,
                        padding: const EdgeInsets.symmetric(vertical: 18),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(16),
                        ),
                      ),
                    ),
                  ),
                ),
              ),
            ],
          ),
        );
      },
    );
  }

  Future<void> _shareCard() async {
    if (_isSharing) return;
    setState(() => _isSharing = true);

    try {
      // Import share service dynamically to avoid circular deps
      final boundary =
          _cardKey.currentContext?.findRenderObject() as RenderRepaintBoundary?;
      if (boundary == null) {
        setState(() => _isSharing = false);
        return;
      }

      final image = await boundary.toImage(pixelRatio: 3.0);
      final byteData = await image.toByteData(format: ImageByteFormat.png);
      if (byteData == null) {
        setState(() => _isSharing = false);
        return;
      }

      final pngBytes = byteData.buffer.asUint8List();
      final directory = await getTemporaryDirectory();
      final timestamp = DateTime.now().millisecondsSinceEpoch;
      final filePath = '${directory.path}/vantag_habit_$timestamp.png';
      final file = File(filePath);
      await file.writeAsBytes(pngBytes);

      // Get referral link for sharing
      final l10n = AppLocalizations.of(context);
      String shareText = l10n.habitShareText;
      try {
        final referralCode = await ReferralService().getOrCreateReferralCode();
        if (referralCode != null) {
          final referralLink = DeepLinkService.generateReferralLink(
            referralCode,
          );
          shareText = l10n.habitShareTextWithLink(referralLink.toString());
        }
      } catch (_) {
        // Use default text if referral fails
      }

      await Share.shareXFiles([XFile(filePath)], text: shareText);

      // Cleanup after 5 minutes
      Future.delayed(const Duration(minutes: 5), () {
        if (file.existsSync()) {
          try {
            file.deleteSync();
          } catch (_) {}
        }
      });

      if (mounted) {
        Navigator.pop(context);
      }
    } catch (_) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(AppLocalizations.of(context).shareError),
            backgroundColor: context.appColors.error,
          ),
        );
      }
    } finally {
      if (mounted) {
        setState(() => _isSharing = false);
      }
    }
  }
}

class _ToggleChip extends StatelessWidget {
  final String label;
  final bool isSelected;
  final VoidCallback onTap;

  const _ToggleChip({
    required this.label,
    required this.isSelected,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 8),
        decoration: BoxDecoration(
          color: isSelected
              ? context.appColors.primary.withValues(alpha: 0.2)
              : Colors.white.withValues(alpha: 0.05),
          borderRadius: BorderRadius.circular(24),
          border: Border.all(
            color: isSelected
                ? context.appColors.primary
                : Colors.white.withValues(alpha: 0.1),
            width: 1,
          ),
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(
              isSelected
                  ? CupertinoIcons.checkmark_circle_fill
                  : CupertinoIcons.circle,
              size: 16,
              color: isSelected
                  ? context.appColors.primary
                  : Colors.white.withValues(alpha: 0.5),
            ),
            const SizedBox(width: 6),
            Text(
              label,
              style: TextStyle(
                fontSize: 13,
                fontWeight: isSelected ? FontWeight.w600 : FontWeight.w400,
                color: isSelected
                    ? context.appColors.primary
                    : Colors.white.withValues(alpha: 0.6),
              ),
            ),
          ],
        ),
      ),
    );
  }
}


--- FILE: lib/widgets/login_prompt_card.dart ---

import 'dart:io';
import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../services/auth_service.dart';
import '../theme/theme.dart';

/// Login prompt card shown to users who haven't linked their account
/// Glassmorphism design with Google + Apple sign-in options
class LoginPromptCard extends StatefulWidget {
  final VoidCallback? onDismiss;
  final VoidCallback? onLoginSuccess;

  const LoginPromptCard({
    super.key,
    this.onDismiss,
    this.onLoginSuccess,
  });

  @override
  State<LoginPromptCard> createState() => _LoginPromptCardState();
}

class _LoginPromptCardState extends State<LoginPromptCard> {
  final _authService = AuthService();
  bool _isLoadingGoogle = false;
  bool _isLoadingApple = false;

  Future<void> _signInWithGoogle() async {
    if (_isLoadingGoogle || _isLoadingApple) return;

    setState(() => _isLoadingGoogle = true);
    HapticFeedback.mediumImpact();

    try {
      final result = await _authService.signInWithGoogle();

      if (!mounted) return;

      if (result.success) {
        final l10n = AppLocalizations.of(context);
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(l10n.googleLinkedSuccess),
            backgroundColor: context.appColors.success,
            behavior: SnackBarBehavior.floating,
          ),
        );
        widget.onLoginSuccess?.call();
      } else if (result.errorMessage != null &&
          result.errorMessage != 'Giriş iptal edildi') {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(result.errorMessage!),
            backgroundColor: context.appColors.error,
            behavior: SnackBarBehavior.floating,
          ),
        );
      }
    } finally {
      if (mounted) {
        setState(() => _isLoadingGoogle = false);
      }
    }
  }

  Future<void> _signInWithApple() async {
    if (_isLoadingGoogle || _isLoadingApple) return;

    setState(() => _isLoadingApple = true);
    HapticFeedback.mediumImpact();

    try {
      final result = await _authService.signInWithApple();

      if (!mounted) return;

      if (result.success) {
        final l10n = AppLocalizations.of(context);
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(l10n.appleLinkedSuccess),
            backgroundColor: context.appColors.success,
            behavior: SnackBarBehavior.floating,
          ),
        );
        widget.onLoginSuccess?.call();
      } else if (result.errorMessage != null &&
          result.errorMessage != 'Giriş iptal edildi') {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(result.errorMessage!),
            backgroundColor: context.appColors.error,
            behavior: SnackBarBehavior.floating,
          ),
        );
      }
    } finally {
      if (mounted) {
        setState(() => _isLoadingApple = false);
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final showApple = Platform.isIOS;

    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(24),
        child: BackdropFilter(
          filter: ImageFilter.blur(sigmaX: 20, sigmaY: 20),
          child: Container(
            padding: const EdgeInsets.all(20),
            decoration: BoxDecoration(
              color: context.appColors.surface.withValues(alpha: 0.8),
              borderRadius: BorderRadius.circular(24),
              border: Border.all(
                color: context.appColors.primary.withValues(alpha: 0.3),
                width: 1,
              ),
              boxShadow: [
                BoxShadow(
                  color: context.appColors.primary.withValues(alpha: 0.1),
                  blurRadius: 20,
                  offset: const Offset(0, 4),
                ),
              ],
            ),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                // Icons row
                Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    // Google icon
                    Container(
                      width: 48,
                      height: 48,
                      decoration: BoxDecoration(
                        color: context.appColors.surfaceLight,
                        borderRadius: BorderRadius.circular(16),
                      ),
                      child: Center(
                        child: Image.asset(
                          'assets/icons/google_icon.png',
                          width: 24,
                          height: 24,
                          errorBuilder: (_, __, ___) => Icon(
                            CupertinoIcons.globe,
                            size: 24,
                            color: context.appColors.textPrimary,
                          ),
                        ),
                      ),
                    ),
                    if (showApple) ...[
                      const SizedBox(width: 12),
                      // Apple icon
                      Container(
                        width: 48,
                        height: 48,
                        decoration: BoxDecoration(
                          color: context.appColors.surfaceLight,
                          borderRadius: BorderRadius.circular(16),
                        ),
                        child: Center(
                          child: Icon(
                            Icons.apple,
                            size: 24,
                            color: context.appColors.textPrimary,
                          ),
                        ),
                      ),
                    ],
                  ],
                ),

                const SizedBox(height: 16),

                // Title
                Text(
                  l10n.loginPromptTitle,
                  style: TextStyle(
                    fontSize: 18,
                    fontWeight: FontWeight.w700,
                    color: context.appColors.textPrimary,
                  ),
                ),

                const SizedBox(height: 8),

                // Subtitle
                Text(
                  l10n.loginPromptSubtitle,
                  textAlign: TextAlign.center,
                  style: TextStyle(
                    fontSize: 14,
                    color: context.appColors.textSecondary,
                  ),
                ),

                const SizedBox(height: 20),

                // Buttons row
                Row(
                  children: [
                    // Google button
                    Expanded(
                      child: _buildLoginButton(
                        onTap: _signInWithGoogle,
                        isLoading: _isLoadingGoogle,
                        icon: CupertinoIcons.globe,
                        label: l10n.linkWithGoogle,
                        isPrimary: true,
                      ),
                    ),
                    if (showApple) ...[
                      const SizedBox(width: 12),
                      // Apple button
                      Expanded(
                        child: _buildLoginButton(
                          onTap: _signInWithApple,
                          isLoading: _isLoadingApple,
                          icon: Icons.apple,
                          label: l10n.linkWithApple,
                          isPrimary: false,
                        ),
                      ),
                    ],
                  ],
                ),

                const SizedBox(height: 12),

                // Dismiss link
                TextButton(
                  onPressed: widget.onDismiss,
                  style: TextButton.styleFrom(
                    foregroundColor: context.appColors.textTertiary,
                    padding: const EdgeInsets.symmetric(
                      horizontal: 16,
                      vertical: 8,
                    ),
                  ),
                  child: Text(
                    l10n.loginPromptLater,
                    style: const TextStyle(
                      fontSize: 14,
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildLoginButton({
    required VoidCallback onTap,
    required bool isLoading,
    required IconData icon,
    required String label,
    required bool isPrimary,
  }) {
    return Semantics(
      button: true,
      label: label,
      child: GestureDetector(
        onTap: isLoading ? null : onTap,
        child: Container(
          height: 48,
          decoration: BoxDecoration(
            color: isPrimary
                ? context.appColors.primary
                : context.appColors.surfaceLight,
            borderRadius: BorderRadius.circular(16),
            border: isPrimary
                ? null
                : Border.all(color: context.appColors.cardBorder),
          ),
          child: Center(
            child: isLoading
                ? SizedBox(
                    width: 20,
                    height: 20,
                    child: CircularProgressIndicator(
                      strokeWidth: 2,
                      color: isPrimary
                          ? context.appColors.textPrimary
                          : context.appColors.primary,
                    ),
                  )
                : Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(
                        icon,
                        size: 18,
                        color: isPrimary
                            ? context.appColors.textPrimary
                            : context.appColors.textPrimary,
                      ),
                      const SizedBox(width: 8),
                      Flexible(
                        child: Text(
                          label,
                          overflow: TextOverflow.ellipsis,
                          style: TextStyle(
                            fontSize: 13,
                            fontWeight: FontWeight.w600,
                            color: isPrimary
                                ? context.appColors.textPrimary
                                : context.appColors.textPrimary,
                          ),
                        ),
                      ),
                    ],
                  ),
          ),
        ),
      ),
    );
  }
}


--- FILE: lib/widgets/premium_fintech_dashboard.dart ---

import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../providers/currency_provider.dart';
import '../theme/theme.dart';
import '../utils/currency_utils.dart';
import 'package:vantag/l10n/app_localizations.dart';

/// Premium Fintech Dashboard Components
/// Beyond, Revolut, N26 dark mode style

/// Premium Balance Card - Kredi kartı görünümünde, neon glow efektli
class PremiumBalanceCard extends StatefulWidget {
  final double netBalance;
  final double totalIncome;
  final double totalSpent;
  final double savedAmount;
  final int savedCount;
  final int incomeSourceCount;
  final VoidCallback? onTap;

  const PremiumBalanceCard({
    super.key,
    required this.netBalance,
    required this.totalIncome,
    required this.totalSpent,
    this.savedAmount = 0,
    this.savedCount = 0,
    this.incomeSourceCount = 1,
    this.onTap,
  });

  @override
  State<PremiumBalanceCard> createState() => _PremiumBalanceCardState();
}

class _PremiumBalanceCardState extends State<PremiumBalanceCard>
    with SingleTickerProviderStateMixin {
  late AnimationController _countController;
  late Animation<double> _countAnimation;
  double _displayedBalance = 0;
  double _displayedIncome = 0;
  double _displayedSpent = 0;

  @override
  void initState() {
    super.initState();
    _countController = AnimationController(
      duration: const Duration(milliseconds: 1500),
      vsync: this,
    );
    _countAnimation = CurvedAnimation(
      parent: _countController,
      curve: Curves.easeOutCubic,
    );

    _countController.addListener(() {
      setState(() {
        _displayedBalance = widget.netBalance * _countAnimation.value;
        _displayedIncome = widget.totalIncome * _countAnimation.value;
        _displayedSpent = widget.totalSpent * _countAnimation.value;
      });
    });

    _countController.forward();
  }

  @override
  void didUpdateWidget(PremiumBalanceCard oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (oldWidget.netBalance != widget.netBalance ||
        oldWidget.totalIncome != widget.totalIncome ||
        oldWidget.totalSpent != widget.totalSpent) {
      _countController.forward(from: 0);
    }
  }

  @override
  void dispose() {
    _countController.dispose();
    super.dispose();
  }

  double get spentPercent => widget.totalIncome > 0
      ? (widget.totalSpent / widget.totalIncome).clamp(0, 1)
      : 0;

  bool get isHealthy => widget.netBalance >= 0;

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final currencyProvider = context.watch<CurrencyProvider>();

    return GestureDetector(
      onTap: widget.onTap,
      child: Container(
        margin: const EdgeInsets.symmetric(horizontal: 20),
        padding: const EdgeInsets.all(24),
        decoration: BoxDecoration(
          color: context.appColors.surface,
          borderRadius: BorderRadius.circular(24),
          border: Border.all(
            color: Colors.white.withValues(alpha: 0.06),
            width: 1,
          ),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withValues(alpha: 0.2),
              blurRadius: 20,
              offset: const Offset(0, 10),
            ),
          ],
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Üst kısım: Net Bakiye label - Revolut minimal style
            Text(
              l10n.netBalance.toUpperCase(),
              style: TextStyle(
                fontSize: 13,
                fontWeight: FontWeight.w600,
                letterSpacing: 1.2,
                color: context.appColors.textSecondary,
              ),
            ),

            const SizedBox(height: 12),

            // BÜYÜK RAKAM - Counting animation ile (Revolut style)
            Row(
              crossAxisAlignment: CrossAxisAlignment.end,
              children: [
                Text(
                  formatTurkishCurrency(
                    _displayedBalance,
                    decimalDigits: 0,
                    showDecimals: false,
                  ),
                  style: TextStyle(
                    fontSize: 48,
                    fontWeight: FontWeight.w700,
                    letterSpacing: -1.5,
                    color: isHealthy ? Colors.white : context.appColors.error,
                    height: 1,
                  ),
                ),
                Padding(
                  padding: const EdgeInsets.only(bottom: 6, left: 4),
                  child: Text(
                    currencyProvider.symbol,
                    style: TextStyle(
                      fontSize: 18,
                      fontWeight: FontWeight.w500,
                      color: context.appColors.textTertiary,
                    ),
                  ),
                ),
              ],
            ),

            const SizedBox(height: 20),

            // Progress bar
            Container(
              height: 4,
              decoration: BoxDecoration(
                color: AppColors.cardBackground,
                borderRadius: BorderRadius.circular(2),
              ),
              child: LayoutBuilder(
                builder: (context, constraints) {
                  return Stack(
                    children: [
                      AnimatedContainer(
                        duration: const Duration(milliseconds: 800),
                        curve: Curves.easeOutCubic,
                        width: constraints.maxWidth * spentPercent,
                        height: 4,
                        decoration: BoxDecoration(
                          gradient: AppGradients.primaryButton,
                          borderRadius: BorderRadius.circular(2),
                        ),
                      ),
                    ],
                  );
                },
              ),
            ),

            const SizedBox(height: 8),

            // Budget text
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text(
                  l10n.budgetUsage,
                  style: TextStyle(
                    fontSize: 10,
                    letterSpacing: 1,
                    fontWeight: FontWeight.w500,
                    color: context.appColors.textTertiary,
                  ),
                ),
                Text(
                  "${formatTurkishCurrency(_displayedSpent, decimalDigits: 0, showDecimals: false)} / ${formatTurkishCurrency(widget.totalIncome, decimalDigits: 0, showDecimals: false)}",
                  style: TextStyle(
                    fontSize: 12,
                    color: context.appColors.textSecondary,
                  ),
                ),
              ],
            ),

            const SizedBox(height: 24),

            // Income ve Expense kartları
            Row(
              children: [
                Expanded(
                  child: _StatCard(
                    icon: CupertinoIcons.arrow_down,
                    label: l10n.income,
                    value: formatTurkishCurrency(
                      _displayedIncome,
                      decimalDigits: 0,
                      showDecimals: false,
                    ),
                    color: context.appColors.success,
                  ),
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: _StatCard(
                    icon: CupertinoIcons.arrow_up,
                    label: l10n.expense,
                    value: formatTurkishCurrency(
                      _displayedSpent,
                      decimalDigits: 0,
                      showDecimals: false,
                    ),
                    color: context.appColors.error,
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}

/// Stat Card (Income/Expense)
class _StatCard extends StatelessWidget {
  final IconData icon;
  final String label;
  final String value;
  final Color color;

  const _StatCard({
    required this.icon,
    required this.label,
    required this.value,
    required this.color,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: color.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: color.withValues(alpha: 0.2)),
      ),
      child: Column(
        children: [
          Container(
            width: 40,
            height: 40,
            decoration: BoxDecoration(
              color: color.withValues(alpha: 0.15),
              shape: BoxShape.circle,
            ),
            child: Icon(icon, size: 20, color: color),
          ),
          const SizedBox(height: 8),
          Text(
            label,
            style: TextStyle(
              fontSize: 10,
              letterSpacing: 1,
              fontWeight: FontWeight.w500,
              color: context.appColors.textTertiary,
            ),
          ),
          const SizedBox(height: 4),
          Text(
            value,
            style: TextStyle(
              fontSize: 18,
              fontWeight: FontWeight.w600,
              color: context.appColors.textPrimary,
            ),
          ),
        ],
      ),
    );
  }
}

/// Premium Currency Band
class PremiumCurrencyBand extends StatelessWidget {
  final String? usdRate;
  final String? eurRate;
  final String? goldRate;
  final bool usdUp;
  final bool eurUp;
  final bool goldUp;

  const PremiumCurrencyBand({
    super.key,
    this.usdRate,
    this.eurRate,
    this.goldRate,
    this.usdUp = true,
    this.eurUp = false,
    this.goldUp = true,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      margin: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: context.appColors.cardBorder),
      ),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceAround,
        children: [
          _CurrencyItem(symbol: "USD", value: usdRate ?? "-", isUp: usdUp),
          _Divider(),
          _CurrencyItem(symbol: "EUR", value: eurRate ?? "-", isUp: eurUp),
          _Divider(),
          _CurrencyItem(symbol: "Altın", value: goldRate ?? "-", isUp: goldUp),
        ],
      ),
    );
  }
}

class _CurrencyItem extends StatelessWidget {
  final String symbol;
  final String value;
  final bool isUp;

  const _CurrencyItem({
    required this.symbol,
    required this.value,
    required this.isUp,
  });

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        Text(
          symbol,
          style: TextStyle(
            fontSize: 11,
            fontWeight: FontWeight.w500,
            color: context.appColors.textTertiary,
          ),
        ),
        const SizedBox(height: 4),
        Row(
          children: [
            Text(
              value,
              style: TextStyle(
                fontSize: 14,
                fontWeight: FontWeight.w600,
                color: context.appColors.textPrimary,
              ),
            ),
            const SizedBox(width: 4),
            Text(
              isUp ? "↑" : "↓",
              style: TextStyle(
                fontSize: 12,
                color: isUp
                    ? context.appColors.success
                    : context.appColors.error,
              ),
            ),
          ],
        ),
      ],
    );
  }
}

class _Divider extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Container(width: 1, height: 30, color: context.appColors.cardBorder);
  }
}

/// Premium Section Title
class PremiumSectionHeader extends StatelessWidget {
  final String title;
  final String? actionText;
  final VoidCallback? onActionTap;

  const PremiumSectionHeader({
    super.key,
    required this.title,
    this.actionText,
    this.onActionTap,
  });

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Row(
            children: [
              Container(
                width: 4,
                height: 20,
                decoration: BoxDecoration(
                  gradient: AppGradients.primaryButton,
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
              const SizedBox(width: 10),
              Text(
                title,
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textPrimary,
                ),
              ),
            ],
          ),
          if (actionText != null)
            GestureDetector(
              onTap: onActionTap,
              child: Text(
                actionText!,
                style: TextStyle(
                  fontSize: 13,
                  fontWeight: FontWeight.w500,
                  color: context.appColors.primary,
                ),
              ),
            ),
        ],
      ),
    );
  }
}

/// Premium Transaction Item
class PremiumTransactionItem extends StatelessWidget {
  final String storeName;
  final String category;
  final double amount;
  final String time;
  final IconData categoryIcon;
  final Color categoryColor;
  final bool isExpense;
  final VoidCallback? onTap;

  const PremiumTransactionItem({
    super.key,
    required this.storeName,
    required this.category,
    required this.amount,
    required this.time,
    required this.categoryIcon,
    required this.categoryColor,
    this.isExpense = true,
    this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        margin: const EdgeInsets.symmetric(horizontal: 20, vertical: 6),
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: context.appColors.surface,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: context.appColors.cardBorder),
        ),
        child: Row(
          children: [
            // Mağaza ikonu
            Container(
              width: 48,
              height: 48,
              decoration: BoxDecoration(
                color: categoryColor.withValues(alpha: 0.15),
                borderRadius: BorderRadius.circular(16),
              ),
              child: Icon(categoryIcon, size: 24, color: categoryColor),
            ),
            const SizedBox(width: 14),
            // İsim ve kategori
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    storeName,
                    style: TextStyle(
                      fontSize: 15,
                      fontWeight: FontWeight.w500,
                      color: context.appColors.textPrimary,
                    ),
                  ),
                  const SizedBox(height: 2),
                  Text(
                    category,
                    style: TextStyle(
                      fontSize: 12,
                      color: context.appColors.textTertiary,
                    ),
                  ),
                ],
              ),
            ),
            // Tutar ve saat
            Column(
              crossAxisAlignment: CrossAxisAlignment.end,
              children: [
                Text(
                  "${isExpense ? '-' : '+'}${formatTurkishCurrency(amount, decimalDigits: 0, showDecimals: false)}",
                  style: TextStyle(
                    fontSize: 15,
                    fontWeight: FontWeight.w600,
                    color: isExpense
                        ? context.appColors.error
                        : context.appColors.success,
                  ),
                ),
                const SizedBox(height: 2),
                Text(
                  time,
                  style: TextStyle(
                    fontSize: 11,
                    color: context.appColors.textTertiary,
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}

/// Premium Header with Profile Photo
class PremiumHeader extends StatelessWidget {
  final String greeting;
  final String title;
  final String? photoPath;
  final VoidCallback? onSettingsTap;
  final Widget? trailing;

  const PremiumHeader({
    super.key,
    required this.greeting,
    required this.title,
    this.photoPath,
    this.onSettingsTap,
    this.trailing,
  });

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.fromLTRB(20, 16, 20, 0),
      child: Row(
        children: [
          // Profil fotoğrafı
          Container(
            width: 48,
            height: 48,
            decoration: BoxDecoration(
              shape: BoxShape.circle,
              border: Border.all(color: context.appColors.primary, width: 2),
              boxShadow: [
                BoxShadow(
                  color: context.appColors.primary.withValues(alpha: 0.3),
                  blurRadius: 12,
                  spreadRadius: 2,
                ),
              ],
            ),
            child: ClipOval(
              child: photoPath != null
                  ? Image.asset(photoPath!, fit: BoxFit.cover)
                  : Container(
                      color: context.appColors.surfaceLight,
                      child: Icon(
                        CupertinoIcons.person,
                        size: 24,
                        color: context.appColors.textSecondary,
                      ),
                    ),
            ),
          ),
          const SizedBox(width: 12),
          // Selamlama
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  "$greeting 👋",
                  style: TextStyle(
                    fontSize: 14,
                    color: context.appColors.textSecondary,
                  ),
                ),
                Text(
                  title,
                  style: TextStyle(
                    fontSize: 22,
                    fontWeight: FontWeight.w700,
                    color: context.appColors.textPrimary,
                  ),
                ),
              ],
            ),
          ),
          // Trailing widgets
          if (trailing != null) trailing!,
          // Ayarlar butonu
          if (onSettingsTap != null)
            _GlassButton(
              icon: CupertinoIcons.settings,
              onTap: onSettingsTap!,
            ),
        ],
      ),
    );
  }
}

/// Glass Button
class _GlassButton extends StatelessWidget {
  final IconData icon;
  final VoidCallback onTap;

  const _GlassButton({required this.icon, required this.onTap});

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: ClipRRect(
        borderRadius: BorderRadius.circular(16),
        child: BackdropFilter(
          filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
          child: Container(
            width: 44,
            height: 44,
            decoration: BoxDecoration(
              color: context.appColors.surfaceLight.withValues(alpha: 0.5),
              borderRadius: BorderRadius.circular(16),
              border: Border.all(color: context.appColors.cardBorder),
            ),
            child: Icon(
              icon,
              size: 20,
              color: context.appColors.textSecondary,
            ),
          ),
        ),
      ),
    );
  }
}

/// Premium Floating Bottom Navigation Bar
class PremiumFloatingNavBar extends StatelessWidget {
  final int selectedIndex;
  final ValueChanged<int> onItemSelected;
  final VoidCallback onAddPressed;

  const PremiumFloatingNavBar({
    super.key,
    required this.selectedIndex,
    required this.onItemSelected,
    required this.onAddPressed,
  });

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return Positioned(
      left: 20,
      right: 20,
      bottom: 24,
      child: ClipRRect(
        borderRadius: BorderRadius.circular(28),
        child: BackdropFilter(
          filter: ImageFilter.blur(sigmaX: 20, sigmaY: 20),
          child: Container(
            height: 72,
            decoration: BoxDecoration(
              color: context.appColors.surface.withValues(alpha: 0.9),
              borderRadius: BorderRadius.circular(28),
              border: Border.all(
                color: context.appColors.primary.withValues(alpha: 0.2),
              ),
              boxShadow: [
                BoxShadow(
                  color: context.appColors.primary.withValues(alpha: 0.15),
                  blurRadius: 30,
                  offset: const Offset(0, -5),
                ),
              ],
            ),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceEvenly,
              children: [
                _NavItem(
                  icon: CupertinoIcons.house,
                  label: l10n.dashboard,
                  isSelected: selectedIndex == 0,
                  onTap: () => onItemSelected(0),
                ),
                _NavItem(
                  icon: CupertinoIcons.chart_bar,
                  label: l10n.navReports,
                  isSelected: selectedIndex == 1,
                  onTap: () => onItemSelected(1),
                ),
                // Ortadaki FAB
                GestureDetector(
                  onTap: onAddPressed,
                  child: Container(
                    width: 56,
                    height: 56,
                    decoration: BoxDecoration(
                      gradient: AppGradients.primaryButton,
                      shape: BoxShape.circle,
                      boxShadow: [
                        BoxShadow(
                          color: context.appColors.primary.withValues(
                            alpha: 0.4,
                          ),
                          blurRadius: 20,
                          offset: const Offset(0, 5),
                        ),
                      ],
                    ),
                    child: const Icon(
                      CupertinoIcons.plus,
                      color: Colors.white,
                      size: 28,
                    ),
                  ),
                ),
                _NavItem(
                  icon: CupertinoIcons.rosette,
                  label: l10n.navAchievements,
                  isSelected: selectedIndex == 2,
                  onTap: () => onItemSelected(2),
                ),
                _NavItem(
                  icon: CupertinoIcons.person,
                  label: l10n.navProfile,
                  isSelected: selectedIndex == 3,
                  onTap: () => onItemSelected(3),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

class _NavItem extends StatelessWidget {
  final IconData icon;
  final String label;
  final bool isSelected;
  final VoidCallback onTap;

  const _NavItem({
    required this.icon,
    required this.label,
    required this.isSelected,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      behavior: HitTestBehavior.opaque,
      child: SizedBox(
        width: 56,
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(
              icon,
              size: 24,
              color: isSelected
                  ? context.appColors.primary
                  : context.appColors.textTertiary,
            ),
            const SizedBox(height: 4),
            Text(
              label,
              style: TextStyle(
                fontSize: 10,
                fontWeight: isSelected ? FontWeight.w600 : FontWeight.w500,
                color: isSelected
                    ? context.appColors.primary
                    : context.appColors.textTertiary,
              ),
            ),
            if (isSelected)
              Container(
                margin: const EdgeInsets.only(top: 4),
                width: 4,
                height: 4,
                decoration: BoxDecoration(
                  color: context.appColors.primary,
                  shape: BoxShape.circle,
                  boxShadow: [
                    BoxShadow(
                      color: context.appColors.primary.withValues(alpha: 0.5),
                      blurRadius: 6,
                    ),
                  ],
                ),
              )
            else
              const SizedBox(height: 8),
          ],
        ),
      ),
    );
  }
}


--- FILE: lib/widgets/whats_new_dialog.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../theme/theme.dart';

/// Dialog to show what's new in the app
class WhatsNewDialog extends StatelessWidget {
  final String version;
  final List<String> changes;

  const WhatsNewDialog({
    super.key,
    required this.version,
    required this.changes,
  });

  static const String _lastSeenVersionKey = 'last_seen_whats_new_version';
  static const String _currentVersion = '1.0.3';

  /// Check if we should show what's new dialog
  static Future<bool> shouldShow() async {
    final prefs = await SharedPreferences.getInstance();
    final lastSeenVersion = prefs.getString(_lastSeenVersionKey);
    return lastSeenVersion != _currentVersion;
  }

  /// Mark the current version as seen
  static Future<void> markAsSeen() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(_lastSeenVersionKey, _currentVersion);
  }

  /// Show the dialog if needed
  static Future<void> showIfNeeded(BuildContext context) async {
    if (!await shouldShow()) return;

    final locale = Localizations.localeOf(context).languageCode;

    final changes = locale == 'tr'
        ? [
            'AI artık seçtiğiniz dilde cevap veriyor',
            'Performans iyileştirmeleri',
            'Hata düzeltmeleri',
          ]
        : [
            'AI now responds in your selected language',
            'Performance improvements',
            'Bug fixes',
          ];

    if (!context.mounted) return;

    await showDialog(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      builder: (context) => WhatsNewDialog(
        version: _currentVersion,
        changes: changes,
      ),
    );

    await markAsSeen();
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return Dialog(
      backgroundColor: context.appColors.surface,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(24)),
      child: Padding(
        padding: const EdgeInsets.all(24),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            // Icon
            Container(
              width: 60,
              height: 60,
              decoration: BoxDecoration(
                color: context.appColors.primary.withValues(alpha: 0.15),
                shape: BoxShape.circle,
              ),
              child: Icon(
                CupertinoIcons.sparkles,
                size: 32,
                color: context.appColors.primary,
              ),
            ),

            const SizedBox(height: 16),

            // Title
            Text(
              l10n.whatsNewInVersion(version),
              style: TextStyle(
                fontSize: 20,
                fontWeight: FontWeight.bold,
                color: context.appColors.textPrimary,
              ),
            ),

            const SizedBox(height: 20),

            // Changes list
            ...changes.map((change) => Padding(
                  padding: const EdgeInsets.only(bottom: 12),
                  child: Row(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Icon(
                        CupertinoIcons.checkmark_circle,
                        size: 20,
                        color: context.appColors.success,
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: Text(
                          change,
                          style: TextStyle(
                            fontSize: 14,
                            color: context.appColors.textSecondary,
                          ),
                        ),
                      ),
                    ],
                  ),
                )),

            const SizedBox(height: 20),

            // Button
            SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                onPressed: () => Navigator.pop(context),
                style: ElevatedButton.styleFrom(
                  backgroundColor: context.appColors.primary,
                  foregroundColor: Colors.white,
                  padding: const EdgeInsets.symmetric(vertical: 14),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(16),
                  ),
                ),
                child: Text(
                  l10n.gotIt,
                  style: const TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}


--- FILE: lib/widgets/category_budget_card.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/category_budget.dart';
import '../models/expense.dart';
import '../providers/currency_provider.dart';
import '../theme/theme.dart';
import '../utils/currency_utils.dart';
import 'create_budget_sheet.dart';

/// Card showing budget progress for a single category
class CategoryBudgetCard extends StatefulWidget {
  final CategoryBudgetWithSpent budget;
  final VoidCallback? onTap;
  final int animationIndex;

  const CategoryBudgetCard({
    super.key,
    required this.budget,
    this.onTap,
    this.animationIndex = 0,
  });

  @override
  State<CategoryBudgetCard> createState() => _CategoryBudgetCardState();
}

class _CategoryBudgetCardState extends State<CategoryBudgetCard>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _slideAnimation;
  late Animation<double> _fadeAnimation;
  late Animation<double> _progressAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      duration: const Duration(milliseconds: 500),
      vsync: this,
    );

    _slideAnimation = Tween<double>(
      begin: 30,
      end: 0,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeOutCubic));

    _fadeAnimation = Tween<double>(
      begin: 0,
      end: 1,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeOutCubic));

    _progressAnimation =
        Tween<double>(
          begin: 0,
          end: widget.budget.percentUsedClamped / 100,
        ).animate(
          CurvedAnimation(
            parent: _controller,
            curve: const Interval(0.3, 1.0, curve: Curves.easeOutCubic),
          ),
        );

    // Staggered delay
    Future.delayed(Duration(milliseconds: 80 * widget.animationIndex), () {
      if (mounted) _controller.forward();
    });
  }

  @override
  void didUpdateWidget(CategoryBudgetCard oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (oldWidget.budget.percentUsed != widget.budget.percentUsed) {
      _progressAnimation =
          Tween<double>(
            begin: _progressAnimation.value,
            end: widget.budget.percentUsedClamped / 100,
          ).animate(
            CurvedAnimation(parent: _controller, curve: Curves.easeOutCubic),
          );
      _controller.forward(from: 0);
    }
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  Color _getProgressColor() {
    final percent = widget.budget.percentUsed;
    if (percent >= 100) return context.appColors.error;
    if (percent >= 80) return context.appColors.warning;
    if (percent >= 50) return Colors.amber;
    return context.appColors.success;
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final currencyProvider = context.watch<CurrencyProvider>();
    final budget = widget.budget;

    final spentConverted = currencyProvider.convertFromTRY(budget.spent);
    final limitConverted = currencyProvider.convertFromTRY(
      budget.budget.monthlyLimit,
    );
    final remainingConverted = currencyProvider.convertFromTRY(
      budget.remaining.abs(),
    );

    final progressColor = _getProgressColor();

    return AnimatedBuilder(
      animation: _controller,
      builder: (context, child) {
        return Transform.translate(
          offset: Offset(0, _slideAnimation.value),
          child: Opacity(
            opacity: _fadeAnimation.value,
            child: GestureDetector(
              onTap: () {
                HapticFeedback.lightImpact();
                widget.onTap?.call();
              },
              onLongPress: () {
                HapticFeedback.mediumImpact();
                CreateBudgetSheet.show(context, existingBudget: budget.budget);
              },
              child: Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: context.appColors.cardBackground,
                  borderRadius: BorderRadius.circular(16),
                  border: Border.all(
                    color: budget.isOverBudget
                        ? context.appColors.error.withValues(alpha: 0.3)
                        : budget.isNearLimit
                        ? context.appColors.warning.withValues(alpha: 0.3)
                        : context.appColors.cardBorder,
                    width: budget.isOverBudget || budget.isNearLimit ? 1.5 : 1,
                  ),
                  boxShadow: [
                    if (budget.isOverBudget)
                      BoxShadow(
                        color: context.appColors.error.withValues(alpha: 0.1),
                        blurRadius: 8,
                        spreadRadius: 0,
                      ),
                  ],
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    // Header: Category icon + name + percentage
                    Row(
                      children: [
                        Container(
                          width: 40,
                          height: 40,
                          decoration: BoxDecoration(
                            color: progressColor.withValues(alpha: 0.15),
                            borderRadius: BorderRadius.circular(16),
                          ),
                          child: Icon(
                            ExpenseCategory.getIcon(budget.budget.category),
                            color: progressColor,
                            size: 20,
                          ),
                        ),
                        const SizedBox(width: 12),
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text(
                                ExpenseCategory.getLocalizedName(
                                  budget.budget.category,
                                  l10n,
                                ),
                                style: TextStyle(
                                  fontSize: 15,
                                  fontWeight: FontWeight.w600,
                                  color: context.appColors.textPrimary,
                                ),
                              ),
                              const SizedBox(height: 2),
                              Text(
                                budget.isOverBudget
                                    ? l10n.overLimit
                                    : budget.isNearLimit
                                    ? l10n.nearLimit
                                    : l10n.onTrack,
                                style: TextStyle(
                                  fontSize: 12,
                                  fontWeight: FontWeight.w500,
                                  color: progressColor,
                                ),
                              ),
                            ],
                          ),
                        ),
                        // Percentage badge
                        Container(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 10,
                            vertical: 6,
                          ),
                          decoration: BoxDecoration(
                            color: progressColor.withValues(alpha: 0.15),
                            borderRadius: BorderRadius.circular(8),
                          ),
                          child: Text(
                            '%${budget.percentUsed.toStringAsFixed(0)}',
                            style: TextStyle(
                              fontSize: 14,
                              fontWeight: FontWeight.w700,
                              color: progressColor,
                            ),
                          ),
                        ),
                      ],
                    ),

                    const SizedBox(height: 16),

                    // Progress bar
                    ClipRRect(
                      borderRadius: BorderRadius.circular(6),
                      child: Container(
                        height: 8,
                        decoration: BoxDecoration(
                          color: context.appColors.surfaceLight,
                        ),
                        child: LayoutBuilder(
                          builder: (context, constraints) {
                            return Stack(
                              children: [
                                AnimatedContainer(
                                  duration: const Duration(milliseconds: 300),
                                  width:
                                      constraints.maxWidth *
                                      _progressAnimation.value,
                                  decoration: BoxDecoration(
                                    gradient: LinearGradient(
                                      colors: [
                                        progressColor.withValues(alpha: 0.8),
                                        progressColor,
                                      ],
                                    ),
                                    borderRadius: BorderRadius.circular(6),
                                    boxShadow: [
                                      BoxShadow(
                                        color: progressColor.withValues(
                                          alpha: 0.4,
                                        ),
                                        blurRadius: 4,
                                        offset: const Offset(0, 1),
                                      ),
                                    ],
                                  ),
                                ),
                              ],
                            );
                          },
                        ),
                      ),
                    ),

                    const SizedBox(height: 12),

                    // Amount info
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        // Spent / Limit
                        Text(
                          l10n.ofBudget(
                            '${currencyProvider.symbol}${formatTurkishCurrency(spentConverted, decimalDigits: 0)}',
                            '${currencyProvider.symbol}${formatTurkishCurrency(limitConverted, decimalDigits: 0)}',
                          ),
                          style: TextStyle(
                            fontSize: 13,
                            color: context.appColors.textSecondary,
                          ),
                        ),
                        // Remaining
                        Row(
                          children: [
                            Icon(
                              budget.isOverBudget
                                  ? CupertinoIcons.exclamationmark_triangle_fill
                                  : CupertinoIcons.checkmark_circle_fill,
                              size: 14,
                              color: budget.isOverBudget
                                  ? context.appColors.error
                                  : context.appColors.success,
                            ),
                            const SizedBox(width: 4),
                            Text(
                              budget.isOverBudget
                                  ? l10n.overBudgetAmount(
                                      '${currencyProvider.symbol}${formatTurkishCurrency(remainingConverted, decimalDigits: 0)}',
                                    )
                                  : l10n.remainingAmount(
                                      '${currencyProvider.symbol}${formatTurkishCurrency(remainingConverted, decimalDigits: 0)}',
                                    ),
                              style: TextStyle(
                                fontSize: 13,
                                fontWeight: FontWeight.w600,
                                color: budget.isOverBudget
                                    ? context.appColors.error
                                    : context.appColors.success,
                              ),
                            ),
                          ],
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            ),
          ),
        );
      },
    );
  }
}

/// Compact budget card for dashboard
class CompactBudgetCard extends StatelessWidget {
  final CategoryBudgetWithSpent budget;
  final VoidCallback? onTap;

  const CompactBudgetCard({super.key, required this.budget, this.onTap});

  Color _getProgressColor(BuildContext context) {
    final percent = budget.percentUsed;
    if (percent >= 100) return context.appColors.error;
    if (percent >= 80) return context.appColors.warning;
    return context.appColors.success;
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final progressColor = _getProgressColor(context);

    return GestureDetector(
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
        decoration: BoxDecoration(
          color: progressColor.withValues(alpha: 0.1),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: progressColor.withValues(alpha: 0.2)),
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(
              ExpenseCategory.getIcon(budget.budget.category),
              color: progressColor,
              size: 16,
            ),
            const SizedBox(width: 8),
            Text(
              ExpenseCategory.getLocalizedName(budget.budget.category, l10n),
              style: TextStyle(
                fontSize: 13,
                fontWeight: FontWeight.w500,
                color: context.appColors.textPrimary,
              ),
            ),
            const SizedBox(width: 8),
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
              decoration: BoxDecoration(
                color: progressColor.withValues(alpha: 0.2),
                borderRadius: BorderRadius.circular(4),
              ),
              child: Text(
                '%${budget.percentUsed.toStringAsFixed(0)}',
                style: TextStyle(
                  fontSize: 11,
                  fontWeight: FontWeight.w700,
                  color: progressColor,
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}


--- FILE: lib/widgets/shimmer_effect.dart ---

import 'package:flutter/material.dart';
import '../theme/theme.dart';

/// Shimmer efekti widget'ı
/// Platinum rozetler ve yükleme durumları için kullanılır
class ShimmerEffect extends StatefulWidget {
  final Widget child;
  final List<Color>? colors;
  final Duration duration;
  final bool enabled;

  const ShimmerEffect({
    super.key,
    required this.child,
    this.colors,
    this.duration = const Duration(milliseconds: 2000),
    this.enabled = true,
  });

  /// Platinum gradient için
  factory ShimmerEffect.platinum({
    Key? key,
    required Widget child,
    bool enabled = true,
  }) {
    return ShimmerEffect(
      key: key,
      colors: const [
        Color(0xFFE5E4E2),
        Color(0xFF8ED1FC),
        Color(0xFFB4A7D6),
        Color(0xFFE5E4E2),
      ],
      enabled: enabled,
      child: child,
    );
  }

  /// Yükleme placeholder için
  factory ShimmerEffect.loading({Key? key, required Widget child}) {
    return ShimmerEffect(
      key: key,
      colors: const [
        Color(0xFF2A2A40), // AppColors.surfaceLight hardcoded for const factory
        Color(
          0xFF35354D,
        ), // AppColors.surfaceLighter hardcoded for const factory
        Color(0xFF2A2A40), // AppColors.surfaceLight hardcoded for const factory
      ],
      child: child,
    );
  }

  @override
  State<ShimmerEffect> createState() => _ShimmerEffectState();
}

class _ShimmerEffectState extends State<ShimmerEffect>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _animation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(vsync: this, duration: widget.duration);

    _animation = Tween<double>(
      begin: 0.0,
      end: 1.0,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeInOut));

    if (widget.enabled) {
      _controller.repeat();
    }
  }

  @override
  void didUpdateWidget(ShimmerEffect oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (widget.enabled != oldWidget.enabled) {
      if (widget.enabled) {
        _controller.repeat();
      } else {
        _controller.stop();
      }
    }
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    if (!widget.enabled) {
      return widget.child;
    }

    final colors =
        widget.colors ?? const [Colors.white24, Colors.white54, Colors.white24];

    return RepaintBoundary(
      child: AnimatedBuilder(
        animation: _animation,
        builder: (context, child) {
          return ShaderMask(
            shaderCallback: (bounds) {
              return LinearGradient(
                begin: Alignment(-1.0 + 2 * _animation.value, 0),
                end: Alignment(0.0 + 2 * _animation.value, 0),
                colors: colors,
              ).createShader(bounds);
            },
            blendMode: BlendMode.srcATop,
            child: widget.child,
          );
        },
      ),
    );
  }
}

/// Gradient border ile shimmer efekti
class ShimmerBorder extends StatefulWidget {
  final Widget child;
  final double borderRadius;
  final double borderWidth;
  final List<Color>? colors;
  final Duration duration;
  final bool enabled;

  const ShimmerBorder({
    super.key,
    required this.child,
    this.borderRadius = 16,
    this.borderWidth = 2,
    this.colors,
    this.duration = const Duration(milliseconds: 2000),
    this.enabled = true,
  });

  @override
  State<ShimmerBorder> createState() => _ShimmerBorderState();
}

class _ShimmerBorderState extends State<ShimmerBorder>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _animation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(vsync: this, duration: widget.duration);

    _animation = Tween<double>(begin: 0.0, end: 1.0).animate(_controller);

    if (widget.enabled) {
      _controller.repeat();
    }
  }

  @override
  void didUpdateWidget(ShimmerBorder oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (widget.enabled != oldWidget.enabled) {
      if (widget.enabled) {
        _controller.repeat();
      } else {
        _controller.stop();
      }
    }
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    if (!widget.enabled) {
      return widget.child;
    }

    final colors =
        widget.colors ??
        const [
          Color(0xFFE5E4E2),
          Color(0xFF8ED1FC),
          Color(0xFFB4A7D6),
          Color(0xFFE5E4E2),
        ];

    return RepaintBoundary(
      child: AnimatedBuilder(
        animation: _animation,
        builder: (context, child) {
          return Container(
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(widget.borderRadius),
              gradient: SweepGradient(
                startAngle: _animation.value * 6.28,
                colors: colors,
              ),
            ),
            child: Container(
              margin: EdgeInsets.all(widget.borderWidth),
              decoration: BoxDecoration(
                color: context.appColors.surface,
                borderRadius: BorderRadius.circular(
                  widget.borderRadius - widget.borderWidth,
                ),
              ),
              child: widget.child,
            ),
          );
        },
      ),
    );
  }
}

/// Blur + opacity ile kilitli görünüm
class LockedOverlay extends StatelessWidget {
  final Widget child;
  final bool isLocked;
  final double blurAmount;
  final double opacity;

  const LockedOverlay({
    super.key,
    required this.child,
    this.isLocked = true,
    this.blurAmount = AppAnimations.lockedBlur,
    this.opacity = AppAnimations.lockedOpacity,
  });

  @override
  Widget build(BuildContext context) {
    if (!isLocked) {
      return child;
    }

    return Stack(
      children: [
        // Blur yapılmış içerik
        Opacity(
          opacity: opacity,
          child: ImageFiltered(
            imageFilter: blurAmount > 0
                ? ColorFilter.mode(
                    Colors.black.withValues(alpha: 0.3),
                    BlendMode.darken,
                  )
                : const ColorFilter.mode(Colors.transparent, BlendMode.dst),
            child: child,
          ),
        ),
      ],
    );
  }
}


--- FILE: lib/widgets/expense_history_card.dart ---

import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_slidable/flutter_slidable.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';
import '../theme/theme.dart';
import '../utils/category_utils.dart';
import '../utils/currency_utils.dart';
import 'premium_share_card.dart';

class ExpenseHistoryCard extends StatefulWidget {
  final Expense expense;
  final VoidCallback? onDelete;
  final VoidCallback? onEdit;
  final Function(ExpenseDecision)? onDecisionUpdate;
  final bool showHint;
  final String currencySymbol;
  final double dailyWorkHours;

  const ExpenseHistoryCard({
    super.key,
    required this.expense,
    this.onDelete,
    this.onEdit,
    this.onDecisionUpdate,
    this.showHint = false,
    this.currencySymbol = '₺',
    this.dailyWorkHours = 8,
  });

  @override
  State<ExpenseHistoryCard> createState() => _ExpenseHistoryCardState();
}

class _ExpenseHistoryCardState extends State<ExpenseHistoryCard>
    with SingleTickerProviderStateMixin {
  // iOS 26 Liquid Glass: Subtle breathing glow
  late AnimationController _glowController;
  late Animation<double> _glowAnimation;

  @override
  void initState() {
    super.initState();
    _glowController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 3000),
    )..repeat(reverse: true);

    _glowAnimation = Tween<double>(begin: 0.15, end: 0.35).animate(
      CurvedAnimation(parent: _glowController, curve: Curves.easeInOut),
    );
  }

  @override
  void dispose() {
    _glowController.dispose();
    super.dispose();
  }

  Expense get expense => widget.expense;
  VoidCallback? get onDelete => widget.onDelete;
  VoidCallback? get onEdit => widget.onEdit;
  Function(ExpenseDecision)? get onDecisionUpdate => widget.onDecisionUpdate;
  bool get showHint => widget.showHint;
  String get currencySymbol => widget.currencySymbol;
  double get dailyWorkHours => widget.dailyWorkHours;

  String _formatDate(BuildContext context, DateTime date) {
    final l10n = AppLocalizations.of(context);
    final months = [
      l10n.monthJan,
      l10n.monthFeb,
      l10n.monthMar,
      l10n.monthApr,
      l10n.monthMay,
      l10n.monthJun,
      l10n.monthJul,
      l10n.monthAug,
      l10n.monthSep,
      l10n.monthOct,
      l10n.monthNov,
      l10n.monthDec,
    ];
    return '${date.day} ${months[date.month - 1]} ${date.year}';
  }

  Color _getDecisionColor(BuildContext context, ExpenseDecision? decision) {
    return switch (decision) {
      ExpenseDecision.yes => context.appColors.decisionYes,
      ExpenseDecision.thinking => context.appColors.decisionThinking,
      ExpenseDecision.no => context.appColors.decisionNo,
      null => context.appColors.textTertiary,
    };
  }

  IconData _getDecisionIcon(ExpenseDecision? decision) {
    return switch (decision) {
      ExpenseDecision.yes => CupertinoIcons.checkmark_circle_fill,
      ExpenseDecision.thinking => CupertinoIcons.clock_fill,
      ExpenseDecision.no => CupertinoIcons.xmark_circle_fill,
      null => CupertinoIcons.question_circle_fill,
    };
  }

  void _showDecisionDialog(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    showModalBottomSheet(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      backgroundColor: context.appColors.surface,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
      ),
      builder: (context) => SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(24),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Container(
                width: 40,
                height: 4,
                decoration: BoxDecoration(
                  color: context.appColors.textTertiary,
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
              const SizedBox(height: 24),
              Text(
                l10n.updateDecision,
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textPrimary,
                ),
              ),
              const SizedBox(height: 24),
              _buildOptionTile(
                context: context,
                icon: CupertinoIcons.checkmark_circle_fill,
                label: l10n.bought,
                color: context.appColors.decisionYes,
                onTap: () {
                  Navigator.pop(context);
                  onDecisionUpdate?.call(ExpenseDecision.yes);
                },
              ),
              const SizedBox(height: 12),
              _buildOptionTile(
                context: context,
                icon: CupertinoIcons.xmark_circle_fill,
                label: l10n.passed,
                color: context.appColors.decisionNo,
                onTap: () {
                  Navigator.pop(context);
                  onDecisionUpdate?.call(ExpenseDecision.no);
                },
              ),
              const SizedBox(height: 12),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildOptionTile({
    required BuildContext context,
    required IconData icon,
    required String label,
    required Color color,
    required VoidCallback onTap,
  }) {
    return Semantics(
      label: label,
      button: true,
      child: Material(
        color: Colors.transparent,
        child: InkWell(
          onTap: onTap,
          borderRadius: BorderRadius.circular(16),
          child: Container(
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: color.withValues(alpha: 0.1),
            borderRadius: BorderRadius.circular(16),
            border: Border.all(color: color.withValues(alpha: 0.2)),
          ),
          child: Row(
            children: [
              Icon(icon, color: color, size: 24),
              const SizedBox(width: 16),
              Text(
                label,
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.w500,
                  color: color,
                ),
              ),
            ],
          ),
        ),
      ),
      ),
    );
  }

  void _showOptionsMenu(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    showModalBottomSheet(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      backgroundColor: context.appColors.surface,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
      ),
      builder: (context) => SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(24),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Container(
                width: 40,
                height: 4,
                decoration: BoxDecoration(
                  color: context.appColors.textTertiary,
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
              const SizedBox(height: 24),
              _buildMenuTile(
                context: context,
                icon: CupertinoIcons.share,
                label: l10n.share,
                color: context.appColors.primary,
                onTap: () {
                  Navigator.pop(context);
                  _showShareCard(context);
                },
              ),
              const SizedBox(height: 12),
              _buildMenuTile(
                context: context,
                icon: CupertinoIcons.pencil,
                label: l10n.edit,
                color: context.appColors.info,
                onTap: () {
                  Navigator.pop(context);
                  onEdit?.call();
                },
              ),
              const SizedBox(height: 12),
              _buildMenuTile(
                context: context,
                icon: CupertinoIcons.trash,
                label: l10n.delete,
                color: context.appColors.error,
                onTap: () {
                  Navigator.pop(context);
                  onDelete?.call();
                },
              ),
              const SizedBox(height: 12),
            ],
          ),
        ),
      ),
    );
  }

  void _showShareCard(BuildContext context) {
    showShareCardPreview(
      context,
      amount: expense.amount,
      hoursRequired: expense.hoursRequired,
      category: expense.category,
      date: expense.date,
      currencySymbol: currencySymbol,
      decision: expense.decision,
    );
  }

  Widget _buildMenuTile({
    required BuildContext context,
    required IconData icon,
    required String label,
    required Color color,
    required VoidCallback onTap,
  }) {
    return Material(
      color: Colors.transparent,
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(16),
        child: Container(
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: context.appColors.surfaceLight,
            borderRadius: BorderRadius.circular(16),
          ),
          child: Row(
            children: [
              Icon(icon, color: color, size: 22),
              const SizedBox(width: 16),
              Text(
                label,
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.w500,
                  color: color,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  String _getDecisionLabel(BuildContext context, ExpenseDecision? decision) {
    final l10n = AppLocalizations.of(context);
    return switch (decision) {
      ExpenseDecision.yes => l10n.accessibilityDecisionYes,
      ExpenseDecision.thinking => l10n.accessibilityDecisionThinking,
      ExpenseDecision.no => l10n.accessibilityDecisionNo,
      null => '',
    };
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final decisionColor = _getDecisionColor(context, expense.decision);
    final isThinking = expense.decision == ExpenseDecision.thinking;

    // Accessibility: Semantic label for screen readers
    final semanticLabel = l10n.accessibilityExpenseItem(
      CategoryUtils.getLocalizedName(context, expense.category),
      formatTurkishCurrency(expense.amount, decimalDigits: 0),
      expense.hoursRequired.toStringAsFixed(1),
      _getDecisionLabel(context, expense.decision),
    );

    // iOS 26 Liquid Glass: Animated card with subtle glow
    Widget card = AnimatedBuilder(
      animation: _glowAnimation,
      builder: (context, child) {
        return Semantics(
          label: semanticLabel,
          button: isThinking,
          child: Padding(
            padding: const EdgeInsets.only(bottom: AppDesign.spacingSm),
            // iOS 26: Outer glow container
            child: Container(
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(24),
                boxShadow: [
                  // Animated glow based on decision color
                  BoxShadow(
                    color: decisionColor.withValues(
                      alpha: _glowAnimation.value,
                    ),
                    blurRadius: 16,
                    spreadRadius: 0,
                    offset: const Offset(0, 4),
                  ),
                  // Subtle shadow for depth
                  BoxShadow(
                    color: Colors.black.withValues(alpha: 0.2),
                    blurRadius: 12,
                    offset: const Offset(0, 4),
                  ),
                ],
              ),
              child: ClipRRect(
                borderRadius: BorderRadius.circular(24),
                child: BackdropFilter(
                  // iOS 26: Enhanced blur for list items (20σ)
                  filter: ImageFilter.blur(sigmaX: 20, sigmaY: 20),
                  child: Container(
                    decoration: BoxDecoration(
                      borderRadius: BorderRadius.circular(24),
                      // iOS 26 Liquid Glass: Premium gradient
                      gradient: LinearGradient(
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                        colors: [
                          context.appColors.surface.withValues(alpha: 0.8),
                          context.appColors.surface.withValues(alpha: 0.6),
                        ],
                      ),
                      // Glass border
                      border: Border.all(
                        color: Colors.white.withValues(alpha: 0.15),
                        width: 1,
                      ),
                    ),
                    child: Material(
                      color: Colors.transparent,
                      child: InkWell(
                        onTap: isThinking ? () => _showDecisionDialog(context) : null,
                        borderRadius: BorderRadius.circular(24),
            child: Padding(
              padding: const EdgeInsets.all(16),
              child: Row(
                children: [
                  // Decision indicator - Revolut style (44x44, radius 14)
                  Container(
                    width: AppDesign.iconContainerSize,
                    height: AppDesign.iconContainerSize,
                    decoration: BoxDecoration(
                      color: decisionColor.withValues(alpha: 0.12),
                      borderRadius: BorderRadius.circular(AppDesign.iconContainerRadius),
                    ),
                    child: Icon(
                      _getDecisionIcon(expense.decision),
                      size: AppDesign.iconSize,
                      color: decisionColor,
                    ),
                  ),
                  const SizedBox(width: 16),

                  // Content - Revolut style
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        // Title (amount + category)
                        Text(
                          '${formatTurkishCurrency(expense.amount, decimalDigits: 0)} $currencySymbol',
                          style: TextStyle(
                            fontSize: 16,
                            fontWeight: FontWeight.w600,
                            color: context.appColors.textPrimary,
                            letterSpacing: -0.2,
                          ),
                        ),
                        const SizedBox(height: 4),
                        // Subtitle (category + badges)
                        Row(
                          children: [
                            Text(
                              CategoryUtils.getLocalizedName(
                                context,
                                expense.category,
                              ),
                              style: TextStyle(
                                fontSize: 13,
                                fontWeight: FontWeight.w400,
                                color: context.appColors.textTertiary,
                              ),
                            ),
                            // Work time
                            Text(
                              ' · ${formatWorkTime(
                                expense.hoursRequired,
                                workHoursPerDay: dailyWorkHours,
                                locale: Localizations.localeOf(context).languageCode,
                              )}',
                              style: TextStyle(
                                fontSize: 13,
                                color: context.appColors.textTertiary,
                              ),
                            ),
                            // Simulation badge
                            if (expense.isSimulation) ...[
                              Text(
                                ' · Sim',
                                style: TextStyle(
                                  fontSize: 13,
                                  fontWeight: FontWeight.w500,
                                  color: context.appColors.warning,
                                ),
                              ),
                            ],
                            // Auto-recorded badge
                            if (expense.isAutoRecorded) ...[
                              Text(
                                ' · ${l10n.autoRecorded}',
                                style: TextStyle(
                                  fontSize: 13,
                                  fontWeight: FontWeight.w500,
                                  color: context.appColors.info,
                                ),
                              ),
                            ],
                            // Tap to update hint
                            if (isThinking) ...[
                              Text(
                                ' · ${l10n.tapToUpdate}',
                                style: TextStyle(
                                  fontSize: 13,
                                  fontWeight: FontWeight.w500,
                                  color: context.appColors.decisionThinking,
                                ),
                              ),
                            ],
                          ],
                        ),
                      ],
                    ),
                  ),

                  // Right side - Amount (Revolut style)
                  Column(
                    crossAxisAlignment: CrossAxisAlignment.end,
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      // Date
                      Text(
                        _formatDate(context, expense.date),
                        style: TextStyle(
                          fontSize: 13,
                          color: context.appColors.textTertiary,
                        ),
                      ),
                    ],
                  ),
                  // Options menu button
                  const SizedBox(width: 8),
                  Semantics(
                    label: l10n.accessibilityEditExpense,
                    button: true,
                    child: GestureDetector(
                      onTap: () => _showOptionsMenu(context),
                      behavior: HitTestBehavior.opaque,
                      child: Container(
                        width: 32,
                        height: 32,
                        alignment: Alignment.center,
                        child: Icon(
                          CupertinoIcons.ellipsis_vertical,
                          size: 20,
                          color: context.appColors.textTertiary,
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
                  ),
                ),
              ),
            ),
          ),
        );
      },
    );

    // Swipe actions with flutter_slidable
    return Column(
      children: [
        if (showHint)
          Padding(
            padding: const EdgeInsets.only(bottom: 8),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(
                  CupertinoIcons.arrow_left_right,
                  size: 16,
                  color: context.appColors.textTertiary,
                ),
                const SizedBox(width: 8),
                Text(
                  l10n.swipeToEditOrDelete,
                  style: TextStyle(
                    fontSize: 12,
                    color: context.appColors.textTertiary,
                    fontWeight: FontWeight.w400,
                  ),
                ),
              ],
            ),
          ),
        Slidable(
          key: ValueKey(
            'expense_${expense.amount}_${expense.date.toIso8601String()}',
          ),

          // Swipe right → Edit (Blue)
          startActionPane: ActionPane(
            motion: const BehindMotion(),
            extentRatio: 0.25,
            children: [
              Semantics(
                label: l10n.accessibilityEditExpense,
                button: true,
                child: CustomSlidableAction(
                  onPressed: (_) {
                    HapticFeedback.lightImpact();
                    onEdit?.call();
                  },
                  backgroundColor: context.appColors.info,
                  foregroundColor: Colors.white,
                  borderRadius: BorderRadius.circular(16),
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      const Icon(CupertinoIcons.pencil, size: 22),
                      const SizedBox(height: 4),
                      Text(
                        l10n.edit,
                        style: const TextStyle(
                          fontSize: 12,
                          fontWeight: FontWeight.w600,
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ],
          ),

          // Swipe left → Delete (Red)
          endActionPane: ActionPane(
            motion: const BehindMotion(),
            extentRatio: 0.25,
            dismissible: DismissiblePane(
              onDismissed: () {
                HapticFeedback.mediumImpact();
                onDelete?.call();
              },
              confirmDismiss: () => _showDeleteConfirmation(context),
            ),
            children: [
              Semantics(
                label: l10n.accessibilityDeleteExpense,
                button: true,
                child: CustomSlidableAction(
                  onPressed: (_) async {
                    HapticFeedback.lightImpact();
                    final confirmed = await _showDeleteConfirmation(context);
                    if (confirmed) {
                      onDelete?.call();
                    }
                  },
                  backgroundColor: context.appColors.error,
                  foregroundColor: Colors.white,
                  borderRadius: BorderRadius.circular(16),
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      const Icon(CupertinoIcons.trash, size: 22),
                      const SizedBox(height: 4),
                      Text(
                        l10n.delete,
                        style: const TextStyle(
                          fontSize: 12,
                          fontWeight: FontWeight.w600,
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ],
          ),

          child: card,
        ),
      ],
    );
  }

  Future<bool> _showDeleteConfirmation(BuildContext context) async {
    final l10n = AppLocalizations.of(context);

    return await showDialog<bool>(
          context: context,
          builder: (context) => AlertDialog(
            backgroundColor: context.appColors.surface,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(16),
            ),
            title: Text(
              l10n.deleteExpense,
              style: TextStyle(
                color: context.appColors.textPrimary,
                fontWeight: FontWeight.w600,
              ),
            ),
            content: Text(
              l10n.deleteExpenseConfirm,
              style: TextStyle(color: context.appColors.textSecondary),
            ),
            actions: [
              TextButton(
                onPressed: () => Navigator.pop(context, false),
                child: Text(
                  l10n.cancel,
                  style: TextStyle(color: context.appColors.textSecondary),
                ),
              ),
              TextButton(
                onPressed: () {
                  HapticFeedback.mediumImpact();
                  Navigator.pop(context, true);
                },
                style: TextButton.styleFrom(
                  foregroundColor: context.appColors.error,
                ),
                child: Text(l10n.delete),
              ),
            ],
          ),
        ) ??
        false;
  }
}


--- FILE: lib/widgets/add_subscription_sheet.dart ---

import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';
import '../services/services.dart';
import '../theme/theme.dart';
import 'turkish_currency_input.dart';

/// Add new subscription bottom sheet
class AddSubscriptionSheet extends StatefulWidget {
  final Function(Subscription) onAdd;

  const AddSubscriptionSheet({super.key, required this.onAdd});

  @override
  State<AddSubscriptionSheet> createState() => _AddSubscriptionSheetState();
}

class _AddSubscriptionSheetState extends State<AddSubscriptionSheet> {
  final _formKey = GlobalKey<FormState>();
  final _nameController = TextEditingController();
  final _amountController = TextEditingController();
  final _subscriptionService = SubscriptionService();

  int _selectedDay = DateTime.now().day;
  int _selectedColorIndex = 0;
  String _selectedCategory = 'entertainment';
  bool _autoRecord = true;
  bool _isLoading = false;

  /// Subscription category keys and their localization getters
  static const List<String> _categoryKeys = [
    'entertainment',
    'digital',
    'health',
    'education',
    'sports',
    'communication',
    'other',
  ];

  /// Get localized category name from key
  String _getLocalizedCategory(String key, AppLocalizations l10n) {
    return switch (key) {
      'entertainment' => l10n.categoryEntertainment,
      'digital' => l10n.categoryDigital,
      'health' => l10n.categoryHealth,
      'education' => l10n.categoryEducation,
      'sports' => l10n.categorySports,
      'communication' => l10n.categoryCommunication,
      'other' => l10n.categoryOther,
      _ => key,
    };
  }

  @override
  void initState() {
    super.initState();
    _loadNextColorIndex();
  }

  Future<void> _loadNextColorIndex() async {
    final index = await _subscriptionService.getNextColorIndex();
    if (mounted) {
      setState(() => _selectedColorIndex = index);
    }
  }

  @override
  void dispose() {
    _nameController.dispose();
    _amountController.dispose();
    super.dispose();
  }

  Future<void> _submit() async {
    final l10n = AppLocalizations.of(context);
    if (!_formKey.currentState!.validate()) return;

    final amount = parseTurkishCurrency(_amountController.text);
    if (amount == null || amount <= 0) {
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text(l10n.pleaseEnterValidAmount)));
      return;
    }

    setState(() => _isLoading = true);

    final subscription = Subscription(
      id: _subscriptionService.generateId(),
      name: _nameController.text.trim(),
      amount: amount,
      renewalDay: _selectedDay,
      category: _selectedCategory,
      colorIndex: _selectedColorIndex,
      autoRecord: _autoRecord,
      createdAt: DateTime.now(),
    );

    HapticFeedback.mediumImpact();
    widget.onAdd(subscription);
    Navigator.pop(context);
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final bottomPadding = MediaQuery.of(context).viewInsets.bottom;

    return Container(
      margin: EdgeInsets.only(bottom: bottomPadding),
      decoration: BoxDecoration(
        color: context.appColors.gradientMid,
        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
      ),
      child: ClipRRect(
        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
        child: BackdropFilter(
          filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
          child: SingleChildScrollView(
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                // Handle
                Container(
                  width: 40,
                  height: 4,
                  margin: const EdgeInsets.only(top: 12),
                  decoration: BoxDecoration(
                    color: Colors.white.withValues(alpha: 0.2),
                    borderRadius: BorderRadius.circular(2),
                  ),
                ),

                Padding(
                  padding: const EdgeInsets.all(24),
                  child: Form(
                    key: _formKey,
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        // Title
                        Text(
                          l10n.newSubscription,
                          style: TextStyle(
                            fontSize: 20,
                            fontWeight: FontWeight.w600,
                            color: context.appColors.textPrimary,
                          ),
                        ),
                        const SizedBox(height: 24),

                        // Subscription name
                        TextFormField(
                          controller: _nameController,
                          keyboardType: TextInputType.text,
                          enableSuggestions: true,
                          autocorrect: false,
                          enableIMEPersonalizedLearning: true,
                          style: TextStyle(
                            color: context.appColors.textPrimary,
                          ),
                          decoration: _inputDecoration(
                            l10n.subscriptionName,
                            l10n.subscriptionNameHint,
                          ),
                          validator: (v) => v?.trim().isEmpty == true
                              ? l10n.nameRequired
                              : null,
                          textCapitalization: TextCapitalization.words,
                        ),
                        const SizedBox(height: 16),

                        // Monthly amount
                        TextFormField(
                          controller: _amountController,
                          style: TextStyle(
                            color: context.appColors.textPrimary,
                          ),
                          decoration: _inputDecoration(
                            l10n.monthlyAmountLabel,
                            l10n.subscriptionPriceHint,
                          ),
                          keyboardType: const TextInputType.numberWithOptions(
                            decimal: true,
                          ),
                          inputFormatters: [TurkishCurrencyInputFormatter()],
                          validator: (v) =>
                              v?.isEmpty == true ? l10n.amountRequired : null,
                        ),
                        const SizedBox(height: 16),

                        // Category and renewal day
                        Row(
                          children: [
                            // Category
                            Expanded(
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text(
                                    l10n.category,
                                    style: TextStyle(
                                      fontSize: 12,
                                      color: context.appColors.textSecondary,
                                    ),
                                  ),
                                  const SizedBox(height: 8),
                                  Container(
                                    padding: const EdgeInsets.symmetric(
                                      horizontal: 12,
                                    ),
                                    decoration: BoxDecoration(
                                      color: context.appColors.surface
                                          .withValues(alpha: 0.5),
                                      borderRadius: BorderRadius.circular(16),
                                    ),
                                    child: DropdownButtonHideUnderline(
                                      child: DropdownButton<String>(
                                        value: _selectedCategory,
                                        isExpanded: true,
                                        dropdownColor:
                                            context.appColors.gradientMid,
                                        style: TextStyle(
                                          color: context.appColors.textPrimary,
                                          fontSize: 14,
                                        ),
                                        items: _categoryKeys
                                            .map(
                                              (key) => DropdownMenuItem(
                                                value: key,
                                                child: Text(
                                                  _getLocalizedCategory(
                                                    key,
                                                    l10n,
                                                  ),
                                                ),
                                              ),
                                            )
                                            .toList(),
                                        onChanged: (v) {
                                          if (v != null) {
                                            setState(
                                              () => _selectedCategory = v,
                                            );
                                          }
                                        },
                                      ),
                                    ),
                                  ),
                                ],
                              ),
                            ),
                            const SizedBox(width: 16),
                            // Renewal day
                            Expanded(
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text(
                                    l10n.renewalDay,
                                    style: TextStyle(
                                      fontSize: 12,
                                      color: context.appColors.textSecondary,
                                    ),
                                  ),
                                  const SizedBox(height: 8),
                                  Container(
                                    padding: const EdgeInsets.symmetric(
                                      horizontal: 12,
                                    ),
                                    decoration: BoxDecoration(
                                      color: context.appColors.surface
                                          .withValues(alpha: 0.5),
                                      borderRadius: BorderRadius.circular(16),
                                    ),
                                    child: DropdownButtonHideUnderline(
                                      child: DropdownButton<int>(
                                        value: _selectedDay,
                                        isExpanded: true,
                                        dropdownColor:
                                            context.appColors.gradientMid,
                                        style: TextStyle(
                                          color: context.appColors.textPrimary,
                                          fontSize: 14,
                                        ),
                                        items: List.generate(31, (i) => i + 1)
                                            .map(
                                              (d) => DropdownMenuItem(
                                                value: d,
                                                child: Text('$d'),
                                              ),
                                            )
                                            .toList(),
                                        onChanged: (v) {
                                          if (v != null) {
                                            setState(() => _selectedDay = v);
                                          }
                                        },
                                      ),
                                    ),
                                  ),
                                ],
                              ),
                            ),
                          ],
                        ),
                        const SizedBox(height: 20),

                        // Color picker
                        Text(
                          l10n.color,
                          style: TextStyle(
                            fontSize: 12,
                            color: context.appColors.textSecondary,
                          ),
                        ),
                        const SizedBox(height: 10),
                        Row(
                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                          children: List.generate(
                            SubscriptionColors.count,
                            (index) => Semantics(
                              button: true,
                              selected: _selectedColorIndex == index,
                              label: '${l10n.color} ${index + 1}',
                              child: GestureDetector(
                                onTap: () {
                                  HapticFeedback.selectionClick();
                                  setState(() => _selectedColorIndex = index);
                                },
                                child: AnimatedContainer(
                                  duration: const Duration(milliseconds: 200),
                                  width: 36,
                                  height: 36,
                                  decoration: BoxDecoration(
                                    color: SubscriptionColors.get(index),
                                    shape: BoxShape.circle,
                                    border: _selectedColorIndex == index
                                        ? Border.all(
                                            color: Colors.white,
                                            width: 2.5,
                                          )
                                        : null,
                                    boxShadow: _selectedColorIndex == index
                                        ? [
                                            BoxShadow(
                                              color: SubscriptionColors.get(
                                                index,
                                              ).withValues(alpha: 0.5),
                                              blurRadius: 10,
                                              spreadRadius: 2,
                                            ),
                                          ]
                                        : null,
                                  ),
                                ),
                              ),
                            ),
                          ),
                        ),
                        const SizedBox(height: 20),

                        // Auto record toggle
                        Container(
                          padding: const EdgeInsets.all(14),
                          decoration: BoxDecoration(
                            color: context.appColors.surface.withValues(
                              alpha: 0.4,
                            ),
                            borderRadius: BorderRadius.circular(16),
                          ),
                          child: Row(
                            children: [
                              Icon(
                                CupertinoIcons.sparkles,
                                size: 20,
                                color: _autoRecord
                                    ? context.appColors.primary
                                    : context.appColors.textTertiary,
                              ),
                              const SizedBox(width: 12),
                              Expanded(
                                child: Column(
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    Text(
                                      l10n.autoRecord,
                                      style: TextStyle(
                                        fontSize: 14,
                                        fontWeight: FontWeight.w500,
                                        color: context.appColors.textPrimary,
                                      ),
                                    ),
                                    Text(
                                      l10n.autoRecordDescription,
                                      style: TextStyle(
                                        fontSize: 11,
                                        color: context.appColors.textSecondary,
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                              Switch(
                                value: _autoRecord,
                                onChanged: (v) =>
                                    setState(() => _autoRecord = v),
                                activeTrackColor: context.appColors.primary,
                              ),
                            ],
                          ),
                        ),
                        const SizedBox(height: 24),

                        // Submit button
                        SizedBox(
                          width: double.infinity,
                          child: ElevatedButton(
                            onPressed: _isLoading ? null : _submit,
                            style: ElevatedButton.styleFrom(
                              backgroundColor: context.appColors.primary,
                              foregroundColor: Colors.white,
                              padding: const EdgeInsets.symmetric(vertical: 16),
                              shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(16),
                              ),
                            ),
                            child: _isLoading
                                ? const SizedBox(
                                    width: 20,
                                    height: 20,
                                    child: CircularProgressIndicator(
                                      strokeWidth: 2,
                                      color: Colors.white,
                                    ),
                                  )
                                : Text(
                                    l10n.addSubscription,
                                    style: const TextStyle(
                                      fontSize: 16,
                                      fontWeight: FontWeight.w600,
                                    ),
                                  ),
                          ),
                        ),
                        const SizedBox(height: 16),
                      ],
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  InputDecoration _inputDecoration(String label, String hint) {
    return InputDecoration(
      labelText: label,
      hintText: hint,
      labelStyle: TextStyle(
        color: context.appColors.textSecondary,
        fontSize: 14,
      ),
      hintStyle: TextStyle(color: context.appColors.textTertiary, fontSize: 14),
      filled: true,
      fillColor: context.appColors.surface.withValues(alpha: 0.5),
      border: OutlineInputBorder(
        borderRadius: BorderRadius.circular(16),
        borderSide: BorderSide.none,
      ),
      contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
    );
  }
}


--- FILE: lib/widgets/decision_buttons.dart ---

import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/services.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../core/theme/psychology_design_system.dart';
import '../models/models.dart';

/// iOS 26 Liquid Glass Decision Buttons
/// Premium fintech-style decision interface with psychology-based emphasis
/// "Vazgeçtim" (Passed) button is emphasized with CYAN - positive for savings!
class DecisionButtons extends StatelessWidget {
  final Function(ExpenseDecision) onDecision;
  final bool enabled;

  const DecisionButtons({
    super.key,
    required this.onDecision,
    this.enabled = true,
  });

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    return Column(
      children: [
        Text(
          l10n.whatIsYourDecision,
          style: PsychologyTypography.bodyMedium,
          textAlign: TextAlign.center,
        ),
        const SizedBox(height: 16),
        Row(
          children: [
            Expanded(
              child: _AnimatedDecisionButton(
                label: l10n.bought,
                icon: CupertinoIcons.checkmark,
                color: PsychologyColors.decisionYes,
                decision: ExpenseDecision.yes,
                onTap: enabled ? () => onDecision(ExpenseDecision.yes) : null,
              ),
            ),
            const SizedBox(width: 10),
            Expanded(
              child: _AnimatedDecisionButton(
                label: l10n.thinking,
                icon: CupertinoIcons.clock,
                color: PsychologyColors.decisionThinking,
                decision: ExpenseDecision.thinking,
                onTap: enabled
                    ? () => onDecision(ExpenseDecision.thinking)
                    : null,
              ),
            ),
            const SizedBox(width: 10),
            Expanded(
              child: _AnimatedDecisionButton(
                label: l10n.passed,
                icon: CupertinoIcons.xmark,
                color: PsychologyColors.decisionNo, // CYAN - positive savings!
                decision: ExpenseDecision.no,
                onTap: enabled ? () => onDecision(ExpenseDecision.no) : null,
                isEmphasis: true, // Positive action = emphasized with glow
              ),
            ),
          ],
        ),
      ],
    );
  }
}

class _AnimatedDecisionButton extends StatefulWidget {
  final String label;
  final IconData icon;
  final Color color;
  final ExpenseDecision decision;
  final VoidCallback? onTap;
  final bool isEmphasis;

  const _AnimatedDecisionButton({
    required this.label,
    required this.icon,
    required this.color,
    required this.decision,
    required this.onTap,
    this.isEmphasis = false,
  });

  @override
  State<_AnimatedDecisionButton> createState() =>
      _AnimatedDecisionButtonState();
}

class _AnimatedDecisionButtonState extends State<_AnimatedDecisionButton>
    with TickerProviderStateMixin {
  late AnimationController _scaleController;
  late AnimationController _glowController;
  late Animation<double> _scaleAnimation;
  late Animation<double> _glowAnimation;

  bool _isPressed = false;

  @override
  void initState() {
    super.initState();

    // Scale animation using psychology timing
    _scaleController = AnimationController(
      vsync: this,
      duration: PsychologyAnimations.quick,
    );
    _scaleAnimation = Tween<double>(
      begin: 1.0,
      end: PsychologyAnimations.buttonPressScale,
    ).animate(CurvedAnimation(
      parent: _scaleController,
      curve: PsychologyAnimations.standardCurve,
    ));

    // Emphasis glow for "Vazgeçtim" button (2s cycle)
    _glowController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 2000),
    );
    _glowAnimation = Tween<double>(begin: 0.2, end: 0.5).animate(
      CurvedAnimation(parent: _glowController, curve: Curves.easeInOut),
    );

    if (widget.isEmphasis) {
      _glowController.repeat(reverse: true);
    }
  }

  @override
  void dispose() {
    _scaleController.dispose();
    _glowController.dispose();
    super.dispose();
  }

  void _handleTapDown(TapDownDetails details) {
    if (widget.onTap == null) return;
    setState(() => _isPressed = true);
    _scaleController.forward();
    HapticFeedback.lightImpact();
  }

  void _handleTapUp(TapUpDetails details) {
    if (widget.onTap == null) return;
    setState(() => _isPressed = false);
    _scaleController.reverse();
  }

  void _handleTapCancel() {
    if (widget.onTap == null) return;
    setState(() => _isPressed = false);
    _scaleController.reverse();
  }

  void _handleTap() {
    if (widget.onTap == null) return;

    // Psychology-based haptic feedback
    switch (widget.decision) {
      case ExpenseDecision.yes:
        HapticFeedback.mediumImpact();
        break;
      case ExpenseDecision.thinking:
        HapticFeedback.lightImpact();
        break;
      case ExpenseDecision.no:
        HapticFeedback.heavyImpact(); // Celebration for saving!
        break;
    }

    widget.onTap!();
  }

  @override
  Widget build(BuildContext context) {
    final bool isEnabled = widget.onTap != null;

    return RepaintBoundary(
      child: AnimatedBuilder(
        animation: Listenable.merge([_scaleAnimation, _glowAnimation]),
        builder: (context, child) {
          return Transform.scale(
            scale: _scaleAnimation.value,
            child: GestureDetector(
              onTapDown: _handleTapDown,
              onTapUp: _handleTapUp,
              onTapCancel: _handleTapCancel,
              onTap: _handleTap,
              child: AnimatedOpacity(
                opacity: isEnabled ? 1.0 : 0.5,
                duration: PsychologyAnimations.quick,
                child: Container(
                  decoration: BoxDecoration(
                    borderRadius: BorderRadius.circular(PsychologyRadius.lg),
                    boxShadow: widget.isEmphasis
                        ? [
                            BoxShadow(
                              color: widget.color.withValues(
                                alpha: _glowAnimation.value,
                              ),
                              blurRadius: 20,
                              spreadRadius: -4,
                            ),
                          ]
                        : null,
                  ),
                  child: ClipRRect(
                    borderRadius: BorderRadius.circular(PsychologyRadius.lg),
                    child: BackdropFilter(
                      filter: ImageFilter.blur(sigmaX: 20, sigmaY: 20),
                      child: Container(
                        constraints: const BoxConstraints(minHeight: 88),
                        padding: const EdgeInsets.symmetric(
                          vertical: 16,
                          horizontal: 12,
                        ),
                        decoration: BoxDecoration(
                          gradient: LinearGradient(
                            begin: Alignment.topLeft,
                            end: Alignment.bottomRight,
                            colors: [
                              widget.color.withValues(
                                alpha: _isPressed ? 0.2 : 0.12,
                              ),
                              widget.color.withValues(
                                alpha: _isPressed ? 0.15 : 0.06,
                              ),
                            ],
                          ),
                          borderRadius: BorderRadius.circular(PsychologyRadius.lg),
                          border: Border.all(
                            color: widget.color.withValues(
                              alpha: widget.isEmphasis ? 0.4 : 0.2,
                            ),
                            width: widget.isEmphasis ? 1.5 : 1,
                          ),
                        ),
                        child: Column(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            // Icon container with psychology glow
                            Container(
                              width: 44,
                              height: 44,
                              decoration: BoxDecoration(
                                gradient: LinearGradient(
                                  colors: [
                                    widget.color.withValues(alpha: 0.25),
                                    widget.color.withValues(alpha: 0.1),
                                  ],
                                ),
                                borderRadius: BorderRadius.circular(14),
                                border: Border.all(
                                  color: widget.color.withValues(alpha: 0.3),
                                ),
                                boxShadow: PsychologyShadows.glow(
                                  widget.color,
                                  intensity: 0.25,
                                  blur: 12,
                                ),
                              ),
                              child: Icon(
                                widget.icon,
                                size: 22,
                                color: widget.color,
                                shadows: PsychologyShadows.iconHalo(widget.color),
                              ),
                            ),
                            const SizedBox(height: 10),
                            // Label
                            Text(
                              widget.label,
                              style: PsychologyTypography.labelMedium.copyWith(
                                color: widget.color,
                                fontWeight: FontWeight.w600,
                              ),
                              textAlign: TextAlign.center,
                            ),
                          ],
                        ),
                      ),
                    ),
                  ),
                ),
              ),
            ),
          );
        },
      ),
    );
  }
}

/// Single decision button (for separate usage)
class SingleDecisionButton extends StatefulWidget {
  final String label;
  final IconData icon;
  final Color color;
  final VoidCallback? onTap;
  final bool isSelected;

  const SingleDecisionButton({
    super.key,
    required this.label,
    required this.icon,
    required this.color,
    this.onTap,
    this.isSelected = false,
  });

  @override
  State<SingleDecisionButton> createState() => _SingleDecisionButtonState();
}

class _SingleDecisionButtonState extends State<SingleDecisionButton>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _scaleAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: PsychologyAnimations.micro,
    );

    _scaleAnimation = Tween<double>(
      begin: 1.0,
      end: PsychologyAnimations.buttonPressScale,
    ).animate(CurvedAnimation(
      parent: _controller,
      curve: PsychologyAnimations.standardCurve,
    ));
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return RepaintBoundary(
      child: GestureDetector(
        onTapDown: (_) {
          if (widget.onTap != null) {
            _controller.forward();
            HapticFeedback.selectionClick();
          }
        },
        onTapUp: (_) => _controller.reverse(),
        onTapCancel: () => _controller.reverse(),
        onTap: () {
          if (widget.onTap != null) {
            HapticFeedback.lightImpact();
            widget.onTap!();
          }
        },
        child: AnimatedBuilder(
          animation: _scaleAnimation,
          builder: (context, child) {
            return Transform.scale(
              scale: _scaleAnimation.value,
              child: AnimatedContainer(
                duration: PsychologyAnimations.standardDuration,
                curve: PsychologyAnimations.standardCurve,
                constraints: const BoxConstraints(minHeight: 44),
                padding: const EdgeInsets.symmetric(
                  vertical: 12,
                  horizontal: 16,
                ),
                decoration: BoxDecoration(
                  color: widget.isSelected
                      ? widget.color.withValues(alpha: 0.2)
                      : widget.color.withValues(alpha: 0.1),
                  borderRadius: BorderRadius.circular(PsychologyRadius.md),
                  border: Border.all(
                    color: widget.isSelected
                        ? widget.color
                        : widget.color.withValues(alpha: 0.3),
                    width: widget.isSelected ? 2 : 1,
                  ),
                  boxShadow: widget.isSelected
                      ? PsychologyShadows.glow(widget.color, intensity: 0.2)
                      : null,
                ),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Icon(
                      widget.icon,
                      size: 18,
                      color: widget.color,
                      shadows: widget.isSelected
                          ? PsychologyShadows.iconHalo(widget.color)
                          : null,
                    ),
                    const SizedBox(width: 8),
                    Text(
                      widget.label,
                      style: PsychologyTypography.labelMedium.copyWith(
                        color: widget.color,
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                  ],
                ),
              ),
            );
          },
        ),
      ),
    );
  }
}


--- FILE: lib/widgets/financial_snapshot_card.dart ---

import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../core/theme/psychology_design_system.dart';
import '../providers/currency_provider.dart';
import '../theme/theme.dart' hide GlassCard;
import '../core/theme/premium_effects.dart';
import '../utils/currency_utils.dart';

/// Premium Financial Snapshot Card
/// Revolut-style clean design, mirror layout for income/expense
class FinancialSnapshotCard extends StatefulWidget {
  final double totalIncome;
  final double totalSpent;
  final double savedAmount;
  final int savedCount;
  final int incomeSourceCount;
  final VoidCallback? onTap;

  // Budget-based parameters (optional)
  final double? availableBudget; // Discretionary budget after mandatory
  final double? discretionarySpent; // Only discretionary expenses
  final double? mandatorySpent; // Mandatory expenses total

  const FinancialSnapshotCard({
    super.key,
    required this.totalIncome,
    required this.totalSpent,
    required this.savedAmount,
    this.savedCount = 0,
    this.incomeSourceCount = 1,
    this.onTap,
    this.availableBudget,
    this.discretionarySpent,
    this.mandatorySpent,
  });

  @override
  State<FinancialSnapshotCard> createState() => _FinancialSnapshotCardState();
}

class _FinancialSnapshotCardState extends State<FinancialSnapshotCard>
    with TickerProviderStateMixin {
  late AnimationController _countController;
  late Animation<double> _countAnimation;

  // iOS 26 Liquid Glass: Animated breathing glow
  late AnimationController _glowController;
  late Animation<double> _glowAnimation;

  double _previousNetBalance = 0;
  double _previousIncome = 0;
  double _previousSpent = 0;

  double get netBalance => widget.totalIncome - widget.totalSpent;

  // Budget-based progress calculation
  bool get _hasBudgetData =>
      widget.availableBudget != null && widget.discretionarySpent != null;

  /// Progress bar için harcama yüzdesi
  /// Budget varsa: discretionarySpent / availableBudget
  /// Yoksa: totalSpent / totalIncome
  double get spentPercent {
    if (_hasBudgetData && widget.availableBudget! > 0) {
      return (widget.discretionarySpent! / widget.availableBudget! * 100).clamp(
        0,
        150,
      );
    }
    return widget.totalIncome > 0
        ? (widget.totalSpent / widget.totalIncome * 100).clamp(0, 100)
        : 0;
  }

  double get remainingPercent => (100 - spentPercent).clamp(0, 100);

  bool get isHealthy => netBalance >= 0;

  @override
  void initState() {
    super.initState();
    // Psychology-based 800ms count-up animation
    _countController = AnimationController(
      duration: PsychologyAnimations.countUp,
      vsync: this,
    );
    _countAnimation = CurvedAnimation(
      parent: _countController,
      curve: PsychologyAnimations.standardCurve,
    );
    _countController.forward();

    // Psychology-based breathing glow effect (3s cycle)
    _glowController = AnimationController(
      vsync: this,
      duration: PsychologyAnimations.breathingCycle,
    )..repeat(reverse: true);

    _glowAnimation = Tween<double>(
      begin: PsychologyAnimations.glowMin + 0.15, // Enhanced for hero card
      end: PsychologyAnimations.glowMax + 0.15,
    ).animate(CurvedAnimation(
      parent: _glowController,
      curve: PsychologyAnimations.smooth,
    ));
  }

  @override
  void didUpdateWidget(FinancialSnapshotCard oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (oldWidget.totalIncome != widget.totalIncome ||
        oldWidget.totalSpent != widget.totalSpent) {
      _previousNetBalance = oldWidget.totalIncome - oldWidget.totalSpent;
      _previousIncome = oldWidget.totalIncome;
      _previousSpent = oldWidget.totalSpent;
      _countController.forward(from: 0);
    }
  }

  @override
  void dispose() {
    _countController.dispose();
    _glowController.dispose();
    super.dispose();
  }

  double _lerp(double begin, double end, double t) {
    return begin + (end - begin) * t;
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final currencyProvider = context.watch<CurrencyProvider>();

    return AnimatedBuilder(
      animation: _countAnimation,
      builder: (context, child) {
        final animatedNetBalance = _lerp(
          _previousNetBalance,
          netBalance,
          _countAnimation.value,
        );
        final animatedIncome = _lerp(
          _previousIncome,
          widget.totalIncome,
          _countAnimation.value,
        );
        final animatedSpent = _lerp(
          _previousSpent,
          widget.totalSpent,
          _countAnimation.value,
        );
        final animatedRemaining = widget.totalIncome > 0
            ? ((animatedIncome - animatedSpent) / animatedIncome * 100).clamp(
                0.0,
                100.0,
              )
            : 100.0;

        // Accessibility: Semantic label for screen readers
        final semanticLabel = l10n.accessibilitySpendingProgress(
          spentPercent.toInt(),
        );

        return Semantics(
          label: semanticLabel,
          button: widget.onTap != null,
          child: GestureDetector(
            onTap: widget.onTap,
            child: Padding(
              padding: const EdgeInsets.symmetric(horizontal: 20),
              // iOS 26 Liquid Glass: Animated outer glow container
              child: AnimatedBuilder(
                animation: _glowAnimation,
                builder: (context, child) {
                  return Container(
                    decoration: BoxDecoration(
                      borderRadius: BorderRadius.circular(PsychologyRadius.xxl + 4),
                      boxShadow: [
                        // Animated breathing glow with psychology primary
                        BoxShadow(
                          color: PsychologyColors.primary.withValues(
                            alpha: _glowAnimation.value,
                          ),
                          blurRadius: 40,
                          spreadRadius: -4,
                          offset: const Offset(0, 8),
                        ),
                        // Deep shadow for depth
                        BoxShadow(
                          color: Colors.black.withValues(alpha: 0.4),
                          blurRadius: 24,
                          offset: const Offset(0, 12),
                        ),
                      ],
                    ),
                    child: ClipRRect(
                      borderRadius: BorderRadius.circular(28),
                      child: BackdropFilter(
                        // iOS 26: Enhanced 30σ blur
                        filter: ImageFilter.blur(sigmaX: 30, sigmaY: 30),
                        child: Container(
                          padding: const EdgeInsets.all(24),
                          decoration: BoxDecoration(
                            borderRadius: BorderRadius.circular(PsychologyRadius.xxl + 4),
                            // Psychology-based glass gradient
                            gradient: LinearGradient(
                              begin: Alignment.topLeft,
                              end: Alignment.bottomRight,
                              colors: [
                                PsychologyColors.primary.withValues(alpha: 0.35),
                                PsychologyColors.primaryDark.withValues(alpha: 0.25),
                                PsychologyColors.surfaceOverlay.withValues(alpha: 0.4),
                              ],
                              stops: const [0.0, 0.5, 1.0],
                            ),
                            // Glass border with highlight
                            border: Border.all(
                              color: Colors.white.withValues(
                                alpha: PsychologyGlass.highlightOpacity + 0.05,
                              ),
                              width: 1.5,
                            ),
                          ),
                          child: Stack(
                            children: [
                              // iOS 26: Top highlight for glass light refraction
                              Positioned(
                                top: 0,
                                left: 0,
                                right: 0,
                                height: 60,
                                child: Container(
                                  decoration: BoxDecoration(
                                    borderRadius: const BorderRadius.vertical(
                                      top: Radius.circular(28),
                                    ),
                                    gradient: LinearGradient(
                                      begin: Alignment.topCenter,
                                      end: Alignment.bottomCenter,
                                      colors: [
                                        Colors.white.withValues(alpha: 0.12),
                                        Colors.white.withValues(alpha: 0.0),
                                      ],
                                    ),
                                  ),
                                ),
                              ),
                              // Content
                              Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    // Header: Label + Badge
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Row(
                          children: [
                            Container(
                              width: 8,
                              height: 8,
                              decoration: BoxDecoration(
                                color: isHealthy
                                    ? context.appColors.success
                                    : context.appColors.error,
                                shape: BoxShape.circle,
                                boxShadow: [
                                  BoxShadow(
                                    color:
                                        (isHealthy
                                                ? context.appColors.success
                                                : context.appColors.error)
                                            .withValues(alpha: 0.5),
                                    blurRadius: 8,
                                    spreadRadius: 1,
                                  ),
                                ],
                              ),
                            ),
                            const SizedBox(width: 10),
                            Text(
                              l10n.netBalance.toUpperCase(),
                              style: TextStyle(
                                fontSize: 12,
                                fontWeight: FontWeight.w600,
                                letterSpacing: 1.2,
                                color: context.appColors.textSecondary,
                              ),
                            ),
                          ],
                        ),
                        if (widget.incomeSourceCount > 0)
                          ShimmerEffect(
                            duration: const Duration(milliseconds: 3000),
                            child: Container(
                              padding: const EdgeInsets.symmetric(
                                horizontal: 12,
                                vertical: 6,
                              ),
                              decoration: BoxDecoration(
                                color: context.appColors.primary.withValues(
                                  alpha: 0.15,
                                ),
                                borderRadius: BorderRadius.circular(8),
                                border: Border.all(
                                  color: context.appColors.primary.withValues(
                                    alpha: 0.3,
                                  ),
                                  width: 1,
                                ),
                              ),
                              child: Row(
                                mainAxisSize: MainAxisSize.min,
                                children: [
                                  Icon(
                                    CupertinoIcons.creditcard_fill,
                                    size: 14,
                                    color: context.appColors.primary,
                                  ),
                                  const SizedBox(width: 6),
                                  Text(
                                    l10n.sources(widget.incomeSourceCount),
                                    style: TextStyle(
                                      fontSize: 12,
                                      fontWeight: FontWeight.w600,
                                      color: context.appColors.primary,
                                    ),
                                  ),
                                ],
                              ),
                            ),
                          ),
                      ],
                    ),

                    const SizedBox(
                      height: 24,
                    ), // Design System: section spacing
                    // Big Balance Number with BreatheGlow - HERO ELEMENT
                    BreatheGlow(
                      glowColor: PremiumColors.purple,
                      blurRadius: 48, // Enhanced glow
                      minOpacity: 0.3,
                      maxOpacity: 0.6,
                      child: Row(
                        crossAxisAlignment: CrossAxisAlignment.end,
                        children: [
                          // Design System: fontSize 52, w700, letterSpacing -1, Space Grotesk
                          // FittedBox ensures text scales down if needed
                          Flexible(
                            child: FittedBox(
                              fit: BoxFit.scaleDown,
                              alignment: Alignment.centerLeft,
                              child: Text(
                                formatTurkishCurrency(
                                  currencyProvider.convertFromTRY(
                                    animatedNetBalance.abs(),
                                  ),
                                  decimalDigits: 0,
                                  showDecimals: false,
                                ),
                                style:
                                    AccessibleText.scaled(
                                      context,
                                      fontSize: 52,
                                      fontWeight: FontWeight.w700,
                                      maxScale:
                                          1.2, // Limit scale for hero numbers
                                    ).copyWith(
                                      fontFamily:
                                          AppFonts.heading, // Space Grotesk
                                      letterSpacing: -1,
                                      color: isHealthy
                                          ? Colors.white
                                          : context.appColors.error,
                                      height: 1,
                                      shadows: [
                                        Shadow(
                                          color:
                                              (isHealthy
                                                      ? PremiumColors.purple
                                                      : context.appColors.error)
                                                  .withValues(alpha: 0.4),
                                          blurRadius: 20,
                                        ),
                                      ],
                                    ),
                              ),
                            ),
                          ),
                          const SizedBox(width: 10),
                          Padding(
                            padding: const EdgeInsets.only(bottom: 10),
                            child: Text(
                              currencyProvider.symbol,
                              style: AccessibleText.scaled(
                                context,
                                fontSize: 20,
                                fontWeight: FontWeight.w600,
                                color: context.appColors.textSecondary
                                    .withValues(alpha: 0.8),
                                maxScale: 1.3,
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),

                    const SizedBox(height: 20),

                    // Percentage badge - with glow effect
                    Row(
                      children: [
                        Container(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 14,
                            vertical: 10,
                          ),
                          decoration: BoxDecoration(
                            color:
                                (isHealthy
                                        ? context.appColors.success
                                        : context.appColors.error)
                                    .withValues(alpha: 0.12),
                            borderRadius: BorderRadius.circular(16),
                            border: Border.all(
                              color:
                                  (isHealthy
                                          ? context.appColors.success
                                          : context.appColors.error)
                                      .withValues(alpha: 0.25),
                              width: 1,
                            ),
                            boxShadow: [
                              BoxShadow(
                                color:
                                    (isHealthy
                                            ? context.appColors.success
                                            : context.appColors.error)
                                        .withValues(alpha: 0.2),
                                blurRadius: 16,
                                spreadRadius: 0,
                              ),
                            ],
                          ),
                          child: Row(
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              Icon(
                                isHealthy
                                    ? CupertinoIcons.arrow_up_right
                                    : CupertinoIcons.arrow_down_right,
                                size: 18,
                                color: isHealthy
                                    ? context.appColors.success
                                    : context.appColors.error,
                                shadows: PremiumShadows.iconHalo(
                                  isHealthy
                                      ? context.appColors.success
                                      : context.appColors.error,
                                ),
                              ),
                              const SizedBox(width: 8),
                              Text(
                                '${animatedRemaining.toStringAsFixed(0)}%',
                                style: TextStyle(
                                  fontSize: 16,
                                  fontWeight: FontWeight.w700,
                                  letterSpacing: 0.5,
                                  color: isHealthy
                                      ? context.appColors.success
                                      : context.appColors.error,
                                ),
                              ),
                            ],
                          ),
                        ),
                      ],
                    ),

                    const SizedBox(
                      height: 24,
                    ), // Design System: section spacing
                    // Progress Bar with LevelProgressBar
                    _buildProgressBar(l10n, currencyProvider),

                    const SizedBox(
                      height: 24,
                    ), // Design System: section spacing
                    // Income / Expense - Mirror Layout with GradientBorder
                                _buildIncomeExpenseRow(
                                  l10n,
                                  animatedIncome,
                                  animatedSpent,
                                  currencyProvider,
                                ),
                              ],
                            ),
                          ],
                        ),
                      ),
                    ),
                  ),
                );
              },
            ),
          ),
        ),
      );
      },
    );
  }

  Widget _buildProgressBar(
    AppLocalizations l10n,
    CurrencyProvider currencyProvider,
  ) {
    // Budget-based values when available
    final double displaySpent;
    final double displayBudget;

    if (_hasBudgetData) {
      displaySpent = currencyProvider.convertFromTRY(
        widget.discretionarySpent!,
      );
      displayBudget = currencyProvider.convertFromTRY(widget.availableBudget!);
    } else {
      displaySpent = currencyProvider.convertFromTRY(widget.totalSpent);
      displayBudget = currencyProvider.convertFromTRY(widget.totalIncome);
    }

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text(
              l10n.budgetUsage.toUpperCase(),
              style: TextStyle(
                fontSize: 11,
                fontWeight: FontWeight.w600,
                letterSpacing: 1.2,
                color: context.appColors.textTertiary,
              ),
            ),
            // Percentage badge with shimmer
            ShimmerEffect(
              duration: const Duration(milliseconds: 2500),
              child: Container(
                padding: const EdgeInsets.symmetric(
                  horizontal: 10,
                  vertical: 4,
                ),
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    colors: [
                      PremiumColors.purple.withValues(alpha: 0.3),
                      PremiumColors.gradientEnd.withValues(alpha: 0.2),
                    ],
                  ),
                  borderRadius: BorderRadius.circular(8),
                  border: Border.all(
                    color: PremiumColors.purple.withValues(alpha: 0.4),
                    width: 1,
                  ),
                ),
                child: Text(
                  '${spentPercent.toStringAsFixed(0)}%',
                  style: const TextStyle(
                    fontSize: 12,
                    fontWeight: FontWeight.w700,
                    color: Colors.white,
                  ),
                ),
              ),
            ),
          ],
        ),
        const SizedBox(height: 12),
        // Premium Level Progress Bar
        LevelProgressBar(
          progress: (spentPercent / 100).clamp(0.0, 1.0),
          height: 10,
          showShimmer: true,
        ),
        const SizedBox(height: 10),
        // Budget numbers
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text(
              formatTurkishCurrency(
                displaySpent,
                decimalDigits: 0,
                showDecimals: false,
              ),
              style: TextStyle(
                fontSize: 13,
                fontWeight: FontWeight.w600,
                color: context.appColors.textSecondary,
              ),
            ),
            Text(
              formatTurkishCurrency(
                displayBudget,
                decimalDigits: 0,
                showDecimals: false,
              ),
              style: TextStyle(
                fontSize: 13,
                fontWeight: FontWeight.w500,
                color: context.appColors.textTertiary,
              ),
            ),
          ],
        ),
      ],
    );
  }

  Widget _buildIncomeExpenseRow(
    AppLocalizations l10n,
    double income,
    double spent,
    CurrencyProvider currencyProvider,
  ) {
    final incomeConverted = currencyProvider.convertFromTRY(income);
    final spentConverted = currencyProvider.convertFromTRY(spent);

    // Symmetric layout constants
    const double iconSize = 48;
    const double iconBorderRadius = 14;
    const double iconInnerSize = 24;
    const double labelFontSize = 12;
    const double amountFontSize = 28;

    return LayoutBuilder(
      builder: (context, constraints) {
        // Responsive font size for very small screens
        final responsiveAmountSize = constraints.maxWidth < 300
            ? 22.0
            : amountFontSize;

        return GradientBorder(
          borderWidth: 1.5,
          borderRadius: 20, // Design System: consistent border radius
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: [
              Colors.white.withValues(alpha: 0.2),
              PremiumColors.purple.withValues(alpha: 0.5),
              Colors.white.withValues(alpha: 0.15),
            ],
          ),
          child: Padding(
            padding: const EdgeInsets.all(20), // Design System: 20px padding
            child: Row(
              children: [
                // Income - Sol taraf (Label → Arrow → Amount vertical layout)
                Expanded(
                  child: Column(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      // Label on top
                      Text(
                        l10n.income.toUpperCase(),
                        maxLines: 1,
                        overflow: TextOverflow.ellipsis,
                        style: TextStyle(
                          fontSize: labelFontSize,
                          fontWeight: FontWeight.w600,
                          letterSpacing: 1.2,
                          color: context.appColors.textTertiary,
                        ),
                      ),
                      const SizedBox(height: 8),
                      // Arrow icon in middle
                      Container(
                        width: iconSize,
                        height: iconSize,
                        decoration: BoxDecoration(
                          color: context.appColors.success.withValues(
                            alpha: 0.15,
                          ),
                          borderRadius: BorderRadius.circular(iconBorderRadius),
                          boxShadow: PremiumShadows.coloredGlow(
                            context.appColors.success,
                            intensity: 0.6,
                          ),
                        ),
                        child: Icon(
                          CupertinoIcons.arrow_down,
                          size: iconInnerSize,
                          color: context.appColors.success,
                          shadows: PremiumShadows.iconHalo(
                            context.appColors.success,
                          ),
                        ),
                      ),
                      const SizedBox(height: 8),
                      // Amount at bottom
                      FittedBox(
                        fit: BoxFit.scaleDown,
                        child: Text(
                          formatTurkishCurrency(
                            incomeConverted,
                            decimalDigits: 0,
                            showDecimals: false,
                          ),
                          style: TextStyle(
                            fontSize: responsiveAmountSize,
                            fontWeight: FontWeight.w700,
                            letterSpacing: -0.5,
                            color: Colors.white,
                            shadows: [
                              Shadow(
                                color: context.appColors.success.withValues(
                                  alpha: 0.4,
                                ),
                                blurRadius: 16,
                              ),
                            ],
                          ),
                        ),
                      ),
                    ],
                  ),
                ),

                // Dikey Divider - subtle gradient
                Container(
                  width: 1,
                  height: 80,
                  margin: const EdgeInsets.symmetric(horizontal: 16),
                  decoration: BoxDecoration(
                    gradient: LinearGradient(
                      begin: Alignment.topCenter,
                      end: Alignment.bottomCenter,
                      colors: [
                        Colors.white.withValues(alpha: 0.0),
                        Colors.white.withValues(alpha: 0.15),
                        Colors.white.withValues(alpha: 0.0),
                      ],
                    ),
                  ),
                ),

                // Expense - Sağ taraf (Label → Arrow → Amount vertical layout)
                Expanded(
                  child: Column(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      // Label on top
                      Text(
                        l10n.expense.toUpperCase(),
                        maxLines: 1,
                        overflow: TextOverflow.ellipsis,
                        style: TextStyle(
                          fontSize: labelFontSize,
                          fontWeight: FontWeight.w600,
                          letterSpacing: 1.2,
                          color: context.appColors.textTertiary,
                        ),
                      ),
                      const SizedBox(height: 8),
                      // Arrow icon in middle
                      Container(
                        width: iconSize,
                        height: iconSize,
                        decoration: BoxDecoration(
                          color: context.appColors.error.withValues(
                            alpha: 0.15,
                          ),
                          borderRadius: BorderRadius.circular(iconBorderRadius),
                          boxShadow: PremiumShadows.coloredGlow(
                            context.appColors.error,
                            intensity: 0.6,
                          ),
                        ),
                        child: Icon(
                          CupertinoIcons.arrow_up,
                          size: iconInnerSize,
                          color: context.appColors.error,
                          shadows: PremiumShadows.iconHalo(
                            context.appColors.error,
                          ),
                        ),
                      ),
                      const SizedBox(height: 8),
                      // Amount at bottom
                      FittedBox(
                        fit: BoxFit.scaleDown,
                        child: Text(
                          formatTurkishCurrency(
                            spentConverted,
                            decimalDigits: 0,
                            showDecimals: false,
                          ),
                          style: TextStyle(
                            fontSize: responsiveAmountSize,
                            fontWeight: FontWeight.w700,
                            letterSpacing: -0.5,
                            color: Colors.white,
                            shadows: [
                              Shadow(
                                color: context.appColors.error.withValues(
                                  alpha: 0.4,
                                ),
                                blurRadius: 16,
                              ),
                            ],
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
        );
      },
    );
  }
}

/// Kompakt Financial Snapshot - Header'da kullanım için
class CompactFinancialBadge extends StatelessWidget {
  final double netBalance;
  final double spentPercent;
  final VoidCallback? onTap;

  const CompactFinancialBadge({
    super.key,
    required this.netBalance,
    required this.spentPercent,
    this.onTap,
  });

  bool get isHealthy => netBalance >= 0;

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(24),
          boxShadow: [
            // Subtle glow
            BoxShadow(
              color: (isHealthy
                      ? context.appColors.success
                      : context.appColors.error)
                  .withValues(alpha: 0.3),
              blurRadius: 16,
              spreadRadius: 0,
            ),
          ],
        ),
        child: ClipRRect(
          borderRadius: BorderRadius.circular(24),
          child: BackdropFilter(
            // iOS 26: Enhanced blur
            filter: ImageFilter.blur(sigmaX: 20, sigmaY: 20),
            child: Container(
              padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 8),
              decoration: BoxDecoration(
                // iOS 26 Liquid Glass gradient
                gradient: LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: [
                    Colors.white.withValues(alpha: 0.08),
                    Colors.white.withValues(alpha: 0.04),
                  ],
                ),
                borderRadius: BorderRadius.circular(24),
                border: Border.all(
                  color: (isHealthy
                          ? context.appColors.success
                          : context.appColors.error)
                      .withValues(alpha: 0.35),
                  width: 1,
                ),
              ),
            child: Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                Container(
                  width: 6,
                  height: 6,
                  decoration: BoxDecoration(
                    color: isHealthy
                        ? context.appColors.success
                        : context.appColors.error,
                    shape: BoxShape.circle,
                  ),
                ),
                const SizedBox(width: 8),
                Text(
                  formatTurkishCurrency(
                    netBalance.abs(),
                    decimalDigits: 0,
                    showDecimals: false,
                  ),
                  style: TextStyle(
                    fontSize: 14,
                    fontWeight: FontWeight.w600,
                    color: context.appColors.textPrimary,
                  ),
                ),
                const SizedBox(width: 6),
                Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 6,
                    vertical: 2,
                  ),
                  decoration: BoxDecoration(
                    color: _getPercentColor(context).withValues(alpha: 0.15),
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Text(
                    '${spentPercent.toStringAsFixed(0)}%',
                    style: TextStyle(
                      fontSize: 11,
                      fontWeight: FontWeight.w600,
                      color: _getPercentColor(context),
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
      ),
    );
  }

  Color _getPercentColor(BuildContext context) {
    if (spentPercent < 50) return context.appColors.success;
    if (spentPercent < 75) return context.appColors.warning;
    return context.appColors.error;
  }
}


--- FILE: lib/widgets/budget_shift_dialog.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/savings_pool.dart';
import '../providers/savings_pool_provider.dart';
import '../theme/theme.dart';
import '../utils/currency_utils.dart';

/// Bütçe kaydırma diyaloğu
/// Kullanıcı havuzda yetersiz bakiye olduğunda hangi bütçeden kaydıracağını seçer
class BudgetShiftDialog extends StatefulWidget {
  final double shortfall; // Eksik tutar
  final double totalAmount; // Toplam istenen tutar
  final String dreamId;
  final String dreamName;
  final String currencySymbol;

  const BudgetShiftDialog({
    super.key,
    required this.shortfall,
    required this.totalAmount,
    required this.dreamId,
    required this.dreamName,
    required this.currencySymbol,
  });

  /// Diyaloğu göster ve sonucu döndür
  static Future<BudgetShiftResult?> show({
    required BuildContext context,
    required double shortfall,
    required double totalAmount,
    required String dreamId,
    required String dreamName,
    required String currencySymbol,
  }) {
    return showModalBottomSheet<BudgetShiftResult>(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      builder: (context) => BudgetShiftDialog(
        shortfall: shortfall,
        totalAmount: totalAmount,
        dreamId: dreamId,
        dreamName: dreamName,
        currencySymbol: currencySymbol,
      ),
    );
  }

  @override
  State<BudgetShiftDialog> createState() => _BudgetShiftDialogState();
}

class _BudgetShiftDialogState extends State<BudgetShiftDialog> {
  BudgetShiftSource? _selectedSource;
  bool _isLoading = false;

  List<_BudgetOption> get _options {
    final l10n = AppLocalizations.of(context);
    final pool = context.read<SavingsPoolProvider>();

    return [
      _BudgetOption(
        source: BudgetShiftSource.food,
        emoji: '🍔',
        label: l10n.budgetShiftFromFood,
      ),
      _BudgetOption(
        source: BudgetShiftSource.entertainment,
        emoji: '🎬',
        label: l10n.budgetShiftFromEntertainment,
      ),
      _BudgetOption(
        source: BudgetShiftSource.clothing,
        emoji: '👕',
        label: l10n.budgetShiftFromClothing,
      ),
      _BudgetOption(
        source: BudgetShiftSource.transport,
        emoji: '🚗',
        label: l10n.budgetShiftFromTransport,
      ),
      _BudgetOption(
        source: BudgetShiftSource.shopping,
        emoji: '🛒',
        label: l10n.budgetShiftFromShopping,
      ),
      _BudgetOption(
        source: BudgetShiftSource.extraIncome,
        emoji: '💰',
        label: l10n.extraIncome,
        isHighlighted: true,
      ),
      if (pool.canUseJoker)
        _BudgetOption(
          source: BudgetShiftSource.joker,
          emoji: '🃏',
          label: l10n.useJoker,
          isJoker: true,
        ),
    ];
  }

  Future<void> _confirm() async {
    if (_selectedSource == null) return;

    setState(() => _isLoading = true);

    final poolProvider = context.read<SavingsPoolProvider>();

    // Allocation yap
    final result = await poolProvider.allocateToDream(
      widget.totalAmount,
      widget.dreamId,
      source: _selectedSource,
    );

    if (!mounted) return;

    setState(() => _isLoading = false);

    if (result.isSuccess) {
      HapticFeedback.mediumImpact();
      Navigator.pop(
        context,
        BudgetShiftResult(
          success: true,
          source: _selectedSource!,
          amount: widget.shortfall,
        ),
      );
    } else if (result.isJokerAlreadyUsed) {
      _showError(AppLocalizations.of(context).jokerUsed);
    } else {
      _showError(result.errorMessage ?? 'Error');
    }
  }

  void _showError(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: context.appColors.error,
        behavior: SnackBarBehavior.floating,
      ),
    );
  }

  void _createDebt() async {
    setState(() => _isLoading = true);

    final poolProvider = context.read<SavingsPoolProvider>();
    await poolProvider.createShadowDebt(widget.totalAmount, widget.dreamId);

    if (!mounted) return;

    setState(() => _isLoading = false);

    HapticFeedback.heavyImpact();
    Navigator.pop(
      context,
      BudgetShiftResult(
        success: true,
        source: null,
        amount: widget.shortfall,
        isDebt: true,
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final bottomPadding = MediaQuery.of(context).viewInsets.bottom;

    return Container(
      margin: EdgeInsets.only(bottom: bottomPadding),
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
      ),
      child: SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(24),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Handle
              Center(
                child: Container(
                  width: 40,
                  height: 4,
                  decoration: BoxDecoration(
                    color: context.appColors.textTertiary,
                    borderRadius: BorderRadius.circular(2),
                  ),
                ),
              ),
              const SizedBox(height: 24),

              // Dream icon & name
              Row(
                children: [
                  Container(
                    width: 48,
                    height: 48,
                    decoration: BoxDecoration(
                      color: context.appColors.primary.withValues(alpha: 0.1),
                      borderRadius: BorderRadius.circular(16),
                    ),
                    child: const Center(
                      child: Text('✨', style: TextStyle(fontSize: 24)),
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          widget.dreamName,
                          style: TextStyle(
                            fontSize: 16,
                            fontWeight: FontWeight.w600,
                            color: context.appColors.textPrimary,
                          ),
                        ),
                        Text(
                          '${widget.currencySymbol}${formatTurkishCurrency(widget.totalAmount, decimalDigits: 0, showDecimals: false)} ekleniyor',
                          style: TextStyle(
                            fontSize: 13,
                            color: context.appColors.textSecondary,
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 24),

              // Question
              Text(
                l10n.budgetShiftQuestion(
                  '${widget.currencySymbol}${formatTurkishCurrency(widget.shortfall, decimalDigits: 0, showDecimals: false)}',
                ),
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.w700,
                  color: context.appColors.textPrimary,
                ),
              ),
              const SizedBox(height: 8),
              Text(
                'Havuzda yeterli bakiye yok. Bu parayı nereden kaydırmak istersin?',
                style: TextStyle(
                  fontSize: 14,
                  color: context.appColors.textSecondary,
                ),
              ),
              const SizedBox(height: 20),

              // Options
              Wrap(
                spacing: 10,
                runSpacing: 10,
                children: _options.map((option) {
                  final isSelected = _selectedSource == option.source;
                  return GestureDetector(
                    onTap: () {
                      HapticFeedback.selectionClick();
                      setState(() => _selectedSource = option.source);
                    },
                    child: AnimatedContainer(
                      duration: const Duration(milliseconds: 200),
                      padding: const EdgeInsets.symmetric(
                        horizontal: 14,
                        vertical: 12,
                      ),
                      decoration: BoxDecoration(
                        color: isSelected
                            ? (option.isJoker
                                  ? context.appColors.warning.withValues(
                                      alpha: 0.15,
                                    )
                                  : context.appColors.primary.withValues(
                                      alpha: 0.15,
                                    ))
                            : context.appColors.surfaceLight,
                        borderRadius: BorderRadius.circular(16),
                        border: Border.all(
                          color: isSelected
                              ? (option.isJoker
                                    ? context.appColors.warning
                                    : context.appColors.primary)
                              : context.appColors.cardBorder,
                          width: isSelected ? 2 : 1,
                        ),
                      ),
                      child: Row(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          Text(
                            option.emoji,
                            style: const TextStyle(fontSize: 18),
                          ),
                          const SizedBox(width: 8),
                          Text(
                            option.label,
                            style: TextStyle(
                              fontSize: 14,
                              fontWeight: isSelected
                                  ? FontWeight.w600
                                  : FontWeight.w500,
                              color: isSelected
                                  ? (option.isJoker
                                        ? context.appColors.warning
                                        : context.appColors.primary)
                                  : context.appColors.textPrimary,
                            ),
                          ),
                        ],
                      ),
                    ),
                  );
                }).toList(),
              ),

              const SizedBox(height: 24),

              // Confirm button
              SizedBox(
                width: double.infinity,
                child: ElevatedButton(
                  onPressed: _selectedSource != null && !_isLoading
                      ? _confirm
                      : null,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: context.appColors.primary,
                    foregroundColor: Colors.white,
                    padding: const EdgeInsets.symmetric(vertical: 16),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(16),
                    ),
                    disabledBackgroundColor: context.appColors.surfaceLight,
                  ),
                  child: _isLoading
                      ? const SizedBox(
                          width: 20,
                          height: 20,
                          child: CircularProgressIndicator(
                            strokeWidth: 2,
                            color: Colors.white,
                          ),
                        )
                      : const Text(
                          'Onayla',
                          style: TextStyle(
                            fontSize: 16,
                            fontWeight: FontWeight.w600,
                          ),
                        ),
                ),
              ),

              const SizedBox(height: 12),

              // Create debt option
              Center(
                child: TextButton.icon(
                  onPressed: _isLoading ? null : _createDebt,
                  icon: Icon(
                    CupertinoIcons.exclamationmark_triangle,
                    size: 18,
                    color: context.appColors.error,
                  ),
                  label: Text(
                    l10n.createShadowDebt,
                    style: TextStyle(
                      fontSize: 14,
                      color: context.appColors.error,
                    ),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class _BudgetOption {
  final BudgetShiftSource source;
  final String emoji;
  final String label;
  final bool isHighlighted;
  final bool isJoker;

  const _BudgetOption({
    required this.source,
    required this.emoji,
    required this.label,
    this.isHighlighted = false,
    this.isJoker = false,
  });
}

/// Budget shift sonucu
class BudgetShiftResult {
  final bool success;
  final BudgetShiftSource? source;
  final double amount;
  final bool isDebt;

  const BudgetShiftResult({
    required this.success,
    this.source,
    required this.amount,
    this.isDebt = false,
  });
}


--- FILE: lib/widgets/animated_bottom_sheet.dart ---

import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import '../theme/theme.dart';

/// Animasyonlu bottom sheet
/// Açılırken: backdrop blur + karartma + slideUp + scale
/// Kapanırken: aynı animasyonun tersi
class AnimatedBottomSheet extends StatefulWidget {
  final Widget child;
  final double? initialHeight;
  final double? maxHeight;
  final bool showDragHandle;
  final VoidCallback? onClose;

  const AnimatedBottomSheet({
    super.key,
    required this.child,
    this.initialHeight,
    this.maxHeight,
    this.showDragHandle = true,
    this.onClose,
  });

  /// Bottom sheet'i göster
  static Future<T?> show<T>({
    required BuildContext context,
    required Widget child,
    double? initialHeight,
    double? maxHeight,
    bool showDragHandle = true,
    bool isDismissible = true,
    bool enableDrag = true,
  }) {
    return showModalBottomSheet<T>(
      context: context,
      isScrollControlled: true,
      isDismissible: isDismissible,
      enableDrag: enableDrag,
      backgroundColor: Colors.transparent,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      builder: (context) => _AnimatedBottomSheetWrapper(
        initialHeight: initialHeight,
        maxHeight: maxHeight,
        showDragHandle: showDragHandle,
        child: child,
      ),
    );
  }

  @override
  State<AnimatedBottomSheet> createState() => _AnimatedBottomSheetState();
}

class _AnimatedBottomSheetState extends State<AnimatedBottomSheet> {
  @override
  Widget build(BuildContext context) {
    return Container(
      constraints: BoxConstraints(
        maxHeight: widget.maxHeight ?? MediaQuery.of(context).size.height * 0.9,
      ),
      decoration: BoxDecoration(
        color: context.appColors.surface.withValues(alpha: 0.95),
        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
      ),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          if (widget.showDragHandle)
            Container(
              margin: const EdgeInsets.only(top: 12, bottom: 8),
              width: 40,
              height: 4,
              decoration: BoxDecoration(
                color: context.appColors.textTertiary.withValues(alpha: 0.3),
                borderRadius: BorderRadius.circular(2),
              ),
            ),
          Flexible(child: widget.child),
        ],
      ),
    );
  }
}

class _AnimatedBottomSheetWrapper extends StatefulWidget {
  final Widget child;
  final double? initialHeight;
  final double? maxHeight;
  final bool showDragHandle;

  const _AnimatedBottomSheetWrapper({
    required this.child,
    this.initialHeight,
    this.maxHeight,
    this.showDragHandle = true,
  });

  @override
  State<_AnimatedBottomSheetWrapper> createState() =>
      _AnimatedBottomSheetWrapperState();
}

class _AnimatedBottomSheetWrapperState
    extends State<_AnimatedBottomSheetWrapper>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _slideAnimation;
  late Animation<double> _scaleAnimation;
  late Animation<double> _blurAnimation;
  late Animation<double> _backdropAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: AppAnimations.medium,
    );

    _slideAnimation = Tween<double>(begin: 1.0, end: 0.0).animate(
      CurvedAnimation(parent: _controller, curve: AppAnimations.standardCurve),
    );

    _scaleAnimation = Tween<double>(begin: 0.98, end: 1.0).animate(
      CurvedAnimation(parent: _controller, curve: AppAnimations.standardCurve),
    );

    _blurAnimation = Tween<double>(begin: 0.0, end: AppAnimations.backdropBlur)
        .animate(
          CurvedAnimation(
            parent: _controller,
            curve: AppAnimations.standardCurve,
          ),
        );

    _backdropAnimation =
        Tween<double>(begin: 0.0, end: AppAnimations.backdropOpacity).animate(
          CurvedAnimation(
            parent: _controller,
            curve: AppAnimations.standardCurve,
          ),
        );

    _controller.forward();
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: _controller,
      builder: (context, child) {
        return Stack(
          children: [
            // Backdrop with blur
            Positioned.fill(
              child: GestureDetector(
                onTap: () => Navigator.of(context).pop(),
                child: BackdropFilter(
                  filter: ImageFilter.blur(
                    sigmaX: _blurAnimation.value,
                    sigmaY: _blurAnimation.value,
                  ),
                  child: Container(
                    color: Colors.black.withValues(
                      alpha: _backdropAnimation.value,
                    ),
                  ),
                ),
              ),
            ),

            // Sheet
            Positioned(
              left: 0,
              right: 0,
              bottom: 0,
              child: Transform.translate(
                offset: Offset(
                  0,
                  _slideAnimation.value * AppAnimations.sheetSlideOffset.dy,
                ),
                child: Transform.scale(
                  scale: _scaleAnimation.value,
                  alignment: Alignment.bottomCenter,
                  child: AnimatedBottomSheet(
                    initialHeight: widget.initialHeight,
                    maxHeight: widget.maxHeight,
                    showDragHandle: widget.showDragHandle,
                    child: widget.child,
                  ),
                ),
              ),
            ),
          ],
        );
      },
    );
  }
}

/// Modal dialog için wrapper
class AnimatedModal extends StatefulWidget {
  final Widget child;
  final bool showCloseButton;
  final VoidCallback? onClose;

  const AnimatedModal({
    super.key,
    required this.child,
    this.showCloseButton = true,
    this.onClose,
  });

  static Future<T?> show<T>({
    required BuildContext context,
    required Widget child,
    bool showCloseButton = true,
    bool barrierDismissible = true,
  }) {
    return showGeneralDialog<T>(
      context: context,
      barrierDismissible: barrierDismissible,
      barrierLabel: 'Dismiss',
      barrierColor: Colors.black.withValues(alpha: 0.85),
      transitionDuration: AppAnimations.medium,
      pageBuilder: (context, animation, secondaryAnimation) {
        return _AnimatedModalWrapper(
          animation: animation,
          showCloseButton: showCloseButton,
          child: child,
        );
      },
    );
  }

  @override
  State<AnimatedModal> createState() => _AnimatedModalState();
}

class _AnimatedModalState extends State<AnimatedModal> {
  @override
  Widget build(BuildContext context) {
    return Container(
      margin: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(24),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withValues(alpha: 0.3),
            blurRadius: 20,
            spreadRadius: 0,
          ),
        ],
      ),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          if (widget.showCloseButton)
            Align(
              alignment: Alignment.topRight,
              child: IconButton(
                icon: Icon(
                  CupertinoIcons.xmark,
                  color: context.appColors.textSecondary,
                ),
                tooltip: MaterialLocalizations.of(context).closeButtonTooltip,
                onPressed: widget.onClose ?? () => Navigator.of(context).pop(),
              ),
            ),
          widget.child,
        ],
      ),
    );
  }
}

class _AnimatedModalWrapper extends StatelessWidget {
  final Animation<double> animation;
  final Widget child;
  final bool showCloseButton;

  const _AnimatedModalWrapper({
    required this.animation,
    required this.child,
    this.showCloseButton = true,
  });

  @override
  Widget build(BuildContext context) {
    final curvedAnimation = CurvedAnimation(
      parent: animation,
      curve: AppAnimations.standardCurve,
    );

    return AnimatedBuilder(
      animation: curvedAnimation,
      builder: (context, _) {
        return Stack(
          children: [
            // Backdrop
            Positioned.fill(
              child: GestureDetector(
                onTap: () => Navigator.of(context).pop(),
                child: BackdropFilter(
                  filter: ImageFilter.blur(
                    sigmaX: curvedAnimation.value * AppAnimations.backdropBlur,
                    sigmaY: curvedAnimation.value * AppAnimations.backdropBlur,
                  ),
                  child: Container(
                    color: Colors.black.withValues(
                      alpha:
                          curvedAnimation.value * AppAnimations.backdropOpacity,
                    ),
                  ),
                ),
              ),
            ),

            // Modal
            Center(
              child: Transform.scale(
                scale: 0.8 + (0.2 * curvedAnimation.value),
                child: Opacity(
                  opacity: curvedAnimation.value,
                  child: AnimatedModal(
                    showCloseButton: showCloseButton,
                    child: child,
                  ),
                ),
              ),
            ),
          ],
        );
      },
    );
  }
}


--- FILE: lib/widgets/subscription_calendar_view.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';
import '../theme/theme.dart';

/// Abonelik takvim görünümü
/// Her ayın hangi gününde hangi aboneliklerin yenilendiğini gösterir
class SubscriptionCalendarView extends StatefulWidget {
  final List<Subscription> subscriptions;
  final Function(int day, List<Subscription> subscriptions) onDayTap;

  const SubscriptionCalendarView({
    super.key,
    required this.subscriptions,
    required this.onDayTap,
  });

  @override
  State<SubscriptionCalendarView> createState() =>
      _SubscriptionCalendarViewState();
}

class _SubscriptionCalendarViewState extends State<SubscriptionCalendarView> {
  late DateTime _currentMonth;
  late Map<int, List<Subscription>> _subscriptionsByDay;

  List<String> _getWeekDays(AppLocalizations l10n) => [
    l10n.weekdayMon,
    l10n.weekdayTue,
    l10n.weekdayWed,
    l10n.weekdayThu,
    l10n.weekdayFri,
    l10n.weekdaySat,
    l10n.weekdaySun,
  ];

  List<String> _getMonthNames(AppLocalizations l10n) => [
    '',
    l10n.monthJan,
    l10n.monthFeb,
    l10n.monthMar,
    l10n.monthApr,
    l10n.monthMay,
    l10n.monthJun,
    l10n.monthJul,
    l10n.monthAug,
    l10n.monthSep,
    l10n.monthOct,
    l10n.monthNov,
    l10n.monthDec,
  ];

  @override
  void initState() {
    super.initState();
    _currentMonth = DateTime(DateTime.now().year, DateTime.now().month, 1);
    _updateSubscriptionsByDay();
  }

  @override
  void didUpdateWidget(SubscriptionCalendarView oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (oldWidget.subscriptions != widget.subscriptions) {
      _updateSubscriptionsByDay();
    }
  }

  void _updateSubscriptionsByDay() {
    _subscriptionsByDay = {};
    for (final sub in widget.subscriptions) {
      final renewalDay = sub.getRenewalDayForMonth(
        _currentMonth.year,
        _currentMonth.month,
      );
      _subscriptionsByDay.putIfAbsent(renewalDay, () => []).add(sub);
    }
  }

  void _previousMonth() {
    HapticFeedback.selectionClick();
    setState(() {
      _currentMonth = DateTime(_currentMonth.year, _currentMonth.month - 1, 1);
      _updateSubscriptionsByDay();
    });
  }

  void _nextMonth() {
    HapticFeedback.selectionClick();
    setState(() {
      _currentMonth = DateTime(_currentMonth.year, _currentMonth.month + 1, 1);
      _updateSubscriptionsByDay();
    });
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final daysInMonth = DateTime(
      _currentMonth.year,
      _currentMonth.month + 1,
      0,
    ).day;
    final firstDayOfWeek = _currentMonth.weekday; // 1 = Monday
    final weekDays = _getWeekDays(l10n);
    final monthNames = _getMonthNames(l10n);

    return Column(
      children: [
        // Month header and navigation
        Padding(
          padding: const EdgeInsets.symmetric(vertical: 8),
          child: Row(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              IconButton(
                onPressed: _previousMonth,
                icon: const Icon(CupertinoIcons.chevron_left),
                color: context.appColors.textSecondary,
              ),
              Text(
                '${monthNames[_currentMonth.month]} ${_currentMonth.year}',
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textPrimary,
                ),
              ),
              IconButton(
                onPressed: _nextMonth,
                icon: const Icon(CupertinoIcons.chevron_right),
                color: context.appColors.textSecondary,
              ),
            ],
          ),
        ),
        const SizedBox(height: 8),

        // Weekday headers
        Row(
          children: weekDays
              .map(
                (day) => Expanded(
                  child: Center(
                    child: Text(
                      day,
                      style: TextStyle(
                        fontSize: 12,
                        fontWeight: FontWeight.w500,
                        color: context.appColors.textTertiary,
                      ),
                    ),
                  ),
                ),
              )
              .toList(),
        ),
        const SizedBox(height: 12),

        // Calendar grid
        _buildCalendarGrid(daysInMonth, firstDayOfWeek),
      ],
    );
  }

  Widget _buildCalendarGrid(int daysInMonth, int firstDayOfWeek) {
    final now = DateTime.now();
    final isCurrentMonth =
        _currentMonth.year == now.year && _currentMonth.month == now.month;

    // Toplam hücre sayısı: önceki aydan boşluklar + bu ayın günleri
    final totalCells = firstDayOfWeek - 1 + daysInMonth;
    final rowCount = (totalCells / 7).ceil();

    return Column(
      children: List.generate(rowCount, (rowIndex) {
        return Padding(
          padding: const EdgeInsets.only(bottom: 8),
          child: Row(
            children: List.generate(7, (colIndex) {
              final cellIndex = rowIndex * 7 + colIndex;
              final dayNumber = cellIndex - (firstDayOfWeek - 2);

              // Önceki aydan veya sonraki aydan boşluk
              if (dayNumber < 1 || dayNumber > daysInMonth) {
                return const Expanded(child: SizedBox(height: 56));
              }

              final isToday = isCurrentMonth && dayNumber == now.day;
              final subs = _subscriptionsByDay[dayNumber] ?? [];

              return Expanded(child: _buildDayCell(dayNumber, isToday, subs));
            }),
          ),
        );
      }),
    );
  }

  Widget _buildDayCell(int day, bool isToday, List<Subscription> subs) {
    final hasSubscriptions = subs.isNotEmpty;

    return GestureDetector(
      onTap: hasSubscriptions
          ? () {
              HapticFeedback.lightImpact();
              widget.onDayTap(day, subs);
            }
          : null,
      child: Container(
        height: 56,
        margin: const EdgeInsets.symmetric(horizontal: 2),
        decoration: BoxDecoration(
          color: isToday
              ? context.appColors.primary.withValues(alpha: 0.2)
              : hasSubscriptions
              ? context.appColors.surface.withValues(alpha: 0.5)
              : Colors.transparent,
          borderRadius: BorderRadius.circular(8),
          border: isToday
              ? Border.all(color: context.appColors.primary, width: 1.5)
              : null,
        ),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            // Gün numarası
            Text(
              '$day',
              style: TextStyle(
                fontSize: 14,
                fontWeight: isToday || hasSubscriptions
                    ? FontWeight.w600
                    : FontWeight.w400,
                color: isToday
                    ? context.appColors.primary
                    : hasSubscriptions
                    ? context.appColors.textPrimary
                    : context.appColors.textTertiary,
              ),
            ),
            if (hasSubscriptions) ...[
              const SizedBox(height: 4),
              // Abonelik renk noktaları
              _buildSubscriptionDots(subs),
            ],
          ],
        ),
      ),
    );
  }

  Widget _buildSubscriptionDots(List<Subscription> subs) {
    // Maksimum 3 nokta göster
    final displaySubs = subs.take(3).toList();
    final hasMore = subs.length > 3;

    return Row(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        ...displaySubs.map(
          (sub) => Container(
            width: 6,
            height: 6,
            margin: const EdgeInsets.symmetric(horizontal: 1),
            decoration: BoxDecoration(color: sub.color, shape: BoxShape.circle),
          ),
        ),
        if (hasMore)
          Container(
            width: 6,
            height: 6,
            margin: const EdgeInsets.symmetric(horizontal: 1),
            decoration: BoxDecoration(
              color: context.appColors.textTertiary,
              shape: BoxShape.circle,
            ),
            child: const Center(
              child: Text(
                '+',
                style: TextStyle(fontSize: 6, color: Colors.white, height: 1),
              ),
            ),
          ),
      ],
    );
  }
}


--- FILE: lib/widgets/pursuit_completion_modal.dart ---

import 'dart:math';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:confetti/confetti.dart';
import 'package:flutter/cupertino.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/pursuit.dart';
import '../theme/quiet_luxury.dart';
import 'package:vantag/theme/app_theme.dart';

/// Celebration modal shown when a pursuit reaches 100%
class PursuitCompletionModal extends StatefulWidget {
  final Pursuit pursuit;
  final String Function(double amount) formatAmount;
  final VoidCallback? onShare;
  final VoidCallback? onDismiss;

  const PursuitCompletionModal({
    super.key,
    required this.pursuit,
    required this.formatAmount,
    this.onShare,
    this.onDismiss,
  });

  @override
  State<PursuitCompletionModal> createState() => _PursuitCompletionModalState();
}

class _PursuitCompletionModalState extends State<PursuitCompletionModal>
    with SingleTickerProviderStateMixin {
  late ConfettiController _confettiController;
  late AnimationController _animationController;
  late Animation<double> _scaleAnimation;
  late Animation<double> _opacityAnimation;

  @override
  void initState() {
    super.initState();

    // Confetti controller
    _confettiController = ConfettiController(
      duration: const Duration(seconds: 3),
    );

    // Animation controller for modal entrance
    _animationController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 600),
    );

    _scaleAnimation = Tween<double>(begin: 0.5, end: 1.0).animate(
      CurvedAnimation(parent: _animationController, curve: Curves.elasticOut),
    );

    _opacityAnimation = Tween<double>(begin: 0.0, end: 1.0).animate(
      CurvedAnimation(
        parent: _animationController,
        curve: const Interval(0.0, 0.5, curve: Curves.easeOut),
      ),
    );

    // Start animations
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _confettiController.play();
      _animationController.forward();
      HapticFeedback.mediumImpact();
    });
  }

  @override
  void dispose() {
    _confettiController.dispose();
    _animationController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final daysSinceCreation = widget.pursuit.daysSinceCreation;

    return Stack(
      children: [
        // Background overlay
        GestureDetector(
          onTap: _dismiss,
          child: AnimatedBuilder(
            animation: _opacityAnimation,
            builder: (context, child) => Container(
              color: Colors.black.withValues(
                alpha: 0.7 * _opacityAnimation.value,
              ),
            ),
          ),
        ),

        // Confetti
        Align(
          alignment: Alignment.topCenter,
          child: ConfettiWidget(
            confettiController: _confettiController,
            blastDirection: pi / 2,
            blastDirectionality: BlastDirectionality.explosive,
            maxBlastForce: 20,
            minBlastForce: 8,
            emissionFrequency: 0.05,
            numberOfParticles: 20,
            gravity: 0.2,
            shouldLoop: false,
            colors: [
              QuietLuxury.gold,
              AppColors.secondary,
              AppColors.primary,
              QuietLuxury.positive,
              Colors.white,
            ],
          ),
        ),

        // Modal content
        Center(
          child: AnimatedBuilder(
            animation: _scaleAnimation,
            builder: (context, child) => Transform.scale(
              scale: _scaleAnimation.value,
              child: Opacity(opacity: _opacityAnimation.value, child: child),
            ),
            child: Container(
              margin: const EdgeInsets.symmetric(horizontal: 24),
              padding: const EdgeInsets.all(24),
              decoration: BoxDecoration(
                color: QuietLuxury.background,
                borderRadius: BorderRadius.circular(24),
                border: Border.all(
                  color: QuietLuxury.gold.withValues(alpha: 0.3),
                  width: 2,
                ),
                boxShadow: [
                  BoxShadow(
                    color: QuietLuxury.gold.withValues(alpha: 0.2),
                    blurRadius: 30,
                    spreadRadius: 5,
                  ),
                ],
              ),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  // Emoji with gold glow
                  Container(
                    width: 100,
                    height: 100,
                    decoration: BoxDecoration(
                      shape: BoxShape.circle,
                      gradient: RadialGradient(
                        colors: [
                          QuietLuxury.gold.withValues(alpha: 0.3),
                          Colors.transparent,
                        ],
                      ),
                    ),
                    child: Center(
                      child: Text(
                        widget.pursuit.emoji,
                        style: const TextStyle(fontSize: 56),
                      ),
                    ),
                  ),
                  const SizedBox(height: 20),

                  // Congratulations text
                  Text(
                    l10n.congratulations,
                    style: QuietLuxury.heading.copyWith(
                      fontSize: 28,
                      color: QuietLuxury.gold,
                    ),
                  ),
                  const SizedBox(height: 8),

                  // Dream came true
                  Text(
                    l10n.pursuitCompleted,
                    style: QuietLuxury.subheading.copyWith(
                      color: QuietLuxury.textPrimary,
                    ),
                    textAlign: TextAlign.center,
                  ),
                  const SizedBox(height: 20),

                  // Stats
                  Container(
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: QuietLuxury.cardBackground,
                      borderRadius: BorderRadius.circular(16),
                      border: Border.all(
                        color: QuietLuxury.cardBorder,
                        width: 0.5,
                      ),
                    ),
                    child: Column(
                      children: [
                        Text(
                          widget.pursuit.name,
                          style: QuietLuxury.body.copyWith(
                            color: QuietLuxury.textPrimary,
                            fontWeight: FontWeight.w600,
                          ),
                          textAlign: TextAlign.center,
                        ),
                        const SizedBox(height: 12),
                        Text(
                          l10n.pursuitCompletedMessage(
                            daysSinceCreation,
                            widget.formatAmount(widget.pursuit.savedAmount),
                          ),
                          style: QuietLuxury.label.copyWith(
                            color: QuietLuxury.textSecondary,
                          ),
                          textAlign: TextAlign.center,
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 24),

                  // Buttons
                  Row(
                    children: [
                      // Share button
                      Expanded(
                        child: OutlinedButton.icon(
                          onPressed: () {
                            widget.onShare?.call();
                          },
                          style: OutlinedButton.styleFrom(
                            foregroundColor: QuietLuxury.textPrimary,
                            side: BorderSide(color: QuietLuxury.cardBorder),
                            padding: const EdgeInsets.symmetric(vertical: 12),
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(16),
                            ),
                          ),
                          icon: Icon(
                            CupertinoIcons.share,
                            size: 18,
                          ),
                          label: Text(l10n.shareProgress),
                        ),
                      ),
                      const SizedBox(width: 12),
                      // Done button
                      Expanded(
                        child: ElevatedButton(
                          onPressed: _dismiss,
                          style: ElevatedButton.styleFrom(
                            backgroundColor: QuietLuxury.gold,
                            foregroundColor: Colors.black,
                            padding: const EdgeInsets.symmetric(vertical: 12),
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(16),
                            ),
                          ),
                          child: Text(
                            l10n.great,
                            style: const TextStyle(fontWeight: FontWeight.w600),
                          ),
                        ),
                      ),
                    ],
                  ),
                ],
              ),
            ),
          ),
        ),
      ],
    );
  }

  void _dismiss() {
    widget.onDismiss?.call();
    Navigator.of(context).pop();
  }
}

/// Show the pursuit completion modal
Future<void> showPursuitCompletionModal(
  BuildContext context, {
  required Pursuit pursuit,
  required String Function(double amount) formatAmount,
  VoidCallback? onShare,
}) {
  return showDialog(
    context: context,
    barrierDismissible: false,
    barrierColor: Colors.black.withValues(alpha: 0.85),
    builder: (_) => PursuitCompletionModal(
      pursuit: pursuit,
      formatAmount: formatAmount,
      onShare: onShare,
    ),
  );
}


--- FILE: lib/widgets/pursuit_card.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/pursuit.dart';
import '../theme/app_theme.dart';
import '../theme/quiet_luxury.dart';
import '../theme/accessible_text.dart';
import 'pursuit_progress_visual.dart';

/// Card widget for displaying a pursuit in a list
class PursuitCard extends StatelessWidget {
  final Pursuit pursuit;
  final VoidCallback? onTap;
  final VoidCallback? onAddSavings;
  final String Function(double amount) formatAmount;

  const PursuitCard({
    super.key,
    required this.pursuit,
    this.onTap,
    this.onAddSavings,
    required this.formatAmount,
  });

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    // Accessibility: Semantic label for screen readers
    final semanticLabel = l10n.accessibilityPursuitCard(
      pursuit.name,
      formatAmount(pursuit.savedAmount),
      formatAmount(pursuit.targetAmount),
      pursuit.progressPercentDisplay,
    );

    return Semantics(
      label: semanticLabel,
      button: onTap != null,
      child: Pressable(
        onTap: onTap,
        child: GlassCard(
          premium: true,
          padding: const EdgeInsets.all(20),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Top row: Emoji + Name + Progress badge
              Row(
                children: [
                  // Emoji with progress visual
                  PursuitProgressVisual(
                    progress: pursuit.progressPercent,
                    emoji: pursuit.emoji,
                    imageUrl: pursuit.imageUrl,
                    size: 48,
                  ),
                  const SizedBox(width: 12),
                  // Name and category
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          pursuit.name,
                          style: QuietLuxury.heading.copyWith(fontSize: 16),
                          maxLines: 1,
                          overflow: TextOverflow.ellipsis,
                        ),
                        const SizedBox(height: 2),
                        Text(
                          _getCategoryLabel(context, pursuit.category),
                          style: QuietLuxury.label,
                        ),
                      ],
                    ),
                  ),
                  // Progress badge
                  Container(
                    padding: const EdgeInsets.symmetric(
                      horizontal: 12,
                      vertical: 6,
                    ),
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        colors: [
                          _getProgressColor(pursuit.progressPercent)
                              .withValues(alpha: 0.25),
                          _getProgressColor(pursuit.progressPercent)
                              .withValues(alpha: 0.15),
                        ],
                      ),
                      borderRadius: BorderRadius.circular(8),
                      border: Border.all(
                        color: _getProgressColor(pursuit.progressPercent)
                            .withValues(alpha: 0.4),
                        width: 1,
                      ),
                    ),
                    child: Text(
                      '${pursuit.progressPercentDisplay}%',
                      style: AccessibleText.scaled(
                        context,
                        fontSize: 13,
                        fontWeight: FontWeight.w700,
                        color: _getProgressColor(pursuit.progressPercent),
                        maxScale: 1.3,
                      ),
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 12),
              // Progress bar
              PursuitLinearProgress(
                progress: pursuit.progressPercent,
                height: 6,
                progressColor: _getProgressColor(pursuit.progressPercent),
              ),
              const SizedBox(height: 12),
              // Bottom row: Amounts + Add button
              Row(
                children: [
                  // Saved / Target
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        FittedBox(
                          fit: BoxFit.scaleDown,
                          alignment: Alignment.centerLeft,
                          child: Row(
                            crossAxisAlignment: CrossAxisAlignment.baseline,
                            textBaseline: TextBaseline.alphabetic,
                            children: [
                              Text(
                                formatAmount(pursuit.savedAmount),
                                style: AccessibleText.scaled(
                                  context,
                                  fontSize: 20,
                                  fontWeight: FontWeight.w700,
                                  color: QuietLuxury.positive,
                                  maxScale: 1.3,
                                ).copyWith(letterSpacing: -0.5),
                              ),
                              Text(
                                ' / ${formatAmount(pursuit.targetAmount)}',
                                style: AccessibleText.scaled(
                                  context,
                                  fontSize: 14,
                                  fontWeight: FontWeight.w500,
                                  color: QuietLuxury.textSecondary.withValues(alpha: 0.7),
                                  maxScale: 1.3,
                                ),
                              ),
                            ],
                          ),
                        ),
                        const SizedBox(height: 4),
                        Text(
                          l10n.remainingAmount(
                            formatAmount(pursuit.remainingAmount),
                          ),
                          style: AccessibleText.scaled(
                            context,
                            fontSize: 12,
                            fontWeight: FontWeight.w400,
                            color: QuietLuxury.textTertiary.withValues(alpha: 0.6),
                            maxScale: 1.4,
                          ),
                        ),
                      ],
                    ),
                  ),
                  // Add savings button
                  if (!pursuit.isCompleted && onAddSavings != null)
                    _AddSavingsButton(onTap: onAddSavings!),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

  String _getCategoryLabel(BuildContext context, PursuitCategory category) {
    final l10n = AppLocalizations.of(context);
    switch (category) {
      case PursuitCategory.tech:
        return l10n.pursuitCategoryTech;
      case PursuitCategory.travel:
        return l10n.pursuitCategoryTravel;
      case PursuitCategory.home:
        return l10n.pursuitCategoryHome;
      case PursuitCategory.fashion:
        return l10n.pursuitCategoryFashion;
      case PursuitCategory.vehicle:
        return l10n.pursuitCategoryVehicle;
      case PursuitCategory.education:
        return l10n.pursuitCategoryEducation;
      case PursuitCategory.health:
        return l10n.pursuitCategoryHealth;
      case PursuitCategory.other:
        return l10n.pursuitCategoryOther;
    }
  }

  Color _getProgressColor(double progress) {
    if (progress >= 1.0) return QuietLuxury.gold;
    if (progress >= 0.7) return QuietLuxury.positive;
    if (progress >= 0.3) return AppColors.secondary;
    return QuietLuxury.textTertiary;
  }
}

class _AddSavingsButton extends StatelessWidget {
  final VoidCallback onTap;

  const _AddSavingsButton({required this.onTap});

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    return Semantics(
      label: l10n.addSavings,
      button: true,
      child: Material(
        color: Colors.transparent,
        child: InkWell(
          onTap: onTap,
          borderRadius: BorderRadius.circular(16),
          child: Tooltip(
            message: l10n.addSavings,
            child: Container(
              constraints: const BoxConstraints(minHeight: 44),
              padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  colors: [
                    QuietLuxury.positive.withValues(alpha: 0.2),
                    QuietLuxury.positive.withValues(alpha: 0.12),
                  ],
                ),
                borderRadius: BorderRadius.circular(16),
                border: Border.all(
                  color: QuietLuxury.positive.withValues(alpha: 0.4),
                  width: 1,
                ),
                boxShadow: [
                  BoxShadow(
                    color: QuietLuxury.positive.withValues(alpha: 0.15),
                    blurRadius: 8,
                    offset: const Offset(0, 2),
                  ),
                ],
              ),
              child: Row(
                mainAxisSize: MainAxisSize.min,
                children: [
                  Icon(
                    CupertinoIcons.plus,
                    size: 14,
                    color: QuietLuxury.positive,
                  ),
                  const SizedBox(width: 6),
                  Text(
                    l10n.addSavings,
                    style: QuietLuxury.label.copyWith(
                      color: QuietLuxury.positive,
                      fontWeight: FontWeight.w700,
                      fontSize: 13,
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

/// Compact pursuit card for horizontal lists
class PursuitCompactCard extends StatelessWidget {
  final Pursuit pursuit;
  final VoidCallback? onTap;
  final String Function(double amount) formatAmount;
  final double width;

  const PursuitCompactCard({
    super.key,
    required this.pursuit,
    this.onTap,
    required this.formatAmount,
    this.width = 160,
  });

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    // Accessibility: Semantic label for screen readers
    final semanticLabel = l10n.accessibilityPursuitCard(
      pursuit.name,
      formatAmount(pursuit.savedAmount),
      formatAmount(pursuit.targetAmount),
      pursuit.progressPercentDisplay,
    );

    return Semantics(
      label: semanticLabel,
      button: onTap != null,
      child: Pressable(
        onTap: onTap,
        child: Container(
          width: width,
          padding: const EdgeInsets.all(12),
          decoration: QuietLuxury.cardDecoration,
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Emoji
              PursuitCircularProgress(
                progress: pursuit.progressPercent,
                emoji: pursuit.emoji,
                size: 48,
                strokeWidth: 3,
              ),
              const SizedBox(height: 8),
              // Name
              Text(
                pursuit.name,
                style: QuietLuxury.body.copyWith(
                  color: QuietLuxury.textPrimary,
                  fontWeight: FontWeight.w500,
                ),
                maxLines: 1,
                overflow: TextOverflow.ellipsis,
              ),
              const SizedBox(height: 4),
              // Progress
              Text(
                '${pursuit.progressPercentDisplay}%',
                style: QuietLuxury.label.copyWith(
                  color: QuietLuxury.positive,
                  fontWeight: FontWeight.w600,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}


--- FILE: lib/widgets/upgrade_dialog.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../theme/theme.dart';

/// Reusable upgrade dialog for free tier limits
/// Shows consistent premium upsell messaging
class UpgradeDialog extends StatelessWidget {
  final String message;
  final VoidCallback? onUpgrade;

  const UpgradeDialog({super.key, required this.message, this.onUpgrade});

  /// Show the upgrade dialog
  static void show(
    BuildContext context,
    String message, {
    VoidCallback? onUpgrade,
  }) {
    HapticFeedback.mediumImpact();
    showDialog(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.90),
      builder: (_) => UpgradeDialog(message: message, onUpgrade: onUpgrade),
    );
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return AlertDialog(
      backgroundColor: context.appColors.surface,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(24)),
      title: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(8),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [
                  context.appColors.gold.withValues(alpha: 0.2),
                  context.appColors.gold.withValues(alpha: 0.1),
                ],
              ),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Icon(
              CupertinoIcons.star_fill,
              color: context.appColors.gold,
              size: 24,
            ),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Text(
              l10n.upgradeToPremium,
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.w600,
                color: context.appColors.textPrimary,
              ),
            ),
          ),
        ],
      ),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            message,
            style: TextStyle(
              fontSize: 14,
              color: context.appColors.textSecondary,
              height: 1.4,
            ),
          ),
          const SizedBox(height: 20),
          Text(
            l10n.premiumIncludes,
            style: TextStyle(
              fontSize: 14,
              fontWeight: FontWeight.w600,
              color: context.appColors.textPrimary,
            ),
          ),
          const SizedBox(height: 12),
          _buildBenefitRow(
            context,
            CupertinoIcons.chat_bubble,
            l10n.unlimitedAiChat,
          ),
          _buildBenefitRow(
            context,
            CupertinoIcons.scope,
            l10n.unlimitedPursuits,
          ),
          _buildBenefitRow(
            context,
            CupertinoIcons.square_arrow_up,
            l10n.exportFeature,
          ),
          _buildBenefitRow(
            context,
            CupertinoIcons.money_dollar_circle,
            l10n.allCurrencies,
          ),
          _buildBenefitRow(
            context,
            CupertinoIcons.chart_bar,
            l10n.fullReports,
          ),
          _buildBenefitRow(
            context,
            CupertinoIcons.share,
            l10n.cleanShareCards,
          ),
        ],
      ),
      actionsPadding: const EdgeInsets.fromLTRB(20, 0, 20, 16),
      actions: [
        TextButton(
          onPressed: () => Navigator.pop(context),
          child: Text(
            l10n.maybeLater,
            style: TextStyle(
              color: context.appColors.textSecondary,
              fontWeight: FontWeight.w500,
            ),
          ),
        ),
        Container(
          decoration: BoxDecoration(
            gradient: LinearGradient(
              colors: [
                context.appColors.primary,
                context.appColors.primaryDark,
              ],
            ),
            borderRadius: BorderRadius.circular(16),
            boxShadow: [
              BoxShadow(
                color: context.appColors.primary.withValues(alpha: 0.3),
                blurRadius: 8,
                offset: const Offset(0, 2),
              ),
            ],
          ),
          child: ElevatedButton(
            onPressed: () {
              Navigator.pop(context);
              if (onUpgrade != null) {
                onUpgrade!();
              } else {
                Navigator.of(context).pushNamed('/paywall');
              }
            },
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.transparent,
              foregroundColor: Colors.white,
              shadowColor: Colors.transparent,
              padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 12),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(16),
              ),
            ),
            child: Text(
              l10n.seePremium,
              style: const TextStyle(fontWeight: FontWeight.w600),
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildBenefitRow(BuildContext context, IconData icon, String text) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 4),
      child: Row(
        children: [
          Icon(icon, size: 18, color: context.appColors.success),
          const SizedBox(width: 10),
          Expanded(
            child: Text(
              text,
              style: TextStyle(
                fontSize: 13,
                color: context.appColors.textSecondary,
              ),
            ),
          ),
        ],
      ),
    );
  }
}

/// Compact upgrade banner for inline display
class UpgradeBanner extends StatelessWidget {
  final String message;
  final VoidCallback? onTap;

  const UpgradeBanner({super.key, required this.message, this.onTap});

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return GestureDetector(
      onTap: onTap ?? () => Navigator.of(context).pushNamed('/paywall'),
      child: Container(
        margin: const EdgeInsets.symmetric(vertical: 8),
        padding: const EdgeInsets.all(12),
        decoration: BoxDecoration(
          gradient: LinearGradient(
            colors: [
              context.appColors.primary.withValues(alpha: 0.15),
              context.appColors.primaryDark.withValues(alpha: 0.1),
            ],
          ),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: context.appColors.primary.withValues(alpha: 0.3),
          ),
        ),
        child: Row(
          children: [
            Container(
              padding: const EdgeInsets.all(6),
              decoration: BoxDecoration(
                color: context.appColors.gold.withValues(alpha: 0.2),
                borderRadius: BorderRadius.circular(8),
              ),
              child: Icon(
                CupertinoIcons.star_fill,
                size: 18,
                color: context.appColors.gold,
              ),
            ),
            const SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    message,
                    style: TextStyle(
                      fontSize: 13,
                      color: context.appColors.textSecondary,
                    ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    l10n.seePremium,
                    style: TextStyle(
                      fontSize: 12,
                      fontWeight: FontWeight.w600,
                      color: context.appColors.primary,
                    ),
                  ),
                ],
              ),
            ),
            Icon(
              CupertinoIcons.chevron_right,
              size: 18,
              color: context.appColors.primary,
            ),
          ],
        ),
      ),
    );
  }
}


--- FILE: lib/widgets/spending_heatmap.dart ---

import 'package:flutter/material.dart';
import 'package:fl_chart/fl_chart.dart';
import '../models/models.dart';
import '../theme/theme.dart';

/// Task 67: Spending Heatmap Widget
/// Shows daily spending intensity in a calendar heatmap view
class SpendingHeatmap extends StatelessWidget {
  final List<Expense> expenses;
  final int weeksToShow;
  final DateTime? startDate;

  const SpendingHeatmap({
    super.key,
    required this.expenses,
    this.weeksToShow = 12,
    this.startDate,
  });

  @override
  Widget build(BuildContext context) {
    final start = startDate ?? DateTime.now().subtract(Duration(days: weeksToShow * 7));
    final dailyAmounts = _calculateDailyAmounts(start);
    final maxAmount = dailyAmounts.values.fold(0.0, (max, v) => v > max ? v : max);

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // Week day labels
        Row(
          children: [
            const SizedBox(width: 24),
            ...['P', 'S', 'Ç', 'P', 'C', 'C', 'P'].map((d) => Expanded(
              child: Center(
                child: Text(
                  d,
                  style: TextStyle(
                    fontSize: 10,
                    color: context.appColors.textTertiary,
                  ),
                ),
              ),
            )),
          ],
        ),
        const SizedBox(height: 4),
        // Heatmap grid
        SizedBox(
          height: 7 * 14.0,
          child: Row(
            children: [
              // Month labels column
              SizedBox(
                width: 24,
                child: _buildMonthLabels(context, start),
              ),
              // Heatmap cells
              Expanded(
                child: _buildHeatmapGrid(context, dailyAmounts, maxAmount, start),
              ),
            ],
          ),
        ),
        const SizedBox(height: 8),
        // Legend
        _buildLegend(context),
      ],
    );
  }

  Map<DateTime, double> _calculateDailyAmounts(DateTime start) {
    final amounts = <DateTime, double>{};
    for (final expense in expenses) {
      if (expense.decision == ExpenseDecision.yes) {
        final date = DateTime(expense.date.year, expense.date.month, expense.date.day);
        if (date.isAfter(start.subtract(const Duration(days: 1)))) {
          amounts[date] = (amounts[date] ?? 0) + expense.amount;
        }
      }
    }
    return amounts;
  }

  Widget _buildMonthLabels(BuildContext context, DateTime start) {
    final months = <String>[];
    var current = start;
    var lastMonth = -1;

    for (var week = 0; week < weeksToShow; week++) {
      if (current.month != lastMonth) {
        months.add(_getMonthAbbr(current.month));
        lastMonth = current.month;
      } else {
        months.add('');
      }
      current = current.add(const Duration(days: 7));
    }

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: months.take(7).map((m) => SizedBox(
        height: 14,
        child: Text(
          m,
          style: TextStyle(
            fontSize: 8,
            color: context.appColors.textTertiary,
          ),
        ),
      )).toList(),
    );
  }

  Widget _buildHeatmapGrid(
    BuildContext context,
    Map<DateTime, double> amounts,
    double maxAmount,
    DateTime start,
  ) {
    return GridView.builder(
      physics: const NeverScrollableScrollPhysics(),
      gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
        crossAxisCount: 7,
        mainAxisSpacing: 2,
        crossAxisSpacing: 2,
      ),
      itemCount: weeksToShow * 7,
      itemBuilder: (context, index) {
        final date = start.add(Duration(days: index));
        final amount = amounts[DateTime(date.year, date.month, date.day)] ?? 0;
        final intensity = maxAmount > 0 ? (amount / maxAmount) : 0.0;

        return _HeatmapCell(
          intensity: intensity,
          date: date,
          amount: amount,
        );
      },
    );
  }

  Widget _buildLegend(BuildContext context) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.end,
      children: [
        Text(
          'Az',
          style: TextStyle(
            fontSize: 10,
            color: context.appColors.textTertiary,
          ),
        ),
        const SizedBox(width: 4),
        ...[0.0, 0.25, 0.5, 0.75, 1.0].map((i) => Container(
          width: 12,
          height: 12,
          margin: const EdgeInsets.symmetric(horizontal: 1),
          decoration: BoxDecoration(
            color: _getIntensityColor(context, i),
            borderRadius: BorderRadius.circular(2),
          ),
        )),
        const SizedBox(width: 4),
        Text(
          'Çok',
          style: TextStyle(
            fontSize: 10,
            color: context.appColors.textTertiary,
          ),
        ),
      ],
    );
  }

  String _getMonthAbbr(int month) {
    const abbrs = ['', 'Oca', 'Şub', 'Mar', 'Nis', 'May', 'Haz',
                   'Tem', 'Ağu', 'Eyl', 'Eki', 'Kas', 'Ara'];
    return abbrs[month];
  }

  static Color _getIntensityColor(BuildContext context, double intensity) {
    if (intensity <= 0) {
      return context.appColors.surfaceLight;
    } else if (intensity < 0.25) {
      return context.appColors.success.withValues(alpha: 0.3);
    } else if (intensity < 0.5) {
      return context.appColors.success.withValues(alpha: 0.5);
    } else if (intensity < 0.75) {
      return context.appColors.warning.withValues(alpha: 0.7);
    } else {
      return context.appColors.error.withValues(alpha: 0.9);
    }
  }
}

class _HeatmapCell extends StatelessWidget {
  final double intensity;
  final DateTime date;
  final double amount;

  const _HeatmapCell({
    required this.intensity,
    required this.date,
    required this.amount,
  });

  @override
  Widget build(BuildContext context) {
    return Tooltip(
      message: '${date.day}/${date.month}: ${amount.toStringAsFixed(0)} TL',
      child: Container(
        decoration: BoxDecoration(
          color: SpendingHeatmap._getIntensityColor(context, intensity),
          borderRadius: BorderRadius.circular(2),
        ),
      ),
    );
  }
}

/// Task 70: Savings Projection Widget
/// Shows projected savings based on current trend
class SavingsProjection extends StatelessWidget {
  final double currentSavings;
  final double monthlyAverage;
  final int projectionMonths;

  const SavingsProjection({
    super.key,
    required this.currentSavings,
    required this.monthlyAverage,
    this.projectionMonths = 12,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: context.appColors.cardBorder),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(
                Icons.trending_up,
                color: context.appColors.success,
                size: 20,
              ),
              const SizedBox(width: 8),
              Text(
                'Tasarruf Projeksiyonu',
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textPrimary,
                ),
              ),
            ],
          ),
          const SizedBox(height: 16),
          // Projection milestones
          ...[
            (3, '3 Ay'),
            (6, '6 Ay'),
            (12, '1 Yıl'),
          ].where((e) => e.$1 <= projectionMonths).map((milestone) {
            final projected = currentSavings + (monthlyAverage * milestone.$1);
            return Padding(
              padding: const EdgeInsets.symmetric(vertical: 4),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(
                    milestone.$2,
                    style: TextStyle(
                      fontSize: 14,
                      color: context.appColors.textSecondary,
                    ),
                  ),
                  Text(
                    '${projected.toStringAsFixed(0)} TL',
                    style: TextStyle(
                      fontSize: 14,
                      fontWeight: FontWeight.w600,
                      color: context.appColors.success,
                    ),
                  ),
                ],
              ),
            );
          }),
          if (monthlyAverage > 0) ...[
            const SizedBox(height: 12),
            Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: context.appColors.success.withValues(alpha: 0.1),
                borderRadius: BorderRadius.circular(8),
              ),
              child: Row(
                children: [
                  Icon(
                    Icons.lightbulb_outline,
                    color: context.appColors.success,
                    size: 16,
                  ),
                  const SizedBox(width: 8),
                  Expanded(
                    child: Text(
                      'Aylık ortalama: ${monthlyAverage.toStringAsFixed(0)} TL',
                      style: TextStyle(
                        fontSize: 12,
                        color: context.appColors.success,
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ],
        ],
      ),
    );
  }
}

/// Task 68: Category Trend Chart
/// Shows spending trend by category over time
class CategoryTrendChart extends StatelessWidget {
  final List<Expense> expenses;
  final int monthsToShow;
  final List<Color>? categoryColors;

  const CategoryTrendChart({
    super.key,
    required this.expenses,
    this.monthsToShow = 6,
    this.categoryColors,
  });

  @override
  Widget build(BuildContext context) {
    final monthlyData = _calculateMonthlyByCategory();
    if (monthlyData.isEmpty) {
      return const SizedBox.shrink();
    }

    final categories = monthlyData.values
        .expand((m) => m.keys)
        .toSet()
        .take(5)
        .toList();

    final defaultColors = [
      context.appColors.primary,
      context.appColors.success,
      context.appColors.warning,
      context.appColors.error,
      context.appColors.secondary,
    ];

    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: context.appColors.cardBorder),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Kategori Trendi',
            style: TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.w600,
              color: context.appColors.textPrimary,
            ),
          ),
          const SizedBox(height: 16),
          SizedBox(
            height: 200,
            child: LineChart(
              LineChartData(
                gridData: FlGridData(
                  show: true,
                  drawVerticalLine: false,
                  horizontalInterval: 1000,
                  getDrawingHorizontalLine: (value) => FlLine(
                    color: context.appColors.cardBorder,
                    strokeWidth: 0.5,
                  ),
                ),
                titlesData: FlTitlesData(
                  leftTitles: AxisTitles(
                    sideTitles: SideTitles(
                      showTitles: true,
                      reservedSize: 40,
                      getTitlesWidget: (value, meta) => Text(
                        _formatAmount(value),
                        style: TextStyle(
                          fontSize: 10,
                          color: context.appColors.textTertiary,
                        ),
                      ),
                    ),
                  ),
                  bottomTitles: AxisTitles(
                    sideTitles: SideTitles(
                      showTitles: true,
                      getTitlesWidget: (value, meta) {
                        final months = monthlyData.keys.toList();
                        if (value.toInt() >= months.length) return const SizedBox();
                        final date = months[value.toInt()];
                        return Text(
                          _getMonthAbbr(date.month),
                          style: TextStyle(
                            fontSize: 10,
                            color: context.appColors.textTertiary,
                          ),
                        );
                      },
                    ),
                  ),
                  rightTitles: const AxisTitles(sideTitles: SideTitles(showTitles: false)),
                  topTitles: const AxisTitles(sideTitles: SideTitles(showTitles: false)),
                ),
                borderData: FlBorderData(show: false),
                lineBarsData: categories.asMap().entries.map((entry) {
                  final index = entry.key;
                  final category = entry.value;
                  final color = categoryColors?[index % (categoryColors?.length ?? 1)] ??
                      defaultColors[index % defaultColors.length];

                  return LineChartBarData(
                    spots: monthlyData.entries.toList().asMap().entries.map((e) {
                      final monthIndex = e.key;
                      final monthData = e.value.value;
                      return FlSpot(monthIndex.toDouble(), monthData[category] ?? 0);
                    }).toList(),
                    isCurved: true,
                    color: color,
                    barWidth: 2,
                    dotData: const FlDotData(show: false),
                    belowBarData: BarAreaData(
                      show: true,
                      color: color.withValues(alpha: 0.1),
                    ),
                  );
                }).toList(),
              ),
            ),
          ),
          const SizedBox(height: 12),
          // Legend
          Wrap(
            spacing: 16,
            runSpacing: 8,
            children: categories.asMap().entries.map((entry) {
              final index = entry.key;
              final category = entry.value;
              final color = categoryColors?[index % (categoryColors?.length ?? 1)] ??
                  defaultColors[index % defaultColors.length];

              return Row(
                mainAxisSize: MainAxisSize.min,
                children: [
                  Container(
                    width: 12,
                    height: 12,
                    decoration: BoxDecoration(
                      color: color,
                      borderRadius: BorderRadius.circular(2),
                    ),
                  ),
                  const SizedBox(width: 4),
                  Text(
                    category,
                    style: TextStyle(
                      fontSize: 11,
                      color: context.appColors.textSecondary,
                    ),
                  ),
                ],
              );
            }).toList(),
          ),
        ],
      ),
    );
  }

  Map<DateTime, Map<String, double>> _calculateMonthlyByCategory() {
    final result = <DateTime, Map<String, double>>{};
    final now = DateTime.now();

    for (var i = monthsToShow - 1; i >= 0; i--) {
      final month = DateTime(now.year, now.month - i, 1);
      result[month] = {};
    }

    for (final expense in expenses) {
      if (expense.decision == ExpenseDecision.yes) {
        final month = DateTime(expense.date.year, expense.date.month, 1);
        if (result.containsKey(month)) {
          result[month]![expense.category] =
              (result[month]![expense.category] ?? 0) + expense.amount;
        }
      }
    }

    return result;
  }

  String _formatAmount(double value) {
    if (value >= 1000) {
      return '${(value / 1000).toStringAsFixed(0)}K';
    }
    return value.toStringAsFixed(0);
  }

  String _getMonthAbbr(int month) {
    const abbrs = ['', 'Oca', 'Şub', 'Mar', 'Nis', 'May', 'Haz',
                   'Tem', 'Ağu', 'Eyl', 'Eki', 'Kas', 'Ara'];
    return abbrs[month];
  }
}

/// Task 69: Work Hours Equivalent Chart
/// Shows expenses as work hours needed to earn that amount
class WorkHoursChart extends StatelessWidget {
  final List<Expense> expenses;
  final double hourlyRate;
  final int daysToShow;

  const WorkHoursChart({
    super.key,
    required this.expenses,
    required this.hourlyRate,
    this.daysToShow = 7,
  });

  @override
  Widget build(BuildContext context) {
    if (hourlyRate <= 0) return const SizedBox.shrink();

    final dailyHours = _calculateDailyWorkHours();

    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: context.appColors.cardBorder),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(
                Icons.access_time,
                color: context.appColors.primary,
                size: 20,
              ),
              const SizedBox(width: 8),
              Text(
                'Çalışma Saati Karşılığı',
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textPrimary,
                ),
              ),
            ],
          ),
          const SizedBox(height: 16),
          SizedBox(
            height: 150,
            child: BarChart(
              BarChartData(
                gridData: const FlGridData(show: false),
                borderData: FlBorderData(show: false),
                titlesData: FlTitlesData(
                  leftTitles: const AxisTitles(sideTitles: SideTitles(showTitles: false)),
                  rightTitles: const AxisTitles(sideTitles: SideTitles(showTitles: false)),
                  topTitles: const AxisTitles(sideTitles: SideTitles(showTitles: false)),
                  bottomTitles: AxisTitles(
                    sideTitles: SideTitles(
                      showTitles: true,
                      getTitlesWidget: (value, meta) {
                        final days = dailyHours.keys.toList();
                        if (value.toInt() >= days.length) return const SizedBox();
                        final date = days[value.toInt()];
                        return Text(
                          _getDayAbbr(date.weekday),
                          style: TextStyle(
                            fontSize: 10,
                            color: context.appColors.textTertiary,
                          ),
                        );
                      },
                    ),
                  ),
                ),
                barGroups: dailyHours.entries.toList().asMap().entries.map((e) {
                  final index = e.key;
                  final hours = e.value.value;
                  return BarChartGroupData(
                    x: index,
                    barRods: [
                      BarChartRodData(
                        toY: hours,
                        color: hours > 8
                            ? context.appColors.error
                            : hours > 4
                                ? context.appColors.warning
                                : context.appColors.success,
                        width: 20,
                        borderRadius: const BorderRadius.vertical(top: Radius.circular(4)),
                      ),
                    ],
                  );
                }).toList(),
              ),
            ),
          ),
          const SizedBox(height: 12),
          Row(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Text(
                'Toplam: ${_totalHours().toStringAsFixed(1)} saat',
                style: TextStyle(
                  fontSize: 14,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textPrimary,
                ),
              ),
              Text(
                ' (${hourlyRate.toStringAsFixed(0)} TL/saat)',
                style: TextStyle(
                  fontSize: 12,
                  color: context.appColors.textTertiary,
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Map<DateTime, double> _calculateDailyWorkHours() {
    final result = <DateTime, double>{};
    final now = DateTime.now();

    for (var i = daysToShow - 1; i >= 0; i--) {
      final day = DateTime(now.year, now.month, now.day - i);
      result[day] = 0;
    }

    for (final expense in expenses) {
      if (expense.decision == ExpenseDecision.yes) {
        final day = DateTime(expense.date.year, expense.date.month, expense.date.day);
        if (result.containsKey(day)) {
          result[day] = result[day]! + (expense.amount / hourlyRate);
        }
      }
    }

    return result;
  }

  double _totalHours() {
    return _calculateDailyWorkHours().values.fold(0.0, (a, b) => a + b);
  }

  String _getDayAbbr(int weekday) {
    const abbrs = ['', 'Pzt', 'Sal', 'Çar', 'Per', 'Cum', 'Cmt', 'Paz'];
    return abbrs[weekday];
  }
}


--- FILE: lib/widgets/subscription_detail_sheet.dart ---

import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';
import '../services/services.dart';
import '../theme/theme.dart';
import '../theme/app_theme.dart';
import '../utils/currency_utils.dart';
import 'turkish_currency_input.dart';

/// Subscription detail and edit bottom sheet
class SubscriptionDetailSheet extends StatefulWidget {
  final Subscription subscription;
  final Function(Subscription) onUpdate;
  final VoidCallback onDelete;

  const SubscriptionDetailSheet({
    super.key,
    required this.subscription,
    required this.onUpdate,
    required this.onDelete,
  });

  @override
  State<SubscriptionDetailSheet> createState() =>
      _SubscriptionDetailSheetState();
}

class _SubscriptionDetailSheetState extends State<SubscriptionDetailSheet> {
  final _subscriptionManager = SubscriptionManager();
  bool _isEditing = false;
  late TextEditingController _nameController;
  late TextEditingController _amountController;
  late int _selectedDay;
  late int _selectedColorIndex;
  late String _selectedCategory;
  late bool _autoRecord;

  double? _workHours;
  double? _workDays;

  /// Subscription category keys
  static const List<String> _categoryKeys = [
    'entertainment',
    'digital',
    'health',
    'education',
    'sports',
    'communication',
    'other',
  ];

  /// Map legacy Turkish categories to keys
  static const Map<String, String> _legacyCategoryMap = {
    'Eğlence': 'entertainment',
    'Dijital': 'digital',
    'Sağlık': 'health',
    'Eğitim': 'education',
    'Spor': 'sports',
    'Haberleşme': 'communication',
    'Diğer': 'other',
  };

  /// Normalize category (convert legacy Turkish to key)
  String _normalizeCategory(String category) {
    return _legacyCategoryMap[category] ?? category;
  }

  /// Get localized category name from key
  String _getLocalizedCategory(String key, AppLocalizations l10n) {
    return switch (key) {
      'entertainment' => l10n.categoryEntertainment,
      'digital' => l10n.categoryDigital,
      'health' => l10n.categoryHealth,
      'education' => l10n.categoryEducation,
      'sports' => l10n.categorySports,
      'communication' => l10n.categoryCommunication,
      'other' => l10n.categoryOther,
      _ => key,
    };
  }

  @override
  void initState() {
    super.initState();
    _initControllers();
    _loadWorkTime();
  }

  void _initControllers() {
    _nameController = TextEditingController(text: widget.subscription.name);
    _amountController = TextEditingController(
      text: formatTurkishCurrency(widget.subscription.amount),
    );
    _selectedDay = widget.subscription.renewalDay;
    _selectedColorIndex = widget.subscription.colorIndex;
    // Normalize legacy Turkish category to key
    _selectedCategory = _normalizeCategory(widget.subscription.category);
    _autoRecord = widget.subscription.autoRecord;
  }

  Future<void> _loadWorkTime() async {
    final hours = await _subscriptionManager.calculateWorkHours(
      widget.subscription.amount,
    );
    final days = await _subscriptionManager.calculateWorkDays(
      widget.subscription.amount,
    );

    if (mounted) {
      setState(() {
        _workHours = hours;
        _workDays = days;
      });
    }
  }

  @override
  void dispose() {
    _nameController.dispose();
    _amountController.dispose();
    super.dispose();
  }

  void _toggleEdit() {
    HapticFeedback.selectionClick();
    setState(() => _isEditing = !_isEditing);
  }

  void _save() {
    final amount = parseTurkishCurrency(_amountController.text);
    if (amount == null || amount <= 0 || _nameController.text.trim().isEmpty) {
      return;
    }

    final updated = widget.subscription.copyWith(
      name: _nameController.text.trim(),
      amount: amount,
      renewalDay: _selectedDay,
      colorIndex: _selectedColorIndex,
      category: _selectedCategory,
      autoRecord: _autoRecord,
    );

    HapticFeedback.mediumImpact();
    widget.onUpdate(updated);
    Navigator.pop(context);
  }

  void _confirmDelete() {
    final l10n = AppLocalizations.of(context);
    HapticFeedback.lightImpact();
    showDialog(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      builder: (context) => AlertDialog(
        backgroundColor: context.appColors.gradientMid,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
        title: Text(
          l10n.deleteSubscription,
          style: TextStyle(color: context.appColors.textPrimary),
        ),
        content: Text(
          l10n.deleteSubscriptionConfirm(widget.subscription.name),
          style: TextStyle(color: context.appColors.textSecondary),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text(
              l10n.cancel,
              style: TextStyle(color: context.appColors.textSecondary),
            ),
          ),
          TextButton(
            onPressed: () {
              Navigator.pop(context); // Close dialog
              Navigator.pop(context); // Close sheet
              widget.onDelete();
            },
            child: Text(
              l10n.delete,
              style: const TextStyle(color: AppColors.categoryBills),
            ),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final sub = widget.subscription;

    return Container(
      decoration: BoxDecoration(
        color: context.appColors.gradientMid,
        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
      ),
      child: ClipRRect(
        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
        child: BackdropFilter(
          filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
          child: SingleChildScrollView(
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                // Handle
                Container(
                  width: 40,
                  height: 4,
                  margin: const EdgeInsets.only(top: 12),
                  decoration: BoxDecoration(
                    color: context.appColors.cardBorder,
                    borderRadius: BorderRadius.circular(2),
                  ),
                ),

                Padding(
                  padding: const EdgeInsets.all(24),
                  child: _isEditing
                      ? _buildEditView(l10n)
                      : _buildDetailView(sub, l10n),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildDetailView(Subscription sub, AppLocalizations l10n) {
    return Column(
      children: [
        // Title and color
        Row(
          children: [
            Container(
              width: 48,
              height: 48,
              decoration: BoxDecoration(
                color: sub.color.withValues(alpha: 0.2),
                borderRadius: BorderRadius.circular(16),
              ),
              child: Center(
                child: Container(
                  width: 20,
                  height: 20,
                  decoration: BoxDecoration(
                    color: sub.color,
                    shape: BoxShape.circle,
                    boxShadow: [
                      BoxShadow(
                        color: sub.color.withValues(alpha: 0.4),
                        blurRadius: 8,
                      ),
                    ],
                  ),
                ),
              ),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    sub.name,
                    style: TextStyle(
                      fontSize: 20,
                      fontWeight: FontWeight.w600,
                      color: context.appColors.textPrimary,
                    ),
                  ),
                  const SizedBox(height: 2),
                  Text(
                    sub.category,
                    style: TextStyle(
                      fontSize: 14,
                      color: context.appColors.textSecondary,
                    ),
                  ),
                ],
              ),
            ),
            // Edit button
            Semantics(
              button: true,
              label: l10n.edit,
              child: IconButton(
                onPressed: _toggleEdit,
                tooltip: l10n.edit,
                icon: const Icon(CupertinoIcons.pencil),
                color: context.appColors.textSecondary,
              ),
            ),
          ],
        ),
        const SizedBox(height: 24),

        // Amount card
        Container(
          padding: const EdgeInsets.all(20),
          decoration: BoxDecoration(
            color: context.appColors.surface.withValues(alpha: 0.5),
            borderRadius: BorderRadius.circular(16),
            border: Border.all(
              color: sub.color.withValues(alpha: 0.3),
              width: 1,
            ),
          ),
          child: Row(
            children: [
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      l10n.monthlyAmount,
                      style: TextStyle(
                        fontSize: 12,
                        color: context.appColors.textSecondary,
                      ),
                    ),
                    const SizedBox(height: 4),
                    Text(
                      '${formatTurkishCurrency(sub.amount, decimalDigits: 2)} ₺',
                      style: TextStyle(
                        fontSize: 28,
                        fontWeight: FontWeight.w600,
                        color: context.appColors.textPrimary,
                      ),
                    ),
                  ],
                ),
              ),
              Container(
                padding: const EdgeInsets.symmetric(
                  horizontal: 14,
                  vertical: 8,
                ),
                decoration: BoxDecoration(
                  color: context.appColors.surface.withValues(alpha: 0.8),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Column(
                  children: [
                    Text(
                      l10n.everyMonth,
                      style: TextStyle(
                        fontSize: 11,
                        color: context.appColors.textTertiary,
                      ),
                    ),
                    Text(
                      '${sub.renewalDay}',
                      style: TextStyle(
                        fontSize: 24,
                        fontWeight: FontWeight.w700,
                        color: context.appColors.textPrimary,
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
        const SizedBox(height: 16),

        // Statistics
        Row(
          children: [
            Expanded(
              child: _buildStatCard(
                l10n.subscriptionDuration,
                l10n.daysCount(sub.daysSinceSubscription),
                CupertinoIcons.calendar,
              ),
            ),
            const SizedBox(width: 12),
            Expanded(
              child: _buildStatCard(
                l10n.totalPaid,
                '${formatTurkishCurrency(sub.totalPaid, decimalDigits: 0)} ₺',
                CupertinoIcons.creditcard,
              ),
            ),
          ],
        ),
        const SizedBox(height: 12),
        Row(
          children: [
            Expanded(
              child: _buildStatCard(
                l10n.workHours,
                _workHours != null
                    ? l10n.hoursCount(_workHours!.toStringAsFixed(1))
                    : '-',
                CupertinoIcons.clock,
              ),
            ),
            const SizedBox(width: 12),
            Expanded(
              child: _buildStatCard(
                l10n.workDays,
                _workDays != null
                    ? l10n.daysCountDecimal(_workDays!.toStringAsFixed(2))
                    : '-',
                CupertinoIcons.briefcase,
              ),
            ),
          ],
        ),
        const SizedBox(height: 16),

        // Auto record status
        Container(
          padding: const EdgeInsets.all(14),
          decoration: BoxDecoration(
            color: context.appColors.surface.withValues(alpha: 0.3),
            borderRadius: BorderRadius.circular(16),
          ),
          child: Row(
            children: [
              Icon(
                sub.autoRecord
                    ? CupertinoIcons.checkmark_circle_fill
                    : CupertinoIcons.xmark_circle_fill,
                size: 20,
                color: sub.autoRecord
                    ? AppColors.categoryHealth
                    : context.appColors.textTertiary,
              ),
              const SizedBox(width: 12),
              Expanded(
                child: Text(
                  sub.autoRecord ? l10n.autoRecordOn : l10n.autoRecordOff,
                  style: TextStyle(
                    fontSize: 13,
                    color: context.appColors.textSecondary,
                  ),
                ),
              ),
            ],
          ),
        ),
        const SizedBox(height: 24),

        // Delete button
        Semantics(
          button: true,
          label: l10n.deleteSubscription,
          child: SizedBox(
            width: double.infinity,
            child: OutlinedButton.icon(
              onPressed: _confirmDelete,
              icon: const Icon(CupertinoIcons.trash, size: 18),
              label: Text(l10n.deleteSubscription),
              style: OutlinedButton.styleFrom(
                foregroundColor: AppColors.categoryBills,
                side: const BorderSide(
                  color: AppColors.categoryBills,
                  width: 1,
                ),
                padding: const EdgeInsets.symmetric(vertical: 14),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(16),
                ),
              ),
            ),
          ),
        ),
        const SizedBox(height: 16),
      ],
    );
  }

  Widget _buildStatCard(String label, String value, IconData icon) {
    return Container(
      padding: const EdgeInsets.all(14),
      decoration: BoxDecoration(
        color: context.appColors.surface.withValues(alpha: 0.4),
        borderRadius: BorderRadius.circular(16),
      ),
      child: Row(
        children: [
          Icon(icon, size: 18, color: context.appColors.textTertiary),
          const SizedBox(width: 10),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  label,
                  style: TextStyle(
                    fontSize: 11,
                    color: context.appColors.textTertiary,
                  ),
                ),
                const SizedBox(height: 2),
                Text(
                  value,
                  style: TextStyle(
                    fontSize: 13,
                    fontWeight: FontWeight.w600,
                    color: context.appColors.textPrimary,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildEditView(AppLocalizations l10n) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // Title
        Row(
          children: [
            Text(
              l10n.editSubscription,
              style: TextStyle(
                fontSize: 20,
                fontWeight: FontWeight.w600,
                color: context.appColors.textPrimary,
              ),
            ),
            const Spacer(),
            TextButton(
              onPressed: _toggleEdit,
              child: Text(
                l10n.cancel,
                style: TextStyle(color: context.appColors.textSecondary),
              ),
            ),
          ],
        ),
        const SizedBox(height: 20),

        // Subscription name
        TextFormField(
          controller: _nameController,
          style: TextStyle(color: context.appColors.textPrimary),
          decoration: _inputDecoration(l10n.subscriptionName),
        ),
        const SizedBox(height: 16),

        // Monthly amount
        TextFormField(
          controller: _amountController,
          style: TextStyle(color: context.appColors.textPrimary),
          decoration: _inputDecoration(l10n.monthlyAmountLabel),
          keyboardType: const TextInputType.numberWithOptions(decimal: true),
          inputFormatters: [TurkishCurrencyInputFormatter()],
        ),
        const SizedBox(height: 16),

        // Category and renewal day
        Row(
          children: [
            Expanded(child: _buildCategoryDropdown(l10n)),
            const SizedBox(width: 16),
            Expanded(child: _buildDayDropdown(l10n)),
          ],
        ),
        const SizedBox(height: 20),

        // Color picker
        Text(
          l10n.color,
          style: TextStyle(
            fontSize: 12,
            color: context.appColors.textSecondary,
          ),
        ),
        const SizedBox(height: 10),
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: List.generate(
            SubscriptionColors.count,
            (index) => Semantics(
              button: true,
              selected: _selectedColorIndex == index,
              label: '${l10n.color} ${index + 1}',
              child: GestureDetector(
                onTap: () {
                  HapticFeedback.selectionClick();
                  setState(() => _selectedColorIndex = index);
                },
                child: AnimatedContainer(
                  duration: const Duration(milliseconds: 200),
                  width: 36,
                  height: 36,
                  decoration: BoxDecoration(
                    color: SubscriptionColors.get(index),
                    shape: BoxShape.circle,
                    border: _selectedColorIndex == index
                        ? Border.all(color: Colors.white, width: 2.5)
                        : null,
                  ),
                ),
              ),
            ),
          ),
        ),
        const SizedBox(height: 20),

        // Auto record toggle
        Container(
          padding: const EdgeInsets.all(14),
          decoration: BoxDecoration(
            color: context.appColors.surface.withValues(alpha: 0.4),
            borderRadius: BorderRadius.circular(16),
          ),
          child: Row(
            children: [
              Icon(
                CupertinoIcons.sparkles,
                size: 20,
                color: _autoRecord
                    ? context.appColors.primary
                    : context.appColors.textTertiary,
              ),
              const SizedBox(width: 12),
              Expanded(
                child: Text(
                  l10n.autoRecord,
                  style: TextStyle(
                    fontSize: 14,
                    color: context.appColors.textPrimary,
                  ),
                ),
              ),
              Switch(
                value: _autoRecord,
                onChanged: (v) => setState(() => _autoRecord = v),
                activeTrackColor: context.appColors.primary,
              ),
            ],
          ),
        ),
        const SizedBox(height: 24),

        // Save button
        SizedBox(
          width: double.infinity,
          child: ElevatedButton(
            onPressed: _save,
            style: ElevatedButton.styleFrom(
              backgroundColor: context.appColors.primary,
              foregroundColor: Colors.white,
              padding: const EdgeInsets.symmetric(vertical: 16),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(16),
              ),
            ),
            child: Text(
              l10n.saveChanges,
              style: const TextStyle(fontSize: 16, fontWeight: FontWeight.w600),
            ),
          ),
        ),
        const SizedBox(height: 16),
      ],
    );
  }

  Widget _buildCategoryDropdown(AppLocalizations l10n) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          l10n.category,
          style: TextStyle(
            fontSize: 12,
            color: context.appColors.textSecondary,
          ),
        ),
        const SizedBox(height: 8),
        Container(
          padding: const EdgeInsets.symmetric(horizontal: 12),
          decoration: BoxDecoration(
            color: context.appColors.surface.withValues(alpha: 0.5),
            borderRadius: BorderRadius.circular(16),
          ),
          child: DropdownButtonHideUnderline(
            child: DropdownButton<String>(
              value: _selectedCategory,
              isExpanded: true,
              dropdownColor: context.appColors.gradientMid,
              style: TextStyle(
                color: context.appColors.textPrimary,
                fontSize: 14,
              ),
              items: _categoryKeys
                  .map(
                    (key) => DropdownMenuItem(
                      value: key,
                      child: Text(_getLocalizedCategory(key, l10n)),
                    ),
                  )
                  .toList(),
              onChanged: (v) {
                if (v != null) setState(() => _selectedCategory = v);
              },
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildDayDropdown(AppLocalizations l10n) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          l10n.renewalDay,
          style: TextStyle(
            fontSize: 12,
            color: context.appColors.textSecondary,
          ),
        ),
        const SizedBox(height: 8),
        Container(
          padding: const EdgeInsets.symmetric(horizontal: 12),
          decoration: BoxDecoration(
            color: context.appColors.surface.withValues(alpha: 0.5),
            borderRadius: BorderRadius.circular(16),
          ),
          child: DropdownButtonHideUnderline(
            child: DropdownButton<int>(
              value: _selectedDay,
              isExpanded: true,
              dropdownColor: context.appColors.gradientMid,
              style: TextStyle(
                color: context.appColors.textPrimary,
                fontSize: 14,
              ),
              items: List.generate(31, (i) => i + 1)
                  .map((d) => DropdownMenuItem(value: d, child: Text('$d')))
                  .toList(),
              onChanged: (v) {
                if (v != null) setState(() => _selectedDay = v);
              },
            ),
          ),
        ),
      ],
    );
  }

  InputDecoration _inputDecoration(String label) {
    return InputDecoration(
      labelText: label,
      labelStyle: TextStyle(
        color: context.appColors.textSecondary,
        fontSize: 14,
      ),
      filled: true,
      fillColor: context.appColors.surface.withValues(alpha: 0.5),
      border: OutlineInputBorder(
        borderRadius: BorderRadius.circular(16),
        borderSide: BorderSide.none,
      ),
      contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
    );
  }
}


--- FILE: lib/widgets/add_savings_sheet.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';
import '../providers/providers.dart';
import '../theme/quiet_luxury.dart';
import 'pursuit_progress_visual.dart';
import 'pool_allocation_dialog.dart';

/// Bottom sheet for adding savings to a pursuit
class AddSavingsSheet extends StatefulWidget {
  final Pursuit pursuit;
  final TransactionSource source;
  final double? prefilledAmount;

  const AddSavingsSheet({
    super.key,
    required this.pursuit,
    this.source = TransactionSource.manual,
    this.prefilledAmount,
  });

  @override
  State<AddSavingsSheet> createState() => _AddSavingsSheetState();
}

class _AddSavingsSheetState extends State<AddSavingsSheet> {
  final _amountController = TextEditingController();
  final _noteController = TextEditingController();
  bool _isLoading = false;

  @override
  void initState() {
    super.initState();
    if (widget.prefilledAmount != null) {
      _amountController.text = widget.prefilledAmount!.toStringAsFixed(0);
    }
  }

  @override
  void dispose() {
    _amountController.dispose();
    _noteController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final currencyProvider = context.watch<CurrencyProvider>();
    final currencySymbol = currencyProvider.currency.symbol;

    // Quick amount chips
    final quickAmounts = [100.0, 500.0, 1000.0, 5000.0];

    return Container(
      decoration: BoxDecoration(
        color: QuietLuxury.background,
        borderRadius: const BorderRadius.vertical(top: Radius.circular(20)),
      ),
      child: SafeArea(
        child: Padding(
          padding: EdgeInsets.only(
            left: 20,
            right: 20,
            top: 16,
            bottom: MediaQuery.of(context).viewInsets.bottom + 16,
          ),
          child: SingleChildScrollView(
            child: Column(
              mainAxisSize: MainAxisSize.min,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // Handle bar
                Center(
                  child: Container(
                    width: 40,
                    height: 4,
                    decoration: BoxDecoration(
                      color: QuietLuxury.cardBorder,
                      borderRadius: BorderRadius.circular(2),
                    ),
                  ),
                ),
                const SizedBox(height: 20),

                // Pursuit info header
                _buildPursuitHeader(),
                const SizedBox(height: 24),

                // Title
                Text(l10n.addSavings, style: QuietLuxury.heading),
                const SizedBox(height: 16),

                // Amount input
                TextField(
                  controller: _amountController,
                  style: QuietLuxury.body.copyWith(
                    color: QuietLuxury.textPrimary,
                  ),
                  decoration: InputDecoration(
                    hintText: '0',
                    prefixText: currencySymbol,
                    hintStyle: QuietLuxury.body.copyWith(
                      color: QuietLuxury.textTertiary,
                    ),
                    prefixStyle: QuietLuxury.body.copyWith(
                      color: QuietLuxury.textSecondary,
                    ),
                    filled: true,
                    fillColor: QuietLuxury.cardBackground,
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(16),
                      borderSide: BorderSide(color: QuietLuxury.cardBorder),
                    ),
                    enabledBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(16),
                      borderSide: BorderSide(color: QuietLuxury.cardBorder),
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(16),
                      borderSide: BorderSide(
                        color: QuietLuxury.positive.withValues(alpha: 0.5),
                      ),
                    ),
                    contentPadding: const EdgeInsets.symmetric(
                      horizontal: 16,
                      vertical: 14,
                    ),
                  ),
                  keyboardType: TextInputType.number,
                  inputFormatters: [FilteringTextInputFormatter.digitsOnly],
                  autofocus: widget.prefilledAmount == null,
                ),
                const SizedBox(height: 16),

                // Quick amount chips
                Text(
                  l10n.quickAmounts,
                  style: QuietLuxury.label.copyWith(
                    color: QuietLuxury.textSecondary,
                  ),
                ),
                const SizedBox(height: 8),
                Wrap(
                  spacing: 8,
                  runSpacing: 8,
                  children: quickAmounts.map((amount) {
                    return _QuickAmountChip(
                      amount: amount,
                      currencySymbol: currencySymbol,
                      onTap: () {
                        HapticFeedback.selectionClick();
                        _amountController.text = amount.toStringAsFixed(0);
                      },
                    );
                  }).toList(),
                ),
                const SizedBox(height: 20),

                // Optional note
                TextField(
                  controller: _noteController,
                  keyboardType: TextInputType.text,
                  enableSuggestions: true,
                  autocorrect: false,
                  enableIMEPersonalizedLearning: true,
                  textCapitalization: TextCapitalization.sentences,
                  style: QuietLuxury.body.copyWith(
                    color: QuietLuxury.textPrimary,
                  ),
                  decoration: InputDecoration(
                    hintText: l10n.addNote,
                    hintStyle: QuietLuxury.body.copyWith(
                      color: QuietLuxury.textTertiary,
                    ),
                    filled: true,
                    fillColor: QuietLuxury.cardBackground,
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(16),
                      borderSide: BorderSide(color: QuietLuxury.cardBorder),
                    ),
                    enabledBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(16),
                      borderSide: BorderSide(color: QuietLuxury.cardBorder),
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(16),
                      borderSide: BorderSide(
                        color: QuietLuxury.positive.withValues(alpha: 0.5),
                      ),
                    ),
                    contentPadding: const EdgeInsets.symmetric(
                      horizontal: 16,
                      vertical: 14,
                    ),
                    prefixIcon: Icon(
                      CupertinoIcons.doc_text,
                      color: QuietLuxury.textTertiary,
                      size: 20,
                    ),
                  ),
                  maxLines: 2,
                ),
                const SizedBox(height: 24),

                // Add button
                Semantics(
                  label: l10n.accessibilityAddSavings,
                  button: true,
                  child: SizedBox(
                    width: double.infinity,
                    child: ElevatedButton(
                      onPressed: _isLoading ? null : _onSubmit,
                      style: ElevatedButton.styleFrom(
                        backgroundColor: QuietLuxury.positive,
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(vertical: 16),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(16),
                        ),
                        disabledBackgroundColor: QuietLuxury.positive
                            .withValues(alpha: 0.5),
                      ),
                      child: _isLoading
                          ? const SizedBox(
                              width: 20,
                              height: 20,
                              child: CircularProgressIndicator(
                                strokeWidth: 2,
                                valueColor: AlwaysStoppedAnimation<Color>(
                                  Colors.white,
                                ),
                              ),
                            )
                          : Row(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                Icon(CupertinoIcons.add, size: 18),
                                const SizedBox(width: 8),
                                Text(
                                  l10n.addSavings,
                                  style: const TextStyle(
                                    fontSize: 16,
                                    fontWeight: FontWeight.w600,
                                  ),
                                ),
                              ],
                            ),
                    ),
                  ),
                ),
                const SizedBox(height: 8),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildPursuitHeader() {
    final currencyProvider = context.watch<CurrencyProvider>();

    return GlassCard(
      padding: const EdgeInsets.all(12),
      child: Row(
        children: [
          PursuitProgressVisual(
            progress: widget.pursuit.progressPercent,
            emoji: widget.pursuit.emoji,
            size: 48,
            animate: false,
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  widget.pursuit.name,
                  style: QuietLuxury.body.copyWith(
                    color: QuietLuxury.textPrimary,
                    fontWeight: FontWeight.w500,
                  ),
                  maxLines: 1,
                  overflow: TextOverflow.ellipsis,
                ),
                const SizedBox(height: 4),
                Row(
                  children: [
                    Text(
                      '${currencyProvider.currency.symbol}${widget.pursuit.savedAmount.toStringAsFixed(0)}',
                      style: QuietLuxury.label.copyWith(
                        color: QuietLuxury.positive,
                      ),
                    ),
                    Text(
                      ' / ${currencyProvider.currency.symbol}${widget.pursuit.targetAmount.toStringAsFixed(0)}',
                      style: QuietLuxury.label,
                    ),
                  ],
                ),
              ],
            ),
          ),
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
            decoration: BoxDecoration(
              color: QuietLuxury.positive.withValues(alpha: 0.2),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Text(
              '${widget.pursuit.progressPercentDisplay}%',
              style: QuietLuxury.label.copyWith(
                color: QuietLuxury.positive,
                fontWeight: FontWeight.w600,
              ),
            ),
          ),
        ],
      ),
    );
  }

  double _parseAmount(String value) {
    final cleaned = value
        .replaceAll('.', '')
        .replaceAll(',', '.')
        .replaceAll(RegExp(r'[^\d.]'), '');
    return double.tryParse(cleaned) ?? 0;
  }

  Future<void> _onSubmit() async {
    final amount = _parseAmount(_amountController.text);
    if (amount <= 0) {
      HapticFeedback.heavyImpact();
      return;
    }

    final l10n = AppLocalizations.of(context);
    final pursuitProvider = context.read<PursuitProvider>();
    final currencyProvider = context.read<CurrencyProvider>();
    final poolProvider = context.read<SavingsPoolProvider>();
    final symbol = currencyProvider.currency.symbol;

    // Check pool status
    final poolAvailable = poolProvider.available;
    final hasDebt = poolProvider.hasDebt;
    final debtAmount = poolProvider.shadowDebt;

    double finalAmount = amount;
    bool createDebt = false;
    bool isOneTimeIncome = false;

    // Case 1: Pool has debt - ask about source
    if (hasDebt) {
      final choice = await showDebtSourceDialog(
        context,
        debtAmount: debtAmount,
        currencySymbol: symbol,
      );

      if (choice == null || choice == DebtSourceChoice.cancel) {
        return; // User cancelled
      }

      if (choice == DebtSourceChoice.oneTimeIncome) {
        isOneTimeIncome = true;
        // Don't deduct from pool, add directly
      } else {
        // From savings - pool goes more negative
        createDebt = true;
      }
    }
    // Case 2: Pool is positive but amount > available
    else if (poolAvailable < amount) {
      final choice = await showPoolAllocationDialog(
        context,
        available: poolAvailable,
        requested: amount,
        currencySymbol: symbol,
      );

      if (choice == null || choice == PoolAllocationChoice.cancel) {
        return; // User cancelled
      }

      switch (choice) {
        case PoolAllocationChoice.fromPocket:
          // Zero out pool + add difference from pocket (use extraIncome source)
          isOneTimeIncome = true;
          break;
        case PoolAllocationChoice.createDebt:
          // Pool goes negative
          createDebt = true;
          break;
        case PoolAllocationChoice.availableOnly:
          // Only use available
          finalAmount = poolAvailable;
          break;
        case PoolAllocationChoice.cancel:
          return;
      }
    }

    if (finalAmount <= 0) {
      HapticFeedback.heavyImpact();
      return;
    }

    setState(() => _isLoading = true);

    try {
      // Deduct from pool (unless one-time income)
      if (!isOneTimeIncome) {
        if (createDebt) {
          // Create shadow debt
          await poolProvider.createShadowDebt(finalAmount, widget.pursuit.id);
        } else {
          // Normal allocation from pool
          await poolProvider.allocateToDream(finalAmount, widget.pursuit.id);
        }
      }

      // Add to pursuit
      final reachedTarget = await pursuitProvider.addSavings(
        widget.pursuit.id,
        finalAmount,
        source: isOneTimeIncome ? TransactionSource.manual : widget.source,
        note: _noteController.text.trim().isEmpty
            ? null
            : _noteController.text.trim(),
        currency: currencyProvider.currency.code,
      );

      HapticFeedback.mediumImpact();

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(l10n.savingsAdded),
            backgroundColor: QuietLuxury.positive,
            behavior: SnackBarBehavior.floating,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(8),
            ),
          ),
        );
        Navigator.of(context).pop(reachedTarget);
      }
    } catch (e) {
      HapticFeedback.heavyImpact();
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Hata: $e'),
            backgroundColor: QuietLuxury.negative,
          ),
        );
      }
    } finally {
      if (mounted) {
        setState(() => _isLoading = false);
      }
    }
  }
}

class _QuickAmountChip extends StatelessWidget {
  final double amount;
  final String currencySymbol;
  final VoidCallback onTap;

  const _QuickAmountChip({
    required this.amount,
    required this.currencySymbol,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    final formattedAmount = '+$currencySymbol${amount.toStringAsFixed(0)}';
    return Semantics(
      label: formattedAmount,
      button: true,
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(24),
        child: Container(
          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
          decoration: BoxDecoration(
            color: QuietLuxury.cardBackground,
            borderRadius: BorderRadius.circular(24),
            border: Border.all(color: QuietLuxury.cardBorder, width: 0.5),
          ),
          child: Text(
            formattedAmount,
            style: QuietLuxury.label.copyWith(
              color: QuietLuxury.positive,
              fontWeight: FontWeight.w600,
            ),
          ),
        ),
      ),
    );
  }
}

/// Show the add savings sheet
Future<bool?> showAddSavingsSheet(
  BuildContext context, {
  required Pursuit pursuit,
  TransactionSource source = TransactionSource.manual,
  double? prefilledAmount,
}) {
  return showModalBottomSheet<bool>(
    context: context,
    isScrollControlled: true,
    barrierColor: Colors.black.withValues(alpha: 0.85),
    backgroundColor: Colors.transparent,
    builder: (_) => AddSavingsSheet(
      pursuit: pursuit,
      source: source,
      prefilledAmount: prefilledAmount,
    ),
  );
}


--- FILE: lib/widgets/onboarding_checklist.dart ---

import 'dart:ui';
import 'package:confetti/confetti.dart';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../providers/providers.dart';
import '../services/services.dart';
import '../theme/theme.dart';

/// Checklist item data model
class ChecklistItem {
  final String id;
  final String title;
  final String subtitle;
  final String duration;
  final IconData icon;
  final Color iconColor;
  final bool isCompleted;
  final VoidCallback? onTap;

  const ChecklistItem({
    required this.id,
    required this.title,
    required this.subtitle,
    required this.duration,
    required this.icon,
    required this.iconColor,
    required this.isCompleted,
    this.onTap,
  });
}

/// Onboarding checklist widget for main screen
/// Shows 4 quick-win items to guide new users
/// Dismisses after 3 items completed with celebration
class OnboardingChecklist extends StatefulWidget {
  final VoidCallback? onAddExpense;
  final VoidCallback? onViewReport;
  final VoidCallback? onCreatePursuit;
  final VoidCallback? onEnableNotifications;

  const OnboardingChecklist({
    super.key,
    this.onAddExpense,
    this.onViewReport,
    this.onCreatePursuit,
    this.onEnableNotifications,
  });

  @override
  State<OnboardingChecklist> createState() => _OnboardingChecklistState();
}

class _OnboardingChecklistState extends State<OnboardingChecklist>
    with TickerProviderStateMixin {
  static const String _keyChecklistDismissed = 'onboarding_checklist_dismissed';
  static const String _keyNotificationsEnabled = 'checklist_notifications_done';

  late ConfettiController _confettiController;
  late AnimationController _celebrationController;
  late Animation<double> _celebrationScale;

  // iOS 26 Liquid Glass: Animated breathing glow
  late AnimationController _glowController;
  late Animation<double> _glowAnimation;

  bool _isDismissed = false;
  bool _showCelebration = false;
  bool _notificationsCompleted = false;

  @override
  void initState() {
    super.initState();
    _confettiController = ConfettiController(
      duration: const Duration(seconds: 3),
    );
    _celebrationController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 600),
    );
    _celebrationScale = Tween<double>(begin: 0.0, end: 1.0).animate(
      CurvedAnimation(
        parent: _celebrationController,
        curve: Curves.elasticOut,
      ),
    );

    // iOS 26 Liquid Glass: Breathing glow effect
    _glowController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 2500),
    )..repeat(reverse: true);

    _glowAnimation = Tween<double>(begin: 0.2, end: 0.5).animate(
      CurvedAnimation(parent: _glowController, curve: Curves.easeInOut),
    );

    _loadState();
  }

  Future<void> _loadState() async {
    final prefs = await SharedPreferences.getInstance();
    if (mounted) {
      setState(() {
        _isDismissed = prefs.getBool(_keyChecklistDismissed) ?? false;
        _notificationsCompleted = prefs.getBool(_keyNotificationsEnabled) ?? false;
      });
    }
  }

  @override
  void dispose() {
    _confettiController.dispose();
    _celebrationController.dispose();
    _glowController.dispose();
    super.dispose();
  }

  Future<void> _dismissChecklist({bool isDismissedEarly = false}) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_keyChecklistDismissed, true);

    if (isDismissedEarly) {
      // Track early dismissal
      final financeProvider = context.read<FinanceProvider>();
      final pursuitProvider = context.read<PursuitProvider>();
      int completedCount = 0;
      if (financeProvider.expenses.isNotEmpty) completedCount++;
      if (financeProvider.expenses.length >= 3) completedCount++;
      if (pursuitProvider.allPursuits.isNotEmpty) completedCount++;
      if (_notificationsCompleted) completedCount++;

      AnalyticsService().logChecklistDismissed(completedCount: completedCount);
    }

    setState(() {
      _isDismissed = true;
    });
  }

  Future<void> _markNotificationsDone() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_keyNotificationsEnabled, true);
    setState(() {
      _notificationsCompleted = true;
    });
  }

  void _checkCompletion(List<ChecklistItem> items) {
    final completedCount = items.where((i) => i.isCompleted).length;

    // Show celebration when 3 items completed
    if (completedCount >= 3 && !_showCelebration) {
      _showCelebration = true;
      _confettiController.play();
      _celebrationController.forward();
      HapticFeedback.heavyImpact();

      // Track analytics
      AnalyticsService().logChecklistCompleted(totalTimeMinutes: 5); // Estimate
      AnalyticsService().logCelebrationShown(
        celebrationType: 'confetti',
        milestoneName: 'checklist_completed',
      );

      // Auto-dismiss after celebration
      Future.delayed(const Duration(seconds: 3), () {
        if (mounted) {
          _dismissChecklist();
        }
      });
    }
  }


  @override
  Widget build(BuildContext context) {
    if (_isDismissed) return const SizedBox.shrink();

    final l10n = AppLocalizations.of(context);
    final financeProvider = context.watch<FinanceProvider>();
    final pursuitProvider = context.watch<PursuitProvider>();

    // Build checklist items
    final items = _buildItems(
      l10n,
      financeProvider,
      pursuitProvider,
    );

    // Check if should show celebration
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _checkCompletion(items);
    });

    final completedCount = items.where((i) => i.isCompleted).length;
    final progress = completedCount / items.length;

    return Stack(
      children: [
        // Main checklist card
        AnimatedSwitcher(
          duration: const Duration(milliseconds: 400),
          child: _showCelebration
              ? _buildCelebrationCard(l10n, completedCount)
              : _buildChecklistCard(l10n, items, progress, completedCount),
        ),

        // Confetti
        Positioned.fill(
          child: Align(
            alignment: Alignment.topCenter,
            child: ConfettiWidget(
              confettiController: _confettiController,
              blastDirectionality: BlastDirectionality.explosive,
              particleDrag: 0.05,
              emissionFrequency: 0.05,
              numberOfParticles: 20,
              gravity: 0.1,
              colors: [
                context.appColors.primary,
                context.appColors.accent,
                context.appColors.success,
                context.appColors.warning,
              ],
            ),
          ),
        ),
      ],
    );
  }

  List<ChecklistItem> _buildItems(
    AppLocalizations l10n,
    FinanceProvider financeProvider,
    PursuitProvider pursuitProvider,
  ) {
    final hasExpenses = financeProvider.expenses.isNotEmpty;
    final hasPursuits = pursuitProvider.allPursuits.isNotEmpty;
    final hasMultipleExpenses = financeProvider.expenses.length >= 3;

    final items = <ChecklistItem>[
      // Item 1: Add first expense (quick win)
      ChecklistItem(
        id: 'add_expense',
        title: l10n.checklistFirstExpenseTitle,
        subtitle: l10n.checklistFirstExpenseSubtitle,
        duration: '1 dk',
        icon: CupertinoIcons.doc_text_fill,
        iconColor: context.appColors.primary,
        isCompleted: hasExpenses,
        onTap: widget.onAddExpense,
      ),

      // Item 2: View your first report
      ChecklistItem(
        id: 'view_report',
        title: l10n.checklistViewReportTitle,
        subtitle: l10n.checklistViewReportSubtitle,
        duration: '30 sn',
        icon: CupertinoIcons.chart_bar_fill,
        iconColor: context.appColors.accent,
        isCompleted: hasMultipleExpenses, // Needs some data to be meaningful
        onTap: widget.onViewReport,
      ),

      // Item 3: Create a savings goal
      ChecklistItem(
        id: 'create_pursuit',
        title: l10n.checklistCreatePursuitTitle,
        subtitle: l10n.checklistCreatePursuitSubtitle,
        duration: '1 dk',
        icon: CupertinoIcons.scope,
        iconColor: context.appColors.success,
        isCompleted: hasPursuits,
        onTap: widget.onCreatePursuit,
      ),

      // Item 4: Enable notifications
      ChecklistItem(
        id: 'enable_notifications',
        title: l10n.checklistNotificationsTitle,
        subtitle: l10n.checklistNotificationsSubtitle,
        duration: '30 sn',
        icon: CupertinoIcons.bell_fill,
        iconColor: context.appColors.warning,
        isCompleted: _notificationsCompleted,
        onTap: () async {
          HapticFeedback.lightImpact();
          final granted = await NotificationService().requestPermission();
          if (granted) {
            await _markNotificationsDone();
            // Calculate completed count manually
            int completedCount = 0;
            if (hasExpenses) completedCount++;
            if (hasMultipleExpenses) completedCount++;
            if (hasPursuits) completedCount++;
            completedCount++; // This notification item
            AnalyticsService().logChecklistItemCompleted(
              itemName: 'enable_notifications',
              itemIndex: 3,
              totalCompleted: completedCount,
            );
          }
          widget.onEnableNotifications?.call();
        },
      ),
    ];
    return items;
  }

  Widget _buildChecklistCard(
    AppLocalizations l10n,
    List<ChecklistItem> items,
    double progress,
    int completedCount,
  ) {
    // iOS 26 Liquid Glass: Animated card with breathing glow
    return AnimatedBuilder(
      animation: _glowAnimation,
      builder: (context, child) {
        return Padding(
          key: const ValueKey('checklist'),
          padding: const EdgeInsets.all(16),
          // iOS 26: Outer glow container
          child: Container(
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(28),
              boxShadow: [
                // Animated breathing glow
                BoxShadow(
                  color: const Color(0xFF8B5CF6).withValues(
                    alpha: _glowAnimation.value,
                  ),
                  blurRadius: 32,
                  spreadRadius: 0,
                  offset: const Offset(0, 8),
                ),
                // Deep shadow for depth
                BoxShadow(
                  color: Colors.black.withValues(alpha: 0.35),
                  blurRadius: 20,
                  offset: const Offset(0, 10),
                ),
              ],
            ),
            child: ClipRRect(
              borderRadius: BorderRadius.circular(28),
              child: BackdropFilter(
                // iOS 26: Enhanced 24σ blur
                filter: ImageFilter.blur(sigmaX: 24, sigmaY: 24),
                child: Container(
                  decoration: BoxDecoration(
                    borderRadius: BorderRadius.circular(28),
                    // iOS 26 Liquid Glass: Premium gradient
                    gradient: LinearGradient(
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                      colors: [
                        const Color(0xFF8B5CF6).withValues(alpha: 0.25),
                        const Color(0xFF7C3AED).withValues(alpha: 0.18),
                        const Color(0xFF1E1B4B).withValues(alpha: 0.35),
                      ],
                      stops: const [0.0, 0.5, 1.0],
                    ),
                    // Glass border
                    border: Border.all(
                      color: Colors.white.withValues(alpha: 0.2),
                      width: 1.5,
                    ),
                  ),
                  child: Stack(
                    children: [
                      // iOS 26: Top highlight for glass light refraction
                      Positioned(
                        top: 0,
                        left: 0,
                        right: 0,
                        height: 50,
                        child: Container(
                          decoration: BoxDecoration(
                            borderRadius: const BorderRadius.vertical(
                              top: Radius.circular(28),
                            ),
                            gradient: LinearGradient(
                              begin: Alignment.topCenter,
                              end: Alignment.bottomCenter,
                              colors: [
                                Colors.white.withValues(alpha: 0.12),
                                Colors.white.withValues(alpha: 0.0),
                              ],
                            ),
                          ),
                        ),
                      ),
                      // Content
                      Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          // Header with progress
          Padding(
            padding: const EdgeInsets.fromLTRB(20, 16, 12, 12),
            child: Row(
              children: [
                // Title
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        l10n.checklistTitle,
                        style: TextStyle(
                          fontSize: 16,
                          fontWeight: FontWeight.w700,
                          color: context.appColors.textPrimary,
                        ),
                      ),
                      const SizedBox(height: 4),
                      Text(
                        l10n.checklistProgress(completedCount, items.length),
                        style: TextStyle(
                          fontSize: 13,
                          color: context.appColors.textSecondary,
                        ),
                      ),
                    ],
                  ),
                ),

                // Dismiss button
                IconButton(
                  onPressed: () => _dismissChecklist(isDismissedEarly: true),
                  icon: Icon(
                    CupertinoIcons.xmark,
                    size: 20,
                    color: context.appColors.textTertiary,
                  ),
                ),
              ],
            ),
          ),

          // Progress bar
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 20),
            child: ClipRRect(
              borderRadius: BorderRadius.circular(4),
              child: LinearProgressIndicator(
                value: progress,
                backgroundColor: context.appColors.surfaceLight,
                valueColor: AlwaysStoppedAnimation(context.appColors.success),
                minHeight: 6,
              ),
            ),
          ),

          const SizedBox(height: 16),

          // Checklist items
          ...items.map((item) => _buildChecklistItem(item)),

                        const SizedBox(height: 8),
                      ],
                    ),
                  ],
                ),
              ),
            ),
          ),
        ),
      );
      },
    );
  }

  Widget _buildChecklistItem(ChecklistItem item) {
    return Material(
      color: Colors.transparent,
      child: InkWell(
        onTap: item.isCompleted ? null : item.onTap,
        borderRadius: BorderRadius.circular(16),
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
          child: Row(
            children: [
              // Status indicator
              AnimatedContainer(
                duration: const Duration(milliseconds: 300),
                width: 44,
                height: 44,
                decoration: BoxDecoration(
                  color: item.isCompleted
                      ? context.appColors.success.withValues(alpha: 0.15)
                      : item.iconColor.withValues(alpha: 0.1),
                  borderRadius: BorderRadius.circular(16),
                  border: Border.all(
                    color: item.isCompleted
                        ? context.appColors.success.withValues(alpha: 0.3)
                        : item.iconColor.withValues(alpha: 0.2),
                  ),
                ),
                child: Icon(
                  item.isCompleted ? CupertinoIcons.checkmark_circle_fill : item.icon,
                  size: 22,
                  color: item.isCompleted
                      ? context.appColors.success
                      : item.iconColor,
                ),
              ),
              const SizedBox(width: 14),

              // Content
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      item.title,
                      style: TextStyle(
                        fontSize: 14,
                        fontWeight: FontWeight.w600,
                        color: item.isCompleted
                            ? context.appColors.textTertiary
                            : context.appColors.textPrimary,
                        decoration: item.isCompleted
                            ? TextDecoration.lineThrough
                            : null,
                      ),
                    ),
                    const SizedBox(height: 2),
                    Text(
                      item.subtitle,
                      style: TextStyle(
                        fontSize: 12,
                        color: context.appColors.textTertiary,
                      ),
                    ),
                  ],
                ),
              ),

              // Duration badge or checkmark
              if (!item.isCompleted)
                Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 10,
                    vertical: 4,
                  ),
                  decoration: BoxDecoration(
                    color: context.appColors.surfaceLight,
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Text(
                    item.duration,
                    style: TextStyle(
                      fontSize: 11,
                      fontWeight: FontWeight.w600,
                      color: context.appColors.textSecondary,
                    ),
                  ),
                )
              else
                Icon(
                  CupertinoIcons.checkmark,
                  size: 20,
                  color: context.appColors.success,
                ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildCelebrationCard(AppLocalizations l10n, int completedCount) {
    return ScaleTransition(
      scale: _celebrationScale,
      child: Container(
        key: const ValueKey('celebration'),
        margin: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(28),
          boxShadow: [
            // Success glow
            BoxShadow(
              color: context.appColors.success.withValues(alpha: 0.5),
              blurRadius: 32,
              spreadRadius: 0,
              offset: const Offset(0, 8),
            ),
          ],
        ),
        child: ClipRRect(
          borderRadius: BorderRadius.circular(28),
          child: BackdropFilter(
            filter: ImageFilter.blur(sigmaX: 24, sigmaY: 24),
            child: Container(
              padding: const EdgeInsets.all(24),
              decoration: BoxDecoration(
                // iOS 26 Liquid Glass: Success gradient
                gradient: LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: [
                    context.appColors.success.withValues(alpha: 0.25),
                    const Color(0xFF8B5CF6).withValues(alpha: 0.15),
                    const Color(0xFF1E1B4B).withValues(alpha: 0.3),
                  ],
                  stops: const [0.0, 0.5, 1.0],
                ),
                borderRadius: BorderRadius.circular(28),
                border: Border.all(
                  color: context.appColors.success.withValues(alpha: 0.4),
                  width: 2,
                ),
              ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            // Trophy icon
            Container(
              width: 64,
              height: 64,
              decoration: BoxDecoration(
                color: context.appColors.success.withValues(alpha: 0.2),
                shape: BoxShape.circle,
              ),
              child: Icon(
                CupertinoIcons.rosette,
                size: 32,
                color: context.appColors.success,
              ),
            ),
            const SizedBox(height: 16),

            // Title
            Text(
              l10n.checklistCelebrationTitle,
              textAlign: TextAlign.center,
              style: TextStyle(
                fontSize: 20,
                fontWeight: FontWeight.w700,
                color: context.appColors.textPrimary,
              ),
            ),
            const SizedBox(height: 8),

            // Subtitle
            Text(
              l10n.checklistCelebrationSubtitle,
              textAlign: TextAlign.center,
              style: TextStyle(
                fontSize: 14,
                color: context.appColors.textSecondary,
              ),
            ),
          ],
        ),
      ),
    ),
  ),
),
    );
  }
}

/// Extension to check if checklist should be shown
extension OnboardingChecklistExtension on BuildContext {
  Future<bool> shouldShowOnboardingChecklist() async {
    final prefs = await SharedPreferences.getInstance();
    return !(prefs.getBool('onboarding_checklist_dismissed') ?? false);
  }
}


--- FILE: lib/widgets/currency_rate_widget.dart ---

import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/currency.dart';
import '../providers/currency_provider.dart';
import '../services/services.dart';
import '../theme/theme.dart';
import '../screens/currency_detail_screen.dart';

/// Rate item data model
class _RateItem {
  final String symbol;
  final String value;
  final bool showWarning;

  const _RateItem({
    required this.symbol,
    required this.value,
    this.showWarning = false,
  });
}

class CurrencyRateWidget extends StatelessWidget {
  final ExchangeRates? rates;
  final bool isLoading;
  final bool hasError;
  final VoidCallback? onRetry;

  const CurrencyRateWidget({
    super.key,
    this.rates,
    this.isLoading = false,
    this.hasError = false,
    this.onRetry,
  });

  /// Main currencies to show in ticker (excluding selected one)
  static const _mainCurrencyCodes = ['USD', 'EUR', 'GBP'];

  String _formatRate(double rate, int decimals) {
    if (rate >= 1000) {
      return rate
          .toStringAsFixed(0)
          .replaceAllMapped(
            RegExp(r'(\d{1,3})(?=(\d{3})+(?!\d))'),
            (Match m) => '${m[1]},',
          );
    }
    return rate.toStringAsFixed(decimals);
  }

  /// Get TRY value of a currency (how many TRY per 1 unit)
  double _getTryValue(String code, ExchangeRates rates) {
    switch (code) {
      case 'TRY':
        return 1.0;
      case 'USD':
        return rates.usdRate;
      case 'EUR':
        return rates.eurRate;
      case 'GBP':
        // GBP not from TCMB, approximate via USD
        return rates.usdRate * 1.27;
      case 'SAR':
        // SAR pegged to USD at 3.75
        return rates.usdRate / 3.75;
      default:
        return 1.0;
    }
  }

  /// Calculate exchange rate: how many units of [base] per 1 unit of [target]
  double _calculateRate(String targetCode, Currency base, ExchangeRates rates) {
    final targetInTry = _getTryValue(targetCode, rates);
    final baseInTry = _getTryValue(base.code, rates);

    if (baseInTry <= 0) return 0;
    return targetInTry / baseInTry;
  }

  /// Build currency item for ticker
  _RateItem _buildCurrencyItem(
    String targetCode,
    Currency base,
    ExchangeRates rates,
  ) {
    final target = getCurrencyByCode(targetCode);
    final rate = _calculateRate(targetCode, base, rates);

    // Use 2 decimals for TRY (large numbers), 4 for others
    final decimals = base.code == 'TRY' ? 2 : 4;

    return _RateItem(
      symbol: target.symbol,
      value: '${_formatRate(rate, decimals)} ${base.symbol}',
    );
  }

  /// Build gold item for ticker
  _RateItem _buildGoldItem(
    Currency base,
    ExchangeRates rates,
    AppLocalizations l10n,
  ) {
    final goldOzUsd = rates.goldOzUsd;
    final usdTry = rates.usdRate;
    final showWarning = !rates.goldFromApi;

    if (base.code == 'TRY') {
      // TRY: Show gold per gram
      final goldGramTry = (goldOzUsd ?? 0) * usdTry / 31.1035;
      return _RateItem(
        symbol: l10n.gold,
        value: '${_formatRate(goldGramTry, 0)} ₺/${base.goldUnit}',
        showWarning: showWarning,
      );
    } else {
      // Other currencies: Show gold per ounce in selected currency
      if (goldOzUsd == null) {
        return _RateItem(
          symbol: l10n.gold,
          value: '-',
          showWarning: showWarning,
        );
      }

      final baseInTry = _getTryValue(base.code, rates);
      final goldInBase = (goldOzUsd * usdTry) / baseInTry;

      return _RateItem(
        symbol: l10n.gold,
        value: '${_formatRate(goldInBase, 0)} ${base.symbol}/${base.goldUnit}',
        showWarning: showWarning,
      );
    }
  }

  /// Get rate items based on selected currency - DYNAMIC!
  /// Removes selected currency from list, shows remaining + gold
  List<_RateItem> _getRateItems(
    Currency selected,
    ExchangeRates rates,
    AppLocalizations l10n,
  ) {
    final items = <_RateItem>[];

    // Filter out selected currency from main list
    final currenciesToShow = _mainCurrencyCodes
        .where((code) => code != selected.code)
        .toList();

    // Build currency items
    for (final code in currenciesToShow) {
      items.add(_buildCurrencyItem(code, selected, rates));
    }

    // Gold always at the end
    items.add(_buildGoldItem(selected, rates, l10n));

    return items;
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final currencyProvider = context.watch<CurrencyProvider>();
    final selectedCurrency = currencyProvider.currency;

    return Semantics(
      button: true,
      label: l10n.currencyRatesDescription,
      child: GestureDetector(
        onTap: () {
          if (rates != null) {
            Navigator.push(
              context,
              MaterialPageRoute(
                builder: (context) => CurrencyDetailScreen(rates: rates!),
              ),
            );
          }
        },
        child: ClipRRect(
          borderRadius: BorderRadius.circular(16),
          child: BackdropFilter(
            filter: ImageFilter.blur(sigmaX: 15, sigmaY: 15),
            child: Container(
              padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
              decoration: BoxDecoration(
                // Glass effect: semi-transparent with blur
                color: context.appColors.surface.withValues(alpha: 0.6),
                borderRadius: BorderRadius.circular(16),
                border: Border.all(
                  color: Colors.white.withValues(alpha: 0.15),
                  width: 1,
                ),
                // Subtle inner glow
                boxShadow: [
                  BoxShadow(
                    color: context.appColors.primary.withValues(alpha: 0.1),
                    blurRadius: 12,
                    spreadRadius: 0,
                  ),
                ],
              ),
              child: _buildContent(context, l10n, selectedCurrency),
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildContent(
    BuildContext context,
    AppLocalizations l10n,
    Currency selectedCurrency,
  ) {
    // Loading state
    if (isLoading) {
      return Row(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          SizedBox(
            width: 14,
            height: 14,
            child: CircularProgressIndicator(
              strokeWidth: 2,
              valueColor: AlwaysStoppedAnimation<Color>(
                context.appColors.textTertiary.withValues(alpha: 0.7),
              ),
            ),
          ),
          const SizedBox(width: 10),
          Text(
            l10n.ratesLoading,
            style: TextStyle(
              fontSize: 12,
              color: context.appColors.textTertiary,
            ),
          ),
        ],
      );
    }

    // Error state
    if (hasError || rates == null) {
      return Row(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            CupertinoIcons.exclamationmark_circle,
            size: 14,
            color: context.appColors.textTertiary,
          ),
          const SizedBox(width: 8),
          Text(
            l10n.ratesLoadFailed,
            style: TextStyle(
              fontSize: 12,
              color: context.appColors.textTertiary,
            ),
          ),
          if (onRetry != null) ...[
            const SizedBox(width: 8),
            Semantics(
              button: true,
              label: l10n.retry,
              child: GestureDetector(
                onTap: onRetry,
                child: Text(
                  l10n.retry,
                  style: TextStyle(
                    fontSize: 12,
                    color: context.appColors.primary,
                    fontWeight: FontWeight.w500,
                  ),
                ),
              ),
            ),
          ],
        ],
      );
    }

    // Get currency-aware rate items
    final rateItems = _getRateItems(selectedCurrency, rates!, l10n);

    // Normal view with currency-aware rates - FittedBox prevents overflow
    return FittedBox(
      fit: BoxFit.scaleDown,
      child: Row(
        mainAxisAlignment: MainAxisAlignment.center,
        mainAxisSize: MainAxisSize.min,
        children: [
          for (int i = 0; i < rateItems.length; i++) ...[
            if (i > 0) _buildDivider(context),
            _buildRateItem(context, rateItems[i], l10n),
          ],
          const SizedBox(width: 8),
          Icon(
            CupertinoIcons.chevron_right,
            size: 16,
            color: context.appColors.textTertiary.withValues(alpha: 0.7),
          ),
        ],
      ),
    );
  }

  Widget _buildRateItem(
    BuildContext context,
    _RateItem item,
    AppLocalizations l10n,
  ) {
    return Row(
      mainAxisSize: MainAxisSize.min,
      children: [
        Text(
          item.symbol,
          style: TextStyle(
            fontSize: 12,
            fontWeight: FontWeight.w500,
            color: context.appColors.textSecondary,
          ),
        ),
        const SizedBox(width: 4),
        Text(
          item.value,
          style: TextStyle(
            fontSize: 12,
            fontWeight: FontWeight.w600,
            color: context.appColors.textPrimary,
          ),
        ),
        if (item.showWarning) ...[
          const SizedBox(width: 4),
          Tooltip(
            message: l10n.goldPriceNotUpdated,
            child: Icon(
              CupertinoIcons.info_circle,
              size: 12,
              color: context.appColors.warning.withValues(alpha: 0.8),
            ),
          ),
        ],
      ],
    );
  }

  Widget _buildDivider(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 12),
      child: Text(
        '|',
        style: TextStyle(
          fontSize: 12,
          color: context.appColors.textTertiary.withValues(alpha: 0.5),
        ),
      ),
    );
  }
}


--- FILE: lib/widgets/turkish_currency_input.dart ---

import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../providers/currency_provider.dart';
import '../utils/currency_utils.dart';

// Re-export currency utils for backward compatibility
export '../utils/currency_utils.dart';

/// Türkçe para girişi için hazır TextField widget'ı
class TurkishCurrencyTextField extends StatelessWidget {
  final TextEditingController controller;
  final String? label;
  final String? hint;
  final FocusNode? focusNode;
  final ValueChanged<double?>? onChanged;
  final VoidCallback? onEditingComplete;
  final InputDecoration? decoration;
  final bool allowDecimals;
  final int maxIntegerDigits;

  const TurkishCurrencyTextField({
    super.key,
    required this.controller,
    this.label,
    this.hint,
    this.focusNode,
    this.onChanged,
    this.onEditingComplete,
    this.decoration,
    this.allowDecimals = true,
    this.maxIntegerDigits = 12, // Trilyonlara kadar
  });

  @override
  Widget build(BuildContext context) {
    return TextField(
      controller: controller,
      focusNode: focusNode,
      keyboardType: const TextInputType.numberWithOptions(decimal: true),
      inputFormatters: [
        PremiumCurrencyFormatter(
          allowDecimals: allowDecimals,
          maxIntegerDigits: maxIntegerDigits,
        ),
      ],
      decoration:
          decoration ??
          InputDecoration(labelText: label, hintText: hint ?? 'Tutar (₺)'),
      onChanged: (value) {
        if (onChanged != null) {
          onChanged!(parseAmount(value));
        }
      },
      onEditingComplete: onEditingComplete,
    );
  }
}

/// Premium gelir/gider girişi için özelleştirilmiş widget
class PremiumAmountInput extends StatefulWidget {
  final TextEditingController? controller;
  final double? initialValue;
  final String label;
  final String? hint;
  final String? prefix;
  final String? suffix;
  final bool showCurrency;
  final ValueChanged<double?>? onChanged;
  final FormFieldValidator<String>? validator;
  final bool enabled;
  final FocusNode? focusNode;
  final Color? accentColor;

  const PremiumAmountInput({
    super.key,
    this.controller,
    this.initialValue,
    required this.label,
    this.hint,
    this.prefix,
    this.suffix, // Will use CurrencyProvider if null
    this.showCurrency = true,
    this.onChanged,
    this.validator,
    this.enabled = true,
    this.focusNode,
    this.accentColor,
  });

  @override
  State<PremiumAmountInput> createState() => _PremiumAmountInputState();
}

class _PremiumAmountInputState extends State<PremiumAmountInput> {
  late TextEditingController _controller;
  bool _ownsController = false;

  @override
  void initState() {
    super.initState();
    if (widget.controller != null) {
      _controller = widget.controller!;
    } else {
      _controller = TextEditingController();
      _ownsController = true;

      if (widget.initialValue != null && widget.initialValue! > 0) {
        _controller.text = formatTurkishCurrency(
          widget.initialValue!,
          decimalDigits: 0,
          showDecimals: false,
        );
      }
    }
  }

  @override
  void dispose() {
    if (_ownsController) {
      _controller.dispose();
    }
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final accentColor = widget.accentColor ?? theme.colorScheme.primary;
    final currencyProvider = context.watch<CurrencyProvider>();
    final suffixText = widget.suffix ?? currencyProvider.code;

    return TextFormField(
      controller: _controller,
      focusNode: widget.focusNode,
      enabled: widget.enabled,
      keyboardType: const TextInputType.numberWithOptions(decimal: true),
      inputFormatters: [
        PremiumCurrencyFormatter(maxIntegerDigits: 12, allowDecimals: true),
      ],
      style: TextStyle(
        fontSize: 24,
        fontWeight: FontWeight.w600,
        color: widget.enabled ? null : theme.disabledColor,
      ),
      textAlign: TextAlign.center,
      decoration: InputDecoration(
        labelText: widget.label,
        hintText: widget.hint ?? '0',
        prefixText: widget.prefix,
        suffixText: widget.showCurrency ? suffixText : null,
        suffixStyle: TextStyle(
          fontSize: 18,
          fontWeight: FontWeight.w500,
          color: accentColor.withValues(alpha: 0.7),
        ),
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(16),
          borderSide: BorderSide(color: accentColor.withValues(alpha: 0.3)),
        ),
        enabledBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(16),
          borderSide: BorderSide(color: accentColor.withValues(alpha: 0.3)),
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(16),
          borderSide: BorderSide(color: accentColor, width: 2),
        ),
        filled: true,
        fillColor: accentColor.withValues(alpha: 0.05),
        contentPadding: const EdgeInsets.symmetric(
          horizontal: 20,
          vertical: 16,
        ),
      ),
      onChanged: (value) {
        widget.onChanged?.call(parseAmount(value));
      },
      validator: widget.validator,
    );
  }
}


--- FILE: lib/widgets/welcome_back_sheet.dart ---

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:vantag/services/reengagement_service.dart';
import 'package:vantag/theme/theme.dart';

/// Welcome back bottom sheet for returning stalled users
/// Shows personalized message based on days inactive
class WelcomeBackSheet extends StatefulWidget {
  final int daysSinceActive;
  final int? recoveredStreakPercent;
  final VoidCallback? onAddExpense;
  final VoidCallback? onDismiss;

  const WelcomeBackSheet({
    super.key,
    required this.daysSinceActive,
    this.recoveredStreakPercent,
    this.onAddExpense,
    this.onDismiss,
  });

  /// Show the welcome back sheet
  static Future<void> show(
    BuildContext context, {
    required int daysSinceActive,
    int? recoveredStreakPercent,
    VoidCallback? onAddExpense,
  }) async {
    await showModalBottomSheet(
      context: context,
      backgroundColor: Colors.transparent,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      isScrollControlled: true,
      builder: (context) => WelcomeBackSheet(
        daysSinceActive: daysSinceActive,
        recoveredStreakPercent: recoveredStreakPercent,
        onAddExpense: onAddExpense,
        onDismiss: () => Navigator.of(context).pop(),
      ),
    );

    // Mark as shown
    await ReengagementService().markWelcomeBackShown();
  }

  @override
  State<WelcomeBackSheet> createState() => _WelcomeBackSheetState();
}

class _WelcomeBackSheetState extends State<WelcomeBackSheet>
    with SingleTickerProviderStateMixin {
  late AnimationController _animationController;
  late Animation<double> _scaleAnimation;
  late Animation<double> _fadeAnimation;

  @override
  void initState() {
    super.initState();

    _animationController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 600),
    );

    _scaleAnimation = Tween<double>(begin: 0.8, end: 1.0).animate(
      CurvedAnimation(
        parent: _animationController,
        curve: Curves.elasticOut,
      ),
    );

    _fadeAnimation = Tween<double>(begin: 0.0, end: 1.0).animate(
      CurvedAnimation(
        parent: _animationController,
        curve: const Interval(0.0, 0.5, curve: Curves.easeOut),
      ),
    );

    _animationController.forward();
  }

  @override
  void dispose() {
    _animationController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final message = ReengagementService().getWelcomeBackMessage(
      context,
      widget.daysSinceActive,
    );

    return AnimatedBuilder(
      animation: _animationController,
      builder: (context, child) {
        return FadeTransition(
          opacity: _fadeAnimation,
          child: ScaleTransition(
            scale: _scaleAnimation,
            child: child,
          ),
        );
      },
      child: Container(
        margin: const EdgeInsets.all(16),
        padding: const EdgeInsets.all(24),
        decoration: BoxDecoration(
          color: context.appColors.surface,
          borderRadius: BorderRadius.circular(24),
          border: Border.all(
            color: message.color.withValues(alpha: 0.3),
            width: 2,
          ),
          boxShadow: [
            BoxShadow(
              color: message.color.withValues(alpha: 0.2),
              blurRadius: 20,
              offset: const Offset(0, 8),
            ),
          ],
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            // Close button
            Align(
              alignment: Alignment.topRight,
              child: GestureDetector(
                onTap: () {
                  HapticFeedback.lightImpact();
                  widget.onDismiss?.call();
                },
                child: Container(
                  padding: const EdgeInsets.all(4),
                  decoration: BoxDecoration(
                    color: context.appColors.surfaceLight,
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Icon(
                    Icons.close_rounded,
                    size: 20,
                    color: context.appColors.textTertiary,
                  ),
                ),
              ),
            ),

            // Icon with glow
            Container(
              width: 80,
              height: 80,
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: [
                    message.color.withValues(alpha: 0.2),
                    message.color.withValues(alpha: 0.1),
                  ],
                ),
                borderRadius: BorderRadius.circular(24),
                boxShadow: [
                  BoxShadow(
                    color: message.color.withValues(alpha: 0.3),
                    blurRadius: 16,
                    spreadRadius: 2,
                  ),
                ],
              ),
              child: Icon(
                message.icon,
                size: 40,
                color: message.color,
              ),
            ),
            const SizedBox(height: 20),

            // Title
            Text(
              message.title,
              style: TextStyle(
                fontSize: 24,
                fontWeight: FontWeight.w700,
                color: context.appColors.textPrimary,
              ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 8),

            // Days badge
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
              decoration: BoxDecoration(
                color: message.color.withValues(alpha: 0.15),
                borderRadius: BorderRadius.circular(16),
              ),
              child: Text(
                '${widget.daysSinceActive} gün sonra',
                style: TextStyle(
                  fontSize: 13,
                  fontWeight: FontWeight.w600,
                  color: message.color,
                ),
              ),
            ),
            const SizedBox(height: 16),

            // Subtitle
            Text(
              message.subtitle,
              style: TextStyle(
                fontSize: 15,
                color: context.appColors.textSecondary,
                height: 1.4,
              ),
              textAlign: TextAlign.center,
            ),

            // Streak recovery info (if applicable)
            if (widget.recoveredStreakPercent != null &&
                widget.recoveredStreakPercent! > 0) ...[
              const SizedBox(height: 16),
              Container(
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: const Color(0xFF10B981).withValues(alpha: 0.1),
                  borderRadius: BorderRadius.circular(16),
                  border: Border.all(
                    color: const Color(0xFF10B981).withValues(alpha: 0.3),
                  ),
                ),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    const Icon(
                      Icons.auto_awesome_rounded,
                      size: 18,
                      color: Color(0xFF10B981),
                    ),
                    const SizedBox(width: 8),
                    Text(
                      'Serinin %${widget.recoveredStreakPercent}\'i kurtarıldı!',
                      style: const TextStyle(
                        fontSize: 14,
                        fontWeight: FontWeight.w600,
                        color: Color(0xFF10B981),
                      ),
                    ),
                  ],
                ),
              ),
            ],

            const SizedBox(height: 24),

            // CTA Button
            GestureDetector(
              onTap: () {
                HapticFeedback.mediumImpact();
                widget.onDismiss?.call();
                widget.onAddExpense?.call();
              },
              child: Container(
                width: double.infinity,
                padding: const EdgeInsets.symmetric(vertical: 16),
                decoration: BoxDecoration(
                  color: message.color,
                  borderRadius: BorderRadius.circular(16),
                  boxShadow: [
                    BoxShadow(
                      color: message.color.withValues(alpha: 0.4),
                      blurRadius: 12,
                      offset: const Offset(0, 4),
                    ),
                  ],
                ),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    const Icon(
                      Icons.add_rounded,
                      size: 20,
                      color: Colors.white,
                    ),
                    const SizedBox(width: 8),
                    Text(
                      message.ctaText,
                      style: const TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.w600,
                        color: Colors.white,
                      ),
                    ),
                  ],
                ),
              ),
            ),

            const SizedBox(height: 12),

            // Secondary action
            TextButton(
              onPressed: () {
                HapticFeedback.lightImpact();
                widget.onDismiss?.call();
              },
              child: Text(
                'Sonra hatırlat',
                style: TextStyle(
                  fontSize: 14,
                  color: context.appColors.textTertiary,
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}


--- FILE: lib/widgets/pursuit_progress_visual.dart ---

import 'package:flutter/material.dart';
import '../theme/quiet_luxury.dart';

/// ShaderMask fill-from-bottom animation for pursuit progress
class PursuitProgressVisual extends StatelessWidget {
  final double progress; // 0.0 to 1.0
  final String emoji;
  final String? imageUrl;
  final double size;
  final bool animate;
  final Color? fillColor;

  const PursuitProgressVisual({
    super.key,
    required this.progress,
    required this.emoji,
    this.imageUrl,
    this.size = 64,
    this.animate = true,
    this.fillColor,
  });

  @override
  Widget build(BuildContext context) {
    final effectiveFillColor = fillColor ?? QuietLuxury.positive;

    if (!animate) {
      return _buildContent(progress, effectiveFillColor);
    }

    return TweenAnimationBuilder<double>(
      tween: Tween(begin: 0, end: progress),
      duration: const Duration(milliseconds: 800),
      curve: Curves.easeOutCubic,
      builder: (context, value, child) {
        return _buildContent(value, effectiveFillColor);
      },
    );
  }

  Widget _buildContent(double value, Color color) {
    return Stack(
      alignment: Alignment.center,
      children: [
        // Background circle (unfilled part)
        Container(
          width: size,
          height: size,
          decoration: BoxDecoration(
            shape: BoxShape.circle,
            color: QuietLuxury.cardBackground,
            border: Border.all(color: QuietLuxury.cardBorder, width: 1),
          ),
        ),
        // Filled part with ShaderMask
        ShaderMask(
          shaderCallback: (bounds) {
            return LinearGradient(
              begin: Alignment.bottomCenter,
              end: Alignment.topCenter,
              colors: [
                Colors.white,
                Colors.white,
                Colors.transparent,
                Colors.transparent,
              ],
              stops: [0.0, value, value, 1.0],
            ).createShader(bounds);
          },
          blendMode: BlendMode.dstIn,
          child: Container(
            width: size,
            height: size,
            decoration: BoxDecoration(
              shape: BoxShape.circle,
              gradient: LinearGradient(
                begin: Alignment.bottomCenter,
                end: Alignment.topCenter,
                colors: [
                  color.withValues(alpha: 0.8),
                  color.withValues(alpha: 0.4),
                ],
              ),
            ),
          ),
        ),
        // Emoji or Image
        if (imageUrl != null)
          ClipOval(
            child: Image.network(
              imageUrl!,
              width: size * 0.6,
              height: size * 0.6,
              fit: BoxFit.cover,
              cacheWidth: 150,
              cacheHeight: 150,
              errorBuilder: (_, __, ___) => _buildEmoji(),
            ),
          )
        else
          _buildEmoji(),
      ],
    );
  }

  Widget _buildEmoji() {
    return Text(emoji, style: TextStyle(fontSize: size * 0.4));
  }
}

/// Circular progress indicator for pursuit (alternative style)
class PursuitCircularProgress extends StatelessWidget {
  final double progress; // 0.0 to 1.0
  final String emoji;
  final double size;
  final double strokeWidth;
  final Color? progressColor;
  final Color? backgroundColor;

  const PursuitCircularProgress({
    super.key,
    required this.progress,
    required this.emoji,
    this.size = 80,
    this.strokeWidth = 4,
    this.progressColor,
    this.backgroundColor,
  });

  @override
  Widget build(BuildContext context) {
    return SizedBox(
      width: size,
      height: size,
      child: Stack(
        alignment: Alignment.center,
        children: [
          // Background circle
          SizedBox(
            width: size,
            height: size,
            child: CircularProgressIndicator(
              value: 1.0,
              strokeWidth: strokeWidth,
              valueColor: AlwaysStoppedAnimation<Color>(
                backgroundColor ?? QuietLuxury.cardBorder,
              ),
              backgroundColor: Colors.transparent,
            ),
          ),
          // Progress arc
          TweenAnimationBuilder<double>(
            tween: Tween(begin: 0, end: progress),
            duration: const Duration(milliseconds: 800),
            curve: Curves.easeOutCubic,
            builder: (context, value, _) {
              return SizedBox(
                width: size,
                height: size,
                child: CircularProgressIndicator(
                  value: value,
                  strokeWidth: strokeWidth,
                  strokeCap: StrokeCap.round,
                  valueColor: AlwaysStoppedAnimation<Color>(
                    progressColor ?? QuietLuxury.positive,
                  ),
                  backgroundColor: Colors.transparent,
                ),
              );
            },
          ),
          // Emoji
          Text(emoji, style: TextStyle(fontSize: size * 0.35)),
        ],
      ),
    );
  }
}

/// Linear progress bar for pursuit list cards
class PursuitLinearProgress extends StatelessWidget {
  final double progress; // 0.0 to 1.0
  final double height;
  final Color? progressColor;
  final Color? backgroundColor;
  final BorderRadius? borderRadius;

  const PursuitLinearProgress({
    super.key,
    required this.progress,
    this.height = 6,
    this.progressColor,
    this.backgroundColor,
    this.borderRadius,
  });

  @override
  Widget build(BuildContext context) {
    final effectiveRadius = borderRadius ?? BorderRadius.circular(height / 2);
    final effectiveProgressColor = progressColor ?? QuietLuxury.positive;
    final effectiveBackgroundColor = backgroundColor ?? QuietLuxury.cardBorder;

    return Container(
      height: height,
      decoration: BoxDecoration(
        color: effectiveBackgroundColor,
        borderRadius: effectiveRadius,
      ),
      child: TweenAnimationBuilder<double>(
        tween: Tween(begin: 0, end: progress.clamp(0.0, 1.0)),
        duration: const Duration(milliseconds: 600),
        curve: Curves.easeOutCubic,
        builder: (context, value, _) {
          return FractionallySizedBox(
            alignment: Alignment.centerLeft,
            widthFactor: value,
            child: Container(
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  colors: [
                    effectiveProgressColor.withValues(alpha: 0.7),
                    effectiveProgressColor,
                  ],
                ),
                borderRadius: effectiveRadius,
                boxShadow: [
                  BoxShadow(
                    color: effectiveProgressColor.withValues(alpha: 0.3),
                    blurRadius: 8,
                    offset: const Offset(0, 2),
                  ),
                ],
              ),
            ),
          );
        },
      ),
    );
  }
}


--- FILE: lib/widgets/installment_summary_card.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/expense.dart';
import '../providers/currency_provider.dart';
import '../services/budget_service.dart';
import '../theme/theme.dart' hide GlassCard;
import '../core/theme/premium_effects.dart';
import '../utils/currency_utils.dart';
import '../utils/category_utils.dart';

/// Aktif taksitleri gösteren kart
/// Premium animasyonlar: slide-up, count-up, progress bar
class InstallmentSummaryCard extends StatefulWidget {
  final BudgetService budgetService;
  final int animationIndex;
  final VoidCallback? onSeeAll;

  const InstallmentSummaryCard({
    super.key,
    required this.budgetService,
    this.animationIndex = 0,
    this.onSeeAll,
  });

  @override
  State<InstallmentSummaryCard> createState() => _InstallmentSummaryCardState();
}

class _InstallmentSummaryCardState extends State<InstallmentSummaryCard>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _slideAnimation;
  late Animation<double> _fadeAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      duration: const Duration(milliseconds: 400),
      vsync: this,
    );

    _slideAnimation = Tween<double>(
      begin: 30,
      end: 0,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeOutCubic));

    _fadeAnimation = Tween<double>(
      begin: 0,
      end: 1,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeOutCubic));

    // Staggered delay based on index
    Future.delayed(Duration(milliseconds: 100 * widget.animationIndex), () {
      if (mounted) _controller.forward();
    });
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  void _showAllInstallmentsSheet(
    BuildContext context,
    List<Expense> installments,
    CurrencyProvider currencyProvider,
  ) {
    final l10n = AppLocalizations.of(context);
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      builder: (context) => _AllInstallmentsSheet(
        installments: installments,
        currencyProvider: currencyProvider,
        l10n: l10n,
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final currencyProvider = context.watch<CurrencyProvider>();
    final installments = widget.budgetService.activeInstallments;

    // Taksit yoksa gösterme
    if (installments.isEmpty) return const SizedBox.shrink();

    final monthlyBurden = widget.budgetService.monthlyInstallmentBurden;
    final totalDebt = widget.budgetService.totalRemainingDebt;
    final totalInterest = widget.budgetService.totalInterestAmount;
    final interestHours = widget.budgetService.totalInterestHours;

    // Currency conversion
    final monthlyBurdenConverted = currencyProvider.convertFromTRY(
      monthlyBurden,
    );
    final totalDebtConverted = currencyProvider.convertFromTRY(totalDebt);
    final totalInterestConverted = currencyProvider.convertFromTRY(
      totalInterest,
    );

    return AnimatedBuilder(
      animation: _controller,
      builder: (context, child) {
        return Transform.translate(
          offset: Offset(0, _slideAnimation.value),
          child: Opacity(
            opacity: _fadeAnimation.value,
            child: GlassCard(
              borderRadius: 20,
              padding: const EdgeInsets.all(20),
              boxShadow: PremiumShadows.coloredGlow(
                context.appColors.warning,
                intensity: 0.2,
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // Başlık
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Row(
                        children: [
                          Container(
                            width: 36,
                            height: 36,
                            decoration: BoxDecoration(
                              color: context.appColors.warning.withValues(
                                alpha: 0.15,
                              ),
                              borderRadius: BorderRadius.circular(8),
                              boxShadow: PremiumShadows.coloredGlow(
                                context.appColors.warning,
                                intensity: 0.3,
                              ),
                            ),
                            child: Icon(
                              CupertinoIcons.creditcard,
                              color: context.appColors.warning,
                              size: 18,
                              shadows: PremiumShadows.iconHalo(
                                context.appColors.warning,
                              ),
                            ),
                          ),
                          const SizedBox(width: 12),
                          Text(
                            l10n.activeInstallments,
                            style: TextStyle(
                              color: context.appColors.textPrimary,
                              fontSize: 16,
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                        ],
                      ),
                      Container(
                        padding: const EdgeInsets.symmetric(
                          horizontal: 10,
                          vertical: 5,
                        ),
                        decoration: BoxDecoration(
                          color: context.appColors.warning.withValues(
                            alpha: 0.2,
                          ),
                          borderRadius: BorderRadius.circular(16),
                          border: Border.all(
                            color: context.appColors.warning.withValues(
                              alpha: 0.3,
                            ),
                            width: 1,
                          ),
                        ),
                        child: Text(
                          l10n.installmentCount(installments.length),
                          style: TextStyle(
                            color: context.appColors.warning,
                            fontSize: 12,
                            fontWeight: FontWeight.w600,
                          ),
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 16),

                  // Taksit listesi (max 3 göster) with staggered animation
                  ...installments
                      .take(3)
                      .toList()
                      .asMap()
                      .entries
                      .map(
                        (entry) => _AnimatedInstallmentRow(
                          index: entry.key,
                          expense: entry.value,
                          currencyProvider: currencyProvider,
                          l10n: l10n,
                        ),
                      ),

                  // Daha fazla varsa - "Tümünü Gör" butonu
                  if (installments.length > 3)
                    Padding(
                      padding: const EdgeInsets.only(top: 8),
                      child: GestureDetector(
                        onTap:
                            widget.onSeeAll ??
                            () => _showAllInstallmentsSheet(
                              context,
                              installments,
                              currencyProvider,
                            ),
                        child: Row(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            Text(
                              l10n.moreInstallments(installments.length - 3),
                              style: TextStyle(
                                color: context.appColors.textTertiary,
                                fontSize: 12,
                              ),
                            ),
                            const SizedBox(width: 8),
                            Container(
                              padding: const EdgeInsets.symmetric(
                                horizontal: 12,
                                vertical: 6,
                              ),
                              decoration: BoxDecoration(
                                color: context.appColors.warning.withValues(
                                  alpha: 0.15,
                                ),
                                borderRadius: BorderRadius.circular(16),
                                border: Border.all(
                                  color: context.appColors.warning.withValues(
                                    alpha: 0.3,
                                  ),
                                ),
                              ),
                              child: Row(
                                mainAxisSize: MainAxisSize.min,
                                children: [
                                  Text(
                                    l10n.viewAll,
                                    style: TextStyle(
                                      color: context.appColors.warning,
                                      fontSize: 12,
                                      fontWeight: FontWeight.w600,
                                    ),
                                  ),
                                  const SizedBox(width: 4),
                                  Icon(
                                    CupertinoIcons.chevron_right,
                                    color: context.appColors.warning,
                                    size: 12,
                                  ),
                                ],
                              ),
                            ),
                          ],
                        ),
                      ),
                    ),

                  Divider(color: context.appColors.cardBorder, height: 24),

                  // Özet with count-up animations
                  Row(
                    children: [
                      Expanded(
                        child: _AnimatedSummaryItem(
                          index: 0,
                          label: l10n.monthlyBurden,
                          value: monthlyBurdenConverted,
                          color: context.appColors.warning,
                        ),
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: _AnimatedSummaryItem(
                          index: 1,
                          label: l10n.remainingDebt,
                          value: totalDebtConverted,
                          color: context.appColors.primary,
                        ),
                      ),
                    ],
                  ),

                  // Vade farkı uyarısı
                  if (totalInterest > 0) ...[
                    const SizedBox(height: 12),
                    Container(
                      padding: const EdgeInsets.all(10),
                      decoration: BoxDecoration(
                        color: context.appColors.error.withValues(alpha: 0.1),
                        borderRadius: BorderRadius.circular(8),
                        border: Border.all(
                          color: context.appColors.error.withValues(alpha: 0.2),
                        ),
                      ),
                      child: Row(
                        children: [
                          Icon(
                            CupertinoIcons.arrow_up_right,
                            color: context.appColors.error,
                            size: 16,
                            shadows: PremiumShadows.iconHalo(
                              context.appColors.error,
                            ),
                          ),
                          const SizedBox(width: 8),
                          Expanded(
                            child: Text(
                              l10n.totalInterestCost(
                                formatTurkishCurrency(
                                  totalInterestConverted,
                                  decimalDigits: 0,
                                  showDecimals: false,
                                ),
                                interestHours.toStringAsFixed(0),
                              ),
                              style: TextStyle(
                                color: context.appColors.error,
                                fontSize: 12,
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ],
              ),
            ),
          ),
        );
      },
    );
  }
}

/// Animated installment row with progress bar
class _AnimatedInstallmentRow extends StatefulWidget {
  final int index;
  final Expense expense;
  final CurrencyProvider currencyProvider;
  final AppLocalizations l10n;

  const _AnimatedInstallmentRow({
    required this.index,
    required this.expense,
    required this.currencyProvider,
    required this.l10n,
  });

  @override
  State<_AnimatedInstallmentRow> createState() =>
      _AnimatedInstallmentRowState();
}

class _AnimatedInstallmentRowState extends State<_AnimatedInstallmentRow>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _slideAnimation;
  late Animation<double> _fadeAnimation;
  late Animation<double> _progressAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      duration: const Duration(milliseconds: 600),
      vsync: this,
    );

    _slideAnimation = Tween<double>(begin: 20, end: 0).animate(
      CurvedAnimation(
        parent: _controller,
        curve: const Interval(0.0, 0.6, curve: Curves.easeOutCubic),
      ),
    );

    _fadeAnimation = Tween<double>(begin: 0, end: 1).animate(
      CurvedAnimation(
        parent: _controller,
        curve: const Interval(0.0, 0.5, curve: Curves.easeOut),
      ),
    );

    _progressAnimation = CurvedAnimation(
      parent: _controller,
      curve: const Interval(0.3, 1.0, curve: Curves.easeOutCubic),
    );

    // Staggered delay: 200ms base + 100ms per index
    Future.delayed(Duration(milliseconds: 200 + (100 * widget.index)), () {
      if (mounted) _controller.forward();
    });
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final currentInstallment = widget.expense.currentInstallment ?? 1;
    final totalInstallments = widget.expense.installmentCount ?? 1;
    final progress = currentInstallment / totalInstallments;
    final installmentAmount = widget.currencyProvider.convertFromTRY(
      widget.expense.installmentAmount,
    );

    return AnimatedBuilder(
      animation: _controller,
      builder: (context, child) {
        final animatedProgress = progress * _progressAnimation.value;

        return Transform.translate(
          offset: Offset(0, _slideAnimation.value),
          child: Opacity(
            opacity: _fadeAnimation.value,
            child: Padding(
              padding: const EdgeInsets.only(bottom: 12),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Expanded(
                        child: Text(
                          widget.expense.subCategory?.isNotEmpty == true
                              ? '${CategoryUtils.getLocalizedName(context, widget.expense.category)} - ${widget.expense.subCategory}'
                              : CategoryUtils.getLocalizedName(
                                  context,
                                  widget.expense.category,
                                ),
                          style: TextStyle(
                            color: context.appColors.textPrimary,
                          ),
                          overflow: TextOverflow.ellipsis,
                        ),
                      ),
                      Text(
                        '${formatTurkishCurrency(installmentAmount, decimalDigits: 0, showDecimals: false)}/${widget.l10n.monthAbbreviation}',
                        style: TextStyle(
                          color: context.appColors.warning,
                          fontWeight: FontWeight.w600,
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 6),
                  Row(
                    children: [
                      Expanded(
                        child: Container(
                          height: 6,
                          decoration: BoxDecoration(
                            color: context.appColors.cardBorder,
                            borderRadius: BorderRadius.circular(3),
                          ),
                          child: FractionallySizedBox(
                            alignment: Alignment.centerLeft,
                            widthFactor: animatedProgress.clamp(0.0, 1.0),
                            child: Container(
                              decoration: BoxDecoration(
                                gradient: LinearGradient(
                                  colors: progress > 0.8
                                      ? [
                                          context.appColors.success,
                                          context.appColors.success.withValues(
                                            alpha: 0.8,
                                          ),
                                        ]
                                      : [
                                          context.appColors.warning,
                                          context.appColors.warning.withValues(
                                            alpha: 0.8,
                                          ),
                                        ],
                                ),
                                borderRadius: BorderRadius.circular(3),
                                boxShadow: [
                                  BoxShadow(
                                    color:
                                        (progress > 0.8
                                                ? context.appColors.success
                                                : context.appColors.warning)
                                            .withValues(alpha: 0.4),
                                    blurRadius: 6,
                                    spreadRadius: 0,
                                  ),
                                ],
                              ),
                            ),
                          ),
                        ),
                      ),
                      const SizedBox(width: 8),
                      Text(
                        '$currentInstallment/$totalInstallments',
                        style: TextStyle(
                          color: context.appColors.textTertiary,
                          fontSize: 11,
                        ),
                      ),
                    ],
                  ),
                ],
              ),
            ),
          ),
        );
      },
    );
  }
}

/// Animated summary item with count-up
class _AnimatedSummaryItem extends StatefulWidget {
  final int index;
  final String label;
  final double value;
  final Color color;

  const _AnimatedSummaryItem({
    required this.index,
    required this.label,
    required this.value,
    required this.color,
  });

  @override
  State<_AnimatedSummaryItem> createState() => _AnimatedSummaryItemState();
}

class _AnimatedSummaryItemState extends State<_AnimatedSummaryItem>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _slideAnimation;
  late Animation<double> _fadeAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      duration: const Duration(milliseconds: 400),
      vsync: this,
    );

    _slideAnimation = Tween<double>(
      begin: 20,
      end: 0,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeOutCubic));

    _fadeAnimation = Tween<double>(
      begin: 0,
      end: 1,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeOutCubic));

    // Staggered delay: 400ms base + 100ms per index
    Future.delayed(Duration(milliseconds: 400 + (100 * widget.index)), () {
      if (mounted) _controller.forward();
    });
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: _controller,
      builder: (context, child) {
        return Transform.translate(
          offset: Offset(0, _slideAnimation.value),
          child: Opacity(
            opacity: _fadeAnimation.value,
            child: Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: widget.color.withValues(alpha: 0.1),
                borderRadius: BorderRadius.circular(16),
                border: Border.all(
                  color: widget.color.withValues(alpha: 0.2),
                  width: 1,
                ),
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    widget.label,
                    style: TextStyle(
                      color: context.appColors.textSecondary,
                      fontSize: 11,
                    ),
                  ),
                  const SizedBox(height: 4),
                  AnimatedCountUp(
                    value: widget.value,
                    duration: const Duration(milliseconds: 800),
                    formatter: (value) => formatTurkishCurrency(
                      value,
                      decimalDigits: 0,
                      showDecimals: false,
                    ),
                    style: TextStyle(
                      color: widget.color,
                      fontSize: 16,
                      fontWeight: FontWeight.bold,
                      shadows: [
                        Shadow(
                          color: widget.color.withValues(alpha: 0.3),
                          blurRadius: 8,
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ),
        );
      },
    );
  }
}

/// Bottom sheet showing all installments
class _AllInstallmentsSheet extends StatelessWidget {
  final List<Expense> installments;
  final CurrencyProvider currencyProvider;
  final AppLocalizations l10n;

  const _AllInstallmentsSheet({
    required this.installments,
    required this.currencyProvider,
    required this.l10n,
  });

  @override
  Widget build(BuildContext context) {
    return DraggableScrollableSheet(
      initialChildSize: 0.7,
      minChildSize: 0.4,
      maxChildSize: 0.9,
      builder: (context, scrollController) {
        return Container(
          decoration: BoxDecoration(
            color: context.appColors.background,
            borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
            border: Border.all(color: context.appColors.cardBorder),
          ),
          child: Column(
            children: [
              // Handle
              Padding(
                padding: const EdgeInsets.only(top: 12, bottom: 8),
                child: Container(
                  width: 40,
                  height: 4,
                  decoration: BoxDecoration(
                    color: context.appColors.cardBorder,
                    borderRadius: BorderRadius.circular(2),
                  ),
                ),
              ),

              // Header
              Padding(
                padding: const EdgeInsets.symmetric(
                  horizontal: 20,
                  vertical: 12,
                ),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Row(
                      children: [
                        Container(
                          width: 36,
                          height: 36,
                          decoration: BoxDecoration(
                            color: context.appColors.warning.withValues(
                              alpha: 0.15,
                            ),
                            borderRadius: BorderRadius.circular(8),
                          ),
                          child: Icon(
                            CupertinoIcons.creditcard,
                            color: context.appColors.warning,
                            size: 18,
                          ),
                        ),
                        const SizedBox(width: 12),
                        Text(
                          l10n.activeInstallments,
                          style: TextStyle(
                            color: context.appColors.textPrimary,
                            fontSize: 18,
                            fontWeight: FontWeight.w600,
                          ),
                        ),
                      ],
                    ),
                    Container(
                      padding: const EdgeInsets.symmetric(
                        horizontal: 10,
                        vertical: 5,
                      ),
                      decoration: BoxDecoration(
                        color: context.appColors.warning.withValues(alpha: 0.2),
                        borderRadius: BorderRadius.circular(16),
                      ),
                      child: Text(
                        l10n.installmentCount(installments.length),
                        style: TextStyle(
                          color: context.appColors.warning,
                          fontSize: 12,
                          fontWeight: FontWeight.w600,
                        ),
                      ),
                    ),
                  ],
                ),
              ),

              Divider(color: context.appColors.cardBorder),

              // Installments list
              Expanded(
                child: ListView.builder(
                  controller: scrollController,
                  padding: const EdgeInsets.all(20),
                  itemCount: installments.length,
                  itemBuilder: (context, index) {
                    final expense = installments[index];
                    return _InstallmentListItem(
                      expense: expense,
                      currencyProvider: currencyProvider,
                      l10n: l10n,
                    );
                  },
                ),
              ),
            ],
          ),
        );
      },
    );
  }
}

/// Single installment item in the full list
class _InstallmentListItem extends StatelessWidget {
  final Expense expense;
  final CurrencyProvider currencyProvider;
  final AppLocalizations l10n;

  const _InstallmentListItem({
    required this.expense,
    required this.currencyProvider,
    required this.l10n,
  });

  @override
  Widget build(BuildContext context) {
    final currentInstallment = expense.currentInstallment ?? 1;
    final totalInstallments = expense.installmentCount ?? 1;
    final progress = currentInstallment / totalInstallments;
    final installmentAmount = currencyProvider.convertFromTRY(
      expense.installmentAmount,
    );
    final totalAmount = currencyProvider.convertFromTRY(expense.amount);
    final remainingAmount =
        installmentAmount * (totalInstallments - currentInstallment + 1);

    return Container(
      margin: const EdgeInsets.only(bottom: 16),
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: context.appColors.cardBorder),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Title & Amount
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Expanded(
                child: Text(
                  expense.subCategory?.isNotEmpty == true
                      ? '${CategoryUtils.getLocalizedName(context, expense.category)} - ${expense.subCategory}'
                      : CategoryUtils.getLocalizedName(
                          context,
                          expense.category,
                        ),
                  style: TextStyle(
                    color: context.appColors.textPrimary,
                    fontSize: 16,
                    fontWeight: FontWeight.w600,
                  ),
                  overflow: TextOverflow.ellipsis,
                ),
              ),
              Text(
                '${formatTurkishCurrency(installmentAmount, decimalDigits: 0, showDecimals: false)}/${l10n.monthAbbreviation}',
                style: TextStyle(
                  color: context.appColors.warning,
                  fontSize: 16,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ],
          ),

          const SizedBox(height: 12),

          // Progress bar
          Container(
            height: 8,
            decoration: BoxDecoration(
              color: context.appColors.cardBorder,
              borderRadius: BorderRadius.circular(4),
            ),
            child: FractionallySizedBox(
              alignment: Alignment.centerLeft,
              widthFactor: progress.clamp(0.0, 1.0),
              child: Container(
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    colors: progress > 0.8
                        ? [
                            context.appColors.success,
                            context.appColors.success.withValues(alpha: 0.8),
                          ]
                        : [
                            context.appColors.warning,
                            context.appColors.warning.withValues(alpha: 0.8),
                          ],
                  ),
                  borderRadius: BorderRadius.circular(4),
                ),
              ),
            ),
          ),

          const SizedBox(height: 12),

          // Details row
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              // Progress text
              Text(
                '$currentInstallment / $totalInstallments ${l10n.installmentsLabel}',
                style: TextStyle(
                  color: context.appColors.textSecondary,
                  fontSize: 13,
                ),
              ),
              // Remaining
              Text(
                '${l10n.remaining}: ${formatTurkishCurrency(remainingAmount, decimalDigits: 0, showDecimals: false)}',
                style: TextStyle(
                  color: context.appColors.textTertiary,
                  fontSize: 12,
                ),
              ),
            ],
          ),

          // Total amount
          if (expense.amount != installmentAmount) ...[
            const SizedBox(height: 8),
            Text(
              '${l10n.total}: ${formatTurkishCurrency(totalAmount, decimalDigits: 0, showDecimals: false)}',
              style: TextStyle(
                color: context.appColors.textTertiary,
                fontSize: 12,
              ),
            ),
          ],
        ],
      ),
    );
  }
}


--- FILE: lib/widgets/subscription_sheet.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';
import '../providers/currency_provider.dart';
import '../services/services.dart';
import '../screens/subscription_screen.dart';
import '../theme/theme.dart';
import '../utils/currency_utils.dart';

class SubscriptionSheet extends StatefulWidget {
  final VoidCallback? onChanged;

  const SubscriptionSheet({super.key, this.onChanged});

  @override
  State<SubscriptionSheet> createState() => _SubscriptionSheetState();
}

class _SubscriptionSheetState extends State<SubscriptionSheet> {
  final _subscriptionService = SubscriptionService();
  List<Subscription> _subscriptions = [];
  bool _isLoading = true;
  double _totalMonthly = 0;

  @override
  void initState() {
    super.initState();
    _loadSubscriptions();
  }

  Future<void> _loadSubscriptions() async {
    final subs = await _subscriptionService.getActiveSubscriptions();
    final total = await _subscriptionService.getTotalMonthlyAmount();
    if (mounted) {
      setState(() {
        _subscriptions = subs
          ..sort((a, b) => a.daysUntilRenewal.compareTo(b.daysUntilRenewal));
        _totalMonthly = total;
        _isLoading = false;
      });
    }
  }

  Future<void> _deleteSubscription(String id) async {
    await _subscriptionService.deleteSubscription(id);
    await _loadSubscriptions();
    widget.onChanged?.call();
  }

  void _showAddEditDialog({Subscription? existing}) {
    showModalBottomSheet(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      isScrollControlled: true,
      backgroundColor: QuietLuxury.background,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
      ),
      builder: (context) => _AddEditSubscriptionSheet(
        existing: existing,
        onSaved: () {
          _loadSubscriptions();
          widget.onChanged?.call();
        },
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    return DraggableScrollableSheet(
      initialChildSize: 0.7,
      minChildSize: 0.5,
      maxChildSize: 0.95,
      expand: false,
      builder: (context, scrollController) => Container(
        decoration: BoxDecoration(
          color: QuietLuxury.background,
          borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
          border: Border.all(color: QuietLuxury.cardBorder, width: 0.5),
        ),
        child: Column(
          children: [
            // Handle - Quiet Luxury
            Padding(
              padding: const EdgeInsets.only(top: 12),
              child: Container(
                width: 36,
                height: 4,
                decoration: BoxDecoration(
                  color: QuietLuxury.textTertiary.withValues(alpha: 0.3),
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
            ),

            // Header - Quiet Luxury
            Padding(
              padding: QuietLuxury.pagePadding,
              child: Row(
                children: [
                  Container(
                    width: 44,
                    height: 44,
                    decoration: BoxDecoration(
                      color: QuietLuxury.textSecondary.withValues(alpha: 0.1),
                      borderRadius: BorderRadius.circular(16),
                      border: Border.all(
                        color: QuietLuxury.cardBorder,
                        width: 0.5,
                      ),
                    ),
                    child: Icon(
                      CupertinoIcons.calendar,
                      color: QuietLuxury.textSecondary,
                      size: 20,
                    ),
                  ),
                  const SizedBox(width: 16),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(l10n.subscriptions, style: QuietLuxury.heading),
                        const SizedBox(height: 2),
                        Text(
                          l10n.monthlyTotalAmount(
                            formatTurkishCurrency(
                              _totalMonthly,
                              decimalDigits: 2,
                            ),
                          ),
                          style: QuietLuxury.label,
                        ),
                      ],
                    ),
                  ),
                  // Add button - Quiet Luxury subtle
                  Pressable(
                    onTap: () => _showAddEditDialog(),
                    child: Container(
                      width: 44,
                      height: 44,
                      decoration: BoxDecoration(
                        color: QuietLuxury.positive.withValues(alpha: 0.1),
                        borderRadius: BorderRadius.circular(16),
                        border: Border.all(
                          color: QuietLuxury.positive.withValues(alpha: 0.2),
                          width: 0.5,
                        ),
                      ),
                      child: Icon(
                        CupertinoIcons.plus,
                        color: QuietLuxury.positive,
                        size: 22,
                      ),
                    ),
                  ),
                ],
              ),
            ),

            // Abonelik Yönetimi Butonu
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 8),
              child: _SubscriptionManageButton(
                onTap: () {
                  Navigator.pop(context); // Sheet'i kapat
                  Navigator.push(
                    context,
                    MaterialPageRoute(
                      builder: (_) => const SubscriptionScreen(),
                    ),
                  );
                },
              ),
            ),

            // Subtle space instead of divider
            const SizedBox(height: 8),

            // Content
            Expanded(
              child: _isLoading
                  ? Center(
                      child: CircularProgressIndicator(
                        color: QuietLuxury.textSecondary,
                        strokeWidth: 2,
                      ),
                    )
                  : _subscriptions.isEmpty
                  ? _buildEmptyState(l10n)
                  : ListView.builder(
                      controller: scrollController,
                      padding: QuietLuxury.pagePadding,
                      itemCount: _subscriptions.length,
                      itemBuilder: (context, index) {
                        final sub = _subscriptions[index];
                        return _SubscriptionCard(
                          subscription: sub,
                          onEdit: () => _showAddEditDialog(existing: sub),
                          onDelete: () => _deleteSubscription(sub.id),
                        );
                      },
                    ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildEmptyState(AppLocalizations l10n) {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Container(
            width: 64,
            height: 64,
            decoration: BoxDecoration(
              color: QuietLuxury.cardBackground,
              borderRadius: BorderRadius.circular(16),
              border: Border.all(color: QuietLuxury.cardBorder, width: 0.5),
            ),
            child: Icon(
              CupertinoIcons.repeat,
              size: 26,
              color: QuietLuxury.textTertiary,
            ),
          ),
          const SizedBox(height: 20),
          Text(
            l10n.noSubscriptionsYet,
            style: QuietLuxury.heading.copyWith(fontSize: 18),
          ),
          const SizedBox(height: 8),
          Text(l10n.addSubscriptionsLikeNetflix, style: QuietLuxury.subheading),
          const SizedBox(height: 24),
          Pressable(
            onTap: () => _showAddEditDialog(),
            child: Container(
              padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 14),
              decoration: BoxDecoration(
                color: QuietLuxury.positive.withValues(alpha: 0.1),
                borderRadius: QuietLuxury.buttonRadius,
                border: Border.all(
                  color: QuietLuxury.positive.withValues(alpha: 0.2),
                  width: 0.5,
                ),
              ),
              child: Row(
                mainAxisSize: MainAxisSize.min,
                children: [
                  Icon(
                    CupertinoIcons.plus,
                    size: 18,
                    color: QuietLuxury.positive,
                  ),
                  const SizedBox(width: 8),
                  Text(
                    l10n.addSubscription,
                    style: TextStyle(
                      fontSize: 14,
                      fontWeight: FontWeight.w500,
                      color: QuietLuxury.positive,
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }
}

class _SubscriptionCard extends StatelessWidget {
  final Subscription subscription;
  final VoidCallback onEdit;
  final VoidCallback onDelete;

  const _SubscriptionCard({
    required this.subscription,
    required this.onEdit,
    required this.onDelete,
  });

  String _formatNextRenewal(AppLocalizations l10n) {
    final days = subscription.daysUntilRenewal;
    if (days == 0) return l10n.today;
    if (days == 1) return l10n.tomorrow;
    if (days < 7) return l10n.daysLater(days);
    return '${subscription.nextRenewalDate.day}/${subscription.nextRenewalDate.month}';
  }

  Color _getRenewalColor() {
    final days = subscription.daysUntilRenewal;
    if (days <= 1) return QuietLuxury.warning;
    if (days <= 3) {
      return AppColors.categoryEntertainment.withValues(
        alpha: 0.7,
      ); // Subtle blue
    }
    return QuietLuxury.textTertiary;
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    return Dismissible(
      key: Key(subscription.id),
      direction: DismissDirection.endToStart,
      confirmDismiss: (direction) async {
        _showOptionsMenu(context, l10n);
        return false;
      },
      background: Container(
        margin: const EdgeInsets.only(bottom: QuietLuxury.cardSpacing),
        decoration: BoxDecoration(
          color: QuietLuxury.negative.withValues(alpha: 0.15),
          borderRadius: QuietLuxury.cardRadius,
        ),
        alignment: Alignment.centerRight,
        padding: const EdgeInsets.only(right: 24),
        child: Icon(CupertinoIcons.trash, color: QuietLuxury.negative),
      ),
      child: Pressable(
        onTap: onEdit,
        child: Container(
          margin: const EdgeInsets.only(bottom: QuietLuxury.cardSpacing),
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: QuietLuxury.cardBackground,
            borderRadius: QuietLuxury.cardRadius,
            border: Border.all(color: QuietLuxury.cardBorder, width: 0.5),
          ),
          child: Row(
            children: [
              // Icon - Gradient background
              Container(
                width: 44,
                height: 44,
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                    colors: [
                      QuietLuxury.textSecondary.withValues(alpha: 0.15),
                      QuietLuxury.textSecondary.withValues(alpha: 0.05),
                    ],
                  ),
                  borderRadius: BorderRadius.circular(16),
                  border: Border.all(color: QuietLuxury.cardBorder, width: 0.5),
                ),
                child: Center(
                  child: Text(
                    _getEmoji(subscription.name),
                    style: const TextStyle(fontSize: 18),
                  ),
                ),
              ),
              const SizedBox(width: 14),

              // Info
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      subscription.name,
                      style: TextStyle(
                        fontSize: 15,
                        fontWeight: FontWeight.w500,
                        color: QuietLuxury.textPrimary,
                        letterSpacing: 0.2,
                      ),
                    ),
                    const SizedBox(height: 6),
                    Row(
                      children: [
                        Container(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 8,
                            vertical: 3,
                          ),
                          decoration: BoxDecoration(
                            color: QuietLuxury.textTertiary.withValues(
                              alpha: 0.1,
                            ),
                            borderRadius: BorderRadius.circular(6),
                          ),
                          child: Text(
                            subscription.category,
                            style: QuietLuxury.label.copyWith(fontSize: 10),
                          ),
                        ),
                        const SizedBox(width: 8),
                        Icon(
                          CupertinoIcons.clock,
                          size: 11,
                          color: _getRenewalColor(),
                        ),
                        const SizedBox(width: 4),
                        Text(
                          _formatNextRenewal(l10n),
                          style: TextStyle(
                            fontSize: 11,
                            color: _getRenewalColor(),
                            fontWeight: FontWeight.w500,
                          ),
                        ),
                      ],
                    ),
                  ],
                ),
              ),

              // Amount
              Column(
                crossAxisAlignment: CrossAxisAlignment.end,
                children: [
                  Text(
                    '${formatTurkishCurrency(subscription.amount, decimalDigits: 2)} ₺',
                    style: TextStyle(
                      fontSize: 15,
                      fontWeight: FontWeight.w500,
                      letterSpacing: 0.3,
                      color: QuietLuxury.textPrimary,
                    ),
                  ),
                  const SizedBox(height: 2),
                  Text(l10n.perMonth, style: QuietLuxury.label),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

  String _getEmoji(String name) {
    final lower = name.toLowerCase();
    if (lower.contains('netflix')) return '🎬';
    if (lower.contains('spotify')) return '🎵';
    if (lower.contains('youtube')) return '▶️';
    if (lower.contains('amazon')) return '📦';
    if (lower.contains('disney')) return '🏰';
    if (lower.contains('apple')) return '🍎';
    if (lower.contains('gym') || lower.contains('spor')) return '💪';
    if (lower.contains('game') || lower.contains('oyun')) return '🎮';
    if (lower.contains('cloud') || lower.contains('drive')) return '☁️';
    if (lower.contains('music') || lower.contains('müzik')) return '🎵';
    if (lower.contains('news') || lower.contains('haber')) return '📰';
    return '📅';
  }

  void _showOptionsMenu(BuildContext context, AppLocalizations l10n) {
    showModalBottomSheet(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      backgroundColor: QuietLuxury.background,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
      ),
      builder: (context) => SafeArea(
        child: Padding(
          padding: QuietLuxury.pagePadding,
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Container(
                width: 36,
                height: 4,
                decoration: BoxDecoration(
                  color: QuietLuxury.textTertiary.withValues(alpha: 0.3),
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
              const SizedBox(height: 24),
              _buildMenuTile(
                context: context,
                icon: CupertinoIcons.pencil,
                label: l10n.edit,
                color: AppColors.categoryEntertainment.withValues(
                  alpha: 0.7,
                ), // Subtle blue
                onTap: () {
                  Navigator.pop(context);
                  onEdit();
                },
              ),
              const SizedBox(height: 12),
              _buildMenuTile(
                context: context,
                icon: CupertinoIcons.trash,
                label: l10n.delete,
                color: QuietLuxury.negative,
                onTap: () {
                  Navigator.pop(context);
                  onDelete();
                },
              ),
              const SizedBox(height: 12),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildMenuTile({
    required BuildContext context,
    required IconData icon,
    required String label,
    required Color color,
    required VoidCallback onTap,
  }) {
    return Pressable(
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: color.withValues(alpha: 0.1),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: color.withValues(alpha: 0.2), width: 0.5),
        ),
        child: Row(
          children: [
            Icon(icon, color: color.withValues(alpha: 0.8), size: 20),
            const SizedBox(width: 14),
            Text(
              label,
              style: TextStyle(
                fontSize: 15,
                fontWeight: FontWeight.w500,
                color: color,
              ),
            ),
          ],
        ),
      ),
    );
  }
}

class _AddEditSubscriptionSheet extends StatefulWidget {
  final Subscription? existing;
  final VoidCallback onSaved;

  const _AddEditSubscriptionSheet({this.existing, required this.onSaved});

  @override
  State<_AddEditSubscriptionSheet> createState() =>
      _AddEditSubscriptionSheetState();
}

class _AddEditSubscriptionSheetState extends State<_AddEditSubscriptionSheet> {
  final _subscriptionService = SubscriptionService();
  final _nameController = TextEditingController();
  final _amountController = TextEditingController();

  int _renewalDay = 1;
  String _category = ExpenseCategory.all.first;
  bool _isActive = true;
  bool _autoRecord = false;
  bool _isSaving = false;

  bool get _isEditMode => widget.existing != null;

  @override
  void initState() {
    super.initState();
    if (widget.existing != null) {
      _nameController.text = widget.existing!.name;
      _amountController.text = formatTurkishCurrency(
        widget.existing!.amount,
        decimalDigits: 2,
      );
      _renewalDay = widget.existing!.renewalDay;
      _category = widget.existing!.category;
      _isActive = widget.existing!.isActive;
      _autoRecord = widget.existing!.autoRecord;
    }
  }

  @override
  void dispose() {
    _nameController.dispose();
    _amountController.dispose();
    super.dispose();
  }

  Future<void> _save() async {
    final l10n = AppLocalizations.of(context);
    final name = _nameController.text.trim();
    final amount = double.tryParse(_amountController.text);

    if (name.isEmpty) {
      _showError(l10n.enterSubscriptionName);
      return;
    }

    if (amount == null || amount <= 0) {
      _showError(l10n.enterValidAmount);
      return;
    }

    setState(() => _isSaving = true);

    final subscription = Subscription(
      id: widget.existing?.id ?? _subscriptionService.generateId(),
      name: name,
      amount: amount,
      renewalDay: _renewalDay,
      category: _category,
      isActive: _isActive,
      autoRecord: _autoRecord,
      createdAt: widget.existing?.createdAt ?? DateTime.now(),
    );

    if (_isEditMode) {
      await _subscriptionService.updateSubscription(
        widget.existing!.id,
        subscription,
      );
    } else {
      await _subscriptionService.addSubscription(subscription);
    }

    if (!mounted) return;

    widget.onSaved();
    Navigator.pop(context);
  }

  void _showError(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: context.appColors.error,
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final currencyProvider = context.watch<CurrencyProvider>();
    return Padding(
      padding: EdgeInsets.only(
        left: 24,
        right: 24,
        top: 16,
        bottom: MediaQuery.of(context).viewInsets.bottom + 24,
      ),
      child: SingleChildScrollView(
        child: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Handle
            Center(
              child: Container(
                width: 40,
                height: 4,
                decoration: BoxDecoration(
                  color: context.appColors.textTertiary,
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
            ),
            const SizedBox(height: 20),

            // Title
            Text(
              _isEditMode ? l10n.editSubscription : l10n.newSubscription,
              style: TextStyle(
                fontSize: 20,
                fontWeight: FontWeight.w700,
                color: context.appColors.textPrimary,
              ),
            ),
            const SizedBox(height: 24),

            // Name
            Text(
              l10n.subscriptionName,
              style: TextStyle(
                fontSize: 13,
                fontWeight: FontWeight.w500,
                color: context.appColors.textSecondary,
              ),
            ),
            const SizedBox(height: 8),
            TextField(
              controller: _nameController,
              decoration: InputDecoration(
                hintText: l10n.subscriptionNameHint,
                filled: true,
                fillColor: context.appColors.surfaceLight,
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(16),
                  borderSide: BorderSide.none,
                ),
              ),
              style: TextStyle(color: context.appColors.textPrimary),
            ),
            const SizedBox(height: 16),

            // Amount and Day
            Row(
              children: [
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        l10n.monthlyAmount,
                        style: TextStyle(
                          fontSize: 13,
                          fontWeight: FontWeight.w500,
                          color: context.appColors.textSecondary,
                        ),
                      ),
                      const SizedBox(height: 8),
                      TextField(
                        controller: _amountController,
                        keyboardType: TextInputType.number,
                        decoration: InputDecoration(
                          hintText: '0',
                          suffixText: currencyProvider.code,
                          filled: true,
                          fillColor: context.appColors.surfaceLight,
                          border: OutlineInputBorder(
                            borderRadius: BorderRadius.circular(16),
                            borderSide: BorderSide.none,
                          ),
                        ),
                        style: TextStyle(color: context.appColors.textPrimary),
                      ),
                    ],
                  ),
                ),
                const SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        l10n.renewalDay,
                        style: TextStyle(
                          fontSize: 13,
                          fontWeight: FontWeight.w500,
                          color: context.appColors.textSecondary,
                        ),
                      ),
                      const SizedBox(height: 8),
                      Container(
                        padding: const EdgeInsets.symmetric(horizontal: 12),
                        decoration: BoxDecoration(
                          color: context.appColors.surfaceLight,
                          borderRadius: BorderRadius.circular(16),
                        ),
                        child: DropdownButtonHideUnderline(
                          child: DropdownButton<int>(
                            value: _renewalDay,
                            isExpanded: true,
                            dropdownColor: context.appColors.surface,
                            items: List.generate(31, (i) => i + 1)
                                .map(
                                  (day) => DropdownMenuItem(
                                    value: day,
                                    child: Text(
                                      l10n.dayOfMonth(day),
                                      style: TextStyle(
                                        color: context.appColors.textPrimary,
                                        fontSize: 14,
                                      ),
                                    ),
                                  ),
                                )
                                .toList(),
                            onChanged: (val) {
                              if (val != null) {
                                setState(() => _renewalDay = val);
                              }
                            },
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
            const SizedBox(height: 16),

            // Category
            Text(
              l10n.category,
              style: TextStyle(
                fontSize: 13,
                fontWeight: FontWeight.w500,
                color: context.appColors.textSecondary,
              ),
            ),
            const SizedBox(height: 8),
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 12),
              decoration: BoxDecoration(
                color: context.appColors.surfaceLight,
                borderRadius: BorderRadius.circular(16),
              ),
              child: DropdownButtonHideUnderline(
                child: DropdownButton<String>(
                  value: _category,
                  isExpanded: true,
                  dropdownColor: context.appColors.surface,
                  items: ExpenseCategory.all
                      .map(
                        (cat) => DropdownMenuItem(
                          value: cat,
                          child: Text(
                            ExpenseCategory.getLocalizedName(cat, l10n),
                            style: TextStyle(
                              color: context.appColors.textPrimary,
                            ),
                          ),
                        ),
                      )
                      .toList(),
                  onChanged: (val) {
                    if (val != null) setState(() => _category = val);
                  },
                ),
              ),
            ),
            const SizedBox(height: 20),

            // Toggles
            _buildToggle(
              title: l10n.active,
              subtitle: l10n.passivesNotIncluded,
              value: _isActive,
              onChanged: (val) => setState(() => _isActive = val),
            ),
            const SizedBox(height: 12),
            _buildToggle(
              title: l10n.autoRecord,
              subtitle: l10n.autoRecordDescription,
              value: _autoRecord,
              onChanged: (val) => setState(() => _autoRecord = val),
            ),
            const SizedBox(height: 24),

            // Save button
            SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                onPressed: _isSaving ? null : _save,
                style: ElevatedButton.styleFrom(
                  backgroundColor: context.appColors.primary,
                  foregroundColor: context.appColors.background,
                  disabledBackgroundColor: context.appColors.primary.withValues(
                    alpha: 0.5,
                  ),
                  padding: const EdgeInsets.symmetric(vertical: 16),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(16),
                  ),
                ),
                child: _isSaving
                    ? SizedBox(
                        height: 20,
                        width: 20,
                        child: CircularProgressIndicator(
                          strokeWidth: 2,
                          valueColor: AlwaysStoppedAnimation<Color>(
                            context.appColors.background,
                          ),
                        ),
                      )
                    : Text(
                        _isEditMode ? l10n.update : l10n.add,
                        style: const TextStyle(
                          fontSize: 16,
                          fontWeight: FontWeight.w600,
                        ),
                      ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildToggle({
    required String title,
    required String subtitle,
    required bool value,
    required ValueChanged<bool> onChanged,
  }) {
    return Container(
      padding: const EdgeInsets.all(14),
      decoration: BoxDecoration(
        color: context.appColors.surfaceLight,
        borderRadius: BorderRadius.circular(16),
      ),
      child: Row(
        children: [
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  title,
                  style: TextStyle(
                    fontSize: 14,
                    fontWeight: FontWeight.w500,
                    color: context.appColors.textPrimary,
                  ),
                ),
                const SizedBox(height: 2),
                Text(
                  subtitle,
                  style: TextStyle(
                    fontSize: 12,
                    color: context.appColors.textTertiary,
                  ),
                ),
              ],
            ),
          ),
          Switch(
            value: value,
            onChanged: onChanged,
            activeTrackColor: context.appColors.primary,
            activeThumbColor: context.appColors.textPrimary,
          ),
        ],
      ),
    );
  }
}

/// Abonelik Yönetimi Butonu - Quiet Luxury
/// Tüm abonelikleri yönetmek için ana ekrana yönlendirir
class _SubscriptionManageButton extends StatefulWidget {
  final VoidCallback onTap;

  const _SubscriptionManageButton({required this.onTap});

  @override
  State<_SubscriptionManageButton> createState() =>
      _SubscriptionManageButtonState();
}

class _SubscriptionManageButtonState extends State<_SubscriptionManageButton> {
  SubscriptionStats? _stats;
  bool _isLoading = true;

  @override
  void initState() {
    super.initState();
    _loadStats();
  }

  Future<void> _loadStats() async {
    try {
      final stats = await subscriptionManager.getStats();
      if (mounted) {
        setState(() {
          _stats = stats;
          _isLoading = false;
        });
      }
    } catch (e) {
      debugPrint('[SubscriptionManageButton] Error loading stats: $e');
      if (mounted) {
        setState(() => _isLoading = false);
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final accentColor = _stats?.statusColor ?? QuietLuxury.textSecondary;

    return Pressable(
      onTap: () {
        HapticFeedback.lightImpact();
        widget.onTap();
      },
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 12),
        decoration: BoxDecoration(
          color: accentColor.withValues(alpha: 0.08),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: accentColor.withValues(alpha: 0.2),
            width: 0.5,
          ),
        ),
        child: Row(
          children: [
            // Icon
            Icon(CupertinoIcons.calendar, size: 20, color: accentColor),
            const SizedBox(width: 12),

            // Text
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    l10n.calendarView,
                    style: TextStyle(
                      fontSize: 14,
                      fontWeight: FontWeight.w500,
                      color: accentColor,
                      letterSpacing: 0.2,
                    ),
                  ),
                  const SizedBox(height: 2),
                  Text(
                    _isLoading
                        ? l10n.loading
                        : _stats != null && _stats!.totalCount > 0
                        ? l10n.subscriptionCount(
                            _stats!.totalCount,
                            _stats!.totalMonthlyCost.toStringAsFixed(0),
                          )
                        : l10n.viewSubscriptionsInCalendar,
                    style: QuietLuxury.label,
                  ),
                ],
              ),
            ),

            // Arrow
            Icon(
              CupertinoIcons.chevron_right,
              size: 12,
              color: accentColor.withValues(alpha: 0.5),
            ),
          ],
        ),
      ),
    );
  }
}


--- FILE: lib/widgets/streak_widget.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../core/theme/psychology_design_system.dart';
import '../services/services.dart';

class StreakWidget extends StatefulWidget {
  final VoidCallback? onTap;

  const StreakWidget({super.key, this.onTap});

  @override
  State<StreakWidget> createState() => StreakWidgetState();
}

class StreakWidgetState extends State<StreakWidget>
    with SingleTickerProviderStateMixin {
  final _streakService = StreakService();
  StreakData? _streakData;
  late AnimationController _pulseController;
  late Animation<double> _pulseAnimation;

  @override
  void initState() {
    super.initState();
    _loadStreak();
    // Psychology-based pulse animation (800ms cycle for active streak)
    _pulseController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 800),
    );
    _pulseAnimation = Tween<double>(
      begin: PsychologyAnimations.pulseMin,
      end: PsychologyAnimations.pulseMax,
    ).animate(CurvedAnimation(
      parent: _pulseController,
      curve: Curves.easeInOut,
    ));
  }

  @override
  void dispose() {
    _pulseController.dispose();
    super.dispose();
  }

  Future<void> _loadStreak() async {
    final data = await _streakService.getStreakData();
    if (mounted) {
      setState(() => _streakData = data);
      // Start pulse animation only when streak is active
      if (data.displayStreak > 0) {
        _pulseController.repeat(reverse: true);
      }
    }
  }

  /// Reloads streak (callable from outside)
  Future<void> refresh() async {
    await _loadStreak();
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    if (_streakData == null) {
      return const SizedBox.shrink();
    }

    final streak = _streakData!;
    final hasStreak = streak.displayStreak > 0;
    final color = hasStreak
        ? PsychologyColors.streakFlame
        : PsychologyColors.textTertiary;

    // Accessibility: Semantic label for screen readers
    final semanticLabel = l10n.accessibilityStreakInfo(
      streak.displayStreak,
      streak.longestStreak,
    );

    return Semantics(
      label: semanticLabel,
      button: true,
      child: GestureDetector(
        onTap: () {
          HapticFeedback.lightImpact();
          (widget.onTap ?? () => _showStreakDetails(context))();
        },
        child: AnimatedBuilder(
          animation: _pulseAnimation,
          builder: (context, child) {
            return Container(
              padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 8),
              decoration: BoxDecoration(
                color: color.withValues(alpha: 0.12),
                borderRadius: BorderRadius.circular(PsychologyRadius.full),
                border: Border.all(
                  color: color.withValues(alpha: 0.25),
                ),
                boxShadow: hasStreak
                    ? PsychologyShadows.glow(color, intensity: 0.3)
                    : null,
              ),
              child: Row(
                mainAxisSize: MainAxisSize.min,
                children: [
                  Transform.scale(
                    scale: hasStreak ? _pulseAnimation.value : 1.0,
                    child: Icon(
                      CupertinoIcons.flame_fill,
                      size: 18,
                      color: color,
                      shadows: hasStreak
                          ? PsychologyShadows.iconHalo(color)
                          : null,
                    ),
                  ),
                  const SizedBox(width: 6),
                  Text(
                    hasStreak
                        ? l10n.streakDays(streak.displayStreak)
                        : l10n.startToday,
                    style: PsychologyTypography.labelMedium.copyWith(
                      color: color,
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                ],
              ),
            );
          },
        ),
      ),
    );
  }

  void _showStreakDetails(BuildContext context) {
    if (_streakData == null) return;

    final l10n = AppLocalizations.of(context);
    final streak = _streakData!;
    final color = streak.hasStreak
        ? PsychologyColors.streakFlame
        : PsychologyColors.primary;

    showModalBottomSheet(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      backgroundColor: PsychologyColors.surface,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(
          top: Radius.circular(PsychologyRadius.xxl),
        ),
      ),
      builder: (context) => SafeArea(
        child: Padding(
          padding: PsychologySpacing.sheetPadding,
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              // Handle bar
              Container(
                width: 40,
                height: 4,
                decoration: BoxDecoration(
                  color: PsychologyColors.textTertiary,
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
              const SizedBox(height: 24),

              // Big icon with psychology glow
              Container(
                width: 80,
                height: 80,
                decoration: BoxDecoration(
                  color: color.withValues(alpha: 0.15),
                  shape: BoxShape.circle,
                  boxShadow: PsychologyShadows.glow(color, intensity: 0.4),
                ),
                child: Center(
                  child: Icon(
                    streak.hasStreak
                        ? CupertinoIcons.flame_fill
                        : CupertinoIcons.sportscourt_fill,
                    size: 40,
                    color: color,
                    shadows: PsychologyShadows.iconHalo(color),
                  ),
                ),
              ),
              const SizedBox(height: 16),

              // Title
              Text(
                streak.hasStreak
                    ? l10n.dayStreak(streak.displayStreak)
                    : l10n.startStreak,
                style: PsychologyTypography.headlineMedium,
              ),
              const SizedBox(height: 8),

              // Description
              Text(
                streak.hasStreak
                    ? l10n.keepStreakMessage
                    : l10n.startStreakMessage,
                textAlign: TextAlign.center,
                style: PsychologyTypography.bodyMedium,
              ),
              const SizedBox(height: 24),

              // Statistics
              if (streak.longestStreak > 0)
                Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: PsychologyColors.surfaceElevated,
                    borderRadius: BorderRadius.circular(PsychologyRadius.lg),
                    border: Border.all(
                      color: PsychologyColors.streakFlame.withValues(alpha: 0.2),
                    ),
                  ),
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(
                        CupertinoIcons.rosette,
                        size: 20,
                        color: PsychologyColors.streakFlame,
                      ),
                      const SizedBox(width: 8),
                      Text(
                        l10n.longestStreak(streak.longestStreak),
                        style: PsychologyTypography.labelMedium.copyWith(
                          color: PsychologyColors.textSecondary,
                        ),
                      ),
                    ],
                  ),
                ),

              // New record notification with success glow
              if (streak.isNewRecord && streak.displayStreak > 1) ...[
                const SizedBox(height: 12),
                Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 16,
                    vertical: 8,
                  ),
                  decoration: BoxDecoration(
                    color: PsychologyColors.success.withValues(alpha: 0.15),
                    borderRadius: BorderRadius.circular(PsychologyRadius.full),
                    border: Border.all(
                      color: PsychologyColors.success.withValues(alpha: 0.3),
                    ),
                    boxShadow: PsychologyShadows.glow(
                      PsychologyColors.success,
                      intensity: 0.25,
                    ),
                  ),
                  child: Row(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Icon(
                        CupertinoIcons.star_circle_fill,
                        size: 16,
                        color: PsychologyColors.success,
                      ),
                      const SizedBox(width: 6),
                      Text(
                        l10n.newRecord,
                        style: PsychologyTypography.labelMedium.copyWith(
                          color: PsychologyColors.success,
                        ),
                      ),
                    ],
                  ),
                ),
              ],

              const SizedBox(height: 16),
            ],
          ),
        ),
      ),
    );
  }
}


--- FILE: lib/widgets/saved_money_counter.dart ---

import 'dart:math';
import 'package:flutter/material.dart';
import 'package:flutter/cupertino.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';
import '../providers/currency_provider.dart';
import '../services/services.dart';
import '../theme/theme.dart';
import '../utils/currency_utils.dart';
import 'animated_counter.dart';

/// Saved money counter widget showing savings statistics
class SavedMoneyCounter extends StatelessWidget {
  final DecisionStats stats;
  final ExchangeRates? exchangeRates;

  const SavedMoneyCounter({super.key, required this.stats, this.exchangeRates});

  String _formatCurrency(double amount, {int decimals = 2}) {
    return formatTurkishCurrency(amount, decimalDigits: decimals);
  }

  String _formatTime(AppLocalizations l10n) {
    final hours = stats.savedHours;
    final days = stats.savedDays;

    if (days >= 1) {
      return l10n.savedTimeHoursDays(
        hours.toStringAsFixed(0),
        days.toStringAsFixed(1),
      );
    } else if (hours >= 1) {
      return l10n.savedTimeHours(hours.toStringAsFixed(1));
    } else {
      final minutes = (hours * 60).round();
      return l10n.savedTimeMinutes(minutes);
    }
  }

  String? _getEmotionalMessage(AppLocalizations l10n) {
    if (exchangeRates == null) return null;

    final savedTL = stats.savedAmount;
    final goldGrams = savedTL / exchangeRates!.goldRate;
    final days = stats.savedDays;

    final messages = <String>[];

    // Gold message
    if (goldGrams >= 0.1) {
      messages.add(l10n.couldBuyGoldGrams(goldGrams.toStringAsFixed(1)));
    }

    // Work days message
    if (days >= 0.5) {
      if (days >= 1) {
        messages.add(l10n.equivalentWorkDays(days.toStringAsFixed(1)));
      } else {
        final hours = stats.savedHours;
        messages.add(l10n.equivalentWorkHours(hours.toStringAsFixed(0)));
      }
    }

    // USD message
    final usdAmount = savedTL / exchangeRates!.usdRate;
    if (usdAmount >= 10) {
      messages.add(
        l10n.savedDollars(formatTurkishCurrency(usdAmount, decimalDigits: 2)),
      );
    }

    if (messages.isEmpty) return null;

    // Select a random message
    final random = Random();
    return messages[random.nextInt(messages.length)];
  }

  @override
  Widget build(BuildContext context) {
    if (stats.noCount == 0) {
      return const SizedBox.shrink();
    }

    final l10n = AppLocalizations.of(context);
    final currencyProvider = context.watch<CurrencyProvider>();
    final emotionalMessage = _getEmotionalMessage(l10n);

    return Container(
      width: double.infinity,
      margin: const EdgeInsets.only(bottom: 24),
      padding: const EdgeInsets.symmetric(vertical: 24, horizontal: 20),
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(24),
        border: Border.all(
          color: context.appColors.primary.withValues(alpha: 0.2),
          width: 1,
        ),
      ),
      child: Column(
        children: [
          // Icon
          Container(
            width: 44,
            height: 44,
            decoration: BoxDecoration(
              color: context.appColors.primary.withValues(alpha: 0.1),
              borderRadius: BorderRadius.circular(16),
            ),
            child: Icon(
              CupertinoIcons.shield_lefthalf_fill,
              size: 22,
              color: context.appColors.primary,
            ),
          ),
          const SizedBox(height: 16),

          // Amount with slot-machine style animation
          Row(
            mainAxisAlignment: MainAxisAlignment.center,
            crossAxisAlignment: CrossAxisAlignment.end,
            children: [
              NumberTicker(
                value: stats.savedAmount,
                style: TextStyle(
                  fontSize: 42,
                  fontWeight: FontWeight.w700,
                  color: context.appColors.primary,
                  letterSpacing: -2,
                  height: 1.2,
                ),
                duration: const Duration(milliseconds: 1000),
                curve: Curves.easeOutCubic,
                useGrouping: true,
              ),
              Padding(
                padding: const EdgeInsets.only(bottom: 6, left: 4),
                child: Text(
                  currencyProvider.symbol,
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.w600,
                    color: context.appColors.primary,
                  ),
                ),
              ),
            ],
          ),
          const SizedBox(height: 6),

          // Label
          Text(
            l10n.youSaved,
            style: TextStyle(
              fontSize: 15,
              fontWeight: FontWeight.w600,
              color: context.appColors.textPrimary,
            ),
          ),

          // Currency alternatives
          if (exchangeRates != null && stats.savedAmount > 0) ...[
            const SizedBox(height: 16),

            // OR text
            Text(
              l10n.or,
              style: TextStyle(
                fontSize: 10,
                fontWeight: FontWeight.w600,
                color: context.appColors.textTertiary,
                letterSpacing: 1.5,
              ),
            ),
            const SizedBox(height: 12),

            // Currency list
            _buildCurrencyAlternatives(context, l10n),
          ],

          const SizedBox(height: 16),

          // Time saved
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 6),
            decoration: BoxDecoration(
              color: context.appColors.surfaceLight,
              borderRadius: BorderRadius.circular(16),
            ),
            child: Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                Icon(
                  CupertinoIcons.clock,
                  size: 14,
                  color: context.appColors.textSecondary,
                ),
                const SizedBox(width: 6),
                Text(
                  _formatTime(l10n),
                  style: TextStyle(
                    fontSize: 12,
                    fontWeight: FontWeight.w500,
                    color: context.appColors.textSecondary,
                  ),
                ),
              ],
            ),
          ),

          // Emotional message
          if (emotionalMessage != null) ...[
            const SizedBox(height: 12),
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 8),
              decoration: BoxDecoration(
                color: context.appColors.primary.withValues(alpha: 0.08),
                borderRadius: BorderRadius.circular(16),
              ),
              child: Row(
                mainAxisSize: MainAxisSize.min,
                children: [
                  const Text('💡', style: TextStyle(fontSize: 12)),
                  const SizedBox(width: 8),
                  Flexible(
                    child: Text(
                      emotionalMessage,
                      style: TextStyle(
                        fontSize: 11,
                        fontWeight: FontWeight.w500,
                        color: context.appColors.primary,
                      ),
                      textAlign: TextAlign.center,
                    ),
                  ),
                ],
              ),
            ),
          ],
        ],
      ),
    );
  }

  Widget _buildCurrencyAlternatives(
    BuildContext context,
    AppLocalizations l10n,
  ) {
    if (exchangeRates == null) return const SizedBox.shrink();

    final savedTL = stats.savedAmount;
    final usdAmount = savedTL / exchangeRates!.usdRate;
    final eurAmount = savedTL / exchangeRates!.eurRate;
    final goldGrams = savedTL / exchangeRates!.goldRate;

    return Wrap(
      alignment: WrapAlignment.center,
      spacing: 16,
      runSpacing: 8,
      children: [
        _buildCurrencyItem(context, '💵', '${_formatCurrency(usdAmount)} USD'),
        _buildCurrencyItem(context, '💶', '${_formatCurrency(eurAmount)} EUR'),
        _buildCurrencyItem(
          context,
          '🥇',
          l10n.goldGramsShort(_formatCurrency(goldGrams, decimals: 1)),
        ),
      ],
    );
  }

  Widget _buildCurrencyItem(BuildContext context, String emoji, String text) {
    return Row(
      mainAxisSize: MainAxisSize.min,
      children: [
        Text(emoji, style: const TextStyle(fontSize: 14)),
        const SizedBox(width: 4),
        Text(
          text,
          style: TextStyle(
            fontSize: 12,
            fontWeight: FontWeight.w500,
            color: context.appColors.textSecondary,
          ),
        ),
      ],
    );
  }
}


--- FILE: lib/widgets/empty_state.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:lottie/lottie.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../theme/theme.dart';

/// Enhanced empty state widget with CTA and value propositions
/// Features:
/// - Illustration/icon with pulse animation
/// - Value proposition (1 line)
/// - CTA button
/// - Optional example data preview
class EmptyState extends StatefulWidget {
  final IconData icon;
  final Color? iconColor;
  final String? title;
  final String message;
  final Widget? action;
  final bool useLottie;
  final String? ctaText;
  final VoidCallback? onCtaTap;
  final bool showExampleData;
  final Widget? exampleDataWidget;

  const EmptyState({
    super.key,
    this.icon = CupertinoIcons.tray,
    this.iconColor,
    this.title,
    required this.message,
    this.action,
    this.useLottie = false,
    this.ctaText,
    this.onCtaTap,
    this.showExampleData = false,
    this.exampleDataWidget,
  });

  /// Empty state for expense list - engaging CTA
  factory EmptyState.expenses({
    required String message,
    required String ctaText,
    required VoidCallback onCtaTap,
    bool useLottie = true,
  }) {
    return EmptyState(
      icon: CupertinoIcons.doc_text,
      iconColor: const Color(0xFF6C63FF),
      message: message,
      useLottie: useLottie,
      ctaText: ctaText,
      onCtaTap: onCtaTap,
    );
  }

  /// Empty state for achievements list
  factory EmptyState.achievements({
    required String message,
    String? ctaText,
    VoidCallback? onCtaTap,
  }) {
    return EmptyState(
      icon: CupertinoIcons.rosette,
      iconColor: const Color(0xFFF59E0B),
      message: message,
      ctaText: ctaText,
      onCtaTap: onCtaTap,
    );
  }

  /// Empty state for reports
  factory EmptyState.reports({
    required String message,
    String? ctaText,
    VoidCallback? onCtaTap,
  }) {
    return EmptyState(
      icon: CupertinoIcons.chart_bar,
      iconColor: const Color(0xFF2DD4BF),
      message: message,
      ctaText: ctaText,
      onCtaTap: onCtaTap,
    );
  }

  /// Empty state for subscription list
  factory EmptyState.subscriptions({
    required String message,
    String? ctaText,
    VoidCallback? onCtaTap,
  }) {
    return EmptyState(
      icon: CupertinoIcons.calendar_badge_plus,
      iconColor: const Color(0xFF8B5CF6),
      message: message,
      ctaText: ctaText,
      onCtaTap: onCtaTap,
    );
  }

  /// Empty state for pursuits with Lottie animation
  factory EmptyState.pursuits({
    required String message,
    required String ctaText,
    required VoidCallback onCtaTap,
    bool useLottie = true,
  }) {
    return EmptyState(
      icon: CupertinoIcons.scope,
      iconColor: const Color(0xFF10B981),
      message: message,
      useLottie: useLottie,
      ctaText: ctaText,
      onCtaTap: onCtaTap,
    );
  }

  /// Empty state for AI chat history
  factory EmptyState.aiChat({
    required String message,
    String? ctaText,
    VoidCallback? onCtaTap,
  }) {
    return EmptyState(
      icon: CupertinoIcons.sparkles,
      iconColor: const Color(0xFF6C63FF),
      message: message,
      ctaText: ctaText,
      onCtaTap: onCtaTap,
    );
  }

  /// Empty state for savings pool
  factory EmptyState.savingsPool({
    required String message,
    String? ctaText,
    VoidCallback? onCtaTap,
  }) {
    return EmptyState(
      icon: CupertinoIcons.money_dollar_circle,
      iconColor: const Color(0xFF10B981),
      message: message,
      ctaText: ctaText,
      onCtaTap: onCtaTap,
    );
  }

  /// Empty state for search results
  factory EmptyState.searchResults({required String message}) {
    return EmptyState(
      icon: CupertinoIcons.search,
      iconColor: const Color(0xFF6B7280),
      message: message,
    );
  }

  @override
  State<EmptyState> createState() => _EmptyStateState();
}

class _EmptyStateState extends State<EmptyState> with TickerProviderStateMixin {
  late AnimationController _fadeController;
  late AnimationController _pulseController;
  late Animation<double> _fadeAnimation;
  late Animation<double> _pulseAnimation;

  @override
  void initState() {
    super.initState();

    // Fade in animasyonu
    _fadeController = AnimationController(
      vsync: this,
      duration: AppAnimations.long,
    );

    _fadeAnimation = CurvedAnimation(
      parent: _fadeController,
      curve: AppAnimations.standardCurve,
    );

    // Pulse animasyonu
    _pulseController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 1500),
    );

    _pulseAnimation = Tween<double>(begin: 1.0, end: 1.08).animate(
      CurvedAnimation(parent: _pulseController, curve: Curves.easeInOut),
    );

    // Animasyonları başlat
    Future.delayed(AppAnimations.initialDelay, () {
      if (mounted) {
        _fadeController.forward();
        _pulseController.repeat(reverse: true);
      }
    });
  }

  @override
  void dispose() {
    _fadeController.dispose();
    _pulseController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final iconColor = widget.iconColor ?? context.appColors.primary;

    return RepaintBoundary(
      child: FadeTransition(
        opacity: _fadeAnimation,
        child: Center(
          child: Padding(
            padding: const EdgeInsets.all(32),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                // Animasyonlu ikon veya Lottie
                if (widget.useLottie)
                  SizedBox(
                    width: 150,
                    height: 150,
                    child: Lottie.asset(
                      'assets/animations/empty.json',
                      repeat: true,
                      fit: BoxFit.contain,
                    ),
                  )
                else
                  AnimatedBuilder(
                    animation: _pulseAnimation,
                    builder: (context, child) {
                      return Transform.scale(
                        scale: _pulseAnimation.value,
                        child: Container(
                          width: 88,
                          height: 88,
                          decoration: BoxDecoration(
                            gradient: LinearGradient(
                              begin: Alignment.topLeft,
                              end: Alignment.bottomRight,
                              colors: [
                                iconColor.withValues(alpha: 0.15),
                                iconColor.withValues(alpha: 0.05),
                              ],
                            ),
                            borderRadius: BorderRadius.circular(24),
                            border: Border.all(
                              color: iconColor.withValues(alpha: 0.2),
                              width: 1.5,
                            ),
                          ),
                          child: Icon(
                            widget.icon,
                            size: 40,
                            color: iconColor,
                          ),
                        ),
                      );
                    },
                  ),
                const SizedBox(height: 24),

                // Başlık (opsiyonel)
                if (widget.title != null) ...[
                  Text(
                    widget.title!,
                    style: TextStyle(
                      fontSize: 20,
                      fontWeight: FontWeight.w700,
                      color: context.appColors.textPrimary,
                    ),
                    textAlign: TextAlign.center,
                  ),
                  const SizedBox(height: 8),
                ],

                // Mesaj - değer önerisi (1 satır)
                Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 16),
                  child: Text(
                    widget.message,
                    style: TextStyle(
                      fontSize: 15,
                      color: context.appColors.textSecondary,
                      height: 1.4,
                    ),
                    textAlign: TextAlign.center,
                    maxLines: 2,
                    overflow: TextOverflow.ellipsis,
                  ),
                ),

                // CTA Button
                if (widget.ctaText != null && widget.onCtaTap != null) ...[
                  const SizedBox(height: 24),
                  _buildCtaButton(context, iconColor),
                ],

                // Eski aksiyon butonu (geriye uyumluluk)
                if (widget.action != null && widget.ctaText == null) ...[
                  const SizedBox(height: 24),
                  widget.action!,
                ],

                // Örnek veri gösterimi
                if (widget.showExampleData && widget.exampleDataWidget != null) ...[
                  const SizedBox(height: 32),
                  _buildExampleDataSection(context),
                ],
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildCtaButton(BuildContext context, Color iconColor) {
    return GestureDetector(
      onTap: () {
        HapticFeedback.lightImpact();
        widget.onCtaTap?.call();
      },
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 28, vertical: 14),
        decoration: BoxDecoration(
          color: iconColor,
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            BoxShadow(
              color: iconColor.withValues(alpha: 0.3),
              blurRadius: 12,
              offset: const Offset(0, 4),
            ),
          ],
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(
              CupertinoIcons.plus,
              size: 18,
              color: Colors.white,
            ),
            const SizedBox(width: 8),
            Text(
              widget.ctaText!,
              style: const TextStyle(
                fontSize: 15,
                fontWeight: FontWeight.w600,
                color: Colors.white,
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildExampleDataSection(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return Column(
      children: [
        Row(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Container(
              width: 40,
              height: 1,
              color: context.appColors.cardBorder,
            ),
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 12),
              child: Text(
                l10n.emptyStateExampleTitle,
                style: TextStyle(
                  fontSize: 12,
                  fontWeight: FontWeight.w500,
                  color: context.appColors.textTertiary,
                ),
              ),
            ),
            Container(
              width: 40,
              height: 1,
              color: context.appColors.cardBorder,
            ),
          ],
        ),
        const SizedBox(height: 16),
        Opacity(
          opacity: 0.6,
          child: widget.exampleDataWidget!,
        ),
      ],
    );
  }
}

/// Contextual empty state builder with localized messages
/// Use this for quick access to properly configured empty states
class ContextualEmptyState {
  /// Expenses empty state with localized message and CTA
  static Widget expenses(BuildContext context, {required VoidCallback onAdd}) {
    final l10n = AppLocalizations.of(context);
    return EmptyState.expenses(
      message: l10n.emptyStateExpensesMessage,
      ctaText: l10n.emptyStateExpensesCta,
      onCtaTap: onAdd,
    );
  }

  /// Pursuits empty state with localized message and CTA
  static Widget pursuits(BuildContext context, {required VoidCallback onAdd}) {
    final l10n = AppLocalizations.of(context);
    return EmptyState.pursuits(
      message: l10n.emptyStatePursuitsMessage,
      ctaText: l10n.emptyStatePursuitsCta,
      onCtaTap: onAdd,
    );
  }

  /// Reports empty state with localized message
  static Widget reports(BuildContext context, {VoidCallback? onAddExpense}) {
    final l10n = AppLocalizations.of(context);
    return EmptyState.reports(
      message: l10n.emptyStateReportsMessage,
      ctaText: onAddExpense != null ? l10n.emptyStateReportsCta : null,
      onCtaTap: onAddExpense,
    );
  }

  /// Subscriptions empty state with localized message and CTA
  static Widget subscriptions(BuildContext context, {required VoidCallback onAdd}) {
    final l10n = AppLocalizations.of(context);
    return EmptyState.subscriptions(
      message: l10n.emptyStateSubscriptionsMessage,
      ctaText: l10n.emptyStateSubscriptionsCta,
      onCtaTap: onAdd,
    );
  }

  /// Achievements empty state with localized message
  static Widget achievements(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    return EmptyState.achievements(
      message: l10n.emptyStateAchievementsMessage,
    );
  }

  /// Savings pool empty state with localized message
  static Widget savingsPool(BuildContext context, {VoidCallback? onAdd}) {
    final l10n = AppLocalizations.of(context);
    return EmptyState.savingsPool(
      message: l10n.emptyStateSavingsPoolMessage,
      onCtaTap: onAdd,
    );
  }

  /// Search results empty state
  static Widget searchResults(BuildContext context, String query) {
    return EmptyState.searchResults(
      message: '"$query" için sonuç bulunamadı',
    );
  }
}

/// Yükleniyor durumu için shimmer efektli placeholder
class LoadingPlaceholder extends StatefulWidget {
  final double width;
  final double height;
  final BorderRadius? borderRadius;

  const LoadingPlaceholder({
    super.key,
    this.width = double.infinity,
    this.height = 20,
    this.borderRadius,
  });

  @override
  State<LoadingPlaceholder> createState() => _LoadingPlaceholderState();
}

class _LoadingPlaceholderState extends State<LoadingPlaceholder>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _animation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 1500),
    );

    _animation = Tween<double>(
      begin: 0.0,
      end: 1.0,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeInOut));

    _controller.repeat(reverse: true);
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return RepaintBoundary(
      child: AnimatedBuilder(
        animation: _animation,
        builder: (context, child) {
          return Container(
            width: widget.width,
            height: widget.height,
            decoration: BoxDecoration(
              borderRadius: widget.borderRadius ?? BorderRadius.circular(4),
              gradient: LinearGradient(
                begin: Alignment.centerLeft,
                end: Alignment.centerRight,
                colors: [
                  context.appColors.surfaceLight,
                  context.appColors.surfaceLighter,
                  context.appColors.surfaceLight,
                ],
                stops: [0.0, _animation.value, 1.0],
              ),
            ),
          );
        },
      ),
    );
  }
}

/// Liste için shimmer placeholder
class ListLoadingPlaceholder extends StatelessWidget {
  final int itemCount;
  final double itemHeight;
  final double spacing;

  const ListLoadingPlaceholder({
    super.key,
    this.itemCount = 5,
    this.itemHeight = 80,
    this.spacing = 12,
  });

  @override
  Widget build(BuildContext context) {
    return Column(
      children: List.generate(itemCount, (index) {
        return Padding(
          padding: EdgeInsets.only(bottom: spacing),
          child: LoadingPlaceholder(
            height: itemHeight,
            borderRadius: BorderRadius.circular(16),
          ),
        );
      }),
    );
  }
}


--- FILE: lib/widgets/ai_insights_card.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import '../models/models.dart';
import '../theme/theme.dart';
import '../core/theme/premium_effects.dart';

/// AI Insights Card - Premium UI Element
/// Shows AI-generated insights about spending patterns
class AIInsightsCard extends StatelessWidget {
  final List<Expense> expenses;
  final List<Expense> lastMonthExpenses;

  const AIInsightsCard({
    super.key,
    required this.expenses,
    required this.lastMonthExpenses,
  });

  @override
  Widget build(BuildContext context) {
    final insights = _generateInsights();

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // Header
        Row(
          children: [
            Text(
              'AI Insights',
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.w600,
                color: context.appColors.textPrimary,
              ),
            ),
            const SizedBox(width: 8),
            const SmartBadge(),
          ],
        ),
        const SizedBox(height: 16),

        // Insight cards
        ...insights.map(
          (insight) => Padding(
            padding: const EdgeInsets.only(bottom: 12),
            child: _InsightCard(insight: insight),
          ),
        ),
      ],
    );
  }

  List<_Insight> _generateInsights() {
    final insights = <_Insight>[];

    // 1. Peak Spending Day
    final peakDay = _findPeakSpendingDay();
    if (peakDay != null) {
      insights.add(
        _Insight(
          icon: CupertinoIcons.calendar,
          iconColor: AppColors.premiumPurple,
          title: 'En Çok Harcama Günü',
          subtitle: peakDay,
        ),
      );
    }

    // 2. Top Category
    final topCategory = _findTopCategory();
    if (topCategory != null) {
      insights.add(
        _Insight(
          icon: CupertinoIcons.scope,
          iconColor: AppColors.premiumCyan,
          title: 'En Büyük Kategori',
          subtitle: topCategory,
        ),
      );
    }

    // 3. Month Comparison
    final comparison = _calculateMonthComparison();
    if (comparison != null) {
      insights.add(
        _Insight(
          icon: comparison.isDown
              ? CupertinoIcons.arrow_down_right
              : CupertinoIcons.arrow_up_right,
          iconColor: comparison.isDown ? AppColors.success : AppColors.error,
          title: 'Bu Ay vs Geçen Ay',
          subtitle: comparison.text,
        ),
      );
    }

    return insights;
  }

  String? _findPeakSpendingDay() {
    if (expenses.isEmpty) return null;

    final dayTotals = <int, double>{};
    for (final expense in expenses) {
      if (expense.decision == ExpenseDecision.yes) {
        final day = expense.date.weekday;
        dayTotals[day] = (dayTotals[day] ?? 0) + expense.amount;
      }
    }

    if (dayTotals.isEmpty) return null;

    final peakDay = dayTotals.entries.reduce(
      (a, b) => a.value > b.value ? a : b,
    );

    final dayNames = {
      1: 'Pazartesi',
      2: 'Salı',
      3: 'Çarşamba',
      4: 'Perşembe',
      5: 'Cuma',
      6: 'Cumartesi',
      7: 'Pazar',
    };

    return '${dayNames[peakDay.key]} en çok harcadığın gün';
  }

  String? _findTopCategory() {
    if (expenses.isEmpty) return null;

    final categoryTotals = <String, double>{};
    for (final expense in expenses) {
      if (expense.decision == ExpenseDecision.yes) {
        categoryTotals[expense.category] =
            (categoryTotals[expense.category] ?? 0) + expense.amount;
      }
    }

    if (categoryTotals.isEmpty) return null;

    final topCategory = categoryTotals.entries.reduce(
      (a, b) => a.value > b.value ? a : b,
    );

    return '${topCategory.key} en büyük kategorin';
  }

  _MonthComparison? _calculateMonthComparison() {
    final thisMonthTotal = expenses
        .where((e) => e.decision == ExpenseDecision.yes)
        .fold(0.0, (sum, e) => sum + e.amount);

    final lastMonthTotal = lastMonthExpenses
        .where((e) => e.decision == ExpenseDecision.yes)
        .fold(0.0, (sum, e) => sum + e.amount);

    if (lastMonthTotal == 0) return null;

    final change = ((thisMonthTotal - lastMonthTotal) / lastMonthTotal) * 100;
    final isDown = change < 0;

    return _MonthComparison(
      text:
          'Geçen aya göre %${change.abs().toStringAsFixed(0)} ${isDown ? 'düşüş' : 'artış'}',
      isDown: isDown,
    );
  }
}

class _Insight {
  final IconData icon;
  final Color iconColor;
  final String title;
  final String subtitle;

  const _Insight({
    required this.icon,
    required this.iconColor,
    required this.title,
    required this.subtitle,
  });
}

class _MonthComparison {
  final String text;
  final bool isDown;

  const _MonthComparison({required this.text, required this.isDown});
}

class _InsightCard extends StatefulWidget {
  final _Insight insight;

  const _InsightCard({required this.insight});

  @override
  State<_InsightCard> createState() => _InsightCardState();
}

class _InsightCardState extends State<_InsightCard>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _scaleAnimation;
  bool _isPressed = false;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 100),
    );
    _scaleAnimation = Tween<double>(
      begin: 1.0,
      end: 0.95,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeInOut));
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTapDown: (_) {
        setState(() => _isPressed = true);
        _controller.forward();
        HapticFeedback.lightImpact();
      },
      onTapUp: (_) {
        setState(() => _isPressed = false);
        _controller.reverse();
      },
      onTapCancel: () {
        setState(() => _isPressed = false);
        _controller.reverse();
      },
      child: AnimatedBuilder(
        animation: _scaleAnimation,
        builder: (context, child) {
          return Transform.scale(
            scale: _scaleAnimation.value,
            child: GradientBorder(
              borderRadius: 16,
              borderWidth: 1.5,
              child: Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: PremiumColors.cardBackground,
                  borderRadius: BorderRadius.circular(14.5),
                  boxShadow: _isPressed
                      ? PremiumShadows.glowPurple
                      : PremiumShadows.shadowPremium,
                ),
                child: Row(
                  children: [
                    // Icon with glow
                    Container(
                      width: 44,
                      height: 44,
                      decoration: BoxDecoration(
                        color: widget.insight.iconColor.withValues(alpha: 0.15),
                        borderRadius: BorderRadius.circular(16),
                        boxShadow: [
                          BoxShadow(
                            color: widget.insight.iconColor.withValues(
                              alpha: 0.3,
                            ),
                            blurRadius: 12,
                            spreadRadius: 0,
                          ),
                        ],
                      ),
                      child: Icon(
                        widget.insight.icon,
                        color: widget.insight.iconColor,
                        size: 22,
                        shadows: PremiumShadows.iconHalo(
                          widget.insight.iconColor,
                        ),
                      ),
                    ),
                    const SizedBox(width: 14),
                    // Text
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            widget.insight.title,
                            style: TextStyle(
                              fontSize: 12,
                              fontWeight: FontWeight.w500,
                              color: context.appColors.textSecondary,
                            ),
                          ),
                          const SizedBox(height: 2),
                          Text(
                            widget.insight.subtitle,
                            style: TextStyle(
                              fontSize: 14,
                              fontWeight: FontWeight.w600,
                              color: context.appColors.textPrimary,
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              ),
            ),
          );
        },
      ),
    );
  }
}


--- FILE: lib/widgets/result_card.dart ---

import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../core/theme/psychology_design_system.dart';
import '../models/models.dart';
import '../services/services.dart';
import '../utils/currency_utils.dart';

/// Premium Result Card - iOS 26 Liquid Glass Design
/// Hero component showing work hours required for an expense
/// Features: Glass morphism, animated glow, premium typography
class ResultCard extends StatefulWidget {
  final ExpenseResult result;
  final String? categoryInsight;
  final String? emotionalMessage;
  final double? amount;
  final ExchangeRates? exchangeRates;
  final String? amountCurrencyCode;
  final double dailyHours;
  final int workDaysPerWeek;

  const ResultCard({
    super.key,
    required this.result,
    this.categoryInsight,
    this.emotionalMessage,
    this.amount,
    this.exchangeRates,
    this.amountCurrencyCode,
    this.dailyHours = 8,
    this.workDaysPerWeek = 5,
  });

  @override
  State<ResultCard> createState() => _ResultCardState();
}

class _ResultCardState extends State<ResultCard>
    with SingleTickerProviderStateMixin {
  late AnimationController _glowController;
  late Animation<double> _glowAnimation;

  @override
  void initState() {
    super.initState();
    // Animated glow effect - subtle breathing (psychology-based timing)
    _glowController = AnimationController(
      vsync: this,
      duration: PsychologyAnimations.breathingCycle,
    )..repeat(reverse: true);

    _glowAnimation = Tween<double>(
      begin: PsychologyAnimations.glowMin,
      end: PsychologyAnimations.glowMax,
    ).animate(
      CurvedAnimation(parent: _glowController, curve: PsychologyAnimations.smooth),
    );
  }

  @override
  void dispose() {
    _glowController.dispose();
    super.dispose();
  }

  String _formatCurrency(double value, {int decimals = 2}) {
    return formatTurkishCurrency(value, decimalDigits: decimals);
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final insightService = InsightService();
    final insight = insightService.getExpenseInsight(context, widget.result);

    return AnimatedBuilder(
      animation: _glowAnimation,
      builder: (context, child) {
        return Container(
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(PsychologyRadius.xxl + 4),
            boxShadow: [
              // Animated outer glow
              BoxShadow(
                color: PsychologyColors.primary.withValues(
                  alpha: _glowAnimation.value,
                ),
                blurRadius: PsychologyGlass.heavyBlurSigma,
                spreadRadius: 0,
                offset: const Offset(0, 8),
              ),
              // Deep shadow for depth
              BoxShadow(
                color: Colors.black.withValues(alpha: 0.4),
                blurRadius: PsychologyGlass.blurSigma,
                offset: const Offset(0, 12),
              ),
            ],
          ),
          child: ClipRRect(
            borderRadius: BorderRadius.circular(PsychologyRadius.xxl + 4),
            child: BackdropFilter(
              filter: ImageFilter.blur(
                sigmaX: PsychologyGlass.heroBlurSigma,
                sigmaY: PsychologyGlass.heroBlurSigma,
              ),
              child: Container(
                width: double.infinity,
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(PsychologyRadius.xxl + 4),
                  // Premium glass gradient
                  gradient: LinearGradient(
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                    colors: [
                      PsychologyColors.primary.withValues(alpha: 0.35),
                      PsychologyColors.primaryDark.withValues(alpha: 0.25),
                      PsychologyColors.surfaceOverlay.withValues(alpha: 0.4),
                    ],
                    stops: const [0.0, 0.5, 1.0],
                  ),
                  // Glass border with highlight
                  border: Border.all(
                    color: PsychologyColors.glassHighlight,
                    width: 1.5,
                  ),
                ),
                child: Stack(
                  children: [
                    // Top-left highlight (glass light refraction)
                    Positioned(
                      top: 0,
                      left: 0,
                      right: 0,
                      height: 80,
                      child: Container(
                        decoration: BoxDecoration(
                          borderRadius: BorderRadius.vertical(
                            top: Radius.circular(PsychologyRadius.xxl + 4),
                          ),
                          gradient: PsychologyGlass.topHighlight,
                        ),
                      ),
                    ),
                    // Content
                    Padding(
                      padding: const EdgeInsets.all(24),
                      child: Column(
                        children: [
                          // Hero time display
                          _buildHeroTimeDisplay(context),

                          const SizedBox(height: 24),

                          // Emotional message
                          if (widget.emotionalMessage != null)
                            _buildEmotionalMessage(context),

                          // Insight message
                          _buildInsightCard(context, insight),

                          // Category insight
                          if (widget.categoryInsight != null) ...[
                            const SizedBox(height: 12),
                            _buildCategoryInsight(context),
                          ],

                          // Currency alternatives
                          if (widget.amount != null &&
                              widget.exchangeRates != null) ...[
                            const SizedBox(height: 16),
                            _buildCurrencyAlternatives(context, l10n),
                          ],
                        ],
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ),
        );
      },
    );
  }

  Widget _buildHeroTimeDisplay(BuildContext context) {
    final timeDisplay = getSimulationTimeDisplay(
      widget.result.hoursRequired,
      workHoursPerDay: widget.dailyHours,
      workDaysPerWeek: widget.workDaysPerWeek,
    );

    return Row(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        // Left block: Hours or Years
        _buildPremiumTimeBlock(
          context: context,
          value: timeDisplay.value1,
          unit: timeDisplay.unit1,
          icon: timeDisplay.isYearMode
              ? CupertinoIcons.calendar
              : CupertinoIcons.clock_fill,
          isPrimary: true,
        ),
        // Divider with glow
        Container(
          width: 2,
          height: 70,
          margin: const EdgeInsets.symmetric(horizontal: PsychologySpacing.xxl + 4),
          decoration: BoxDecoration(
            gradient: LinearGradient(
              begin: Alignment.topCenter,
              end: Alignment.bottomCenter,
              colors: [
                PsychologyColors.textPrimary.withValues(alpha: 0.0),
                PsychologyColors.textPrimary.withValues(alpha: 0.3),
                PsychologyColors.textPrimary.withValues(alpha: 0.0),
              ],
            ),
            borderRadius: BorderRadius.circular(1),
          ),
        ),
        // Right block: Days
        _buildPremiumTimeBlock(
          context: context,
          value: timeDisplay.value2,
          unit: timeDisplay.unit2,
          icon: CupertinoIcons.sun_max_fill,
          isPrimary: false,
        ),
      ],
    );
  }

  Widget _buildPremiumTimeBlock({
    required BuildContext context,
    required String value,
    required String unit,
    required IconData icon,
    required bool isPrimary,
  }) {
    final iconColor = isPrimary
        ? PsychologyColors.primary
        : PsychologyColors.secondary;

    return Column(
      children: [
        // Icon with glass container
        Container(
          width: 52,
          height: 52,
          decoration: BoxDecoration(
            gradient: LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: [
                iconColor.withValues(alpha: 0.25),
                iconColor.withValues(alpha: 0.1),
              ],
            ),
            borderRadius: BorderRadius.circular(16),
            border: Border.all(
              color: iconColor.withValues(alpha: 0.3),
              width: 1,
            ),
            boxShadow: [
              BoxShadow(
                color: iconColor.withValues(alpha: 0.3),
                blurRadius: 16,
                spreadRadius: 0,
              ),
            ],
          ),
          child: Icon(icon, size: 24, color: iconColor),
        ),
        const SizedBox(height: PsychologySpacing.md + 2),
        // Value - Premium tabular numbers
        Text(
          value,
          style: PsychologyTypography.displayMedium.copyWith(
            fontSize: 42,
            shadows: PsychologyShadows.iconHalo(iconColor),
          ),
        ),
        const SizedBox(height: PsychologySpacing.sm - 2),
        // Unit label
        Text(
          unit.toUpperCase(),
          style: PsychologyTypography.labelSmall.copyWith(
            color: PsychologyColors.textSecondary,
            letterSpacing: 1.5,
          ),
        ),
      ],
    );
  }

  Widget _buildEmotionalMessage(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.only(bottom: PsychologySpacing.lg),
      child: Container(
        width: double.infinity,
        padding: const EdgeInsets.symmetric(
          horizontal: PsychologySpacing.xl,
          vertical: PsychologySpacing.lg,
        ),
        decoration: BoxDecoration(
          gradient: LinearGradient(
            colors: [
              PsychologyColors.primaryMuted,
              PsychologyColors.secondarySubtle,
            ],
          ),
          borderRadius: BorderRadius.circular(PsychologyRadius.lg),
          border: Border.all(
            color: PsychologyColors.glassBorder,
          ),
        ),
        child: Text(
          widget.emotionalMessage!,
          textAlign: TextAlign.center,
          style: PsychologyTypography.bodyMedium.copyWith(
            fontStyle: FontStyle.italic,
            color: PsychologyColors.textPrimary.withValues(alpha: 0.9),
          ),
        ),
      ),
    );
  }

  Widget _buildInsightCard(BuildContext context, String insight) {
    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(PsychologySpacing.lg),
      decoration: BoxDecoration(
        color: PsychologyColors.glassFill,
        borderRadius: BorderRadius.circular(PsychologyRadius.lg),
        border: Border.all(
          color: PsychologyColors.glassBorder,
        ),
      ),
      child: Row(
        children: [
          // Icon container
          Container(
            width: 40,
            height: 40,
            decoration: BoxDecoration(
              gradient: PsychologyGlass.gradient(PsychologyColors.warning),
              borderRadius: BorderRadius.circular(PsychologyRadius.md),
            ),
            child: const Icon(
              CupertinoIcons.lightbulb_fill,
              size: 20,
              color: PsychologyColors.warning,
            ),
          ),
          const SizedBox(width: PsychologySpacing.md + 2),
          Expanded(
            child: Text(
              insight,
              style: PsychologyTypography.bodySmall.copyWith(
                color: PsychologyColors.textPrimary.withValues(alpha: 0.8),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildCategoryInsight(BuildContext context) {
    return Container(
      width: double.infinity,
      padding: EdgeInsets.symmetric(
        horizontal: PsychologySpacing.lg,
        vertical: PsychologySpacing.md + 2,
      ),
      decoration: BoxDecoration(
        color: PsychologyColors.infoSubtle,
        borderRadius: BorderRadius.circular(PsychologyRadius.md + 2),
        border: Border.all(
          color: PsychologyColors.info.withValues(alpha: 0.2),
        ),
      ),
      child: Row(
        children: [
          const Icon(
            CupertinoIcons.chart_bar_fill,
            size: 18,
            color: PsychologyColors.info,
          ),
          const SizedBox(width: PsychologySpacing.md),
          Expanded(
            child: Text(
              widget.categoryInsight!,
              style: PsychologyTypography.bodySmall.copyWith(
                fontWeight: FontWeight.w500,
                color: PsychologyColors.info,
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildCurrencyAlternatives(
    BuildContext context,
    AppLocalizations l10n,
  ) {
    if (widget.amount == null || widget.exchangeRates == null) {
      return const SizedBox.shrink();
    }

    final currencyCode = widget.amountCurrencyCode ?? 'TRY';
    double amountInTRY;

    if (currencyCode == 'TRY') {
      amountInTRY = widget.amount!;
    } else if (currencyCode == 'USD') {
      amountInTRY = widget.amount! * widget.exchangeRates!.usdRate;
    } else if (currencyCode == 'EUR') {
      amountInTRY = widget.amount! * widget.exchangeRates!.eurRate;
    } else if (currencyCode == 'GBP') {
      amountInTRY = widget.amount! * (widget.exchangeRates!.usdRate * 1.27);
    } else if (currencyCode == 'SAR') {
      amountInTRY = widget.amount! * (widget.exchangeRates!.usdRate / 3.75);
    } else {
      amountInTRY = widget.amount!;
    }

    final usdAmount = amountInTRY / widget.exchangeRates!.usdRate;
    final eurAmount = amountInTRY / widget.exchangeRates!.eurRate;
    final goldGrams = amountInTRY / widget.exchangeRates!.goldRate;

    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(PsychologySpacing.lg),
      decoration: BoxDecoration(
        color: PsychologyColors.glassFill,
        borderRadius: BorderRadius.circular(PsychologyRadius.lg),
        border: Border.all(
          color: PsychologyColors.glassBorder,
        ),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(
                CupertinoIcons.arrow_right_arrow_left,
                size: 14,
                color: PsychologyColors.textTertiary,
              ),
              const SizedBox(width: PsychologySpacing.sm),
              Expanded(
                child: Text(
                  l10n.withThisAmountYouCouldBuy(
                    _formatCurrency(widget.amount!, decimals: 2),
                  ),
                  style: PsychologyTypography.labelSmall.copyWith(
                    fontWeight: FontWeight.w500,
                    color: PsychologyColors.textTertiary,
                  ),
                  maxLines: 2,
                  overflow: TextOverflow.ellipsis,
                ),
              ),
            ],
          ),
          const SizedBox(height: PsychologySpacing.md + 2),
          Wrap(
            spacing: PsychologySpacing.xl,
            runSpacing: PsychologySpacing.sm + 2,
            children: [
              _buildCurrencyChip(
                icon: CupertinoIcons.money_dollar,
                value: '${_formatCurrency(usdAmount)} USD',
                color: PsychologyColors.success,
              ),
              _buildCurrencyChip(
                icon: CupertinoIcons.money_euro,
                value: '${_formatCurrency(eurAmount)} EUR',
                color: PsychologyColors.info,
              ),
              _buildCurrencyChip(
                icon: CupertinoIcons.circle_fill,
                value: l10n.goldGrams(_formatCurrency(goldGrams, decimals: 1)),
                color: PsychologyColors.warning,
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildCurrencyChip({
    required IconData icon,
    required String value,
    required Color color,
  }) {
    return Row(
      mainAxisSize: MainAxisSize.min,
      children: [
        Icon(icon, size: 14, color: color),
        const SizedBox(width: PsychologySpacing.sm - 2),
        Text(
          value,
          style: PsychologyTypography.bodySmall.copyWith(
            fontWeight: FontWeight.w600,
            color: PsychologyColors.textPrimary.withValues(alpha: 0.8),
          ),
        ),
      ],
    );
  }
}


--- FILE: lib/widgets/debug_menu.dart ---

import 'dart:io';
import 'package:flutter/cupertino.dart';
import 'package:flutter/foundation.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:shared_preferences/shared_preferences.dart';
import '../services/services.dart';
import '../theme/theme.dart';

/// Task 90: Debug Menu
/// Developer-only menu for testing and debugging
/// Only visible in debug mode or when unlocked via secret gesture
class DebugMenu extends StatefulWidget {
  const DebugMenu({super.key});

  /// Show debug menu via bottom sheet
  static Future<void> show(BuildContext context) async {
    // Only allow in debug mode
    if (!kDebugMode) return;

    await showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => const DebugMenu(),
    );
  }

  /// Check if debug menu should be enabled
  static bool get isEnabled => kDebugMode;

  @override
  State<DebugMenu> createState() => _DebugMenuState();
}

class _DebugMenuState extends State<DebugMenu> {
  final _streakService = StreakService();
  final _notificationService = NotificationService();

  Map<String, dynamic> _stats = {};
  bool _loading = true;

  @override
  void initState() {
    super.initState();
    _loadStats();
  }

  Future<void> _loadStats() async {
    final prefs = await SharedPreferences.getInstance();
    final streakData = await _streakService.getStreakData();

    setState(() {
      _stats = {
        'Current Streak': streakData.currentStreak,
        'Longest Streak': streakData.longestStreak,
        'Is Stale': streakData.isStale,
        'Platform': Platform.operatingSystem,
        'Debug Mode': kDebugMode,
        'Prefs Keys': prefs.getKeys().length,
      };
      _loading = false;
    });
  }

  @override
  Widget build(BuildContext context) {
    return Container(
      margin: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: BorderRadius.circular(24),
      ),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          // Handle
          Container(
            margin: const EdgeInsets.only(top: 12),
            width: 40,
            height: 4,
            decoration: BoxDecoration(
              color: context.appColors.textTertiary,
              borderRadius: BorderRadius.circular(2),
            ),
          ),
          // Header
          Padding(
            padding: const EdgeInsets.all(16),
            child: Row(
              children: [
                Icon(
                  CupertinoIcons.ant,
                  color: context.appColors.warning,
                ),
                const SizedBox(width: 12),
                Text(
                  'Debug Menu',
                  style: TextStyle(
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                    color: context.appColors.textPrimary,
                  ),
                ),
                const Spacer(),
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                  decoration: BoxDecoration(
                    color: context.appColors.warning.withValues(alpha: 0.2),
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Text(
                    'DEV ONLY',
                    style: TextStyle(
                      fontSize: 10,
                      fontWeight: FontWeight.bold,
                      color: context.appColors.warning,
                    ),
                  ),
                ),
              ],
            ),
          ),
          const Divider(height: 1),

          // Stats section
          if (_loading)
            const Padding(
              padding: EdgeInsets.all(32),
              child: CircularProgressIndicator(),
            )
          else
            ListView(
              shrinkWrap: true,
              physics: const NeverScrollableScrollPhysics(),
              children: [
                _buildSection('App Stats', [
                  ..._stats.entries.map((e) => _buildStatRow(e.key, e.value.toString())),
                ]),
                _buildSection('Quick Actions', [
                  _buildActionButton(
                    'Reset Streak',
                    CupertinoIcons.arrow_counterclockwise,
                    () async {
                      await _streakService.resetAllStreakData();
                      HapticFeedback.heavyImpact();
                      _loadStats();
                      if (mounted) {
                        ScaffoldMessenger.of(context).showSnackBar(
                          const SnackBar(content: Text('Streak reset!')),
                        );
                      }
                    },
                  ),
                  _buildActionButton(
                    'Clear Notifications',
                    CupertinoIcons.bell_slash,
                    () async {
                      await _notificationService.cancelAll();
                      HapticFeedback.mediumImpact();
                      if (mounted) {
                        ScaffoldMessenger.of(context).showSnackBar(
                          const SnackBar(content: Text('Notifications cleared!')),
                        );
                      }
                    },
                  ),
                  _buildActionButton(
                    'Test Achievement Notification',
                    CupertinoIcons.rosette,
                    () async {
                      await _notificationService.showAchievementUnlocked(
                        achievementTitle: 'Test Achievement',
                        achievementDescription: 'This is a test notification',
                      );
                      HapticFeedback.lightImpact();
                    },
                  ),
                  _buildActionButton(
                    'Clear SharedPreferences',
                    CupertinoIcons.trash,
                    () async {
                      final confirmed = await _showConfirmDialog(
                        context,
                        'Clear All Data?',
                        'This will reset all app data. Are you sure?',
                      );
                      if (confirmed == true) {
                        final prefs = await SharedPreferences.getInstance();
                        await prefs.clear();
                        HapticFeedback.heavyImpact();
                        _loadStats();
                        if (mounted) {
                          ScaffoldMessenger.of(context).showSnackBar(
                            const SnackBar(content: Text('All data cleared!')),
                          );
                        }
                      }
                    },
                    isDestructive: true,
                  ),
                ]),
              ],
            ),
          const SizedBox(height: 16),
        ],
      ),
    );
  }

  Widget _buildSection(String title, List<Widget> children) {
    return Padding(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            title,
            style: TextStyle(
              fontSize: 12,
              fontWeight: FontWeight.w600,
              color: context.appColors.textTertiary,
              letterSpacing: 1,
            ),
          ),
          const SizedBox(height: 8),
          ...children,
        ],
      ),
    );
  }

  Widget _buildStatRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 4),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(
            label,
            style: TextStyle(
              fontSize: 14,
              color: context.appColors.textSecondary,
            ),
          ),
          Text(
            value,
            style: TextStyle(
              fontSize: 14,
              fontWeight: FontWeight.w500,
              color: context.appColors.textPrimary,
              fontFamily: 'monospace',
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildActionButton(
    String label,
    IconData icon,
    VoidCallback onTap, {
    bool isDestructive = false,
  }) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 4),
      child: Material(
        color: Colors.transparent,
        child: InkWell(
          onTap: onTap,
          borderRadius: BorderRadius.circular(8),
          child: Padding(
            padding: const EdgeInsets.symmetric(vertical: 8, horizontal: 4),
            child: Row(
              children: [
                Icon(
                  icon,
                  size: 20,
                  color: isDestructive
                      ? context.appColors.error
                      : context.appColors.primary,
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: Text(
                    label,
                    style: TextStyle(
                      fontSize: 14,
                      color: isDestructive
                          ? context.appColors.error
                          : context.appColors.textPrimary,
                    ),
                  ),
                ),
                Icon(
                  CupertinoIcons.chevron_right,
                  size: 16,
                  color: context.appColors.textTertiary,
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Future<bool?> _showConfirmDialog(
    BuildContext context,
    String title,
    String message,
  ) {
    return showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: context.appColors.surface,
        title: Text(
          title,
          style: TextStyle(color: context.appColors.textPrimary),
        ),
        content: Text(
          message,
          style: TextStyle(color: context.appColors.textSecondary),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: Text(
              'Cancel',
              style: TextStyle(color: context.appColors.textSecondary),
            ),
          ),
          TextButton(
            onPressed: () => Navigator.pop(context, true),
            child: Text(
              'Confirm',
              style: TextStyle(color: context.appColors.error),
            ),
          ),
        ],
      ),
    );
  }
}

/// Secret tap gesture to unlock debug menu
/// Wrap around any widget to enable debug menu access
class DebugMenuTrigger extends StatefulWidget {
  final Widget child;
  final int requiredTaps;

  const DebugMenuTrigger({
    super.key,
    required this.child,
    this.requiredTaps = 7,
  });

  @override
  State<DebugMenuTrigger> createState() => _DebugMenuTriggerState();
}

class _DebugMenuTriggerState extends State<DebugMenuTrigger> {
  int _tapCount = 0;
  DateTime? _lastTapTime;

  void _handleTap() {
    final now = DateTime.now();

    // Reset if more than 2 seconds since last tap
    if (_lastTapTime != null && now.difference(_lastTapTime!).inSeconds > 2) {
      _tapCount = 0;
    }

    _tapCount++;
    _lastTapTime = now;

    if (_tapCount >= widget.requiredTaps) {
      _tapCount = 0;
      HapticFeedback.heavyImpact();
      DebugMenu.show(context);
    }
  }

  @override
  Widget build(BuildContext context) {
    // Only wrap in debug mode
    if (!kDebugMode) return widget.child;

    return GestureDetector(
      onTap: _handleTap,
      behavior: HitTestBehavior.translucent,
      child: widget.child,
    );
  }
}


--- FILE: lib/widgets/add_expense_sheet.dart ---

import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';
import '../services/services.dart';
import '../theme/theme.dart';
import '../providers/providers.dart';
import '../utils/currency_utils.dart';
import '../utils/currency_helper.dart';
import '../utils/duplicate_checker.dart';
import 'turkish_currency_input.dart';
import 'result_card.dart';
import 'decision_buttons.dart';
import 'smart_choice_toggle.dart';
import 'redirect_savings_sheet.dart';
import 'multi_currency_pro_sheet.dart';
import 'expense_form_chips.dart';
import '../screens/voice_input_screen.dart';

/// Full Expense Entry Bottom Sheet
/// Contains: Date chips, Amount, Description (Smart Match), Category, Subcategory, Calculate button
/// Shows Result Card and Decision Buttons after calculation
class AddExpenseSheet extends StatefulWidget {
  final ExchangeRates? exchangeRates;
  final VoidCallback? onExpenseAdded;
  final Expense? existingExpense;
  final Function(Expense)? onExpenseUpdated;

  const AddExpenseSheet({
    super.key,
    this.exchangeRates,
    this.onExpenseAdded,
    this.existingExpense,
    this.onExpenseUpdated,
  });

  bool get isEditMode => existingExpense != null;

  @override
  State<AddExpenseSheet> createState() => _AddExpenseSheetState();
}

class _AddExpenseSheetState extends State<AddExpenseSheet>
    with TickerProviderStateMixin {
  final _amountController = TextEditingController();
  final _descriptionController = TextEditingController();
  final _subCategoryController = TextEditingController();
  final _subCategoryFocusNode = FocusNode();

  final _calculationService = CalculationService();
  final _insightService = InsightService();
  final _messagesService = MessagesService();
  final _subCategoryService = SubCategoryService();
  final _receiptScannerService = ReceiptScannerService();

  // State
  DateTime _selectedDate = DateTime.now();
  String? _selectedCategory;
  SubCategorySuggestions? _subCategorySuggestions;
  bool _showSubCategorySuggestions = false;
  ExpenseResult? _result;
  String? _categoryInsight;
  String? _emotionalMessage;
  Expense? _pendingExpense;

  // Currency state
  late Currency _expenseCurrency;
  late Currency _incomeCurrency;

  // Smart Match & Animations
  late AnimationController _smartMatchAnimController;
  late AnimationController _attentionAnimController;
  late Animation<double> _smartMatchScale;
  late Animation<double> _attentionPulse;
  bool _smartMatchActive = false;
  bool _categoryValidationError = false;
  bool _userManuallySelectedCategory = false;

  // Wealth Coach: Smart Choice
  double? _smartChoiceSavedFrom;

  // Gider tipi ve taksit bilgileri
  ExpenseType _expenseType = ExpenseType.single;
  bool _isMandatory = false;
  bool _showInstallmentDetails = false;

  // Receipt scanning state
  bool _isScanning = false;

  // Taksit inputları için controller'lar
  final _installmentCountController = TextEditingController();
  final _cashPriceController = TextEditingController();
  final _installmentTotalController = TextEditingController();

  // Date helpers
  DateTime get _today => DateTime.now();
  DateTime get _yesterday => _today.subtract(const Duration(days: 1));
  DateTime get _twoDaysAgo => _today.subtract(const Duration(days: 2));

  bool _isSameDay(DateTime a, DateTime b) {
    return a.year == b.year && a.month == b.month && a.day == b.day;
  }

  String? get _selectedDateChip {
    if (_isSameDay(_selectedDate, _today)) return null;
    if (_isSameDay(_selectedDate, _yesterday)) return 'yesterday';
    if (_isSameDay(_selectedDate, _twoDaysAgo)) return 'twoDaysAgo';
    return 'custom';
  }

  // Available currencies for expense entry
  static const List<String> _availableCurrencies = ['TRY', 'USD', 'EUR', 'GBP'];

  @override
  void initState() {
    super.initState();
    CategoryLearningService.initialize();
    _initCurrencies();
    _initEditMode();

    _smartMatchAnimController = AnimationController(
      duration: const Duration(milliseconds: 300),
      vsync: this,
    );
    _smartMatchScale = Tween<double>(begin: 1.0, end: 1.05).animate(
      CurvedAnimation(
        parent: _smartMatchAnimController,
        curve: Curves.easeOutBack,
      ),
    );

    _attentionAnimController = AnimationController(
      duration: const Duration(milliseconds: 800),
      vsync: this,
    );
    _attentionPulse = Tween<double>(begin: 1.0, end: 1.03).animate(
      CurvedAnimation(
        parent: _attentionAnimController,
        curve: Curves.easeInOut,
      ),
    );

    _subCategoryFocusNode.addListener(() {
      if (_subCategoryFocusNode.hasFocus) {
        setState(() => _showSubCategorySuggestions = true);
      }
    });

    _loadSubCategorySuggestions();
  }

  void _initCurrencies() {
    final financeProvider = context.read<FinanceProvider>();

    // Get income currency from user profile (default TRY)
    final userProfile = financeProvider.userProfile;
    final incomeCurrencyCode = userProfile?.incomeSources.isNotEmpty == true
        ? userProfile!.incomeSources.first.currencyCode
        : 'TRY';
    _incomeCurrency = getCurrencyByCode(incomeCurrencyCode);

    // Default expense currency is income currency
    _expenseCurrency = _incomeCurrency;
  }

  /// Pre-fill form if editing an existing expense
  void _initEditMode() {
    final expense = widget.existingExpense;
    if (expense == null) return;

    // Pre-fill amount (use original amount if available, otherwise converted amount)
    final displayAmount = expense.originalAmount ?? expense.amount;
    _amountController.text = formatTurkishCurrency(
      displayAmount,
      decimalDigits: 2,
    );

    // Pre-fill category
    _selectedCategory = expense.category;
    _userManuallySelectedCategory = true;

    // Pre-fill description/subcategory
    if (expense.subCategory != null && expense.subCategory!.isNotEmpty) {
      _subCategoryController.text = expense.subCategory!;
    }

    // Pre-fill currency
    if (expense.originalCurrency != null) {
      _expenseCurrency = getCurrencyByCode(expense.originalCurrency!);
    }

    // Pre-fill date
    _selectedDate = expense.date;

    // Pre-fill expense type and mandatory status
    _expenseType = expense.type;
    _isMandatory = expense.isMandatory;

    // Pre-fill installment details if applicable
    if (expense.type == ExpenseType.installment) {
      _showInstallmentDetails = true;
      if (expense.installmentCount != null) {
        _installmentCountController.text = expense.installmentCount.toString();
      }
      if (expense.cashPrice != null) {
        _cashPriceController.text = formatTurkishCurrency(
          expense.cashPrice!,
          decimalDigits: 2,
        );
      }
      if (expense.installmentTotal != null) {
        _installmentTotalController.text = formatTurkishCurrency(
          expense.installmentTotal!,
          decimalDigits: 2,
        );
      }
    }
  }

  @override
  void dispose() {
    _amountController.dispose();
    _descriptionController.dispose();
    _subCategoryController.dispose();
    _subCategoryFocusNode.dispose();
    _smartMatchAnimController.dispose();
    _attentionAnimController.dispose();
    // Taksit controller'ları
    _installmentCountController.dispose();
    _cashPriceController.dispose();
    _installmentTotalController.dispose();
    // Receipt scanner
    _receiptScannerService.dispose();
    super.dispose();
  }

  /// Scan receipt using camera or gallery
  Future<void> _scanReceipt({bool fromCamera = true}) async {
    final l10n = AppLocalizations.of(context);

    setState(() => _isScanning = true);

    try {
      // Pick image
      final imageFile = await _receiptScannerService.pickImage(
        fromCamera: fromCamera,
      );

      if (imageFile == null) {
        setState(() => _isScanning = false);
        return;
      }

      // Extract data from receipt
      final result = await _receiptScannerService.extractFromReceipt(imageFile);

      if (!mounted) return;

      if (result.hasAmount) {
        // Auto-fill amount
        _amountController.text = formatTurkishCurrency(
          result.amount!,
          decimalDigits: 2,
        );
        _onAmountChanged(_amountController.text);

        // Auto-fill description with merchant if available
        if (result.merchant != null && _descriptionController.text.isEmpty) {
          _descriptionController.text = result.merchant!;
        }

        // Auto-select detected currency if valid
        if (result.currency != null &&
            _availableCurrencies.contains(result.currency)) {
          setState(() {
            _expenseCurrency = getCurrencyByCode(result.currency!);
          });
        }

        haptics.success();
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(l10n.receiptScanned),
            behavior: SnackBarBehavior.floating,
            backgroundColor: context.appColors.success,
          ),
        );
      } else {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(l10n.noAmountFound),
            behavior: SnackBarBehavior.floating,
            backgroundColor: context.appColors.warning,
          ),
        );
      }
    } catch (e) {
      debugPrint('[AddExpenseSheet] Scan error: $e');
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(l10n.scanError),
            behavior: SnackBarBehavior.floating,
            backgroundColor: context.appColors.error,
          ),
        );
      }
    } finally {
      if (mounted) {
        setState(() => _isScanning = false);
      }
    }
  }

  /// Show options for camera vs gallery
  void _showScanOptions() {
    final l10n = AppLocalizations.of(context);

    showModalBottomSheet(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      backgroundColor: context.appColors.cardBackground,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      builder: (context) => SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(20),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Container(
                width: 40,
                height: 4,
                margin: const EdgeInsets.only(bottom: 16),
                decoration: BoxDecoration(
                  color: context.appColors.textTertiary,
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
              Text(
                l10n.scanReceipt,
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textPrimary,
                ),
              ),
              const SizedBox(height: 20),
              ListTile(
                leading: Container(
                  padding: const EdgeInsets.all(10),
                  decoration: BoxDecoration(
                    color: context.appColors.primary.withValues(alpha: 0.1),
                    borderRadius: BorderRadius.circular(16),
                  ),
                  child: Icon(
                    CupertinoIcons.camera,
                    color: context.appColors.primary,
                  ),
                ),
                title: Text(
                  l10n.takePhoto,
                  style: TextStyle(color: context.appColors.textPrimary),
                ),
                onTap: () {
                  Navigator.pop(context);
                  _scanReceipt(fromCamera: true);
                },
              ),
              const SizedBox(height: 8),
              ListTile(
                leading: Container(
                  padding: const EdgeInsets.all(10),
                  decoration: BoxDecoration(
                    color: context.appColors.secondary.withValues(alpha: 0.1),
                    borderRadius: BorderRadius.circular(16),
                  ),
                  child: Icon(
                    CupertinoIcons.photo,
                    color: context.appColors.secondary,
                  ),
                ),
                title: Text(
                  l10n.chooseFromGallery,
                  style: TextStyle(color: context.appColors.textPrimary),
                ),
                onTap: () {
                  Navigator.pop(context);
                  _scanReceipt(fromCamera: false);
                },
              ),
            ],
          ),
        ),
      ),
    );
  }

  Future<void> _loadSubCategorySuggestions() async {
    if (_selectedCategory == null) {
      if (mounted) setState(() => _subCategorySuggestions = null);
      return;
    }
    final suggestions = await _subCategoryService.getSuggestions(
      _selectedCategory!,
    );
    if (mounted) setState(() => _subCategorySuggestions = suggestions);
  }

  void _onDescriptionChanged(String text) {
    if (_userManuallySelectedCategory) return;

    final predicted = CategoryLearningService.predictCategory(text);
    if (predicted != null && ExpenseCategory.all.contains(predicted)) {
      setState(() {
        _selectedCategory = predicted;
        _smartMatchActive = true;
        _categoryValidationError = false;
      });

      _smartMatchAnimController.forward().then((_) {
        _smartMatchAnimController.reverse();
      });

      _loadSubCategorySuggestions();
    }
  }

  void _onCategoryManuallySelected(String? category) {
    if (category == null) return;

    setState(() {
      _selectedCategory = category;
      _userManuallySelectedCategory = true;
      _categoryValidationError = false;
      _smartMatchActive = false;
    });

    _attentionAnimController.stop();
    _attentionAnimController.reset();
    _loadSubCategorySuggestions();

    final description = _descriptionController.text.trim();
    if (description.isNotEmpty) {
      CategoryLearningService.learn(description, category);
    }
  }

  void _onAmountChanged(String text) {
    final amount = parseTurkishCurrency(text);
    final hasValidAmount = amount != null && amount > 0;

    if (hasValidAmount && _selectedCategory == null) {
      _attentionAnimController.repeat(reverse: true);
    } else {
      _attentionAnimController.stop();
      _attentionAnimController.reset();
    }
  }

  void _selectSubCategory(String subCategory) {
    _subCategoryController.text = subCategory;
    setState(() => _showSubCategorySuggestions = false);
    _subCategoryFocusNode.unfocus();
  }

  void _selectYesterday() {
    setState(() {
      _selectedDate = _yesterday;
      _result = null;
      _pendingExpense = null;
    });
  }

  void _selectTwoDaysAgo() {
    setState(() {
      _selectedDate = _twoDaysAgo;
      _result = null;
      _pendingExpense = null;
    });
  }

  void _selectToday() {
    setState(() {
      _selectedDate = _today;
      _result = null;
      _pendingExpense = null;
    });
  }

  Future<void> _showCalendarDatePicker() async {
    final l10n = AppLocalizations.of(context);
    final picked = await showDatePicker(
      context: context,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      initialDate: _selectedDate,
      firstDate: DateTime.now().subtract(const Duration(days: 365)),
      lastDate: DateTime.now(),
      helpText: l10n.selectExpenseDate,
      cancelText: l10n.cancel,
      confirmText: l10n.select,
      builder: (context, child) {
        return Theme(
          data: Theme.of(context).copyWith(
            colorScheme: ColorScheme.dark(
              primary: context.appColors.primary,
              onPrimary: context.appColors.background,
              surface: context.appColors.surface,
              onSurface: context.appColors.textPrimary,
            ),
          ),
          child: child!,
        );
      },
    );

    if (picked != null) {
      setState(() {
        _selectedDate = picked;
        _result = null;
        _pendingExpense = null;
      });
    }
  }

  String _formatDisplayDate(DateTime date, AppLocalizations l10n) {
    if (_isSameDay(date, _today)) return l10n.today;
    if (_isSameDay(date, _yesterday)) return l10n.yesterday;
    if (_isSameDay(date, _twoDaysAgo)) return l10n.twoDaysAgo;
    return '${date.day}/${date.month}/${date.year}';
  }

  void _showError(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: context.appColors.error,
        behavior: SnackBarBehavior.floating,
      ),
    );
  }

  /// Convert amount from one currency to income currency using exchange rates
  double _convertToIncomeCurrency(double amount, Currency from) {
    if (from == _incomeCurrency) return amount;

    final rates = widget.exchangeRates;
    if (rates == null) return amount; // No rates, return as-is

    final usdTry = rates.usdRate;
    final eurTry = rates.eurRate;
    final gbpTry = usdTry * 1.27; // Approximate
    final sarTry = usdTry / 3.75; // SAR pegged to USD

    // TRY value of each currency
    double getTryValue(String code) {
      switch (code) {
        case 'TRY':
          return 1.0;
        case 'USD':
          return usdTry;
        case 'EUR':
          return eurTry;
        case 'GBP':
          return gbpTry;
        case 'SAR':
          return sarTry;
        default:
          return 1.0;
      }
    }

    // Convert: from -> TRY -> incomeCurrency
    final amountInTry = amount * getTryValue(from.code);
    final incomeTryRate = getTryValue(_incomeCurrency.code);
    final result = incomeTryRate > 0 ? amountInTry / incomeTryRate : amount;

    // Debug logging for currency conversion
    debugPrint('💱 [AddExpense] _convertToIncomeCurrency:');
    debugPrint('   Input: $amount ${from.code} → ${_incomeCurrency.code}');
    debugPrint('   Rates: USD/TRY=$usdTry, EUR/TRY=$eurTry');
    debugPrint('   fromRate=${getTryValue(from.code)}, toRate=$incomeTryRate');
    debugPrint('   amountInTRY=$amountInTry, result=$result');

    return result;
  }

  Future<void> _calculate() async {
    final l10n = AppLocalizations.of(context);
    final enteredAmount = parseTurkishCurrency(_amountController.text);

    if (enteredAmount == null) {
      _showError(l10n.validationEnterAmount);
      return;
    }

    if (enteredAmount <= 0) {
      _showError(l10n.validationAmountPositive);
      return;
    }

    if (enteredAmount > 100000000) {
      _showError(l10n.validationAmountTooHigh);
      return;
    }

    if (_selectedCategory == null) {
      setState(() => _categoryValidationError = true);
      _showError(l10n.pleaseSelectCategory);
      _attentionAnimController.repeat(reverse: true);
      return;
    }

    // Taksit bilgilerini parse et
    int? installmentCount;
    double? cashPrice;
    double? installmentTotal;

    // Taksit validasyonu
    if (_expenseType == ExpenseType.installment) {
      installmentCount = int.tryParse(_installmentCountController.text);
      cashPrice = parseTurkishCurrency(_cashPriceController.text);
      installmentTotal = parseTurkishCurrency(_installmentTotalController.text);

      if (installmentCount == null || installmentCount <= 0) {
        _showError('Lütfen taksit sayısını seçin');
        return;
      }

      if (installmentTotal == null || installmentTotal <= 0) {
        _showError('Lütfen taksitli toplam fiyatı girin');
        return;
      }
    }

    // Hesaplama için kullanılacak tutar
    // Taksitli ise aylık taksit tutarını kullan (bu ayki harcama olarak)
    double amountForCalculation = enteredAmount;
    if (_expenseType == ExpenseType.installment &&
        installmentCount != null &&
        installmentCount > 0 &&
        installmentTotal != null) {
      amountForCalculation = installmentTotal / installmentCount;
    }

    // Convert to income currency if different
    final amountInIncomeCurrency = _convertToIncomeCurrency(
      amountForCalculation,
      _expenseCurrency,
    );
    final isDifferentCurrency = _expenseCurrency != _incomeCurrency;

    // Taksit bilgilerini de currency'e çevir
    final cashPriceConverted = cashPrice != null
        ? _convertToIncomeCurrency(cashPrice, _expenseCurrency)
        : null;
    final installmentTotalConverted = installmentTotal != null
        ? _convertToIncomeCurrency(installmentTotal, _expenseCurrency)
        : null;

    final financeProvider = context.read<FinanceProvider>();
    final userProfile =
        financeProvider.userProfile ??
        UserProfile(incomeSources: [], dailyHours: 8, workDaysPerWeek: 5);

    final result = _calculationService.calculateExpense(
      userProfile: userProfile,
      expenseAmount: amountInIncomeCurrency,
      month: _selectedDate.month,
      year: _selectedDate.year,
    );

    // Determine record type with new fixed thresholds
    RecordType recordType;
    if (Expense.needsSimulationDialog(amountInIncomeCurrency)) {
      // Middle range (250k-750k): ask user
      final isSimulation = await _showLargeAmountDialog();
      if (!mounted) return;
      recordType = isSimulation ? RecordType.simulation : RecordType.real;
    } else {
      // Auto-determine based on fixed thresholds
      recordType = Expense.detectRecordType(
        amountInIncomeCurrency,
        result.hoursRequired,
      );
    }

    final rawSubCat = _subCategoryController.text.trim();
    final normalizedSubCat = rawSubCat.isEmpty
        ? null
        : SubCategoryService.normalize(rawSubCat);

    final isSmartChoice =
        _smartChoiceSavedFrom != null &&
        _smartChoiceSavedFrom! > amountInIncomeCurrency;

    final expense = Expense(
      amount: amountInIncomeCurrency,
      category: _selectedCategory!,
      subCategory: normalizedSubCat,
      date: _selectedDate,
      hoursRequired: result.hoursRequired,
      daysRequired: result.daysRequired,
      recordType: recordType,
      savedFrom: _smartChoiceSavedFrom,
      isSmartChoice: isSmartChoice,
      originalAmount: isDifferentCurrency ? enteredAmount : null,
      originalCurrency: isDifferentCurrency ? _expenseCurrency.code : null,
      // Yeni fieldlar
      type: _expenseType,
      isMandatory: _isMandatory,
      installmentCount: installmentCount,
      currentInstallment: installmentCount != null ? 1 : null,
      cashPrice: cashPriceConverted,
      installmentTotal: installmentTotalConverted,
      installmentStartDate: _expenseType == ExpenseType.installment
          ? _selectedDate
          : null,
    );

    final categoryInsight = _insightService.getCategoryInsight(
      context,
      financeProvider.expenses,
      _selectedCategory!,
      _selectedDate.month,
      _selectedDate.year,
    );

    // Duygusal mesaj (zorunlu gider değilse)
    String? emotionalMessage;
    if (!_isMandatory) {
      emotionalMessage = _messagesService.getCalculationMessage(
        context,
        result.hoursRequired,
        enteredAmount,
      );
    }

    setState(() {
      _result = result;
      _pendingExpense = expense;
      _categoryInsight = categoryInsight;
      _emotionalMessage = emotionalMessage;
    });
  }

  Future<void> _onDecision(
    ExpenseDecision decision, {
    bool force = false,
  }) async {
    if (_pendingExpense == null) return;

    final amount = _pendingExpense!.amount;
    final isSimulation = _pendingExpense!.isSimulation;
    final category = _pendingExpense!.category;
    final subCategory = _pendingExpense!.subCategory;

    final financeProvider = context.read<FinanceProvider>();

    // Duplicate kontrolü (force değilse ve simülasyon değilse)
    if (!force && !isSimulation) {
      final duplicates = DuplicateChecker.findDuplicates(
        expenses: financeProvider.expenses,
        amount: amount,
        category: category,
        date: _selectedDate,
      );

      if (duplicates.isNotEmpty) {
        final match = duplicates.first;
        final shouldContinue = await _showDuplicateWarningDialog(match);
        if (!shouldContinue) return;
      }
    }

    // "Vazgeçtim" (no) decision - ADD to expense list with decision=no for stats tracking
    // This allows DecisionStats to calculate totalSaved correctly
    // Vazgeçtim = User PASSED on the purchase = Money saved = Tracked in noTotal
    if (decision == ExpenseDecision.no && !isSimulation) {
      // Add to expense list with decision=no for Total Saved stats
      final expenseWithDecision = _pendingExpense!.copyWith(
        decision: ExpenseDecision.no,
        decisionDate: DateTime.now(),
      );
      await financeProvider.addExpense(expenseWithDecision);

      // Track expense added (manual method, decision: no)
      AnalyticsService().logExpenseAdded(
        method: 'manual',
        amount: expenseWithDecision.amount,
        category: expenseWithDecision.category,
        decision: 'no',
      );

      // Calculate hours for display
      final userProfile = financeProvider.userProfile;
      final hoursRequired = userProfile != null && userProfile.hourlyRate > 0
          ? amount / userProfile.hourlyRate
          : 0.0;

      // Play victory sound and show celebration
      soundService.playVictory();
      victoryManager.showVictoryAnimation(
        context,
        amount: amount,
        hours: hoursRequired,
      );

      // Add to savings pool automatically
      final savingsPoolProvider = context.read<SavingsPoolProvider>();
      await savingsPoolProvider.addSavings(amount);

      // Show redirect savings option if user has active pursuits
      final pursuitProvider = context.read<PursuitProvider>();
      if (pursuitProvider.activePursuits.isNotEmpty) {
        // Close current sheet first
        if (mounted) Navigator.pop(context);
        widget.onExpenseAdded?.call();

        // Show redirect savings sheet after a short delay
        await Future.delayed(const Duration(milliseconds: 300));
        if (mounted) {
          final currencyProvider = context.read<CurrencyProvider>();
          await showRedirectSavingsSheet(
            context,
            amount: amount,
            currency: currencyProvider.code,
          );
        }
        return;
      }

      // Show celebration snackbar with motivational message
      final l10n = AppLocalizations.of(context);
      final message = _messagesService.getMessageForSavings(l10n);
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                Icon(CupertinoIcons.star_fill, color: Colors.white, size: 20),
                const SizedBox(width: 12),
                Expanded(child: Text(message)),
              ],
            ),
            duration: const Duration(seconds: 3),
            behavior: SnackBarBehavior.floating,
            backgroundColor: context.appColors.success,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(16),
            ),
          ),
        );
        widget.onExpenseAdded?.call();
        Navigator.pop(context);
      }
      return;
    }

    // For "yes" and "thinking" decisions - save the expense
    final expenseWithDecision = _pendingExpense!.copyWith(
      decision: decision,
      decisionDate: DateTime.now(),
    );

    await financeProvider.addExpense(expenseWithDecision);

    // Track expense added (manual method)
    AnalyticsService().logExpenseAdded(
      method: 'manual',
      amount: expenseWithDecision.amount,
      category: expenseWithDecision.category,
      decision: decision.name,
    );

    // Schedule 72h reminder for "thinking" decisions
    if (decision == ExpenseDecision.thinking && !isSimulation) {
      final currencyProvider = context.read<CurrencyProvider>();
      // Generate unique ID from expense properties
      final expenseKey =
          '${expenseWithDecision.date.millisecondsSinceEpoch}_${expenseWithDecision.amount.toInt()}';
      await NotificationService().scheduleThinkingReminder(
        expenseId: expenseKey,
        amount: amount,
        description:
            expenseWithDecision.subCategory ?? expenseWithDecision.category,
        currencySymbol: currencyProvider.currency.symbol,
      );
    }

    if (!isSimulation && subCategory != null && subCategory.isNotEmpty) {
      await _subCategoryService.addRecentSubCategory(category, subCategory);
    }

    if (!mounted) return;

    // Budget warning check (only for actual purchases)
    if (decision == ExpenseDecision.yes && !isSimulation) {
      await _checkBudgetWarning(expenseWithDecision, financeProvider.expenses);

      // Debt warning - show if pool has debt
      final savingsPoolProvider = context.read<SavingsPoolProvider>();
      if (savingsPoolProvider.hasDebt && mounted) {
        final l10n = AppLocalizations.of(context);
        final currencyProvider = context.read<CurrencyProvider>();
        final debtAmount = savingsPoolProvider.shadowDebt;
        final symbol = currencyProvider.currency.symbol;

        // Show debt warning after a short delay
        Future.delayed(const Duration(milliseconds: 500), () {
          if (mounted) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: Row(
                  children: [
                    Icon(
                      CupertinoIcons.exclamationmark_triangle_fill,
                      color: Colors.white,
                      size: 20,
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Text(
                        l10n.debtWarningOnPurchase(
                          '$symbol${debtAmount.toStringAsFixed(0)}',
                        ),
                      ),
                    ),
                  ],
                ),
                duration: const Duration(seconds: 4),
                behavior: SnackBarBehavior.floating,
                backgroundColor: context.appColors.warning,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(16),
                ),
              ),
            );
          }
        });
      }
    }

    // Smart Choice savings (when user bought but spent less than intended)
    // Example: Intended to spend 520₺, actually spent 500₺ = 20₺ savings
    if (decision == ExpenseDecision.yes &&
        expenseWithDecision.isSmartChoice &&
        expenseWithDecision.savedAmount > 0 &&
        !isSimulation) {
      final savingsPoolProvider = context.read<SavingsPoolProvider>();
      await savingsPoolProvider.addSavings(expenseWithDecision.savedAmount);
      debugPrint(
        '💰 [AddExpenseSheet] Smart Choice savings added: ${expenseWithDecision.savedAmount}',
      );
    }

    final l10n = AppLocalizations.of(context);
    final message = isSimulation
        ? l10n.simulationSaved
        : _messagesService.getMessageForSpending(l10n);

    // Play success sound for expense confirmation (yes/thinking decisions)
    if (!isSimulation && decision != ExpenseDecision.no) {
      soundService.playSuccess();
    }

    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Row(
          children: [
            Icon(
              decision == ExpenseDecision.thinking
                  ? CupertinoIcons.clock_fill
                  : CupertinoIcons.checkmark_circle_fill,
              color: Colors.white,
              size: 20,
            ),
            const SizedBox(width: 12),
            Expanded(child: Text(message)),
          ],
        ),
        duration: const Duration(seconds: 3),
        behavior: SnackBarBehavior.floating,
        backgroundColor: decision == ExpenseDecision.thinking
            ? context.appColors.warning
            : context.appColors.primary,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
      ),
    );

    // Check if we should show voice tip (after 2nd expense)
    if (!isSimulation) {
      await _checkVoiceTip();
    }

    widget.onExpenseAdded?.call();
    if (mounted) Navigator.pop(context);
  }

  /// Check if voice tip should be shown (after 2nd expense)
  Future<void> _checkVoiceTip() async {
    final prefs = await SharedPreferences.getInstance();
    final hasSeenVoiceTip = prefs.getBool('hasSeenVoiceTip') ?? false;
    final expenseCount = prefs.getInt('expenseCount') ?? 0;

    // Increment expense count
    await prefs.setInt('expenseCount', expenseCount + 1);

    // Show tip after 2nd expense (count is now 2 after increment)
    if (!hasSeenVoiceTip && expenseCount + 1 >= 2) {
      await prefs.setBool('hasSeenVoiceTip', true);

      // Show with slight delay to let snackbar appear first
      if (mounted) {
        Future.delayed(const Duration(milliseconds: 500), () {
          if (mounted) {
            _showVoiceTipDialog();
          }
        });
      }
    }
  }

  /// Show voice tip dialog
  void _showVoiceTipDialog() {
    final l10n = AppLocalizations.of(context);

    showDialog(
      context: context,
      builder: (dialogContext) => AlertDialog(
        backgroundColor: context.appColors.surface,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
        icon: Icon(
          CupertinoIcons.mic_fill,
          size: 48,
          color: context.appColors.primary,
        ),
        title: Text(
          l10n.didYouKnow,
          style: TextStyle(color: context.appColors.textPrimary),
        ),
        content: Text(
          l10n.voiceTipMessage,
          style: TextStyle(color: context.appColors.textSecondary),
          textAlign: TextAlign.center,
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(dialogContext),
            child: Text(
              l10n.gotIt,
              style: TextStyle(color: context.appColors.textSecondary),
            ),
          ),
          ElevatedButton(
            style: ElevatedButton.styleFrom(
              backgroundColor: context.appColors.primary,
              foregroundColor: Colors.white,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(8),
              ),
            ),
            onPressed: () {
              Navigator.pop(dialogContext);
              Navigator.push(
                context,
                MaterialPageRoute(builder: (_) => const VoiceInputScreen()),
              );
            },
            child: Text(l10n.tryNow),
          ),
        ],
      ),
    );
  }

  String _formatTimeAgo(Duration diff, AppLocalizations l10n) {
    if (diff.inMinutes < 1) {
      return l10n.timeAgoNow;
    } else if (diff.inMinutes < 60) {
      return l10n.timeAgoMinutes(diff.inMinutes);
    } else if (diff.inHours < 24) {
      return l10n.timeAgoHours(diff.inHours);
    } else {
      return l10n.timeAgoDays(diff.inDays);
    }
  }

  /// Show dialog to ask user if large amount (250k-750k) is real or simulation
  Future<bool> _showLargeAmountDialog() async {
    final l10n = AppLocalizations.of(context);

    final result = await showDialog<bool>(
      context: context,
      barrierDismissible: false,
      builder: (context) => AlertDialog(
        backgroundColor: context.appColors.cardBackground,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
        title: Row(
          children: [
            Icon(
              CupertinoIcons.money_dollar_circle_fill,
              color: context.appColors.primary,
              size: 24,
            ),
            const SizedBox(width: 8),
            Expanded(
              child: Text(
                l10n.largeAmountTitle,
                style: const TextStyle(
                  color: Colors.white,
                  fontSize: 18,
                  fontWeight: FontWeight.w600,
                ),
              ),
            ),
          ],
        ),
        content: Text(
          l10n.largeAmountMessage,
          style: TextStyle(
            color: context.appColors.textSecondary,
            fontSize: 14,
          ),
        ),
        actions: [
          // Real expense button
          TextButton(
            onPressed: () => Navigator.pop(context, false), // false = real
            child: Text(
              l10n.realExpenseButton,
              style: TextStyle(color: context.appColors.textSecondary),
            ),
          ),
          // Simulation button
          ElevatedButton(
            onPressed: () => Navigator.pop(context, true), // true = simulation
            style: ElevatedButton.styleFrom(
              backgroundColor: context.appColors.primary,
              foregroundColor: Colors.white,
            ),
            child: Text(l10n.simulationButton),
          ),
        ],
      ),
    );

    return result ?? false; // Default to real expense if dialog dismissed
  }

  Future<bool> _showDuplicateWarningDialog(DuplicateMatch match) async {
    final l10n = AppLocalizations.of(context);
    final timeAgoText = _formatTimeAgo(match.timeSinceEntry, l10n);
    final amountStr = match.expense.amount.toStringAsFixed(0);

    final result = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: context.appColors.cardBackground,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
        title: Row(
          children: [
            Icon(CupertinoIcons.exclamationmark_triangle_fill, color: Colors.amber, size: 24),
            const SizedBox(width: 8),
            Expanded(
              child: Text(
                l10n.warning,
                style: const TextStyle(
                  color: Colors.white,
                  fontSize: 18,
                  fontWeight: FontWeight.w600,
                ),
              ),
            ),
          ],
        ),
        content: Text(
          '${l10n.duplicateExpenseWarning}:\n\n'
          '${l10n.duplicateExpenseDetails(amountStr, ExpenseCategory.getLocalizedName(match.expense.category, l10n))}\n'
          '($timeAgoText)\n\n'
          '${l10n.addAnyway}',
          style: TextStyle(
            color: context.appColors.textSecondary,
            fontSize: 14,
          ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: Text(
              l10n.no,
              style: TextStyle(color: context.appColors.textSecondary),
            ),
          ),
          ElevatedButton(
            onPressed: () => Navigator.pop(context, true),
            style: ElevatedButton.styleFrom(
              backgroundColor: context.appColors.primary,
              foregroundColor: Colors.white,
            ),
            child: Text(l10n.yes),
          ),
        ],
      ),
    );
    return result ?? false;
  }

  void _cancelDecision() {
    setState(() {
      _result = null;
      _pendingExpense = null;
      _categoryInsight = null;
      _emotionalMessage = null;
    });
  }

  /// Check if expense affects budget and show warning
  Future<void> _checkBudgetWarning(
    Expense expense,
    List<Expense> allExpenses,
  ) async {
    final budgetProvider = context.read<CategoryBudgetProvider>();
    final l10n = AppLocalizations.of(context);
    final currencyProvider = context.read<CurrencyProvider>();

    // Update provider with latest expenses
    await budgetProvider.updateExpenses(allExpenses);

    // Check budget impact
    final budgetCheck = await budgetProvider.checkExpenseImpact(
      expense.category,
      expense.amount,
    );

    if (!budgetCheck.hasBudget || !mounted) return;

    final convertedAmount = currencyProvider.convertFromTRY(
      budgetCheck.amountOver,
    );

    if (budgetCheck.wouldExceed) {
      // Show over budget warning
      HapticFeedback.heavyImpact();
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Row(
            children: [
              Icon(CupertinoIcons.exclamationmark_triangle_fill, color: Colors.white, size: 20),
              const SizedBox(width: 10),
              Expanded(
                child: Text(
                  l10n.budgetExceededMessage(
                    ExpenseCategory.getLocalizedName(expense.category, l10n),
                    '${currencyProvider.symbol}${formatTurkishCurrency(convertedAmount, decimalDigits: 0)}',
                  ),
                ),
              ),
            ],
          ),
          backgroundColor: context.appColors.error,
          behavior: SnackBarBehavior.floating,
          duration: const Duration(seconds: 4),
          action: SnackBarAction(
            label: l10n.viewAll,
            textColor: Colors.white,
            onPressed: () {
              // Navigate to budget screen or show budget sheet
            },
          ),
        ),
      );
    } else if (budgetCheck.wouldBeNearLimit) {
      // Show near limit warning
      HapticFeedback.mediumImpact();
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Row(
            children: [
              Icon(
                CupertinoIcons.exclamationmark_circle_fill,
                color: Colors.white,
                size: 20,
              ),
              const SizedBox(width: 10),
              Expanded(
                child: Text(
                  l10n.budgetNearLimitMessage(
                    budgetCheck.percentAfter.toStringAsFixed(0),
                    ExpenseCategory.getLocalizedName(expense.category, l10n),
                  ),
                ),
              ),
            ],
          ),
          backgroundColor: context.appColors.warning,
          behavior: SnackBarBehavior.floating,
          duration: const Duration(seconds: 3),
        ),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return DraggableScrollableSheet(
      initialChildSize: 0.9,
      minChildSize: 0.5,
      maxChildSize: 0.95,
      builder: (context, scrollController) {
        return ClipRRect(
          borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
          child: BackdropFilter(
            filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
            child: Container(
              decoration: BoxDecoration(
                color: context.appColors.gradientMid,
                borderRadius: const BorderRadius.vertical(
                  top: Radius.circular(24),
                ),
                border: Border.all(
                  color: context.appColors.cardBorder,
                  width: 1,
                ),
              ),
              child: Column(
                children: [
                  // Handle bar
                  Padding(
                    padding: const EdgeInsets.only(top: 12, bottom: 8),
                    child: Container(
                      width: 40,
                      height: 4,
                      decoration: BoxDecoration(
                        color: context.appColors.textTertiary.withValues(
                          alpha: 0.5,
                        ),
                        borderRadius: BorderRadius.circular(2),
                      ),
                    ),
                  ),

                  // Header
                  Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 20),
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              widget.isEditMode
                                  ? l10n.editExpense
                                  : l10n.newExpense,
                              style: TextStyle(
                                fontSize: 22,
                                fontWeight: FontWeight.w700,
                                color: context.appColors.textPrimary,
                                letterSpacing: -0.5,
                              ),
                            ),
                            const SizedBox(height: 4),
                            Row(
                              children: [
                                Icon(
                                  CupertinoIcons.calendar,
                                  size: 14,
                                  color: context.appColors.textTertiary,
                                ),
                                const SizedBox(width: 6),
                                Text(
                                  _formatDisplayDate(_selectedDate, l10n),
                                  style: TextStyle(
                                    fontSize: 12,
                                    fontWeight: FontWeight.w500,
                                    color: context.appColors.textTertiary,
                                  ),
                                ),
                              ],
                            ),
                          ],
                        ),
                        IconButton(
                          onPressed: () => Navigator.pop(context),
                          tooltip: l10n.accessibilityCloseSheet,
                          icon: Container(
                            width: 36,
                            height: 36,
                            decoration: BoxDecoration(
                              color: context.appColors.surfaceLight,
                              shape: BoxShape.circle,
                            ),
                            child: Icon(
                              CupertinoIcons.xmark,
                              size: 20,
                              color: context.appColors.textSecondary,
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),

                  const SizedBox(height: 16),

                  // Content
                  Expanded(
                    child: SingleChildScrollView(
                      controller: scrollController,
                      padding: EdgeInsets.only(
                        left: 20,
                        right: 20,
                        bottom: MediaQuery.of(context).viewInsets.bottom + 24,
                      ),
                      child: _result == null
                          ? _buildForm(l10n)
                          : _buildResultSection(l10n),
                    ),
                  ),
                ],
              ),
            ),
          ),
        );
      },
    );
  }

  Widget _buildForm(AppLocalizations l10n) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // Date chips
        _buildDateChips(l10n),

        const SizedBox(height: 20),

        // Amount input
        _buildAmountInput(l10n),

        const SizedBox(height: 16),

        // Smart Choice Toggle
        SmartChoiceToggle(
          selectedCategory: _selectedCategory,
          currentAmount: parseTurkishCurrency(_amountController.text) ?? 0,
          onSavedFromChanged: (value) {
            setState(() => _smartChoiceSavedFrom = value);
          },
          isEnabled: _pendingExpense == null,
        ),

        const SizedBox(height: 8),

        // Zorunlu gider toggle
        _buildMandatoryToggle(),

        // Taksit bölümü
        _buildInstallmentSection(),

        const SizedBox(height: 16),

        // Description (Smart Match)
        _buildDescriptionInput(l10n),

        const SizedBox(height: 16),

        // Category
        _buildCategoryDropdown(l10n),

        const SizedBox(height: 16),

        // Subcategory
        _buildSubCategorySection(l10n),

        const SizedBox(height: 24),

        // Calculate button
        _buildCalculateButton(l10n),

        const SizedBox(height: 24),
      ],
    );
  }

  Widget _buildDateChips(AppLocalizations l10n) {
    return Row(
      children: [
        ExpenseDateChip(
          label: l10n.yesterday,
          isSelected: _selectedDateChip == 'yesterday',
          onTap: _selectYesterday,
        ),
        const SizedBox(width: 8),
        ExpenseDateChip(
          label: l10n.twoDaysAgo,
          isSelected: _selectedDateChip == 'twoDaysAgo',
          onTap: _selectTwoDaysAgo,
        ),
        const SizedBox(width: 8),
        ExpenseDateChip(
          icon: CupertinoIcons.calendar,
          label: _selectedDateChip == 'custom'
              ? '${_selectedDate.day}/${_selectedDate.month}'
              : null,
          isSelected: _selectedDateChip == 'custom',
          onTap: _showCalendarDatePicker,
        ),
        if (_selectedDateChip != null) ...[
          const Spacer(),
          GestureDetector(
            onTap: _selectToday,
            child: Text(
              l10n.today,
              style: TextStyle(
                fontSize: 12,
                color: context.appColors.primary,
                fontWeight: FontWeight.w500,
              ),
            ),
          ),
        ],
      ],
    );
  }

  Widget _buildAmountInput(AppLocalizations l10n) {
    return Container(
      padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 20),
      decoration: BoxDecoration(
        color: context.appColors.surfaceLight,
        borderRadius: BorderRadius.circular(24),
        border: Border.all(color: context.appColors.cardBorder),
      ),
      child: Column(
        children: [
          // Top row: Amount input (full width)
          TextField(
            controller: _amountController,
            autofocus: true,
            keyboardType: const TextInputType.numberWithOptions(decimal: true),
            inputFormatters: [TurkishCurrencyInputFormatter()],
            style: TextStyle(
              fontSize: 40,
              fontWeight: FontWeight.w700,
              color: context.appColors.textPrimary,
              letterSpacing: -1,
            ),
            textAlign: TextAlign.center,
            decoration: InputDecoration(
              hintText: '0,00',
              hintStyle: TextStyle(
                fontSize: 40,
                fontWeight: FontWeight.w700,
                color: context.appColors.textTertiary.withValues(alpha: 0.5),
              ),
              border: InputBorder.none,
              contentPadding: EdgeInsets.zero,
            ),
            onChanged: _onAmountChanged,
          ),
          const SizedBox(height: 12),
          // Bottom row: Currency selector (left) + Scan/Voice buttons (right)
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              // Currency dropdown (left)
              _buildCurrencyDropdown(),
              // Scan + Voice buttons (right)
              Row(
                children: [
                  _buildScanButton(l10n),
                  const SizedBox(width: 8),
                  _buildVoiceButton(l10n),
                ],
              ),
            ],
          ),
        ],
      ),
    );
  }

  /// Voice input button
  Widget _buildVoiceButton(AppLocalizations l10n) {
    return Semantics(
      label: l10n.voiceInput,
      button: true,
      child: GestureDetector(
        onTap: _openVoiceInput,
        child: Container(
          width: 44,
          height: 44,
          decoration: BoxDecoration(
            color: context.appColors.primary.withValues(alpha: 0.15),
            borderRadius: BorderRadius.circular(16),
            border: Border.all(
              color: context.appColors.primary.withValues(alpha: 0.3),
            ),
          ),
          child: Icon(
            CupertinoIcons.mic_fill,
            size: 22,
            color: context.appColors.primary,
          ),
        ),
      ),
    );
  }

  /// Open voice input screen and handle result
  Future<void> _openVoiceInput() async {
    final result = await Navigator.push<Map<String, dynamic>>(
      context,
      MaterialPageRoute(
        builder: (_) => const VoiceInputScreen(returnResult: true),
      ),
    );

    if (result != null && mounted) {
      // Auto-fill from voice result
      if (result['amount'] != null) {
        _amountController.text = formatTurkishCurrency(
          (result['amount'] as num).toDouble(),
          decimalDigits: 2,
        );
        _onAmountChanged(_amountController.text);
      }
      if (result['description'] != null &&
          (result['description'] as String).isNotEmpty) {
        _descriptionController.text = result['description'] as String;
      }
      if (result['category'] != null) {
        setState(() {
          _selectedCategory = result['category'] as String;
        });
      }
    }
  }

  /// Receipt scan button
  Widget _buildScanButton(AppLocalizations l10n) {
    return Semantics(
      label: l10n.scanReceipt,
      button: true,
      child: GestureDetector(
        onTap: _isScanning ? null : _showScanOptions,
        child: Container(
          width: 44,
          height: 44,
          decoration: BoxDecoration(
            color: context.appColors.secondary.withValues(alpha: 0.15),
            borderRadius: BorderRadius.circular(16),
            border: Border.all(
              color: context.appColors.secondary.withValues(alpha: 0.3),
            ),
          ),
          child: _isScanning
              ? Center(
                  child: SizedBox(
                    width: 20,
                    height: 20,
                    child: CircularProgressIndicator(
                      strokeWidth: 2,
                      color: context.appColors.secondary,
                    ),
                  ),
                )
              : Icon(
                  CupertinoIcons.camera,
                  size: 22,
                  color: context.appColors.secondary,
                ),
        ),
      ),
    );
  }

  Widget _buildCurrencyDropdown() {
    final isPro = context.watch<ProProvider>().isPro;

    // FREE users see locked currency display
    if (!isPro) {
      return GestureDetector(
        onTap: () => MultiCurrencyProSheet.show(context),
        child: Container(
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
          decoration: BoxDecoration(
            color: context.appColors.textTertiary.withValues(alpha: 0.1),
            borderRadius: BorderRadius.circular(16),
            border: Border.all(
              color: context.appColors.textTertiary.withValues(alpha: 0.3),
              width: 1,
            ),
          ),
          child: Row(
            mainAxisSize: MainAxisSize.min,
            children: [
              Text(
                CurrencyHelper.getDisplay(_expenseCurrency.code),
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textTertiary,
                ),
              ),
              const SizedBox(width: 6),
              Icon(
                CupertinoIcons.lock,
                size: 14,
                color: context.appColors.textTertiary,
              ),
            ],
          ),
        ),
      );
    }

    // PRO users get full dropdown
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 4),
      decoration: BoxDecoration(
        color: context.appColors.primary.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: context.appColors.primary.withValues(alpha: 0.3),
          width: 1,
        ),
      ),
      child: DropdownButtonHideUnderline(
        child: DropdownButton<String>(
          value: _expenseCurrency.code,
          icon: Icon(
            CupertinoIcons.chevron_down,
            size: 16,
            color: context.appColors.primary,
          ),
          dropdownColor: context.appColors.cardBackground,
          borderRadius: BorderRadius.circular(16),
          style: TextStyle(
            fontSize: 18,
            fontWeight: FontWeight.w600,
            color: context.appColors.primary,
          ),
          items: _availableCurrencies.map((code) {
            return DropdownMenuItem<String>(
              value: code,
              child: Text(
                CurrencyHelper.getDisplay(code),
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: _expenseCurrency.code == code
                      ? FontWeight.w600
                      : FontWeight.w400,
                  color: _expenseCurrency.code == code
                      ? context.appColors.primary
                      : context.appColors.textPrimary,
                ),
              ),
            );
          }).toList(),
          onChanged: (code) {
            if (code != null) {
              HapticFeedback.selectionClick();
              setState(() => _expenseCurrency = getCurrencyByCode(code));
            }
          },
        ),
      ),
    );
  }

  Widget _buildDescriptionInput(AppLocalizations l10n) {
    return TextField(
      controller: _descriptionController,
      keyboardType: TextInputType.text,
      enableSuggestions: true,
      autocorrect: false,
      enableIMEPersonalizedLearning: true,
      style: TextStyle(color: context.appColors.textPrimary, fontSize: 14),
      decoration: InputDecoration(
        labelText: l10n.descriptionLabel,
        labelStyle: TextStyle(
          color: context.appColors.textSecondary,
          fontSize: 14,
        ),
        hintText: l10n.descriptionHint,
        hintStyle: TextStyle(
          color: context.appColors.textTertiary,
          fontSize: 14,
        ),
        filled: true,
        fillColor: context.appColors.surface,
        contentPadding: const EdgeInsets.symmetric(
          horizontal: 16,
          vertical: 14,
        ),
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(16),
          borderSide: BorderSide(color: context.appColors.cardBorder),
        ),
        enabledBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(16),
          borderSide: BorderSide(color: context.appColors.cardBorder),
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(16),
          borderSide: BorderSide(color: context.appColors.primary, width: 1.5),
        ),
        suffixIcon: _smartMatchActive
            ? Padding(
                padding: const EdgeInsets.only(right: 8),
                child: Icon(
                  CupertinoIcons.sparkles,
                  size: 18,
                  color: context.appColors.success,
                ),
              )
            : null,
      ),
      onChanged: _onDescriptionChanged,
    );
  }

  Widget _buildCategoryDropdown(AppLocalizations l10n) {
    return AnimatedBuilder(
      animation: Listenable.merge([
        _smartMatchAnimController,
        _attentionAnimController,
      ]),
      builder: (context, child) {
        final scale = _smartMatchActive
            ? _smartMatchScale.value
            : (_categoryValidationError ? _attentionPulse.value : 1.0);
        return Transform.scale(
          scale: scale,
          child: Container(
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(16),
              boxShadow: _smartMatchActive
                  ? [
                      BoxShadow(
                        color: context.appColors.success.withValues(alpha: 0.3),
                        blurRadius: 8,
                        spreadRadius: 1,
                      ),
                    ]
                  : _categoryValidationError
                  ? [
                      BoxShadow(
                        color: context.appColors.error.withValues(alpha: 0.3),
                        blurRadius: 8,
                        spreadRadius: 1,
                      ),
                    ]
                  : null,
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                DropdownButtonFormField<String>(
                  initialValue: _selectedCategory,
                  hint: Text(
                    l10n.selectCategory,
                    style: TextStyle(
                      color: context.appColors.textTertiary,
                      fontSize: 14,
                    ),
                  ),
                  items: ExpenseCategory.all.map((category) {
                    return DropdownMenuItem(
                      value: category,
                      child: Text(
                        ExpenseCategory.getLocalizedName(category, l10n),
                      ),
                    );
                  }).toList(),
                  onChanged: _onCategoryManuallySelected,
                  decoration: InputDecoration(
                    labelText: l10n.category,
                    labelStyle: TextStyle(
                      color: _categoryValidationError
                          ? context.appColors.error
                          : context.appColors.textSecondary,
                      fontSize: 14,
                    ),
                    filled: true,
                    fillColor: context.appColors.surface,
                    contentPadding: const EdgeInsets.symmetric(
                      horizontal: 16,
                      vertical: 14,
                    ),
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(16),
                      borderSide: BorderSide(
                        color: _categoryValidationError
                            ? context.appColors.error
                            : context.appColors.cardBorder,
                      ),
                    ),
                    enabledBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(16),
                      borderSide: BorderSide(
                        color: _categoryValidationError
                            ? context.appColors.error
                            : (_smartMatchActive
                                  ? context.appColors.success
                                  : context.appColors.cardBorder),
                        width: _smartMatchActive || _categoryValidationError
                            ? 1.5
                            : 1,
                      ),
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(16),
                      borderSide: BorderSide(
                        color: context.appColors.primary,
                        width: 1.5,
                      ),
                    ),
                  ),
                  dropdownColor: context.appColors.surface,
                  style: TextStyle(
                    color: context.appColors.textPrimary,
                    fontSize: 14,
                  ),
                ),
                if (_categoryValidationError)
                  Padding(
                    padding: const EdgeInsets.only(top: 6, left: 4),
                    child: Text(
                      l10n.pleaseSelectCategory,
                      style: TextStyle(
                        fontSize: 12,
                        color: context.appColors.error,
                      ),
                    ),
                  ),
                if (_smartMatchActive && _selectedCategory != null)
                  Padding(
                    padding: const EdgeInsets.only(top: 6, left: 4),
                    child: Row(
                      children: [
                        Icon(
                          CupertinoIcons.sparkles,
                          size: 14,
                          color: context.appColors.success,
                        ),
                        const SizedBox(width: 4),
                        Text(
                          l10n.autoSelected(
                            ExpenseCategory.getLocalizedName(
                              _selectedCategory!,
                              l10n,
                            ),
                          ),
                          style: TextStyle(
                            fontSize: 12,
                            color: context.appColors.success,
                          ),
                        ),
                      ],
                    ),
                  ),
              ],
            ),
          ),
        );
      },
    );
  }

  Widget _buildSubCategorySection(AppLocalizations l10n) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        TextField(
          controller: _subCategoryController,
          focusNode: _subCategoryFocusNode,
          keyboardType: TextInputType.text,
          enableSuggestions: true,
          autocorrect: false,
          enableIMEPersonalizedLearning: true,
          textCapitalization: TextCapitalization.words,
          style: TextStyle(color: context.appColors.textPrimary, fontSize: 14),
          decoration: InputDecoration(
            hintText: l10n.subCategoryOptional,
            hintStyle: TextStyle(
              color: context.appColors.textTertiary,
              fontSize: 14,
            ),
            filled: true,
            fillColor: context.appColors.surface,
            contentPadding: const EdgeInsets.symmetric(
              horizontal: 16,
              vertical: 14,
            ),
            border: OutlineInputBorder(
              borderRadius: BorderRadius.circular(16),
              borderSide: BorderSide(color: context.appColors.cardBorder),
            ),
            enabledBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(16),
              borderSide: BorderSide(color: context.appColors.cardBorder),
            ),
            focusedBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(16),
              borderSide: BorderSide(
                color: context.appColors.primary,
                width: 1.5,
              ),
            ),
            suffixIcon: _subCategoryController.text.isNotEmpty
                ? IconButton(
                    icon: const Icon(CupertinoIcons.xmark, size: 18),
                    color: context.appColors.textTertiary,
                    onPressed: () {
                      _subCategoryController.clear();
                      setState(() {});
                    },
                  )
                : null,
          ),
          onChanged: (_) => setState(() {}),
          onTap: () => setState(() => _showSubCategorySuggestions = true),
        ),
        if (_showSubCategorySuggestions &&
            _subCategorySuggestions != null &&
            !_subCategorySuggestions!.isEmpty)
          _buildSubCategoryChips(l10n),
      ],
    );
  }

  Widget _buildSubCategoryChips(AppLocalizations l10n) {
    final suggestions = _subCategorySuggestions!;
    return Padding(
      padding: const EdgeInsets.only(top: 10),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          if (suggestions.hasRecent) ...[
            Padding(
              padding: const EdgeInsets.only(bottom: 6),
              child: Text(
                l10n.recentlyUsed,
                style: TextStyle(
                  fontSize: 11,
                  color: context.appColors.textTertiary,
                  fontWeight: FontWeight.w500,
                ),
              ),
            ),
            Wrap(
              spacing: 8,
              runSpacing: 6,
              children: suggestions.recent.map((subCat) {
                return ExpenseSubCategoryChip(
                  label: subCat,
                  isRecent: true,
                  onTap: () => _selectSubCategory(subCat),
                );
              }).toList(),
            ),
            if (suggestions.hasFixed) const SizedBox(height: 12),
          ],
          if (suggestions.hasFixed) ...[
            Padding(
              padding: const EdgeInsets.only(bottom: 6),
              child: Text(
                l10n.suggestions,
                style: TextStyle(
                  fontSize: 11,
                  color: context.appColors.textTertiary,
                  fontWeight: FontWeight.w500,
                ),
              ),
            ),
            Wrap(
              spacing: 8,
              runSpacing: 6,
              children: suggestions.fixed.map((subCat) {
                return ExpenseSubCategoryChip(
                  label: subCat,
                  isRecent: false,
                  onTap: () => _selectSubCategory(subCat),
                );
              }).toList(),
            ),
          ],
        ],
      ),
    );
  }

  Widget _buildCalculateButton(AppLocalizations l10n) {
    return SizedBox(
      width: double.infinity,
      height: 56,
      child: Container(
        decoration: BoxDecoration(
          gradient: AppGradients.primaryButton,
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            BoxShadow(
              color: context.appColors.primary.withValues(alpha: 0.3),
              blurRadius: 12,
              offset: const Offset(0, 4),
            ),
          ],
        ),
        child: ElevatedButton(
          onPressed: _calculate,
          style: ElevatedButton.styleFrom(
            backgroundColor: Colors.transparent,
            shadowColor: Colors.transparent,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(16),
            ),
          ),
          child: Row(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              const Icon(CupertinoIcons.equal_square, size: 22),
              const SizedBox(width: 10),
              Text(
                l10n.calculate,
                style: const TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.w600,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  /// Zorunlu gider toggle widget'ı
  Widget _buildMandatoryToggle() {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8),
      child: Container(
        decoration: BoxDecoration(
          color: isDark
              ? Colors.white.withValues(alpha: 0.05)
              : Colors.black.withValues(alpha: 0.03),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: _isMandatory
                ? context.appColors.info.withValues(alpha: 0.5)
                : context.appColors.cardBorder,
          ),
        ),
        child: SwitchListTile(
          title: Text(
            'Zorunlu Gider',
            style: TextStyle(
              color: context.appColors.textPrimary,
              fontWeight: _isMandatory ? FontWeight.w600 : FontWeight.normal,
            ),
          ),
          subtitle: Text(
            'Kira, fatura, kredi ödemesi gibi sabit giderler',
            style: TextStyle(
              color: context.appColors.textSecondary,
              fontSize: 12,
            ),
          ),
          secondary: Icon(
            _isMandatory
                ? CupertinoIcons.lock_fill
                : CupertinoIcons.lock_open,
            color: _isMandatory
                ? context.appColors.info
                : context.appColors.textTertiary,
          ),
          value: _isMandatory,
          onChanged: (value) => setState(() => _isMandatory = value),
          activeTrackColor: context.appColors.info,
        ),
      ),
    );
  }

  /// Taksit bölümü widget'ı
  Widget _buildInstallmentSection() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // Taksitli mi toggle
        Padding(
          padding: const EdgeInsets.symmetric(vertical: 8),
          child: Builder(
            builder: (context) {
              final isDark = Theme.of(context).brightness == Brightness.dark;
              return Container(
                decoration: BoxDecoration(
                  color: isDark
                      ? Colors.white.withValues(alpha: 0.05)
                      : Colors.black.withValues(alpha: 0.03),
                  borderRadius: BorderRadius.circular(16),
                  border: Border.all(
                    color: _expenseType == ExpenseType.installment
                        ? context.appColors.warning.withValues(alpha: 0.5)
                        : context.appColors.cardBorder,
                  ),
                ),
                child: SwitchListTile(
                  title: Text(
                    'Taksitli Alım',
                    style: TextStyle(
                      color: context.appColors.textPrimary,
                      fontWeight: _expenseType == ExpenseType.installment
                          ? FontWeight.w600
                          : FontWeight.normal,
                    ),
                  ),
                  subtitle: Text(
                    'Kredi kartı veya mağaza taksiti',
                    style: TextStyle(
                      color: context.appColors.textSecondary,
                      fontSize: 12,
                    ),
                  ),
                  secondary: Icon(
                    CupertinoIcons.creditcard,
                    color: _expenseType == ExpenseType.installment
                        ? context.appColors.warning
                        : context.appColors.textTertiary,
                  ),
                  value: _expenseType == ExpenseType.installment,
                  onChanged: (value) {
                    setState(() {
                      _expenseType = value
                          ? ExpenseType.installment
                          : ExpenseType.single;
                      _showInstallmentDetails = value;
                      // Auto-copy amount to installment total when toggle is enabled
                      if (value &&
                          _installmentTotalController.text.isEmpty &&
                          _amountController.text.isNotEmpty) {
                        _installmentTotalController.text =
                            _amountController.text;
                      }
                    });
                  },
                  activeTrackColor: context.appColors.warning,
                ),
              );
            },
          ),
        ),

        // Taksit detayları (animasyonlu açılır)
        AnimatedCrossFade(
          firstChild: const SizedBox.shrink(),
          secondChild: _buildInstallmentDetails(),
          crossFadeState: _showInstallmentDetails
              ? CrossFadeState.showSecond
              : CrossFadeState.showFirst,
          duration: const Duration(milliseconds: 300),
        ),
      ],
    );
  }

  /// Taksit detayları formu
  Widget _buildInstallmentDetails() {
    return Container(
      margin: const EdgeInsets.only(top: 8, bottom: 16),
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: context.appColors.warning.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: context.appColors.warning.withValues(alpha: 0.3),
        ),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Başlık
          Row(
            children: [
              Icon(
                CupertinoIcons.info,
                color: context.appColors.warning,
                size: 18,
              ),
              const SizedBox(width: 8),
              Text(
                'Taksit Bilgileri',
                style: TextStyle(
                  color: context.appColors.warning,
                  fontWeight: FontWeight.w600,
                ),
              ),
            ],
          ),
          const SizedBox(height: 16),

          // Peşin fiyat
          TextField(
            controller: _cashPriceController,
            keyboardType: const TextInputType.numberWithOptions(decimal: true),
            inputFormatters: [TurkishCurrencyInputFormatter()],
            style: TextStyle(color: context.appColors.textPrimary),
            decoration: InputDecoration(
              labelText: 'Peşin Fiyat',
              labelStyle: TextStyle(color: context.appColors.textSecondary),
              hintText: 'Ürünün peşin fiyatı',
              hintStyle: TextStyle(color: context.appColors.textTertiary),
              prefixText: '${_expenseCurrency.symbol} ',
              prefixStyle: TextStyle(color: context.appColors.textPrimary),
              enabledBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(8),
                borderSide: BorderSide(color: context.appColors.cardBorder),
              ),
              focusedBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(8),
                borderSide: BorderSide(color: context.appColors.warning),
              ),
              filled: true,
              fillColor: context.appColors.surface,
            ),
            onChanged: (_) => _updateInstallmentSummary(),
          ),
          const SizedBox(height: 12),

          // Taksit sayısı
          DropdownButtonFormField<int>(
            initialValue: int.tryParse(_installmentCountController.text),
            dropdownColor: context.appColors.cardBackground,
            style: TextStyle(color: context.appColors.textPrimary),
            decoration: InputDecoration(
              labelText: 'Taksit Sayısı',
              labelStyle: TextStyle(color: context.appColors.textSecondary),
              enabledBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(8),
                borderSide: BorderSide(color: context.appColors.cardBorder),
              ),
              focusedBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(8),
                borderSide: BorderSide(color: context.appColors.warning),
              ),
              filled: true,
              fillColor: context.appColors.surface,
            ),
            items: [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 18, 24, 36]
                .map(
                  (n) => DropdownMenuItem(value: n, child: Text('$n taksit')),
                )
                .toList(),
            onChanged: (value) {
              _installmentCountController.text = value?.toString() ?? '';
              _updateInstallmentSummary();
            },
          ),
          const SizedBox(height: 12),

          // Taksitli toplam fiyat
          TextField(
            controller: _installmentTotalController,
            keyboardType: const TextInputType.numberWithOptions(decimal: true),
            inputFormatters: [TurkishCurrencyInputFormatter()],
            style: TextStyle(color: context.appColors.textPrimary),
            decoration: InputDecoration(
              labelText: 'Taksitli Toplam Fiyat',
              labelStyle: TextStyle(color: context.appColors.textSecondary),
              hintText: 'Vade farkı dahil toplam',
              hintStyle: TextStyle(color: context.appColors.textTertiary),
              prefixText: '${_expenseCurrency.symbol} ',
              prefixStyle: TextStyle(color: context.appColors.textPrimary),
              enabledBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(8),
                borderSide: BorderSide(color: context.appColors.cardBorder),
              ),
              focusedBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(8),
                borderSide: BorderSide(color: context.appColors.warning),
              ),
              filled: true,
              fillColor: context.appColors.surface,
            ),
            onChanged: (_) => _updateInstallmentSummary(),
          ),

          // Özet kartı
          _buildInstallmentSummary(),
        ],
      ),
    );
  }

  /// Taksit özet kartı
  Widget _buildInstallmentSummary() {
    final cashPrice = parseTurkishCurrency(_cashPriceController.text);
    final installmentTotal = parseTurkishCurrency(
      _installmentTotalController.text,
    );
    final installmentCount = int.tryParse(_installmentCountController.text);

    // Hesaplama yapılamıyorsa boş döndür
    if (cashPrice == null ||
        installmentTotal == null ||
        installmentCount == null) {
      return const SizedBox.shrink();
    }
    if (cashPrice <= 0 || installmentTotal <= 0 || installmentCount <= 0) {
      return const SizedBox.shrink();
    }

    final interestAmount = installmentTotal - cashPrice;
    final interestRate = (interestAmount / cashPrice) * 100;
    final monthlyPayment = installmentTotal / installmentCount;

    // Saatlik ücret hesabı
    final financeProvider = context.read<FinanceProvider>();
    final hourlyRate = financeProvider.hourlyRate;
    final interestHours = hourlyRate > 0 ? interestAmount / hourlyRate : 0.0;
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return Container(
      margin: const EdgeInsets.only(top: 16),
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: isDark
            ? Colors.white.withValues(alpha: 0.05)
            : Colors.black.withValues(alpha: 0.03),
        borderRadius: BorderRadius.circular(8),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'TAKSİT ÖZETİ',
            style: TextStyle(
              color: context.appColors.warning,
              fontSize: 12,
              fontWeight: FontWeight.w600,
              letterSpacing: 1,
            ),
          ),
          const SizedBox(height: 12),

          _summaryRow(
            'Aylık taksit:',
            '${_expenseCurrency.symbol}${formatTurkishCurrency(monthlyPayment, decimalDigits: 0)}',
          ),
          _summaryRow('Taksit sayısı:', '$installmentCount ay'),
          Divider(color: context.appColors.cardBorder, height: 16),
          _summaryRow(
            'Vade farkı:',
            '${_expenseCurrency.symbol}${formatTurkishCurrency(interestAmount, decimalDigits: 0)} (%${interestRate.toStringAsFixed(1)})',
            isHighlight: true,
          ),
          if (hourlyRate > 0)
            _summaryRow(
              'Vade farkı saat olarak:',
              '${interestHours.toStringAsFixed(1)} saat',
              isHighlight: true,
            ),

          // Uyarı mesajı
          if (interestAmount > 0) ...[
            const SizedBox(height: 12),
            Container(
              padding: const EdgeInsets.all(8),
              decoration: BoxDecoration(
                color: context.appColors.error.withValues(alpha: 0.15),
                borderRadius: BorderRadius.circular(6),
              ),
              child: Row(
                children: [
                  Icon(
                    CupertinoIcons.exclamationmark_triangle_fill,
                    color: context.appColors.error,
                    size: 18,
                  ),
                  const SizedBox(width: 8),
                  Expanded(
                    child: Text(
                      'Peşin alsaydın ${interestHours.toStringAsFixed(0)} saat kazanırdın!',
                      style: TextStyle(
                        color: context.appColors.error,
                        fontSize: 12,
                        fontWeight: FontWeight.w500,
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ],
        ],
      ),
    );
  }

  Widget _summaryRow(String label, String value, {bool isHighlight = false}) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 2),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(
            label,
            style: TextStyle(
              color: context.appColors.textSecondary,
              fontSize: 13,
            ),
          ),
          Text(
            value,
            style: TextStyle(
              color: isHighlight
                  ? context.appColors.warning
                  : context.appColors.textPrimary,
              fontSize: 13,
              fontWeight: isHighlight ? FontWeight.w600 : FontWeight.normal,
            ),
          ),
        ],
      ),
    );
  }

  void _updateInstallmentSummary() {
    setState(() {});
  }

  /// Zorunlu gider için sadece Kaydet butonu
  Widget _buildMandatorySaveButton(AppLocalizations l10n) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 16),
      child: Column(
        children: [
          // Bilgi mesajı
          Container(
            padding: const EdgeInsets.all(12),
            margin: const EdgeInsets.only(bottom: 16),
            decoration: BoxDecoration(
              color: context.appColors.info.withValues(alpha: 0.1),
              borderRadius: BorderRadius.circular(8),
              border: Border.all(
                color: context.appColors.info.withValues(alpha: 0.3),
              ),
            ),
            child: Row(
              children: [
                Icon(
                  CupertinoIcons.info,
                  color: context.appColors.info,
                  size: 20,
                ),
                const SizedBox(width: 8),
                Expanded(
                  child: Text(
                    'Zorunlu gider olarak kaydedilecek',
                    style: TextStyle(
                      color: context.appColors.info,
                      fontSize: 13,
                    ),
                  ),
                ),
              ],
            ),
          ),

          // Kaydet butonu
          SizedBox(
            width: double.infinity,
            child: Container(
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  colors: [
                    context.appColors.info,
                    context.appColors.info.withValues(alpha: 0.8),
                  ],
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                ),
                borderRadius: BorderRadius.circular(16),
                boxShadow: [
                  BoxShadow(
                    color: context.appColors.info.withValues(alpha: 0.3),
                    blurRadius: 8,
                    offset: const Offset(0, 4),
                  ),
                ],
              ),
              child: ElevatedButton.icon(
                onPressed: _saveMandatoryExpense,
                icon: Icon(CupertinoIcons.checkmark, size: 20),
                label: const Text('Kaydet'),
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.transparent,
                  shadowColor: Colors.transparent,
                  foregroundColor: Colors.white,
                  padding: const EdgeInsets.symmetric(vertical: 16),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(16),
                  ),
                ),
              ),
            ),
          ),

          const SizedBox(height: 8),

          // İptal butonu
          TextButton(
            onPressed: _cancelDecision,
            child: Text(
              l10n.cancel,
              style: TextStyle(color: context.appColors.textSecondary),
            ),
          ),
        ],
      ),
    );
  }

  /// Update existing expense (edit mode)
  Future<void> _updateExpense() async {
    if (_pendingExpense == null || widget.existingExpense == null) return;

    // Create updated expense keeping the original decision
    final updatedExpense = _pendingExpense!.copyWith(
      decision: widget.existingExpense!.decision,
      decisionDate: widget.existingExpense!.decisionDate,
    );

    // Call the update callback
    widget.onExpenseUpdated?.call(updatedExpense);

    if (mounted) {
      final l10n = AppLocalizations.of(context);
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(l10n.updateExpense),
          backgroundColor: context.appColors.success,
          behavior: SnackBarBehavior.floating,
        ),
      );
      Navigator.pop(context);
    }
  }

  /// Zorunlu gideri kaydet (otomatik "yes" kararı ile)
  Future<void> _saveMandatoryExpense() async {
    if (_pendingExpense == null) return;

    // Zorunlu gider için otomatik olarak "yes" kararı ile kaydet
    final expense = _pendingExpense!.copyWith(
      decision: ExpenseDecision.yes,
      decisionDate: DateTime.now(),
    );

    final financeProvider = context.read<FinanceProvider>();
    await financeProvider.addExpense(expense);

    // Alt kategori kaydet (varsa)
    final subCategory = _subCategoryController.text.trim();
    if (subCategory.isNotEmpty && _selectedCategory != null) {
      await _subCategoryService.addRecentSubCategory(
        _selectedCategory!,
        subCategory,
      );
    }

    // Callback ve kapat
    widget.onExpenseAdded?.call();

    if (mounted) {
      soundService.playSuccess();
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: const Text('Zorunlu gider kaydedildi'),
          backgroundColor: context.appColors.info,
          behavior: SnackBarBehavior.floating,
        ),
      );
      Navigator.pop(context);
    }
  }

  Widget _buildResultSection(AppLocalizations l10n) {
    final financeProvider = context.read<FinanceProvider>();
    final userProfile = financeProvider.userProfile;

    return Column(
      children: [
        // Result Card
        ResultCard(
          result: _result!,
          categoryInsight: _isMandatory ? null : _categoryInsight,
          emotionalMessage: _emotionalMessage,
          amount: _pendingExpense?.amount,
          exchangeRates: widget.exchangeRates,
          amountCurrencyCode: _incomeCurrency.code,
          dailyHours: userProfile?.dailyHours.toDouble() ?? 8,
          workDaysPerWeek: userProfile?.workDaysPerWeek ?? 5,
        ),

        const SizedBox(height: 20),

        // Edit mode: show update button
        if (widget.isEditMode)
          _buildUpdateButton(l10n)
        // Zorunlu gider ise sadece Kaydet butonu, değilse karar butonları
        else if (_isMandatory)
          _buildMandatorySaveButton(l10n)
        else ...[
          // Decision Buttons
          DecisionButtons(onDecision: _onDecision),

          const SizedBox(height: 16),

          // Cancel Button
          Center(
            child: TextButton(
              onPressed: _cancelDecision,
              style: TextButton.styleFrom(
                foregroundColor: context.appColors.textSecondary,
                padding: const EdgeInsets.symmetric(
                  horizontal: 24,
                  vertical: 12,
                ),
              ),
              child: Text(
                l10n.cancel,
                style: const TextStyle(
                  fontSize: 14,
                  fontWeight: FontWeight.w500,
                ),
              ),
            ),
          ),
        ],

        const SizedBox(height: 24),
      ],
    );
  }

  /// Update button for edit mode
  Widget _buildUpdateButton(AppLocalizations l10n) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 16),
      child: Column(
        children: [
          // Update button
          SizedBox(
            width: double.infinity,
            child: Container(
              decoration: BoxDecoration(
                gradient: AppGradients.primaryButton,
                borderRadius: BorderRadius.circular(16),
                boxShadow: [
                  BoxShadow(
                    color: context.appColors.primary.withValues(alpha: 0.3),
                    blurRadius: 8,
                    offset: const Offset(0, 4),
                  ),
                ],
              ),
              child: ElevatedButton.icon(
                onPressed: _updateExpense,
                icon: Icon(CupertinoIcons.pencil, size: 20),
                label: Text(l10n.updateExpense),
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.transparent,
                  shadowColor: Colors.transparent,
                  foregroundColor: Colors.white,
                  padding: const EdgeInsets.symmetric(vertical: 16),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(16),
                  ),
                ),
              ),
            ),
          ),

          const SizedBox(height: 8),

          // Cancel button
          TextButton(
            onPressed: _cancelDecision,
            child: Text(
              l10n.cancel,
              style: TextStyle(color: context.appColors.textSecondary),
            ),
          ),
        ],
      ),
    );
  }
}

/// Show the AddExpenseSheet
void showAddExpenseSheet(
  BuildContext context, {
  ExchangeRates? exchangeRates,
  VoidCallback? onExpenseAdded,
  Expense? existingExpense,
  Function(Expense)? onExpenseUpdated,
}) {
  HapticFeedback.lightImpact();
  showModalBottomSheet(
    context: context,
    isScrollControlled: true,
    backgroundColor: Colors.transparent,
    barrierColor: Colors.black.withValues(alpha: 0.85),
    builder: (context) => AddExpenseSheet(
      exchangeRates: exchangeRates,
      onExpenseAdded: onExpenseAdded,
      existingExpense: existingExpense,
      onExpenseUpdated: onExpenseUpdated,
    ),
  );
}


--- FILE: lib/widgets/offline_banner.dart ---

import 'dart:async';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:vantag/l10n/app_localizations.dart';
import 'package:vantag/services/connectivity_service.dart';
import 'package:vantag/services/offline_queue_service.dart';
import 'package:vantag/theme/app_theme.dart';

/// Elegant offline banner that shows when device is not connected
class OfflineBanner extends StatefulWidget {
  final Widget child;

  const OfflineBanner({super.key, required this.child});

  @override
  State<OfflineBanner> createState() => _OfflineBannerState();
}

class _OfflineBannerState extends State<OfflineBanner>
    with SingleTickerProviderStateMixin {
  final ConnectivityService _connectivityService = ConnectivityService();
  final OfflineQueueService _offlineQueueService = OfflineQueueService();
  late AnimationController _controller;
  late Animation<double> _slideAnimation;
  late Animation<double> _opacityAnimation;

  bool _isOffline = false;
  bool _showBanner = false;
  int _pendingCount = 0;
  StreamSubscription<bool>? _subscription;

  @override
  void initState() {
    super.initState();

    _controller = AnimationController(
      duration: const Duration(milliseconds: 400),
      vsync: this,
    );

    _slideAnimation = Tween<double>(
      begin: -1.0,
      end: 0.0,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeOutCubic));

    _opacityAnimation = Tween<double>(
      begin: 0.0,
      end: 1.0,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeOut));

    _initConnectivity();
  }

  Future<void> _initConnectivity() async {
    await _connectivityService.initialize();
    await _offlineQueueService.initialize();

    _isOffline = !_connectivityService.isConnected;
    _pendingCount = _offlineQueueService.pendingCount;

    // Listen for queue changes
    _offlineQueueService.addListener(_onQueueChanged);

    if (_isOffline) {
      _showBanner = true;
      _controller.forward();
    }

    _subscription = _connectivityService.onConnectivityChanged.listen((
      isConnected,
    ) {
      if (!isConnected && !_isOffline) {
        // Just went offline
        setState(() {
          _isOffline = true;
          _showBanner = true;
        });
        _controller.forward();
      } else if (isConnected && _isOffline) {
        // Just came back online
        setState(() => _isOffline = false);
        // Show brief "Back online" message then hide
        Future.delayed(const Duration(seconds: 2), () {
          if (mounted && !_isOffline && _pendingCount == 0) {
            _controller.reverse().then((_) {
              if (mounted) {
                setState(() => _showBanner = false);
              }
            });
          }
        });
      }
    });

    if (mounted) setState(() {});
  }

  void _onQueueChanged() {
    if (mounted) {
      setState(() {
        _pendingCount = _offlineQueueService.pendingCount;
      });
    }
  }

  @override
  void dispose() {
    _subscription?.cancel();
    _offlineQueueService.removeListener(_onQueueChanged);
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Stack(
      children: [
        widget.child,
        if (_showBanner)
          Positioned(
            top: 0,
            left: 0,
            right: 0,
            child: AnimatedBuilder(
              animation: _controller,
              builder: (context, child) {
                return Transform.translate(
                  offset: Offset(0, _slideAnimation.value * 60),
                  child: Opacity(
                    opacity: _opacityAnimation.value,
                    child: _buildBanner(context),
                  ),
                );
              },
            ),
          ),
      ],
    );
  }

  Widget _buildBanner(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final isBackOnline = !_isOffline;
    final isSyncing = _offlineQueueService.isSyncing;

    // Determine message based on state
    String message;
    if (isBackOnline && isSyncing) {
      message = l10n.syncing;
    } else if (isBackOnline) {
      message = l10n.dataSynced;
    } else if (_pendingCount > 0) {
      message = l10n.pendingSync(_pendingCount);
    } else {
      message = l10n.offlineMessage;
    }

    return SafeArea(
      child: Container(
        margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
        decoration: BoxDecoration(
          gradient: LinearGradient(
            colors: isBackOnline
                ? [
                    context.appColors.success.withValues(alpha: 0.9),
                    context.appColors.success,
                  ]
                : [AppColors.error, AppColors.error.withValues(alpha: 0.9)],
          ),
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            BoxShadow(
              color:
                  (isBackOnline ? context.appColors.success : AppColors.error)
                      .withValues(alpha: 0.3),
              blurRadius: 12,
              offset: const Offset(0, 4),
            ),
          ],
        ),
        child: Row(
          children: [
            // Icon with pulse animation
            _PulsingIcon(
              icon: isSyncing
                  ? CupertinoIcons.arrow_clockwise
                  : (isBackOnline ? CupertinoIcons.wifi : CupertinoIcons.wifi_slash),
              color: Colors.white,
              isPulsing: !isBackOnline || isSyncing,
            ),
            const SizedBox(width: 12),

            // Text content
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                mainAxisSize: MainAxisSize.min,
                children: [
                  Text(
                    isBackOnline ? l10n.backOnline : l10n.noInternet,
                    style: const TextStyle(
                      color: Colors.white,
                      fontSize: 14,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  const SizedBox(height: 2),
                  Text(
                    message,
                    style: TextStyle(
                      color: Colors.white.withValues(alpha: 0.9),
                      fontSize: 12,
                    ),
                  ),
                ],
              ),
            ),

            // Status indicator
            if (!isBackOnline || _pendingCount > 0)
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                decoration: BoxDecoration(
                  color: Colors.white.withValues(alpha: 0.2),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    if (_pendingCount > 0) ...[
                      Text(
                        '$_pendingCount',
                        style: const TextStyle(
                          color: Colors.white,
                          fontSize: 10,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      const SizedBox(width: 4),
                    ],
                    Container(
                      width: 6,
                      height: 6,
                      decoration: BoxDecoration(
                        color: _pendingCount > 0 ? Colors.amber : Colors.white,
                        shape: BoxShape.circle,
                      ),
                    ),
                    const SizedBox(width: 6),
                    Text(
                      _pendingCount > 0 ? l10n.pendingLabel : l10n.offline,
                      style: const TextStyle(
                        color: Colors.white,
                        fontSize: 10,
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                  ],
                ),
              ),
          ],
        ),
      ),
    );
  }
}

/// Pulsing icon animation for offline state
class _PulsingIcon extends StatefulWidget {
  final IconData icon;
  final Color color;
  final bool isPulsing;

  const _PulsingIcon({
    required this.icon,
    required this.color,
    this.isPulsing = true,
  });

  @override
  State<_PulsingIcon> createState() => _PulsingIconState();
}

class _PulsingIconState extends State<_PulsingIcon>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _scaleAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      duration: const Duration(milliseconds: 1000),
      vsync: this,
    );

    _scaleAnimation = Tween<double>(
      begin: 1.0,
      end: 1.15,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeInOut));

    if (widget.isPulsing) {
      _controller.repeat(reverse: true);
    }
  }

  @override
  void didUpdateWidget(_PulsingIcon oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (widget.isPulsing && !_controller.isAnimating) {
      _controller.repeat(reverse: true);
    } else if (!widget.isPulsing && _controller.isAnimating) {
      _controller.stop();
      _controller.value = 0;
    }
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: _scaleAnimation,
      builder: (context, child) {
        return Transform.scale(
          scale: widget.isPulsing ? _scaleAnimation.value : 1.0,
          child: Container(
            padding: const EdgeInsets.all(8),
            decoration: BoxDecoration(
              color: Colors.white.withValues(alpha: 0.2),
              shape: BoxShape.circle,
            ),
            child: Icon(widget.icon, color: widget.color, size: 20),
          ),
        );
      },
    );
  }
}

/// Minimal offline indicator (small dot in corner)
class OfflineIndicator extends StatefulWidget {
  const OfflineIndicator({super.key});

  @override
  State<OfflineIndicator> createState() => _OfflineIndicatorState();
}

class _OfflineIndicatorState extends State<OfflineIndicator> {
  final ConnectivityService _connectivityService = ConnectivityService();
  bool _isOffline = false;
  StreamSubscription<bool>? _subscription;

  @override
  void initState() {
    super.initState();
    _initConnectivity();
  }

  Future<void> _initConnectivity() async {
    await _connectivityService.initialize();
    _isOffline = !_connectivityService.isConnected;

    _subscription = _connectivityService.onConnectivityChanged.listen((
      isConnected,
    ) {
      if (mounted) {
        setState(() => _isOffline = !isConnected);
      }
    });

    if (mounted) setState(() {});
  }

  @override
  void dispose() {
    _subscription?.cancel();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    if (!_isOffline) return const SizedBox.shrink();

    return Tooltip(
      message: AppLocalizations.of(context).noInternet,
      child: Container(
        padding: const EdgeInsets.all(4),
        decoration: BoxDecoration(
          color: AppColors.error,
          borderRadius: BorderRadius.circular(4),
        ),
        child: const Icon(CupertinoIcons.wifi_slash, color: Colors.white, size: 12),
      ),
    );
  }
}


--- FILE: lib/widgets/pool_allocation_dialog.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../theme/theme.dart';

/// The allocation choice made by user
enum PoolAllocationChoice {
  /// Use available pool + add difference from pocket
  fromPocket,

  /// Create shadow debt (pool goes negative)
  createDebt,

  /// Only transfer available amount
  availableOnly,

  /// Cancel the operation
  cancel,
}

/// The source choice when pool is in debt
enum DebtSourceChoice {
  /// One-time income - doesn't affect pool
  oneTimeIncome,

  /// From savings - pool goes more negative
  fromSavings,

  /// Cancel
  cancel,
}

/// Dialog for handling over-allocation from pool
/// Shows 3 options when user wants to add more than available
class PoolAllocationDialog extends StatelessWidget {
  final double available;
  final double requested;
  final String currencySymbol;

  const PoolAllocationDialog({
    super.key,
    required this.available,
    required this.requested,
    required this.currencySymbol,
  });

  double get difference => requested - available;

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return Dialog(
      backgroundColor: Colors.transparent,
      insetPadding: const EdgeInsets.symmetric(horizontal: 20),
      child: Container(
        decoration: BoxDecoration(
          color: context.appColors.surface,
          borderRadius: BorderRadius.circular(24),
          border: Border.all(color: context.appColors.cardBorder),
        ),
        padding: const EdgeInsets.all(24),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            // Header icon
            Container(
              width: 56,
              height: 56,
              decoration: BoxDecoration(
                color: context.appColors.warning.withValues(alpha: 0.15),
                shape: BoxShape.circle,
              ),
              child: Icon(
                CupertinoIcons.exclamationmark_triangle_fill,
                color: context.appColors.warning,
                size: 28,
              ),
            ),
            const SizedBox(height: 16),

            // Title
            Text(
              l10n.overAllocationTitle,
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.w700,
                color: context.appColors.textPrimary,
              ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 8),

            // Message
            Text(
              l10n.overAllocationMessage(
                '$currencySymbol${available.toStringAsFixed(0)}',
                '$currencySymbol${requested.toStringAsFixed(0)}',
              ),
              style: TextStyle(
                fontSize: 14,
                color: context.appColors.textSecondary,
              ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 24),

            // Option 1: From pocket
            _OptionButton(
              icon: CupertinoIcons.creditcard_fill,
              iconColor: context.appColors.success,
              title: l10n.fromMyPocket,
              subtitle: l10n.fromMyPocketDesc(
                '$currencySymbol${difference.toStringAsFixed(0)}',
              ),
              onTap: () {
                HapticFeedback.mediumImpact();
                Navigator.of(context).pop(PoolAllocationChoice.fromPocket);
              },
            ),
            const SizedBox(height: 12),

            // Option 2: Create debt
            _OptionButton(
              icon: CupertinoIcons.clock_fill,
              iconColor: context.appColors.warning,
              title: l10n.deductFromFuture,
              subtitle: l10n.deductFromFutureDesc(
                '$currencySymbol${difference.toStringAsFixed(0)}',
              ),
              onTap: () {
                HapticFeedback.mediumImpact();
                Navigator.of(context).pop(PoolAllocationChoice.createDebt);
              },
            ),
            const SizedBox(height: 12),

            // Option 3: Available only
            if (available > 0)
              _OptionButton(
                icon: CupertinoIcons.money_dollar_circle_fill,
                iconColor: context.appColors.primary,
                title: l10n.transferAvailableOnly(
                  '$currencySymbol${available.toStringAsFixed(0)}',
                ),
                subtitle: l10n.transferAvailableOnlyDesc,
                onTap: () {
                  HapticFeedback.mediumImpact();
                  Navigator.of(context).pop(PoolAllocationChoice.availableOnly);
                },
              ),

            const SizedBox(height: 16),

            // Cancel button
            TextButton(
              onPressed: () {
                HapticFeedback.lightImpact();
                Navigator.of(context).pop(PoolAllocationChoice.cancel);
              },
              child: Text(
                l10n.cancel,
                style: TextStyle(color: context.appColors.textSecondary),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

/// Dialog for choosing source when pool is in debt
class DebtSourceDialog extends StatelessWidget {
  final double debtAmount;
  final String currencySymbol;

  const DebtSourceDialog({
    super.key,
    required this.debtAmount,
    required this.currencySymbol,
  });

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return Dialog(
      backgroundColor: Colors.transparent,
      insetPadding: const EdgeInsets.symmetric(horizontal: 20),
      child: Container(
        decoration: BoxDecoration(
          color: context.appColors.surface,
          borderRadius: BorderRadius.circular(24),
          border: Border.all(color: context.appColors.cardBorder),
        ),
        padding: const EdgeInsets.all(24),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            // Header icon
            Container(
              width: 56,
              height: 56,
              decoration: BoxDecoration(
                color: context.appColors.error.withValues(alpha: 0.15),
                shape: BoxShape.circle,
              ),
              child: Icon(
                CupertinoIcons.question_circle_fill,
                color: context.appColors.error,
                size: 28,
              ),
            ),
            const SizedBox(height: 16),

            // Title
            Text(
              l10n.oneTimeIncomeTitle,
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.w700,
                color: context.appColors.textPrimary,
              ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 8),

            // Message
            Text(
              l10n.oneTimeIncomeDesc,
              style: TextStyle(
                fontSize: 14,
                color: context.appColors.textSecondary,
              ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 24),

            // Option 1: One-time income
            _OptionButton(
              icon: CupertinoIcons.sparkles,
              iconColor: context.appColors.success,
              title: l10n.oneTimeIncomeOption,
              subtitle: l10n.oneTimeIncomeOptionDesc,
              onTap: () {
                HapticFeedback.mediumImpact();
                Navigator.of(context).pop(DebtSourceChoice.oneTimeIncome);
              },
            ),
            const SizedBox(height: 12),

            // Option 2: From savings
            _OptionButton(
              icon: CupertinoIcons.money_dollar_circle_fill,
              iconColor: context.appColors.warning,
              title: l10n.fromSavingsOption,
              subtitle: l10n.fromSavingsOptionDesc,
              onTap: () {
                HapticFeedback.mediumImpact();
                Navigator.of(context).pop(DebtSourceChoice.fromSavings);
              },
            ),

            const SizedBox(height: 16),

            // Cancel button
            TextButton(
              onPressed: () {
                HapticFeedback.lightImpact();
                Navigator.of(context).pop(DebtSourceChoice.cancel);
              },
              child: Text(
                l10n.cancel,
                style: TextStyle(color: context.appColors.textSecondary),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

class _OptionButton extends StatelessWidget {
  final IconData icon;
  final Color iconColor;
  final String title;
  final String subtitle;
  final VoidCallback onTap;

  const _OptionButton({
    required this.icon,
    required this.iconColor,
    required this.title,
    required this.subtitle,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    return Material(
      color: Colors.transparent,
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(16),
        child: Container(
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: context.appColors.cardBackground,
            borderRadius: BorderRadius.circular(16),
            border: Border.all(color: context.appColors.cardBorder),
          ),
          child: Row(
            children: [
              Container(
                width: 44,
                height: 44,
                decoration: BoxDecoration(
                  color: iconColor.withValues(alpha: 0.15),
                  borderRadius: BorderRadius.circular(16),
                ),
                child: Icon(icon, color: iconColor, size: 22),
              ),
              const SizedBox(width: 14),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      title,
                      style: TextStyle(
                        fontSize: 15,
                        fontWeight: FontWeight.w600,
                        color: context.appColors.textPrimary,
                      ),
                    ),
                    const SizedBox(height: 2),
                    Text(
                      subtitle,
                      style: TextStyle(
                        fontSize: 12,
                        color: context.appColors.textSecondary,
                      ),
                    ),
                  ],
                ),
              ),
              Icon(
                CupertinoIcons.chevron_right,
                color: context.appColors.textTertiary,
                size: 18,
              ),
            ],
          ),
        ),
      ),
    );
  }
}

/// Show pool allocation dialog
Future<PoolAllocationChoice?> showPoolAllocationDialog(
  BuildContext context, {
  required double available,
  required double requested,
  required String currencySymbol,
}) {
  return showDialog<PoolAllocationChoice>(
    context: context,
    barrierColor: Colors.black.withValues(alpha: 0.85),
    builder: (context) => PoolAllocationDialog(
      available: available,
      requested: requested,
      currencySymbol: currencySymbol,
    ),
  );
}

/// Show debt source dialog
Future<DebtSourceChoice?> showDebtSourceDialog(
  BuildContext context, {
  required double debtAmount,
  required String currencySymbol,
}) {
  return showDialog<DebtSourceChoice>(
    context: context,
    barrierColor: Colors.black.withValues(alpha: 0.85),
    builder: (context) => DebtSourceDialog(
      debtAmount: debtAmount,
      currencySymbol: currencySymbol,
    ),
  );
}


--- FILE: lib/widgets/labeled_text_field.dart ---

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import '../theme/theme.dart';

class LabeledTextField extends StatelessWidget {
  final TextEditingController controller;
  final String label;
  final TextInputType? keyboardType;
  final String? hint;
  final Widget? prefix;
  final Widget? suffix;
  final bool autofocus;
  final List<TextInputFormatter>? inputFormatters;
  final ValueChanged<String>? onChanged;

  const LabeledTextField({
    super.key,
    required this.controller,
    required this.label,
    this.keyboardType,
    this.hint,
    this.prefix,
    this.suffix,
    this.autofocus = false,
    this.inputFormatters,
    this.onChanged,
  });

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: TextStyle(
            fontSize: 13,
            fontWeight: FontWeight.w500,
            color: context.appColors.textSecondary,
          ),
        ),
        const SizedBox(height: 8),
        TextField(
          controller: controller,
          keyboardType: keyboardType ?? TextInputType.text,
          autofocus: autofocus,
          inputFormatters: inputFormatters,
          onChanged: onChanged,
          enableSuggestions: true,
          autocorrect: false,
          enableIMEPersonalizedLearning: true,
          style: TextStyle(
            fontSize: 16,
            fontWeight: FontWeight.w500,
            color: context.appColors.textPrimary,
          ),
          decoration: InputDecoration(
            hintText: hint,
            prefixIcon: prefix,
            suffixIcon: suffix,
            filled: true,
            fillColor: context.appColors.surface,
            contentPadding: const EdgeInsets.symmetric(
              horizontal: 16,
              vertical: 16,
            ),
            border: OutlineInputBorder(
              borderRadius: BorderRadius.circular(16),
              borderSide: BorderSide(color: context.appColors.cardBorder),
            ),
            enabledBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(16),
              borderSide: BorderSide(color: context.appColors.cardBorder),
            ),
            focusedBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(16),
              borderSide: BorderSide(
                color: context.appColors.primary,
                width: 2,
              ),
            ),
          ),
        ),
      ],
    );
  }
}


--- FILE: lib/widgets/voice_input_button.dart ---

import 'dart:math' as math;
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../screens/voice_input_screen.dart';
import '../theme/theme.dart';
import '../theme/app_theme.dart';

/// Simple voice input button that opens VoiceInputScreen
class VoiceInputButton extends StatelessWidget {
  /// Button size
  final double size;

  /// Primary color for gradient
  final Color? primaryColor;

  /// Secondary color for gradient
  final Color? secondaryColor;

  const VoiceInputButton({
    super.key,
    this.size = 56,
    this.primaryColor,
    this.secondaryColor,
  });

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final primary = primaryColor ?? context.appColors.primary;
    final secondary = secondaryColor ?? context.appColors.secondary;

    return Semantics(
      label: l10n.voiceInput,
      button: true,
      child: GestureDetector(
        onTap: () {
          HapticFeedback.mediumImpact();
          Navigator.of(
            context,
          ).push(MaterialPageRoute(builder: (_) => const VoiceInputScreen()));
        },
        child: Container(
          width: size,
          height: size,
          decoration: BoxDecoration(
            gradient: LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: [primary, secondary],
            ),
            shape: BoxShape.circle,
            boxShadow: [
              BoxShadow(
                color: primary.withValues(alpha: 0.4),
                blurRadius: 16,
                offset: const Offset(0, 6),
              ),
            ],
          ),
          child: Center(
            child: Icon(
              CupertinoIcons.mic_fill,
              color: Colors.white,
              size: size * 0.45,
            ),
          ),
        ),
      ),
    );
  }
}

/// Compact voice button for inline use (e.g., in QuickAddSheet header)
class CompactVoiceButton extends StatelessWidget {
  /// Optional callback when voice input is complete
  /// If not provided, uses default VoiceInputScreen flow
  final VoidCallback? onTap;

  /// Button size
  final double size;

  const CompactVoiceButton({super.key, this.onTap, this.size = 40});

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    return Semantics(
      label: l10n.tapToSpeak,
      button: true,
      child: GestureDetector(
        onTap: () {
          HapticFeedback.lightImpact();
          if (onTap != null) {
            onTap!();
          } else {
            Navigator.of(
              context,
            ).push(MaterialPageRoute(builder: (_) => const VoiceInputScreen()));
          }
        },
        child: Container(
          width: size,
          height: size,
          decoration: BoxDecoration(
            gradient: LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: [context.appColors.primary, context.appColors.secondary],
            ),
            shape: BoxShape.circle,
            boxShadow: [
              BoxShadow(
                color: context.appColors.primary.withValues(alpha: 0.3),
                blurRadius: 8,
                offset: const Offset(0, 3),
              ),
            ],
          ),
          child: Center(
            child: Icon(
              CupertinoIcons.mic_fill,
              color: Colors.white,
              size: size * 0.5,
            ),
          ),
        ),
      ),
    );
  }
}

/// Animated voice button with pulse effect
class AnimatedVoiceButton extends StatefulWidget {
  final VoidCallback onTap;
  final double size;
  final bool isListening;

  const AnimatedVoiceButton({
    super.key,
    required this.onTap,
    this.size = 120,
    this.isListening = false,
  });

  @override
  State<AnimatedVoiceButton> createState() => _AnimatedVoiceButtonState();
}

class _AnimatedVoiceButtonState extends State<AnimatedVoiceButton>
    with SingleTickerProviderStateMixin {
  late AnimationController _pulseController;
  late Animation<double> _pulseAnimation;

  @override
  void initState() {
    super.initState();
    _pulseController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 1200),
    );

    _pulseAnimation = Tween<double>(begin: 1.0, end: 1.25).animate(
      CurvedAnimation(parent: _pulseController, curve: Curves.easeInOut),
    );
  }

  @override
  void didUpdateWidget(AnimatedVoiceButton oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (widget.isListening && !oldWidget.isListening) {
      _pulseController.repeat(reverse: true);
    } else if (!widget.isListening && oldWidget.isListening) {
      _pulseController.stop();
      _pulseController.reset();
    }
  }

  @override
  void dispose() {
    _pulseController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    return AnimatedBuilder(
      animation: _pulseAnimation,
      builder: (context, child) {
        final scale = widget.isListening ? _pulseAnimation.value : 1.0;
        return Transform.scale(
          scale: scale,
          child: Semantics(
            label: l10n.tapToSpeak,
            button: true,
            child: GestureDetector(
              onTap: widget.onTap,
              child: Container(
                width: widget.size,
                height: widget.size,
                decoration: BoxDecoration(
                  shape: BoxShape.circle,
                  gradient: LinearGradient(
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                    colors: widget.isListening
                        ? [AppColors.categoryBills, AppColors.dangerRedDark]
                        : [
                            context.appColors.primary,
                            context.appColors.secondary,
                          ],
                  ),
                  boxShadow: [
                    BoxShadow(
                      color:
                          (widget.isListening
                                  ? AppColors.categoryBills
                                  : context.appColors.primary)
                              .withValues(
                                alpha: widget.isListening ? 0.6 : 0.4,
                              ),
                      blurRadius: widget.isListening ? 50 : 25,
                      spreadRadius: widget.isListening ? 10 : 0,
                    ),
                  ],
                ),
                child: Center(
                  child: Icon(
                    widget.isListening
                        ? CupertinoIcons.stop_fill
                        : CupertinoIcons.mic_fill,
                    color: Colors.white,
                    size: widget.size * 0.4,
                  ),
                ),
              ),
            ),
          ),
        );
      },
    );
  }
}

/// Sound level waveform visualization
class VoiceWaveform extends StatefulWidget {
  final double soundLevel;
  final Color color;
  final double width;
  final double height;

  const VoiceWaveform({
    super.key,
    required this.soundLevel,
    this.color = AppColors.primary,
    this.width = 200,
    this.height = 60,
  });

  @override
  State<VoiceWaveform> createState() => _VoiceWaveformState();
}

class _VoiceWaveformState extends State<VoiceWaveform>
    with SingleTickerProviderStateMixin {
  late AnimationController _waveController;

  @override
  void initState() {
    super.initState();
    _waveController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 2000),
    )..repeat();
  }

  @override
  void dispose() {
    _waveController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: _waveController,
      builder: (context, child) {
        return SizedBox(
          width: widget.width,
          height: widget.height,
          child: CustomPaint(
            painter: _WaveformPainter(
              color: widget.color,
              progress: _waveController.value,
              amplitude: widget.soundLevel,
            ),
          ),
        );
      },
    );
  }
}

/// Custom painter for waveform visualization
class _WaveformPainter extends CustomPainter {
  final Color color;
  final double progress;
  final double amplitude;

  _WaveformPainter({
    required this.color,
    required this.progress,
    required this.amplitude,
  });

  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()
      ..color = color
      ..strokeWidth = 3
      ..strokeCap = StrokeCap.round
      ..style = PaintingStyle.stroke;

    const barCount = 15;
    final barWidth = size.width / (barCount * 2);
    final maxHeight = size.height * 0.85;
    final minHeight = size.height * 0.15;

    for (var i = 0; i < barCount; i++) {
      final x = barWidth + (i * barWidth * 2);

      // Create wave effect with sound level
      final wave = math.sin((i / barCount + progress) * math.pi * 2);
      final heightFactor = 0.3 + (wave + 1) / 2 * 0.7;
      final amplifiedHeight =
          minHeight +
          (maxHeight - minHeight) * heightFactor * (0.3 + amplitude * 0.7);

      final y1 = (size.height - amplifiedHeight) / 2;
      final y2 = y1 + amplifiedHeight;

      canvas.drawLine(Offset(x, y1), Offset(x, y2), paint);
    }
  }

  @override
  bool shouldRepaint(covariant _WaveformPainter oldDelegate) {
    return oldDelegate.progress != progress ||
        oldDelegate.amplitude != amplitude;
  }
}


--- FILE: lib/widgets/currency_selector.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/currency.dart';
import '../providers/currency_provider.dart';
import '../providers/finance_provider.dart';
import '../providers/pro_provider.dart';
import '../services/free_tier_service.dart';
import '../theme/theme.dart';
import 'upgrade_dialog.dart';

/// Show currency selector bottom sheet
void showCurrencySelector(BuildContext context) {
  final l10n = AppLocalizations.of(context);
  final currencyProvider = context.read<CurrencyProvider>();
  final financeProvider = context.read<FinanceProvider>();
  final proProvider = context.read<ProProvider>();
  final isPremium = proProvider.isPro;
  final freeTierService = FreeTierService();

  showModalBottomSheet(
    context: context,
    barrierColor: Colors.black.withValues(alpha: 0.85),
    backgroundColor: context.appColors.surface,
    shape: const RoundedRectangleBorder(
      borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
    ),
    builder: (context) => SafeArea(
      child: Padding(
        padding: const EdgeInsets.symmetric(vertical: 16),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            // Handle
            Container(
              width: 40,
              height: 4,
              margin: const EdgeInsets.only(bottom: 16),
              decoration: BoxDecoration(
                color: context.appColors.textTertiary,
                borderRadius: BorderRadius.circular(2),
              ),
            ),
            // Title
            Padding(
              padding: const EdgeInsets.only(bottom: 8),
              child: Text(
                l10n.selectCurrency,
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.w600,
                  color: context.appColors.textPrimary,
                ),
              ),
            ),
            // Free tier note
            if (!isPremium)
              Padding(
                padding: const EdgeInsets.fromLTRB(16, 0, 16, 12),
                child: Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 12,
                    vertical: 8,
                  ),
                  decoration: BoxDecoration(
                    color: context.appColors.warning.withValues(alpha: 0.15),
                    borderRadius: BorderRadius.circular(8),
                    border: Border.all(
                      color: context.appColors.warning.withValues(alpha: 0.3),
                    ),
                  ),
                  child: Row(
                    children: [
                      Icon(
                        CupertinoIcons.info_circle_fill,
                        size: 16,
                        color: context.appColors.warning,
                      ),
                      const SizedBox(width: 8),
                      Expanded(
                        child: Text(
                          l10n.freeUserCurrencyNote(l10n.allCurrencies),
                          style: TextStyle(
                            fontSize: 12,
                            color: context.appColors.textSecondary,
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            // Currency options
            ...supportedCurrencies.map((currency) {
              final isSelected =
                  currencyProvider.currency.code == currency.code;
              final isLocked = !freeTierService.isCurrencyAvailable(
                isPremium,
                currency.code,
              );

              return ListTile(
                leading: Text(
                  currency.flag,
                  style: const TextStyle(fontSize: 24),
                ),
                title: Row(
                  children: [
                    Text(
                      currency.code,
                      style: TextStyle(
                        color: isLocked
                            ? context.appColors.textTertiary
                            : context.appColors.textPrimary,
                        fontWeight: isSelected
                            ? FontWeight.w600
                            : FontWeight.w500,
                        fontSize: 16,
                      ),
                    ),
                    const SizedBox(width: 8),
                    Text(
                      currency.symbol,
                      style: TextStyle(
                        color: isLocked
                            ? context.appColors.textTertiary.withValues(
                                alpha: 0.5,
                              )
                            : context.appColors.textSecondary,
                        fontSize: 16,
                      ),
                    ),
                  ],
                ),
                subtitle: Text(
                  isLocked ? l10n.currencyLocked : currency.name,
                  style: TextStyle(
                    color: isLocked
                        ? context.appColors.textTertiary.withValues(alpha: 0.7)
                        : context.appColors.textTertiary,
                    fontSize: 13,
                  ),
                ),
                trailing: isLocked
                    ? Icon(
                        CupertinoIcons.lock,
                        size: 20,
                        color: context.appColors.textTertiary,
                      )
                    : isSelected
                    ? Icon(
                        CupertinoIcons.checkmark_circle_fill,
                        color: context.appColors.primary,
                      )
                    : null,
                onTap: () async {
                  if (isLocked) {
                    Navigator.pop(context);
                    UpgradeDialog.show(context, l10n.multiCurrencyPremium);
                    return;
                  }

                  Navigator.pop(context);

                  // Para birimi değiştir
                  await currencyProvider.setCurrency(currency);

                  // Gelir kaynaklarını yeni para birimine convert et
                  await _convertIncomeSources(
                    currencyProvider,
                    financeProvider,
                    currency.code,
                  );

                  HapticFeedback.lightImpact();
                },
              );
            }),
          ],
        ),
      ),
    ),
  );
}

/// Gelir kaynaklarını yeni para birimine convert et
Future<void> _convertIncomeSources(
  CurrencyProvider currencyProvider,
  FinanceProvider financeProvider,
  String targetCurrency,
) async {
  final currentSources = financeProvider.incomeSources;
  if (currentSources.isEmpty) return;

  // Önce kurların yüklü olduğundan emin ol
  if (!currencyProvider.hasRates) {
    await currencyProvider.fetchRates();
  }

  // Tüm gelir kaynaklarını convert et
  final convertedSources = currencyProvider.convertIncomeSources(
    currentSources,
    targetCurrency,
  );

  if (convertedSources != null) {
    await financeProvider.updateIncomeSourcesWithConversion(convertedSources);
  } else {
    // Conversion failed - log for debugging
    debugPrint(
      '[CurrencySelector] Income conversion failed - rates not available',
    );
  }
}


--- FILE: lib/widgets/smart_choice_toggle.dart ---

import 'dart:ui';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter/cupertino.dart';
import '../theme/theme.dart';
import '../models/models.dart';
import 'turkish_currency_input.dart';
import 'package:vantag/l10n/app_localizations.dart';

/// Wealth Coach: Smart Choice Toggle Widget
/// Glassmorphism tasarım ile "Aslında şunu alacaktım" seçeneği
class SmartChoiceToggle extends StatefulWidget {
  final String? selectedCategory;
  final double currentAmount;
  final ValueChanged<double?> onSavedFromChanged;
  final bool isEnabled;

  const SmartChoiceToggle({
    super.key,
    this.selectedCategory,
    required this.currentAmount,
    required this.onSavedFromChanged,
    this.isEnabled = true,
  });

  @override
  State<SmartChoiceToggle> createState() => _SmartChoiceToggleState();
}

class _SmartChoiceToggleState extends State<SmartChoiceToggle>
    with SingleTickerProviderStateMixin {
  bool _isExpanded = false;
  final _alternativeController = TextEditingController();
  late AnimationController _animController;
  late Animation<double> _expandAnimation;
  late Animation<double> _glowAnimation;

  @override
  void initState() {
    super.initState();
    _animController = AnimationController(
      duration: const Duration(milliseconds: 300),
      vsync: this,
    );
    _expandAnimation = CurvedAnimation(
      parent: _animController,
      curve: Curves.easeOutCubic,
    );
    _glowAnimation = Tween<double>(begin: 0, end: 1).animate(
      CurvedAnimation(parent: _animController, curve: Curves.easeInOut),
    );

    // Kategori değişince varsayılan öneriyi güncelle
    _updateDefaultThreshold();
  }

  @override
  void didUpdateWidget(SmartChoiceToggle oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (oldWidget.selectedCategory != widget.selectedCategory) {
      _updateDefaultThreshold();
    }

    // Form temizlendiğinde toggle'ı kapat ve sıfırla
    // currentAmount 0 olduğunda veya kategori null olduğunda
    if ((oldWidget.currentAmount > 0 && widget.currentAmount == 0) ||
        (oldWidget.selectedCategory != null &&
            widget.selectedCategory == null)) {
      if (_isExpanded) {
        _isExpanded = false;
        _animController.reverse();
        _alternativeController.clear();
        // Build sonrasında callback çağır (setState during build hatasını önler)
        WidgetsBinding.instance.addPostFrameCallback((_) {
          widget.onSavedFromChanged(null);
        });
      }
    }
  }

  void _updateDefaultThreshold() {
    if (widget.selectedCategory != null &&
        _alternativeController.text.isEmpty) {
      final defaultThreshold = CategoryThresholds.getDefault(
        widget.selectedCategory!,
      );
      // Varsayılan değeri sadece şu anki tutardan büyükse öner
      if (defaultThreshold > widget.currentAmount && widget.currentAmount > 0) {
        _alternativeController.text = formatTurkishCurrency(defaultThreshold);
      }
    }
  }

  @override
  void dispose() {
    _alternativeController.dispose();
    _animController.dispose();
    super.dispose();
  }

  void _toggle() {
    if (!widget.isEnabled) return;

    HapticFeedback.lightImpact();
    setState(() {
      _isExpanded = !_isExpanded;
    });

    if (_isExpanded) {
      _animController.forward();
      _updateDefaultThreshold();
    } else {
      _animController.reverse();
      widget.onSavedFromChanged(null);
    }
  }

  void _onAlternativeAmountChanged(String value) {
    final amount = parseTurkishCurrency(value);
    if (amount != null && amount > widget.currentAmount) {
      widget.onSavedFromChanged(amount);
      HapticFeedback.selectionClick();
    } else {
      widget.onSavedFromChanged(null);
    }
  }

  double? get _savedAmount {
    final alternativeAmount = parseTurkishCurrency(_alternativeController.text);
    if (alternativeAmount != null && alternativeAmount > widget.currentAmount) {
      return alternativeAmount - widget.currentAmount;
    }
    return null;
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: _animController,
      builder: (context, child) {
        return Container(
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(16),
            // Golden glow efekti (aktifken)
            boxShadow: _isExpanded
                ? [
                    BoxShadow(
                      color: AppColors.medalGold.withValues(
                        alpha: 0.3 * _glowAnimation.value,
                      ),
                      blurRadius: 20,
                      spreadRadius: 2,
                    ),
                  ]
                : null,
          ),
          child: ClipRRect(
            borderRadius: BorderRadius.circular(16),
            child: BackdropFilter(
              filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
              child: Container(
                decoration: BoxDecoration(
                  color: _isExpanded
                      ? AppColors.medalGold.withValues(alpha: 0.1)
                      : context.appColors.surface.withValues(alpha: 0.8),
                  borderRadius: BorderRadius.circular(16),
                  border: Border.all(
                    color: _isExpanded
                        ? AppColors.medalGold.withValues(alpha: 0.5)
                        : context.appColors.cardBorder,
                    width: 1,
                  ),
                ),
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    // Toggle Header
                    InkWell(
                      onTap: _toggle,
                      borderRadius: BorderRadius.circular(16),
                      child: Padding(
                        padding: const EdgeInsets.all(16),
                        child: Row(
                          children: [
                            // Icon
                            AnimatedContainer(
                              duration: const Duration(milliseconds: 200),
                              width: 40,
                              height: 40,
                              decoration: BoxDecoration(
                                color: _isExpanded
                                    ? AppColors.medalGold.withValues(alpha: 0.2)
                                    : context.appColors.surfaceLight,
                                borderRadius: BorderRadius.circular(16),
                              ),
                              child: Icon(
                                _isExpanded
                                    ? CupertinoIcons.arrow_down_right
                                    : CupertinoIcons.lightbulb,
                                color: _isExpanded
                                    ? AppColors.medalGold
                                    : context.appColors.textSecondary,
                                size: 22,
                              ),
                            ),
                            const SizedBox(width: 12),
                            // Text
                            Expanded(
                              child: Builder(
                                builder: (context) {
                                  final l10n = AppLocalizations.of(context);
                                  return Column(
                                    crossAxisAlignment:
                                        CrossAxisAlignment.start,
                                    children: [
                                      Text(
                                        l10n.mindfulChoice,
                                        style: TextStyle(
                                          fontSize: 14,
                                          fontWeight: FontWeight.w600,
                                          color: _isExpanded
                                              ? AppColors.medalGold
                                              : context.appColors.textPrimary,
                                        ),
                                      ),
                                      const SizedBox(height: 2),
                                      Text(
                                        _isExpanded
                                            ? l10n.mindfulChoiceExpandedDesc
                                            : l10n.mindfulChoiceCollapsedDesc,
                                        style: TextStyle(
                                          fontSize: 12,
                                          color:
                                              context.appColors.textSecondary,
                                        ),
                                      ),
                                    ],
                                  );
                                },
                              ),
                            ),
                            // Toggle indicator
                            AnimatedRotation(
                              turns: _isExpanded ? 0.5 : 0,
                              duration: const Duration(milliseconds: 200),
                              child: Icon(
                                CupertinoIcons.chevron_down,
                                color: _isExpanded
                                    ? AppColors.medalGold
                                    : context.appColors.textTertiary,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ),
                    // Expanded content
                    SizeTransition(
                      sizeFactor: _expandAnimation,
                      child: Container(
                        padding: const EdgeInsets.fromLTRB(16, 0, 16, 16),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            // Divider
                            Container(
                              height: 1,
                              color: context.appColors.cardBorder,
                            ),
                            const SizedBox(height: 16),
                            // Alternative amount input
                            Builder(
                              builder: (context) {
                                final l10n = AppLocalizations.of(context);
                                return TextField(
                                  controller: _alternativeController,
                                  keyboardType:
                                      const TextInputType.numberWithOptions(
                                        decimal: true,
                                      ),
                                  style: TextStyle(
                                    color: context.appColors.textPrimary,
                                    fontSize: 16,
                                    fontWeight: FontWeight.w600,
                                  ),
                                  decoration: InputDecoration(
                                    labelText: l10n.mindfulChoiceAmountLabel,
                                    labelStyle: TextStyle(
                                      color: context.appColors.textSecondary,
                                      fontSize: 13,
                                    ),
                                    hintText: l10n.mindfulChoiceAmountHint(
                                      formatTurkishCurrency(
                                        CategoryThresholds.getDefault(
                                          widget.selectedCategory ?? 'Diğer',
                                        ),
                                      ),
                                    ),
                                    hintStyle: TextStyle(
                                      color: context.appColors.textTertiary,
                                      fontSize: 14,
                                    ),
                                    filled: true,
                                    fillColor: context.appColors.background
                                        .withValues(alpha: 0.5),
                                    contentPadding: const EdgeInsets.symmetric(
                                      horizontal: 16,
                                      vertical: 14,
                                    ),
                                    border: OutlineInputBorder(
                                      borderRadius: BorderRadius.circular(16),
                                      borderSide: BorderSide.none,
                                    ),
                                    prefixIcon: Icon(
                                      CupertinoIcons.bag,
                                      color: context.appColors.textTertiary,
                                      size: 20,
                                    ),
                                  ),
                                  inputFormatters: [
                                    TurkishCurrencyInputFormatter(),
                                  ],
                                  onChanged: _onAlternativeAmountChanged,
                                );
                              },
                            ),
                            const SizedBox(height: 16),
                            // Freedom Preview
                            if (_savedAmount != null && _savedAmount! > 0)
                              _buildFreedomPreview(context),
                          ],
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ),
        );
      },
    );
  }

  Widget _buildFreedomPreview(BuildContext context) {
    final saved = _savedAmount!;
    final l10n = AppLocalizations.of(context);

    return Container(
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [
            AppColors.medalGold.withValues(alpha: 0.15),
            AppColors.categoryHealth.withValues(alpha: 0.15),
          ],
        ),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.medalGold.withValues(alpha: 0.3)),
      ),
      child: Row(
        children: [
          // Icon
          Container(
            width: 36,
            height: 36,
            decoration: BoxDecoration(
              color: AppColors.medalGold.withValues(alpha: 0.2),
              borderRadius: BorderRadius.circular(8),
            ),
            child: const Icon(
              CupertinoIcons.shield_lefthalf_fill,
              color: AppColors.medalGold,
              size: 20,
            ),
          ),
          const SizedBox(width: 12),
          // Info
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  l10n.mindfulChoiceSavings(
                    formatTurkishCurrency(saved, decimalDigits: 0),
                  ),
                  style: const TextStyle(
                    fontSize: 14,
                    fontWeight: FontWeight.w600,
                    color: AppColors.medalGold,
                  ),
                ),
                const SizedBox(height: 2),
                Text(
                  l10n.mindfulChoiceSavingsDesc,
                  style: TextStyle(
                    fontSize: 11,
                    color: context.appColors.textSecondary,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}


--- FILE: lib/widgets/ai_chat_sheet.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_animate/flutter_animate.dart';
import 'package:provider/provider.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';
import '../providers/finance_provider.dart';
import '../providers/currency_provider.dart';
import '../providers/pro_provider.dart';
import '../services/ai_service.dart';
import '../services/analytics_service.dart';
import '../services/free_tier_service.dart';
import '../theme/theme.dart';
import '../constants/app_limits.dart';
import '../core/theme/premium_effects.dart';
import 'upgrade_dialog.dart';

class AIChatSheet extends StatefulWidget {
  const AIChatSheet({super.key});

  @override
  State<AIChatSheet> createState() => _AIChatSheetState();
}

class _AIChatSheetState extends State<AIChatSheet> {
  final TextEditingController _controller = TextEditingController();
  final ScrollController _scrollController = ScrollController();
  final List<ChatMessage> _messages = [];
  final FreeTierService _freeTierService = FreeTierService();
  bool _isLoading = false;
  bool _showUpsell = false;

  // Dynamic AI greeting
  String _greeting = '';
  bool _greetingLoading = true;

  // Free tier chat limit (used, total)
  int _usedChats = 0;
  int _totalChats = AppLimits.freeAiChatsPerDay;

  @override
  void initState() {
    super.initState();
    _loadAIGreeting();
    _loadChatUsage();
    // Track AI Chat opened
    AnalyticsService().logAIChatUsed();
  }

  Future<void> _loadChatUsage() async {
    final (used, total) = await _freeTierService.getAiChatUsage();
    if (mounted) {
      setState(() {
        _usedChats = used;
        _totalChats = total;
      });
    }
  }

  @override
  void dispose() {
    _controller.dispose();
    _scrollController.dispose();
    super.dispose();
  }

  void _scrollToBottom() {
    Future.delayed(const Duration(milliseconds: 100), () {
      if (!mounted) return;
      if (_scrollController.hasClients) {
        _scrollController.animateTo(
          0, // reverse: true olduğu için 0 en alt
          duration: const Duration(milliseconds: 300),
          curve: Curves.easeOut,
        );
      }
    });
  }

  Future<void> _loadAIGreeting() async {
    try {
      final financeProvider = context.read<FinanceProvider>();
      final currencyProvider = context.read<CurrencyProvider>();
      final userProfile = financeProvider.userProfile;
      final expenses = financeProvider.realExpenses;

      if (userProfile == null) {
        final l10n = AppLocalizations.of(context);
        setState(() {
          _greeting = l10n.aiGreeting;
          _greetingLoading = false;
        });
        return;
      }

      // Bütçe hesapla
      final now = DateTime.now();
      final monthlySpent = expenses
          .where(
            (e) =>
                e.date.month == now.month &&
                e.date.year == now.year &&
                e.decision == ExpenseDecision.yes,
          )
          .fold(0.0, (sum, e) => sum + e.amount);
      final remaining = userProfile.monthlyIncome - monthlySpent;
      final usagePercent = userProfile.monthlyIncome > 0
          ? (monthlySpent / userProfile.monthlyIncome * 100)
          : 0;

      // Son 3 harcama
      final recentExpenses = expenses
          .where((e) => e.decision == ExpenseDecision.yes)
          .take(3)
          .map((e) => '${e.category}: ${e.amount.toStringAsFixed(0)}')
          .join(', ');

      // Get locale early for cache key
      final locale = Localizations.localeOf(context).languageCode;
      final isEnglish = locale == 'en';

      // Cache key oluştur (include language to avoid wrong language from cache)
      final cacheKey =
          '${locale}_${monthlySpent.toStringAsFixed(0)}_${remaining.toStringAsFixed(0)}_${usagePercent.toStringAsFixed(0)}';

      // Cache kontrol
      final cachedGreeting = await _getCachedGreeting(cacheKey);
      if (cachedGreeting != null) {
        if (mounted) {
          setState(() {
            _greeting = cachedGreeting;
            _greetingLoading = false;
          });
        }
        return;
      }

      // AI'dan karşılama iste
      final personality = AIService().personalityMode;
      final currency = currencyProvider.code;

      final prompt = isEnglish
          ? '''
Greet the user. You are Vantag, a finance assistant.

BUDGET:
- Income: ${userProfile.monthlyIncome.toStringAsFixed(0)} $currency
- Spent: ${monthlySpent.toStringAsFixed(0)} $currency
- Remaining: ${remaining.toStringAsFixed(0)} $currency
- Usage: ${usagePercent.toStringAsFixed(0)}%
${recentExpenses.isNotEmpty ? '- Recent: $recentExpenses' : ''}

RULES:
- ${personality == PersonalityMode.friendly ? 'Casual, use "you"' : 'Professional, formal'}
- MAX 1 sentence + 1 question
- 1 emoji max
- Can reference recent spending

EXAMPLES:
- "Coffee again? 😄 Let's chat"
- "Budget at 80%, careful! What should we do?"
- "Looking good, only 30% used. Analysis?"

ONLY write the greeting:
'''
          : '''
Kullanıcıyı karşıla. Sen Vantag, finans asistanısın.

BÜTÇE:
- Gelir: ${userProfile.monthlyIncome.toStringAsFixed(0)} $currency
- Harcanan: ${monthlySpent.toStringAsFixed(0)} $currency
- Kalan: ${remaining.toStringAsFixed(0)} $currency
- Kullanım: %${usagePercent.toStringAsFixed(0)}
${recentExpenses.isNotEmpty ? '- Son: $recentExpenses' : ''}

KURAL:
- ${personality == PersonalityMode.friendly ? 'Samimi, "sen" de' : 'Profesyonel, "siz" de'}
- MAX 1 cümle + 1 soru
- 1 emoji max
- Son harcamaya atıf yapabilirsin

ÖRNEK:
- "Kahveye yine mi daldın? 😄 Gel konuşalım"
- "Bütçe %80'de, dikkat! Ne yapalım?"
- "Çiçek gibisin, %30 kullandın. Analiz mi?"

SADECE karşılama cümlesini yaz:
''';

      final response = await AIService().getGreeting(
        prompt,
        languageCode: locale,
      );

      // Cache'e kaydet
      await _cacheGreeting(cacheKey, response);

      if (mounted) {
        setState(() {
          _greeting = response;
          _greetingLoading = false;
        });
      }
    } catch (e) {
      // Fallback
      if (mounted) {
        setState(() {
          _greeting = _getFallbackGreeting();
          _greetingLoading = false;
        });
      }
    }
  }

  // Fallback - Internet yoksa
  String _getFallbackGreeting() {
    final l10n = AppLocalizations.of(context);
    final financeProvider = context.read<FinanceProvider>();
    final userProfile = financeProvider.userProfile;
    final expenses = financeProvider.realExpenses;

    if (userProfile == null) {
      return l10n.aiGreeting;
    }

    final now = DateTime.now();
    final monthlySpent = expenses
        .where(
          (e) =>
              e.date.month == now.month &&
              e.date.year == now.year &&
              e.decision == ExpenseDecision.yes,
        )
        .fold(0.0, (sum, e) => sum + e.amount);
    final remaining = userProfile.monthlyIncome - monthlySpent;
    final usagePercent = userProfile.monthlyIncome > 0
        ? (monthlySpent / userProfile.monthlyIncome * 100)
        : 0;

    if (remaining < 0) {
      return l10n.aiFallbackOverBudget;
    } else if (usagePercent > 80) {
      return l10n.aiFallbackHighUsage;
    } else if (usagePercent > 50) {
      return l10n.aiFallbackMediumUsage;
    } else {
      return l10n.aiFallbackLowUsage;
    }
  }

  // Cache metodları (SharedPreferences ile)
  Future<String?> _getCachedGreeting(String key) async {
    final prefs = await SharedPreferences.getInstance();
    final cached = prefs.getString('ai_greeting_$key');
    final timestamp = prefs.getInt('ai_greeting_timestamp_$key') ?? 0;

    // 1 saat geçtiyse cache geçersiz
    if (DateTime.now().millisecondsSinceEpoch - timestamp > 3600000) {
      return null;
    }
    return cached;
  }

  Future<void> _cacheGreeting(String key, String greeting) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString('ai_greeting_$key', greeting);
    await prefs.setInt(
      'ai_greeting_timestamp_$key',
      DateTime.now().millisecondsSinceEpoch,
    );
  }

  void _showPaywall(BuildContext context) {
    HapticFeedback.mediumImpact();
    // Navigate to paywall
    Navigator.of(context).pushNamed('/paywall');
  }

  @override
  Widget build(BuildContext context) {
    final isPremium = context.watch<ProProvider>().isPro;
    final l10n = AppLocalizations.of(context);

    return Container(
      height: MediaQuery.of(context).size.height * 0.85,
      decoration: BoxDecoration(
        color: context.appColors.background,
        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
        border: Border.all(color: context.appColors.cardBorder),
      ),
      child: Column(
        children: [
          _buildHandle(),
          _buildHeader(),
          // Free tier remaining chats indicator
          if (!isPremium) _buildRemainingChatsIndicator(l10n),
          Expanded(child: _buildMessageList(isPremium)),
          _buildInput(isPremium),
        ],
      ),
    );
  }

  Widget _buildRemainingChatsIndicator(AppLocalizations l10n) {
    final remaining = _totalChats - _usedChats;
    final isLimitReached = remaining <= 0;
    final isLow = remaining <= 1 && !isLimitReached;

    return Container(
      margin: const EdgeInsets.symmetric(horizontal: 20, vertical: 8),
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
      decoration: BoxDecoration(
        color: isLimitReached
            ? context.appColors.error.withValues(alpha: 0.15)
            : isLow
            ? context.appColors.warning.withValues(alpha: 0.15)
            : context.appColors.primary.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(8),
        border: Border.all(
          color: isLimitReached
              ? context.appColors.error.withValues(alpha: 0.3)
              : isLow
              ? context.appColors.warning.withValues(alpha: 0.3)
              : context.appColors.primary.withValues(alpha: 0.2),
        ),
      ),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            isLimitReached
                ? CupertinoIcons.exclamationmark_triangle_fill
                : isLow
                ? CupertinoIcons.exclamationmark_triangle
                : CupertinoIcons.chat_bubble,
            size: 16,
            color: isLimitReached
                ? context.appColors.error
                : isLow
                ? context.appColors.warning
                : context.appColors.primary,
          ),
          const SizedBox(width: 8),
          Text(
            isLimitReached
                ? l10n.dailyLimitReached
                : l10n.aiChatUsageIndicator(_usedChats, _totalChats),
            style: TextStyle(
              fontSize: 13,
              fontWeight: FontWeight.w500,
              color: isLimitReached
                  ? context.appColors.error
                  : isLow
                  ? context.appColors.warning
                  : context.appColors.textSecondary,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildHandle() {
    return Container(
      margin: const EdgeInsets.symmetric(vertical: 12),
      width: 40,
      height: 4,
      decoration: BoxDecoration(
        color: context.appColors.textTertiary.withValues(alpha: 0.3),
        borderRadius: BorderRadius.circular(2),
      ),
    );
  }

  Widget _buildHeader() {
    final facts = AIService().userFacts.take(3).toList();
    final l10n = AppLocalizations.of(context);

    return Padding(
      padding: const EdgeInsets.fromLTRB(20, 0, 20, 16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Container(
                padding: const EdgeInsets.all(10),
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    colors: [
                      context.appColors.primary.withValues(alpha: 0.2),
                      context.appColors.primaryDark.withValues(alpha: 0.1),
                    ],
                  ),
                  borderRadius: BorderRadius.circular(16),
                ),
                child: Icon(
                  CupertinoIcons.sparkles,
                  size: 22,
                  color: context.appColors.primary,
                ),
              ),
              const SizedBox(width: 12),
              Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    'Vantag AI',
                    style: TextStyle(
                      fontSize: 18,
                      fontWeight: FontWeight.w600,
                      color: context.appColors.textPrimary,
                    ),
                  ),
                  Text(
                    AIService().personalityMode == PersonalityMode.friendly
                        ? l10n.friendlyMode
                        : l10n.professionalMode,
                    style: TextStyle(
                      fontSize: 12,
                      color: context.appColors.textSecondary,
                    ),
                  ),
                ],
              ),
              const Spacer(),
              // Clear history button
              Semantics(
                label: l10n.delete,
                button: true,
                child: GestureDetector(
                  onTap: () async {
                    await AIService().clearHistory();
                    setState(() {
                      _messages.clear();
                      _showUpsell = false;
                    });
                    HapticFeedback.mediumImpact();
                  },
                  child: Tooltip(
                    message: l10n.delete,
                    child: Container(
                      padding: const EdgeInsets.all(8),
                      margin: const EdgeInsets.only(right: 8),
                      decoration: BoxDecoration(
                        color: context.appColors.surfaceLight,
                        borderRadius: BorderRadius.circular(8),
                      ),
                      child: Icon(
                        CupertinoIcons.trash,
                        size: 16,
                        color: context.appColors.textTertiary,
                      ),
                    ),
                  ),
                ),
              ),
              Semantics(
                label: AIService().personalityMode == PersonalityMode.friendly
                    ? l10n.professionalMode
                    : l10n.friendlyMode,
                hint: l10n.accessibilityToggleOn,
                button: true,
                child: GestureDetector(
                  onTap: _togglePersonality,
                  child: Tooltip(
                    message:
                        AIService().personalityMode == PersonalityMode.friendly
                        ? l10n.professionalMode
                        : l10n.friendlyMode,
                    child: Container(
                      padding: const EdgeInsets.symmetric(
                        horizontal: 12,
                        vertical: 8,
                      ),
                      decoration: BoxDecoration(
                        color: context.appColors.surfaceLight,
                        borderRadius: BorderRadius.circular(8),
                        border: Border.all(color: context.appColors.cardBorder),
                      ),
                      child: Row(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          Icon(
                            AIService().personalityMode ==
                                    PersonalityMode.friendly
                                ? CupertinoIcons.smiley
                                : CupertinoIcons.briefcase,
                            size: 16,
                            color: context.appColors.primary,
                          ),
                          const SizedBox(width: 6),
                          Icon(
                            CupertinoIcons.chevron_down,
                            size: 12,
                            color: context.appColors.textSecondary,
                          ),
                        ],
                      ),
                    ),
                  ),
                ),
              ),
            ],
          ),
          if (facts.isNotEmpty) ...[
            const SizedBox(height: 14),
            Wrap(
              spacing: 8,
              runSpacing: 8,
              children: facts
                  .map(
                    (fact) => Container(
                      padding: const EdgeInsets.symmetric(
                        horizontal: 10,
                        vertical: 6,
                      ),
                      decoration: BoxDecoration(
                        color: context.appColors.primary.withValues(alpha: 0.1),
                        borderRadius: BorderRadius.circular(24),
                        border: Border.all(
                          color: context.appColors.primary.withValues(
                            alpha: 0.2,
                          ),
                        ),
                      ),
                      child: Row(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          Icon(
                            CupertinoIcons.lightbulb,
                            size: 12,
                            color: context.appColors.primary,
                          ),
                          const SizedBox(width: 6),
                          Flexible(
                            child: Text(
                              fact,
                              style: TextStyle(
                                fontSize: 11,
                                color: context.appColors.primary,
                                fontWeight: FontWeight.w500,
                              ),
                              overflow: TextOverflow.ellipsis,
                            ),
                          ),
                        ],
                      ),
                    ),
                  )
                  .toList(),
            ),
          ],
        ],
      ),
    );
  }

  Widget _buildMessageList(bool isPremium) {
    final l10n = AppLocalizations.of(context);

    if (_messages.isEmpty) {
      return SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Column(
          children: [
            const SizedBox(height: 20),
            // AI Avatar with rotating glow ring
            RotatingGradientBorder(
              size: 80,
              borderWidth: 3,
              duration: const Duration(seconds: 4),
              child: Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: PremiumColors.cardBackground,
                  shape: BoxShape.circle,
                ),
                child: Icon(
                  CupertinoIcons.sparkles,
                  size: 32,
                  color: PremiumColors.purple,
                  shadows: PremiumShadows.iconHalo(PremiumColors.purple),
                ),
              ),
            ),
            const SizedBox(height: 20),

            // Dinamik greeting
            if (_greetingLoading)
              SizedBox(
                height: 60,
                child: Column(
                  children: [
                    SizedBox(
                      width: 20,
                      height: 20,
                      child: CircularProgressIndicator(
                        strokeWidth: 2,
                        color: PremiumColors.purple,
                      ),
                    ),
                    const SizedBox(height: 8),
                    Text(
                      l10n.aiThinking,
                      style: TextStyle(
                        fontSize: 13,
                        color: context.appColors.textTertiary,
                      ),
                    ),
                  ],
                ),
              )
            else
              Text(
                _greeting,
                textAlign: TextAlign.center,
                style: TextStyle(
                  fontSize: 15,
                  color: context.appColors.textSecondary,
                  height: 1.5,
                ),
              ).animate().fadeIn(duration: 300.ms),

            const SizedBox(height: 32),

            // 4 Suggestion Buttons (for both free and premium users)
            _buildSuggestionButtons(l10n),
          ],
        ),
      );
    }

    return ListView.builder(
      controller: _scrollController,
      reverse: true,
      padding: const EdgeInsets.symmetric(horizontal: 20),
      itemCount:
          _messages.length +
          (_isLoading ? 1 : 0) +
          (_showUpsell && !isPremium ? 1 : 0),
      itemBuilder: (context, index) {
        // Loading indicator at the bottom (which is top in reverse)
        if (_isLoading && index == 0) {
          return _buildLoadingBubble();
        }

        // Upsell widget after AI response
        if (_showUpsell && !isPremium && index == (_isLoading ? 1 : 0)) {
          return _buildPremiumUpsell(context);
        }

        final adjustedIndex =
            index - (_isLoading ? 1 : 0) - (_showUpsell && !isPremium ? 1 : 0);
        if (adjustedIndex < 0 || adjustedIndex >= _messages.length) {
          return const SizedBox.shrink();
        }

        final message = _messages.reversed.toList()[adjustedIndex];
        return _buildMessageBubble(message);
      },
    );
  }

  Widget _buildSuggestionButtons(AppLocalizations l10n) {
    return Wrap(
      spacing: 8,
      runSpacing: 8,
      alignment: WrapAlignment.center,
      children: [
        _buildSuggestionChip('📊', l10n.aiSuggestion1, 0),
        _buildSuggestionChip('💡', l10n.aiSuggestion2, 1),
        _buildSuggestionChip('🔥', l10n.aiSuggestion3, 2),
        _buildSuggestionChip('🎯', l10n.aiSuggestion4, 3),
      ],
    );
  }

  Widget _buildSuggestionChip(String emoji, String text, int index) {
    final l10n = AppLocalizations.of(context);
    return Semantics(
      label: l10n.accessibilitySuggestionButton(text),
      button: true,
      child: GestureDetector(
        onTap: () {
          HapticFeedback.selectionClick();
          // Analytics logging
          _logAnalytics('ai_suggestion_tapped', {'suggestion': index});
          _controller.text = text;
          _sendMessage();
        },
        child: Container(
          padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),
          decoration: BoxDecoration(
            color: context.appColors.surfaceLight,
            borderRadius: BorderRadius.circular(24),
            border: Border.all(color: context.appColors.cardBorder),
          ),
          child: Row(
            mainAxisSize: MainAxisSize.min,
            children: [
              Text(emoji, style: const TextStyle(fontSize: 16)),
              const SizedBox(width: 8),
              Flexible(
                child: Text(
                  text,
                  style: TextStyle(
                    fontSize: 13,
                    color: context.appColors.textSecondary,
                  ),
                  overflow: TextOverflow.ellipsis,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  void _logAnalytics(String event, Map<String, dynamic> params) {
    // Placeholder for analytics logging
    // Analytics.log(event, params);
  }

  Widget _buildPremiumUpsell(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return AnimatedOpacity(
      opacity: _showUpsell ? 1.0 : 0.0,
      duration: const Duration(milliseconds: 500),
      child: Container(
        margin: const EdgeInsets.only(bottom: 12, top: 8),
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: context.appColors.primary.withValues(alpha: 0.1),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: context.appColors.primary.withValues(alpha: 0.3),
          ),
        ),
        child: Column(
          children: [
            Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(
                  CupertinoIcons.lock,
                  size: 18,
                  color: context.appColors.primary,
                ),
                const SizedBox(width: 8),
                Flexible(
                  child: Text(
                    l10n.aiPremiumUpsell,
                    textAlign: TextAlign.center,
                    style: TextStyle(
                      fontSize: 13,
                      color: context.appColors.textSecondary,
                      height: 1.4,
                    ),
                  ),
                ),
              ],
            ),
            const SizedBox(height: 12),
            Semantics(
              label: l10n.aiPremiumButton,
              button: true,
              child: GestureDetector(
                onTap: () => _showPaywall(context),
                child: Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 20,
                    vertical: 10,
                  ),
                  decoration: BoxDecoration(
                    gradient: LinearGradient(
                      colors: [
                        context.appColors.primary,
                        context.appColors.primaryDark,
                      ],
                    ),
                    borderRadius: BorderRadius.circular(24),
                  ),
                  child: Text(
                    l10n.aiPremiumButton,
                    style: const TextStyle(
                      fontSize: 14,
                      fontWeight: FontWeight.w600,
                      color: Colors.white,
                    ),
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    ).animate().fadeIn(delay: 300.ms, duration: 500.ms);
  }

  Widget _buildMessageBubble(ChatMessage message) {
    final isUser = message.role == 'user';

    return Align(
      alignment: isUser ? Alignment.centerRight : Alignment.centerLeft,
      child: Container(
        margin: const EdgeInsets.only(bottom: 12),
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
        constraints: BoxConstraints(
          maxWidth: MediaQuery.of(context).size.width * 0.75,
        ),
        decoration: BoxDecoration(
          color: isUser
              ? context.appColors.primary
              : context.appColors.surfaceLight,
          borderRadius: BorderRadius.circular(16).copyWith(
            bottomRight: isUser ? const Radius.circular(4) : null,
            bottomLeft: !isUser ? const Radius.circular(4) : null,
          ),
          border: isUser
              ? null
              : Border.all(color: context.appColors.cardBorder),
        ),
        child: message.isTyping
            ? _buildTypingText(message.content)
            : Text(
                message.content,
                style: TextStyle(
                  fontSize: 14,
                  color: isUser ? Colors.white : context.appColors.textPrimary,
                  height: 1.4,
                ),
              ),
      ),
    ).animate().fadeIn(duration: 200.ms).slideY(begin: 0.1, end: 0);
  }

  Widget _buildTypingText(String text) {
    return Text(
      text,
      style: TextStyle(
        fontSize: 14,
        color: context.appColors.textPrimary,
        height: 1.4,
      ),
    );
  }

  Widget _buildLoadingBubble() {
    final l10n = AppLocalizations.of(context);
    return Align(
          alignment: Alignment.centerLeft,
          child: Container(
            margin: const EdgeInsets.only(bottom: 12),
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
            decoration: BoxDecoration(
              color: context.appColors.surfaceLight,
              borderRadius: BorderRadius.circular(
                16,
              ).copyWith(bottomLeft: const Radius.circular(4)),
              border: Border.all(color: context.appColors.cardBorder),
            ),
            child: Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                SizedBox(
                  width: 16,
                  height: 16,
                  child: CircularProgressIndicator(
                    strokeWidth: 2,
                    color: context.appColors.primary,
                  ),
                ),
                const SizedBox(width: 12),
                Text(
                  l10n.aiThinking,
                  style: TextStyle(
                    fontSize: 13,
                    color: context.appColors.textSecondary,
                    fontStyle: FontStyle.italic,
                  ),
                ),
              ],
            ),
          ),
        )
        .animate(onPlay: (c) => c.repeat())
        .shimmer(
          duration: 1500.ms,
          color: context.appColors.primary.withValues(alpha: 0.1),
        );
  }

  Widget _buildInput(bool isPremium) {
    final l10n = AppLocalizations.of(context);

    return Container(
      padding: EdgeInsets.fromLTRB(
        16,
        12,
        16,
        MediaQuery.of(context).padding.bottom + 12,
      ),
      decoration: BoxDecoration(
        color: context.appColors.surface,
        border: Border(top: BorderSide(color: context.appColors.cardBorder)),
      ),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          // Suggestion buttons when in conversation (for quick access)
          if (_messages.isNotEmpty) ...[
            SingleChildScrollView(
              scrollDirection: Axis.horizontal,
              child: Row(
                children: [
                  _buildMiniSuggestionChip('📊', l10n.aiSuggestion1, 0),
                  const SizedBox(width: 8),
                  _buildMiniSuggestionChip('💡', l10n.aiSuggestion2, 1),
                  const SizedBox(width: 8),
                  _buildMiniSuggestionChip('🔥', l10n.aiSuggestion3, 2),
                  const SizedBox(width: 8),
                  _buildMiniSuggestionChip('🎯', l10n.aiSuggestion4, 3),
                ],
              ),
            ),
            const SizedBox(height: 12),
          ],
          // Input row
          Row(
            children: [
              Expanded(
                child: Container(
                  padding: const EdgeInsets.symmetric(horizontal: 16),
                  decoration: BoxDecoration(
                    color: context.appColors.surfaceLight,
                    borderRadius: BorderRadius.circular(24),
                    border: Border.all(color: context.appColors.cardBorder),
                  ),
                  child: Semantics(
                    label: l10n.accessibilityAiChatInput,
                    textField: true,
                    child: TextField(
                      controller: _controller,
                      readOnly: !isPremium,
                      onTap: () {
                        if (!isPremium) {
                          _showPaywall(context);
                        }
                      },
                      style: TextStyle(
                        color: context.appColors.textPrimary,
                        fontSize: 14,
                      ),
                      decoration: InputDecoration(
                        hintText: isPremium
                            ? l10n.aiInputPlaceholder
                            : l10n.aiInputPlaceholderFree,
                        hintStyle: TextStyle(
                          color: context.appColors.textTertiary,
                        ),
                        border: InputBorder.none,
                        contentPadding: const EdgeInsets.symmetric(
                          vertical: 12,
                        ),
                        suffixIcon: !isPremium
                            ? Icon(
                                CupertinoIcons.lock,
                                size: 18,
                                color: context.appColors.textTertiary,
                              )
                            : null,
                      ),
                      keyboardType: TextInputType.text,
                      textInputAction: TextInputAction.send,
                      enableSuggestions: true,
                      autocorrect: false,
                      enableIMEPersonalizedLearning: true,
                      onSubmitted: isPremium ? (_) => _sendMessage() : null,
                    ),
                  ),
                ),
              ),
              const SizedBox(width: 12),
              Semantics(
                label: l10n.accessibilityAiSendButton,
                button: true,
                child: Tooltip(
                  message: l10n.accessibilityAiSendButton,
                  child: GestureDetector(
                    onTap: isPremium
                        ? _sendMessage
                        : () => _showPaywall(context),
                    child: Container(
                      width: 48,
                      height: 48,
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          begin: Alignment.topLeft,
                          end: Alignment.bottomRight,
                          colors: isPremium
                              ? [
                                  context.appColors.primary,
                                  context.appColors.primaryDark,
                                ]
                              : [
                                  context.appColors.textTertiary,
                                  context.appColors.textSecondary,
                                ],
                        ),
                        shape: BoxShape.circle,
                        boxShadow: isPremium
                            ? [
                                BoxShadow(
                                  color: context.appColors.primary.withValues(
                                    alpha: 0.3,
                                  ),
                                  blurRadius: 12,
                                  offset: const Offset(0, 4),
                                ),
                              ]
                            : null,
                      ),
                      child: Icon(
                        isPremium
                            ? CupertinoIcons.paperplane_fill
                            : CupertinoIcons.lock_fill,
                        size: 20,
                        color: Colors.white,
                      ),
                    ),
                  ),
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildMiniSuggestionChip(String emoji, String text, int index) {
    final l10n = AppLocalizations.of(context);
    return Semantics(
      label: l10n.accessibilitySuggestionButton(text),
      button: true,
      child: GestureDetector(
        onTap: () {
          HapticFeedback.selectionClick();
          _logAnalytics('ai_suggestion_tapped', {'suggestion': index});
          _controller.text = text;
          _sendMessage();
        },
        child: Container(
          padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
          decoration: BoxDecoration(
            color: context.appColors.surfaceLight,
            borderRadius: BorderRadius.circular(16),
            border: Border.all(color: context.appColors.cardBorder),
          ),
          child: Row(
            mainAxisSize: MainAxisSize.min,
            children: [
              Text(emoji, style: const TextStyle(fontSize: 12)),
              const SizedBox(width: 4),
              Text(
                text.length > 20 ? '${text.substring(0, 20)}...' : text,
                style: TextStyle(
                  fontSize: 11,
                  color: context.appColors.textTertiary,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Future<void> _sendMessage() async {
    final text = _controller.text.trim();
    if (text.isEmpty || _isLoading) return;

    final proProvider = context.read<ProProvider>();
    final isPremium = proProvider.isPro;
    final l10n = AppLocalizations.of(context);

    // Check if AI service is available
    if (!AIService().isAvailable) {
      setState(() {
        _messages.add(ChatMessage(
          role: 'assistant',
          content: l10n.aiServiceUnavailable,
        ));
      });
      _scrollToBottom();
      return;
    }

    // Check free tier limit before sending
    if (!isPremium) {
      final canUse = await _freeTierService.canUseAiChat(isPremium);
      if (!canUse) {
        HapticFeedback.heavyImpact();
        if (mounted) {
          UpgradeDialog.show(context, l10n.aiChatLimitReached);
        }
        return;
      }
    }

    HapticFeedback.lightImpact();
    _controller.clear();

    setState(() {
      _messages.add(ChatMessage(role: 'user', content: text));
      _isLoading = true;
      _showUpsell = false;
    });

    _scrollToBottom();

    final financeProvider = context.read<FinanceProvider>();
    final locale = Localizations.localeOf(context);

    try {
      final response = await AIService().getResponse(
        message: text,
        financeProvider: financeProvider,
        isPremium: isPremium,
        proProvider: proProvider,
        languageCode: locale.languageCode,
      );

      if (mounted) {
        HapticFeedback.lightImpact();

        // Increment free tier counter after successful response
        if (!isPremium) {
          await _freeTierService.incrementAiChatCount();
          _loadChatUsage(); // Refresh the usage count
        }

        // Add message with typing effect for free users
        if (!isPremium) {
          await _typeMessage(response);
        } else {
          setState(() {
            _messages.add(ChatMessage(role: 'assistant', content: response));
            _isLoading = false;
          });
        }

        // Show upsell for free users
        if (!isPremium) {
          setState(() {
            _showUpsell = true;
          });
        }

        _scrollToBottom();
      }
    } on AILimitExceededException catch (e) {
      if (mounted) {
        final resetTime = e.resetDate;
        final locale = Localizations.localeOf(context).languageCode;
        final isEnglish = locale == 'en';
        final limitTypeText = isEnglish
            ? (e.limitType == 'daily' ? 'daily' : 'monthly')
            : (e.limitType == 'daily' ? 'günlük' : 'aylık');
        final limitMessage = isEnglish
            ? 'You\'ve reached your $limitTypeText AI limit. Try again in ${_formatResetTime(resetTime, isEnglish)}.'
            : '$limitTypeText AI limitine ulaştın. ${_formatResetTime(resetTime, isEnglish)} sonra tekrar deneyebilirsin.';
        setState(() {
          _messages.add(ChatMessage(role: 'assistant', content: limitMessage));
          _isLoading = false;
          _showUpsell = true;
        });
      }
    } catch (e) {
      if (mounted) {
        final locale = Localizations.localeOf(context).languageCode;
        final isEnglish = locale == 'en';
        setState(() {
          _messages.add(
            ChatMessage(
              role: 'assistant',
              content: isEnglish
                  ? 'Something went wrong, please try again.'
                  : 'Bir hata oluştu, tekrar dener misin?',
            ),
          );
          _isLoading = false;
        });
      }
    }
  }

  String _formatResetTime(DateTime resetDate, [bool isEnglish = false]) {
    final now = DateTime.now();
    final diff = resetDate.difference(now);
    if (diff.inHours < 1) {
      return isEnglish
          ? '${diff.inMinutes} minutes'
          : '${diff.inMinutes} dakika';
    } else if (diff.inHours < 24) {
      return isEnglish ? '${diff.inHours} hours' : '${diff.inHours} saat';
    } else {
      return isEnglish ? '${diff.inDays} days' : '${diff.inDays} gün';
    }
  }

  Future<void> _typeMessage(String fullText) async {
    setState(() {
      _isLoading = false;
      _messages.add(
        ChatMessage(role: 'assistant', content: '', isTyping: true),
      );
    });

    final messageIndex = _messages.length - 1;
    String currentText = '';

    // Type word by word
    final words = fullText.split(' ');
    for (int i = 0; i < words.length; i++) {
      if (!mounted) break;

      currentText += (i > 0 ? ' ' : '') + words[i];

      setState(() {
        _messages[messageIndex] = ChatMessage(
          role: 'assistant',
          content: currentText,
          isTyping: i < words.length - 1,
        );
      });

      _scrollToBottom();
      await Future.delayed(const Duration(milliseconds: 50));
    }

    if (mounted) {
      setState(() {
        _messages[messageIndex] = ChatMessage(
          role: 'assistant',
          content: fullText,
          isTyping: false,
        );
      });
    }
  }

  void _togglePersonality() {
    HapticFeedback.selectionClick();
    final current = AIService().personalityMode;
    AIService().setPersonalityMode(
      current == PersonalityMode.friendly
          ? PersonalityMode.professional
          : PersonalityMode.friendly,
    );
    setState(() {});
  }
}

class ChatMessage {
  final String role;
  final String content;
  final bool isTyping;

  ChatMessage({
    required this.role,
    required this.content,
    this.isTyping = false,
  });
}


--- FILE: lib/widgets/premium_nav_bar.dart ---

import 'dart:io';
import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:showcaseview/showcaseview.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../core/theme/psychology_design_system.dart';
import '../theme/theme.dart';
import '../services/services.dart';

/// Premium Floating Navigation Bar
/// Premium banking-style design - Gradient FAB, Glassmorphism
class PremiumNavBar extends StatelessWidget {
  final int currentIndex;
  final Function(int) onTap;
  final VoidCallback onAddTap;
  final VoidCallback? onAddLongPress;

  const PremiumNavBar({
    super.key,
    required this.currentIndex,
    required this.onTap,
    required this.onAddTap,
    this.onAddLongPress,
  });

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final isDark = context.isDarkMode;

    return Container(
      margin: const EdgeInsets.fromLTRB(20, 0, 20, 34),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(32),
        child: BackdropFilter(
          filter: ImageFilter.blur(sigmaX: 20, sigmaY: 20),
          child: Container(
            height: 64,
            padding: const EdgeInsets.symmetric(horizontal: 8),
            decoration: BoxDecoration(
              color: isDark
                  ? AppColors.surface.withValues(alpha: 0.95)
                  : const Color(0xF2FFFFFF),
              borderRadius: BorderRadius.circular(32),
              border: Border.all(
                color: Colors.white.withValues(alpha: 0.06),
                width: 1,
              ),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withValues(alpha: 0.3),
                  blurRadius: 30,
                  offset: const Offset(0, 10),
                ),
              ],
            ),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceEvenly,
              children: [
                // Home
                _NavItem(
                  icon: CupertinoIcons.house_fill,
                  label: l10n.homePage,
                  tooltip: l10n.navHomeTooltip,
                  isActive: currentIndex == 0,
                  onTap: () => onTap(0),
                ),
                // Reports
                _NavItem(
                  icon: CupertinoIcons.chart_bar_fill,
                  label: l10n.analysis,
                  tooltip: l10n.navReportsTooltip,
                  isActive: currentIndex == 1,
                  onTap: () => onTap(1),
                ),
                // FAB - Center
                Semantics(
                  label: l10n.accessibilityAddExpense,
                  button: true,
                  child: _CenterAddButton(
                    onTap: onAddTap,
                    onLongPress: onAddLongPress,
                  ),
                ),
                // Pursuits (Dreams)
                _NavItem(
                  icon: CupertinoIcons.star_fill,
                  label: l10n.navPursuits,
                  tooltip: l10n.navPursuitsTooltip,
                  isActive: currentIndex == 2,
                  onTap: () => onTap(2),
                ),
                // Settings
                _NavItem(
                  icon: CupertinoIcons.gear_alt_fill,
                  label: l10n.navSettings,
                  tooltip: l10n.navSettingsTooltip,
                  isActive: currentIndex == 3,
                  onTap: () => onTap(3),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

class _NavItem extends StatelessWidget {
  final IconData icon;
  final String label;
  final bool isActive;
  final VoidCallback onTap;
  final String? tooltip;

  const _NavItem({
    required this.icon,
    required this.label,
    required this.isActive,
    required this.onTap,
    this.tooltip,
  });

  @override
  Widget build(BuildContext context) {
    final colors = context.appColors;

    return Semantics(
      label: tooltip ?? label,
      button: true,
      selected: isActive,
      child: GestureDetector(
        onTap: () {
          haptics.navigation();
          onTap();
        },
        behavior: HitTestBehavior.opaque,
        child: AnimatedContainer(
          duration: const Duration(milliseconds: 200),
          curve: Curves.easeOutCubic,
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
          decoration: BoxDecoration(
            color: isActive
                ? colors.primary.withValues(alpha: 0.15)
                : Colors.transparent,
            borderRadius: BorderRadius.circular(16),
            boxShadow: isActive
                ? [
                    BoxShadow(
                      color: colors.primary.withValues(alpha: 0.4),
                      blurRadius: 12,
                      spreadRadius: -2,
                    ),
                  ]
                : null,
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Icon(
                icon,
                size: 24,
                color: isActive ? colors.primary : colors.textTertiary,
              ),
              const SizedBox(height: 4),
              AnimatedDefaultTextStyle(
                duration: const Duration(milliseconds: 200),
                style: TextStyle(
                  fontSize: 11,
                  fontWeight: isActive ? FontWeight.w600 : FontWeight.w500,
                  color: isActive ? colors.primary : colors.textTertiary,
                  letterSpacing: 0.3,
                ),
                child: Text(label),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class _CenterAddButton extends StatefulWidget {
  final VoidCallback onTap;
  final VoidCallback? onLongPress;

  const _CenterAddButton({required this.onTap, this.onLongPress});

  @override
  State<_CenterAddButton> createState() => _CenterAddButtonState();
}

class _CenterAddButtonState extends State<_CenterAddButton>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _scaleAnimation;
  bool _isPressed = false;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 150),
    );
    _scaleAnimation = Tween<double>(
      begin: 1.0,
      end: 0.92,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeInOut));
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  void _onTapDown(TapDownDetails details) {
    setState(() => _isPressed = true);
    _controller.forward();
  }

  void _onTapUp(TapUpDetails details) {
    setState(() => _isPressed = false);
    _controller.reverse();
    haptics.buttonPress();
    widget.onTap();
  }

  void _onTapCancel() {
    setState(() => _isPressed = false);
    _controller.reverse();
  }

  void _onLongPress() {
    setState(() => _isPressed = false);
    _controller.reverse();
    HapticFeedback.heavyImpact();
    widget.onLongPress?.call();
  }

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTapDown: _onTapDown,
      onTapUp: _onTapUp,
      onTapCancel: _onTapCancel,
      onLongPress: widget.onLongPress != null ? _onLongPress : null,
      behavior: HitTestBehavior.opaque,
      child: AnimatedBuilder(
        animation: _scaleAnimation,
        builder: (context, child) {
          return Transform.scale(
            scale: _scaleAnimation.value,
            child: Container(
              width: 56,
              height: 56,
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                boxShadow: [
                  BoxShadow(
                    color: context.appColors.primary.withValues(
                      alpha: _isPressed ? 0.3 : 0.5,
                    ),
                    blurRadius: _isPressed ? 15 : 25,
                    offset: Offset(0, _isPressed ? 4 : 8),
                  ),
                ],
              ),
              child: Container(
                decoration: BoxDecoration(
                  gradient: AppGradients.primaryButton,
                  shape: BoxShape.circle,
                ),
                child: Center(
                  child: Icon(
                    CupertinoIcons.plus,
                    size: 28,
                    color: Colors.white,
                  ),
                ),
              ),
            ),
          );
        },
      ),
    );
  }
}

class _ProfileNavItem extends StatefulWidget {
  final bool isActive;
  final VoidCallback onTap;
  final String label;

  const _ProfileNavItem({
    required this.isActive,
    required this.onTap,
    required this.label,
  });

  @override
  State<_ProfileNavItem> createState() => _ProfileNavItemState();
}

class _ProfileNavItemState extends State<_ProfileNavItem> {
  final _profileService = ProfileService();
  String? _photoPath;

  @override
  void initState() {
    super.initState();
    _loadPhoto();
  }

  Future<void> _loadPhoto() async {
    final path = await _profileService.getProfilePhotoPath();
    if (mounted) {
      setState(() => _photoPath = path);
    }
  }

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: () {
        haptics.navigation();
        widget.onTap();
      },
      behavior: HitTestBehavior.opaque,
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        curve: Curves.easeOutCubic,
        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
        decoration: BoxDecoration(
          color: widget.isActive
              ? context.appColors.primary.withValues(alpha: 0.15)
              : Colors.transparent,
          borderRadius: BorderRadius.circular(16),
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            _photoPath != null
                ? Container(
                    width: 24,
                    height: 24,
                    decoration: BoxDecoration(
                      shape: BoxShape.circle,
                      border: Border.all(
                        color: widget.isActive
                            ? context.appColors.primary
                            : context.appColors.textTertiary,
                        width: 2,
                      ),
                      boxShadow: widget.isActive
                          ? [
                              BoxShadow(
                                color: context.appColors.primary.withValues(
                                  alpha: 0.3,
                                ),
                                blurRadius: 8,
                              ),
                            ]
                          : null,
                    ),
                    child: ClipOval(
                      child: Image.file(
                        File(_photoPath!),
                        fit: BoxFit.cover,
                        width: 24,
                        height: 24,
                        errorBuilder: (context, error, stackTrace) {
                          return Icon(
                            CupertinoIcons.person_fill,
                            size: 16,
                            color: widget.isActive
                                ? context.appColors.primary
                                : context.appColors.textTertiary,
                          );
                        },
                      ),
                    ),
                  )
                : Icon(
                    CupertinoIcons.person_fill,
                    size: 24,
                    color: widget.isActive
                        ? context.appColors.primary
                        : context.appColors.textTertiary,
                  ),
            const SizedBox(height: 4),
            AnimatedDefaultTextStyle(
              duration: const Duration(milliseconds: 200),
              style: TextStyle(
                fontSize: 11,
                fontWeight: widget.isActive ? FontWeight.w600 : FontWeight.w500,
                color: widget.isActive
                    ? context.appColors.primary
                    : context.appColors.textTertiary,
              ),
              child: Text(widget.label),
            ),
          ],
        ),
      ),
    );
  }
}

/// Premium Floating Navigation Bar with Showcase support
/// iOS 26 Liquid Glass Design
class PremiumNavBarWithShowcase extends StatefulWidget {
  final int currentIndex;
  final Function(int) onTap;
  final VoidCallback onAddTap;
  final VoidCallback? onAddLongPress;

  const PremiumNavBarWithShowcase({
    super.key,
    required this.currentIndex,
    required this.onTap,
    required this.onAddTap,
    this.onAddLongPress,
  });

  @override
  State<PremiumNavBarWithShowcase> createState() =>
      _PremiumNavBarWithShowcaseState();
}

class _PremiumNavBarWithShowcaseState extends State<PremiumNavBarWithShowcase>
    with SingleTickerProviderStateMixin {
  // Psychology-based breathing glow animation
  late AnimationController _glowController;
  late Animation<double> _glowAnimation;

  @override
  void initState() {
    super.initState();
    _glowController = AnimationController(
      vsync: this,
      duration: PsychologyAnimations.breathingCycle,
    )..repeat(reverse: true);

    _glowAnimation = Tween<double>(
      begin: PsychologyAnimations.glowMin,
      end: PsychologyAnimations.glowMax,
    ).animate(CurvedAnimation(
      parent: _glowController,
      curve: PsychologyAnimations.smooth,
    ));
  }

  @override
  void dispose() {
    _glowController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final isDark = context.isDarkMode;

    // Psychology-based floating nav with breathing glow
    return AnimatedBuilder(
      animation: _glowAnimation,
      builder: (context, child) {
        return Container(
          margin: const EdgeInsets.fromLTRB(20, 0, 20, 34),
          // Psychology glow shadow for premium feel
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(PsychologyRadius.sheet),
            boxShadow: [
              // Animated breathing glow
              BoxShadow(
                color: PsychologyColors.primary.withValues(
                  alpha: _glowAnimation.value,
                ),
                blurRadius: 24,
                spreadRadius: -4,
                offset: const Offset(0, 6),
              ),
              // Deep shadow for depth
              BoxShadow(
                color: Colors.black.withValues(alpha: 0.4),
                blurRadius: 20,
                offset: const Offset(0, 10),
              ),
            ],
          ),
          child: ClipRRect(
            borderRadius: BorderRadius.circular(PsychologyRadius.sheet),
            child: BackdropFilter(
              // Psychology glass blur (24σ)
              filter: ImageFilter.blur(
                sigmaX: PsychologyGlass.blurSigma,
                sigmaY: PsychologyGlass.blurSigma,
              ),
              child: Container(
                height: 68,
                padding: const EdgeInsets.symmetric(horizontal: 8),
                decoration: BoxDecoration(
                  // Psychology glass gradient
                  gradient: isDark
                      ? LinearGradient(
                          begin: Alignment.topCenter,
                          end: Alignment.bottomCenter,
                          colors: [
                            PsychologyColors.primary.withValues(alpha: 0.15),
                            PsychologyColors.surface.withValues(alpha: 0.9),
                          ],
                        )
                      : LinearGradient(
                          begin: Alignment.topCenter,
                          end: Alignment.bottomCenter,
                          colors: [
                            Colors.white.withValues(alpha: 0.95),
                            Colors.white.withValues(alpha: 0.85),
                          ],
                        ),
                  borderRadius: BorderRadius.circular(PsychologyRadius.sheet),
                  border: Border.all(
                    color: Colors.white.withValues(
                      alpha: PsychologyGlass.highlightOpacity,
                    ),
                    width: 1.5,
                  ),
                ),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                  children: [
                    // Home
                    _NavItem(
                      icon: CupertinoIcons.house_fill,
                      label: l10n.homePage,
                      isActive: widget.currentIndex == 0,
                      onTap: () => widget.onTap(0),
                    ),
                    // Reports - with Showcase
                    Showcase(
                      key: TourKeys.navBarReport,
                      title: l10n.reports,
                      description: l10n.reportsDescription,
                      titleTextStyle: TextStyle(
                        fontWeight: FontWeight.bold,
                        color: context.appColors.textPrimary,
                        fontSize: 16,
                      ),
                      descTextStyle: TextStyle(
                        color: context.appColors.textSecondary,
                        fontSize: 14,
                      ),
                      tooltipBackgroundColor: context.appColors.gradientMid,
                      overlayColor: Colors.black,
                      overlayOpacity: 0.95,
                      targetBorderRadius: BorderRadius.circular(16),
                      child: _NavItem(
                        icon: CupertinoIcons.chart_bar_fill,
                        label: l10n.analysis,
                        isActive: widget.currentIndex == 1,
                        onTap: () => widget.onTap(1),
                      ),
                    ),
                    // FAB - Center with Showcase
                    Showcase(
                      key: TourKeys.navBarAddButton,
                      title: l10n.quickAdd,
                      description: l10n.quickAddDescription,
                      titleTextStyle: TextStyle(
                        fontWeight: FontWeight.bold,
                        color: context.appColors.textPrimary,
                        fontSize: 16,
                      ),
                      descTextStyle: TextStyle(
                        color: context.appColors.textSecondary,
                        fontSize: 14,
                      ),
                      tooltipBackgroundColor: context.appColors.gradientMid,
                      overlayColor: Colors.black,
                      overlayOpacity: 0.95,
                      targetShapeBorder: const CircleBorder(),
                      targetPadding: EdgeInsets.zero,
                      child: Semantics(
                        label: l10n.accessibilityAddExpense,
                        button: true,
                        child: _CenterAddButton(
                          onTap: widget.onAddTap,
                          onLongPress: widget.onAddLongPress,
                        ),
                      ),
                    ),
                    // Pursuits (Dreams) - with Showcase
                    Showcase(
                      key: TourKeys.navBarAchievements,
                      title: l10n.navPursuits,
                      description: l10n.emptyPursuitsMessage,
                      titleTextStyle: TextStyle(
                        fontWeight: FontWeight.bold,
                        color: context.appColors.textPrimary,
                        fontSize: 16,
                      ),
                      descTextStyle: TextStyle(
                        color: context.appColors.textSecondary,
                        fontSize: 14,
                      ),
                      tooltipBackgroundColor: context.appColors.gradientMid,
                      overlayColor: Colors.black,
                      overlayOpacity: 0.95,
                      targetBorderRadius: BorderRadius.circular(16),
                      child: _NavItem(
                        icon: CupertinoIcons.star_fill,
                        label: l10n.navPursuits,
                        isActive: widget.currentIndex == 2,
                        onTap: () => widget.onTap(2),
                      ),
                    ),
                    // Settings - with Showcase
                    Showcase(
                      key: TourKeys.navBarProfile,
                      title: l10n.navSettings,
                      description: l10n.profileAndSettingsDescription,
                      titleTextStyle: TextStyle(
                        fontWeight: FontWeight.bold,
                        color: context.appColors.textPrimary,
                        fontSize: 16,
                      ),
                      descTextStyle: TextStyle(
                        color: context.appColors.textSecondary,
                        fontSize: 14,
                      ),
                      tooltipBackgroundColor: context.appColors.gradientMid,
                      overlayColor: Colors.black,
                      overlayOpacity: 0.95,
                      targetBorderRadius: BorderRadius.circular(16),
                      child: _NavItem(
                        icon: CupertinoIcons.gear_alt_fill,
                        label: l10n.navSettings,
                        isActive: widget.currentIndex == 3,
                        onTap: () => widget.onTap(3),
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ),
        );
      },
    );
  }
}


--- FILE: lib/widgets/payday_confirmation_dialog.dart ---

import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';
import '../services/services.dart';
import '../providers/finance_provider.dart';
import '../theme/theme.dart';
import '../utils/currency_utils.dart';

/// Dialog shown on payday to confirm salary received and update balance
class PaydayConfirmationDialog extends StatefulWidget {
  final VoidCallback? onConfirmed;
  final VoidCallback? onSkipped;

  const PaydayConfirmationDialog({super.key, this.onConfirmed, this.onSkipped});

  /// Show the payday confirmation dialog if today is payday
  static Future<void> showIfPayday(BuildContext context) async {
    final financeProvider = context.read<FinanceProvider>();
    final profile = financeProvider.userProfile;

    if (profile == null) return;
    if (profile.salaryDay == null) return;
    if (!profile.isPayday) return;
    if (profile.isSalaryConfirmedThisMonth) return;

    await showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => PaydayConfirmationDialog(
        onConfirmed: () => Navigator.pop(context),
        onSkipped: () => Navigator.pop(context),
      ),
    );
  }

  @override
  State<PaydayConfirmationDialog> createState() =>
      _PaydayConfirmationDialogState();
}

class _PaydayConfirmationDialogState extends State<PaydayConfirmationDialog>
    with SingleTickerProviderStateMixin {
  final _balanceController = TextEditingController();
  final _profileService = ProfileService();
  bool _showBalanceInput = false;
  bool _isLoading = false;

  late AnimationController _celebrationController;

  @override
  void initState() {
    super.initState();
    _celebrationController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 600),
    );
    _celebrationController.forward();

    // Pre-fill with current balance + expected salary
    WidgetsBinding.instance.addPostFrameCallback((_) {
      final financeProvider = context.read<FinanceProvider>();
      final profile = financeProvider.userProfile;
      if (profile != null) {
        final currentBalance = profile.currentBalance ?? 0;
        final salary = profile.monthlyIncome;
        final newBalance = currentBalance + salary;
        _balanceController.text = formatTurkishCurrency(
          newBalance,
          decimalDigits: 0,
        );
      }
    });
  }

  @override
  void dispose() {
    _balanceController.dispose();
    _celebrationController.dispose();
    super.dispose();
  }

  Future<void> _confirmSalary() async {
    if (_isLoading) return;

    setState(() => _isLoading = true);
    HapticFeedback.heavyImpact();

    try {
      final financeProvider = context.read<FinanceProvider>();
      final profile = financeProvider.userProfile;

      double? newBalance;
      if (_showBalanceInput && _balanceController.text.isNotEmpty) {
        newBalance = parseTurkishCurrency(_balanceController.text);
      } else if (profile != null) {
        // Auto-add salary to balance
        final currentBalance = profile.currentBalance ?? 0;
        newBalance = currentBalance + profile.monthlyIncome;
      }

      // Record salary confirmation
      final updatedProfile = await _profileService.confirmSalaryReceived(
        newBalance: newBalance,
      );

      if (updatedProfile != null) {
        financeProvider.setUserProfile(updatedProfile);
      }

      // Add salary as income record
      final income = Income.salary(
        amount: profile?.monthlyIncome ?? 0,
        title: AppLocalizations.of(context).incomeTypeSalary,
        currencyCode: profile?.incomeSources.firstOrNull?.currencyCode ?? 'TRY',
      );
      await _profileService.addIncome(income);

      if (!mounted) return;

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(AppLocalizations.of(context).paydayCelebration),
          backgroundColor: context.appColors.success,
          behavior: SnackBarBehavior.floating,
        ),
      );

      widget.onConfirmed?.call();
    } catch (e) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error: $e'),
          backgroundColor: context.appColors.error,
          behavior: SnackBarBehavior.floating,
        ),
      );
    } finally {
      if (mounted) {
        setState(() => _isLoading = false);
      }
    }
  }

  void _skip() {
    HapticFeedback.lightImpact();
    widget.onSkipped?.call();
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);

    return Dialog(
      backgroundColor: Colors.transparent,
      child: ClipRRect(
        borderRadius: BorderRadius.circular(24),
        child: BackdropFilter(
          filter: ImageFilter.blur(sigmaX: 20, sigmaY: 20),
          child: Container(
            padding: const EdgeInsets.all(24),
            decoration: BoxDecoration(
              color: context.appColors.surface,
              borderRadius: BorderRadius.circular(24),
              border: Border.all(color: context.appColors.cardBorder),
            ),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                // Celebration icon
                ScaleTransition(
                  scale: CurvedAnimation(
                    parent: _celebrationController,
                    curve: Curves.elasticOut,
                  ),
                  child: Container(
                    width: 80,
                    height: 80,
                    decoration: BoxDecoration(
                      color: context.appColors.success.withValues(alpha: 0.15),
                      borderRadius: BorderRadius.circular(24),
                    ),
                    child: Icon(
                      CupertinoIcons.gift_fill,
                      size: 40,
                      color: context.appColors.success,
                    ),
                  ),
                ),
                const SizedBox(height: 20),

                // Title
                Text(
                  l10n.paydayTitle,
                  style: TextStyle(
                    fontSize: 24,
                    fontWeight: FontWeight.w700,
                    color: context.appColors.textPrimary,
                  ),
                ),
                const SizedBox(height: 8),

                // Message
                Text(
                  l10n.paydayMessage,
                  textAlign: TextAlign.center,
                  style: TextStyle(
                    fontSize: 16,
                    color: context.appColors.textSecondary,
                  ),
                ),
                const SizedBox(height: 24),

                // Optional balance input
                if (_showBalanceInput) ...[
                  Text(
                    l10n.paydayNewBalance,
                    style: TextStyle(
                      fontSize: 14,
                      fontWeight: FontWeight.w600,
                      color: context.appColors.textSecondary,
                    ),
                  ),
                  const SizedBox(height: 8),
                  TextField(
                    controller: _balanceController,
                    keyboardType: const TextInputType.numberWithOptions(
                      decimal: true,
                    ),
                    inputFormatters: [TurkishCurrencyInputFormatter()],
                    onChanged: (_) => setState(() {}),
                    style: TextStyle(
                      fontSize: 24,
                      fontWeight: FontWeight.w700,
                      color: context.appColors.textPrimary,
                    ),
                    textAlign: TextAlign.center,
                    decoration: InputDecoration(
                      hintText: '0',
                      hintStyle: TextStyle(
                        fontSize: 24,
                        fontWeight: FontWeight.w700,
                        color: context.appColors.textTertiary,
                      ),
                      filled: true,
                      fillColor: context.appColors.surfaceLight,
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(16),
                        borderSide: BorderSide.none,
                      ),
                      contentPadding: const EdgeInsets.symmetric(
                        horizontal: 16,
                        vertical: 14,
                      ),
                      prefixText: '\u20BA ',
                      prefixStyle: TextStyle(
                        fontSize: 20,
                        fontWeight: FontWeight.w600,
                        color: context.appColors.textSecondary,
                      ),
                    ),
                  ),
                  const SizedBox(height: 16),
                ] else ...[
                  // Update balance toggle
                  GestureDetector(
                    onTap: () {
                      HapticFeedback.selectionClick();
                      setState(() => _showBalanceInput = true);
                    },
                    child: Container(
                      padding: const EdgeInsets.symmetric(
                        horizontal: 16,
                        vertical: 12,
                      ),
                      decoration: BoxDecoration(
                        color: context.appColors.surfaceLight,
                        borderRadius: BorderRadius.circular(16),
                      ),
                      child: Row(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          Icon(
                            CupertinoIcons.pencil,
                            size: 18,
                            color: context.appColors.textSecondary,
                          ),
                          const SizedBox(width: 8),
                          Text(
                            l10n.paydayUpdateBalance,
                            style: TextStyle(
                              fontSize: 14,
                              fontWeight: FontWeight.w500,
                              color: context.appColors.textSecondary,
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                  const SizedBox(height: 16),
                ],

                // Confirm button
                SizedBox(
                  width: double.infinity,
                  child: ElevatedButton(
                    onPressed: _isLoading ? null : _confirmSalary,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: context.appColors.success,
                      foregroundColor: Colors.white,
                      padding: const EdgeInsets.symmetric(vertical: 16),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(16),
                      ),
                    ),
                    child: _isLoading
                        ? SizedBox(
                            width: 24,
                            height: 24,
                            child: CircularProgressIndicator(
                              strokeWidth: 2,
                              valueColor: AlwaysStoppedAnimation(Colors.white),
                            ),
                          )
                        : Row(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              const Icon(CupertinoIcons.checkmark_alt, size: 20),
                              const SizedBox(width: 8),
                              Text(
                                l10n.paydayConfirm,
                                style: const TextStyle(
                                  fontSize: 16,
                                  fontWeight: FontWeight.w600,
                                ),
                              ),
                            ],
                          ),
                  ),
                ),
                const SizedBox(height: 12),

                // Skip button
                TextButton(
                  onPressed: _isLoading ? null : _skip,
                  child: Text(
                    l10n.paydaySkip,
                    style: TextStyle(
                      fontSize: 14,
                      fontWeight: FontWeight.w500,
                      color: context.appColors.textTertiary,
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}


--- FILE: lib/widgets/pending_review_sheet.dart ---

import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:intl/intl.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';
import '../providers/finance_provider.dart';
import '../services/import_service.dart';
import '../services/merchant_learning_service.dart';
import '../theme/theme.dart';

/// Category option for the review sheet
class _CategoryOption {
  final String id;
  final String label;
  final IconData icon;
  final Color color;

  const _CategoryOption({
    required this.id,
    required this.label,
    required this.icon,
    required this.color,
  });
}

/// Sheet for reviewing and categorizing pending expenses
class PendingReviewSheet extends StatefulWidget {
  /// Expenses to review
  final List<ParsedExpense> expenses;

  /// User ID for merchant learning
  final String userId;

  /// Callback when all expenses are processed
  final VoidCallback? onComplete;

  const PendingReviewSheet({
    super.key,
    required this.expenses,
    required this.userId,
    this.onComplete,
  });

  /// Show the review sheet as a modal
  static Future<void> show(
    BuildContext context, {
    required List<ParsedExpense> expenses,
    required String userId,
    VoidCallback? onComplete,
  }) {
    return showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      barrierColor: Colors.black.withValues(alpha: 0.85),
      backgroundColor: Colors.transparent,
      builder: (context) => PendingReviewSheet(
        expenses: expenses,
        userId: userId,
        onComplete: onComplete,
      ),
    );
  }

  @override
  State<PendingReviewSheet> createState() => _PendingReviewSheetState();
}

class _PendingReviewSheetState extends State<PendingReviewSheet> {
  late List<ParsedExpense> _remaining;
  final _merchantService = MerchantLearningService();
  int _processedCount = 0;
  int _skippedCount = 0;

  // Category options
  List<_CategoryOption> get _categories => [
    _CategoryOption(
      id: 'Yiyecek',
      label: AppLocalizations.of(context).categoryFood,
      icon: CupertinoIcons.cart,
      color: AppColors.categoryBills,
    ),
    _CategoryOption(
      id: 'Ulasim',
      label: AppLocalizations.of(context).categoryTransport,
      icon: CupertinoIcons.car,
      color: AppColors.categoryEntertainment,
    ),
    _CategoryOption(
      id: 'Giyim',
      label: AppLocalizations.of(context).categoryClothing,
      icon: CupertinoIcons.bag,
      color: AppColors.categoryShopping,
    ),
    _CategoryOption(
      id: 'Elektronik',
      label: AppLocalizations.of(context).categoryElectronics,
      icon: CupertinoIcons.device_phone_portrait,
      color: AppColors.secondary,
    ),
    _CategoryOption(
      id: 'Eglence',
      label: AppLocalizations.of(context).categoryEntertainment,
      icon: CupertinoIcons.game_controller,
      color: AppColors.categoryEducation,
    ),
    _CategoryOption(
      id: 'Saglik',
      label: AppLocalizations.of(context).categoryHealth,
      icon: CupertinoIcons.heart,
      color: AppColors.achievementMystery,
    ),
    _CategoryOption(
      id: 'Egitim',
      label: AppLocalizations.of(context).categoryEducation,
      icon: CupertinoIcons.book,
      color: AppColors.categoryHealth,
    ),
    _CategoryOption(
      id: 'Faturalar',
      label: AppLocalizations.of(context).categoryBills,
      icon: CupertinoIcons.doc_text,
      color: AppColors.categoryOther,
    ),
    _CategoryOption(
      id: 'Diger',
      label: AppLocalizations.of(context).categoryOther,
      icon: CupertinoIcons.ellipsis,
      color: AppColors.categoryDefault,
    ),
  ];

  @override
  void initState() {
    super.initState();
    _remaining = List.from(widget.expenses);
  }

  void _approveExpense(ParsedExpense expense, String category) async {
    HapticFeedback.mediumImpact();

    // Learn merchant if checkbox is checked
    if (expense.rememberMerchant) {
      await _merchantService.learnMerchant(
        userId: widget.userId,
        rawDescription: expense.rawDescription,
        category: category,
        displayName: expense.effectiveDisplayName ?? expense.rawDescription,
      );
    }

    // Add expense to finance provider
    if (mounted) {
      final financeProvider = context.read<FinanceProvider>();

      // Calculate work time (simplified - uses placeholder hourly rate)
      const hourlyRate = 50.0;
      final hoursRequired = expense.amount / hourlyRate;
      final daysRequired = hoursRequired / 8.0;

      final newExpense = Expense(
        amount: expense.amount,
        category: category,
        subCategory: expense.effectiveDisplayName ?? expense.rawDescription,
        date: expense.date,
        hoursRequired: hoursRequired,
        daysRequired: daysRequired,
        decision: ExpenseDecision.yes,
      );
      await financeProvider.addExpense(newExpense);
    }

    setState(() {
      _remaining.remove(expense);
      _processedCount++;
    });

    _checkComplete();
  }

  void _skipExpense(ParsedExpense expense) {
    HapticFeedback.lightImpact();
    setState(() {
      _remaining.remove(expense);
      _skippedCount++;
    });
    _checkComplete();
  }

  void _checkComplete() {
    if (_remaining.isEmpty && widget.onComplete != null) {
      widget.onComplete!();
    }
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final screenHeight = MediaQuery.of(context).size.height;

    return Container(
      height: screenHeight * 0.85,
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
      ),
      child: Column(
        children: [
          // Handle
          Container(
            margin: const EdgeInsets.only(top: 12),
            width: 40,
            height: 4,
            decoration: BoxDecoration(
              color: context.appColors.textTertiary,
              borderRadius: BorderRadius.circular(2),
            ),
          ),

          // Header
          Padding(
            padding: const EdgeInsets.all(20),
            child: Row(
              children: [
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        l10n.reviewExpenses,
                        style: TextStyle(
                          fontSize: 22,
                          fontWeight: FontWeight.w700,
                          color: context.appColors.textPrimary,
                        ),
                      ),
                      const SizedBox(height: 4),
                      Text(
                        l10n.swipeToCategorizeTip,
                        style: TextStyle(
                          fontSize: 14,
                          color: context.appColors.textSecondary,
                        ),
                      ),
                    ],
                  ),
                ),

                // Progress indicator
                Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 12,
                    vertical: 6,
                  ),
                  decoration: BoxDecoration(
                    color: context.appColors.primary.withValues(alpha: 0.1),
                    borderRadius: BorderRadius.circular(24),
                  ),
                  child: Text(
                    '${_remaining.length}',
                    style: TextStyle(
                      fontSize: 16,
                      fontWeight: FontWeight.w700,
                      color: context.appColors.primary,
                    ),
                  ),
                ),
              ],
            ),
          ),

          // Progress bar
          if (widget.expenses.isNotEmpty)
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 20),
              child: LinearProgressIndicator(
                value: _processedCount / widget.expenses.length,
                backgroundColor: context.appColors.cardBorder,
                valueColor: AlwaysStoppedAnimation(context.appColors.success),
                minHeight: 4,
                borderRadius: BorderRadius.circular(2),
              ),
            ),

          const SizedBox(height: 16),

          // Content
          Expanded(
            child: _remaining.isEmpty
                ? _buildEmptyState(l10n)
                : _buildExpenseCard(_remaining.first),
          ),

          // Bottom actions
          SafeArea(
            child: Padding(
              padding: const EdgeInsets.all(20),
              child: Row(
                children: [
                  // Skip button
                  Semantics(
                    button: true,
                    label: l10n.skip,
                    child: TextButton.icon(
                      onPressed: _remaining.isEmpty
                          ? null
                          : () => _skipExpense(_remaining.first),
                      icon: Icon(
                        CupertinoIcons.forward,
                        color: context.appColors.textSecondary,
                      ),
                      label: Text(
                        l10n.skip,
                        style: TextStyle(
                          color: context.appColors.textSecondary,
                        ),
                      ),
                    ),
                  ),
                  const Spacer(),
                  // Close button
                  Semantics(
                    button: true,
                    label: l10n.accessibilityCloseSheet,
                    child: ElevatedButton(
                      onPressed: () => Navigator.pop(context),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: context.appColors.primary,
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(
                          horizontal: 24,
                          vertical: 12,
                        ),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(16),
                        ),
                      ),
                      child: Text(l10n.close),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildEmptyState(AppLocalizations l10n) {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Container(
            width: 80,
            height: 80,
            decoration: BoxDecoration(
              color: context.appColors.success.withValues(alpha: 0.1),
              shape: BoxShape.circle,
            ),
            child: Icon(
              CupertinoIcons.checkmark_circle,
              size: 40,
              color: context.appColors.success,
            ),
          ),
          const SizedBox(height: 16),
          Text(
            l10n.allCategorized,
            style: TextStyle(
              fontSize: 20,
              fontWeight: FontWeight.w600,
              color: context.appColors.textPrimary,
            ),
          ),
          const SizedBox(height: 8),
          Text(
            l10n.categorizedCount(_processedCount, _skippedCount),
            style: TextStyle(
              fontSize: 14,
              color: context.appColors.textSecondary,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildExpenseCard(ParsedExpense expense) {
    final l10n = AppLocalizations.of(context);
    final hasSuggestion = expense.hasSuggestion;
    final suggestedCategory = hasSuggestion ? expense.match!.category : null;

    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20),
      child: Column(
        children: [
          // Expense details card
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(20),
            decoration: BoxDecoration(
              color: context.appColors.cardBackground,
              borderRadius: BorderRadius.circular(24),
              border: Border.all(color: context.appColors.cardBorder),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // Amount
                Text(
                  '${NumberFormat('#,##0', 'tr').format(expense.amount)} ₺',
                  style: TextStyle(
                    fontSize: 32,
                    fontWeight: FontWeight.w700,
                    color: context.appColors.textPrimary,
                  ),
                ),
                const SizedBox(height: 8),

                // Description
                Text(
                  expense.rawDescription,
                  style: TextStyle(
                    fontSize: 16,
                    color: context.appColors.textSecondary,
                  ),
                  maxLines: 2,
                  overflow: TextOverflow.ellipsis,
                ),
                const SizedBox(height: 8),

                // Date
                Row(
                  children: [
                    Icon(
                      CupertinoIcons.calendar,
                      size: 16,
                      color: context.appColors.textTertiary,
                    ),
                    const SizedBox(width: 6),
                    Text(
                      _formatDate(expense.date),
                      style: TextStyle(
                        fontSize: 14,
                        color: context.appColors.textTertiary,
                      ),
                    ),
                  ],
                ),

                // Suggestion badge
                if (hasSuggestion) ...[
                  const SizedBox(height: 16),
                  Container(
                    padding: const EdgeInsets.symmetric(
                      horizontal: 12,
                      vertical: 8,
                    ),
                    decoration: BoxDecoration(
                      color: context.appColors.primary.withValues(alpha: 0.1),
                      borderRadius: BorderRadius.circular(8),
                      border: Border.all(
                        color: context.appColors.primary.withValues(alpha: 0.3),
                      ),
                    ),
                    child: Row(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        Icon(
                          CupertinoIcons.lightbulb_fill,
                          size: 16,
                          color: context.appColors.primary,
                        ),
                        const SizedBox(width: 8),
                        Text(
                          l10n.suggestionLabel(expense.match!.displayName),
                          style: TextStyle(
                            fontSize: 14,
                            color: context.appColors.primary,
                            fontWeight: FontWeight.w500,
                          ),
                        ),
                      ],
                    ),
                  ),
                ],

                // Remember merchant checkbox
                const SizedBox(height: 16),
                GestureDetector(
                  onTap: () {
                    HapticFeedback.selectionClick();
                    setState(() {
                      expense.rememberMerchant = !expense.rememberMerchant;
                    });
                  },
                  child: Row(
                    children: [
                      Container(
                        width: 22,
                        height: 22,
                        decoration: BoxDecoration(
                          color: expense.rememberMerchant
                              ? context.appColors.primary
                              : Colors.transparent,
                          borderRadius: BorderRadius.circular(6),
                          border: Border.all(
                            color: expense.rememberMerchant
                                ? context.appColors.primary
                                : context.appColors.textTertiary,
                          ),
                        ),
                        child: expense.rememberMerchant
                            ? const Icon(
                                Icons.check,
                                size: 16,
                                color: Colors.white,
                              )
                            : null,
                      ),
                      const SizedBox(width: 10),
                      Text(
                        l10n.rememberMerchant,
                        style: TextStyle(
                          fontSize: 14,
                          color: context.appColors.textSecondary,
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),

          const SizedBox(height: 20),

          // Category grid
          Text(
            l10n.selectCategory,
            style: TextStyle(
              fontSize: 14,
              fontWeight: FontWeight.w500,
              color: context.appColors.textSecondary,
            ),
          ),
          const SizedBox(height: 12),

          Expanded(
            child: GridView.builder(
              gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                crossAxisCount: 3,
                mainAxisSpacing: 12,
                crossAxisSpacing: 12,
                childAspectRatio: 1.1,
              ),
              itemCount: _categories.length,
              itemBuilder: (context, index) {
                final category = _categories[index];
                final isSuggested = suggestedCategory == category.id;

                return _buildCategoryButton(
                  category: category,
                  isSuggested: isSuggested,
                  onTap: () => _approveExpense(expense, category.id),
                );
              },
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildCategoryButton({
    required _CategoryOption category,
    required bool isSuggested,
    required VoidCallback onTap,
  }) {
    final l10n = AppLocalizations.of(context);
    final semanticLabel = isSuggested
        ? '${category.label}, ${l10n.suggested}'
        : category.label;

    return Semantics(
      button: true,
      label: semanticLabel,
      child: GestureDetector(
        onTap: onTap,
        child: AnimatedContainer(
          duration: const Duration(milliseconds: 200),
          decoration: BoxDecoration(
            color: isSuggested
                ? category.color.withValues(alpha: 0.2)
                : context.appColors.cardBackground,
            borderRadius: BorderRadius.circular(16),
            border: Border.all(
              color: isSuggested
                  ? category.color
                  : context.appColors.cardBorder,
              width: isSuggested ? 2 : 1,
            ),
            boxShadow: isSuggested
                ? [
                    BoxShadow(
                      color: category.color.withValues(alpha: 0.3),
                      blurRadius: 12,
                      spreadRadius: -2,
                    ),
                  ]
                : null,
          ),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Icon(
                category.icon,
                size: 28,
                color: isSuggested
                    ? category.color
                    : context.appColors.textSecondary,
              ),
              const SizedBox(height: 6),
              Text(
                category.label,
                style: TextStyle(
                  fontSize: 12,
                  fontWeight: isSuggested ? FontWeight.w600 : FontWeight.w500,
                  color: isSuggested
                      ? category.color
                      : context.appColors.textSecondary,
                ),
                textAlign: TextAlign.center,
              ),
              if (isSuggested) ...[
                const SizedBox(height: 2),
                Text(
                  AppLocalizations.of(context).suggested,
                  style: TextStyle(
                    fontSize: 10,
                    color: category.color,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ],
            ],
          ),
        ),
      ),
    );
  }

  String _formatDate(DateTime date) {
    final now = DateTime.now();
    final diff = now.difference(date);

    if (diff.inDays == 0) {
      return AppLocalizations.of(context).today;
    } else if (diff.inDays == 1) {
      return AppLocalizations.of(context).yesterday;
    } else if (diff.inDays < 7) {
      return AppLocalizations.of(context).daysAgo(diff.inDays);
    } else {
      return '${date.day}/${date.month}/${date.year}';
    }
  }
}


--- FILE: lib/widgets/add_income_sheet.dart ---

import 'dart:ui';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:vantag/l10n/app_localizations.dart';
import '../models/models.dart';
import '../services/services.dart';
import '../theme/theme.dart';
import '../providers/providers.dart';
import '../utils/currency_utils.dart';

/// Bottom sheet for adding one-time income (bonus, gift, refund, etc.)
class AddIncomeSheet extends StatefulWidget {
  final VoidCallback? onIncomeAdded;

  const AddIncomeSheet({super.key, this.onIncomeAdded});

  @override
  State<AddIncomeSheet> createState() => _AddIncomeSheetState();
}

class _AddIncomeSheetState extends State<AddIncomeSheet>
    with SingleTickerProviderStateMixin {
  final _amountController = TextEditingController();
  final _notesController = TextEditingController();
  final _profileService = ProfileService();

  IncomeType _selectedType = IncomeType.bonus;
  bool _isLoading = false;

  late AnimationController _buttonAnimationController;
  late Animation<double> _buttonScaleAnimation;

  @override
  void initState() {
    super.initState();
    _buttonAnimationController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 150),
    );
    _buttonScaleAnimation = Tween<double>(begin: 1.0, end: 0.95).animate(
      CurvedAnimation(
        parent: _buttonAnimationController,
        curve: Curves.easeInOut,
      ),
    );
  }

  @override
  void dispose() {
    _amountController.dispose();
    _notesController.dispose();
    _buttonAnimationController.dispose();
    super.dispose();
  }

  double? get _amount {
    final text = _amountController.text.trim();
    if (text.isEmpty) return null;
    return parseTurkishCurrency(text);
  }

  bool get _canSave => _amount != null && _amount! > 0;

  Future<void> _saveIncome() async {
    if (!_canSave || _isLoading) return;

    setState(() => _isLoading = true);
    HapticFeedback.mediumImpact();

    try {
      final financeProvider = context.read<FinanceProvider>();
      final profile = financeProvider.userProfile;
      final currencyCode =
          profile?.incomeSources.firstOrNull?.currencyCode ?? 'TRY';

      // Create income record
      final income = Income(
        id: Income.generateId(),
        title: _selectedType.getLocalizedLabel(AppLocalizations.of(context)),
        amount: _amount!,
        currencyCode: currencyCode,
        type: _selectedType,
        date: DateTime.now(),
        notes: _notesController.text.trim().isNotEmpty
            ? _notesController.text.trim()
            : null,
      );

      // Save income to storage
      await _profileService.addIncome(income);

      // Update balance if tracking
      if (profile?.currentBalance != null) {
        await _profileService.addToBalance(_amount!);
        // Refresh provider
        final newProfile = await _profileService.getProfile();
        if (newProfile != null) {
          financeProvider.setUserProfile(newProfile);
        }
      }

      if (!mounted) return;

      // Show success message
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(AppLocalizations.of(context).incomeAdded),
          backgroundColor: context.appColors.success,
          behavior: SnackBarBehavior.floating,
        ),
      );

      widget.onIncomeAdded?.call();
      Navigator.pop(context);
    } catch (e) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error: $e'),
          backgroundColor: context.appColors.error,
          behavior: SnackBarBehavior.floating,
        ),
      );
    } finally {
      if (mounted) {
        setState(() => _isLoading = false);
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final bottomPadding = MediaQuery.of(context).viewInsets.bottom;

    return Container(
      decoration: BoxDecoration(
        color: context.appColors.surface,
        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
      ),
      child: ClipRRect(
        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
        child: BackdropFilter(
          filter: ImageFilter.blur(sigmaX: 20, sigmaY: 20),
          child: SafeArea(
            child: Padding(
              padding: EdgeInsets.fromLTRB(20, 12, 20, 20 + bottomPadding),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                crossAxisAlignment: CrossAxisAlignment.stretch,
                children: [
                  // Handle bar
                  Center(
                    child: Container(
                      width: 40,
                      height: 4,
                      decoration: BoxDecoration(
                        color: context.appColors.textTertiary.withValues(
                          alpha: 0.3,
                        ),
                        borderRadius: BorderRadius.circular(2),
                      ),
                    ),
                  ),
                  const SizedBox(height: 20),

                  // Header
                  Row(
                    children: [
                      Container(
                        width: 48,
                        height: 48,
                        decoration: BoxDecoration(
                          color: context.appColors.success.withValues(
                            alpha: 0.15,
                          ),
                          borderRadius: BorderRadius.circular(16),
                        ),
                        child: Icon(
                          CupertinoIcons.arrow_down_circle_fill,
                          color: context.appColors.success,
                          size: 24,
                        ),
                      ),
                      const SizedBox(width: 16),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              l10n.addIncomeTitle,
                              style: TextStyle(
                                fontSize: 20,
                                fontWeight: FontWeight.w700,
                                color: context.appColors.textPrimary,
                              ),
                            ),
                            Text(
                              l10n.addIncomeSubtitle,
                              style: TextStyle(
                                fontSize: 14,
                                color: context.appColors.textSecondary,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 24),

                  // Income Type Selector
                  Text(
                    l10n.incomeType,
                    style: TextStyle(
                      fontSize: 14,
                      fontWeight: FontWeight.w600,
                      color: context.appColors.textSecondary,
                    ),
                  ),
                  const SizedBox(height: 12),
                  _buildTypeSelector(),
                  const SizedBox(height: 20),

                  // Amount Input
                  Text(
                    l10n.incomeAmount,
                    style: TextStyle(
                      fontSize: 14,
                      fontWeight: FontWeight.w600,
                      color: context.appColors.textSecondary,
                    ),
                  ),
                  const SizedBox(height: 8),
                  TextField(
                    controller: _amountController,
                    keyboardType: const TextInputType.numberWithOptions(
                      decimal: true,
                    ),
                    inputFormatters: [TurkishCurrencyInputFormatter()],
                    autofocus: true,
                    onChanged: (_) => setState(() {}),
                    style: TextStyle(
                      fontSize: 32,
                      fontWeight: FontWeight.w700,
                      color: context.appColors.textPrimary,
                    ),
                    textAlign: TextAlign.center,
                    decoration: InputDecoration(
                      hintText: '0',
                      hintStyle: TextStyle(
                        fontSize: 32,
                        fontWeight: FontWeight.w700,
                        color: context.appColors.textTertiary,
                      ),
                      filled: true,
                      fillColor: context.appColors.surfaceLight,
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(16),
                        borderSide: BorderSide.none,
                      ),
                      contentPadding: const EdgeInsets.symmetric(
                        horizontal: 20,
                        vertical: 20,
                      ),
                      prefixText: '\u20BA ',
                      prefixStyle: TextStyle(
                        fontSize: 28,
                        fontWeight: FontWeight.w600,
                        color: context.appColors.textSecondary,
                      ),
                    ),
                  ),
                  const SizedBox(height: 20),

                  // Notes Input (optional)
                  Text(
                    l10n.incomeNotes,
                    style: TextStyle(
                      fontSize: 14,
                      fontWeight: FontWeight.w600,
                      color: context.appColors.textSecondary,
                    ),
                  ),
                  const SizedBox(height: 8),
                  TextField(
                    controller: _notesController,
                    style: TextStyle(
                      fontSize: 16,
                      color: context.appColors.textPrimary,
                    ),
                    decoration: InputDecoration(
                      hintText: l10n.incomeNotesHint,
                      hintStyle: TextStyle(
                        color: context.appColors.textTertiary,
                      ),
                      filled: true,
                      fillColor: context.appColors.surfaceLight,
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(16),
                        borderSide: BorderSide.none,
                      ),
                      contentPadding: const EdgeInsets.symmetric(
                        horizontal: 16,
                        vertical: 14,
                      ),
                    ),
                  ),
                  const SizedBox(height: 24),

                  // Save Button
                  RepaintBoundary(
                    child: GestureDetector(
                      onTapDown: _canSave && !_isLoading
                          ? (_) => _buttonAnimationController.forward()
                          : null,
                      onTapUp: _canSave && !_isLoading
                          ? (_) {
                              _buttonAnimationController.reverse();
                              _saveIncome();
                            }
                          : null,
                      onTapCancel: _canSave && !_isLoading
                          ? () => _buttonAnimationController.reverse()
                          : null,
                      child: ScaleTransition(
                        scale: _buttonScaleAnimation,
                        child: AnimatedContainer(
                          duration: const Duration(milliseconds: 200),
                          width: double.infinity,
                          padding: const EdgeInsets.symmetric(vertical: 16),
                          decoration: BoxDecoration(
                            color: _canSave && !_isLoading
                                ? context.appColors.success
                                : context.appColors.surfaceLight,
                            borderRadius: BorderRadius.circular(16),
                            boxShadow: _canSave && !_isLoading
                                ? [
                                    BoxShadow(
                                      color: context.appColors.success
                                          .withValues(alpha: 0.3),
                                      blurRadius: 16,
                                      offset: const Offset(0, 6),
                                    ),
                                  ]
                                : null,
                          ),
                          child: _isLoading
                              ? Center(
                                  child: SizedBox(
                                    width: 24,
                                    height: 24,
                                    child: CircularProgressIndicator(
                                      strokeWidth: 2,
                                      valueColor: AlwaysStoppedAnimation(
                                        context.appColors.background,
                                      ),
                                    ),
                                  ),
                                )
                              : Row(
                                  mainAxisAlignment: MainAxisAlignment.center,
                                  children: [
                                    Icon(
                                      CupertinoIcons.add,
                                      size: 20,
                                      color: _canSave
                                          ? context.appColors.background
                                          : context.appColors.textTertiary,
                                    ),
                                    const SizedBox(width: 8),
                                    Text(
                                      l10n.addIncome,
                                      style: TextStyle(
                                        fontSize: 16,
                                        fontWeight: FontWeight.w600,
                                        color: _canSave
                                            ? context.appColors.background
                                            : context.appColors.textTertiary,
                                      ),
                                    ),
                                  ],
                                ),
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildTypeSelector() {
    final l10n = AppLocalizations.of(context);
    final types = [
      IncomeType.bonus,
      IncomeType.gift,
      IncomeType.refund,
      IncomeType.freelance,
      IncomeType.other,
    ];

    return Wrap(
      spacing: 8,
      runSpacing: 8,
      children: types.map((type) {
        final isSelected = _selectedType == type;
        return GestureDetector(
          onTap: () {
            HapticFeedback.selectionClick();
            setState(() => _selectedType = type);
          },
          child: AnimatedContainer(
            duration: const Duration(milliseconds: 200),
            padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),
            decoration: BoxDecoration(
              color: isSelected
                  ? type.color.withValues(alpha: 0.15)
                  : context.appColors.surfaceLight,
              borderRadius: BorderRadius.circular(16),
              border: Border.all(
                color: isSelected ? type.color : context.appColors.cardBorder,
                width: isSelected ? 2 : 1,
              ),
            ),
            child: Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                Icon(
                  type.icon,
                  size: 18,
                  color: isSelected
                      ? type.color
                      : context.appColors.textSecondary,
                ),
                const SizedBox(width: 8),
                Text(
                  type.getLocalizedLabel(l10n),
                  style: TextStyle(
                    fontSize: 14,
                    fontWeight: isSelected ? FontWeight.w600 : FontWeight.w500,
                    color: isSelected
                        ? type.color
                        : context.appColors.textPrimary,
                  ),
                ),
              ],
            ),
          ),
        );
      }).toList(),
    );
  }
}
